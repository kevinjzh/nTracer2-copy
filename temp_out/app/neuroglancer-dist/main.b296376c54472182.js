(()=>{var e={2338:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJDw4cOCW1/KIAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAHElEQVQI12NggIL/DAz/GdA5/xkY/qPKMDAwAADLZwf5rvm+LQAAAABJRU5ErkJggg=="},9110:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAADCAYAAAC09K7GAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sJFhQXEbhTg7YAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAMklEQVQI12NkgIIvJ3QXMjAwdDN+OaEbysDA4MPAwNDNwMCwiOHLCd1zX07o6kBVGQEAKBANtobskNMAAAAASUVORK5CYII="},5554:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAHCAMAAADzjKfhAAAACVBMVEUAAAAAAAC/v7914kyHAAAAAXRSTlMAQObYZgAAACNJREFUeNo1ioEJAAAIwmz/H90iFFSGJgFMe3gaLZ0od+9/AQZ0ADosbYraAAAAAElFTkSuQmCC"},772:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAHlBMVEW7AAC7AACxAAC7AAC7AAAAAAC4AAC5AAD///+7AAAUdclpAAAABnRSTlMXnORSiwCK0ZKSAAAATUlEQVR42mWPOQ7AQAgDuQLx/z8csYRmPRIFIwRGnosRrpamvkKi0FTIiMASR3hhKW+hAN6/tIWhu9PDWiTGNEkTtIOucA5Oyr9ckPgAWm0GPBog6v4AAAAASUVORK5CYII="},4052:function(e){"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAANlBMVEX/uwDvrwD/uwD/uwD/uwD/uwD/uwD/uwD/uwD6twD/uwAAAADurwD2tQD7uAD+ugAAAAD/uwDhmeTRAAAADHRSTlMJ8mN1EYcbmiixgACm7WbuAAAAVklEQVR42n3PUQqAIBBFUU1LLc3u/jdbOJoW1P08DA9Gba8+YWJ6gNJoNYIBzAA2chBth5kLmG9YUoG0NHAUwFXwO9LuBQL1giCQb8gC9Oro2vp5rncCIY8L8uEx5ZkAAAAASUVORK5CYII="},2959:function(e,t,i){"use strict";e.exports=i.p+"bossauth.html"},7984:function(e,t,i){"use strict";e.exports=i.p+"google_oauth2_redirect.html"},4881:function(e,t,i){"use strict";i.d(t,{HP:()=>o,_E:()=>d,jv:()=>u});var r=i(6985),n=i(6923),s=i(7734);function a(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(a=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}function o(e,t){return{fileNames:e,match:async i=>{let r=i.fileNames;for(let i of e)if(r.has(i))return[t];return[]}}}function l(e){return async t=>{let i=[];for(let r of(await Promise.allSettled(e.map(e=>e.match(t)))))"fulfilled"===r.status&&i.push(...r.value);return i}}class d{directorySpecs=[];fileSpecs=[];_directorySpec;_fileSpec;registerDirectoryFormat(e){this.directorySpecs.push(e),this._directorySpec=void 0}registerFileFormat(e){this.fileSpecs.push(e),this._fileSpec=void 0}copyTo(e){e.directorySpecs.push(...this.directorySpecs),e.fileSpecs.push(...this.fileSpecs),e._fileSpec=void 0,e._directorySpec=void 0}get directorySpec(){return this._directorySpec??(this._directorySpec=this.getDirectorySpec())}getDirectorySpec(){return function(e){let t=new Set,i=new Set;for(let r of e){let{fileNames:e,subDirectories:n}=r;if(void 0!==e)for(let i of e)t.add(i);if(void 0!==n)for(let e of n)i.add(e)}return{fileNames:t,subDirectories:i,match:l(e)}}(this.directorySpecs)}get fileSpec(){return this._fileSpec??(this._fileSpec=this.getFileSpec())}getFileSpec(){let{fileSpecs:e}=this;return function(e){let t=0,i=0;for(let r of e)t=Math.max(t,r.prefixLength),i=Math.max(i,r.suffixLength);return{prefixLength:t,suffixLength:i,match:l(e)}}([...e])}}async function u(e){let t={stack:[],error:void 0,hasError:!1};try{let i=e.kvStoreContext.getKvStore(e.url),{progressListener:a}=e;if(!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(t,a&&new s.Vi(a,{message:`Auto-detecting data format at ${e.url}`}),!1),!(0,n.zg)(i.path)||!0===i.store.singleKey){let t=await i.store.stat(i.path,{signal:e.signal,progressListener:e.progressListener});if(void 0!==t){let n,s;let a=e.autoDetectFile(),{totalSize:o}=t;if(void 0!==o&&a.suffixLength>0){if(o<=a.prefixLength+a.suffixLength){let t=await (0,r.BF)(i.store,i.path,{signal:e.signal,progressListener:e.progressListener,throwIfMissing:!0});n=s=new Uint8Array(await t.response.arrayBuffer())}else[n,s]=await Promise.all([{offset:0,length:a.prefixLength},{offset:o-a.suffixLength,length:a.suffixLength}].map(t=>(0,r.BF)(i.store,i.path,{signal:e.signal,progressListener:e.progressListener,throwIfMissing:!0,byteRange:t}).then(e=>e.response.arrayBuffer()).then(e=>new Uint8Array(e))))}else n=new Uint8Array(await (await (0,r.BF)(i.store,i.path,{signal:e.signal,progressListener:e.progressListener,throwIfMissing:!0,byteRange:{offset:0,length:a.prefixLength}})).response.arrayBuffer());return{matches:await a.match({url:e.url,prefix:n,suffix:s,totalSize:o,signal:e.signal}),url:e.url}}if(!0===i.store.singleKey)return{matches:[],url:e.url};i.path+="/"}let o=e.autoDetectDirectory(),l=new Set;await Promise.all(Array.from(o.fileNames??[],async t=>{let r=await i.store.stat(i.path+t,{signal:e.signal,progressListener:e.progressListener});void 0!==r&&l.add(t)}));let d=i.store.getUrl(i.path);return{matches:await o.match({url:d,fileNames:l,subDirectories:new Set,signal:e.signal}),url:d}}catch(e){t.error=e,t.hasError=!0}finally{a(t)}}},4758:function(e,t,i){"use strict";i.d(t,{uX:()=>s,z2:()=>n});var r=i(6985);function n(e,t){if(void 0===t)return{outer:e,inner:{offset:0,length:e.length}};if("suffixLength"in t){let i=Math.min(e.length,t.suffixLength);return{outer:{offset:e.offset+(e.length-i),length:i},inner:{offset:e.length-i,length:i}}}if(t.offset+t.length>e.length)throw Error(`Requested byte range ${JSON.stringify(t)} not valid for value of length ${e.length}`);return{outer:{offset:e.offset+t.offset,length:t.length},inner:t}}class s{base;byteRange;constructor(e,t){this.base=e,this.byteRange=t}async stat(e){return{totalSize:this.byteRange.length}}async read(e){let{byteRange:t}=this,{outer:i,inner:s}=n(t,e.byteRange);return 0===i.length?{response:new Response(new Uint8Array(0)),totalSize:t.length,...s}:{response:(await (0,r.iT)(this.base,{signal:e.signal,byteRange:i,strictByteRange:!0,throwIfMissing:!0})).response,totalSize:t.length,...s}}getUrl(){let{offset:e,length:t}=this.byteRange;return`${this.base.getUrl()}|range:${e}-${e+t}`}}},119:function(e,t,i){"use strict";i.d(t,{i:()=>u,l:()=>p});var r=i(4758),n=i(6985),s=i(2258);function a(e){if(void 0!==e)return`bytes=${e.offset}-${e.offset+e.length-1}`}let o=-1!==navigator.userAgent.indexOf("Chrome")?"no-store":"default";function l(e,t){return new URL(e).pathname+"/"===new URL(t.url).pathname}function d(e){let t;let i=e.match(/bytes ([0-9]+)-([0-9]+)\/([0-9]+|\*)/);if(null===i)throw Error(`Invalid content-range header: ${JSON.stringify(e)}`);let r=parseInt(i[1],10),n=parseInt(i[2],10);return"*"!==i[3]&&(t=parseInt(i[3],10)),{offset:r,length:n-r+1,totalSize:t}}async function u(e,t,i,n,g=s.ru){let f;try{let s,u,h,m;let{byteRange:v}=n;if(void 0!==v){if("suffixLength"in v){let o=await p(e,t,i,n,g);if(void 0===o)return;let{totalSize:l}=o;if(void 0===l)throw Error(`Failed to determine total size of ${e.getUrl(t)} in order to fetch suffix ${JSON.stringify(v)}`);if(f=(0,r.z2)({offset:0,length:l},v).outer,0===f.length)return{...f,totalSize:l,response:new Response(new Uint8Array(0))};s=a(f)}else f=v,s=0===f.length?a({offset:Math.max(f.offset-1,0),length:1}):a(f)}let y={signal:n.signal,progressListener:n.progressListener};void 0!==s&&(y.headers={range:s},y.cache=o);let b=await g(i,y);if(l(i,b))return;if(206===b.status){let e=b.headers.get("content-range");if(null===e){if(void 0!==f)u=f.offset;else throw Error("Unexpected HTTP 206 response when no byte range specified.")}null!==e&&({offset:u,length:h,totalSize:m}=d(e))}else h=m=c(b.headers);return void 0===u&&(u=0),void 0===h&&(h=c(b.headers)),f?.length===0&&(b=new Response(new Uint8Array(0)),u=f.offset,h=0),{response:b,offset:u,length:h,totalSize:m}}catch(i){if(i instanceof s.oo&&416===i.status&&f?.length===0&&0===f.offset)return{response:new Response(new Uint8Array(0)),offset:0,length:0,totalSize:0};return h(e,t,n,i)}}function c(e){let t=e.get("content-length");if(null===e.get("content-encoding")&&null!==t){let e=Number(t);if(!Number.isFinite(e)||e<0)throw Error("Invalid content-length: {contentLength}");return e}}function h(e,t,i,r){if((0,s.XD)(r)){if(!0===i.throwIfMissing)throw new n.dR(new n.f2(e,t),{cause:r});return}throw r}async function p(e,t,i,r,n=s.ru){try{let e=await n(i,{method:"HEAD",signal:r.signal,progressListener:r.progressListener});if(l(i,e))return;return{totalSize:c(e.headers)}}catch(i){if(!(i instanceof s.oo)||405!==i.status&&501!==i.status)return h(e,t,r,i)}try{let e;let t=await n(i,{signal:r.signal,progressListener:r.progressListener,headers:{range:"bytes=0-0"}});if(l(i,t))return;if(200===t.status)e=c(t.headers);else{let i=t.headers.get("content-range");null!==i&&({totalSize:e}=d(i))}return{totalSize:e}}catch(i){if(i instanceof s.oo&&416===i.status)return{totalSize:0};return h(e,t,r,i)}}},6985:function(e,t,i){"use strict";i.d(t,{BF:()=>s,Mt:()=>d,RQ:()=>o,dR:()=>n,f2:()=>l,iT:()=>a});var r=i(6235);class n extends Error{constructor(e,t){super(`${e.getUrl()} not found`,t)}}async function s(e,t,i={}){return a(new l(e,t),i)}async function a(e,t={}){let i=await e.read(t);if(t?.throwIfMissing===!0&&void 0===i)throw new n(e);if(t?.strictByteRange===!0&&void 0!==i){let{byteRange:r}=t,{offset:n,length:s}=i;if(void 0!==r&&("suffixLength"in r?s!==r.suffixLength:n!==r.offset||void 0!==s&&s!==r.length))throw Error(`Received truncated response for ${e.getUrl()}, expected ${JSON.stringify(r)} but received offset=${n}, length=${s}`)}return i}async function o(e,t,i={}){if(!e.list)throw Error("Listing not supported");return function(e,t,i,r){switch(r){case"suffix":{let i=t.length;return{directories:e.directories.map(e=>e.substring(i)),entries:e.entries.map(({key:e,...t})=>({...t,key:e.substring(i)}))}}case"url":return{directories:e.directories.map(e=>i.getUrl(e)),entries:e.entries.map(({key:e,...t})=>({...t,key:i.getUrl(e)}))};default:return e}}(await e.list(t,i),t,e,i.responseKeys)}class l{store;key;constructor(e,t){this.store=e,this.key=t}stat(e){return this.store.stat(this.key,e)}read(e){return this.store.read(this.key,e)}getUrl(){return this.store.getUrl(this.key)}}function d(e){return e.entries.sort(({key:e},{key:t})=>(0,r.B)(e,t)),e.directories.sort(r.B),e}},8274:function(e,t,i){"use strict";function r(e){if(void 0===e)return"HEAD";if("generationNumber"in e)return`v${e.generationNumber}`;let{commitTime:t}=e;return function(e){let t=e%1000000000n,i=e/1000000000n;t<0n&&(t+=1000000000n,i-=1n);let r=new Date(1e3*Number(i)).toISOString();if(24!==r.length)throw Error(`Invalid commit time: ${e} -> ${r}`);return r=r.slice(0,19),0n!==t&&(r+="."+t.toString().padStart(9,"0").replace(/0+$/,"")),r+="Z"}(t)}function n(e){if(void 0===e)return;let t=e.match(/^(?:v([1-9]\d*)|(?:\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d*)?Z))$/);if(null===t)throw Error(`Invalid OCDBT version specifier: ${JSON.stringify(e)}`);let[,i]=t;if(void 0!==i){let e=BigInt(i);if(e>0xffffffffffffffffn)throw Error(`Invalid generation number: ${e}`);return{generationNumber:e}}return{commitTime:function(e){var t,i;let r,n=e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(?:(\.\d*))?Z$/);if(null===n)throw Error(`Invalid commit timestamp: ${JSON.stringify(e)}`);let[,s,a]=n;return t=Date.parse(s+"Z"),i=a,r=1000000n*BigInt(t),void 0!==i&&i.length>1&&(r+=BigInt(Math.min(0x3b9ac9ff,Math.round(1e9*Number(i))))),r}(e)}}i.d(t,{ko:()=>r,wy:()=>n}),RegExp("^(\\d{0,4})(?:(?<=\\d{4})-(\\d{0,2})(?:(?<=\\d{2})-(\\d{0,2})(?:(?<=\\d{2})T(\\d{0,2})(?:(?<=\\d{2}):(\\d{0,2})(?:(?<=\\d{2}):(\\d{0,2})(?:(?<=\\d{2})(\\.\\d*)?(Z)?)?)?)?)?)?)?$")},732:function(e,t,i){"use strict";i.d(t,{g6:()=>c,ib:()=>o,vi:()=>h,xT:()=>a});var r=i(6923);let n=["http://doc.s3.amazonaws.com/2006-03-01/","http://s3.amazonaws.com/doc/2006-03-01/"];function s(e){return n.includes(e.namespaceURI)&&"ListBucketResult"===e.tagName}function a(e){let t;try{t=new DOMParser().parseFromString(e,"application/xml")}catch{return!1}return s(t.documentElement)}async function o(e,t,i,r){try{let n=await i(`${e}?list-type=2&prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent("/")}&encoding-type=url`,{headers:{accept:"application/xml,text/xml"},signal:r.signal,progressListener:r.progressListener}),a=n.headers.get("content-type");if(null===a||null===/\b(application\/xml|text\/xml|text\/html)\b/i.exec(a))throw Error(`Expected XML content-type but received: ${a}`);let o=await n.text(),l=new DOMParser().parseFromString(o,"application/xml"),{documentElement:d}=l;if(!s(d))throw Error(`Received unexpected XML root element <${d.tagName} xmlns="${d.namespaceURI}">`);let u=d.namespaceURI,c=()=>u,h=l.evaluate("//CommonPrefixes/Prefix",l,c,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),p=[];for(let e=0,t=h.snapshotLength;e<t;++e){let t=h.snapshotItem(e).textContent;null!==t&&(t=decodeURIComponent(t),p.push(t.substring(0,t.length-1)))}let g=[],f=l.evaluate("//Contents/Key",l,c,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let e=0,t=f.snapshotLength;e<t;++e){let t=f.snapshotItem(e).textContent;null!==t&&g.push({key:decodeURIComponent(t)})}return{directories:p,entries:g}}catch(e){throw Error("S3-compatible listing not supported",{cause:e})}}function l(e,t,i){let{baseUrl:n,path:s}=(0,r.f0)(e);return o(n,s,t,i)}async function d(e,t,i){let n=function(e){let t=new URL(e),i=t.pathname.match(/^\/([^/]+)(?:\/(.*))$/);if(null===i)return;let[,r,n]=i;return{bucketUrl:`${t.origin}/${r}/${t.search}`,bucket:decodeURIComponent(r),prefix:decodeURIComponent(n)}}(e);if(void 0===n)throw Error(`Path-style S3 URL ${JSON.stringify(e)} must specify bucket`);let{bucketUrl:s,bucket:a,prefix:l}=n,d=await o(s,l,t,i),u=(0,r.aU)(a)+"/";return{entries:d.entries.map(e=>({key:u+e.key})),directories:d.directories.map(e=>u+e)}}function u(e){return e.getUncounted("s3:urlkind",()=>new Map)}async function c(e,t,i,r,n){let s=u(i),a=s.get(t);if("virtual"===a)return await l(e,r,n);if("path"===a)return await d(e,r,n);if(null!==a)try{let{result:i,urlKind:a}=await Promise.any([l(e,r,n).then(e=>({result:e,urlKind:"virtual"})),d(e,r,n).then(e=>({result:e,urlKind:"path"}))]);return s.set(t,a),i}catch(e){throw n.signal?.throwIfAborted(),s.set(t,null),Error("Neither virtual hosted nor path-style S3 listing supported",{cause:e})}throw Error("Neither virtual hosted nor path-style S3 listing supported")}function h(e,t){return u(e).get(t)}},6923:function(e,t,i){"use strict";function r(e){let t=e.match(/^((?:.*?\|)?)([a-zA-Z][a-zA-Z0-9-+.]*)(?:(:[^?#|]*)((?:[?#][^|]*)?))?$/);if(null===t)throw Error(`Invalid URL: ${e}`);let[,i,r,n,s]=t;return void 0===n?`${i}${r}:`:":"===n||n.endsWith("/")?e:`${i}${r}${n}/${s??""}`}function n(e){return e.match(/.*?([^|]*)$/)[1]}i.d(t,{DY:()=>o,J8:()=>r,Lj:()=>y,V8:()=>c,Vo:()=>u,Yq:()=>d,aU:()=>v,f0:()=>b,i1:()=>f,kr:()=>g,kw:()=>n,mq:()=>a,pN:()=>l,uh:()=>h,zY:()=>p,zg:()=>m});let s=/^(?:([a-zA-Z][a-zA-Z0-9-+.]*):)?(.*)$/;function a(e){let t=e.match(s),i=t[1],r=t[2];return void 0===i?{url:e,scheme:e,suffix:void 0}:{url:e,scheme:i,suffix:r}}function o(e){if(void 0===e)return{authorityAndPath:void 0,query:void 0,fragment:void 0};let[,t,i,r]=e.match(/^([^?#]*)(?:\?([^#]*))?(?:#(.*))?$/);return{authorityAndPath:t,query:i??void 0,fragment:r??void 0}}function l(e){return e.split("|").map(a)}function d(e,...t){let[,i,n]=e.match(/^(.*?[^|?#]*)([^|]*)$/);for(let e of t)e.startsWith("/")&&(e=e.substring(1)),""!==e&&(i=r(i)+v(e));return i+n}function u(e,...t){for(let i of t)i.startsWith("/")&&(i=i.substring(1)),""!==i&&(e=c(e)+i);return e}function c(e){return m(e)||(e+="/"),e}function h(e){let{suffix:t}=e;if(void 0!==t&&t.match(/[#?]/))throw Error(`Invalid URL ${e.url}: query parameters and/or fragment not supported`)}function p(e){if(e.suffix)throw Error(`Invalid URL syntax ${JSON.stringify(e.url)}, expected "${e.scheme}:"`)}function g(e){let[,t,i]=e.match(/^(.*?[^|?#]*)([^|]*)$/);return{base:t,queryAndFragment:i}}function f(e,t){let i=e;for(let r of(e.endsWith("/")&&(e=e.substring(0,e.length-1)),t.split("/")))if(""!==r&&"."!==r){if(".."===r){let r=e.lastIndexOf("/");if(r<=0)throw Error(`Invalid relative path ${JSON.stringify(t)} from base path ${JSON.stringify(i)}`);e=e.substring(0,r);continue}""!==e&&(e+="/"),e+=r}return t.endsWith("/")&&(e+="/"),e}function m(e){return""===e||e.endsWith("/")}function v(e){return encodeURI(e).replace(/[?#@]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)}function y(e,t){let{base:i,queryAndFragment:r}=g(e);return i+v(t)+r}function b(e){let t=new URL(e);if(t.hash)throw Error("fragment not supported");if(t.username||t.password)throw Error("basic auth credentials not supported");return{baseUrl:`${t.origin}/${t.search}`,path:decodeURIComponent(t.pathname.substring(1))}}},4066:function(e,t,i){"use strict";i.d(t,{BA:()=>n,Lr:()=>s,tr:()=>a});var r,n=((r={})[r.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",r[r.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",r[r.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",r[r.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED",r);function s(e){return!(0x8000000000000000n&e)}let a=0xffffffffffffffffn},3719:function(e,t,i){"use strict";i.d(t,{GF:()=>f,Jk:()=>b,SN:()=>a,S_:()=>d,TU:()=>o,Uw:()=>m,ip:()=>S,kp:()=>w,mJ:()=>h,mo:()=>p,ne:()=>y,ny:()=>g,og:()=>c,w:()=>v});var r=i(2902),n=i(106),s=i(566);class a{value_;get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}changed;constructor(e){this.value_=e,this.changed=new s.K_}}class o extends a{validator;defaultValue;constructor(e,t,i=e){super(e),this.validator=t,this.defaultValue=i}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(void 0!==e){let{validator:t}=this;try{this.value=t(e);return}catch{}}this.value=this.defaultValue}}class l extends n.gj{changed=new s.K_;get value(){return this.f(...this.ws.map(e=>e.value))}f;ws;constructor(e,t){for(let i of(super(),this.f=e,this.ws=t,t))this.registerDisposer(i.changed.add(this.changed.dispatch))}}function d(e,...t){return new l(e,t)}class u extends n.gj{changed=new s.K_;value_;valueGeneration=-1;get value(){let e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(e=>e.value)),this.valueGeneration=e),this.value_}f;ws;constructor(e,t){for(let i of(super(),this.f=e,this.ws=t,t))this.registerDisposer(i.changed.add(this.changed.dispatch))}}function c(e,...t){return new u(e,t)}class h extends n.gj{changed=new s.MZ;value;constructor(e,t=(e,t)=>e===t){super(),this.value=e.value,this.registerDisposer(e.changed.add(()=>{let i=e.value;t(this.value,i)||(this.value=i,this.changed.dispatch())}))}}function p(e,t,i){let r=new l(e,t),n=new h(r,i);return n.registerDisposer(r),n}class g extends n.gj{changed=new s.K_;value;constructor(e){super();let t=e(this),i=Object.keys(t),r=()=>{let e=Array.isArray(t)?[]:{};for(let r of i)e[r]=t[r].value;this.value=e,this.changed.dispatch()};for(let e of(r(),i)){let i=t[e];this.registerDisposer(i.changed.add(()=>r()))}}}n.gj,n.gj;class f{changed=new s.MZ;values;constructor(e){void 0===e?this.values=new Set:this.values=new Set(e)}add(e){let{values:t}=this;return t.has(e)||(t.add(e),this.changed.dispatch(e,!0)),this}delete(e){let{values:t}=this;return!!t.delete(e)&&(this.changed.dispatch(e,!1),!0)}has(e){return this.values.has(e)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){let{values:e}=this;e.size>0&&(e.clear(),this.changed.dispatch(null,!1))}}function m(e,...t){let i=t.map(e=>e.value),s=t.length,a=new n.gj,o=e(a,...i),l=(0,r.Z)(()=>{let r=!1;for(let e=0;e<s;++e){let n=t[e].value;i[e]!==n&&(i[e]=n,r=!0)}r&&(a.dispose(),o=e(a=new n.gj,...i))},0),d=t.map(e=>e.changed.add(l));return{flush(){l.flush()},dispose(){l.cancel(),(0,n.k1)(d),a.dispose()},get value(){return l.flush(),o}}}function v(e,...t){let i=t.map(e=>e.value),r=t.length,s=new n.gj,a=e(s,...i),o=()=>{let o=!1;for(let e=0;e<r;++e){let r=t[e].value;i[e]!==r&&(i[e]=r,o=!0)}o&&(s.dispose(),a=e(s=new n.gj,...i))},l=t.map(e=>e.changed.add(o));return{dispose(){(0,n.k1)(l),s.dispose()},get value(){return a}}}function y(e){return{changed:s.LP,value:e}}function b(e,t){return e(t.value),t.changed.add(()=>e(t.value))}class S{outer;getInner;inner;changed;disposer;update;constructor(e,t){this.outer=e,this.getInner=t,this.changed=new s.K_,this.update=()=>{let{disposer:e,outer:t}=this;void 0!==e&&e();let i=this.inner=this.getInner(t.value);this.disposer=i.changed.add(this.changed.dispatch),this.changed.dispatch()},e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}}class w extends S{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}}},2606:function(e,t,i){"use strict";function r(e,t){if(void 0!==e){if(e.aborted){t(e.reason);return}return e.addEventListener("abort",i,{once:!0}),{[Symbol.dispose](){e.removeEventListener("abort",i)}}}function i(){t(this.reason)}}i.d(t,{L0:()=>s,eg:()=>n,oi:()=>a,z6:()=>r});class n{consumers=new Map;controller=new AbortController;retainCount=0;get signal(){return this.controller.signal}addConsumer(e){if(!this.controller.signal.aborted){if(void 0!==e){if(e.aborted)return;let t=this;e.addEventListener("abort",function e(){t.consumers.delete(e),0==--t.retainCount&&(t.controller.abort(),t[Symbol.dispose]())},{once:!0})}++this.retainCount}}[Symbol.dispose](){for(let[e,t]of this.consumers)t.removeEventListener("abort",e);this.consumers.clear(),this.retainCount=0}start(){0===this.retainCount&&this.controller.abort()}}function s(e,t){let{promise:i,resolve:n,reject:s}=Promise.withResolvers(),a=r(e,t);return{promise:i,resolve:e=>{a?.[Symbol.dispose](),n(e)},reject:e=>{a?.[Symbol.dispose](),s(e)}}}function a(e,t){return void 0===t?e:t.aborted?Promise.reject(t.reason):new Promise((i,n)=>{let s=r(t,e=>{n(e)});e.then(e=>{s?.[Symbol.dispose](),i(e)},e=>{s?.[Symbol.dispose](),n(e)})})}},1471:function(e,t,i){"use strict";function r(e,t){let i=e.length,r=0;for(let n=0;n<i;++n)t(e[n],n,e)&&(e[r]=e[n],++r);e.length=r}function n(e,t){if(e.length===t)return e;let i=new e.constructor(t);return i.set(e),i}function s(e,t,i,r){let n=e.length/t,s=e.length*i*r,a=new e.constructor(s),o=e.length*r,l=t*r;for(let s=0;s<n;++s)for(let n=0;n<t;++n){let d=e[s*t+n],u=s*l+n;for(let e=0;e<i;++e)for(let i=0;i<r;++i)a[e*o+i*t+u]=d}return a}function a(e,t,i,r=0,n=e.length){for(;r<n;){let s=r+n-1>>1,a=i(t,e[s]);if(a>0)r=s+1;else{if(!(a<0))return s;n=s}}return~r}function o(e,t,i,r=0,n=e.length){let s=-1,a=1/0;for(;r<n;){let o=r+n-1>>1,l=i(t,e[o]);if(l>0)r=o+1;else{if(!(l<0))return o;n=o}let d=Math.abs(l);d<a&&(a=d,s=o)}return s}function l(e,t,i){let r=t-e;for(;r>0;){let t=Math.floor(r/2),n=e+t;i(n)?r=t:(e=n+1,r-=t+1)}return e}function d(e,t){let i=[];for(let r=0,n=e.length;r<n;++r)e[r]===t&&i.push(r);return i}function u(e,t){let i=e.length;if(t.length!==i)return!1;for(let r=0;r<i;++r)if(e[r]!==t[r])return!1;return!0}function c(e,t,i=(e,t)=>e===t){let r=e.length;if(t.length!==r)return!1;for(let n=0;n<r;++n)if(!i(e[n],t[n]))return!1;return!0}function h(e,t,i){let r=[];if(i===t){for(let t=0;t<e;++t)r[t]=t;return r}r[i]=t;for(let n=0,s=0;n<e;){if(n===t){++n;continue}s===i&&++s,r[s++]=n++}return r}function p(e,t,i){for(let r=0,n=i.length;r<n;++r){let n=i[r];-1!==n&&(e[r]=t[n])}return e}function g(e){let t=[];for(let i=0,r=e.length;i<r;++i){let r=e[i];for(let e=0,i=r.length;e<i;++e){let i=t[e];void 0===i&&(i=t[e]=[]),i.push(r[e])}}return t}function f(e,t){let i=[],r=0;for(let n=0,s=t.length;n<s;++n){let{retainCount:s,deleteCount:a,insertCount:o}=t[n];0!==s&&(i.push(e.slice(r,r+s)),r+=s),r+=a,0!==o&&i.push(Array(o))}return r!==e.length&&i.push(e.slice(r)),[].concat(...i)}function m(e,t,i){let r=[],n=0,s=0,a=e.length,o=t.length;for(;n<a;){let l=0;for(;n<a&&s<o&&i(e[n],t[s]);)++l,++n,++s;0!==l&&r.push({retainCount:l,deleteCount:0,insertCount:0});let d=0;for(;n<a&&(s===o||!i(e[n],t[s]));)++d,++n;0!==d&&r.push({retainCount:0,deleteCount:d,insertCount:0})}return s!==o&&r.push({retainCount:0,deleteCount:0,insertCount:o-s}),r}function v(e,t,i,r,n,s){let a=0,o=0;if(0!==e&&0!==t)for(;;){let l=i(a,o);if(l<0){if(r(a),++a===e)break}else if(l>0){if(n(o),++o===t)break}else if(s(a,o),++a,++o,a===e||o===t)break}for(;a<e;)r(a),++a;for(;o<t;)n(o),++o}i.d(t,{BP:()=>h,FD:()=>v,Kq:()=>l,PK:()=>g,W0:()=>d,X9:()=>s,bm:()=>o,cO:()=>u,dr:()=>r,eK:()=>c,ry:()=>a,wG:()=>m,x:()=>f,x0:()=>n,zV:()=>p})},686:function(e,t,i){"use strict";function r(e,t){return e<t?-1:e>t?1:0}function n(e,t){return BigInt(e)|BigInt(t)<<32n}function s(){return n(0x100000000*Math.random()>>>0,0x100000000*Math.random()>>>0)}function a(e){return n(e>>>0,e<0?0xffffffff:0)}function o(e,t){return e<t?e:t}function l(e,t){return e>t?e:t}i.d(t,{Fx:()=>a,I4:()=>u,Nr:()=>d,SM:()=>o,_f:()=>r,fD:()=>c,ff:()=>s,jT:()=>n,uQ:()=>l,y7:()=>h});let d=0xffffffffffffffffn;function u(e){return e<0n?0n:e>d?d:e}function c(e){return e<0n?-e:e}function h(e){if("number"==typeof e){if(e===Number.POSITIVE_INFINITY)return d;if(!Number.isFinite(e))return 0n;e=BigInt(Math.round(e))}return u(e)}},106:function(e,t,i){"use strict";function r(e){"object"==typeof e?e.dispose():e()}function n(e){for(let t=e.length;t>0;--t)r(e[t-1])}function s(e,t,i,r){return e.addEventListener(t,i,r),()=>e.removeEventListener(t,i,r)}i.d(t,{H0:()=>s,IF:()=>o,gj:()=>a,k1:()=>n,oq:()=>l});class a{refCount=1;wasDisposed;disposers;addRef(){return++this.refCount,this}disposedStacks;dispose(){0==--this.refCount&&this.refCountReachedZero()}[Symbol.dispose](){this.dispose()}refCountReachedZero(){this.disposed();let{disposers:e}=this;void 0!==e&&(n(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return null==t?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(null!=t){let i=t.indexOf(e);-1!==i&&t.splice(i,1)}return e}registerEventListener(e,t,i,r){this.registerDisposer(s(e,t,i,r))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}}class o extends a{value;constructor(e){super(),this.value=e}}function l(e){return()=>{if(void 0!==e){let t=e;e=void 0,r(t)}}}},3783:function(e,t,i){"use strict";i.d(t,{Dv:()=>p,Jc:()=>k,K4:()=>d,Mb:()=>R,Mz:()=>T,R3:()=>n,Rq:()=>x,TL:()=>u,V2:()=>L,_E:()=>r,_Z:()=>b,_r:()=>S,ad:()=>I,bZ:()=>w,e6:()=>D,gf:()=>a,gh:()=>A,iG:()=>E,lA:()=>c,m0:()=>v,n_:()=>m,nn:()=>h,rn:()=>g,th:()=>C,vh:()=>s,vx:()=>y,wO:()=>o});var r=i(5975),n=i(7160),s=i(8333),a=i(2945),o=i(5600),l=i(1471),d=i(1437);let u=r.create(),c=["x","y","z"],h=[n.fromValues(1,0,0),n.fromValues(0,1,0),n.fromValues(0,0,1)];n.fromValues(0,0,0);let p=s.fromValues(0,0,0,0),g=n.fromValues(1,1,1);n.fromValues(1/0,1/0,1/0);let f=a.create();function m(e){return e[0]*e[1]*e[2]}function v(e){return`${e[0]},${e[1]},${e[2]}`}function y(e,t,i){let r=t[0],n=t[1],s=t[2];return e[0]=i[0]*r+i[4]*n+i[8]*s,e[1]=i[1]*r+i[5]*n+i[9]*s,e[2]=i[2]*r+i[6]*n+i[10]*s,e}function b(e,t,i){let r=t[0],n=t[1],s=t[2];return e[0]=i[0]*r+i[1]*n+i[2]*s,e[1]=i[4]*r+i[5]*n+i[6]*s,e[2]=i[8]*r+i[9]*n+i[10]*s,e}function S(e,t,i,r){let n=e.length,s=function(e,t,i){let r=i.length,n=0;for(let i=0;i<r;++i)n+=(e[i]-t[i])**2;let s=0;for(let n=0;n<r;++n){let r=e[n];s-=(r-i[n])*(t[n]-r)}return s/Math.max(n,1e-6)}(t,i,r);s=Math.max(0,Math.min(1,s));for(let r=0;r<n;++r){let n=t[r];e[r]=n+s*(i[r]-n)}return e}function w(e,t){let i=t[0],r=t[1],n=t[2],s=t[4],a=t[5],o=t[6],l=t[8],d=t[9],u=t[10];return e[0]=i,e[1]=r,e[2]=n,e[3]=s,e[4]=a,e[5]=o,e[6]=l,e[7]=d,e[8]=u,e}function C(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],a=t[4],o=t[5],l=t[6],d=t[7],u=t[8],c=t[9],h=t[10],p=t[11],g=t[12],f=t[13],m=t[14],v=t[15];e[0]=s+i,e[1]=d+a,e[2]=p+u,e[3]=v+g,e[4]=s-i,e[5]=d-a,e[6]=p-u,e[7]=v-g,e[8]=s+r,e[9]=d+o,e[10]=p+c,e[11]=v+f,e[12]=s-r,e[13]=d-o,e[14]=p-c,e[15]=v-f;let y=s+n,b=d+l,S=p+h,w=s-n,C=d-l,x=p-h,E=Math.sqrt(y**2+b**2+S**2);e[16]=y/E,e[17]=b/E,e[18]=S/E,e[19]=(v+m)/E;let T=Math.sqrt(w**2+C**2+x**2);return e[20]=w/T,e[21]=C/T,e[22]=x/T,e[23]=(v-m)/T,e}function x(e,t,i,r,n,s,a){for(let o=0;o<6;++o){let l=a[4*o],d=a[4*o+1],u=a[4*o+2];if(Math.max(l*e,l*r)+Math.max(d*t,d*n)+Math.max(u*i,u*s)+a[4*o+3]<0)return!1}return!0}function E(e,t,i,r,n,s,a){for(let o=0;o<4;++o){let l=a[4*o],d=a[4*o+1],u=a[4*o+2];if(Math.max(l*e,l*r)+Math.max(d*t,d*n)+Math.max(u*i,u*s)+a[4*o+3]<0)return!1}{let o=a[20],l=a[21],d=a[22],u=a[23],c=Math.max(o*e,o*r)+Math.max(l*t,l*n)+Math.max(d*i,d*s),h=1e-6*Math.abs(u);if(Math.min(o*e,o*r)+Math.min(l*t,l*n)+Math.min(d*i,d*s)>-u+h||c<-u-h)return!1}return!0}function T(e,t,i,r=!1){let n=i.length,s=[],a=r?1:t+1,o=r?t+1:1;for(let r=0;r<n;++r){let n=i[r];for(let i=0;i<t;++i)0!==e[i*a+n*o]&&(s[i]=!0)}return(0,l.W0)(s,!0)}function k(e,t,i){for(let r=0;r<3;++r){let n=i[r];for(let i=0;i<3;++i)e[r+3*i]=n*t[r+3*i]}return e}function D(e){if(1===e[15]){let t=2/Math.abs(e[10]);return 2/Math.abs(e[0])*(2/Math.abs(e[5]))*t}let t=e[10],i=2*e[14]/(2*t-2);return 4/(e[0]*e[5])/3*(Math.abs((t-1)*i/(t+1))**3-Math.abs(i)**3)}function L(e){if(1===e[15])return 2/Math.abs(e[10]);let t=e[10],i=2*e[14]/(2*t-2);return Math.abs((t-1)*i/(t+1)-i)}function I(e){return e[2]=0,e[6]=0,e[10]=0,e[14]=0,e}let P=n.create();function R(e,t){t[0]=t[1]=t[2]=Number.POSITIVE_INFINITY,t[3]=t[4]=t[5]=Number.NEGATIVE_INFINITY;for(let i=0;i<8;++i){P[0]=2*(1&i)-1,P[1]=2*(i>>>1&1)-1,P[2]=2*(i>>>2&1)-1,n.transformMat4(P,P,e);for(let e=0;e<3;++e){let i=P[e];t[e]=Math.min(t[e],i),t[e+3]=Math.max(t[e+3],i)}}}function A(e,t,i,r=1e-6){function n(e){let n,a;for(let d=0;d<3;++d)if(Math.abs(s[d+3*e])>r){if(void 0===a||void 0===n)n=t[d],a=i[d];else{var o,l;if(a!==i[d]||!(Math.abs((o=n)-(l=t[d]))/Math.max(o,l)<r))return null}}return void 0===n||void 0===a?null:{scale:n,unit:a}}void 0===e&&(e=f);let s=o.create();o.fromQuat(s,e);let a=n(0),l=n(1);return a&&l?{width:a,height:l}:null}},4465:function(){if("undefined"!=typeof NEUROGLANCER_GOOGLE_TAG_MANAGER){let e="dataLayer",t=NEUROGLANCER_GOOGLE_TAG_MANAGER;window[e]=window[e]||[],window[e].push({"gtm.start":new Date().getTime(),event:"gtm.js"});let i=document.createElement("script");i.async=!0,i.src=`https://www.googletagmanager.com/gtm.js?id=${t}`,document.head.appendChild(i)}},2136:function(e,t,i){"use strict";function r(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);return t.length>=3&&31===t[0]&&139===t[1]&&8===t[2]}function n(e,t,i){return e.body.pipeThrough(new DecompressionStream(t),{signal:i})}i.d(t,{Nk:()=>n,fK:()=>r})},290:function(e,t,i){"use strict";i.d(t,{$Z:()=>G,C$:()=>C,CT:()=>O,DY:()=>T,ET:()=>F,Im:()=>d,Iq:()=>E,Iw:()=>S,JG:()=>z,Kh:()=>R,OD:()=>v,PT:()=>w,Qu:()=>$,Re:()=>N,Sc:()=>x,V3:()=>u,ZE:()=>k,ZI:()=>A,_b:()=>c,_s:()=>h,a6:()=>L,ah:()=>W,ds:()=>I,et:()=>B,f6:()=>y,gV:()=>_,hd:()=>function e(t){if("object"==typeof t){if(null===t)return"null";if(Array.isArray(t)){let i="[",r=t.length,n=0;if(0<r)for(i+=e(t[n]);++n<r;)i+=",",i+=e(t[n]);return i+"]"}let i="{",r=Object.keys(t).sort(),n=0,s=r.length;if(n<s){let a=r[n];for(i+=JSON.stringify(a),i+=":",i+=e(t[a]);++n<s;)i+=",",i+=JSON.stringify(a=r[n]),i+=":",i+=e(t[a])}return i+"}"}return"bigint"==typeof t?t.toString():JSON.stringify(t)},j2:()=>M,j5:()=>j,jz:()=>a,kt:()=>D,lu:()=>o,m7:()=>b,nH:()=>s,o7:()=>l,qG:()=>H,qs:()=>V,tw:()=>q,uq:()=>P,zE:()=>U});var r=i(686),n=i(3783);function s(e){let t=typeof e;if("number"===t||"string"===t){let t=parseFloat(""+e);if(!Number.isNaN(t))return t}throw Error(`Expected floating-point number, but received: ${JSON.stringify(e)}.`)}function a(e){let t=s(e);if(Number.isFinite(t))return t;throw Error(`Expected finite floating-point number, but received: ${t}.`)}function o(e){let t=s(e);if(Number.isFinite(t)&&t>=0)return t;throw Error(`Expected finite non-negative floating-point number, but received: ${t}.`)}function l(e){let t=a(e);if(t>0)return t;throw Error(`Expected positive finite floating-point number, but received: ${t}.`)}function d(e,t){return i=>{let r=s(i);if(r>=e&&r<=t)return r;throw Error(`Expected floating-point number in range [${e}, ${t}], but received: ${r}.`)}}function u(e,t,i=s){for(let r of(w(t),e[0]=e[1]=e[2]=0,Object.keys(t)))switch(r){case"x":e[0]=i(t[r]);break;case"y":e[1]=i(t[r]);break;case"z":e[2]=i(t[r]);break;default:throw Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(t)}.`)}return e}function c(e,t){let i=e.length;if(!Array.isArray(t)||t.length!==i)throw Error("Incompatible sizes");for(let e=0;e<i;++e)if(!Number.isFinite(parseFloat(t[e])))throw Error("Non-finite value.");for(let r=0;r<i;++r)e[r]=parseFloat(t[r]);return e}function h(e,t){let i=e.length;if(!Array.isArray(t)||t.length!==i)throw Error("Incompatible sizes.");for(let e=0;e<i;++e)if(!Number.isInteger(parseInt(t[e],void 0)))throw Error("Non-integer value.");for(let r=0;r<i;++r)e[r]=parseInt(t[r],void 0);return e}let p=/('(?:[^'\\]|(?:\\.))*')/,g=/("(?:[^"\\]|(?:\\.))*")/,f=RegExp(`${p.source}|${g.source}`),m=(RegExp(`${g.source}|${p.source}`),/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/);function v(e){return JSON.parse(function(e,t,i){let r=/[&_,]/g,n="";for(;e.length>0;){let t,i;let s=e.match(f);if(null===s)t=e,e="",i="";else{t=e.substr(0,s.index),e=e.substr(s.index+s[0].length);let r=s[1];i=void 0!==r?function(e,t,i,r){if(e.length>=2&&"'"===e.charAt(0)&&e.charAt(e.length-1)===t){let n=e.substr(1,e.length-2),s=i;for(;n.length>0;){let e=n.match(r);if(null===e){s+=n;break}s+=e[1],e[2]===i?(s+="\\",s+=i):s+=t,n=n.substr(e.index+e[0].length)}return s+i}return e}(r,"'",'"',m):s[2]}n+=t.replace(r,","),n+=i}return n}(e,0,'"'))}function y(e,t){if(!Array.isArray(e))throw Error(`Expected array, but received: ${JSON.stringify(e)}.`);if(void 0!==t&&e.length!==t)throw Error(`Expected array of length ${t}, but received: ${JSON.stringify(e)}.`);return e}function b(e,t){if(!Array.isArray(e))throw Error(`Expected array, but received: ${JSON.stringify(e)}.`);return e.map(t)}function S(e,t,i){let r=e.length;if(!Array.isArray(t)||t.length!==r)throw Error(`Expected length ${r} array, but received: ${JSON.stringify(t)}.`);for(let n=0;n<r;++n)e[n]=i(t[n],n);return e}function w(e){if("object"!=typeof e||null==e||Array.isArray(e))throw Error(`Expected JSON object, but received: ${JSON.stringify(e)}.`);return e}function C(e){let t=parseInt(e,10);if(!Number.isInteger(t))throw Error(`Expected integer, but received: ${JSON.stringify(e)}.`);return t}function x(e){let t=C(e);if(t<=0)throw Error(`Expected positive integer, but received: ${t}.`);return t}function E(e){let t=C(e);if(t<0)throw Error(`Expected non-negative integer, but received: ${t}.`);return t}function T(e,t){let i=t.get(e);if(void 0===i)throw Error(`Expected one of ${JSON.stringify(Array.from(t.keys()))}, but received: ${JSON.stringify(e)}.`);return i}function k(e){if("string"!=typeof e)throw Error(`Expected string, but received: ${JSON.stringify(e)}.`);return e}function D(e){if(void 0!==e)return k(e)}function L(e){if(void 0!==e)return C(e)}function I(e){if(void 0!==e){if("boolean"==typeof e)return e;if("true"===e)return!0;if("false"===e)return!1;throw Error(`Expected string or boolean but received: ${JSON.stringify(e)}`)}}function P(e,t,i){let r=Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0;try{return i(r)}catch(e){throw Error(`Error parsing ${JSON.stringify(t)} property: ${e.message}`)}}function R(e,t,i,r){return P(e,t,e=>void 0===e?r:i(e))}function A(e,t){w(e);let i=new Map;for(let r of Object.keys(e))try{i.set(r,t(e[r]))}catch(e){throw Error(`Error parsing value associated with key ${JSON.stringify(r)}: ${e.message}`)}return i}function M(e){if("number"!=typeof e||!Number.isFinite(e)||e<0||e>1)throw Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(e)}.`);return e}function N(e){if(""===e)return{};if(e.startsWith("{"))return v(e);let t={};for(let i of e.split(/[&;]/)){let e=i.match(/^([^=&;]+)=([^&;]*)$/);if(null===e)throw Error(`Invalid query string part: ${JSON.stringify(i)}.`);t[e[1]]=decodeURIComponent(e[2])}return t}function V(e){if(void 0===e)return"";let t=Object.keys(e);return 0===t.length?"":t.some(t=>"string"!=typeof e[t])?JSON.stringify(e):t.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}function O(e,t,i=/^[a-zA-Z]/){if("string"==typeof e&&null!==e.match(i)){let i=e.toUpperCase();if(Object.prototype.hasOwnProperty.call(t,i))return t[i]}throw Error(`Invalid enum value: ${JSON.stringify(e)}.`)}function F(e){return S(n.R3.create(),e,a)}function B(e){return S(n.R3.create(),e,l)}function _(e){return S(n.R3.create(),e,x)}function U(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)if("string"!=typeof t)throw Error(`Expected string, received: ${JSON.stringify(t)}.`);return e}function $(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)if(!Number.isInteger(t))throw Error(`Expected integer, received: ${JSON.stringify(t)}.`);return e}function z(e){if("boolean"!=typeof e)throw Error(`Expected boolean, received: ${JSON.stringify(e)}`);return e}function G(e){for(let t in e)return e}function j(e,t){if(e!==t)throw Error(`Expected ${JSON.stringify(t)}, but received: ${JSON.stringify(e)}`);return t}function W(e,t){if(void 0===e){let e=Array(t);return e.fill(null),e}return S(Array(t),e,e=>{if(null!==e&&"string"!=typeof e)throw Error(`Expected string or null, but received: ${JSON.stringify(e)}`);return e})}function q(e){let t;switch(typeof e){case"string":if(null===e.match(/^(?:0|[1-9][0-9]*)$/))throw Error(`Expected base-10 number, but received: ${JSON.stringify(e)}`);t=BigInt(e);break;case"number":t=BigInt(e);break;case"bigint":t=e;break;default:throw Error(`Expected uint64 value, but received: ${JSON.stringify(e)}`)}if(t<0n||t>r.Nr)throw Error(`Expected uint64 value, but received: ${t}`);return t}function H(e,t){return"bigint"==typeof t?t.toString():t}},3853:function(e,t,i){"use strict";let r;function n(e,t,i,r,n,s,a,o,l){for(let d=0;d<a;++d)for(let a=0;a<l;++a){let l=0;for(let e=0;e<o;++e)l+=i[d+r*e]*n[e+s*a];e[d+t*a]=l}return e}function s(e,t,i=t){return function(e,t,i){for(let r=0;r<i;++r){let n=t*r;e.fill(0,n,n+i),e[n+r]=1}return e}(new e(t*i),t,Math.min(t,i))}function a(e,t,i=!0){let r=t.length,n=i?r+1:r,s=new e(n*(r+1));i&&(s[s.length-1]=1);for(let e=0;e<r;++e)s[(n+1)*e]=t[e];return s}function o(e,t,i=!0){let r=t.length,n=i?r+1:r,a=s(e,n,r+1);for(let e=0;e<r;++e)a[n*r+e]=t[e];return a}function l(e,t,i){for(let r=0;r<i;++r)for(let n=0;n<i;++n)if(e[r*t+n]!==(r===n?1:0))return!1;return!0}function d(e,t,i,r,n,s){for(let a=0;a<s;++a){let s=a*r,o=a*t;for(let t=0;t<n;++t)e[o+t]=i[s+t]}return e}function u(e,t,i,r){d(e,t+1,i,r+1,r,r);for(let n=0;n<r;++n)e[(t+1)*t+n]=i[(r+1)*r+n];e[e.length-1]=1;for(let i=r;i<t;++i)e[(t+1)*i+i]=1;return e}function c(e,t,i,n,s){return d(e,t,i,n,s,s),function(e,t,i){let n=1;(void 0===r||r.length<i)&&(r=new Uint32Array(i));for(let e=0;e<i;++e)r[e]=e;for(let s=0;s<i;++s){let a=t*s,o=s;{let t=Math.abs(e[a+s]);for(let r=s+1;r<i;++r){let i=Math.abs(e[a+r]);i>t&&(t=i,o=r)}}if(s!==o){n*=-1;for(let r=0;r<i;++r){let i=t*r,n=e[i+s];e[i+s]=e[i+o],e[i+o]=n}{let e=r[s];r[s]=r[o],r[o]=e}}let l=e[a+s],d=1/l;n*=l;for(let r=0;r<i;++r)e[t*r+s]*=d;e[a+s]=d;for(let r=0;r<i;++r){if(r===s)continue;let n=-e[t*s+r];for(let a=0;a<i;++a){let i=t*a;e[i+r]+=n*e[i+s]}e[t*s+r]=n*d}}for(let n=0;n<i;++n){let s=r[n];for(;s!==n;){let a=t*n,o=t*s;for(let t=0;t<i;++t){let i=a+t,r=o+t,n=e[i];e[i]=e[r],e[r]=n}let l=r[n]=r[s];r[s]=s,s=l}}return n}(e,t,s)}function h(e,t,i,r,n,s){for(let a=0;a<s;++a){let s=t*a,o=r*a;for(let t=0;t<n;++t)if(e[s+t]!==i[o+t])return!1}return!0}function p(e,t,i,r,n){for(let s=0;s<n;++s){let a=t[i*n+s];for(let e=0;e<n;++e)a+=t[i*e+s]*r[e];e[s]=a}return e}function g(e,t,i,r,n){for(let s=0;s<n;++s){let a=0;for(let e=0;e<n;++e)a+=t[i*e+s]*r[e];e[s]=a}return e}function f(e,t,i,r,n,s){let a=n.length;for(let o=0;o<a;++o){let a=n[o];for(let n=0;n<s;++n)e[n*t+o]=i[n*r+a]}return e}i.d(t,{DC:()=>p,Dg:()=>h,GU:()=>l,JG:()=>d,Jp:()=>n,Kt:()=>a,SO:()=>c,XD:()=>s,Z4:()=>o,lU:()=>g,pb:()=>f,w9:()=>u})},7734:function(e,t,i){"use strict";i.d(t,{QF:()=>o,Vi:()=>r,Zi:()=>l});class r{listener;id;startTime;message;constructor(e,t){this.listener=e;let{id:i=Math.random(),startTime:r=Date.now(),message:n}=t;this.id=i,this.startTime=r,this.message=n,e.addSpan(this)}[Symbol.dispose](){this.listener.removeSpan(this.id)}}class n{items=new Map;add(e){let{items:t}=this,i=(t.get(e)??0)+1;return t.set(e,i),i}delete(e){let{items:t}=this,i=t.get(e);return i>1?(i-=1,t.set(e,i),i):(t.delete(e),0)}has(e){return this.items.has(e)}keys(){return this.items.keys()}entries(){return this.items.entries()}[Symbol.iterator](){return this.items.keys()}}class s{getKey;items;constructor(e){this.getKey=e,this.items=new Map}add(e){let{items:t}=this,i=this.getKey(e),r=t.get(i);return void 0===r?(t.set(i,{value:e,count:1}),1):r.count+=1}delete(e){return this.deleteKey(this.getKey(e))}deleteKey(e){let{items:t}=this,i=t.get(e);return void 0!==i&&i.count>1?i.count-=1:(t.delete(e),0)}has(e){return this.items.has(this.getKey(e))}*[Symbol.iterator](){for(let e of this.items.values())yield e.value}}function a(e){return e.id}class o extends s{constructor(){super(a)}}class l{spans=new o;listeners=new n;addSpan(e){if(1===this.spans.add(e))for(let t of this.listeners)t.addSpan(e)}removeSpan(e){if(0===this.spans.deleteKey(e))for(let t of this.listeners)t.removeSpan(e)}addListener(e){if(void 0!==e&&1===this.listeners.add(e))for(let t of this.spans)e.addSpan(t)}removeListener(e){if(void 0!==e&&0===this.listeners.delete(e))for(let t of this.spans)e.removeSpan(t.id)}}},6224:function(e,t,i){"use strict";function r(e=128){let t=Math.ceil(e/32),i=new Uint32Array(t);crypto.getRandomValues(i);let n="";for(let e=0;e<t;++e)n+=("00000000"+i[e].toString(16)).slice(-8);return n}function n(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,i=t.length;e<i;e+=65536)crypto.getRandomValues(t.subarray(e,Math.min(i,e+65536)));return e}function s(){let e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}i.d(t,{PP:()=>n,ZU:()=>s,c0:()=>r})},566:function(e,t,i){"use strict";i.d(t,{K_:()=>n,LP:()=>s,MZ:()=>r});class r{handlers=new Set;count=0;constructor(){let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(e=>{e.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}addOnce(e){let{handlers:t}=this;t.add(function i(...r){t.delete(i),e(...r)})}remove(e){return this.handlers.delete(e)}dispatch;dispose(){this.handlers=void 0}}class n extends r{}let s={count:0,add:e=>()=>{},addOnce(e){},remove:e=>!1}},4886:function(e,t,i){"use strict";e.exports={}},8512:function(e,t,i){"use strict";e.exports={}},7671:function(e,t,i){"use strict";e.exports={}},1167:function(e,t,i){"use strict";e.exports={}},8611:function(e,t,i){"use strict";e.exports={}},5941:function(e,t,i){"use strict";e.exports={}},3372:function(e,t,i){"use strict";e.exports={}},320:function(e,t,i){"use strict";e.exports={}},447:function(e,t,i){"use strict";e.exports={}},9760:function(e,t,i){"use strict";e.exports={}},5256:function(e,t,i){"use strict";e.exports={}},4003:function(e,t,i){"use strict";e.exports={}},7550:function(e,t,i){"use strict";e.exports={}},8213:function(e,t,i){"use strict";e.exports={}},5125:function(e,t,i){"use strict";e.exports={}},444:function(e,t,i){"use strict";e.exports={}},9651:function(e,t,i){"use strict";e.exports={}},9547:function(e,t,i){"use strict";e.exports={}},6866:function(e,t,i){"use strict";e.exports={}},2950:function(e,t,i){"use strict";e.exports={}},6700:function(e,t,i){"use strict";e.exports={}},6549:function(e,t,i){"use strict";e.exports={}},9308:function(e,t,i){"use strict";e.exports={}},7422:function(e,t,i){"use strict";e.exports={}},8263:function(e,t,i){"use strict";e.exports={}},8400:function(e,t,i){"use strict";e.exports={}},6921:function(e,t,i){"use strict";e.exports={}},4504:function(e,t,i){"use strict";e.exports={}},532:function(e,t,i){"use strict";e.exports={}},5214:function(e,t,i){"use strict";e.exports={}},7980:function(e,t,i){"use strict";e.exports={}},3938:function(e,t,i){"use strict";e.exports={}},3395:function(e,t,i){"use strict";e.exports={}},3278:function(e,t,i){"use strict";e.exports={}},1808:function(e,t,i){"use strict";e.exports={}},4636:function(e,t,i){"use strict";e.exports={}},5584:function(e,t,i){"use strict";e.exports={}},6674:function(e,t,i){"use strict";e.exports={}},677:function(e,t,i){"use strict";e.exports={}},5995:function(e,t,i){"use strict";e.exports={}},4226:function(e,t,i){"use strict";e.exports={}},8468:function(e,t,i){"use strict";e.exports={}},9215:function(e,t,i){"use strict";e.exports={}},4685:function(e,t,i){"use strict";e.exports={}},5029:function(e,t,i){"use strict";e.exports={}},5621:function(e,t,i){"use strict";e.exports={}},1399:function(e,t,i){"use strict";e.exports={}},6054:function(e,t,i){"use strict";e.exports={}},4939:function(e,t,i){"use strict";e.exports={}},389:function(e,t,i){"use strict";e.exports={}},5838:function(e,t,i){"use strict";e.exports={}},9177:function(e,t,i){"use strict";e.exports={}},4282:function(e,t,i){"use strict";e.exports={}},1069:function(e,t,i){"use strict";e.exports={}},7665:function(e,t,i){"use strict";e.exports={}},1682:function(e,t,i){"use strict";e.exports={}},200:function(e,t,i){"use strict";e.exports={}},284:function(e,t,i){"use strict";e.exports={}},7663:function(e,t,i){"use strict";let r,n,s,a,o,l,d,u,c,h,p,g,f,m;i(2374),i(3372);var v,y,b,S,w,C,x,E,T,k,D,L,I,P,R,A,M,N,V,O,F,B,_,U,$,z,G,j,W,q,H=i(1471),J=i(3719),K=i(5931),Z=i(3783);function Y(e){return("0"+e.toString(16)).slice(-2)}function X(e){try{if("string"!=typeof e)throw Error(`Expected string, but received ${JSON.stringify(e)}.`);let t=document.createElement("canvas").getContext("2d");t.fillStyle=e;let i=function(e){{let t=e.match(/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/);if(null!==t)return[parseInt(t[1],10),parseInt(t[2],10),parseInt(t[3],10),parseFloat(t[4])]}{let t=e.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/);if(null!==t)return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),1]}throw Error(`Invalid serialized color: ${JSON.stringify(e)}.`)}(t.fillStyle);return Z.vh.fromValues(i[0]/255,i[1]/255,i[2]/255,i[3])}catch(e){throw Error(`Failed to parse color specification: ${e.message}`)}}function Q(e){return X(e).subarray(0,3)}function ee(e){let t=void 0===e[3]?3:4,i=0;for(let r=0;r<t;r++)i=(i<<8>>>0)+Math.min(255,Math.max(0,Math.round(255*e[t-1-r])));return i}function et(e){return Z.R3.fromValues((e>>>0&255)/255,(e>>>8&255)/255,(e>>>16&255)/255)}function ei(e){return Z.vh.fromValues((e>>>0&255)/255,(e>>>8&255)/255,(e>>>16&255)/255,(e>>>24&255)/255)}function er(e){if(void 0===e[3]||1===e[3]){let t="#";for(let i=0;i<3;++i)t+=Y(Math.min(255,Math.max(0,Math.round(255*e[i]))));return t}let t="rgba(";for(let i=0;i<3;++i)0!==i&&(t+=", "),t+=Math.min(255,Math.max(0,Math.round(255*e[i])));return t+`, ${(0,K.i)(e[3])})`}function en(e){return e<=.03928?e/12.92:((e+.055)/1.055)**2.4}function es(e){return .179>=function(e){let[t,i,r]=e;return .2126*en(t)+.7152*en(i)+.0722*en(r)}(e)}class ea extends J.SN{defaultValue;constructor(e){super(Z.R3.clone(e)),this.defaultValue=e}toString(){return er(this.value)}toJSON(){if(!Z.R3.equals(this.value,this.defaultValue))return er(this.value)}reset(){this.value=Z.R3.clone(this.defaultValue)}restoreState(e){if(void 0===e){this.reset();return}let{value:t}=this,i=Q(e);Z.R3.equals(t,i)||(this.value=i)}}class eo extends J.SN{constructor(){super(void 0)}toJSON(){let{value:e}=this;if(void 0!==e)return er(e)}reset(){this.value=void 0}restoreState(e){if(void 0===e){this.reset();return}let{value:t}=this,i=Q(e);void 0!==t&&Z.R3.equals(t,i)||(this.value=i)}}var el=((v={})[v.UINT8=0]="UINT8",v[v.INT8=1]="INT8",v[v.UINT16=2]="UINT16",v[v.INT16=3]="INT16",v[v.UINT32=4]="UINT32",v[v.INT32=5]="INT32",v[v.UINT64=6]="UINT64",v[v.FLOAT32=7]="FLOAT32",v);let ed={0:!1,1:!0,2:!1,3:!0,4:!1,5:!0,6:!1,7:void 0},eu={0:1,1:1,2:2,3:2,4:4,5:4,6:8,7:4},ec={0:Uint8Array,1:Int8Array,2:Uint16Array,3:Int16Array,4:Uint32Array,5:Int32Array,6:BigUint64Array,7:Float32Array};var eh=i(106),ep=((y={})[y.LITTLE=0]="LITTLE",y[y.BIG=1]="BIG",y);let eg=17===new Uint8Array(Uint16Array.of(4386).buffer)[0]?1:0;var ef=i(290),em=i(686);let ev=new Float64Array(1),ey=new Uint32Array(ev.buffer),eb={[el.UINT8]:[0,255],[el.INT8]:[-128,127],[el.UINT16]:[0,65535],[el.INT16]:[-32768,32767],[el.UINT32]:[0,0xffffffff],[el.INT32]:[-0x80000000,0x7fffffff],[el.UINT64]:[0n,0xffffffffffffffffn],[el.FLOAT32]:[0,1]};function eS(e,t){let[i,r]=e;return Number(t-i)/Number(r-i)}function ew(e,t,i){let r;if("number"==typeof e[0]){let r=e[0]*(1-i)+e[1]*i;if(t!==el.FLOAT32){let e=eb[t];r=Math.round(r),r=Math.max(e[0],r),r=Math.min(e[1],r)}return r}let n=e[0],s=e[1],a=Number(s-n);return r=i>=1?s+BigInt(Math.round(a*(i-1))):n+BigInt(Math.round(a*i)),(0,em.I4)(r)}function eC(e,t){return"number"==typeof t?Math.min(Math.max(e[0],t),e[1]):(0,em.SM)((0,em.uQ)(e[0],t),e[1])}function ex(e,t){return[eC(e,t[0]),eC(e,t[1])]}function eE(e){if(0>=ek(e[0],e[1]))return e;throw Error(`Invalid interval: [${e[0]}, ${e[1]}]`)}function eT(e){return 0>=ek(e[0],e[1])?e:[e[1],e[0]]}function ek(e,t){return e<t?-1:e>t?1:0}function eD(e,t){let i;switch(i="string"!=typeof t?""+t:t,e){case el.UINT64:return(0,ef.tw)(i);case el.FLOAT32:{let e=parseFloat(i);if(!Number.isFinite(e))throw Error(`Invalid float32 value: ${JSON.stringify(i)}`);return e}default:{let t=parseInt(i),r=eb[e];if(!Number.isInteger(t)||t<r[0]||t>r[1])throw Error(`Invalid ${el[e].toLowerCase()} value: ${JSON.stringify(i)}`);return t}}}function eL(e,t){return(0,ef.Iw)([,,],e,e=>eD(t,e))}function eI(e){return(0,ef.Iw)([,,],e,e=>(function(e){if("number"==typeof e)return e;if("string"==typeof e){let t=Number(e);try{let i=(0,ef.tw)(e);if(i.toString()===t.toString())return t;return i}catch{}if(!Number.isFinite(t))throw Error(`Invalid value: ${JSON.stringify(e)}`);return t}throw Error(`Invalid value: ${JSON.stringify(e)}`)})(e))}function eP(e,t){return e[0]===t[0]&&e[1]===t[1]}function eR(e,t,i=eb[t]){if(!eP(e,i))return t===el.UINT64?[e[0].toString(),e[1].toString()]:e}function eA(e,t,i){switch(e){case el.FLOAT32:return function(e,t){if(Number.isNaN(e)||Number.isNaN(t))return NaN;if(e===t)return t;if(0===e)return t<0?-5e-324:5e-324;ev[0]=e;let i=eg===ep.LITTLE?0:1,r=1-i;return t>e==e>0?0xffffffff===ey[i]?(ey[i]=0,ey[r]+=1):ey[i]+=1:0===ey[i]?(ey[i]=0xffffffff,ey[r]-=1):ey[i]-=1,ev[0]}(t,1/0*i);case el.UINT64:return(0,em.I4)(t+BigInt(i));default:{let r=eb[e];return Math.max(r[0],Math.min(r[1],t+i))}}}function eM(e,t){switch(e){case el.FLOAT32:return 1;case el.UINT64:{let e=Number((0,em.fD)(t[0]-t[1]));return e/(e+1)}default:{let e=Math.abs(t[0]-t[1]);return e/(e+1)}}}function eN(e,t){if(void 0===e)return eb[t];let[i,r]=e;if(t===el.UINT64)return[(0,em.y7)(Number.isNaN(i)?0n:i),(0,em.y7)(Number.isNaN(r)?em.Nr:r)];if(i=Number(i),r=Number(r),t!==el.FLOAT32){i=Math.round(i),r=Math.round(r);let e=eb[t];i=Number.isFinite(i)?Math.min(Math.max(e[0],i),e[1]):e[0],r=Number.isFinite(r)?Math.min(Math.max(e[0],r),e[1]):e[1]}return[i,r]}var eV=i(6224),eO=i(566);class eF extends eh.gj{id;changed;value;constructor(e){super(),this.id=e,this.changed=new eO.K_}}var eB=((b={})[b.POINT=0]="POINT",b[b.LINE=1]="LINE",b[b.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",b[b.ELLIPSOID=3]="ELLIPSOID",b);let e_=[0,1,2,3],eU={float32:el.FLOAT32,uint32:el.UINT32,int32:el.INT32,uint16:el.UINT16,int16:el.INT16,uint8:el.UINT8,int8:el.INT8,rgb:void 0,rgba:void 0},e$={rgb:{serializedBytes:()=>3,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, true);dv.setUint8(${t} + 2, ${e} >>> 16);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, true) | (dv.getUint8(${t} + 2) << 16);`,deserializeJson:e=>ee(Q(e)),serializeJson:e=>er(et(e))},rgba:{serializedBytes:()=>4,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, true);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, true);`,deserializeJson:e=>ee(X(e)),serializeJson:e=>er(ei(e))},float32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setFloat32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getFloat32(${t}, isLittleEndian);`,deserializeJson:e=>(0,ef.nH)(e),serializeJson:e=>e},uint32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, isLittleEndian);`,deserializeJson:e=>(0,ef.C$)(e),serializeJson:e=>e},int32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setInt32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt32(${t}, isLittleEndian);`,deserializeJson:e=>(0,ef.C$)(e),serializeJson:e=>e},uint16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, isLittleEndian);`,deserializeJson:e=>(0,ef.C$)(e),serializeJson:e=>e},int16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setInt16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt16(${t}, isLittleEndian);`,deserializeJson:e=>(0,ef.C$)(e),serializeJson:e=>e},uint8:{serializedBytes:()=>1,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getUint8(${t});`,deserializeJson:e=>(0,ef.C$)(e),serializeJson:e=>e},int8:{serializedBytes:()=>2,alignment:()=>1,serializeCode:(e,t)=>`dv.setInt8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getInt8(${t});`,deserializeJson:e=>(0,ef.C$)(e),serializeJson:e=>e}};function ez(e,t,i){let r=0,n=i.length,s=Array(n),a=[];for(let e=0;e<n;++e)s[e]=e;let o=t=>e$[i[t].type].alignment(e);s.sort((e,t)=>o(t)-o(e));let l=0,d=Array(n),u=t,c=()=>{u+=(4-u%4)%4,r+=u,a[l]=u,u=0,++l};for(let t=0;t<n;++t){let r=s[t],n=e$[i[r].type],a=n.serializedBytes(e),o=n.alignment(e),h=(o-u%o)%o,p=u+h+a;p+(4-p%4)%4<=255?u+=h:c(),d[r]={offset:u,group:l},u+=a}return c(),{serializedBytes:r,offsets:d,propertyGroupBytes:a}}class eG{rank;firstGroupInitialOffset;propertySpecs;serializedBytes;serialize;deserialize;propertyGroupBytes;constructor(e,t,i){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=i,0===i.length){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}let{serializedBytes:r,offsets:n,propertyGroupBytes:s}=ez(e,t,i);this.propertyGroupBytes=s;let a="let groupOffset0 = offset;";for(let e=1;e<s.length;++e)a+=`let groupOffset${e} = groupOffset${e-1} + ${s[e-1]}*annotationCount;`;for(let e=0;e<s.length;++e)a+=`groupOffset${e} += ${s[e]}*annotationIndex;`;let o=a,l=a,d=i.length;for(let t=0;t<d;++t){let{group:r,offset:s}=n[t],a=e$[i[t].type],d=`properties[${t}]`,u=`groupOffset${r} + ${s}`;o+=a.serializeCode(d,u,e),l+=a.deserializeCode(d,u,e)}this.serializedBytes=r,this.serialize=Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",o),this.deserialize=Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",l)}}function ej(e,t){let i=[];for(let r of e_){let n=e1[r];i[r]=new eG(e,n.serializedBytes(e),t)}return i}function eW(e,t){let i="float32"===e.type?t.toPrecision(6):t.toString(),{enumValues:r,enumLabels:n}=e;if(void 0!==r){let e=r.indexOf(t);if(-1!==e)return`${n[e]} (${i})`}return i}function eq(e){let t=(0,ef.ZE)(e);if(null===t.match(/^[a-z][a-zA-Z0-9_]*$/))throw Error(`Invalid property identifier: ${JSON.stringify(e)}`);return t}function eH(e){if((0,ef.ZE)(e),!Object.prototype.hasOwnProperty.call(e$,e))throw Error("Unsupported property type: $JSON.stringify(obj)}");return e}function eJ(e){let t,i;(0,ef.PT)(e);let r=(0,ef.uq)(e,"id",eq),n=(0,ef.uq)(e,"type",eH),s=(0,ef.Kh)(e,"description",ef.ZE),a=(0,ef.Kh)(e,"default",e=>e$[n].deserializeJson(e),0);switch(n){case"rgb":case"rgba":break;default:{let r=el[n.toUpperCase()];void 0!==(t=(0,ef.Kh)(e,"enum_values",e=>(0,ef.m7)(e,e=>eD(r,e))))&&(i=(0,ef.uq)(e,"enum_labels",e=>(0,ef.Iw)(Array(t.length),e,ef.ZE)))}}return{type:n,identifier:r,description:s,default:a,enumValues:t,enumLabels:i}}function eK(e){let t=e.default,i=e$[e.type],r="rgb"!==e.type&&"rgba"!==e.type,n=r&&e.enumValues?e.enumValues.map(i.serializeJson):void 0,s=r?e.enumLabels:void 0;return{id:e.identifier,description:e.description,type:e.type,default:0===t?void 0:i.serializeJson(t),enum_labels:s,enum_values:n}}function eZ(e){if(void 0===e)return[];let t=(0,ef.m7)(e,eJ);return!function(e){let t=new Set;for(let i of e){if(t.has(i.identifier))throw Error(`Duplicate property identifier: ${i.identifier}`);t.add(i.identifier)}}(t),t}function eY(e,t,i,r,n){for(let s=0;s<r;++s)e.setFloat32(t,n[s],i),t+=4;return t}function eX(e,t,i,r,n,s){return t=eY(e,t,i,r,n),t=eY(e,t,i,r,s)}function eQ(e,t,i,r,n){for(let s=0;s<r;++s)n[s]=e.getFloat32(t,i),t+=4;return t}function e0(e,t,i,r,n,s){return t=eQ(e,t,i,r,n),t=eQ(e,t,i,r,s)}let e1={1:{icon:"ꕹ",description:"Line",toJSON:e=>({pointA:Array.from(e.pointA),pointB:Array.from(e.pointB)}),restoreState(e,t,i){e.pointA=(0,ef.uq)(t,"pointA",e=>(0,ef.Iw)(new Float32Array(i),e,ef.jz)),e.pointB=(0,ef.uq)(t,"pointB",e=>(0,ef.Iw)(new Float32Array(i),e,ef.jz))},serializedBytes:e=>8*e,serialize(e,t,i,r,n){eX(e,t,i,r,n.pointA,n.pointB)},deserialize:(e,t,i,r,n)=>{let s=new Float32Array(r),a=new Float32Array(r);return e0(e,t,i,r,s,a),{type:1,pointA:s,pointB:a,id:n,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},0:{icon:"⚬",description:"Point",toJSON:e=>({point:Array.from(e.point)}),restoreState:(e,t,i)=>{e.point=(0,ef.uq)(t,"point",e=>(0,ef.Iw)(new Float32Array(i),e,ef.jz))},serializedBytes:e=>4*e,serialize:(e,t,i,r,n)=>{eY(e,t,i,r,n.point)},deserialize:(e,t,i,r,n)=>{let s=new Float32Array(r);return eQ(e,t,i,r,s),{type:0,point:s,id:n,properties:[]}},visitGeometry(e,t){t(e.point,!1)}},2:{icon:"❑",description:"Bounding Box",toJSON:e=>({pointA:Array.from(e.pointA),pointB:Array.from(e.pointB)}),restoreState:(e,t,i)=>{e.pointA=(0,ef.uq)(t,"pointA",e=>(0,ef.Iw)(new Float32Array(i),e,ef.jz)),e.pointB=(0,ef.uq)(t,"pointB",e=>(0,ef.Iw)(new Float32Array(i),e,ef.jz))},serializedBytes:e=>8*e,serialize(e,t,i,r,n){eX(e,t,i,r,n.pointA,n.pointB)},deserialize:(e,t,i,r,n)=>{let s=new Float32Array(r),a=new Float32Array(r);return e0(e,t,i,r,s,a),{type:2,pointA:s,pointB:a,id:n,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},3:{icon:"◎",description:"Ellipsoid",toJSON:e=>({center:Array.from(e.center),radii:Array.from(e.radii)}),restoreState:(e,t,i)=>{e.center=(0,ef.uq)(t,"center",e=>(0,ef.Iw)(new Float32Array(i),e,ef.jz)),e.radii=(0,ef.uq)(t,"radii",e=>(0,ef.Iw)(new Float32Array(i),e,ef.lu))},serializedBytes:e=>8*e,serialize(e,t,i,r,n){eX(e,t,i,r,n.center,n.radii)},deserialize:(e,t,i,r,n)=>{let s=new Float32Array(r),a=new Float32Array(r);return e0(e,t,i,r,s,a),{type:3,center:s,radii:a,id:n,properties:[]}},visitGeometry(e,t){t(e.center,!1),t(e.radii,!0)}}};function e2(e,t){let i=e1[e.type].toJSON(e,t.rank);i.type=eB[e.type].toLowerCase(),i.id=e.id,i.description=e.description||void 0;let{relatedSegments:r}=e;if(r?.some(e=>0!==e.length)&&(i.segments=r.map(e=>Array.from(e,e=>e.toString()))),0!==t.properties.length){let r=t.properties;i.props=e.properties.map((e,t)=>e$[r[t].type].serializeJson(e))}return i}class e3 extends eh.gj{relationships;properties;annotationMap;changed;readonly;childAdded;childUpdated;childCommitted;childDeleted;pending;rank_;get rank(){return this.rank_}annotationPropertySerializers;constructor(e,t=[],i=[]){super(),this.relationships=t,this.properties=i,this.annotationMap=new Map,this.changed=new eO.K_,this.readonly=!1,this.childAdded=new eO.MZ,this.childUpdated=new eO.MZ,this.childCommitted=new eO.MZ,this.childDeleted=new eO.MZ,this.pending=new Set,this.references=new Map,this.rank_=e,this.annotationPropertySerializers=ej(e,i)}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),e.id){if(this.annotationMap.has(e.id))throw Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`)}else e.id=e6();return this.annotationMap.set(e.id,e),t||this.pending.add(e.id),this.changed.dispatch(),this.childAdded.dispatch(e),t&&this.childCommitted.dispatch(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();let t=e.id;this.pending.delete(t),this.changed.dispatch(),this.childCommitted.dispatch(t)}update(e,t){if(this.ensureUpdated(),null===e.value)throw Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){null!==e.value&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return void 0!==t?t.addRef():((t=new eF(e)).value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}references;ensureUpdated(){}toJSON(){this.ensureUpdated();let e=[],{pending:t}=this;for(let i of this)!t.has(i.id)&&e.push(e2(i,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();let{annotationMap:t}=this;for(let i of(t.clear(),this.pending.clear(),void 0!==e&&(0,ef.m7)(e,e=>{let i=function(e,t,i=!1){(0,ef.PT)(e);let r=(0,ef.uq)(e,"type",e=>(0,ef.CT)(e,eB)),n=(0,ef.uq)(e,"id",i?ef.kt:ef.ZE)||e6(),s=(0,ef.uq)(e,"segments",e=>{if(void 0===e)return t.relationships.map(()=>[]);let i=(0,ef.f6)(e);return 0===i.length?t.relationships.map(()=>[]):1!==t.relationships.length||Array.isArray(i[0])?(0,ef.m7)((0,ef.f6)(e,t.relationships.length),e=>(e=(0,ef.f6)(e),(0,ef.Iw)(new BigUint64Array(e.length),e,ef.tw))):[(0,ef.Iw)(new BigUint64Array(i.length),i,ef.tw)]}),a=(0,ef.uq)(e,"props",e=>{let i=t.properties;return void 0===e?i.map(e=>e.default):(0,ef.m7)((0,ef.f6)(e,t.properties.length),(e,t)=>e$[i[t].type].deserializeJson(e))}),o={id:n,description:(0,ef.uq)(e,"description",ef.kt),relatedSegments:s,properties:a,type:r};return e1[r].restoreState(o,e,t.rank),o}(e,this);t.set(i.id,i)}),this.references.values())){let{id:e}=i,r=t.get(e);i.value=r||null,i.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}}class e4 extends e3{watchableTransform;curCoordinateTransform;get rank(){return this.ensureUpdated(),this.rank_}constructor(e,t,i){super(e.value.sourceRank,i,t),this.watchableTransform=e,this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}ensureUpdated(){let e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;let i=e.sourceRank,r=t.sourceRank;if(r===i&&(t.inputSpace===e.inputSpace||(0,H.cO)(t.inputSpace.ids.slice(0,i),e.inputSpace.ids.slice(0,i))))return;let{ids:n}=e.inputSpace,s=t.inputSpace.ids,a=[];for(let e=0;e<i;++e){let t=s.indexOf(n[e]);t>=r&&(t=-1),a.push(t)}let o=e=>{let t=new Float32Array(i);for(let r=0;r<i;++r){let i=a[r];t[r]=-1===i?0:e[r]}return t};for(let e of this.annotationMap.values())switch(e.type){case 0:e.point=o(e.point);break;case 1:case 2:e.pointA=o(e.pointA),e.pointB=o(e.pointB);break;case 3:e.center=o(e.center),e.radii=o(e.radii)}this.rank_!==i&&(this.rank_=i,this.annotationPropertySerializers=ej(this.rank_,this.properties)),this.changed.dispatch()}}function e6(){return(0,eV.c0)(160)}function e5(e){let t=new e3(e.lowerBounds.length);return t.readonly=!0,t.add({type:2,id:"data-bounds",description:"Data Bounds",pointA:new Float32Array(e.lowerBounds),pointB:new Float32Array(e.upperBounds),properties:[]}),t}class e8{propertySerializers;annotations;constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return function(e,t){let i=0,r=[];for(let n of e_){let s=t[n].serializedBytes;r[n]=i,i+=s*e[n].length}let n=[],s=[],a=new ArrayBuffer(i),o=new DataView(a),l=eg===ep.LITTLE;for(let i of e_){let a=t[i],{rank:d}=a,u=a.serialize,c=e[i];n[i]=c.map(e=>e.id),s[i]=new Map(c.map((e,t)=>[e.id,t]));let h=e1[i].serialize,p=r[i],g=a.propertyGroupBytes[0];for(let e=0,t=c.length;e<t;++e){let i=c[e];h(o,p+e*g,l,d,i),u(o,p,e,t,l,i.properties)}}return{data:new Uint8Array(a),typeToIds:n,typeToOffset:r,typeToIdMaps:s}}(this.annotations,this.propertySerializers)}}var e9=i(3853);let e7=[{prefix:"Y",exponent:24,longPrefix:"yotta"},{prefix:"Z",exponent:21,longPrefix:"zetta"},{prefix:"E",exponent:18,longPrefix:"exa"},{prefix:"P",exponent:15,longPrefix:"peta"},{prefix:"T",exponent:12,longPrefix:"tera"},{prefix:"G",exponent:9,longPrefix:"giga"},{prefix:"M",exponent:6,longPrefix:"mega"},{prefix:"k",exponent:3,longPrefix:"kilo"},{prefix:"",exponent:0,longPrefix:""},{prefix:"m",exponent:-3,longPrefix:"milli"},{prefix:"\xb5",exponent:-6,longPrefix:"micro"},{prefix:"n",exponent:-9,longPrefix:"nano"},{prefix:"p",exponent:-12,longPrefix:"pico"},{prefix:"f",exponent:-15,longPrefix:"femto"},{prefix:"a",exponent:-18,longPrefix:"atto"},{prefix:"z",exponent:-21,longPrefix:"zepto"},{prefix:"y",exponent:-24,longPrefix:"yocto"}],te=[...e7,{prefix:"h",exponent:2,longPrefix:"hecto"},{prefix:"da",exponent:1,longPrefix:"deca"},{prefix:"d",exponent:-1,longPrefix:"deci"},{prefix:"c",exponent:-2,longPrefix:"centi"}],tt=[{prefix:"u",exponent:-6},...te],ti=new Map;ti.set("",{unit:"",exponent:0});let tr=new Map;for(let{prefix:e,exponent:t}of tt)for(let i of(tr.set(t,e),["m","s","Hz","rad/s"]))ti.set(`${e}${i}`,{unit:i,exponent:t});function tn(e){let t=Math.log10(e),i=e7.length;return e7[Math.min((0,H.Kq)(0,i,e=>e7[e].exponent<=t),i-1)]}function ts(e,t,i={}){let r;let{precision:n=6,elide1:s=!0}=i,a=e,o="";if(""!==t){let t=tn(e);o=t.prefix,a=td(e,-t.exponent)}if(s&&1===a)return{scale:"",unit:t,prefix:o};if(0!==n){let e,t;let i=(r=a<1||a>=1e3?a.toPrecision(n):a.toFixed(n)).indexOf("e");-1!==i?(e=r.substring(0,i),t=r.substring(i)):(e=r,t="");let s=e.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);null!==s&&((e=e.substring(0,e.length-s[1].length)).endsWith(".")&&(e=e.substring(0,e.length-1)),r=e+t)}else r=a.toString();return{scale:r,unit:t,prefix:o}}function ta(e,t,i){let{scale:r,unit:n,prefix:s}=ts(e,t,i);return`${r}${s}${n}`}function to(e){if(""===e)return{scale:1,unit:""};let t=e.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(null===t)return;let i=t[1],r=void 0===i?1:Number(i);if(Number.isNaN(r))return;let n="";if(void 0!==t[2]){let e=ti.get(t[2]);if(void 0===e)return;n=e.unit,e.exponent>0?r*=10**e.exponent:r/=10**-e.exponent}if(!(r<=0)&&Number.isFinite(r))return{scale:r,unit:n}}function tl(e){let t=ti.get(e);if(void 0===t)throw Error(`Invalid unit: ${JSON.stringify(e)}`);return t}function td(e,t){return t>=0?e*10**t:e/10**-t}function tu(e,t,i){let r=e.length;for(let n=0;n<r;++n)e[n]=t[n]+i[n];return e}function tc(e,t,i){let r=e.length;for(let n=0;n<r;++n)e[n]=t[n]-i[n];return e}function th(e){let t=1;for(let i=0,r=e.length;i<r;++i)t*=e[i];return t}let tp=new Float32Array(0),tg=new Float64Array(0);Float64Array.of(1,1,1);let tf=0;function tm(e,t){return void 0===e?void 0===t:void 0!==t&&e.explicit===t.explicit&&(0,H.cO)(e.coordinates,t.coordinates)&&(0,H.cO)(e.labels,t.labels)}function tv(e){if(1===e.length)return e[0];let t=new Map,i=!1;for(let r of e){r.explicit&&(i=!0);let{coordinates:e,labels:n}=r;for(let i=0,r=e.length;i<r;++i)t.set(e[i],n[i])}let r=Array.from(t.keys());r.sort((e,t)=>e-t);let n=Array.from(r,e=>t.get(e));return{explicit:i,coordinates:r,labels:n}}function ty(e){if(0!==(e=e.filter(e=>void 0!==e)).length)return tv(e)}function tb(e,t){var i,r;return(0,H.cO)(e.transform,t.transform)&&(i=e.box,r=t.box,(0,H.cO)(i.lowerBounds,r.lowerBounds)&&(0,H.cO)(i.upperBounds,r.upperBounds))}function tS(e,t){return e.valid===t.valid&&e.rank===t.rank&&(0,H.cO)(e.names,t.names)&&(0,H.cO)(e.ids,t.ids)&&(0,H.cO)(e.timestamps,t.timestamps)&&(0,H.cO)(e.units,t.units)&&(0,H.cO)(e.scales,t.scales)&&(0,H.eK)(e.boundingBoxes,t.boundingBoxes,tb)&&(0,H.eK)(e.coordinateArrays,t.coordinateArrays,tm)}function tw(e){let{names:t,units:i,scales:r}=e,{valid:n=!0,rank:s=t.length,timestamps:a=t.map(()=>Number.NEGATIVE_INFINITY),ids:o=t.map((e,t)=>-t),boundingBoxes:l=[]}=e,{coordinateArrays:d=Array(s)}=e,{bounds:u=function(e,t){let i=new Float64Array(t),r=new Float64Array(t);i.fill(Number.NEGATIVE_INFINITY),r.fill(Number.POSITIVE_INFINITY);let n=Array(t);n.fill(0);let s=Array(t);for(let a of(s.fill(0),e))for(let e=0;e<t;++e){let o=tR(a,e,t);if(void 0===o)continue;let{lower:l,upper:d}=o;if(Number.isFinite(l)&&Number.isFinite(d)){let t,i,r,a;.001>Math.abs(l-(t=Math.round(l)))&&.001>Math.abs(d-(i=Math.round(d)))?(++s[e],l=t,d=i):.001>Math.abs(l-(r=Math.floor(l))-.5)&&.001>Math.abs(d-(a=Math.floor(d))-.5)&&(++n[e],l=r+.5,d=a+.5)}i[e]=i[e]===Number.NEGATIVE_INFINITY?l:Math.min(i[e],l),r[e]=r[e]===Number.POSITIVE_INFINITY?d:Math.max(r[e],d)}return{lowerBounds:i,upperBounds:r,voxelCenterAtIntegerCoordinates:s.map((e,t)=>n[t]>0&&0===e)}}(l,s)}=e;return{valid:n,rank:s,names:t,timestamps:a,ids:o,units:i,scales:r,boundingBoxes:l,bounds:u,coordinateArrays:d}}let tC=tw({valid:!1,names:[],units:[],scales:tg,boundingBoxes:[]}),tx=tw({valid:!0,names:[],units:[],scales:tg,boundingBoxes:[]});function tE(e,t=!1){if(void 0===e)return tC;(0,ef.PT)(e);let i=tH(Object.keys(e),t),r=i.length,n=Array(r),s=new Float64Array(r),a=Array(r);for(let t=0;t<r;++t)(0,ef.uq)(e,i[t],e=>{if(Array.isArray(e)){let{unit:i,scale:r}=function(e){let[t,i]=(0,ef.f6)(e,2),r=(0,ef.o7)(t),n=(0,ef.ZE)(i),s=ti.get(n);if(void 0===s)throw Error(`Invalid unit: ${JSON.stringify(n)}`);return{unit:s.unit,scale:td(r,s.exponent)}}(e);n[t]=i,s[t]=r}else{(0,ef.PT)(e);let i=(0,ef.uq)(e,"coordinates",ef.Qu),r=(0,ef.uq)(e,"labels",ef.zE),o=i.length;if(o!==r.length)throw Error(`Length of coordinates array (${o}) does not match length of labels array (${r.length})`);n[t]="",s[t]=1,a[t]={explicit:!0,...function(e,t){let i=new Map;for(let r=0,n=e.length;r<n;++r)i.set(e[r],t[r]);return(e=Array.from(i.keys())).sort((e,t)=>e-t),t=Array.from(e,e=>i.get(e)),{coordinates:e,labels:t}}(i,r)}}});return tw({valid:!1,names:i,units:n,scales:s,coordinateArrays:a})}function tT(e){let{rank:t}=e;if(0===t)return;let{names:i,units:r,scales:n,coordinateArrays:s}=e,a={};for(let e=0;e<t;++e){let t=i[e],o=s[e];o?.explicit?a[t]={coordinates:Array.from(o.coordinates),labels:o.labels}:a[t]=[n[e],r[e]]}return a}class tk extends J.SN{constructor(){super(tC)}toJSON(){return tT(this.value)}reset(){this.value=tC}restoreState(e){this.value=tE(e)}}function tD(e,t){let i=e.lowerBounds[t],r=e.upperBounds[t];return e.voxelCenterAtIntegerCoordinates[t]&&(i+=.5,r+=.5),[i,r]}function tL(e,t,i){var r;return r=i=function(e,t,i){let r=e.upperBounds[t];Number.isFinite(r)&&(i=Math.min(i,r-1));let n=e.lowerBounds[t];return Number.isFinite(n)&&(i=Math.max(i,n)),i}(e,t,i),r=e.voxelCenterAtIntegerCoordinates[t]?Math.round(r):Math.floor(r)+.5}function tI(e,t){let i=(e+t)/2;return Number.isFinite(i)||(i=Math.min(Math.max(0,e),t)),i}function tP(e){let t=e.lowerBounds.length;return{box:e,transform:e9.XD(Float64Array,t,t+1)}}function tR(e,t,i){let{box:{lowerBounds:r,upperBounds:n},transform:s}=e,a=r.length,o=s[i*a+t],l=o,d=o,u=!1;for(let e=0;e<a;++e){let a=s[i*e+t];if(0===a)continue;let o=a*r[e],c=a*n[e];l+=Math.min(o,c),d+=Math.max(o,c),u=!0}if(u)return{lower:l,upper:d}}function tA(e,t){let i={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},r=new Float64Array(2*e);return r[t]=1,{transform:r,box:i}}function tM(e,t,i){if(t===i)return e;let{box:r}=e,n=r.lowerBounds.length,s=new Float64Array((n+1)*i);return e9.JG(s,i,e.transform,t,t,n+1),{box:r,transform:s}}function tN(e){return{rank:e.rank,sourceRank:e.rank,inputSpace:e,outputSpace:e,transform:e9.XD(Float64Array,e.rank+1)}}function tV(e,t,i){return e.boundingBoxes.map(r=>(function(e,t,i,r){let{transform:n,box:s}=e,a=e.box.lowerBounds.length,o=r.length,l=new Float64Array((a+1)*o);for(let e=0;e<o;++e){let s=r[e];for(let r=0;r<a;++r){let a=0;for(let l=0;l<o;++l){let d=i[l];a+=t[(o+1)*l+e]*n[o*r+l]*(d/s)}l[o*r+e]=a}let d=t[(o+1)*o+e];for(let r=0;r<o;++r){let l=i[r];d+=t[(o+1)*r+e]*n[o*a+r]*(l/s)}l[a*o+e]=d}return{transform:l,box:s}})(r,t,e.scales,i))}function tO(e,t,i){let r=tw({valid:e.valid,rank:i.rank,ids:i.ids,names:i.names,timestamps:i.timestamps,scales:i.scales,units:i.units,boundingBoxes:tV(e,t,i.scales),coordinateArrays:i.coordinateArrays});return tS(r,i)?i:r}function tF(e,t=!1){if(t){let t=Number(e);if(Number.isInteger(t)&&t>=0)return!0}return null!==e.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)}function tB(e,t=!1){let i=new Set;for(let r of e){if(!tF(r,t)||i.has(r))return!1;i.add(r)}return!0}function t_(e){let t=e.length,i=Array(t);i.fill(!0);for(let r=0;r<t;++r){let t=e[r];if(!tF(t)){i[r]=!1;continue}let n=e.indexOf(t,r+1);-1!==n&&(i[r]=!1,i[n]=!1)}return i}function tU(e){return e.endsWith("'")}function t$(e){return e.endsWith("'")||e.endsWith("^")}function tz(e){return e.endsWith("^")}function tG(e){return!t$(e)}function tj(e,t,i,r,n,s){if(!e9.Dg(e,t+1,r,n+1,t,t))return!1;for(let a=0;a<t;++a){let o=e[(t+1)*t+a],l=r[(n+1)*n+a];if(o*(i[a]/s[a])!==l)return!1}for(let e=t;e<n;++e)if(0!==r[(n+1)*n+e])return!1;for(let e=t;e<n;++e){for(let i=0;i<t;++i)if(0!==r[(n+1)*i+e])return!1;for(let t=0;t<n;++t){let i=r[(n+1)*e+t];if(e===t){if(1!==i)return!1}else if(0!==i)return!1}}return!0}function tW(e){let t=tO(e.inputSpace,e.transform,e.outputSpace);return t===e.outputSpace?e:{rank:e.rank,sourceRank:e.sourceRank,inputSpace:e.inputSpace,transform:e.transform,outputSpace:t}}class tq{mutableSourceRank;value_;outputSpace;inputSpace;changed;inputSpaceChanged;defaultTransform;constructor(e,t=!1){this.mutableSourceRank=t,this.value_=void 0,this.changed=new eO.K_,this.inputSpaceChanged=new eO.K_,this.defaultTransform=tW(e);let i=this;this.outputSpace={changed:i.changed,get value(){return i.value.outputSpace},set value(newOutputSpace){let{value:e}=i;if(tS(e.outputSpace,newOutputSpace)||e.rank!==newOutputSpace.rank)return;let t=function(e,t,i){let r=new Float64Array(e),n=t.length,s=(n+1)*n;for(let e=0;e<n;++e)r[s+e]*=t[e]/i[e];return r}(e.transform,e.outputSpace.scales,newOutputSpace.scales);i.value_={sourceRank:e.sourceRank,rank:e.rank,inputSpace:e.inputSpace,outputSpace:tO(e.inputSpace,t,newOutputSpace),transform:t},i.changed.dispatch()}},this.inputSpace={changed:i.inputSpaceChanged,get value(){return i.value.inputSpace},set value(newInputSpace){let{value:e}=i;if(tS(e.inputSpace,newInputSpace))return;i.value_=function(e,t){let{inputSpace:i,transform:r}=e,{ids:n,rank:s}=i,{rank:a,names:o,units:l,scales:d}=t,u=Array(s);u.fill(!0);let c=[],h=t.ids.map((e,t)=>{let i=n.indexOf(e);return -1!==i?u[i]=!1:c.push(t),i}),{outputSpace:p}=e,{names:g,units:f,scales:m,ids:v,timestamps:y,coordinateArrays:b}=p,S=[],w=[],C=new Float64Array(a),x=[],E=[],T=Array(a),k=0,D=new Float64Array((a+1)**2);D[D.length-1]=1;for(let e=0;e<s;++e)if(!u[e]){S[k]=g[e],x[k]=v[e],w[k]=f[e],C[k]=m[e],E[k]=y[e],T[k]=b[e];for(let t=0;t<a;++t){let i=h[t];-1!==i&&(D[t*(a+1)+k]=r[i*(s+1)+e])}D[a*(a+1)+k]=r[s*(s+1)+e],++k}for(let e of c)x[k]=++tf,S[k]=function(e,t){if(!t.includes(e))return e;let[,i,r]=e.match(/^([^']*)('?)$/);for(let e=0;;++e){let n=`${i}${e}${r}`;if(!t.includes(n))return n}}(o[e],S),C[k]=d[e],w[k]=l[e],D[e*(a+1)+k]=1,++k;let L=tw({valid:t.valid,rank:a,names:S,ids:x,timestamps:E,units:w,scales:C,boundingBoxes:tV(t,D,C),coordinateArrays:T});return{rank:a,sourceRank:e.sourceRank,inputSpace:t,outputSpace:L,transform:D}}(e,newInputSpace),i.inputSpaceChanged.dispatch(),i.changed.dispatch()}}}set value(e){let t=this.value;e!==t&&(this.value_=tW(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return void 0===e&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){let{value:e}=this,{rank:t,transform:i,inputSpace:r,outputSpace:n,sourceRank:s}=e,{defaultTransform:a,mutableSourceRank:o}=this,{inputSpace:l,rank:d,transform:u,outputSpace:c}=a,{units:h,scales:p}=r,g=s===t&&(0,H.cO)(p,o?n.scales:l.scales)&&(0,H.cO)(h,o?n.units:l.units),f=tj(u,d,c.scales,i,t,n.scales),m=(0,H.cO)(c.names,n.names);if(!f||!m||!g)return{sourceRank:s,transform:f?void 0:i,outputSpace:e.outputSpace,inputSpace:g?void 0:r}}set transform(e){let{value:t}=this,{inputSpace:i}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:i,transform:e,outputSpace:tO(i,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(void 0===e){this.reset();return}if(this.mutableSourceRank){let t=e.inputSpace||e.outputSpace,i=t.rank,r=tw({rank:i,names:t.names.map((e,t)=>`${t}`),units:t.units,scales:t.scales,coordinateArrays:t.coordinateArrays});this.value={rank:i,transform:e.transform||e9.XD(Float64Array,i+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:r};return}let{inputSpace:t,sourceRank:i,outputSpace:r,transform:n,rank:s}=this.defaultTransform,{inputSpace:a,sourceRank:o,outputSpace:l,transform:d}=e,u=e.outputSpace.rank,c=t.names,h=void 0!==a?a.names:c,p=Array(i);for(let e=0;e<i;++e){let t=h.indexOf(c[e]);t>=o&&(t=-1),p[e]=t}let g=u-o+i;for(let e=o;e<u;++e)p[i+e-o]=e;let f=new Float64Array(g),m=Array(g),v=[];for(let e=0;e<i;++e){let i=p[e];-1===i||void 0===a?(f[e]=t.scales[e],v[e]=t.units[e],m[e]=t.coordinateArrays[e]):(f[e]=a.scales[i],v[e]=a.units[i],m[e]=ty([t.coordinateArrays[e],a.coordinateArrays[i]]))}let y=a||l,b=c.slice(0,i),S=r.names.slice(0,i),w=r.coordinateArrays.slice(0,i),C=new Float64Array(g),x=[];for(let e=0;e<g;++e){let t=p[e];-1===t?(C[e]=r.scales[e],x[e]=r.units[e],w[e]=r.coordinateArrays[e]):(S[e]=l.names[t],x[e]=l.units[t],C[e]=l.scales[t],w[e]=l.coordinateArrays[t])}if(!tB(S)){this.reset();return}for(let e=i;e<g;++e){let t=e-i+o;f[e]=y.scales[t],v[e]=y.units[t],b[e]=`${e}`}let E=new Float64Array((g+1)**2);E[E.length-1]=1;for(let e=0;e<g;++e){let t;let a=p[e];t=-1===a||void 0===d?e>=i?0:n[s*(s+1)+e]*(r.scales[e]/C[e]):d[u*(u+1)+a],E[g*(g+1)+e]=t;for(let t=0;t<g;++t){let r;let o=p[t];r=-1===a!=(-1===o)?0:-1===a||void 0===d?a>=i||o>=i?a===o?1:0:n[t*(s+1)+e]:d[o*(u+1)+a],E[t*(g+1)+e]=r}}let T=t.boundingBoxes.map(e=>tM(e,s,g));for(let e=i;e<g;++e)T.push(tA(g,e));for(let e=0;e<g;++e){let t;if(0!==E[g*(g+1)+e])continue;for(let i=0;i<g;++i){let r=E[i*(g+1)+e];if(0!==r){if(1===r){if(void 0===t)t=i;else{t=null;break}}else{t=null;break}}}if(null==t)continue;let i=m[t];void 0!==i&&(i.explicit&&(i={...i,explicit:!1}),w[e]=ty([i,w[e]]))}this.value={rank:g,transform:E,sourceRank:i,outputSpace:tw({rank:g,names:S,scales:C,units:x,coordinateArrays:w}),inputSpace:tw({rank:g,names:b,scales:f,units:v,coordinateArrays:m,boundingBoxes:T})}}toJSON(){return tX(this.spec)}restoreState(e){this.spec=tY(e)}}function tH(e,t=!1){let i=(0,ef.m7)(e,e=>(function(e,t=!1){let i=(0,ef.ZE)(e);if(!tF(i,t))throw Error(`Invalid dimension name: ${JSON.stringify(i)}`);return i})(e,t));if(!tB(i,t))throw Error(`Invalid dimensions: ${JSON.stringify(i)}`);return i}class tJ{combined;bindings;retainCount;prevCombined;dimensionRefCounts;getRenameValidity(e){let t=this.combined.value.names,i=t_(e),r=e.length;for(let n=0;n<r;++n){if(!i[n])continue;let r=e[n];if(t.includes(r))continue;let s=!0;for(let e of this.bindings)if(e.space.value.names.includes(r)){s=!1;break}i[n]=s}return i}includeDimensionPredicate_;get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}constructor(e,t){this.combined=e,this.bindings=new Set,this.retainCount=0,this.dimensionRefCounts=new Map,this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()},this.includeDimensionPredicate_=t,this.prevCombined=this.combined.value}update(){let{combined:e,bindings:t}=this,i=this.retainCount>0?1:0;if(0===t.size&&!i){e.value=tC;return}let r=this.includeDimensionPredicate_,n=e.value,s=Array.from(n.names),a=Array.from(n.units),o=Array.from(n.scales),l=Array.from(n.ids),d=Array.from(n.timestamps),u=n.names.map(()=>i?1:0),c=[],h=!1;for(let e of t){let{space:{value:t},prevValue:n,mappedDimensionIds:p}=e;h=h||t.valid;let{names:g,units:f,scales:m,ids:v,timestamps:y}=t,b=[],S=[];c.push(S),e.mappedDimensionIds=b,e.prevValue=t;let w=g.length;for(let e=0;e<w;++e){let t=g[e];if(!r(t))continue;if(void 0!==n){let i=v[e],r=n.ids.indexOf(i);if(-1!==r){let i=p[r];if(void 0!==i){let r=l.indexOf(i);if(-1!==r){b[e]=i,++u[r],S[e]=r;let n=y[e];void 0===n||n<=d[r]||(s[r]=t,o[r]=m[e],a[r]=f[e],d[r]=n);continue}}}}let c=s.indexOf(t);if(-1!==c){b[e]=l[c],++u[c],S[e]=c;continue}c=s.length,S[e]=c,u[c]=1+i,s[c]=t,a[c]=f[e],o[c]=m[e],d[c]=y[e];let h=++tf;l[c]=h,b[e]=h}}let{dimensionRefCounts:p}=this;p.clear();let g=0,f=s.length;for(let e of t){let{space:{value:t}}=e,i=c[g++],{rank:r}=t,n=Array.from(t.names),l=Array.from(t.timestamps),u=Float64Array.from(t.scales),h=Array.from(t.units);for(let e=0;e<r;++e){let t=i[e];void 0!==t&&(h[e]=a[t],u[e]=o[t],l[e]=d[t],n[e]=s[t])}for(let e of n){let t=p.get(e);void 0===t?t=1:++t,p.set(e,t)}if(!(0,H.cO)(h,t.units)||!(0,H.cO)(u,t.scales)||!(0,H.cO)(n,t.names)||!(0,H.cO)(l,t.timestamps)){let i=tw({valid:t.valid,ids:t.ids,scales:u,units:h,names:n,timestamps:l,boundingBoxes:t.boundingBoxes,coordinateArrays:t.coordinateArrays});e.prevValue=i,e.space.value=i}}{for(let e=0;e<f;++e)r(s[e])||(u[e]=0);let e=(e,t)=>0!==u[t];s=s.filter(e),a=a.filter(e),o=o.filter(e),l=l.filter(e),d=d.filter(e),u=u.filter(e),f=s.length}let m=[],v=Array(f);for(let e=0,t=n.rank;e<t;++e){let t=n.coordinateArrays[e];if(!t?.explicit)continue;let i=l.indexOf(n.ids[e]);-1!==i&&(v[i]=[t])}for(let e of t){let{space:{value:t}}=e,{rank:i,boundingBoxes:r,coordinateArrays:n}=t,a=t.names.map(e=>s.indexOf(e));for(let e of r)m.push(function(e,t,i){let{transform:r,box:n}=e,s=i.length,a=n.lowerBounds.length,o=new Float64Array((a+1)*t);for(let e=0;e<s;++e){let n=i[e];if(-1!==n)for(let i=0;i<=a;++i)o[i*t+n]=r[i*s+e]}return{transform:o,box:n}}(e,f,a));for(let e=0;e<i;++e){let t=n[e];if(void 0===t)continue;let i=a[e],r=v[i];void 0===r?v[i]=[t]:r.push(t)}}let y=Array(f);for(let e=0;e<f;++e){let t=v[e];void 0!==t&&(y[e]=tv(t))}let b=tw({valid:h,ids:l,names:s,units:a,scales:new Float64Array(o),boundingBoxes:m,coordinateArrays:y});if(i)for(let e=0;e<f;++e)--u[e];tS(n,b)||(this.prevCombined=b,e.value=b)}handleCombinedChanged;retain(){return++this.retainCount,()=>{0==--this.retainCount&&this.update()}}bind(e){let t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:i}=this;0===i.size&&this.combined.changed.add(this.handleCombinedChanged),i.add(t);let r=e.changed.add(()=>{e.value!==t.prevValue&&this.update()});return this.update(),()=>{r();let{bindings:e}=this;e.delete(t),0===e.size&&this.combined.changed.remove(this.handleCombinedChanged),this.update()}}}function tK(e,t,i,r,n){let s=n.length,a=new e((s+1)**2);a[a.length-1]=1;for(let e=0;e<s;++e){let o=r[e];a[(s+1)*s+e]=t[(i+1)*i+o];for(let r=0;r<s;++r){let l=n[r];a[(s+1)*r+e]=t[(i+1)*l+o]}}return a}function tZ(e){if(void 0===e)return;let t=new Float64Array(16);if(Array.isArray(e)){if(16===e.length)for(let i=0;i<4;++i)for(let r=0;r<4;++r)t[4*i+r]=(0,ef.jz)(e[4*r+i]);else{(0,ef.f6)(e,4);for(let i=0;i<4;++i){let r=(0,ef.f6)(e[i],4);for(let e=0;e<4;++e)t[4*e+i]=(0,ef.jz)(r[e])}}}else{(0,ef.PT)(e);let i=Z.gf.create(),r=Z.R3.create(),n=Z.R3.fromValues(1,1,1);(0,ef.Kh)(e,"rotation",e=>{(0,ef._b)(i,e),Z.gf.normalize(i,i)}),(0,ef.Kh)(e,"translation",e=>{(0,ef._b)(r,e)}),(0,ef.Kh)(e,"scale",e=>{(0,ef._b)(n,e)});let s=Z._E.create();Z._E.fromRotationTranslationScale(s,i,r,n),t.set(s)}return{sourceRank:3,transform:t,outputSpace:tw({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function tY(e){if(void 0===e)return;let t=(0,ef.PT)(e),i=(0,ef.uq)(t,"outputDimensions",tE),r=i.rank,n=(0,ef.uq)(t,"sourceRank",e=>{if(void 0===e)return r;if(!Number.isInteger(e)||e<0||e>r)throw Error(`Expected integer in range [0, ${r}] but received: ${JSON.stringify(e)}`);return e}),s=(0,ef.Kh)(t,"inputDimensions",e=>{let t=tE(e,!0);if(t.rank!==r)throw Error(`Expected rank of ${r}, but received rank of: ${t.rank}`);return t});return{transform:(0,ef.Kh)(t,"matrix",e=>{let t=new Float64Array((r+1)**2),i=(0,ef.f6)(e,r);t[t.length-1]=1;for(let e=0;e<r;++e)try{let n=(0,ef.f6)(i[e],r+1);for(let i=0;i<=r;++i)t[(r+1)*i+e]=(0,ef.jz)(n[i])}catch(t){throw Error(`Error in row ${e}: ${t.message}`)}return t}),outputSpace:i,inputSpace:s,sourceRank:n}}function tX(e){let t;if(void 0===e)return;let{transform:i,outputSpace:r,inputSpace:n,sourceRank:s}=e,a=r.rank;if(void 0!==i){t=[];for(let e=0;e<a;++e){let r=[];t[e]=r;for(let t=0;t<=a;++t)r[t]=i[(a+1)*t+e]}}return{sourceRank:s===a?void 0:s,matrix:t,outputDimensions:tT(r),inputDimensions:void 0===n?void 0:tT(n)}}function tQ(e,t){let{ids:i,names:r,scales:n,units:s,timestamps:a,coordinateArrays:o}=e;return tw({rank:t.length,valid:e.valid,ids:t.map(e=>i[e]),names:t.map(e=>r[e]),timestamps:t.map(e=>a[e]),scales:Float64Array.from(t,e=>n[e]),units:t.map(e=>s[e]),coordinateArrays:t.map(e=>o[e]),boundingBoxes:e.boundingBoxes.map(i=>(function(e,t,i){let{box:r,transform:n}=e,s=e.box.lowerBounds.length,a=t.length,o=new Float64Array((s+1)*a);if(e9.pb(o,a,n,i,t,s+1),!o.every(e=>0===e))return{transform:o,box:r}})(i,t,e.rank)).filter(e=>void 0!==e)})}function t0(e,t,i){return t===i?e:tQ(e,(0,H.BP)(e.rank,i,t))}function t1(e,t){let{transform:i,rank:r}=e,n=(0,Z.Mz)(i,r,[t]);if(1!==n.length)return;let[s]=n,a=Math.abs(i[(r+1)*s+t]),{inputSpace:o}=e;return{scale:o.scales[s]*a,unit:o.units[s]}}function t2(e,t){let{scales:i,units:r}=e.defaultInputSpace;return t<i.length?{scale:i[t],unit:r[t]}:void 0}function t3(e,t,i,r,n,s){let{scales:a}=i,{scales:o,rank:l}=n,d=t+1;for(let i=0;i<l;++i){let n=s[i];if(-1===n)continue;let l=o[i];for(let i=0;i<t;++i){let t=a[r[i]];e[d*i+n]*=t/l}}}function t4(e,t){return e===t||void 0===e.error&&void 0===t.error&&(0,H.cO)(e.modelDimensionNames,t.modelDimensionNames)&&(0,H.cO)(e.layerDimensionNames,t.layerDimensionNames)&&(0,H.cO)(e.globalToRenderLayerDimensions,t.globalToRenderLayerDimensions)&&(0,H.cO)(e.localToRenderLayerDimensions,t.localToRenderLayerDimensions)&&(0,H.cO)(e.channelToRenderLayerDimensions,t.channelToRenderLayerDimensions)&&(0,H.cO)(e.modelToRenderLayerTransform,t.modelToRenderLayerTransform)&&(0,H.cO)(e.channelSpaceShape,t.channelSpaceShape)}function t6(e,t,i,r,n){return(0,J.mo)((e,t,i,n)=>(function(e,t,i,r,n=tx){let s;let{inputSpace:a,rank:o,sourceRank:l,outputSpace:d,transform:u}=i,{names:c}=a,{names:h}=d;if(void 0!==r)s=Array.from(r.modelSubspaceDimensionIndices);else{s=[];for(let e=0;e<l;++e)s[e]=e}let p=s.length;for(let e=l;e<o;++e)s.push(e);let g=(0,Z.Mz)(i.transform,o,s,!0),f=s.length,m=s.map(e=>c[e]||`${e}`),v=g.map(e=>h[e]);if(f!==g.length)return{error:"Rank mismatch between model subspace dimensions ("+m.join(", ")+") and corresponding layer/global dimensions ("+v.join(", ")+")"};let y=tK(Float32Array,u,o,g,s),b=g.map(e=>h[e]),S=t.names.map(e=>b.indexOf(e)),w=e.names.map(e=>b.indexOf(e));t3(y,f,a,s,e,w),t3(y,f,a,s,t,S);let C=n.names.map(e=>b.indexOf(e));t3(y,f,a,s,n,C);let x=[],E=n.rank;if(void 0!==r){let{subsourceToModelSubspaceTransform:e}=r;p!==f&&(e=e9.w9(new Float32Array((f+1)**2),f,e,p)),y=e9.Jp(new Float32Array((f+1)**2),f+1,y,f+1,e,f+1,f+1,f+1,f+1)}let T=new Uint32Array(E),{lowerBounds:k,upperBounds:D,voxelCenterAtIntegerCoordinates:L}=n.bounds;for(let e=0;e<E;++e){let t=k[e],i=D[e];if(L[e]&&(t+=.5,i+=.5),0!==t||!Number.isInteger(i)||i<=0||i>=0x100000000)return{error:`Channel dimension ${n.names[e]} must have lower bound of 0 and positive integer upper bound; current bounds are [${t}, ${i}]`};T[e]=i;let r=C[e],s=-1;if(-1!==r)for(let e=0;e<f;++e){let t=y[r+e*(f+1)];if(0!==t){if(1!==t||-1!==s)return{error:`Channel dimension ${v[r]} must map to a single source dimension`};s=e}}x[e]=s}return{rank:f,unpaddedRank:p,modelDimensionNames:m,layerDimensionNames:v,localToRenderLayerDimensions:S,globalToRenderLayerDimensions:w,channelToRenderLayerDimensions:C,modelToRenderLayerTransform:y,channelToModelDimensions:x,channelSpaceShape:T}})(e,t,i,r,n),[e,t,i,void 0===n?(0,J.ne)(void 0):n],t4)}function t5(e,t){let i;let r=e.rank,n=e.unpaddedRank;n!==r&&void 0!==t&&(t=e9.w9(new Float32Array((r+1)**2),r,t,n)),void 0!==t?(i=new Float32Array((r+1)*(r+1)),e9.Jp(i,r+1,e.modelToRenderLayerTransform,r+1,t,r+1,r+1,r+1,r+1)):i=e.modelToRenderLayerTransform;let s=new Float32Array((r+1)*(r+1)),a=e9.SO(s,r+1,i,r+1,r+1);if(0===a)throw Error("Transform is singular");let{globalToRenderLayerDimensions:o,localToRenderLayerDimensions:l,channelToRenderLayerDimensions:d}=e,u=o.length,c=l.length,h=u+c,p=new Float32Array((h+1)*r);for(let e=0;e<r;++e){for(let t=0;t<u;++t){let i=o[t];-1!==i&&(p[e+t*r]=s[e+i*(r+1)])}for(let t=0;t<c;++t){let i=l[t];-1!==i&&(p[e+(u+t)*r]=s[e+i*(r+1)])}p[e+h*r]=s[e+r*(r+1)]}let g=d.length,f=Array(g),m=[];for(let t=0;t<g;++t){let n=d[t],s=-1;if(-1!==n){for(let t=0;t<r;++t){let a=i[n+t*(r+1)];if(0!==a){if(1!==a||-1!==s)throw Error(`Channel dimension ${e.layerDimensionNames[n]} must map with stride 1 to a single data chunk dimensions`);s=t}}if(-1!==s){let t=i[n+r*(r+1)];if(0!==t&&-.5!==t)throw Error(`Channel dimension ${e.layerDimensionNames[n]} must have an offset of 0 in the chunk coordinate space; current offset is ${t}`);m.push(s)}}f[t]=s}let{channelSpaceShape:v}=e,y=th(v),b=m.length,S=new Uint32Array(y*b);for(let e=0;e<y;++e){let t=e,i=0;for(let r=0;r<g;++r){let n=t%v[r];t=(t-n)/v[r],-1!==f[r]&&(S[e*b+i]=n,++i)}}return{layerRank:r,modelTransform:e,chunkToLayerTransform:i,layerToChunkTransform:s,chunkToLayerTransformDet:a,combinedGlobalLocalRank:h,combinedGlobalLocalToChunkTransform:p,channelToChunkDimensionIndices:f,chunkChannelDimensionIndices:m,numChannels:y,chunkChannelCoordinates:S,channelSpaceShape:v}}function t8(e,t){let{globalToRenderLayerDimensions:i}=e,r=[],n=[];for(let e=0;e<3;++e){let s=t[e];if(-1===s)continue;let a=i[s];n.push(a),-1!==a&&r.push(a)}for(let e=n.length;e<3;++e)n[e]=-1;return{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:n}}function t9(e,t){let{chunkToLayerTransform:i,modelTransform:r}=e,n=r.rank,{layerDisplayDimensionIndices:s,displayToLayerDimensionIndices:a}=t,o=s.length,l=(0,Z.Mz)(i,n,s);if(l.length!==o){let{modelDimensionNames:e,layerDimensionNames:t}=r;throw Error(`Rank mismatch between displayed layer dimensions (${Array.from(s,e=>t[e]).join(",\xa0")}) and corresponding chunk dimensions (${Array.from(l,t=>e[t]).join(",\xa0")})`)}let d=Z._E.create();for(let e=0;e<3;++e){let t=a[e];if(-1!==t){for(let r=0;r<o;++r){let s=l[r];d[4*r+e]=i[s*(n+1)+t]}d[12+e]=i[n*(n+1)+t]}}let u=Z._E.create();Z._E.invert(u,d);for(let e=l.length;e<3;++e)l[e]=-1;return{modelTransform:e.modelTransform,chunkTransform:e,displaySubspaceModelMatrix:d,displaySubspaceInvModelMatrix:u,chunkDisplayDimensionIndices:l,numChunkDisplayDims:o}}function t7(e,t,i,r,n){let s=t.length,a=i.length,o=e.length,l=!0;for(let d=0;d<r;++d){let u=d,c=0;for(let e=0;e<s;++e)c+=n[u+e*r]*t[e];u+=s*r;for(let e=0;e<a;++e)c+=n[u+e*r]*i[e];c+=n[u+a*r],d<o?e[d]=c:(c<0||c>=1)&&(l=!1)}return l}new Uint32Array(0),new Uint32Array(0);var ie=i(2902),it=((S={})[S.GPU_MEMORY=0]="GPU_MEMORY",S[S.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",S[S.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",S[S.DOWNLOADING=3]="DOWNLOADING",S[S.QUEUED=4]="QUEUED",S[S.NEW=5]="NEW",S[S.FAILED=6]="FAILED",S[S.EXPIRED=7]="EXPIRED",S),ii=((w={})[w.FIRST_TIER=0]="FIRST_TIER",w[w.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",w[w.VISIBLE=0]="VISIBLE",w[w.PREFETCH=1]="PREFETCH",w[w.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",w[w.RECENT=2]="RECENT",w[w.LAST_TIER=2]="LAST_TIER",w),ir=((C={})[C.totalTime=0]="totalTime",C[C.totalChunks=1]="totalChunks",C),is=((x={})[x.numChunks=0]="numChunks",x[x.systemMemoryBytes=1]="systemMemoryBytes",x[x.gpuMemoryBytes=2]="gpuMemoryBytes",x);class ia{numVisibleChunksNeeded=0;numVisibleChunksAvailable=0;numPrefetchChunksNeeded=0;numPrefetchChunksAvailable=0}var io=i(5901),il=((E={})[E.MEDIAN=0]="MEDIAN",E[E.MEAN=1]="MEAN",E[E.MAX=2]="MAX",E);class id{numStoredTimes;queryPoolSize;timeElapsedQueries;warnedAboutMissingExtension;storedTimeDeltas;constructor(e=10,t=10){if(this.numStoredTimes=e,this.queryPoolSize=t,this.timeElapsedQueries=[],this.warnedAboutMissingExtension=!1,this.storedTimeDeltas=[],this.queryPoolSize<1)throw Error(`Query pool size must be at least 1, but got ${t}.`)}getTimingExtension(e){let t=e.getExtension("EXT_disjoint_timer_query_webgl2");return null!==t||this.warnedAboutMissingExtension||(console.log("EXT_disjoint_timer_query_webgl2 extension not available. Cannot measure frame time."),this.warnedAboutMissingExtension=!0),t}getOldestQueryIndexByFrameNumber(){if(0===this.timeElapsedQueries.length)return;let e=0;for(let t=1;t<this.timeElapsedQueries.length;t++){let i=this.timeElapsedQueries[e];this.timeElapsedQueries[t].frameNumber<i.frameNumber&&(e=t)}return e}startFrameTimeQuery(e,t,i){if(null===t)return null;let r=e.createQuery(),n=this.timeElapsedQueries[this.timeElapsedQueries.length-1];if(null!==r&&n!==r){if(e.beginQuery(t.TIME_ELAPSED_EXT,r),this.timeElapsedQueries.length>=this.queryPoolSize){let t=this.getOldestQueryIndexByFrameNumber();if(void 0!==t){let i=this.timeElapsedQueries.splice(t,1)[0];e.deleteQuery(i.glQuery)}}this.timeElapsedQueries.push({glQuery:r,frameNumber:i,wasStarted:!0,wasEnded:!1})}return r}endLastTimeQuery(e,t){if(null!==t){let i=this.timeElapsedQueries[this.timeElapsedQueries.length-1];!i.wasEnded&&i.wasStarted&&(e.endQuery(t.TIME_ELAPSED_EXT),i.wasEnded=!0)}}grabAnyFinishedQueryResults(e){let t=[];for(let i=0;i<this.timeElapsedQueries.length;i++){let r=this.timeElapsedQueries[i];if(r.wasEnded&&r.wasStarted){let n=e.getQueryParameter(r.glQuery,e.QUERY_RESULT_AVAILABLE);if(null===n)e.deleteQuery(r.glQuery),t.push(i);else if(n){let n=e.getQueryParameter(r.glQuery,e.QUERY_RESULT)/1e6;this.storedTimeDeltas.push({frameDelta:n,frameNumber:r.frameNumber}),e.deleteQuery(r.glQuery),t.push(i)}}else e.deleteQuery(r.glQuery),t.push(i)}this.timeElapsedQueries=this.timeElapsedQueries.filter((e,i)=>!t.includes(i)),this.storedTimeDeltas.length>this.numStoredTimes&&(this.storedTimeDeltas=this.storedTimeDeltas.slice(-this.numStoredTimes))}getLastFrameTimesInMs(e=10){return this.storedTimeDeltas.slice(-e).map(e=>e.frameDelta)}getQueries(){return this.timeElapsedQueries}}class iu{numberOfStoredFrameDeltas;maxDownsamplingFactor;desiredFrameTimingMs;downsamplingPersistenceDurationInFrames;lastFrameTime;frameDeltas;downsamplingRates;frameCount;constructor(e=10,t=8,i=1e3/60,r=15){this.numberOfStoredFrameDeltas=e,this.maxDownsamplingFactor=t,this.desiredFrameTimingMs=i,this.downsamplingPersistenceDurationInFrames=r,this.lastFrameTime=null,this.frameDeltas=[],this.downsamplingRates=new Map,this.frameCount=0,this.validateConstructorArguments();for(let e=1;e<=this.maxDownsamplingFactor;e*=2)this.downsamplingRates.set(e,-1/0)}validateConstructorArguments(){this.numberOfStoredFrameDeltas=Math.max(1,Math.round(this.numberOfStoredFrameDeltas)),this.maxDownsamplingFactor=Math.max(2,Math.round(this.maxDownsamplingFactor))}storeFrameDelta(e){this.frameDeltas.push(e),this.frameDeltas.length>this.numberOfStoredFrameDeltas&&this.frameDeltas.shift()}calculateMeanFrameTime(){return this.frameDeltas.reduce((e,t)=>e+t,0)/this.frameDeltas.length}calculateMedianFrameTime(){let e=this.frameDeltas.slice().sort((e,t)=>e-t),t=Math.floor(e.length/2);return e.length%2==1?e[t]:(e[t-1]+e[t])/2}calculateMaxFrameTime(){return Math.max(...this.frameDeltas)}updateMaxTrackedDownsamplingRate(e){this.downsamplingRates.set(e,this.frameCount);let t=1;for(let[e,i]of this.downsamplingRates)this.frameCount-i<=this.downsamplingPersistenceDurationInFrames&&(t=e);return t}resetForNewFrameSet(){this.lastFrameTime=null,this.frameCount=0,this.downsamplingRates.forEach((e,t)=>{this.downsamplingRates.set(t,-1/0)})}addFrame(e=Date.now()){if(null!==this.lastFrameTime){let t=e-this.lastFrameTime;t>0&&this.storeFrameDelta(t)}this.lastFrameTime=e,this.frameCount++}calculateFrameTimeInMs(e=2){if(0===this.frameDeltas.length)return 0;switch(e){case 0:return this.calculateMedianFrameTime();case 1:return this.calculateMeanFrameTime();case 2:return this.calculateMaxFrameTime()}}calculateDownsamplingRate(e=1){let t=this.calculateFrameTimeInMs(e);if(0===t)return Math.min(4,this.maxDownsamplingFactor);let i=Math.max(t/this.desiredFrameTimingMs,1);return i=Math.min(Math.pow(2,Math.round(Math.log2(i))),this.maxDownsamplingFactor),this.updateMaxTrackedDownsamplingRate(i)}getFrameDeltas(){return this.frameDeltas}getFrameCount(){return this.frameCount}getDownsamplingRates(){return this.downsamplingRates}setFrameDeltas(e,t=!0){this.frameDeltas=e.slice(-this.numberOfStoredFrameDeltas),t&&this.frameCount++}}var ic=i(4186),ih=i(9652);class ip{width=0;height=0;logicalWidth=0;logicalHeight=0;visibleLeftFraction=0;visibleTopFraction=0;visibleWidthFraction=0;visibleHeightFraction=0}function ig(e,t){let i=1/e.visibleWidthFraction,r=1/e.visibleHeightFraction,n=-1-(-1+2*e.visibleLeftFraction)*i,s=-1-(-1+2*e.visibleTopFraction)*r;s=-s,t[0]=t[0]*i+t[3]*n,t[4]=t[4]*i+t[7]*n,t[8]=t[8]*i+t[11]*n,t[12]=t[12]*i+t[15]*n,t[1]=t[1]*r+t[3]*s,t[5]=t[5]*r+t[7]*s,t[9]=t[9]*r+t[11]*s,t[13]=t[13]*r+t[15]*s}function im(e,t){return e.width===t.width&&e.height===t.height&&e.logicalWidth===t.logicalWidth&&e.logicalHeight===t.logicalHeight&&e.visibleLeftFraction===t.visibleLeftFraction&&e.visibleTopFraction===t.visibleTopFraction}class iv extends eh.gj{context;element;visibility;gl;boundsGeneration;canvasRelativeClippedLeft;canvasRelativeClippedTop;canvasRelativeLogicalLeft;canvasRelativeLogicalTop;renderViewport;boundsUpdated;monitorState;constructor(e,t,i){super(),this.context=e,this.element=t,this.visibility=i,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new ip,this.boundsUpdated=new eO.K_,this.monitorState={isIntersecting:!0},this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(e=!1){let{context:t}=this;t.ensureBoundsUpdated();let{boundsGeneration:i}=t;if(i===this.boundsGeneration)return;this.boundsGeneration=i;let{element:r}=this,n=r.getBoundingClientRect();t.ensureMonitorPanel(r,this.monitorState,n);let s=t.container,a=t.canvasRect,{canvas:o}=t,{width:l,height:d}=o,u=l/a.width,c=d/a.height,h=a.left,p=a.top,g=this.canvasRelativeLogicalLeft=Math.round((n.left-h)*u+r.clientLeft),f=this.canvasRelativeLogicalTop=Math.round((n.top-p)*c+r.clientTop),m=r.clientWidth,v=r.clientHeight,y=g+m,b=f+v,S=f,w=g,C=y,x=b;for(let e=r.parentElement;null!==e&&e!==s;e=e.parentElement){let t=e.getBoundingClientRect();if(0===t.x&&0===t.y&&0===t.width&&0===t.height)continue;let i=Math.max(w,(t.left-h)*u),r=Math.max(S,(t.top-p)*c),n=Math.min(C,(t.right-h)*u),s=Math.min(x,(t.bottom-p)*c);if(i!==w||n!==C){let t=getComputedStyle(e).overflowX;("hidden"===t||"clip"===t)&&(w=i,C=n)}if(r!==S||s!==x){let t=getComputedStyle(e).overflowY;("hidden"===t||"clip"===t)&&(S=r,x=s)}}S=this.canvasRelativeClippedTop=Math.round(Math.max(S,0)),w=this.canvasRelativeClippedLeft=Math.round(Math.max(w,0)),C=Math.round(Math.min(C,l)),x=Math.round(Math.min(x,d));let E=this.renderViewport,T=E.width=Math.max(0,C-w),k=E.height=Math.max(0,x-S);this.context.screenshotMode.value!==ic.u.OFF&&e?(E.width=m*u,E.height=v*c,E.logicalWidth=m*u,E.logicalHeight=v*c):(E.logicalWidth=m,E.logicalHeight=v),E.visibleLeftFraction=(w-g)/m,E.visibleTopFraction=(S-f)/v,E.visibleWidthFraction=T/m,E.visibleHeightFraction=k/v,this.boundsUpdated.dispatch()}setGLClippedViewport(){let{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:i,renderViewport:{width:r,height:n}}=this,s=t+n;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let a=this.context.canvas.height-s;e.viewport(i,a,r,n),e.scissor(i,a,r,n)}setGLLogicalViewport(){let{gl:e,renderViewport:{width:t,height:i,logicalWidth:r,logicalHeight:n}}=this,s=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,s-(this.canvasRelativeLogicalTop+n),r,n),e.scissor(this.canvasRelativeClippedLeft,s-(this.canvasRelativeClippedTop+i),t,i)}disposed(){this.context.unmonitorPanel(this.element,this.monitorState),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;let{element:e}=this;return 0!==e.clientWidth&&0!==e.clientHeight&&0!==e.offsetWidth&&0!==e.offsetHeight}get drawOrder(){return 0}}class iy extends iv{canvas=document.createElement("canvas");canvasRenderingContext=this.canvas.getContext("2d");constructor(e,t,i){super(e,t,i);let{canvas:r}=this;t.appendChild(r),t.style.position="relative",r.style.position="absolute",r.style.left="0",r.style.right="0",r.style.top="0",r.style.bottom="0"}draw(){this.drawIndirect();let{renderViewport:e,canvas:t}=this,{logicalWidth:i,logicalHeight:r}=e;t.width=i,t.height=r;let{canvasRenderingContext:n}=this;n?.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,i,r,0,0,i,r)}}class ib extends J.TU{constructor(){super(Float64Array.of(0,0,1,1),e=>(0,ef.Iw)(new Float64Array(4),e,ef.j2))}toJSON(){let{value:e}=this,[t,i,r,n]=e;if(0!==t||0!==i||1!==r||1!==n)return Array.from(e)}}class iS extends eh.gj{container;canvas;gl;updateStarted;updateFinished;continuousCameraMotionStarted;continuousCameraMotionFinished;changed;panels;canvasRect;rootRect;resizeGeneration;boundsGeneration;screenshotMode;force3DHistogramForAutoRange;framerateMonitor;continuousCameraMotionInProgress;orderedPanels;frameNumber;resizeCallback;ensureMonitorPanel(e,t,i){let r;if(t.addedToResizeObserver||(this.resizeObserver.observe(e),t.addedToResizeObserver=!0),t.isIntersecting){let e=this.rootRect,t=e.top-i.top,n=e.left-i.left,s=i.right-e.right,a=i.bottom-e.bottom;r=`${t}px ${s}px ${a}px ${n}px`}else r="";if(t.intersectionObserverMargin!==r){t.intersectionObserverMargin=r,t.intersectionObserver?.disconnect();let i=Array(101);for(let e=0;e<=100;++e)i[e]=.01*e;(t.intersectionObserver=new IntersectionObserver(e=>{let i=e[e.length-1];t.isIntersecting=i.isIntersecting,this.resizeCallback()},{root:this.container,rootMargin:r,threshold:i})).observe(e)}}unmonitorPanel(e,t){t.addedToResizeObserver&&this.resizeObserver.unobserve(e),t.intersectionObserver?.disconnect()}resizeObserver;debouncedEndContinuousCameraMotion;flagContinuousCameraMotion(){this.continuousCameraMotionInProgress||this.continuousCameraMotionStarted.dispatch(),this.continuousCameraMotionInProgress=!0,this.debouncedEndContinuousCameraMotion()}get isContinuousCameraMotionInProgress(){return this.continuousCameraMotionInProgress}constructor(e){super(),this.container=e,this.canvas=document.createElement("canvas"),this.updateStarted=new eO.K_,this.updateFinished=new eO.K_,this.continuousCameraMotionStarted=new eO.K_,this.continuousCameraMotionFinished=new eO.K_,this.changed=this.updateFinished,this.panels=new Set,this.resizeGeneration=0,this.boundsGeneration=-1,this.screenshotMode=new ic.$(ic.u.OFF),this.force3DHistogramForAutoRange=!1,this.framerateMonitor=new id,this.continuousCameraMotionInProgress=!1,this.orderedPanels=[],this.frameNumber=0,this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()},this.resizeObserver=new ResizeObserver(this.resizeCallback),this.debouncedEndContinuousCameraMotion=this.registerCancellable((0,ie.Z)(()=>{this.continuousCameraMotionInProgress=!1,this.continuousCameraMotionFinished.dispatch()},300)),this.scheduleRedraw=this.registerCancellable((0,io.H)(()=>this.draw()));let{canvas:t,resizeObserver:i}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",i.observe(t),e.appendChild(t),this.registerEventListener(e,"scroll",()=>{this.resizeCallback()},{capture:!0,passive:!0}),this.registerEventListener(t,"webglcontextlost",e=>{console.log(`Lost WebGL context: ${e.statusMessage}`),e.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=(0,ih.B)(t)}applyWindowedViewportToElement(e,t){let[i,r,n,s]=t,a=1/n,o=1/s;e.style.position="absolute",e.style.top=`${-o*r*100}%`,e.style.left=`${-a*i*100}%`,e.style.width=`${100*a}%`,e.style.height=`${100*o}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(let e of this.panels)if(e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){let e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}scheduleRedraw;ensureBoundsUpdated(){let{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;let{canvas:t}=this;this.screenshotMode.value===ic.u.OFF&&(t.width=t.offsetWidth,t.height=t.offsetHeight),this.canvasRect=t.getBoundingClientRect(),this.rootRect=this.container.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl,t=this.framerateMonitor.getTimingExtension(e);this.framerateMonitor.startFrameTimeQuery(e,t,this.frameNumber),this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);let{orderedPanels:i,panels:r}=this;for(let e of(i.length!==r.size&&(i.push(...r),i.sort((e,t)=>e.drawOrder-t.drawOrder)),i)){if(e.ensureBoundsUpdated(),!e.shouldDraw)continue;let{renderViewport:t}=e;0!==t.width&&0!==t.height&&e.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch(),this.framerateMonitor.endLastTimeQuery(e,t),this.framerateMonitor.grabAnyFinishedQueryResults(e)}getDepthArray(){let{width:e,height:t}=this.canvas,i=new Float32Array(e*t);for(let e of this.panels){if(!e.shouldDraw)continue;let t=e.getDepthArray();if(void 0===t)continue;let{canvasRelativeClippedTop:r,canvasRelativeClippedLeft:n,renderViewport:{width:s,height:a}}=e;for(let e=0;e<a;++e){let o=(a-1-e)*s;i.set(t.subarray(o,o+s),(r+e)*s+n)}}return i}getLastFrameTimesInMs(e=10){return this.framerateMonitor.getLastFrameTimesInMs(e)}}class iw extends ip{displayDimensionRenderInfo;globalPosition=tp;projectionMat=Z._E.create();viewMatrix=Z._E.create();invViewMatrix=Z._E.create();viewProjectionMat=Z._E.create();invViewProjectionMat=Z._E.create()}function iC(e,t){return e.displayDimensionRenderInfo===t.displayDimensionRenderInfo&&im(e,t)&&(0,H.cO)(e.globalPosition,t.globalPosition)&&(0,H.cO)(e.projectionMat,t.projectionMat)&&(0,H.cO)(e.viewMatrix,t.viewMatrix)}function ix(e){let{viewMatrix:t,viewProjectionMat:i}=e;Z._E.invert(t,e.invViewMatrix),Z._E.multiply(i,e.projectionMat,t),Z._E.invert(e.invViewProjectionMat,i)}var iE=i(1395),iT=((T={})[T.info=0]="info",T[T.warning=1]="warning",T[T.error=2]="error",T);class ik{changed=new eO.K_;messages=[];children=[];addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){let{messages:e}=this;0!==e.length&&(e.length=0,this.changed.dispatch())}isEmpty(){return 0===this.messages.length&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{let{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Symbol.iterator](){for(let e of(yield*this.messages,this.children))yield*e}}var iD=i(2606),iL=i(7734);let iI=!("undefined"!=typeof Window&&self instanceof Window),iP="rpc.promise.response",iR="rpc.promise.cancel",iA="rpc.promise.addProgressSpan",iM="rpc.promise.removeProgressSpan",iN="rpc.ready",iV=new Map;function iO(e,t){iV.set(e,t)}class iF{rpc;id;constructor(e,t){this.rpc=e,this.id=t}addSpan(e){this.rpc.invoke(iA,{id:this.id,span:{id:e.id,message:e.message,startTime:e.startTime}})}removeSpan(e){this.rpc.invoke(iM,{id:this.id,spanId:e})}}function iB(e,t){iO(e,function(e){let i;let r=e.id,n=new AbortController;!0===e.progressListener&&(i=new iF(this,r));let s=t.call(this,e,{signal:n.signal,progressListener:i});this.set(r,{promise:s,abortController:n}),s.then(({value:e,transfers:t})=>{this.delete(r),this.invoke(iP,{id:r,value:e},t)},e=>{this.delete(r),this.invoke(iP,{id:r,error:e})})})}iO(iR,function(e){let t=e.id,i=this.get(t);if(void 0!==i){let{abortController:e}=i;e.abort()}}),iO(iP,function(e){let t=e.id,{resolve:i,reject:r}=this.get(t);this.delete(t),Object.prototype.hasOwnProperty.call(e,"value")?i(e.value):r(e.error)}),iO(iA,function(e){let t=e.id,{progressListener:i}=this.get(t);new iL.Vi(i,e.span)}),iO(iM,function(e){let t=e.id,{progressListener:i}=this.get(t);i.removeSpan(e.spanId)}),iO(iN,function(e){this.onPeerReady()});let i_=iI?-1:0;class iU{target;objects;nextId;queue;constructor(e,t){this.target=e,this.objects=new Map,this.nextId=i_,t&&(this.queue=[]),e.onmessage=e=>{let t=e.data;if(void 0===iV.get(t.functionName))throw Error(`Missing RPC function: ${t.functionName}`);iV.get(t.functionName).call(this,t)}}sendReady(){this.invoke(iN,{})}onPeerReady(){let{queue:e}=this;if(void 0!==e)for(let{data:t,transfers:i}of(this.queue=void 0,e))this.target.postMessage(t,i)}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,i=this.get(t);return i.referencedGeneration=e.gen,i.addRef(),i}getOptionalRef(e){if(void 0===e)return;let t=e.id,i=this.get(t);return i.referencedGeneration=e.gen,i.addRef(),i}invoke(e,t,i){t.functionName=e;let{queue:r}=this;if(void 0!==r){r.push({data:t,transfers:i});return}this.target.postMessage(t,i)}promiseInvoke(e,t,i){let r,n,s;if(void 0!==i&&({signal:r,progressListener:n,transfers:s}=i),r?.aborted)return Promise.reject(r.reason);void 0!==n&&(t.progressListener=!0);let a=t.id=this.newId();this.invoke(e,t,s);let{promise:o,resolve:l,reject:d}=void 0===r?Promise.withResolvers():(0,iD.L0)(r,()=>{this.invoke(iR,{id:a})});return this.set(a,{resolve:l,reject:d,progressListener:n}),o}newId(){return iI?this.nextId--:this.nextId++}}class i$ extends eh.gj{rpc=null;rpcId=null;isOwner;unreferencedGeneration;referencedGeneration;initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){!0===this.isOwner?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():!1===this.isOwner?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,0===this.refCount&&e===this.referencedGeneration&&this.ownerDispose()}}class iz extends i${constructor(e,t={}){super(),function(e,t,i={}){null!=t&&e.initializeSharedObject(t,i.id)}(this,e,t)}}iO("SharedObject.dispose",function(e){let t=this.get(e.id);if(0!==t.refCount)throw Error("Attempted to dispose object with non-zero reference count.");t.disposed(),this.delete(t.rpcId),t.rpcId=null,t.rpc=null}),iO("SharedObject.refCountReachedZero",function(e){let t=this.get(e.id),i=e.gen;t.counterpartRefCountReachedZero(i)});let iG=new Map;function ij(e){return t=>{t.prototype.RPC_TYPE_ID=e}}function iW(e){return t=>{if(void 0!==e)t.prototype.RPC_TYPE_ID=e;else if(void 0===(e=t.prototype.RPC_TYPE_ID))throw Error("RPC_TYPE_ID should have already been defined");iG.set(e,t)}}iO("SharedObject.new",function(e){let t=e.type,i=new(iG.get(t))(this,e);--i.refCount});let iq="SharedWatchableValue.changed";class iH extends iz{base;updatingValue_=!1;constructor(e,t={}){super(e,t),void 0!==e&&(this.base=new J.SN(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;null!==e&&e.invoke(iq,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let i=new iH;return i.base=t,i.setupChangedHandler(),i.initializeCounterpart(e),i}static make(e,t){return iH.makeFromExisting(e,new J.SN(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}}iH=function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([iW("SharedWatchableValue")],iH),iO(iq,function(e){let t=this.get(e.id);t.updatingValue_=!0,t.base.value=e.value,t.updatingValue_=!1});class iJ extends J.SN{constructor(e=Number.NEGATIVE_INFINITY){super(e)}static VISIBLE=Number.POSITIVE_INFINITY;static IGNORED=Number.NEGATIVE_INFINITY;get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}}class iK extends iJ{contributors=new Map;add(e){let{contributors:t}=this,i=e.changed.add(()=>{this.update()}),r=()=>{t.delete(r),i(),this.update()};return t.set(r,e),this.update(),r}update(){let e=Number.NEGATIVE_INFINITY;for(let t of this.contributors.values())e=Math.max(e,t.value);this.value=e}}function iZ(e){return class extends e{visibility=new iK;initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(iH.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var iY=((k={})[k.DATA=0]="DATA",k[k.ANNOTATION=1]="ANNOTATION",k[k.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION",k);class iX extends eh.gj{userLayer;role=0;messages=new ik;layerChanged=new eO.K_;redrawNeeded=new eO.K_;layerChunkProgressInfo=new ia;handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,i,r){}}class iQ extends iX{backend;visibility=new iK;attach(e){}}function i0(e,t,i){let{state:r}=i;if(void 0===r||r.transform!==e||r.displayDimensionRenderInfo!==t){if(i.messages.clearMessages(),r=i.state={transform:e,displayDimensionRenderInfo:t,modelTransform:void 0},void 0!==e.error){i.messages.addMessage({severity:iT.error,message:e.error});return}try{let i=Z._E.create();!function(e,t,i){e.fill(0),e[15]=1;let r=!0,{displayDimensionIndices:n}=t,{globalToRenderLayerDimensions:s,modelToRenderLayerTransform:a}=i,o=i.rank;for(let t=0;t<3;++t){let i=n[t];if(-1===i){r=!1;continue}let l=s[i];if(-1===l){r=!1;continue}e[t+12]=a[l+o*(o+1)];for(let i=0;i<3;++i)e[t+4*i]=a[l+(o+1)*i]}if(!r){let{globalDimensionNames:e}=t,r=Array.from(n.filter(e=>-1!==e),t=>e[t]).join(",\xa0");throw Error(`Transform from model dimensions (${i.modelDimensionNames.join(",\xa0")}) to display dimensions (${r}) does not have full rank`)}}(i,t,e),r.modelTransform=i}catch(e){i.messages.addMessage({severity:iT.error,message:e.message})}}return r.modelTransform}class i1 extends eh.gj{oldValue_;value_;renderViewport=new ip;changed=new eO.MZ;constructor(e){super();let{parametersConstructor:t=iw,navigationState:i,update:r,isEqual:n=iC}=e;this.oldValue_=new t,this.value_=new t;let s=()=>{let{oldValue_:e,value_:t}=this;e.displayDimensionRenderInfo=i.displayDimensionRenderInfo.value,Object.assign(e,this.renderViewport);let{globalPosition:s}=e,a=i.position.value,o=a.length;s.length!==o&&(e.globalPosition=s=new Float32Array(o)),s.set(a),r(e,i),n(e,t)||(this.value_=e,this.oldValue_=t,this.changed.dispatch(t,e))},a=this.update=this.registerCancellable((0,ie.Z)(s,0));this.registerDisposer(i.changed.add(a)),s()}setViewport(e){im(e,this.renderViewport)||(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}update}class i2 extends i${base;updateInterval;prevDisplayDimensionRenderInfo;constructor(e,t,i=10){super(),this.base=t,this.updateInterval=i,this.prevDisplayDimensionRenderInfo=void 0,this.update=this.registerCancellable((0,ie.Z)((e,t)=>{let i;if(t.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo)i=t,this.prevDisplayDimensionRenderInfo=t.displayDimensionRenderInfo;else{let{displayDimensionRenderInfo:e,...r}=t;i=r}this.rpc.invoke(iE.uH,{id:this.rpcId,value:i})},this.updateInterval)),this.initializeCounterpart(e,{value:t.value}),this.registerDisposer(t.changed.add(this.update))}flush(){this.update.flush()}update}i2=function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([ij(iE.rC)],i2);class i3{value_;defaultValue;get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}changed;constructor(e,t=e){this.value_=e,this.defaultValue=t,this.changed=new eO.K_}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(!0===e||!1===e){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}}class i4 extends eh.gj{model;element;constructor(e,t={}){super(),this.model=e,this.element=document.createElement("input");let{element:i}=this;i.type="checkbox";let r=()=>{let e=this.model.value;this.element.checked=e,(void 0!==t.enableTitle||void 0!==t.disableTitle)&&(this.element.title=(e?t.enableTitle:t.disableTitle)??"")};this.registerDisposer(e.changed.add(r)),r(),this.registerEventListener(i,"change",function(t){e.value=this.checked}),i.addEventListener("mousedown",e=>{e.preventDefault()})}disposed(){let{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}}class i6 extends eh.gj{model;element;initialDisplay;constructor(e,t){super(),this.model=e,this.element=t,this.initialDisplay=this.element.style.display,this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable((0,ie.Z)(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}}function i5(e){try{return e()}catch(e){return{error:e.message}}}function i8(e){if(void 0!==e.error)throw Error(e.error);return e}function i9(e){if("string"==typeof e)return e;if(e instanceof Error){let{message:t,cause:i}=e;return void 0!==i?`${t}: ${i9(i)}`:t}try{return""+e}catch{return"Unknown error"}}class i7 extends eh.gj{register;changed;map;disposerMap;constructor(e,t){if(super(),this.register=e,this.changed=new eO.K_,this.disposerMap=new Map,void 0===t)this.map=new Map;else{let i=this.map=new Map(t),{disposerMap:r}=this;for(let[t,n]of i){let i=new eh.gj;r.set(t,i),e(i,n,t)}}}get value(){return this.map}set(e,t){let{map:i,disposerMap:r}=this,n=r.get(e);return void 0!==n&&n.dispose(),n=new eh.gj,r.set(e,n),i.set(e,t),this.register(n,t,e),this.changed.dispatch(),this}delete(e){let{map:t,disposerMap:i}=this,r=i.get(e);return void 0!==r&&(r.dispose(),i.delete(e),t.delete(e),this.changed.dispatch(),!0)}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){let{map:e,disposerMap:t}=this;if(e.size>0){for(let e of t.values())e.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){let{map:e,disposerMap:t}=this;for(let e of t.values())e.dispose();e.clear(),t.clear(),super.disposed()}}let re=Symbol("objectId"),rt=0;function ri(e){if(e instanceof Object){let t=e[re];return void 0===t&&(t=e[re]=rt++),`o${t}`}return""+JSON.stringify(e)}var rr=((D={})[D.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",D[D.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT",D);class rn extends Error{shaderType;source;log;errorMessages;constructor(e,t,i,r){let n=`Error compiling ${rr[e].toLowerCase()} shader: ${i}`;super(n),this.name="ShaderCompilationError",this.log=i,this.message=n,this.shaderType=e,this.source=t,this.errorMessages=r}}class rs extends Error{vertexSource;fragmentSource;log;constructor(e,t,i){let r=`Error linking shader: ${i}`;super(r),this.name="ShaderLinkError",this.log=i,this.message=r,this.vertexSource=e,this.fragmentSource=t}}function ra(e,t,i){let r=e.createShader(i);if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){let n=e.getShaderInfoLog(r)||"";throw new rn(i,t,n,function(e){e=e.replace("\0","");let t=[];for(let i of e.split("\n")){let e=i.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);null!==e?t.push({message:e[3].trim(),file:parseInt(e[1],10),line:parseInt(e[2],10)}):null!==(e=i.match(/^ERROR:\s*(.+)$/))?t.push({message:e[1]}):(i=i.trim())&&t.push({message:i})}return t}(n))}return r}class ro extends eh.gj{gl;vertexSource;fragmentSource;program;vertexShader;fragmentShader;attributes;uniforms;textureUnits;vertexShaderInputBinders;vertexDebugOutputs;transferFunctionTextures;constructor(e,t,i,r,n,s){super(),this.gl=e,this.vertexSource=t,this.fragmentSource=i,this.attributes=new Map,this.uniforms=new Map,this.vertexShaderInputBinders={},this.transferFunctionTextures=new Map;let a=this.vertexShader=ra(e,t,WebGL2RenderingContext.VERTEX_SHADER),o=this.fragmentShader=ra(e,i,WebGL2RenderingContext.FRAGMENT_SHADER),l=e.createProgram();if(e.attachShader(l,a),e.attachShader(l,o),e.linkProgram(l),!e.getProgramParameter(l,e.LINK_STATUS))throw new rs(t,i,e.getProgramInfoLog(l)||"");this.program=l;let{uniforms:d,attributes:u}=this;if(r)for(let t of r)d.set(t,e.getUniformLocation(l,t));if(n)for(let t of n)u.set(t,e.getAttribLocation(l,t))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){this.gl.useProgram(this.program)}bindAndUpdateTransferFunctionTexture(e,t,i,r){let n=this.textureUnits.get(e);if(void 0===n)throw Error(`Invalid texture unit symbol: ${e.toString()}`);let s=this.transferFunctionTextures.get(e);if(void 0===s)throw Error(`Invalid transfer function texture symbol: ${e.toString()}`);return s.updateAndActivate({textureUnit:n,sortedControlPoints:t,dataType:i,lookupTableSize:r})}unbindTransferFunctionTextures(){let e=this.gl;for(let t of this.transferFunctionTextures.keys()){let i=this.textureUnits.get(t);void 0!==i&&(this.gl.activeTexture(e.TEXTURE0+i),this.gl.bindTexture(e.TEXTURE_2D,null))}}disposed(){let{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0,this.transferFunctionTextures=void 0}}class rl{code="";parts=new Set;add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(let t of e)this.add(t);else throw console.log("Invalid code type",e),Error("Invalid code type")}}toString(){return this.code}}let rd={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D};class ru{gl;nextSymbolID;nextTextureUnit;uniformsCode;attributesCode;varyingsCodeVS;varyingsCodeFS;fragmentExtensionsSet;fragmentExtensions;vertexCode;vertexMain;fragmentCode;outputBufferCode;fragmentMain;required;uniforms;attributes;initializers;textureUnits;vertexDebugOutputs;constructor(e){this.gl=e,this.nextSymbolID=0,this.nextTextureUnit=0,this.uniformsCode="",this.attributesCode="",this.varyingsCodeVS="",this.varyingsCodeFS="",this.fragmentExtensionsSet=new Set,this.fragmentExtensions="",this.vertexCode=new rl,this.vertexMain="",this.fragmentCode=new rl,this.outputBufferCode="",this.fragmentMain="",this.required=new Set,this.uniforms=[],this.attributes=[],this.initializers=[],this.textureUnits=new Map,this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw Error("Duplicate texture unit symbol: "+e.toString());let i=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,i),i}addTextureSampler(e,t,i,r){let n=this.allocateTextureUnit(i,r);return this.addUniform(`highp ${e}`,t,r),this.addInitializer(e=>{if(r){let i=new Int32Array(r);for(let e=0;e<r;++e)i[e]=e+n;e.gl.uniform1iv(e.uniform(t),i)}else e.gl.uniform1i(e.uniform(t),n)}),n}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,i){return this.attributes.push(t),void 0!==i&&(this.attributesCode+=`layout(location = ${i})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,i=""){this.varyingsCodeVS+=`${i} out ${e} ${t};
`,this.varyingsCodeFS+=`${i} in ${e} ${t};
`}addOutputBuffer(e,t,i){null!==i&&(this.outputBufferCode+=`layout(location = ${i}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,i){return this.uniforms.push(t),null!=i?this.uniformsCode+=`uniform ${e} ${t}[${i}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){!this.fragmentExtensionsSet.has(e)&&(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){!this.required.has(e)&&(this.required.add(e),e(this))}build(){let e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
float defaultMaxProjectionIntensity = 0.0;
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
float defaultMaxProjectionIntensity = 0.0;
${this.fragmentCode}
${this.fragmentMain}
`,i=new ro(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);i.textureUnits=this.textureUnits;let{initializers:r}=this;if(r.length>0)for(let e of(i.bind(),r))e(i);return i}}function rc(){return new J.SN(void 0)}function rh(e){return new J.TU(e,ef.ZE)}function rp(e,t,i){let r=new Map,{parameters:n,fallbackParameters:s,shaderError:a,encodeParameters:o=e=>e,extraParameters:l=(0,J.ne)(void 0),encodeExtraParameters:d=e=>e,getContextKey:u,defineShader:c}=i;void 0!==a&&(a.value=void 0);let{encodeContext:h=u}=i,p=(0,ef.hd)(i.memoizeKey);function g(e,i,r){let n=JSON.stringify({id:p,context:h(e),parameters:o(i),extraParameters:d(r)});return t.memoize.get(n,()=>{let n=new ru(t);return c(n,e,i,r),n.build()})}return e.registerDisposer(()=>{for(let e of r.values()){let{shader:t}=e;null!==t&&t.dispose()}}),function(e){let t=u(e),i=r.get(t);void 0===i&&(i={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:n.value,extraParameters:l.value},r.set(t,i));let o=n.changed.count,d=l.changed.count;if(o===i.parametersGeneration&&d===i.extraParametersGeneration)return i;let c=i.parameters=n.value,h=i.extraParameters=l.value,p=i.shader;i.parametersGeneration=o,i.extraParametersGeneration=d;let f=null;try{f=g(e,c,h),i.fallback=!1,void 0!==s&&(s.value=c),void 0!==a&&(a.value=null)}catch(t){if(void 0!==a&&(a.value=t),void 0!==s)try{let t=s.value;f=g(e,t,h),i.parameters=t,i.fallback=!0}catch{}}return null!==p&&p.dispose(),i.shader=f,i}}function rg(e,t,i){return rp(e,t,{...i,getContextKey:e=>e,encodeContext:e=>ri(e),defineShader:(e,t,r,n)=>(e.require(t),i.defineShader(e,r,n))})}function rf(e,t=1,i=0){return`
#line ${i} ${t}
`+e}class rm{gl;bufferType;buffer;constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e,this.bufferType=t,this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,i=WebGL2RenderingContext.FLOAT,r=!1,n=0,s=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,i,r,n,s)}bindToVertexAttribI(e,t,i=WebGL2RenderingContext.UNSIGNED_INT,r=0,n=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,i,r,n)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){let i=this.gl;this.bind(),i.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,i,r){let n=new rm(e,i);return n.setData(t,r),n}}function rv(e,t,i,...r){return e.memoize.get((0,ef.hd)({id:"getMemoizedBuffer",getter:ri(i),args:r}),()=>{let n=new eh.IF(rm.fromData(e,i(...r),t,WebGL2RenderingContext.STATIC_DRAW));return n.registerDisposer(n.value),n})}function ry(e=-1,t=-1,i=1,r=1,n=1,s=1){return(0,H.X9)(new Float32Array([e,t,e,r,i,r,i,t]),2,n,s)}function rb(e,t=-1,i=-1,r=1,n=1,s=1,a=1){return rv(e,WebGL2RenderingContext.ARRAY_BUFFER,ry,t,i,r,n,s,a).value}function rS(e){e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function rw(e){e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = getValue0();")}class rC extends eh.gj{width=Number.NaN;height=Number.NaN;hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){!this.hasSize(e,t)&&(this.width=e,this.height=t,this.performResize())}}class rx extends rC{gl;internalformat;renderbuffer;constructor(e,t){super(),this.gl=e,this.internalformat=t,this.renderbuffer=null,this.renderbuffer=e.createRenderbuffer()}performResize(){let{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}}class rE extends rx{gl;includeStencilBuffer;constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16),this.gl=e,this.includeStencilBuffer=t}attachToFramebuffer(){let{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}}class rT extends rE{constructor(e){super(e,!0)}}class rk extends eh.gj{gl;framebuffer;constructor(e){super(),this.gl=e,this.framebuffer=e.createFramebuffer()}disposed(){let{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}}class rD extends rC{gl;internalFormat;format;dataType;texture;constructor(e,t,i,r){super(),this.gl=e,this.internalFormat=t,this.format=i,this.dataType=r,this.texture=e.createTexture()}performResize(){!function(e,t,i,r,n=WebGL2RenderingContext.RGBA8,s=WebGL2RenderingContext.RGBA,a=WebGL2RenderingContext.UNSIGNED_BYTE){e.activeTexture(WebGL2RenderingContext.TEXTURE0+e.tempTextureUnit),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),rS(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,n,i,r,0,s,a,null),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}}class rL extends rD{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,i=WebGL2RenderingContext.DEPTH_COMPONENT,r=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,i,r)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}}function rI(e,t,i=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,n=WebGL2RenderingContext.UNSIGNED_BYTE){let s=[];for(let a=0;a<t;++a)s[a]=new rD(e,i,r,n);return s}class rP extends eh.gj{gl;width;height;colorBuffers;framebuffer;depthBuffer;fullAttachmentList;attachmentVerified;singleAttachmentList;constructor(e,t){super(),this.gl=e,this.width=Number.NaN,this.height=Number.NaN,this.fullAttachmentList=[],this.attachmentVerified=!1,this.singleAttachmentList=[WebGL2RenderingContext.COLOR_ATTACHMENT0];let{framebuffer:i=new rk(e),colorBuffers:r,depthBuffer:n}=t;this.framebuffer=this.registerDisposer(i),this.colorBuffers=r,this.depthBuffer=n,void 0!==n&&this.registerDisposer(n);let{fullAttachmentList:s}=this;r.forEach((t,i)=>{this.registerDisposer(t),s[i]=e.COLOR_ATTACHMENT0+i})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let{gl:i,depthBuffer:r}=this;void 0!==r?(r.resize(e,t),r.attachToFramebuffer()):i.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((r,n)=>{r.resize(e,t),r.attachToFramebuffer(i.COLOR_ATTACHMENT0+n)}),i.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),i.viewport(0,0,e,t)}bindSingle(e){let{gl:t}=this;this.framebuffer.bind(),0!==e&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,i,r,n=1,s=1){let{gl:a}=this;try{this.bindSingle(e),a.readPixels(t,i,n,s,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,r)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}}class rR extends eh.gj{gl;shader;constructor(e,t){super(),this.gl=e,this.shader=t,this.registerDisposer(t),this.copyVertexPositionsBuffer=rb(e),this.copyTexCoordsBuffer=rb(e,0,0,1,1)}copyVertexPositionsBuffer;copyTexCoordsBuffer;draw(...e){let{gl:t,shader:i}=this;i.bind();let r=e.length;for(let i=0;i<r;++i)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,e[i]);t.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,Z.TL);let n=i.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(n,2);let s=i.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(s,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(n),t.disableVertexAttribArray(s);for(let e=0;e<r;++e)t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=rw,i=1){return e.memoize.get(`OffscreenCopyHelper:${i}:${ri(t)}`,()=>new rR(e,function(e,t=rw,i=1){return e.memoize.get(`elementWiseTextureShader:${i}:${ri(t)}`,()=>{let r=new ru(e);r.addVarying("vec2","vTexCoord"),r.addUniform("sampler2D","uSampler",i),r.addInitializer(t=>{let r=[];for(let e=0;e<i;++e)r[e]=e;e.uniform1iv(t.uniform("uSampler"),r)});for(let e=0;e<i;++e)r.addFragmentCode(`
vec4 getValue${e}() {
  return texture(uSampler[${e}], vTexCoord);
}
`);return r.addUniform("mat4","uProjectionMatrix"),r.require(t),r.addAttribute("vec4","aVertexPosition"),r.addAttribute("vec2","aTexCoord"),r.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),r.build()})}(e,t,i)))}}let rA=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,rM=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,rN=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,rV=[rN,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],rO=[rN,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],rF=[rN,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],rB=[rN,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],r_=[[rN,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],rF,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],rU=[rB,rF,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],r$=[rN,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],rz=[rN,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],rG=[rN,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],rj=[rN,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],rW=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,rq=[rN,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],rH=[rN,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],rJ=[rN,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],rK=[rN,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`],rZ=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,rY=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,rX=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,rQ=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,r0=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,r1=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,r2=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,r3=[r1,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],r4=[r1,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function r6(e,t=1){switch(e){case el.FLOAT32:if(1===t)return"float";if(t>1&&t<=4)return`vec${t}`;break;case el.UINT8:case el.INT8:case el.UINT16:case el.INT16:case el.UINT32:case el.INT32:case el.UINT64:{let i=ed[e]?"":"u",r=8*eu[e];if(1===t)return`${i}int${r}_t`;if(t>1&&t*r<=32)return`${i}int${r}x${t}_t`}}throw Error(`No shader type for ${el[e]}[${t}].`)}let r5={[el.UINT8]:rG,[el.INT8]:rj,[el.UINT16]:rq,[el.INT16]:rH,[el.UINT32]:rJ,[el.INT32]:rK,[el.UINT64]:rN,[el.FLOAT32]:rW},r8={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function r9(e,t,i,r,n,s,a=1){let o=0,l=s*a;for(;l>0;){let i=Math.min(4,l),r=1===i?t:"float"===t?`vec${i}`:`${t[0]}vec${i}`;l-=i,e.addAttribute("highp "+r,`a${n}${o}`),++o}l=s*a;let d="";for(let e=0;e<a;++e){d+=`highp ${t}[${s}] get${n}${e}() {
  highp ${t}[${s}] result;
`;for(let t=0;t<s;++t){let i=e*s+t,r=Math.floor(i/4),a=i%4;d+=`  result[${t}] = a${n}${r}`,(0!==a||i!==l-1)&&(d+=`[${a}]`),d+=";\n"}d+="  return result;\n}\n"}e.addVertexCode(d);let u=r8[i];e.addInitializer(e=>{let s=[];for(let t=0;t<o;++t)s[t]=e.attribute(`a${n}${t}`);e.vertexShaderInputBinders[n]={enable(t){let{gl:i}=e;for(let e=0;e<o;++e){let r=s[e];i.enableVertexAttribArray(r),i.vertexAttribDivisor(r,t)}},disable(){let{gl:t}=e;for(let e=0;e<o;++e){let i=s[e];t.vertexAttribDivisor(i,0),t.disableVertexAttribArray(i)}},bind(n,a){let{gl:d}=e;for(let e=0;e<o;++e){let o=s[e],c=Math.min(4,l-4*e);"float"===t?d.vertexAttribPointer(o,c,i,r,n,a):d.vertexAttribIPointer(o,Math.min(4,l-4*e),i,n,a),a+=u*c}}}})}class r7 extends eh.gj{channels;properties;bounds;visibility;framebuffers;producerVisibility;frameNumber;constructor(e,t,i,r=new iK){super(),this.channels=e,this.properties=t,this.bounds=i,this.visibility=r,this.framebuffers=[],this.producerVisibility=new iK,this.frameNumber=-1}getFramebuffers(e){let{framebuffers:t}=this,i=this.bounds.value.length;for(;t.length<i;){let i=new rP(e,{colorBuffers:rI(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(i)}return t}get visibleHistograms(){return this.visibility.visible?this.bounds.value.length:0}disposed(){for(let e of this.framebuffers)e.dispose();this.framebuffers.length=0}}let ne=Symbol("histogramDataSamplerTextureUnit"),nt=Symbol("histogramDepthTextureUnit");class ni extends eh.gj{gl;shader;inputIndexBuffer;constructor(e){super(),this.gl=e,this.shader=this.registerDisposer((()=>{let e=new ru(this.gl);return e.addOutputBuffer("vec4","outputValue",0),e.addAttribute("float","aInput1"),e.addTextureSampler("sampler2D","uDataSampler",ne),e.addTextureSampler("sampler2D","uDepthSampler",nt),e.addVertexCode(rQ),e.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),e.build()})()),this.inputIndexBuffer=this.registerDisposer(rv(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(4096)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new ni(e))}compute(e,t,i,r,n){let{gl:s}=this,{shader:a}=this,o=r.getFramebuffers(s);a.bind(),s.enable(WebGL2RenderingContext.BLEND),s.disable(WebGL2RenderingContext.SCISSOR_TEST),s.disable(WebGL2RenderingContext.DEPTH_TEST),s.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(a.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let l=a.textureUnit(ne),d=a.textureUnit(nt);s.activeTexture(WebGL2RenderingContext.TEXTURE0+d),s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),rS(s),s.activeTexture(WebGL2RenderingContext.TEXTURE0+l);let u=r.frameNumber;r.frameNumber=n;for(let t=0;t<e;++t)s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i[t].texture),rS(s),o[t].bind(256,1),n!==u&&(s.clearColor(0,0,0,0),s.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),s.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,4096,4);s.disable(WebGL2RenderingContext.BLEND)}}let nr={[el.UINT8]:"vec2",[el.INT8]:"vec2",[el.UINT16]:"vec2",[el.INT16]:"vec2",[el.FLOAT32]:"vec2",[el.UINT32]:"Uint32LerpParameters",[el.INT32]:"Int32LerpParameters",[el.UINT64]:"Uint64LerpParameters"},nn={[el.UINT8]:"",[el.INT8]:"",[el.UINT16]:"",[el.INT16]:"",[el.FLOAT32]:"",[el.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[el.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[el.UINT64]:[rN,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]},ns=`
float computeInvlerp(float inputValue, vec2 p) {
  float outputValue = inputValue;
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;function na(e){let t=r6(e),i=`
float computeInvlerp(${t} inputValue, vec2 p) {
  return computeInvlerp(float(toRaw(inputValue)), p);
}
`;return[r5[e],ns,i]}function no(e){let t=r6(e),i=e===el.INT32?"int":"uint",r=nr[e];return[r5[e],nn[e],`
float computeInvlerp(${i} v, ${r} p) {
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
float computeInvlerp(${t} inputValue, ${r} p) {
  return computeInvlerp(toRaw(inputValue), p);
}
`]}let nl={[el.UINT8]:na(el.UINT8),[el.INT8]:na(el.INT8),[el.UINT16]:na(el.UINT16),[el.INT16]:na(el.INT16),[el.FLOAT32]:ns,[el.UINT32]:no(el.UINT32),[el.INT32]:no(el.INT32),[el.UINT64]:[rN,rF,rB,r$,nn[el.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function nd(e){let t=r6(e),i=`
${t} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return e===el.FLOAT32?i+="return inputValue;\n":i+=`return ${el[e].toLowerCase()}FromFloat(round(inputValue));
`,i+=`
}
`,[r5[e],i]}function nu(e){let t=r6(e),i=nr[e];return[r5[e],nn[e],r0,e===el.UINT32?r1:r3,e===el.UINT32?r2:r4,`
${t} computeLerp(float inputValue, ${i} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${t}(addSaturate(p.offset, xShifted));
  } else {
    return ${t}(subtractSaturate(p.offset, xShifted));
  }
}
`]}let nc={[el.UINT8]:nd(el.UINT8),[el.INT8]:nd(el.INT8),[el.UINT16]:nd(el.UINT16),[el.INT16]:nd(el.INT16),[el.FLOAT32]:nd(el.FLOAT32),[el.UINT32]:nu(el.UINT32),[el.INT32]:nu(el.INT32),[el.UINT64]:[rN,rF,rO,r_,rU,r$,rz,nn[el.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function nh(e,t,i){let r=`uLerpParams_${t}`,n=`uLerpBounds_${t}`,s=`uLerpScalar_${t}`,a="";switch(i){case el.INT8:case el.UINT8:case el.INT16:case el.UINT16:case el.FLOAT32:e.addUniform("vec2",r);break;case el.INT32:case el.UINT32:{let t=nr[i];e.addUniform(`${i===el.INT32?"i":"u"}vec2`,n),e.addUniform("float",s),a+=`
#define ${r} ${t}(${n}[0], int(${n}[1]), ${s})
`;break}case el.UINT64:e.addUniform("uvec3",n),e.addUniform("float",s),a+=`
#define ${r} Uint64LerpParameters(uint64_t(${n}.xy), int(${n}[2]), ${s})
`}return[nn[i],a]}function np(e,t,i,r=!1){let n=r6(i),s=`
float ${t}(${n} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${t});
  ${r?"v = clamp(v, 0.0, 1.0);":""}
  defaultMaxProjectionIntensity = v;
  return v;
}
`;if(i!==el.UINT64&&i!==el.FLOAT32){let e=ed[i]?"int":"uint";s+=`
float ${t}(${e} inputValue) {
  return ${t}(${n}(inputValue));
}
`}return[r5[i],nh(e,t,i),nl[i],s]}function ng(e,t,i,r){let{gl:n}=e;switch(i){case el.INT8:case el.UINT8:case el.INT16:case el.UINT16:case el.FLOAT32:n.uniform2f(e.uniform(`uLerpParams_${t}`),r[0],1/(r[1]-r[0]));break;case el.INT32:case el.UINT32:{let s=r[0],a=r[1]-s,o=Math.max(0,Math.ceil(Math.log2(Math.abs(a)))-24),l=2**o/a,d=e.uniform(`uLerpBounds_${t}`);i===el.UINT32?n.uniform2ui(d,s,o):n.uniform2i(d,s,o),n.uniform1f(e.uniform(`uLerpScalar_${t}`),l);break}case el.UINT64:{let i=r[0],s=r[1],a=(0,em.fD)(s-i),o=Math.max(0,Math.ceil(Math.log2(Number(a)))-24),l=1/Number(a>>=BigInt(o));i>s&&(l*=-1);let d=e.uniform(`uLerpBounds_${t}`);n.uniform3ui(d,Number(4294967295n&i),Number(i>>32n),o),n.uniform1f(e.uniform(`uLerpScalar_${t}`),l)}}}function nf(e,t,i){(0,ef.Kh)(e,t,e=>i.restoreState(e))}i(284);class nm extends eh.gj{children=new Map;changed=new eO.K_;add(e,t){let{children:i}=this;if(i.has(e))throw Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){let{children:t}=this;if(t.has(e))throw Error(`Key ${JSON.stringify(e)} not registered.`);let i=t.get(e);this.children.delete(e),i.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){let{changed:e}=this;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){let e=this.baseJSON();for(let[t,i]of this.children)e[t]=i.toJSON();return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){for(let[t,i]of((0,ef.PT)(e),this.children))try{if(Object.prototype.hasOwnProperty.call(e,t)){let r=e[t];if(void 0===r)continue;i.restoreState(r)}}catch(e){throw Error(`Error restoring property ${JSON.stringify(t)}: ${e.message}`)}}}let nv=new WeakMap;function ny(e){let t,i=nv.get(e),r=e.changed.count;if(void 0!==i&&i.generation===r)return i;if(e instanceof nm)for(let[i,r]of(t=e.baseJSON(),e.children))t[i]=ny(r).value;else t=e.toJSON();return void 0===i?(i={generation:r,value:t},nv.set(e,i)):(i.generation=r,i.value=t),i}var nb=i(5580),nS=((L={})[L.LINKED=0]="LINKED",L[L.RELATIVE=1]="RELATIVE",L[L.UNLINKED=2]="UNLINKED",L);(I={})[I.LINKED=0]="LINKED",I[I.UNLINKED=2]="UNLINKED";class nw extends nb.B{constructor(e=0){super(nS,e)}}nb.B;let nC=Z.R3.create(),nx=Z.gf.create();function nE(e,t,i,r){let n,s=!1;e.registerDisposer(t);let a=2,o=()=>{let s=i.value;if(s!==a)switch(s){case 2:n=void 0;break;case 0:n=void 0,r.assign(e,t);break;case 1:n=r.difference(e,t)}a=s,e.changed.dispatch()};return e.registerDisposer(e.changed.add(()=>{if(!s)switch(i.value){case 2:break;case 0:r.assign(t,e);break;case 1:r.subtract(t,e,n)}})),e.registerDisposer(t.changed.add(()=>{switch(s=!0,i.value){case 2:if(r.isValid(e))break;case 0:r.assign(e,t);break;case 1:r.add(e,t,n)}s=!1})),e.registerDisposer(i.changed.add(o)),o(),e}class nT extends eh.gj{coordinateSpace;coordinates_;curCoordinateSpace;changed;constructor(e){super(),this.coordinateSpace=e,this.coordinates_=tp,this.changed=new eO.K_,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=tp,this.changed.dispatch()}set value(e){let{curCoordinateSpace:t}=this;if(void 0===t||!t.valid||t.rank!==e.length)return;let{coordinates_:i}=this;i.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:i}=e;if(!e.valid)return;if(void 0===t||!t.valid){let{coordinates_:t}=this;if(void 0!==t&&t.length===i);else{!function(e,t){let{lowerBounds:i,upperBounds:r}=t,n=e.length;for(let t=0;t<n;++t)e[t]=tI(i[t],r[t])}(t=this.coordinates_=new Float32Array(i),e.bounds);let{voxelCenterAtIntegerCoordinates:r}=e.bounds;for(let e=0;e<i;++e)r[e]?t[e]=Math.round(t[e]):t[e]=Math.floor(t[e])+.5}this.changed.dispatch();return}let r=new Float32Array(i),n=this.coordinates_,{ids:s,scales:a}=e,{ids:o,scales:l}=t;for(let t=0;t<i;++t){let i=s[t],d=o.indexOf(i);-1===d?r[t]=tI(e.bounds.lowerBounds[t],e.bounds.upperBounds[t]):r[t]=n[d]*(l[d]/a[t])}this.coordinates_=r,this.changed.dispatch()}toJSON(){if(!this.valid&&0===this.coordinates_.length)return;this.handleCoordinateSpaceChanged();let{value:e}=this;if(0!==e.length)return Array.from(e)}restoreState(e){if(void 0===e){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from((0,ef.m7)(e,ef.jz)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();let{bounds:{voxelCenterAtIntegerCoordinates:e}}=this.coordinateSpace.value,{coordinates_:t}=this,i=t.length;for(let r=0;r<i;++r)e[r]?t[r]=Math.round(t[r]):t[r]=Math.floor(t[r])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();let{curCoordinateSpace:t,coordinates_:i}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(i),this.changed.dispatch()}static getOffset(e,t){let i=e.coordinates_,r=t.coordinates_;if(i.length===r.length)return tc(new Float32Array(i.length),i,r)}static addOffset(e,t,i,r=1){e.handleCoordinateSpaceChanged();let{value:n}=t;void 0!==i&&n.length===i.length&&(!function(e,t,i,r){let n=e.length;for(let s=0;s<n;++s)e[s]=t[s]+i[s]*r}(e.value,n,i,r),e.changed.dispatch())}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON:()=>e.toJSON(),reset(){e.reset()},restoreState(t){if(void 0===t||Array.isArray(t)){e.restoreState(t);return}(0,ef.PT)(t),nf(t,"voxelCoordinates",e)}}}}var nk=((P={})[P.STOP=0]="STOP",P[P.LOOP=1]="LOOP",P[P.REVERSE=2]="REVERSE",P);class nD{velocity=10;atBoundary=2;paused=!0}function nL(e){return(0,ef.PT)(e),{velocity:(0,ef.Kh)(e,"velocity",ef.jz,10),atBoundary:(0,ef.Kh)(e,"atBoundary",e=>(0,ef.CT)(e,nk),0),paused:(0,ef.Kh)(e,"paused",ef.JG,!0)}}class nI extends eh.gj{coordinateSpace;velocities_;curCoordinateSpace;changed;constructor(e){super(),this.coordinateSpace=e,this.changed=new eO.K_,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()})),this.curCoordinateSpace=e.value,this.velocities_=Array(this.curCoordinateSpace?.rank??0)}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.velocities_}set value(e){let{curCoordinateSpace:t}=this;void 0!==t&&t.rank===e.length&&(this.velocities_=e,this.changed.dispatch())}get(e){let t=this.coordinateSpace.value?.ids;if(void 0===t)return;let i=t.indexOf(e);if(-1!==i)return this.value[i]}dimensionVelocity(e,t){let i=new eO.K_,r=-1,n=()=>{let e=this.coordinateSpace.value?.ids;void 0===e?r=-1:(-1===r||e[r]!==t)&&(r=e.indexOf(t))},s=()=>{if(n(),-1!==r)return this.value[r]},a=e=>{if(n(),-1===r)return;let t=this.value;t[r]!==e&&(t[r]=e,this.changed.dispatch())},o=s();return e.registerDisposer(this.changed.add(()=>{let e=s();e!==o&&(o=e,i.dispatch())})),{get value(){return s()},set value(newVelocity){a(newVelocity)},changed:i}}modifyDimension(e,t){let i=this.coordinateSpace.value?.ids;if(void 0===i)return;let r=i.indexOf(e);if(-1===r)return;let n=this.value,s=n[r],a=t(s);s!==a&&(n[r]=a,this.changed.dispatch())}togglePlayback(e,t){this.modifyDimension(e,(e=new nD)=>({...e,paused:t??!e.paused}))}playbackEnabled(e){let t=this;return{changed:this.changed,get value(){return void 0!==t.get(e)},set value(enabled){t.modifyDimension(e,e=>enabled?e??new nD:void 0)}}}multiplyVelocity(e,t){this.modifyDimension(e,(e=new nD)=>{let i=Math.round(e.velocity*t);return 0===i&&(i=Math.sign(e.velocity)||1),{...e,velocity:i}})}handleCoordinateSpaceChanged(){let e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;let{rank:i}=e;if(!e.valid)return;if(void 0===t){let{velocities_:e}=this;e.length===i||(e=Array(i)),this.changed.dispatch();return}let r=Array(i),n=this.velocities_,{ids:s}=e,{ids:a}=t;for(let e=0;e<i;++e){let t=s[e],i=a.indexOf(t);-1!==i&&(r[e]=n[i])}this.velocities_=r,this.changed.dispatch()}toJSON(){this.handleCoordinateSpaceChanged();let{velocities_:e,curCoordinateSpace:t}=this;if(!t?.valid||!e.some(e=>void 0!==e))return;let i={},{names:r,rank:n}=t;for(let t=0;t<n;++t){let n=e[t];void 0!==n&&(i[r[t]]=function(e){let{velocity:t,atBoundary:i,paused:r}=e;return{velocity:t,atBoundary:0===i?void 0:nk[i].toLowerCase(),paused:!!r&&void 0}}(n))}return i}reset(){this.handleCoordinateSpaceChanged(),this.velocities_=Array(this.curCoordinateSpace?.rank??0)}restoreState(e){if(void 0===e){this.reset();return}(0,ef.PT)(e);let t=this.curCoordinateSpace=this.coordinateSpace.value;if(this.velocities_=Array(t?.rank??0),void 0===t)throw Error("Must specify dimensions in order to specify velocities");let i=this.velocities_=Array(t?.rank??0),{names:r}=t;for(let t of Object.keys(e)){let n=r.indexOf(t);if(-1===n)throw Error(`Invalid dimension name: ${JSON.stringify(t)}`);i[n]=(0,ef.uq)(e,t,nL)}this.changed.dispatch()}assign(e){let t=e.value,i=this.value,r=i.length,n=!1;for(let e=0;e<r;++e){let r=t[e],s=i[e];if(r!==s)(void 0===s||void 0===r||s.velocity!==r.velocity||s.atBoundary!==r.atBoundary||s.paused!==r.paused)&&(n=!0),i[e]=r}n&&this.changed.dispatch()}}class nP extends eh.gj{peer;positionLink;changed;velocity;constructor(e,t){super(),this.peer=e,this.positionLink=t,this.changed=new eO.K_,this.velocity=this.registerDisposer(new nI(e.coordinateSpace)),this.registerDisposer(e),this.velocity.changed.add(()=>{2===this.positionLink.value?this.changed.dispatch():this.peer.assign(this.velocity)});let i=()=>{2!==this.positionLink.value&&this.velocity.assign(this.peer)};this.registerDisposer(e.changed.add(i)),i()}toJSON(){if(2===this.positionLink.value)return this.velocity.toJSON()}reset(){2===this.positionLink.value&&this.velocity.reset()}restoreState(e){2===this.positionLink.value&&this.velocity.restoreState(e)}copyToPeer(){2===this.positionLink.value&&this.peer.assign(this.velocity)}}class nR extends eh.gj{display;position;velocity;dimensionStates;lastUpdateGeneration;unregisterUpdateStartedCallback;constructor(e,t,i){super(),this.display=e,this.position=t,this.velocity=i,this.dimensionStates=new Map,this.lastUpdateGeneration=0,this.handleVelocityChanged(),this.registerDisposer(i.changed.add(()=>this.handleVelocityChanged()))}disposed(){this.unregisterUpdateStartedCallback?.(),super.disposed()}handleVelocityChanged(){let{dimensionStates:e}=this,t=this.position.coordinateSpace.value?.ids??[],i=t.length,r=this.velocity.value,n=++this.lastUpdateGeneration,s=this.position.value,a=Date.now();for(let o=0;o<i;++o){let i=r[o];if(void 0===i||0===i.velocity||i.paused)continue;let l=t[o],d=e.get(l);void 0===d?e.set(l,{prevTime:a,dimensionIndex:o,prevCoordinate:s[o],generation:n}):(d.generation=n,d.dimensionIndex=o)}for(let[t,i]of e)i.generation!==n&&e.delete(t);if(0===e.size){let{unregisterUpdateStartedCallback:e}=this;void 0!==e&&(e(),this.unregisterUpdateStartedCallback=void 0)}else void 0===this.unregisterUpdateStartedCallback&&(this.unregisterUpdateStartedCallback=this.display.updateStarted.add(()=>this.updateStarted()),this.display.scheduleRedraw())}updateStarted(){let e=this.position.coordinateSpace.value;if(void 0===e)return;let t=e.ids,i=this.position.value,r=!1,n=!1,s=Date.now(),a=this.velocity.value,{bounds:{lowerBounds:o,upperBounds:l}}=e;for(let[e,d]of this.dimensionStates){let{dimensionIndex:u}=d;if(t[u]!==e)continue;let c=a[u];if(Math.floor(i[u])!==Math.floor(d.prevCoordinate)){c?.paused===!1&&(a[u]={...c,paused:!0},n=!0);continue}let h=s-d.prevTime,p=c?.velocity??0,g=h*p/1e3;if(0===g)continue;let f=i[u]+g,m=o[u],v=Math.ceil(l[u]-1),y=g>0?v:m,b=g>0?m:v,S=Math.sign(g);if(Number.isFinite(y)&&f*S>=y*S)switch(c.atBoundary){case 1:if(Number.isFinite(b)){f=b;break}case 0:a[u]={...c,paused:!0},n=!0,f=y;break;case 2:a[u]={...c,velocity:-p},n=!0,f=y}i[u]=f,d.prevCoordinate=i[u],d.prevTime=s,r=!0}r&&this.position.changed.dispatch(),n&&this.velocity.changed.dispatch(),this.display.scheduleRedraw()}}function nA(e,t,i){if(void 0===i||0===Object.keys(i).length){e.value=0;return}(0,ef.PT)(i),e.value=2,(0,ef.uq)(i,"value",e=>{void 0!==e&&t.restoreState(e)}),(0,ef.uq)(i,"link",t=>e.restoreState(t))}class nM{peer;link;value;get changed(){return this.value.changed}constructor(e,t=new nw){this.peer=e,this.link=t}toJSON(){let{link:e}=this;if(0!==e.value)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){nA(this.link,this.value,e)}copyToPeer(){0!==this.link.value&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}}class nN extends nM{}class nV extends nM{value=nE(new nT(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:nT.getOffset,add:nT.addOffset,subtract:(e,t,i)=>{nT.addOffset(e,t,i,-1)}})}class nO extends eh.gj{orientation;changed=new eO.K_;constructor(e){super(),null==e&&(e=Z.gf.create()),this.orientation=e}toJSON(){let{orientation:e}=this;if(Z.gf.normalize(this.orientation,this.orientation),0!==e[0]||0!==e[1]||0!==e[2]||1!==e[3])return Array.prototype.slice.call(this.orientation)}restoreState(e){try{(0,ef._b)(this.orientation,e),Z.gf.normalize(this.orientation,this.orientation)}catch{Z.gf.identity(this.orientation)}this.changed.dispatch()}reset(){Z.gf.identity(this.orientation),this.changed.dispatch()}snap(){let e=Z.wO.create();Z.wO.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let i=0;i<3;++i){let r=0,n=0;for(let s=0;s<3;++s){let a=e[3*i+s];e[3*i+s]=0,!t[s]&&Math.abs(a)>Math.abs(r)&&(r=a,n=s)}e[3*i+n]=Math.sign(r),t[n]=!0}Z.gf.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let i=new nO(Z.gf.multiply(Z.gf.create(),e.orientation,t)),r=!1;i.registerDisposer(e.changed.add(()=>{r||(n=!0,Z.gf.multiply(i.orientation,e.orientation,t),i.changed.dispatch(),n=!1)}));let n=!1,s=Z.gf.invert(Z.gf.create(),t);return i.registerDisposer(i.changed.add(()=>{n||(r=!0,Z.gf.multiply(e.orientation,i.orientation,s),e.changed.dispatch(),r=!1)})),i}assign(e){Z.gf.copy(this.orientation,e.orientation),this.changed.dispatch()}}class nF extends nM{value=nE(new nO,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{let i=Z.gf.create();return Z.gf.multiply(i,Z.gf.invert(i,t.orientation),e.orientation)},add:(e,t,i)=>{Z.gf.multiply(e.orientation,t.orientation,i),e.changed.dispatch()},subtract:(e,t,i)=>{Z.gf.multiply(e.orientation,t.orientation,Z.gf.invert(nx,i)),e.changed.dispatch()}})}class nB extends eh.gj{coordinateSpace;changed;curCoordinateSpace;value_;constructor(e){super(),this.coordinateSpace=e,this.changed=new eO.K_,this.curCoordinateSpace=tC,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=tC,this.changed.dispatch()}toJSON(){let e={},t=!1,{value:i}=this,{factors:r}=i,{names:n,rank:s}=this.curCoordinateSpace;for(let i=0;i<s;++i){let s=r[i];1!==s&&(e[n[i]]=s,t=!0)}if(t)return e}restoreState(e){let{coordinateSpace:{value:t}}=this,{names:i,rank:r}=t,n=new Float64Array(r);if(n.fill(-1),void 0!==e){let t=(0,ef.PT)(e);for(let e=0;e<r;++e)n[e]=(0,ef.uq)(t,i[e],e=>void 0===e?1:(0,ef.o7)(e))}this.value_={factors:n},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){let{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){let{coordinateSpace:{value:e}}=this,t=this.value_,{curCoordinateSpace:i}=this;if(i===e)return t;let{ids:r}=i,{ids:n,rank:s}=e,a=t.factors,o=new Float64Array(s);o.fill(1);for(let e=0;e<s;++e){let t=n[e],i=r.indexOf(t);-1!==i&&(o[e]=a[i])}return(0,H.cO)(o,a)||(t=this.value_={factors:o},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}}function n_(e,t,i,r,n){if(i===r)return t;let{ids:s}=i,{rank:a,ids:o}=r,l=new e(a);for(let e=0;e<a;++e){let i=o[e],r=s.indexOf(i);l[e]=-1===r?n(e):t[r]}return l}class nU extends nM{value=nE(new nB(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{let{factors:i}=e.value,r=e.coordinateSpace.value,n=t.value.factors;return{coordinateSpace:r,offsets:tc(new Float64Array(i.length),i,n)}},add:(e,t,i)=>{let r=n_(Float64Array,i.offsets,i.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(tu(new Float64Array(r.length),r,t.value.factors))},subtract:(e,t,i)=>{let r=n_(Float64Array,i.offsets,i.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(tc(new Float64Array(r.length),t.value.factors,r))},isValid:()=>!0})}function n$(e,t,i){let r;let{rank:n,names:s,units:a}=e,{displayRank:o,displayDimensionIndices:l}=t,d=new Float64Array(3),u=new Float64Array(3),{factors:c}=i,h=[,,,],p=new Float64Array(3);if(d.fill(1),u.fill(1),p.fill(1),h.fill(""),0===o)r=1;else{r=Number.POSITIVE_INFINITY;let{scales:t}=e;for(let e=0;e<o;++e){let i=l[e];r=Math.min(r,u[e]=c[i]*t[i]),h[e]=a[i],p[e]=t[i]}for(let e=0;e<o;++e)d[e]=u[e]/r}return{globalRank:n,globalDimensionNames:s,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:h,displayDimensionScales:p,canonicalVoxelFactors:d,voxelPhysicalScales:u,canonicalVoxelPhysicalSize:r}}function nz(e,t){return(0,H.cO)(e.globalDimensionNames,t.globalDimensionNames)&&(0,H.cO)(e.displayDimensionIndices,t.displayDimensionIndices)&&(0,H.cO)(e.canonicalVoxelFactors,t.canonicalVoxelFactors)&&(0,H.cO)(e.voxelPhysicalScales,t.voxelPhysicalScales)&&e.canonicalVoxelPhysicalSize===t.canonicalVoxelPhysicalSize&&(0,H.cO)(e.displayDimensionUnits,t.displayDimensionUnits)&&(0,H.cO)(e.displayDimensionScales,t.displayDimensionScales)}class nG extends eh.gj{relativeDisplayScales;displayDimensions;changed;curRelativeDisplayScales;curDisplayDimensions;curCoordinateSpace;value_;get value(){let{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:i},curRelativeDisplayScales:r,curDisplayDimensions:n,curCoordinateSpace:s}=this,a=this.value_;if(r!==e||n!==i||s!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=i,this.curCoordinateSpace=t;let r=n$(t,i,e);nz(a,r)||(this.value_=a=r,this.changed.dispatch())}return a}constructor(e,t){super(),this.relativeDisplayScales=e,this.displayDimensions=t,this.changed=new eO.K_,this.curRelativeDisplayScales=this.relativeDisplayScales.value,this.curDisplayDimensions=this.displayDimensions.value,this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value,this.value_=n$(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales),this.registerDisposer(e),this.registerDisposer(t);let i=()=>{this.value};this.registerDisposer(e.changed.add(i)),this.registerDisposer(t.changed.add(i))}}class nj extends eh.gj{coordinateSpace;changed;default_;value_;constructor(e){super(),this.coordinateSpace=e,this.changed=new eO.K_,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){let{coordinateSpace:{value:e}}=this,t=this.value_;if(void 0!==t&&t.coordinateSpace===e)return;if(void 0===t||this.default_){this.setToDefault(e);return}let i=new Int32Array(3),{ids:r}=t.coordinateSpace,{ids:n}=e,s=t.displayDimensionIndices,a=t.displayRank,o=0;for(let e=0;e<a;++e){let t=n.indexOf(r[s[e]]);-1!==t&&(i[o]=t,++o)}if(i.fill(-1,o),0===o){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,o,i),this.changed.dispatch()}setToDefault(e){let t=Math.min(e.rank,3),i=new Int32Array(3);i.fill(-1);for(let e=0;e<t;++e)i[e]=e;this.assignValue(e,t,i)}assignValue(e,t,i){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:i},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(void 0===e){this.reset();return}let t=tH(e);if(t.length>3)throw Error("Number of spatial dimensions must be <= 3");let{coordinateSpace:{value:i}}=this,r=new Int32Array(3);r.fill(-1);let{names:n}=i,s=0;for(let e of t){let t=n.indexOf(e);-1!==t&&(r[s++]=t)}if(0===s){this.reset();return}this.default_=!1,this.assignValue(i,s,r)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;let{value:e}=this,t=[],{displayRank:i,displayDimensionIndices:r,coordinateSpace:{names:n}}=e;if(0!==i){for(let e=0;e<i;++e)t[e]=n[r[e]];return t}}assign(e){if(e.default)this.default=!0;else{let{displayRank:t,displayDimensionIndices:i}=e.value;this.setDimensionIndices(t,i)}}}class nW extends nN{value=(R=new nj(this.peer.coordinateSpace),A=this.peer,nE(R,A,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0}))}class nq extends eh.gj{position;displayDimensionRenderInfo;orientation;changed;get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}constructor(e,t,i){super(),this.position=e,this.displayDimensionRenderInfo=t,this.orientation=i,this.changed=new eO.K_,this.registerDisposer(e),this.registerDisposer(i),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(i.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=nC){let{coordinateSpace:{value:i},value:r}=this.position,{displayDimensionIndices:n,displayRank:s}=this.displayDimensions.value;if(void 0===i)return!1;t.fill(0);for(let e=0;e<s;++e){let i=n[e];t[e]=r[i]}if(!1!==e(t)){for(let e=0;e<s;++e)r[n[e]]=t[e];return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){Z._E.fromQuat(e,this.orientation.orientation);let{value:i}=this.position,{canonicalVoxelFactors:r,displayDimensionIndices:n}=this.displayDimensionRenderInfo.value;for(let s=0;s<3;++s){let a=n[s],o=t/r[s];e[s]*=o,e[4+s]*=o,e[8+s]*=o,e[12+s]=i[a]||0}}toMat3(e,t){Z.wO.fromQuat(e,this.orientation.orientation);let{canonicalVoxelFactors:i,displayRank:r}=this.displayDimensionRenderInfo.value;for(let n=0;n<r;++n){let r=t/i[n];e[n]*=r,e[3+n]*=r,e[6+n]*=r}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;let{position:i}=this,{value:r}=i,{bounds:n}=i.coordinateSpace.value;r[e]=tL(n,e,r[e]+t),i.changed.dispatch()}translateVoxelsRelative(e){if(!this.valid)return;let t=Z.R3.transformQuat(nC,e,this.orientation.orientation),{position:i}=this,{value:r}=i,{displayDimensionIndices:n,displayRank:s}=this.displayDimensions.value,{bounds:a}=i.coordinateSpace.value;for(let e=0;e<s;++e){let i=n[e],s=t[e];0!==s&&(r[i]=tL(a,i,r[i]+s))}this.position.changed.dispatch()}rotateRelative(e,t){let i=Z.gf.create();Z.gf.setAxisAngle(i,e,t);let r=this.orientation.orientation;Z.gf.multiply(r,r,i),this.orientation.changed.dispatch()}rotateAbsolute(e,t,i){let{coordinateSpace:{value:r},value:n}=this.position;if(void 0===r)return;let{relativeDisplayScales:{value:{factors:s}},displayDimensions:{value:{displayDimensionIndices:a,displayRank:o}}}=this,{scales:l}=r,d=Z.gf.create();Z.gf.setAxisAngle(d,e,t);let u=this.orientation.orientation;nC.fill(0);for(let e=0;e<o;++e){let t=a[e],r=i[t]-n[t];nC[e]=r*l[t]*s[t]}let c=Z.gf.invert(nx,u);Z.R3.transformQuat(nC,nC,c),Z.gf.multiply(u,d,u),Z.R3.transformQuat(nC,nC,u);for(let e=0;e<o;++e){let t=a[e];n[t]=i[t]-nC[e]/(l[t]*s[t])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;let{displayDimensionIndices:i}=this.displayDimensions.value,{position:r}=this,n=r.coordinateSpace.value.rank;for(let r=0;r<n;++r)if(-1===i.indexOf(r)&&0==e--){this.translateDimensionRelative(r,t);return}}}class nH extends nM{constructor(e,t){super(e),this.value=(()=>{let i=new e.constructor(t);return nE(i,this.peer,this.link,{assign:(e,t)=>{e.assign(t)},isValid:e=>e.coordinateSpaceValue.valid&&0!==e.canonicalVoxelPhysicalSize,difference:(e,t)=>e.value/t.value*(e.canonicalVoxelPhysicalSize/t.canonicalVoxelPhysicalSize),add:(e,t,i)=>{e.setPhysicalScale(t.value*i,t.canonicalVoxelPhysicalSize)},subtract:(e,t,i)=>{e.setPhysicalScale(t.value/i,t.canonicalVoxelPhysicalSize)}}),i})()}}function nJ(e){return{changed:e.changed,toJSON:()=>e.toJSON(),restoreState(t){nA(e.link,e.value.legacyJsonView,t)},reset(){e.reset()}}}class nK extends eh.gj{displayDimensionRenderInfo;changed;curCanonicalVoxelPhysicalSize;value_;legacyValue_;get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){let{canonicalVoxelPhysicalSize:t}=this;(!Object.is(e,this.value_)||t!==this.curCanonicalVoxelPhysicalSize)&&(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Object.is(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}constructor(e){super(),this.displayDimensionRenderInfo=e,this.changed=new eO.K_,this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}handleCoordinateSpaceChanged(){let{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:i}}}}=this,{curCanonicalVoxelPhysicalSize:r}=this;if(Number.isNaN(e)||t!==r){if(!Number.isNaN(e)){0!==r&&(this.value_=r/t*e,this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}i.valid&&0!==t&&(this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){let{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,void 0===e?this.value_=Number.NaN:this.value_=(0,ef.o7)(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){let e=this;return{changed:e.changed,toJSON:()=>e.toJSON(),reset:()=>e.reset(),restoreState(t){e.legacyValue=(0,ef.o7)(t)}}}setPhysicalScale(e,t){let i=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=t/i*e}assign(e){let{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}}class nZ extends nK{getDefaultValue(){let{legacyValue_:e}=this;if(Number.isNaN(e))return 1;let{canonicalVoxelPhysicalSize:t}=this;return 1e-9*this.legacyValue_/t}}class nY extends nK{getDefaultValue(){let{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;let{canonicalVoxelPhysicalSize:t}=this;return 200*Math.tan(Math.PI/8)*1e-9*e/t}let{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:i}}}=this,{canonicalVoxelFactors:r,displayDimensionIndices:n}=this.displayDimensionRenderInfo.value,s=r.reduce((e,r,s)=>{let a=n[s];return Math.max(e,(i[a]-t[a])*r)},0);return Number.isFinite(s)?2**Math.ceil(Math.log2(s)):1024}}class nX extends eh.gj{defaultValue;displayDimensionRenderInfo;changed;constructor(e,t){super(),this.defaultValue=e,this.displayDimensionRenderInfo=t,this.changed=new eO.K_,this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}value_;canonicalVoxelPhysicalSize;get value(){let{value_:e}=this;if(e>0){let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,i=this.canonicalVoxelPhysicalSize;t!==i&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=i/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;let{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){let{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){"number"==typeof e&&Number.isFinite(e)&&0!==e?this.value=e:this.value=this.defaultValue}setValueAbsolute(e,t){if(e>0){let{canonicalVoxelPhysicalSize:i}=this.displayDimensionRenderInfo.value;e=t/i*e}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}}class nQ extends nN{constructor(e,t){var i,r;super(e),this.value=(i=new nX(e.defaultValue,t),r=this.peer,nE(i,r,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0}))}}class n0 extends eh.gj{pose;zoomFactor;depthRange;changed;constructor(e,t,i){super(),this.pose=e,this.zoomFactor=t,this.depthRange=i,this.changed=new eO.K_,this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(i),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}}function n1(e,t,i,r){let n=eb[t];if(t!==el.FLOAT32&&e===(r?n[1]:n[0]))return e;let s=(t===el.FLOAT32?i:Math.round(i))*(r?1:-1),a=t===el.UINT64?e+BigInt(Math.round(s)):e+s;return t===el.FLOAT32?a:eC(n,a)}function n2(e,t,i=0){if(t===el.UINT64&&1!==i)return e;let r=e[0],n=e[1];return[n1(r,t,i,!1),n1(n,t,i,!0)]}class n3{parents=[];parentPriorities=[];bindings=new Map;constructor(e){if(void 0!==e)for(let[t,i]of(this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities),e.bindings))this.bindings.set(t,i)}addParent(e,t){let{parents:i,parentPriorities:r}=this,n=0,{length:s}=i;for(;n<s&&t<r[n];)++n;return i.splice(n,0,e),r.splice(n,0,t),()=>{this.removeParent(e)}}removeParent(e){let t=this.parents.indexOf(e);if(-1===t)throw Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){let t;let{parents:i,parentPriorities:r}=this,n=r.length,s=0;for(;s<n&&r[s]>0;++s)if(void 0!==(t=i[s].get(e)))return t;if(void 0!==(t=this.bindings.get(e)))return t;for(;s<n;++s)if(void 0!==(t=i[s].get(e)))return t}*getAll(e){let t;let{parents:i,parentPriorities:r}=this,n=r.length;for(;0<n&&r[0]>0;)void 0!==(t=i[0].get(e))&&(yield t);for(void 0!==(t=this.bindings.get(e))&&(yield t);0<n;)void 0!==(t=i[0].get(e))&&(yield t)}*entries(){let{parents:e,parentPriorities:t}=this,i=t.length,r=0;for(;r<i&&t[r]>0;++r)yield*e[r].entries();for(yield*this.bindings.entries();r<i;++r)yield*e[r].entries()}}var n4=((M={})[M.CONTROL=1]="CONTROL",M[M.ALT=2]="ALT",M[M.META=4]="META",M[M.SHIFT=8]="SHIFT",M);function n6(e){return(e.ctrlKey?1:0)|(e.altKey?2:0)|(e.metaKey?4:0)|(e.shiftKey?8:0)}function n5(e,t){let i="";return 1&t&&(i+="control+"),2&t&&(i+="alt+"),4&t&&(i+="meta+"),8&t&&(i+="shift+"),i+=e}function n8(e){let t,i;let r=e.indexOf(":");if(-1!==r&&"at"!==(t=e.substring(0,r))&&"bubble"!==t)throw Error(`Invalid event phase: ${JSON.stringify(t)}`);let n=e.substring(r+1).split("+"),s=0,a=0;e:for(let e of n)switch(e){case"control":s|=1;break;case"control?":a|=1;break;case"alt":s|=2;break;case"alt?":a|=2;break;case"meta":s|=4;break;case"meta?":a|=4;break;case"shift":s|=8;break;case"shift?":a|=8;break;default:if(void 0===i)i=e;else{i=void 0;break e}}if(void 0===i||s&a)throw Error(`Invalid event identifier: ${JSON.stringify(e)}`);return{phase:t,keyName:i,modifiers:s,optionalModifiers:a}}function*n9(e){let{phase:t}=e,i=function*(e,t,i){0===i&&(yield n5(e,t));for(let r=0;r<16;++r)(r&(t|i))===r&&(r&t)===t&&(yield n5(e,r))}(e.keyName,e.modifiers,e.optionalModifiers);if(void 0===t)for(let e of i)yield`at:${e}`,yield`bubble:${e}`;else for(let e of i)yield`${t}:${e}`}function n7(e){return e=e.replace(/^(?:at|bubble|capture)|(?:(?:shift|control|alt|meta)\?\+)/g,"")}class se extends n3{label;static fromObject(e,t={}){let i=new se;if(i.label=t.label,void 0!==t.parents)for(let[e,r]of t.parents)i.addParent(e,r);for(let t of Object.keys(e))i.set(t,e[t]);return i}setFromObject(e){for(let t of Object.keys(e))this.set(t,e[t])}set(e,t){let i=n8(e),r=function(e,t){var i,r,n;let s;let a=(i=e.keyName,r=e.modifiers,n=e.optionalModifiers,s="",1&r&&(s+="control+"),1&n&&(s+="control?+"),2&r&&(s+="alt+"),2&n&&(s+="alt?+"),4&r&&(s+="meta+"),4&n&&(s+="meta?+"),8&r&&(s+="shift+"),8&n&&(s+="shift?+"),s+=i);return"string"==typeof t?{action:t,originalEventIdentifier:a}:{...t,originalEventIdentifier:a}}(i,t);for(let e of n9(i))super.set(e,r)}delete(e){for(let t of n9(n8(e)))super.delete(t)}describe(){let e=[],t=new Map;for(let[,e]of this.entries())t.set(e.originalEventIdentifier,e.action);let i=new Map;for(let[e,r]of t){let t=i.get(r);void 0===t&&(t=[],i.set(r,t)),t.push(n7(e))}for(let[t,r]of i){let i=1===r.length?r[0]:`{${r.join(",")}}`;e.push(`${i}→${t}`)}return e.join(", ")}}function st(e,t,i){if(void 0===i)return;!1!==i.stopPropagation&&e.stopPropagation();let r=new CustomEvent("action:"+i.action,{bubbles:!0,detail:t,cancelable:!0}),n=!e.target.dispatchEvent(r);(!1!==i.preventDefault||n)&&e.preventDefault()}let si=[];function sr(e,t,i,r,n){let s=si[i]+":"+e;st(t,r,n.get(s))}function sn(e,t,i,r){sr(n5(e,n6(t)),t,t.eventPhase,i,r)}function ss(e,t,i,r){return(0,eh.H0)(e,`action:${t}`,i,r)}si[Event.AT_TARGET]="at",si[Event.CAPTURING_PHASE]="capture",si[Event.BUBBLING_PHASE]="bubble";class sa extends eh.gj{target;eventMap;dispatch(e,t){this.shouldIgnore?.(t)||sn(e,t,t,this.eventMap)}shouldIgnore;constructor(e,t,i){super(),this.target=e,this.eventMap=t,this.shouldIgnore=void 0,this.registerEventListener(e,"wheel",e=>{void 0!==i&&i(e),this.dispatch("wheel",e)}),this.registerEventListener(e,"click",e=>{void 0!==i&&i(e),this.dispatch(`click${e.button}`,e)}),this.registerEventListener(e,"dblclick",e=>{void 0!==i&&i(e),this.dispatch(`dblclick${e.button}`,e)}),this.registerEventListener(e,"mousedown",e=>{void 0!==i&&i(e);let t=e.button;2===t&&(3&e.buttons)==1&&(t=0),this.dispatch(`mousedown${t}`,e)}),this.registerEventListener(e,"mouseup",e=>{void 0!==i&&i(e),this.dispatch(`mouseup${e.button}`,e)})}}function so(e,t,i){let{document:r}=e.view,n=e.clientX,s=e.clientY,a=e=>{let i=e.clientX-n,r=e.clientY-s;n=e.clientX,s=e.clientY,t(e,i,r)},o=e.button,l=e=>{r.removeEventListener("pointermove",a,!0),r.removeEventListener("pointerup",d,!1),void 0!==i&&i(e,e.clientX-n,e.clientY-s)},d=e=>{e.button===o&&l(e)};r.addEventListener("pointermove",a,!0),r.addEventListener("pointerup",d,!1),r.addEventListener("pointercancel",l,!1)}function sl(e){let t=0,{deltaMode:i}=e;switch(i){case 0:t=.005;break;case 1:t=.1;break;case 2:t=2}return Math.exp(e.deltaY*t)}let sd=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function su(e,t,i){e.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*t,i)}function sc(e,t=!1){e.addVertexCode(sd),e.addUniform("highp vec3","uLineParams"),e.addVarying("highp float","vLineCoord"),e.addVarying("highp float","vLineFeatherFraction"),t&&(e.addVarying("highp float","vEndpointFraction"),e.addVarying("highp float","vLineCoordT"),e.addVarying("highp float","vLineBorderStartFraction")),e.addVertexCode(rX),e.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${t?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${t?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${t?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${t?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${t?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${t?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${t?", borderWidth":""});
}
`),t&&e.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),e.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function sh(e,t,i){let{gl:r}=e;r.uniform3f(e.uniform("uLineParams"),1/t.width,1/t.height,i)}function sp(e,t,i,r){let n=Math.floor(t*=6),s=t-n,a=r*(1-i),o=r*(1-i*s),l=r*(1-i*(1-s));switch(n%6){case 0:e[0]=r,e[1]=l,e[2]=a;break;case 1:e[0]=o,e[1]=r,e[2]=a;break;case 2:e[0]=a,e[1]=r,e[2]=l;break;case 3:e[0]=a,e[1]=o,e[2]=r;break;case 4:e[0]=l,e[1]=a,e[2]=r;break;case 5:e[0]=r,e[1]=a,e[2]=o}return e}class sg extends eh.gj{model;getDefaultColor;element;constructor(e,t=()=>Z.R3.fromValues(1,0,0)){super(),this.model=e,this.getDefaultColor=t,this.element=document.createElement("input");let{element:i}=this;i.classList.add("neuroglancer-color-widget"),i.type="color",i.addEventListener("change",()=>this.updateModel()),i.addEventListener("input",()=>this.updateModel()),i.addEventListener("wheel",e=>{e.stopPropagation(),e.preventDefault(),this.adjustHueViaWheel(e)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){return this.model.value??this.getDefaultColor()}updateView(){this.element.value=er(this.getRGB())}updateModel(){this.model.value=Q(this.element.value)}adjustHueViaWheel(e){let t=this.getRGB(),i=Z.R3.create();!function(e,t,i,r){let n=Math.max(Math.max(t,i),r),s=Math.min(Math.min(t,i),r);if(e[2]=n,s===n)e[0]=0,e[1]=0;else{let a=n-s;e[1]=a/n,t===n?e[0]=(i-r)/a:i===n?e[0]=2+(r-t)/a:e[0]=4+(t-i)/a,e[0]/=6,e[0]<0&&(e[0]+=1),e[0]>1&&(e[0]-=1)}}(i,t[0],t[1],t[2]);let{deltaY:r}=e,n=Math.round(256*i[0]);n+=r>0?1:r<0?-1:0,n=(n+256)%256,i[0]=n/256,sp(i,i[0],i[1],i[2]),this.model.value=i}}i(4685);var sf=i(5659),sm=i(5966);function sv(e){for(;;){let t=e.firstChild;if(!t)break;e.removeChild(t)}}function sy(e){let{parentElement:t}=e;return!!t&&(t.removeChild(e),!0)}function sb(e,t=Math.max(1,e.value.length)){let i=`${t}ch`;e.style.width!==i&&(e.style.width="0px",e.offsetWidth,e.style.width=i)}function sS(e,t){let i=e.firstElementChild;for(let r of t)r!==i&&e.insertBefore(r,i),i=r.nextElementSibling;for(;null!==i;){let t=i.nextElementSibling;e.removeChild(i),i=t}}function sw(e){return e instanceof HTMLElement&&(!!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)||!!e.isContentEditable||null!==e.closest(".neuroglancer-sticky-focus"))}function sC(e){let t;let{title:i,onClick:r,href:n,clickable:s=!0}=e;void 0!==n?((t=document.createElement("a")).href=n,t.target="_blank"):t=document.createElement("div"),void 0!==i&&(t.title=i),void 0!==r&&t.addEventListener("click",r),s||t.classList.add("neuroglancer-info-icon");let{svg:a}=e;return t.classList.add("neuroglancer-icon"),void 0!==a&&(t.innerHTML=a),void 0!==e.text&&t.appendChild(document.createTextNode(e.text)),t}i(9215),i(5029);class sx extends eh.gj{parent;autoRangeData;finished;element;constructor(e){super(),this.parent=e,this.autoRangeData={inputPercentileBounds:[0,1],autoComputeInProgress:!1,previouslyComputedRanges:[],numIterationsThisCompute:0,invertedInitialRange:!1,finishedLerpRange:null},this.finished=new eO.K_,this.makeAutoRangeButtons(()=>this.autoComputeRange(0,1),()=>this.autoComputeRange(.01,.99),()=>this.autoComputeRange(.05,.95))}get computedRange(){return this.autoRangeData.finishedLerpRange}wasInputInverted(){let{range:e}=this.parent.trackable.value;return void 0!==e&&ek(e[0],e[1])>0}autoComputeRange(e,t){if(!this.autoRangeData.autoComputeInProgress){let{autoRangeData:i}=this,{dataType:r,display:n}=this.parent;i.inputPercentileBounds=[e,t],this.resetAutoRangeData(i),i.invertedInitialRange=this.wasInputInverted(),n.force3DHistogramForAutoRange=!0;let s=r===el.FLOAT32?[-65536,65536]:eb[r];this.setTrackableValue(s,s),n.scheduleRedraw()}}setTrackableValue(e,t){let i;void 0!==this.parent.trackable.value.range?this.parent.trackable.value={...this.parent.trackable.value,range:e,window:t}:this.parent.trackable.value={...this.parent.trackable.value,window:0===ek((i=t)[0],i[1])?eb[this.parent.dataType]:i}}maybeAutoComputeRange(){if(!this.autoRangeData.autoComputeInProgress){this.parent.display.force3DHistogramForAutoRange=!1;return}let{autoRangeData:e}=this,{trackable:t,dataType:i,display:r,histogramSpecifications:n,histogramIndex:s}=this.parent,a=r.gl,{range:o}=t.value;void 0===o&&(o=t.value.window),n.getFramebuffers(a)[s].bind(256,1);let{range:l,window:d}=function(e,t=.05,i=.95,r,n){let s=r[0],a=r[1],o=function(e){let t=e.reduce((e,t)=>e+t,0);if(0===t)return null;let i=0;return e.map(e=>(i+=e)/t)}(e);if(null===o)return{range:r,window:r};let l=function(e,t){let i=e.length-2,[r,n]=t;return Number(n-r)/i}(e,r),d=0;for(let e=0;e<o.length&&(d=e,!(o[e]>t));e++);let u=o.findIndex(e=>e>=i);if(u=-1===u?e.length-1:u,0===d){let e=l/2;n===el.FLOAT32&&(e=Math.max(e,Math.max(1,Math.abs(s/2)))),s=n1(s,n,e,!1)}else s=n1(s,n,l*(d-1),!0);if(u===e.length-1){let e=l/2;n===el.FLOAT32&&(e=Math.max(e,Math.max(1,Math.abs(a/2)))),a=n1(a,n,e,!0)}else a=n1(a,n,l*(e.length-2-u),!1);let c=[s,a],h=64*l;n!==el.FLOAT32&&(h=Math.max(1,h));let p=n2(c,n,h);return{range:c,window:p}}(function(e){let t=new Float32Array(1024);e.readPixels(0,0,256,1,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,t);let i=new Float32Array(256);for(let e=0;e<256;++e)i[e]=t[4*e];return i}(a),e.inputPercentileBounds[0],e.inputPercentileBounds[1],o,i),u=!1;u=i!==el.FLOAT32?e.previouslyComputedRanges.some(e=>eP(e,l)):e.previouslyComputedRanges.some(e=>.001>Math.abs(e[0]-l[0])&&.001>Math.abs(e[1]-l[1]));let c=0===ek(l[0],l[1]),h=e.numIterationsThisCompute>16;e.previouslyComputedRanges.push(l),++e.numIterationsThisCompute,u||h||c?(e.invertedInitialRange&&l.reverse(),this.resetAutoRangeData(e,!0),e.finishedLerpRange=l,this.setTrackableValue(l,d),this.finished.dispatch()):(r.force3DHistogramForAutoRange=!0,this.setTrackableValue(l,l))}resetAutoRangeData(e,t=!1){e.autoComputeInProgress=!t,e.previouslyComputedRanges=[],e.numIterationsThisCompute=0,t&&(e.invertedInitialRange=!1)}makeAutoRangeButtons(e,t,i){let r=this.parent.element;this.element=document.createElement("div");let n=this.element;n.classList.add("neuroglancer-invlerp-range-finder-button-container"),r.appendChild(n);let s=document.createElement("button");s.textContent="Min-Max",s.title="Set range to the minimum and maximum values",s.classList.add("neuroglancer-invlerp-range-finder-button"),s.addEventListener("click",e),n.appendChild(s);let a=document.createElement("button");a.textContent="1-99%",a.title="Set range to the 1st and 99th percentiles",a.classList.add("neuroglancer-invlerp-range-finder-button"),a.addEventListener("click",t),n.appendChild(a);let o=document.createElement("button");o.textContent="5-95%",o.title="Set range to the 5th and 95th percentiles",o.classList.add("neuroglancer-invlerp-range-finder-button"),o.addEventListener("click",i),n.appendChild(o)}}i(200);class sE extends eh.gj{visibility;element;get visible(){return this.visibility.visible}constructor(e=new iJ(iJ.VISIBLE)){super(),this.visibility=e,this.element=document.createElement("div");let{element:t}=this;t.classList.add("neuroglancer-tab-content")}disposed(){sy(this.element),super.disposed()}}class sT extends eh.gj{changed=new eO.K_;options=new Map;optionsChanged=new eO.K_;selectedValue=void 0;defaultValue=void 0;get value(){let{selectedValue:e}=this;return void 0!==e?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){void 0!==e&&this.ready_&&!this.options.has(e)&&(e=void 0);let{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){let e=this.selectedValue;return void 0!==e&&this.options.has(e)?e:this.defaultValue}add(e,t){let{options:i}=this;if(i.has(e))throw Error(`Option already defined: ${JSON.stringify(e)}.`);i.set(e,t),this.optionsChanged.dispatch(),void 0===this.defaultValue&&(this.default=e)}remove(e){let{options:t}=this;if(!t.has(e))throw Error(`Option is not defined: ${JSON.stringify(e)}.`);t.delete(e),this.optionsChanged.dispatch()}toJSON(){let{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}ready_=!0;get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){"string"!=typeof e&&(e=void 0),this.value=e}}class sk extends eh.gj{getter;selected;visibility;invalidateByDefault;element;tabs;tabVisibilityChanged;displayedTab;get visible(){return this.visibility.visible}debouncedUpdateSelectedTab;flush(){this.debouncedUpdateSelectedTab.flush()}constructor(e,t,i=new iJ(iJ.VISIBLE),r=!1){super(),this.getter=e,this.selected=t,this.visibility=i,this.invalidateByDefault=r,this.element=document.createElement("div"),this.tabs=new Map,this.tabVisibilityChanged=new eO.MZ,this.debouncedUpdateSelectedTab=this.registerCancellable((0,io.H)(()=>this.updateSelectedTab()));let{element:n}=this;n.className="neuroglancer-stack-view",this.registerDisposer(i.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}invalidate(e){let{tabs:t}=this,i=t.get(e);void 0!==i&&(i.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){let t=this.tabs.get(e);void 0!==t&&(t.visibility.value=iJ.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){let{tabs:t}=this,i=t.get(e);void 0===i&&(i=this.getter(e),this.element.appendChild(i.element),t.set(e,i)),i.element.style.display="",i.visibility.value=iJ.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){let{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;if(!(t===e&&(void 0===t||this.tabs.has(t))))void 0!==e&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,void 0!==t&&this.showTab(t)}invalidateAll(e){let{tabs:t}=this;for(let[i,r]of t)e?.(i)||(t.delete(i),r.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),sy(this.element),super.disposed()}}class sD extends sT{}class sL extends eh.gj{visibility;element;tabBar;tabs;selectedTab;handleTabElement;stack;tabLabels;tabsGeneration;get visible(){return this.visibility.visible}debouncedUpdateView;constructor(e,t=new iJ(iJ.VISIBLE)){super(),this.visibility=t,this.element=document.createElement("div"),this.tabBar=document.createElement("div"),this.tabLabels=new Map,this.tabsGeneration=-1,this.debouncedUpdateView=this.registerCancellable((0,io.H)(()=>this.updateTabs())),this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;let{element:i,tabBar:r}=this;i.className="neuroglancer-tab-view",r.className="neuroglancer-tab-view-bar",i.appendChild(r),this.registerDisposer(t.changed.add(this.debouncedUpdateView));let n=this.stack=this.registerDisposer(new sk(e.makeTab,e.selectedTab,this.visibility));i.appendChild(n.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView));let s=this.selectedTab.value;this.registerDisposer(e.selectedTab.changed.add(()=>{let e=this.tabs.value.find(({id:e})=>e===s);e?.hidden?(this.tabs.changed.count++,this.debouncedUpdateView()):this.updateTabLabelStyles(),s=this.selectedTab.value})),this.updateTabs()}updateTabLabelStyles(){let e=this.selectedTab.value;for(let[t,i]of this.tabLabels)!function(e,t){let i="neuroglancer-selected-tab-label";t?e.classList.add(i):e.classList.remove(i)}(i,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(-1!==this.tabsGeneration){if(this.tabLabels.clear(),this.visible){let e=this.tabs.value;this.stack.invalidateAll(t=>void 0!==e.find(({id:e})=>e===t))}else this.stack.invalidateAll();sv(this.tabBar),this.tabsGeneration=-1}}makeTabs(){let{tabBar:e,tabLabels:t,handleTabElement:i}=this;for(let{id:r,label:n,hidden:s}of this.tabs.value){if(s&&r!==this.selectedTab.value)continue;let a=document.createElement("div");a.classList.add("neuroglancer-tab-label"),a.textContent=n,a.addEventListener("click",()=>{this.selectedTab.value=r}),void 0!==i&&i(r,a),t.set(r,a),e.appendChild(a)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){sv(this.tabBar),this.tabLabels.clear(),sy(this.element),super.disposed()}}let sI=se.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}});function sP(e,t){let i=new ru(e);return sc(i),i.addTextureSampler("sampler2D","uHistogramSampler",t),i.addOutputBuffer("vec4","out_color",0),i.addAttribute("uint","aDataValue"),i.addUniform("float","uBoundsFraction"),i.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),i.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${sN-1} ? cumSum : total;
if (dataValue == ${sN-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),i.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),i.build()}class sR extends eh.gj{element;dataType;getModel;setModel;constructor(e,t,i,r){super(),this.element=e,this.dataType=t,this.getModel=i,this.setModel=r,e.title=sI.describe(),this.registerDisposer(new sa(e,sI)),ss(e,"set",e=>{var t;let i=e.detail,r=this.getModel(),n=this.getTargetValue(i);if(void 0===n)return;let s=(t=ex(r.window,r.range),"number"==typeof n?Math.abs(n-t[0])<Math.abs(n-t[1])?0:1:(0,em.fD)(t[0]-n)<(0,em.fD)(t[1]-n)?0:1),a=e=>{let t=this.getModel();this.setModel(sM(t,"range",s,e))};a(n),so(i,e=>{let t=this.getTargetValue(e);void 0!==t&&a(t)})}),ss(e,"adjust-window-via-drag",e=>{let t=e.detail,i=this.getTargetFraction(t),r=this.getWindowLerp(i),n=i<.5?0:1,s=e=>{let t=this.getModel();this.setModel(sM(t,"window",n,e))};so(t,e=>{let t=this.getModel().window,i=this.getTargetFraction(e);0===n?s(ew([r,t[1]],this.dataType,-i/(1-i))):s(ew([t[0],r],this.dataType,1/i))})}),ss(e,"zoom-via-wheel",e=>{let t=e.detail,i=sl(t),r=this.getTargetFraction(t),{dataType:n}=this,s=this.getModel(),a=ew(s.window,n,r*(1-i)),o=ew(s.window,n,(1-r)*i+r);this.setModel({...s,window:[a,o],range:s.range})})}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return ew(this.getModel().window,this.dataType,e)}getTargetValue(e){let t=this.getTargetFraction(e);if(Number.isFinite(t))return this.getWindowLerp(t)}}let sA=Symbol("histogramSamplerTexture");function sM(e,t,i,r,n=!1){let s={...e},a=e[t];if(s[t]=[a[0],a[1]],s[t][i]=r,"window"===t&&ek(r,a[1-i])*(2*i-1)<0&&(s[t][1-i]=r),"range"===t&&n){let t=[e.window[0],e.window[1]];for(let e=0;e<2;++e)ek(r,t[e])*(2*e-1)>0&&(t[e]=r);s.window=t}return s}let sN=255;class sV extends iy{parent;get drawOrder(){return 100}controller;constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.dataValuesBuffer=this.registerDisposer(rv(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{let e=new Uint8Array(6*sN);for(let t=0;t<sN;++t)for(let i=0;i<6;++i)e[6*t+i]=t;return e})).value,this.lineShader=this.registerDisposer(sP(this.gl,sA)),this.regionCornersBuffer=rb(this.gl,0,-1,1,1),this.regionShader=this.registerDisposer((()=>{let e=new ru(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addUniform("vec2","uBounds"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),e.setFragmentMain(`
out_color = uColor;
`),e.build()})());let{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel"),this.controller=this.registerDisposer(new sR(t,e.dataType,()=>e.trackable.value,t=>{e.trackable.value=t}))}dataValuesBuffer;lineShader;regionCornersBuffer;regionShader;drawIndirect(){let{lineShader:e,gl:t,regionShader:i,parent:{dataType:r,trackable:{value:n}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{i.bind(),t.uniform4f(i.uniform("uColor"),.2,.2,.2,1);let e=eS(n.window,n.range[0]),s=eS(n.window,n.range[1]),a=eM(r,n.window);t.uniform2f(i.uniform("uBounds"),Math.min(e,s)*a,Math.max(e,s)*a+(1-a));let o=i.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(o,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(o)}if(this.parent.histogramSpecifications.producerVisibility.visible){let{renderViewport:i}=this;e.bind(),sh(e,{width:i.logicalWidth,height:i.logicalHeight},1);let s=e.textureUnit(sA);t.uniform1f(e.uniform("uBoundsFraction"),eM(r,n.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+s),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),rS(t);let a=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(a,1,WebGL2RenderingContext.UNSIGNED_BYTE),su(t,sN,1),t.disableVertexAttribArray(a),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}}function sO(){}class sF extends iy{parent;shaderOptions;constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.cornersBuffer=rb(this.gl,-1,-1,1,1);let{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");let i=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=rg(this,this.gl,{...i,memoizeKey:{id:"colorLegendShader",base:i.memoizeKey},defineShader:(e,t,r)=>{var n;e.addOutputBuffer("vec4","v4f_fragData0",0),e.addAttribute("vec2","aVertexPosition"),e.addUniform("float","uLegendOffset"),e.addVarying("float","vLinearPosition"),e.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);let s=this.parent.dataType,a=r6(s);e.addFragmentCode((n="ng_colorLegendLerp",[r5[s],nh(e,n,s),nc[s],`
${r6(s)} ${n}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${n});
}
`])),e.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${a} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${a} getDataValue(int dummyChannel) {
  return getDataValue();
}
${a} getInterpolatedDataValue() {
  return getDataValue();
}
${a} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),i.defineShader(e,t,r)}})}shaderGetter;cornersBuffer;drawIndirect(){let e=this.shaderGetter(sO),{shader:t}=e;if(null===t)return;this.setGLLogicalViewport();let{gl:i}=this;i.clearColor(0,0,0,0),i.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),i.enable(WebGL2RenderingContext.BLEND);let{trackable:{value:{window:r}},dataType:n}=this.parent;ng(t,"ng_colorLegendLerp",this.parent.dataType,r);let s=function(e,t){switch(e){case el.FLOAT32:return 0;case el.UINT64:return .5/Number((0,em.fD)(t[0]-t[1]));default:return .5/Math.abs(t[0]-t[1])}}(n,r);i.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(s)?s:0),i.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),i.disable(WebGL2RenderingContext.DEPTH_TEST),i.disable(WebGL2RenderingContext.STENCIL_TEST);let a=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(a,2,WebGL2RenderingContext.FLOAT),i.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),i.disableVertexAttribArray(a)}isReady(){return!0}}function sB(e,t){let i=document.createElement("input");return i.addEventListener("focus",()=>{i.select()}),i.classList.add("neuroglancer-invlerp-widget-bound"),i.classList.add(`neuroglancer-invlerp-widget-${e}-bound`),i.type="text",i.spellcheck=!1,i.autocomplete="off",i.title="range"===e?`Data value that maps to ${t}`:`${0===t?"Lower":"Upper"} bound for distribution`,i}function s_(e,t,i){let r;let n=document.createElement("div");n.classList.add("neuroglancer-invlerp-widget-bounds"),n.classList.add(`neuroglancer-invlerp-widget-${e}-bounds`);let s=[sB(e,0),sB(e,1)];for(let r=0;r<2;++r){let n=s[r];n.addEventListener("input",()=>{sU(n)}),n.addEventListener("change",()=>{let s=i.value,a=s[e];try{let a=eD(t,n.value);i.value=sM(s,e,r,a,!0)}catch{s$(n,a[r])}})}return n.appendChild(s[0]),n.appendChild(s[1]),"range"===e&&((r=[document.createElement("div"),document.createElement("div"),document.createElement("div")])[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),n.insertBefore(r[0],s[0]),n.insertBefore(r[1],s[1]),n.appendChild(r[2])),{container:n,inputs:s,spacers:r}}function sU(e){sb(e,Math.max(1,e.value.length+.1))}function s$(e,t){let i;i="bigint"==typeof t||Number.isInteger(t)?t.toString():t.toPrecision(6),e.value=i,sU(e)}function sz(e){let t=e.value,{range:i}=t;e.value={...t,range:[i[1],i[0]]}}class sG extends sE{display;dataType;trackable;histogramSpecifications;histogramIndex;legendShaderOptions;cdfPanel;boundElements;invertArrows;autoRangeFinder;get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){sz(this.trackable)}constructor(e,t,i,r,n,s,a){super(e),this.display=t,this.dataType=i,this.trackable=r,this.histogramSpecifications=n,this.histogramIndex=s,this.legendShaderOptions=a,this.cdfPanel=this.registerDisposer(new sV(this)),this.boundElements={range:s_("range",i,r),window:s_("window",i,r)},this.registerDisposer(n.visibility.add(this.visibility));let{element:o,boundElements:l}=this;if(void 0!==a){let e=this.registerDisposer(new sF(this));o.appendChild(e.element)}let d=e=>{let t=sC({svg:e,title:"Invert range",onClick:()=>{this.invertRange()}});return l.range.spacers[1].appendChild(t),t};this.invertArrows=[d(sm),d(sf)],o.appendChild(l.range.container),o.appendChild(this.cdfPanel.element),o.classList.add("neuroglancer-invlerp-widget"),o.appendChild(l.window.container),this.autoRangeFinder=this.registerDisposer(new sx(this)),this.updateView(),this.registerDisposer(r.changed.add(this.registerCancellable((0,io.H)(()=>this.updateView())))),this.registerDisposer(this.display.updateFinished.add(()=>{this.autoRangeFinder.maybeAutoComputeRange()}))}updateView(){let{boundElements:e}=this,{trackable:{value:t},dataType:i}=this;for(let i=0;i<2;++i)s$(e.range.inputs[i],t.range[i]),s$(e.window.inputs[i],t.window[i]);let r=ek(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=r?"row-reverse":"row";let n=ex(t.window,t.range),s=e.range.spacers,a=eM(i,t.window),o=eS(t.window,n[r?1:0])*a,l=eS(t.window,n[r?0:1])*a+(1-a);s[r?2:0].style.width=`${100*o}%`,s[r?0:2].style.width=`${(1-l)*100}%`;let{invertArrows:d}=this;d[r?1:0].style.display="",d[r?0:1].style.display="none"}}class sj extends sE{display;watchableDataType;trackable;histogramSpecifications;histogramIndex;legendShaderOptions;invlerpWidget;constructor(e,t,i,r,n,s,a){super(e),this.display=t,this.watchableDataType=i,this.trackable=r,this.histogramSpecifications=n,this.histogramIndex=s,this.legendShaderOptions=a,this.invlerpWidget=this.makeInvlerpWidget(),this.registerDisposer(i.changed.add(()=>{sv(this.element),this.invlerpWidget.dispose(),this.invlerpWidget=this.makeInvlerpWidget()}))}get dataType(){return this.watchableDataType.value}disposed(){this.invlerpWidget.dispose(),super.disposed()}makeInvlerpWidget(){let{dataType:e}=this,t=new sG(this.visibility,this.display,e,this.trackable,this.histogramSpecifications,this.histogramIndex,this.legendShaderOptions);return this.element.appendChild(t.element),t}}let sW=se.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function sq(e,t){e.bindInputEventMap(sW),e.bindAction("adjust-contrast-via-wheel",e=>{e.stopPropagation();let i=sl(e.detail);!function(e,t,i){let r=t.value,n=ew(r.range,e,.5-i/2),s=ew(r.range,e,.5+i/2);t.value={...r,range:[n,s]}}(t.dataType,t.trackable,i)}),e.bindAction("adjust-via-drag",e=>{e.stopPropagation();let i=e.detail.screenX,r=e.detail.screenY,n=t.trackable.value.range,s=n,a=i,o=r;so(e.detail,e=>{let l=t.trackable.value.range,d=e.screenX,u=e.screenY;eP(l,s)||(n=l,i=a,r=o),function(e,t,i,r,n){let s=Math.exp(n),a=t.value,o=ew(i,e,.5-s/2+r),l=ew(i,e,.5+s/2+r);t.value={...a,range:[o,l]}}(t.dataType,t.trackable,n,(u-r)*2/screen.height,(d-i)*4/screen.width),s=t.trackable.value.range,a=d,o=u})}),e.bindAction("invert-range",e=>{e.stopPropagation(),sz(t.trackable)})}i(5838);var sH=i(5369),sJ=i(6434),sK=i(9730);i(9651);var sZ=i(5501);function sY(e={}){return sC({svg:sZ,...e})}let sX=new Set;function sQ(e){e.addEventListener("mousedown",e=>{e.preventDefault()})}function s0(){if(void 0===n){sQ(n=document.createElement("ul")),n.id="neuroglancer-status-container";let e=document.getElementById("neuroglancer-container");e?e.appendChild(n):document.body.appendChild(n)}return n}class s1{element;modalElementWrapper;timer;visibility=!0;constructor(e=!1,t=!1){let i=document.createElement("li");this.element=i,!0===e&&(e=200),this.setModal(t),!1!==e?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,sX.add(this)}[Symbol.dispose](){this.dispose()}dispose(){this.modalElementWrapper?s.removeChild(this.modalElementWrapper):n.removeChild(this.element),null!==this.timer&&clearTimeout(this.timer),sX.delete(this)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setModal(e){if(e){if(void 0===this.modalElementWrapper){let e=document.createElement("div"),t=sY({title:"Dismiss",onClick:()=>{this.setModal(!1)}});t.classList.add("neuroglancer-dismiss-modal"),e.appendChild(t),e.appendChild(this.element),this.modalElementWrapper=e,this.applyVisibility(),(function(){if(void 0===s){sQ(s=document.createElement("ul")),s.id="neuroglancer-status-container-modal";let e=document.getElementById("neuroglancer-container");e?e.appendChild(s):document.body.appendChild(s)}return s})().appendChild(e)}}else void 0!==this.modalElementWrapper?(s.removeChild(this.modalElementWrapper),this.modalElementWrapper=void 0,s0().appendChild(this.element)):null===this.element.parentElement&&s0().appendChild(this.element)}applyVisibility(){let e=this.visibility?"":"none";this.element.style.display=e;let{modalElementWrapper:t}=this;void 0!==t&&(t.style.display=e)}setVisible(e){null!==this.timer&&(clearTimeout(this.timer),this.timer=null),e!==this.visibility&&(this.visibility=e,this.applyVisibility())}static forPromise(e,t){let i=new s1(t.delay);i.setText(t.initialMessage);let r=i.dispose.bind(i);return e.then(r,e=>{let r;r=e instanceof Error?e.message:""+e;let{errorPrefix:n=""}=t;i.setErrorMessage(n+r),i.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){let t=new s1;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){let i=s1.showMessage(e);return window.setTimeout(()=>i.dispose(),t),i}}i(6700);let s2=[];function s3(e,t){let i=function(){if(void 0===a){let e=a=document.createElement("div");e.classList.add("neuroglancer-drag-status"),document.body.appendChild(e)}return a}();sv(i),0===e.clientX&&0===e.clientY||(e.clientX<window.innerWidth/2?(i.style.left="auto",i.style.right="0px"):(i.style.right="auto",i.style.left="0px")),"string"==typeof t?i.appendChild(document.createTextNode(t)):i.appendChild(t()),i.style.display=""}function s4(e,t){(0,H.dr)(s2,i=>i.target!==e||i.operation!==t||(i.leaveHandler?.(),!1))}function s6(e,t,i,r,n){s4(t,i),s2.push({target:t,operation:i,status:r,leaveHandler:n}),s3(e,r)}function s5(e,t,i){s4(t,i);let r=0===s2.length?void 0:s2[s2.length-1];void 0===r?void 0!==a&&(sv(a),a.style.display="none"):s3(e,r.status)}i(3395);function s8(e){m===e&&(m=void 0)}var s9=i(2831),s7=i(6235);let ae=/^(\s*)(?:(\+|-)|([a-zA-Z]+):(?:("(?:[^"\\]|\\.)*")|([^\s"/][^\s"]*)|\/((?:[^/\\]|\\.)*)\/)(?=$|\s))/;function at(e){let t,i,r=0,n=e,s={clauses:[]},a=[],o=()=>{void 0!==t&&(0===t.terms.length?(!1===t.include&&a.push({range:{begin:t.range.begin,end:r},message:"Exclusion clause must have at least one term"}),t.range.end=r):t.range.end=t.terms[t.terms.length-1].range.end,s.clauses.push(t))};for(;;r=i){let n;let s=e.match(ae);if(null===s)break;let l=s[0].length;i=r+l,e=e.substring(l);let d=s[1].length,u=s[2];if(void 0!==u){o(),t={range:{begin:r+d,end:-1},include:"+"===u,terms:[]};continue}let c=s[3];void 0===t?t={range:{begin:r+d,end:-1},include:!0,terms:[]}:void 0!==t.terms.find(e=>e.property===c)&&a.push({range:{begin:r+d,end:r+d+c.length},message:`Property ${JSON.stringify(c)} cannot be constrained by more than one term in a clause`});let h=s[4];if(void 0!==h)n={equals:JSON.parse(h)};else{let e=s[5];if(void 0!==e)n={equals:e};else try{n={regexp:RegExp(s[6],"i")}}catch(e){a.push({range:{begin:r+d+c.length+2,end:i-1},message:e.message}),n={equals:""}}}t.terms.push({range:{begin:r+d,end:i},property:c,predicate:n})}o();{let t=e.match(/^\s*/);null!==t&&(r+=t[0].length)}return{raw:n,query:s,errors:a,endOffset:r}}function ai(e,t){return"equals"in e?e.equals===t:null!==t.match(e.regexp)}let ar=/^([a-zA-Z]+):/;function an(e){let t=Array.from(e);return t.sort((e,t)=>(0,s7.B)(e[0],t[0])),t}function as(e,t){return e.dataTransfer.dropEffect=t,o=t,t}function aa(e,t,i){let r;r=e.shiftKey?"copy":e.ctrlKey&&i?"move":t;let n="",s=e=>{""!==n&&(n+=", "),n+=e};return"none"!==t&&r!==t&&s(e.shiftKey?`release SHIFT to ${t}`:`release CONTROL to ${t}`),"copy"!==r&&s("hold SHIFT to copy"),"move"!==r&&i&&"move"!==t&&s("hold CONTROL to move"),{dropEffect:r,dropEffectMessage:n}}let ao=/^[A-Z]$/;class al extends eh.gj{tool;inputEventMapBinder;constructor(e,t){super(),this.tool=e,this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(ss(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){let{globalBinder:e}=this.tool;this===e.activeTool_&&e.deactivate_()}}class ad extends eh.gj{localBinder;toggle;changed;unbound;keyBinding;savedJsonString;get context(){return this.localBinder.context}get globalBinder(){return this.localBinder.globalBinder}constructor(e,t=!1){super(),this.localBinder=e,this.toggle=t,this.changed=new eO.MZ,this.unbound=new eO.MZ,this.keyBinding=void 0,this.savedJsonString=void 0}renderInPalette(e){}unbind(){let{keyBinding:e}=this;void 0!==e&&this.localBinder.set(e,void 0),this.unbound.dispatch()}}class au extends ad{layer;constructor(e,t=!1){super(e.toolBinder,t),this.layer=e}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}}class ac extends eh.gj{layer;changed;constructor(e){super(),this.layer=e,this.changed=new eO.MZ}get context(){return this.layer}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){let{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}}function ah(e,t){let i;if(void 0===t)return;"string"==typeof t&&(t={type:t}),(0,ef.PT)(t);let r=(0,ef.uq)(t,"type",ef.ZE),n=e;for(;;){if(null===(n=Object.getPrototypeOf(n)))return;if(void 0!==(i=ag.get(n)?.get(r)?.getter))break}return i(e,t)}let ap=new Map,ag=new Map;function af(e,t){ap.set(e,t)}function am(e,t,i,r){let{prototype:n}=e,s=ag.get(n);void 0===s&&(s=new Map,ag.set(n,s)),s.set(t,{getter:i,lister:r})}class av extends eh.gj{layer;changed;value_;get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),void 0!==e&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){let e=this.value_;void 0!==e&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=function(e,t){if(void 0===t)return;"string"==typeof t&&(t={type:t}),(0,ef.PT)(t);let i=(0,ef.uq)(t,"type",ef.ZE),r=ap.get(i);if(void 0===r)throw Error(`Invalid tool type: ${JSON.stringify(t)}.`);return r(e,t)}(this.layer,e)}reset(){this.value=void 0}toJSON(){let e=this.value_;if(void 0!==e)return e.toJSON()}constructor(e){super(),this.layer=e,this.changed=new eO.MZ}}class ay extends eh.gj{inputEventMapBinder;toolPaletteState;bindings;changed;activeTool_;queuedTool;debounceDeactivate;localBinders;localBindersChanged;constructor(e,t){super(),this.inputEventMapBinder=e,this.toolPaletteState=t,this.bindings=new Map,this.changed=new eO.MZ,this.debounceDeactivate=this.registerCancellable((0,ie.Z)(()=>{this.deactivate_(),this.reactivateQueuedTool()},100)),this.localBinders=new Set,this.localBindersChanged=new eO.MZ}get(e){return this.bindings.get(e)}deleteBinding(e){let t=e.keyBinding;e.keyBinding=void 0,this.bindings.delete(t);let i=e.localBinder;i.bindings.delete(t);let{jsonToKey:r}=i,{savedJsonString:n}=e;r.get(n)===t&&r.delete(n),this.destroyTool(e)}toolJsonMaybeChanged(e){let{keyBinding:t}=e;if(void 0===t)return;let i=JSON.stringify(e.toJSON());if(i===e.savedJsonString)return;let r=e.localBinder;for(r.jsonToKey.delete(e.savedJsonString);;){let n=r.jsonToKey.get(i);if(r.jsonToKey.set(i,t),e.savedJsonString=i,void 0===(t=n))break;let s=JSON.stringify((e=r.bindings.get(t)).toJSON());if(s===i){this.deleteBinding(e);break}i=s}r.changed.dispatch(),this.changed.dispatch()}set(e,t){let{bindings:i}=this,r=i.get(e);if(void 0!==r&&(this.deleteBinding(r),r.localBinder.changed.dispatch()),void 0!==t){let r=t.localBinder,n=JSON.stringify(t.toJSON());t.savedJsonString=n;let s=r.jsonToKey.get(n);if(void 0!==s){let e=r.bindings.get(s);this.deleteBinding(e)}r.bindings.set(e,t),t.keyBinding=e,r.jsonToKey.set(n,e),i.set(e,t),r.changed.dispatch(),t.changed.add(()=>{this.toolJsonMaybeChanged(t)})}this.changed.dispatch()}activate(e){let t=this.get(e);if(void 0===t){this.deactivate_();return}this.debounceDeactivate.cancel();let i=this.activeTool_;if(t===i?.tool){t.toggle&&this.deactivate_();return}void 0!==i&&(i.tool.toggle&&!t.toggle&&(this.queuedTool=i.tool),this.deactivate_());let r=new al(t,this.inputEventMapBinder);if(this.activeTool_=r,!t.toggle){let t=`Key${e}`;r.registerEventListener(window,"keydown",e=>{e.stopPropagation(),e.preventDefault()}),r.registerEventListener(window,"keyup",e=>{e.code===t&&this.debounceDeactivate()}),r.registerEventListener(window,"blur",()=>{this.debounceDeactivate()})}return t.activate(r),t}reactivateQueuedTool(){if(this.queuedTool){let e=new al(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){this.queuedTool===e&&(this.queuedTool=void 0),this.activeTool_?.tool===e&&this.deactivate_(),e.dispose()}disposed(){for(let e of(this.deactivate_(),super.disposed(),this.bindings.values()))e.dispose()}deactivate_(){this.debounceDeactivate.cancel();let e=this.activeTool_;void 0!==e&&(this.activeTool_=void 0,e.dispose())}deactivate(){this.debounceDeactivate()}}class ab extends eh.gj{context;globalBinder;bindings;jsonToKey;changed;constructor(e,t){super(),this.context=e,this.globalBinder=t,this.bindings=new Map,this.jsonToKey=new Map,this.changed=new eO.MZ,t.localBinders.add(this),t.localBindersChanged.dispatch()}getSortOrder(){return Number.NEGATIVE_INFINITY}disposed(){this.globalBinder.localBinders.delete(this),this.globalBinder.localBindersChanged.dispatch(),this.clear(),super.disposed()}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){let i=ah(this.context,t);void 0!==i&&this.set(e,i)}removeJsonString(e){let t=this.jsonToKey.get(e);void 0!==t&&this.set(t,void 0)}toJSON(){let{bindings:e}=this;if(0===e.size)return;let t={};for(let[i,r]of e)t[i]=r.toJSON();return t}getCommonToolProperties(){return{}}convertLocalJSONToPaletteJSON(e){return e}clear(){let{globalBinder:e,bindings:t}=this;if(0!==t.size){for(let[i,r]of t)r.keyBinding=void 0,e.bindings.delete(i),e.destroyTool(r);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(void 0!==e)for(let[t,i]of((0,ef.PT)(e),Object.entries(e))){if(!t.match(ao))throw Error(`Invalid tool key: ${JSON.stringify(t)}`);let e=ah(this.context,i);if(void 0===e)return;this.set(t,e)}}}class aS extends ab{getCommonToolProperties(){return{layer:this.context.managedLayer.name,layerType:this.context.managedLayer.layer?.type}}convertLocalJSONToPaletteJSON(e){let t=e;return"string"==typeof t&&(t={type:t}),{layer:this.context.managedLayer.name,...t}}getSortOrder(){let{managedLayer:e}=this.context;return e.manager.layerManager.updateNonArchivedLayerIndices(),this.context.managedLayer.nonArchivedLayerIndex}}function aw(e,t,i=!1){let{paletteState:r,dragElement:n}=e;if(void 0===r||void 0===n)return;let s="neuroglancer-tool-to-be-removed";"move"===t&&!1===i?n.classList.add(s):n.classList.remove(s)}class aC extends eh.gj{localBinder;toolJson;dragElement;paletteState;element;toolJsonString;constructor(e,t,i,r){super(),this.localBinder=e,this.toolJson=t,this.dragElement=i,this.paletteState=r,this.element=document.createElement("div"),this.toolJsonString=JSON.stringify(t);let{element:n}=this;n.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.changed.add(this.registerCancellable((0,io.H)(()=>this.updateView())))),this.updateView(),n.title="click → bind key, dbclick → unbind",n.addEventListener("dblclick",()=>{this.localBinder.removeJsonString(this.toolJsonString)}),ax(this,n,e=>this.localBinder.setJson(e,this.toolJson)),void 0!==i&&(i.draggable=!0,i.addEventListener("dragstart",e=>{s6(e,i,"drag","Drag tool to another tool palette, or to the left/top/right/bottom edge of a layer group to create a new tool palette"),m=this;let{toolPaletteState:r}=this.localBinder.globalBinder,n=this;r.viewer.sidePanelManager.startDrag({dropAsNewPanel:(e,i)=>{if(r.addNew({location:e}).tools.insert(this.localBinder.convertLocalJSONToPaletteJSON(t)),"move"===i){let{paletteState:e}=this;e?.palette.state.queryDefined.value===!1&&e.palette.state.tools.remove(e.tool)}},getNewPanelDropEffect:e=>{let t=this.paletteState?.palette.state.queryDefined.value===!1,i=aa(e,t?"move":"copy",t);return aw(n,i.dropEffect,!1),{...i,description:"tool",leaveHandler:()=>{aw(n)}}}},e)}),i.addEventListener("dragend",e=>{s5(e,i,"drag"),s8(this);let{toolPaletteState:t}=this.localBinder.globalBinder;t.viewer.sidePanelManager.endDrag(),e.stopPropagation()}))}updateView(){let{localBinder:e}=this,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t??" "}}function ax(e,t,i){let r;t.addEventListener("mousedown",t=>{0===t.button&&void 0===r&&(t.preventDefault(),t.stopPropagation(),r=new eh.gj,e.registerDisposer(r),r.registerDisposer(new s1(!1)).setText("Press A-Z to bind key"),r.registerEventListener(window,"keydown",e=>{let{code:t}=e,r=t.match(/^Key([A-Z])$/);null!==r&&(e.stopPropagation(),e.preventDefault(),i(r[1]))},{capture:!0}),r.registerEventListener(window,"mouseup",t=>{0===t.button&&void 0!==r&&(t.preventDefault(),t.stopPropagation(),e.unregisterDisposer(r),r.dispose(),r=void 0)}))}),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation()})}function aE(e,t,i){let r=document.createElement("div");r.classList.add("neuroglancer-tool-button"),r.appendChild(e.registerDisposer(new aC(t,i.toolJson,i.dragElement??r)).element);let n=document.createElement("div");n.classList.add("neuroglancer-tool-button-label");let s=i.label;return void 0!==s&&(n.textContent=s),i.title&&(n.title=i.title),r.appendChild(n),r}function aT(e){let t=e.registerDisposer(new s1(!1));t.element.classList.add("neuroglancer-tool-status");let i=document.createElement("div");i.classList.add("neuroglancer-tool-status-content"),t.element.appendChild(i);let{inputEventMapBinder:r}=e;return e.inputEventMapBinder=(e,i)=>{let n=document.createElement("div");n.textContent=e.describe(),n.classList.add("neuroglancer-tool-status-bindings"),t.element.appendChild(n),r(e,i)},{message:t,content:i}}function ak(e){let{message:t,content:i}=aT(e),r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");let n=document.createElement("div");n.classList.add("neuroglancer-tool-status-header-container"),n.appendChild(r),i.appendChild(n);let s=document.createElement("div");return s.classList.add("neuroglancer-tool-status-body"),i.appendChild(s),{message:t,body:s,header:r}}function*aD(e,t,i,r,n){for(let s of t(e.context,n))(function(e,t){for(let i of t){let t=e[i.property];if("string"!=typeof t||!ai(i.predicate,t))return!1}return!0})(s,i)&&(yield{...e.convertLocalJSONToPaletteJSON(s),...r})}function aL(e,t,i){let r=new Map,n=Array.from(e.localBinders);for(let e of(n.sort((e,t)=>e.getSortOrder()-t.getSortOrder()),n))for(let{include:n,terms:s}of t.clauses)for(let t of function*(e,t,i){let r=t.find(e=>"type"===e.property)?.predicate,n=void 0!==r&&"equals"in r?r.equals:void 0,s=e.getCommonToolProperties();for(let e of t){let{property:t}=e;if(t in s&&!ai(e.predicate,s[t]))return}let a=t.filter(e=>!(e.property in s)&&"type"!==e.property),{context:o}=e,l=o;for(;null!==(l=Object.getPrototypeOf(l));){let t=ag.get(l);if(void 0!==t){if(void 0!==n){let r=t.get(n)?.lister;if(void 0===r)continue;yield*aD(e,r,a,s,i);break}for(let[n,{lister:o}]of t)if(void 0!==o){if(void 0!==r&&!ai(r,n))continue;yield*aD(e,o,a,s,i)}}}}(e,s,i)){let e=JSON.stringify(t);n?r.set(e,t):r.delete(e)}return r}function aI(e,t="text/plain"){let i=!1,r=(0,eh.H0)(document,"copy",r=>{let{clipboardData:n}=r;null!==n&&(n.setData(t,e),i=!0),r.stopPropagation(),r.preventDefault()},!0);try{document.execCommand("copy")}finally{r()}return i}let aP=new J.SN(0);window.addEventListener("keydown",e=>{aP.value=n6(e)}),window.addEventListener("keyup",e=>{aP.value=n6(e)});let aR=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),aA=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]);class aM extends eh.gj{target;eventMap;modifierShortcutsAreGlobal;allShortcutsAreGlobal;allowSpaceKeyOnButtons;shouldIgnore;constructor(e,t){super(),this.target=e,this.eventMap=t,this.modifierShortcutsAreGlobal=!0,this.allShortcutsAreGlobal=!1,this.allowSpaceKeyOnButtons=!1,this.shouldIgnore=void 0,this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){if(this.shouldIgnore?.(t))return!0;let i=t.target,{tagName:r}=i;if(i===this.target)return!1;let n="TEXTAREA"===r||"INPUT"===r||"BUTTON"===r||"SELECT"===r,s=!n&&(i.isContentEditable||i.ownerDocument&&"on"===i.ownerDocument.designMode);return!(!n&&!s||this.allShortcutsAreGlobal||aR.has(e))&&(!!s||!!this.modifierShortcutsAreGlobal&&(!!t.altKey||!!t.ctrlKey||!!t.metaKey)||("INPUT"===r&&aA.has(i.type)?"enter"!==e:"INPUT"!==r&&"BUTTON"!==r||!this.allowSpaceKeyOnButtons&&"space"===e))}handleKeyDown(e){let t=e.code.toLowerCase();!this.shouldIgnoreEvent(t,e)&&sn(t,e,e,this.eventMap)}}i(677);class aN extends eh.gj{element;constructor(e,t){super(),this.element=sC({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add("dark"===t.backgroundScheme?"dark-background":"light-background");let i=()=>{let i=e.value;this.element.dataset.checked=i?"true":"false",this.element.title=(i?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(i)),i()}}var aV=i(6516);function aO(e={}){return sC({svg:aV,...e})}class aF extends eh.gj{redraw;constructor(e){super(),this.redraw=e}}class aB extends eh.gj{model;render;visibility;element;generation;currentViewDisposer;debouncedUpdateView;debouncedForceUpdateView;constructor(e,t,i=new iJ(iJ.VISIBLE)){super(),this.model=e,this.render=t,this.visibility=i,this.element=document.createElement("div"),this.generation=-1,this.currentViewDisposer=void 0,this.debouncedUpdateView=this.registerCancellable((0,io.H)(()=>this.updateView())),this.debouncedForceUpdateView=()=>{this.generation=-1,this.debouncedUpdateView()},this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(i.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.disposeCurrentView();let i=this.currentViewDisposer=new aF(this.debouncedForceUpdateView);this.render(e.value,this.element,i),this.generation=t}disposeCurrentView(){let{currentViewDisposer:e}=this;void 0!==e&&e.dispose(),sv(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}}class a_ extends eh.gj{model;element;valueIndexMap;constructor(e){super(),this.model=e,this.element=document.createElement("select"),this.valueIndexMap=new Map;let{element:t,valueIndexMap:i}=this,r=0;for(let n of Object.keys(e.enumType))if(Number.isNaN(Number(n))){let s=document.createElement("option");s.textContent=s.value=n.toLowerCase(),t.appendChild(s),i.set(e.enumType[n],r),++r}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",e=>{e.preventDefault(),e.stopPropagation(),this.adjustViaWheel(e)}),this.updateView()}adjustViaWheel(e){let{element:t}=this,{deltaY:i}=e;i>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):i<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){let{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}}class aU extends eh.gj{model;element;inputElement;validator;constructor(e,t={}){super(),this.model=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input");let{validator:i,label:r}=t,{element:n,inputElement:s}=this;void 0===i&&(i=e instanceof J.TU?e.validator:e=>e),this.validator=i,void 0!==r&&(n.textContent=r),n.appendChild(s),n.className="neuroglancer-number-input",s.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(s,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){sy(this.element),super.disposed()}}function a$(e,t,i,r){return Math.floor((e-t)*(r-1)/(i-t))}i(389);class az extends eh.gj{position;dimensionId;orientation;element;visible;dragging;tickWidth;barWidth;barRightMargin;canvasWidth;constructor(e,t,i="column"){let r,n,s;super(),this.position=e,this.dimensionId=t,this.orientation=i,this.element=document.createElement("div"),this.visible=!0,this.dragging=new J.SN(!1),this.tickWidth="column"===i?10:5,this.barWidth="column"===i?15:10,this.barRightMargin="column"===i?10:2,this.canvasWidth=this.tickWidth+this.barWidth+this.barRightMargin;let a=this.element;a.classList.add("neuroglancer-position-dimension-plot"),a.dataset.orientation=i;let o=document.createElement("canvas"),l=o.getContext("2d"),d=document.createElement("div"),u=document.createElement("div");u.appendChild(d);let c=document.createTextNode("");d.appendChild(c);let h=document.createElement("div"),p=document.createElement("div");u.classList.add("neuroglancer-position-dimension-plot-lowerbound"),h.classList.add("neuroglancer-position-dimension-plot-upperbound"),p.classList.add("neuroglancer-position-dimension-plot-hoverposition"),a.appendChild(u),a.appendChild(h),a.appendChild(p),a.appendChild(o);let g=()=>{let e,t,a,u;let g=this.position.coordinateSpace.value,f=g.ids.indexOf(this.dimensionId);if(-1===f)return;"column"===i?(e=100,o.width=this.canvasWidth,o.height=e,h.style.marginTop=`${e-1}px`):(e=o.clientWidth,o.width=e,o.height=this.canvasWidth);let m=function(e,t,i){let{boundingBoxes:r,bounds:n}=e,[s,a]=tD(n,t);if(s=Math.floor(s),a=Math.floor(a-1),!Number.isFinite(s)||!Number.isFinite(a))return;let o=[],l=e=>a$(e,s,a,i),{rank:d}=e;for(let e of r){let r=tR(e,t,d);void 0!==r&&(r.lower=Math.max(0,l(r.lower)),r.upper=Math.min(i-1,l(Math.ceil(r.upper-1))),o.push(r))}return o.sort((e,t)=>{let i=e.lower-t.lower;return 0!==i?i:t.upper-t.upper}),(0,H.dr)(o,(e,t)=>{if(0===t)return!0;let i=o[t-1];return i.lower!==e.lower||i.upper!==e.upper}),{lowerBound:s,upperBound:a,normalizedBounds:o}}(g,f,e);if(void 0===m||g.bounds.lowerBounds[f]+1===g.bounds.upperBounds[f]){this.element.style.display="none",this.visible=!1;return}this.element.style.display="",this.visible=!0;let{lowerBound:v,upperBound:y}=m;r=v,n=y,c.textContent=v.toString(),h.textContent=y.toString(),"column"!==i&&(t=Math.max(a=d.clientWidth,u=h.clientWidth)/2,o.style.marginLeft=`${t}px`,o.style.marginRight=`${t}px`,h.style.position="relative",h.style.left=`${e+t-u/2}px`,d.style.marginLeft=`${t-a/2}px`),this.drawDimensionBounds(o,l,m);let b=this.position.value[f],S=(t,r)=>{if(void 0!==t&&t>=v&&Math.floor(t)<=y){l.fillStyle=r;let n=a$(t,v,y,e);return"column"===i?l.fillRect(0,n,this.canvasWidth,1):l.fillRect(n,0,1,this.canvasWidth),n}},w=S(b,"#f66"),C=this.dragging.value,x=C?w:S(s,"#66f");if(void 0!==x){let r,n,a;p.textContent=(C?Math.floor(b):s).toString();let o="column"===i?d.clientHeight:d.clientWidth,l="column"===i?h.clientHeight:h.clientWidth;if("column"!==i){r=p.clientWidth,x+=t,x-=r/2;let i=e+t-l/2-r;n=(x=Math.max(0,x))>t+o/2,a=x<i}else n=x>o,a=x<e-l;d.style.visibility=n?"":"hidden",h.style.visibility=a?"":"hidden",p.style.display="",p.style.visibility="visible","column"===i?p.style.marginTop=`${x}px`:p.style.marginLeft=`${x}px`}else d.style.visibility="",p.style.display="none",h.style.visibility=""},f=this.registerCancellable((0,io.H)(g));this.registerDisposer(this.position.changed.add(f));let m=e=>{let t;if(void 0===r||void 0===n)return;let s=o.getBoundingClientRect();return Math.round(Math.min(1,Math.max(0,"column"===i?(e.clientY-s.top)/s.height:(e.clientX-s.left)/s.width))*(n-r))+r},v=e=>{let t=this.position.coordinateSpace.value,i=t.ids.indexOf(this.dimensionId);if(-1===i)return;let r=m(e);if(void 0===r)return;let{position:n}=this,s=n.value;t.bounds.voxelCenterAtIntegerCoordinates[i]||(r+=.5),s[i]=r,n.value=s};o.addEventListener("pointermove",e=>{s=m(e),f()}),o.addEventListener("pointerleave",()=>{s=void 0,f()}),o.addEventListener("pointerdown",e=>{e.preventDefault(),e.stopPropagation(),!e.ctrlKey&&!e.altKey&&!e.metaKey&&(so(e,e=>{this.wasDisposed||(s=void 0,v(e),f(),this.dragging.value=!0)},()=>{this.dragging.value=!1,f()}),v(e))}),g(),"row"===i&&(o.style.maxWidth="100%",o.style.justifySelf="stretch",new ResizeObserver(g).observe(o))}drawDimensionBounds(e,t,i){let{orientation:r}=this;t.clearRect(0,0,e.width,e.height);let{normalizedBounds:n}=i,s="column"===r?e=>{t.fillRect(0,e,this.tickWidth,1)}:e=>{t.fillRect(e,0,1,this.tickWidth)};for(let{lower:e,upper:i}of(t.fillStyle="#fff",n))s(e),s(i);let a=n.length;t.fillStyle="#ccc";for(let e=0;e<a;++e){let{lower:i,upper:s}=n[e],o=Math.floor(e*this.barWidth/a),l=Math.max(1,this.barWidth/a);"column"===r?t.fillRect(o+this.tickWidth,i,l,s+1-i):t.fillRect(i,o+this.tickWidth,s+1-i,l)}}}let aG="neuroglancer-position",aj=se.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},"alt+wheel":{action:"adjust-velocity-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),aW=[e=>e.nameElement,e=>e.coordinate,e=>e.scaleElement];function aq(e,t){let i=e.coordinateArrays[t];return void 0===i?i:""!==e.units[t]||1!==e.scales[t]?null:i}class aH{coordinateSpace;id;container;nameContainer;nameElement;scaleContainer;scaleElement;coordinate;coordinateLabel;playButton;pauseButton;coordinateLabelWidth;maxPositionWidth;maxPositionWidthSeen;dropdownOwner;modified;draggingPosition;hasFocus;dimensionIndex;constructor(e,t,i,r){this.coordinateSpace=e,this.id=t,this.container=document.createElement("div"),this.nameContainer=document.createElement("span"),this.nameElement=document.createElement("input"),this.scaleContainer=document.createElement("span"),this.scaleElement=document.createElement("input"),this.coordinate=document.createElement("input"),this.coordinateLabel=document.createElement("span"),this.playButton=document.createElement("div"),this.pauseButton=document.createElement("div"),this.coordinateLabelWidth=0,this.maxPositionWidth=0,this.maxPositionWidthSeen=0,this.dropdownOwner=void 0,this.modified=!1,this.draggingPosition=!1,this.hasFocus=!1;let{container:n,scaleElement:s,scaleContainer:a,coordinate:o,nameElement:l,nameContainer:d,coordinateLabel:u,playButton:c,pauseButton:h}=this;n.title="",n.classList.add("neuroglancer-position-dimension");let{allowFocus:p,showPlayback:g}=r;p&&(n.draggable=!0,n.tabIndex=-1),this.dimensionIndex=i,n.appendChild(d),n.appendChild(s),d.appendChild(l),d.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",a.appendChild(s),l.classList.add("neuroglancer-position-dimension-name"),l.disabled=!0,l.spellcheck=!1,l.autocomplete="off",l.required=!0,l.placeholder=" ",a.classList.add("neuroglancer-position-dimension-scale-container"),s.classList.add("neuroglancer-position-dimension-scale"),s.disabled=!0,s.spellcheck=!1,s.autocomplete="off",n.appendChild(a),g&&(c.classList.add("neuroglancer-icon"),h.classList.add("neuroglancer-icon"),c.innerHTML=sJ,h.innerHTML=sH,n.appendChild(c),n.appendChild(h)),n.appendChild(o),o.type="text",o.classList.add("neuroglancer-position-dimension-coordinate"),o.spellcheck=!1,o.autocomplete="off",o.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;let f=aq(e,i);if(null!=f){let e=0;for(let t of f.labels)e=Math.max(e,t.length);this.coordinateLabelWidth=e,u.style.width=`${e+2}ch`,n.appendChild(u)}o.required=!0,o.placeholder=" ",u.classList.add("neuroglancer-position-dimension-coordinate-label"),p&&(d.addEventListener("dblclick",e=>{l.disabled=!1,l.focus(),l.select(),e.stopPropagation()}),a.addEventListener("dblclick",e=>{s.disabled=!1,s.focus(),s.select(),e.stopPropagation()}),o.addEventListener("focus",()=>{o.select()}),n.addEventListener("click",e=>{e.target instanceof HTMLInputElement&&!e.target.disabled||o.focus()}))}}function aJ(e,t){let i=t.length;i>e.maxPositionWidthSeen&&(e.maxPositionWidthSeen=i),sb(e.coordinate,Math.max(Math.min(e.maxPositionWidth,e.maxPositionWidthSeen),i))}function aK(e){let{value:t}=e;sb(e),e.parentElement.dataset.isEmpty=""===t?"true":"false"}class aZ extends eh.gj{position;combiner;element;dimensionContainer;coordinateSpace;velocity;singleDimensionId;getToolBinder;allowFocus;showPlayback;showDropdown;dimensionWidgets;dimensionWidgetList;getDimensionIndex(e){return this.position.coordinateSpace.value.ids.indexOf(e)}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");let i=e.dropdownOwner,r=this.getToolBinder?.();if(void 0!==r){let n=this.getDimensionIndex(e.id),s=aE(i,r,{toolJson:{type:aX,dimension:e.coordinateSpace.names[n]}});t.appendChild(s)}let n=i.registerDisposer(new az(this.position,e.id));t.appendChild(n.element);let s=this.velocity?.dimensionVelocity(i,e.id);if(void 0!==s){let r=document.createElement("div");r.classList.add("neuroglancer-position-dimension-playback");let n=document.createElement("div");n.classList.add("neuroglancer-position-dimension-playback-header"),r.appendChild(n),n.appendChild(i.registerDisposer(new aN(this.velocity.playbackEnabled(e.id),{svg:sK,enableTitle:"Enable playback/velocity",disableTitle:"Disable playback/velocity",backgroundScheme:"dark"})).element),n.appendChild(document.createTextNode("Playback")),t.appendChild(r);let a=i.registerDisposer((0,J.mo)(e=>void 0!==e,[s]));r.appendChild(i.registerDisposer(new aB(a,(e,t,i)=>{if(!e)return;let r=new J.SN(0);r.changed.add(()=>{let e=r.value,t=s.value;void 0!==t&&t.velocity!==e&&(s.value={...t,velocity:e})});let n=sC({text:"\xb1",title:"Negate velocity",onClick:()=>{r.value=-r.value}}),a=i.registerDisposer(new aU(r));a.element.insertBefore(n,a.element.firstChild),a.element.title="Velocity in coordinates per second";let o=document.createElement("span");o.textContent="/s",a.element.appendChild(o),t.appendChild(a.element);let l=new nb.B(nk,nk.STOP),d=()=>{l.value=s.value?.atBoundary??nk.STOP,r.value=s.value?.velocity??0};d(),i.registerDisposer(s.changed.add(d)),l.changed.add(()=>{let e=l.value,t=s.value;void 0!==t&&t.atBoundary!==e&&(s.value={...t,atBoundary:e})});let u=new a_(l).element;t.appendChild(u),u.title="Behavior when lower/upper bound is reached"})).element)}n.dragging.changed.add(()=>{!1===(e.draggingPosition=n.dragging.value)&&this.updateDropdownVisibility(e)})}openCoordinateArrayDropdown(e,t,i){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");let{coordinates:r,labels:n}=i,s=[],a=r.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let i=0;i<a;++i){let a=document.createElement("div");a.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");let o=document.createElement("div");o.classList.add("neuroglancer-dimension-dropdown-coordinate");let l=document.createElement("div");l.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),l.textContent=n[i],o.textContent=r[i].toString(),a.appendChild(o),a.appendChild(l),a.addEventListener("click",()=>{let t=this.getDimensionIndex(e.id);if(-1===t)return;let{position:n}=this,s=n.value;s[t]=r[i]+.5,e.modified=!1,n.value=s}),t.appendChild(a),s.push({entryElement:a,coordinateElement:o,labelElement:l})}}openDropdown(e){if(void 0!==e.dropdownOwner||!this.showDropdown)return;let t=this.getDimensionIndex(e.id);if(-1===t)return;this.closeDropdown();let i=e.dropdownOwner=new eh.gj,r=document.createElement("div");r.draggable=!0,r.addEventListener("dragstart",e=>{e.stopPropagation(),e.preventDefault()}),r.addEventListener("pointerenter",()=>{e.hasFocus=!0}),r.tabIndex=-1,e.container.appendChild(r);let n=aq(e.coordinateSpace,t);null==n?this.openRegularDropdown(e,r):this.openCoordinateArrayDropdown(e,r,n),this.widgetWithOpenDropdown=e,i.registerDisposer(()=>{sy(r),e.dropdownOwner=void 0,e.container.dataset.dropdownVisible=void 0,this.widgetWithOpenDropdown=void 0}),i.registerEventListener(document,"pointerdown",t=>{let{target:i}=t;!(i instanceof Node&&e.container.contains(i))&&this.closeDropdown(e)},{capture:!0})}widgetWithOpenDropdown;closeDropdown(e=this.widgetWithOpenDropdown){if(void 0===e)return;let{dropdownOwner:t}=e;void 0!==t&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();let i=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(null===i)break;if(void 0!==i[1]&&document.execCommand("insertText",void 0,i[1]),void 0!==i[2]){let{dimensionWidgetList:r}=this,n=r.indexOf(e);if(-1===n||n+1===r.length)break;let s=t.substring(i[0].length);e=r[n+1],t=s;continue}break}}dragSource;reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:i}=this.position;i.value=t0(i.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t,i){let r;let n=new aH(e,t,i,{allowFocus:this.allowFocus,showPlayback:this.showPlayback}),s=this.getToolBinder?.();if(void 0!==s){let e=this;r={localBinder:s,get toolJson(){return{type:aX,dimension:e.position.coordinateSpace.value.names[e.getDimensionIndex(t)]}}}}for(let e of(void 0===this.singleDimensionId&&(n.container.addEventListener("dragstart",e=>{this.dragSource=n,e.stopPropagation(),e.dataTransfer.setData("neuroglancer-dimension",""),s6(e,n.container,"drag","Drag to reorder dimensions, to an existing tool palette, or to the left/right/top/bottom of another panel to create a new tool palette"),void 0!==r&&(m=r)}),n.container.addEventListener("dragenter",e=>{let{dragSource:t}=this;if(void 0===t||t===n)return;let{dimensionWidgetList:i}=this,r=i.indexOf(t),s=i.indexOf(n);-1!==r&&-1!==s&&(e.preventDefault(),this.reorderDimensionTo(s,r))}),n.container.addEventListener("dragend",e=>{this.dragSource===n&&(this.dragSource=void 0),s5(e,n.container,"drag"),void 0!==r&&s8(r)})),this.allowFocus?(n.container.addEventListener("focusin",()=>{n.hasFocus=!0,this.updateDropdownVisibility(n)}),n.container.addEventListener("focusout",e=>{let{relatedTarget:t}=e;!(t instanceof Node&&n.container.contains(t))&&(n.hasFocus=!1,this.updateDropdownVisibility(n))}),n.coordinate.addEventListener("paste",e=>{let t=n.coordinate,i=t.value,{clipboardData:r}=e;if(null===r)return;let s=r.getData("text"),{selectionEnd:a,selectionStart:o}=t;if(0!==o||a!==i.length){null==o&&(o=0),null==a&&(a=0);let e=s.match(/[^\-0-9.]/);null!==e&&(s=s.substring(0,e.index)),s.length>0&&document.execCommand("insertText",void 0,s)}else this.pasteString(n,s);e.preventDefault(),e.stopPropagation()}),n.coordinate.addEventListener("input",()=>{n.modified=!0;let e=n.coordinate,t=e.value,{selectionDirection:i,selectionEnd:r,selectionStart:s}=e;null===s&&(s=0),null===r&&(r=s);let a="",o=/[^\-0-9.]/g,l=(a+=t.substring(0,s).replace(o,"")).length,d=(a+=t.substring(s,r).replace(o,"")).length;a+=t.substring(r).replace(o,""),e.value=a,e.selectionStart=l,e.selectionEnd=d,e.selectionDirection=i,aJ(n,a),r===s&&r===t.length&&t.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(n,1)}),n.nameElement.addEventListener("input",()=>{let{nameElement:e}=n;sb(e),this.updateNameValidity()}),n.scaleElement.addEventListener("input",()=>{let{scaleElement:e}=n;aK(e),this.updateScaleValidity(n)}),n.coordinate.addEventListener("blur",e=>{let{relatedTarget:t}=e;!this.dimensionWidgetList.some(e=>e.coordinate===t)&&n.modified&&this.updatePosition()}),n.nameElement.addEventListener("blur",e=>{n.nameElement.disabled=!0;let{relatedTarget:t}=e;!this.dimensionWidgetList.some(e=>e.nameElement===t)&&(this.updateNames()||this.forceUpdateDimensions())}),n.scaleElement.addEventListener("blur",e=>{n.scaleElement.disabled=!0;let{relatedTarget:t}=e;!this.dimensionWidgetList.some(e=>e.scaleElement===t)&&(this.updateScales()||this.forceUpdateDimensions())})):n.coordinate.disabled=!0,ss(n.container,"adjust-via-wheel",e=>{let{deltaY:t}=e.detail;0!==t&&this.adjustDimensionPosition(n.id,Math.sign(t))}),ss(n.container,"adjust-velocity-via-wheel",e=>{let t=e.detail;this.adjustDimensionVelocity(n,sl(t))}),ss(n.container,"adjust-up",()=>{this.adjustDimensionPosition(n.id,-1)}),ss(n.container,"adjust-down",()=>{this.adjustDimensionPosition(n.id,1)}),aW)){let t=e(n);ss(t,"maybe-tab-forward",t=>{this.handleLeftRightMovement(t,n,1,e)}),ss(t,"maybe-tab-backward",t=>{this.handleLeftRightMovement(t,n,-1,e)}),ss(t,"tab-forward",()=>{this.selectAdjacentField(n,1,e)}),ss(t,"tab-backward",()=>{this.selectAdjacentField(n,-1,e)})}if(ss(n.coordinate,"commit",()=>{this.updatePosition()}),ss(n.nameElement,"commit",()=>{this.updateNames()}),ss(n.scaleElement,"commit",()=>{this.updateScales()}),ss(n.coordinate,"delete-backward",e=>{e.stopPropagation();let{coordinate:t}=n;t.selectionStart===t.selectionEnd&&0===t.selectionStart&&(e.preventDefault(),this.selectAdjacentCoordinate(n,-1))}),this.showPlayback){let e=e=>{this.velocity?.togglePlayback(n.id,e)};n.playButton.addEventListener("click",()=>e(!1)),n.pauseButton.addEventListener("click",()=>e(!0))}return n}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e.valid||void 0!==this.singleDimensionId||(e=tC),this.coordinateSpace=e;let{dimensionWidgets:t,dimensionWidgetList:i}=this;i.length=0;let{names:r,ids:n,scales:s,units:a,bounds:{lowerBounds:o,upperBounds:l}}=e,d=(n,d)=>{let u=o[d],c=l[d],h=Math.max(Number.isFinite(u)?Math.floor(u).toString().length:0,Number.isFinite(c)?Math.ceil(c).toString().length:0),p=t.get(n);void 0===p?(p=this.newDimension(e,n,d),t.set(n,p),p.maxPositionWidthSeen=h):(p.coordinateSpace=e,p.dimensionIndex=d),p.maxPositionWidth=h;let g=r[d];p.nameElement.value=g,p.nameElement.dataset.isValid=void 0,sb(p.nameElement);let f=aq(e,d);void 0===f?p.container.dataset.coordinateArray="none":null===f?p.container.dataset.coordinateArray="invalid":p.container.dataset.coordinateArray="valid",p.scaleContainer.title="Drag to reorder, double click to change scale",null===f&&(p.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");let{scale:m,prefix:v,unit:y}=ts(s[d],a[d]),b=`${m}${v}${y}`;return p.scaleElement.value=b,p.scaleElement.dataset.isValid=void 0,aK(p.scaleElement),i.push(p),p.container},{singleDimensionId:u}=this;if(void 0!==u){let e=this.getDimensionIndex(u);-1===e?sS(this.dimensionContainer,[]):sS(this.dimensionContainer,[d(u,e)])}else sS(this.dimensionContainer,n.map(d));for(let[i,r]of t)r.coordinateSpace!==e&&(this.closeDropdown(r),t.delete(i))}updateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,i){let{dimensionWidgetList:r}=this,n=r.indexOf(e);if(-1!==n)for(;;){if((n+=t)<0||n>=r.length)return!1;let e=i(r[n]);if("none"!==e.style.display)return e.disabled=!1,e.focus(),e.selectionStart=0,e.selectionEnd=e.value.length,e.selectionDirection=1===t?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,e=>e.coordinate)}handleLeftRightMovement(e,t,i,r){e.stopPropagation();let n=r(t);n.selectionStart===n.selectionEnd&&n.selectionStart===(1===i?n.value.length:0)&&this.selectAdjacentField(t,i,r)&&e.preventDefault()}updateNameValidity(){let{dimensionWidgetList:e}=this,t=Array.from(this.position.coordinateSpace.value.names);for(let i of e)t[i.dimensionIndex]=i.nameElement.value;let i=this.combiner.getRenameValidity(t);for(let t of e)t.nameElement.dataset.isValid=!1===i[t.dimensionIndex]?"false":"true"}updateScaleValidity(e){let t=void 0!==to(e.scaleElement.value);e.scaleElement.dataset.isValid=t.toString()}constructor(e,t,{copyButton:i=!0,velocity:r,singleDimensionId:n,getToolBinder:s,allowFocus:a=!0,showPlayback:o=!0,showDropdown:l=!0}={}){super(),this.position=e,this.combiner=t,this.element=document.createElement("div"),this.dimensionContainer=document.createElement("div"),this.coordinateSpace=void 0,this.dimensionWidgets=new Map,this.dimensionWidgetList=[],this.dragSource=void 0;let{element:d,dimensionContainer:u}=this;if(this.velocity=r,this.singleDimensionId=n,this.getToolBinder=s,this.allowFocus=a,this.showPlayback=o,this.showDropdown=l,this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable((0,io.H)(()=>this.updateDimensions())))),d.className="neuroglancer-position-widget",u.style.display="contents",d.appendChild(u),i){let t=aO({title:"Copy position to clipboard",onClick:()=>{let e=aI(this.getPositionText());s1.showTemporaryMessage(e?"Position copied to clipboard":"Failed to copy position to clipboard")}});t.addEventListener("dragstart",t=>{t.dataTransfer.setData(aG,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),t.dataTransfer.setData("text",this.getPositionText()),t.stopPropagation()}),t.draggable=!0,d.appendChild(t)}let c=this.registerCancellable((0,io.H)(()=>this.updateView()));this.registerDisposer(e.changed.add(c)),void 0!==r&&this.registerDisposer(r.changed.add(c));let h=e=>{let t=e.target;return!!(t instanceof Element&&t.matches(".neuroglancer-position-dimension-playback *"))};if(a){let e=this.registerDisposer(new aM(d,aj));e.allShortcutsAreGlobal=!0,e.shouldIgnore=h}this.registerDisposer(new sa(d,aj)).shouldIgnore=h,this.registerDisposer(ss(d,"cancel",e=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();let{target:t}=e;t instanceof HTMLElement&&t.blur()})),this.updateView()}adjustDimensionPosition(e,t){let i=this.getDimensionIndex(e);if(-1===i)return;this.updatePosition();let{position:r}=this;if(!r.valid)return;let{bounds:n}=r.coordinateSpace.value,s=Float32Array.from(r.value);s[i]=tL(n,i,s[i]+t),this.position.value=s,this.updateView()}adjustDimensionVelocity(e,t){let{velocity:i}=this;void 0!==i&&i.multiplyVelocity(e.id,t)}updatePosition(){if(!this.allowFocus)return;let{position:e}=this,{value:t}=e,i=e.coordinateSpace.value;if(void 0===t)return;let r=!1;for(let e of this.dimensionWidgetList){let{dimensionIndex:n}=e;if(!e.modified)continue;e.modified=!1,r=!0;let s=e.coordinate.value,a=Number(s);Number.isFinite(a)&&(!Number.isInteger(a)||s.includes(".")||void 0===i||i.bounds.voxelCenterAtIntegerCoordinates[n]||(a+=.5),t[n]=a)}r&&(e.value=t)}updateNames(){if(!this.allowFocus)return;let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,i=t.value,r=Array.from(i.names);for(let t of e)r[t.dimensionIndex]=t.nameElement.value;if(this.combiner.getRenameValidity(r).includes(!1))return!1;let n=i.names;if((0,H.cO)(n,r))return!1;let s=i.timestamps.map((e,t)=>n[t]===r[t]?e:Date.now()),a={...i,names:r,timestamps:s};return t.value=a,!0}updateScales(){if(!this.allowFocus)return;let{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,i=t.value,{scales:r,units:n}=i,s=Float64Array.from(r),a=Array.from(n);for(let{dimensionIndex:t,scaleElement:i}of e){let e=to(i.value);if(void 0===e)return!1;s[t]=e.scale,a[t]=e.unit}if((0,H.cO)(r,s)&&(0,H.cO)(n,a))return!1;let o=i.timestamps.map((e,t)=>s[t]===r[t]&&a[t]===n[t]?e:Date.now()),l=tw({valid:i.valid,rank:i.rank,scales:s,units:a,timestamps:o,ids:i.ids,names:i.names,boundingBoxes:i.boundingBoxes,coordinateArrays:i.coordinateArrays});return t.value=l,!0}getPositionText(){let{position:e}=this;return e.valid?e.value.map(e=>Math.floor(e)).join(", "):""}updateView(){this.updateDimensions();let{position:{value:e}}=this;if(void 0===e)return;let t=this.coordinateSpace,{velocity:i}=this;for(let r of this.dimensionWidgetList){let{dimensionIndex:n}=r,s=r.coordinate,a=Math.floor(e[n]),o=a.toString();aJ(r,o),s.value=o;let l=aq(t,n),d="";if(null!=l){let{coordinates:e}=l,t=(0,H.ry)(e,a,(e,t)=>e-t);t!==e.length&&(d=l.labels[t])}if(r.coordinateLabel.textContent=d,this.showPlayback){let e=i?.value?.[n];if(void 0!==e){let t=e.paused;r.playButton.style.display=t?"":"none",r.pauseButton.style.display=t?"none":""}else r.playButton.style.display="none",r.pauseButton.style.display="none"}}}disposed(){this.closeDropdown(),sy(this.element),super.disposed()}}class aY extends eh.gj{element;mouseState;coordinateSpace;tempPosition;constructor(e,t,i){super(),this.element=e,this.mouseState=t,this.coordinateSpace=i,this.tempPosition=Z.R3.create(),e.className="neuroglancer-mouse-position-widget";let r=this.registerCancellable((0,io.H)(()=>this.updateView()));this.registerDisposer(t.changed.add(r)),this.registerDisposer(i.changed.add(r))}updateView(){let e="",{mouseState:t,coordinateSpace:{value:i}}=this;if(t.active&&void 0!==i){let r=t.position,{rank:n,names:s}=i;for(let t=0;t<n;++t)0!==t&&(e+="  "),e+=`${s[t]} ${Math.floor(r[t])}`}this.element.textContent=e}disposed(){sy(this.element),super.disposed()}}let aX="dimension",aQ=se.fromObject({"at:shift?+wheel":{action:"adjust-position-via-wheel"},"at:shift?+alt+wheel":{action:"adjust-velocity-via-wheel"},"shift?+alt?+space":{action:"toggle-playback"},"at:shift?+alt?+mousedown0":{action:"toggle-playback"}});class a0 extends ad{viewer;dimensionId;get position(){return this.viewer.position}get velocity(){return this.viewer.velocity}get coordinateSpace(){return this.viewer.coordinateSpaceCombiner.combined}adjustDimensionHandler(e,t){e.stopPropagation();let{deltaY:i}=e.detail;0!==i&&t.adjustDimensionPosition(this.dimensionId,Math.sign(i))}adjustVelocityHandler(e,t){e.stopPropagation();let i=sl(e.detail);t.velocity.multiplyVelocity(this.dimensionId,i)}activate(e){let{viewer:t}=this,{content:i}=aT(e),{positionWidget:r}=this.makeTool(e,i,!1);e.bindInputEventMap(aQ),e.bindAction("adjust-position-via-wheel",e=>this.adjustDimensionHandler(e,r)),e.bindAction("adjust-velocity-via-wheel",e=>this.adjustVelocityHandler(e,t)),e.bindAction("toggle-playback",e=>{e.stopPropagation(),t.velocity.togglePlayback(this.dimensionId)})}renderInPalette(e){let t=document.createElement("div");return this.makeTool(e,t,!0),t}makeTool(e,t,i){let{viewer:r}=this;i?t.classList.add("neuroglancer-position-tool-in-palette"):t.classList.add("neuroglancer-position-tool");let n=new aZ(r.position,r.coordinateSpaceCombiner,{velocity:r.velocity,singleDimensionId:this.dimensionId,copyButton:!1,allowFocus:i,showPlayback:!1,showDropdown:!1});n.element.style.userSelect="none",t.appendChild(e.registerDisposer(n).element);let s=e.registerDisposer(new az(r.position,this.dimensionId,"row"));s.element.style.flex="1",t.appendChild(s.element);let a=this.velocity.dimensionVelocity(e,this.dimensionId),o=e.registerDisposer((0,J.mo)(e=>void 0!==e,[a]));return t.appendChild(e.registerDisposer(new aB(o,(e,t,i)=>{if(!e)return;t.classList.add("neuroglancer-position-dimension-playback");let n=document.createElement("div"),s=document.createElement("div");n.classList.add("neuroglancer-icon"),s.classList.add("neuroglancer-icon"),n.innerHTML=sJ,s.innerHTML=sH,t.appendChild(n),t.appendChild(s);let o=()=>r.velocity.togglePlayback(this.dimensionId);n.addEventListener("click",o),s.addEventListener("click",o);let l=()=>{let e=a.value?.paused;n.style.display=e?"":"none",s.style.display=e?"none":""};i.registerDisposer(a.changed.add(l)),l();let d=new J.SN(0);d.changed.add(()=>{let e=d.value,t=a.value;void 0!==t&&t.velocity!==e&&(a.value={...t,velocity:e})});let u=sC({text:"\xb1",title:"Negate velocity",onClick:()=>{d.value=-d.value}}),c=i.registerDisposer(new aU(d));c.inputElement.disabled=!0,c.element.insertBefore(u,c.element.firstChild),c.element.title="Velocity in coordinates per second";let h=document.createElement("span");h.textContent="/s",c.element.appendChild(h),t.appendChild(c.element);let p=new nb.B(nk,nk.STOP),g=()=>{p.value=a.value?.atBoundary??nk.STOP,d.value=a.value?.velocity??0};g(),i.registerDisposer(a.changed.add(g)),p.changed.add(()=>{let e=p.value,t=a.value;void 0!==t&&t.atBoundary!==e&&(a.value={...t,atBoundary:e})});let f=new a_(p).element;t.appendChild(f),f.title="Behavior when lower/upper bound is reached"})).element),t.appendChild(e.registerDisposer(new aN(r.velocity.playbackEnabled(this.dimensionId),{svg:sK,enableTitle:"Enable playback/velocity",disableTitle:"Disable playback/velocity",backgroundScheme:"dark"})).element),this.registerDisposer(new sa(s.element,aj)),ss(s.element,"adjust-via-wheel",e=>this.adjustDimensionHandler(e,n)),ss(s.element,"adjust-velocity-via-wheel",e=>this.adjustVelocityHandler(e,r)),{positionWidget:n}}savedDimensionName;get dimensionName(){let{dimensionId:e}=this,t=this.coordinateSpace.value,i=t.ids.indexOf(e);if(-1!==i)return t.names[i]}get description(){return`dim ${this.dimensionName}`}constructor(e,t){super(e.toolBinder),this.viewer=e,this.dimensionId=t,this.savedDimensionName="",this.savedDimensionName=this.dimensionName,this.registerDisposer(this.coordinateSpace.changed.add(()=>{let e=this.dimensionName;if(void 0===e){this.unbind();return}e!==this.savedDimensionName&&(this.savedDimensionName=e,this.changed.dispatch())}))}toJSON(){return{type:aX,dimension:this.dimensionName}}}function a1(e,t){let i=(0,ef.uq)(t,"dimension",ef.ZE),r=e.coordinateSpaceCombiner.combined.value,n=r.names.indexOf(i);if(-1===n)throw Error(`Invalid dimension name: ${JSON.stringify(i)}`);return new a0(e,r.ids[n])}function a2(e,t){return void 0!==t&&e.changed.addOnce(t),e.value.names.map(e=>({type:aX,dimension:e}))}let a3=Symbol("transferFunctionSamplerTexture"),a4=Symbol("histogramSamplerTexture"),a6={[el.UINT8]:256,[el.INT8]:256,[el.UINT16]:8192,[el.INT16]:8192,[el.UINT32]:8192,[el.INT32]:8192,[el.UINT64]:8192,[el.FLOAT32]:8192};class a5{inputValue;outputColor;constructor(e,t=Z.Dv){this.inputValue=e,this.outputColor=t}normalizedInput(e){return eS(e,this.inputValue)}transferFunctionIndex(e,t){return Math.floor(this.normalizedInput(e)*(t-1))}interpolateColor(e,t){let i=Z.vh.create();for(let r=0;r<4;++r)i[r]=ew([this.outputColor[r],e.outputColor[r]],el.UINT8,t);return i}static copyFrom(e){return new a5(e.inputValue,Z.vh.clone(e.outputColor))}}class a8{controlPoints;dataType;autoComputeRange;range;constructor(e=[],t,i=!0){this.controlPoints=e,this.dataType=t,this.autoComputeRange=i,this.controlPoints=e,this.range=eb[t],this.sortAndComputeRange()}get length(){return this.controlPoints.length}setDefaultControlPoints(e,t){this.clear(),this.addPoint(new a5(e[0],Z.Dv)),this.addPoint(new a5(e[1],t))}clear(){this.controlPoints=[]}addPoint(e){let{inputValue:t,outputColor:i}=e,r=this.controlPoints.findIndex(e=>e.inputValue===t);-1!==r&&this.updatePointColor(r,i);let n=new a5(t,i);this.controlPoints.push(n),this.sortAndComputeRange()}removePoint(e){this.controlPoints.splice(e,1),this.computeRange()}updatePoint(e,t){this.controlPoints[e]=t;let i=t.inputValue,r=t.outputColor;this.sortAndComputeRange();for(let e=0;e<this.controlPoints.length;++e)if(this.controlPoints[e].inputValue===i&&(0,H.cO)(this.controlPoints[e].outputColor,r))return e;return -1}updatePointColor(e,t){let i=Z.vh.create();if(3===t.length){let r=this.controlPoints[e].outputColor[3];i=Z.vh.fromValues(t[0],t[1],t[2],r)}else i=Z.vh.clone(t);this.controlPoints[e].outputColor=i}findNearestControlPointIndex(e){let t=new a5(e).normalizedInput(this.range);return this.findNearestControlPointIndexByNormalizedInput(t)}findNearestControlPointIndexByNormalizedInput(e){return(0,H.bm)(this.controlPoints.map(e=>e.normalizedInput(this.range)),e,(e,t)=>e-t)}sortAndComputeRange(){this.controlPoints.sort((e,t)=>e.normalizedInput(this.range)-t.normalizedInput(this.range)),this.computeRange()}computeRange(){if(this.autoComputeRange){if(0==this.controlPoints.length)this.range=eb[this.dataType];else if(1===this.controlPoints.length){let e=eb[this.dataType][1];this.dataType===el.FLOAT32&&e<=this.controlPoints[0].inputValue&&(e=this.controlPoints[0].inputValue+1),this.range=[this.controlPoints[0].inputValue,e]}else this.range=[this.controlPoints[0].inputValue,this.controlPoints[this.controlPoints.length-1].inputValue]}this.range[0]===this.range[1]&&(this.range=eb[this.dataType])}copy(){let e=new a8([],this.dataType,this.autoComputeRange);return e.range=this.range,e.controlPoints=this.controlPoints.map(e=>a5.copyFrom(e)),e}}class a9{lookupTableSize;outputValues;constructor(e){this.lookupTableSize=e,this.outputValues=new Uint8Array(4*e).fill(0)}resize(e){this.lookupTableSize=e,this.outputValues=new Uint8Array(4*e).fill(0)}updateFromControlPoints(e,t){let i=t||e.range,{controlPoints:r}=e,n=this.outputValues,s=this.lookupTableSize;function a(e,t){n[e]=t[0],n[e+1]=t[1],n[e+2]=t[2],n[e+3]=t[3]}function o(e){return e.transferFunctionIndex(i,s)}if(0===r.length){n.fill(0);return}let l=o(r[0]);if(l>0){let e=Z.vh.fromValues(0,0,0,0);for(let t=0;t<l;++t)a(4*t,e)}let d=0;for(let e=l;e<s;++e){let t=r[d],i=4*e;if(d===r.length-1)a(i,t.outputColor);else{let n=r[d+1],s=o(t),l=o(n),u=(e-s)/(l-s);a(i,t.interpolateColor(n,u)),e>=l&&d++}}}static equal(e,t){return(0,H.cO)(e.outputValues,t.outputValues)}copy(){let e=new a9(this.lookupTableSize);return e.outputValues.set(this.outputValues),e}}class a7 extends eh.gj{dataType;trackable;lookupTable;autoPointUpdateEnabled;constructor(e,t,i=a6[e]){super(),this.dataType=e,this.trackable=t,this.autoPointUpdateEnabled=!0,this.lookupTable=new a9(i),this.updateLookupTable()}get sortedControlPoints(){return this.trackable.value.sortedControlPoints}get range(){return this.sortedControlPoints.range}get size(){return this.lookupTable.lookupTableSize}updateLookupTable(e){this.lookupTable.updateFromControlPoints(this.sortedControlPoints,e)}addPoint(e){this.sortedControlPoints.addPoint(e)}generateDefaultControlPoints(e=null,t){if(!this.autoPointUpdateEnabled)return;t=void 0!==t?t:this.trackable.value.window;let i=null!==e?e:[ew(t,this.dataType,.3),ew(t,this.dataType,.7)];i[0]===i[1]&&(i[0]=t[0],i[1]=t[1]);let r=this.trackable.value.defaultColor,n=Z.vh.fromValues(Math.round(255*r[0]),Math.round(255*r[1]),Math.round(255*r[2]),255);this.sortedControlPoints.setDefaultControlPoints(i,n)}generateDefaultWindow(e=null){let t=n2(null!==e?e:this.sortedControlPoints.range,this.dataType);this.trackable.value={...this.trackable.value,window:t}}updatePoint(e,t){return this.sortedControlPoints.updatePoint(e,t)}removePoint(e){this.sortedControlPoints.removePoint(e)}updatePointColor(e,t){this.sortedControlPoints.updatePointColor(e,t)}findNearestControlPointIndex(e,t){let i=ew(t,this.dataType,e);return this.sortedControlPoints.findNearestControlPointIndex(i)}}class oe extends eh.gj{gl;texture;width;height;priorOptions;constructor(e){super(),this.gl=e,this.texture=null,this.height=1,this.priorOptions=void 0}updateAndActivate(e){let{gl:t}=this;if(null===t)return;let{texture:i}=this;function r(e,t){if(void 0===t)throw Error("Texture unit must be defined for transfer function texture");e.activeTexture(WebGL2RenderingContext.TEXTURE0+t),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i)}if(null!==i&&this.optionsEqual(e))return r(t,e.textureUnit),this.width*this.height;null===i&&(i=this.texture=t.createTexture()),r(t,e.textureUnit),rS(t);let n=this.createLookupTable(e);return t.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA,this.width,this.height,0,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,n.outputValues),this.setOptions(e),this.width*this.height}setTextureWidthAndHeightFromSize(e){this.width=e}disposed(){this.gl?.deleteTexture(this.texture),this.texture=null,this.priorOptions=void 0,super.disposed()}}class ot extends oe{gl;texture;constructor(e){super(e),this.gl=e,this.texture=null}optionsEqual(e){let t=this.priorOptions;if(void 0===t)return!1;let i=a9.equal(t.lookupTable,e.lookupTable),r=t.textureUnit===e.textureUnit;return i&&r}createLookupTable(e){return this.setTextureWidthAndHeightFromSize(e.lookupTable.lookupTableSize),e.lookupTable}setOptions(e){this.priorOptions={...e,lookupTable:e.lookupTable.copy()}}}class oi extends oe{gl;constructor(e){super(e),this.gl=e}optionsEqual(e){let t=this.priorOptions;if(void 0===t)return!1;let i=(0,H.eK)(t.sortedControlPoints.controlPoints,e.sortedControlPoints.controlPoints,(e,t)=>e.inputValue===t.inputValue&&(0,H.cO)(e.outputColor,t.outputColor)),r=t.textureUnit===e.textureUnit,n=t.dataType===e.dataType;return i&&r&&n}setOptions(e){this.priorOptions={...e,sortedControlPoints:e.sortedControlPoints.copy()}}createLookupTable(e){let t=this.ensureTextureSize(e.lookupTableSize);if(void 0===t)return new a9(0);this.setTextureWidthAndHeightFromSize(t);let i=new a9(t),r=e.sortedControlPoints;return i.updateFromControlPoints(r),i}ensureTextureSize(e){let t=this.gl;if(null!==t)return Math.min(e,t.getParameter(t.MAX_TEXTURE_SIZE))}}function or(){let e=new Uint8Array(6*sN);for(let t=0;t<sN;++t)for(let i=0;i<6;++i)e[6*t+i]=t;return e}function on(){return function(e,t=-1,i=1,r=1,n=-1){let s=new Float32Array(6144),a=(i-t)/512,o=t;for(let t=0;t<e;++t){let e=12*t;s[e]=o,s[e+1]=r,s[e+2]=o+a,s[e+3]=r,s[e+4]=o+a,s[e+5]=n,s[e+6]=o,s[e+7]=r,s[e+8]=o+a,s[e+9]=n,s[e+10]=o,s[e+11]=n,o+=a}return s}(512)}class os extends iy{parent;texture;textureVertexBuffer;controlPointsVertexBuffer;controlPointsPositionArray;controlPointsColorBuffer;controlPointsColorArray;linePositionBuffer;linePositionArray;get drawOrder(){return 1}transferFunction;controller;dataValuesBuffer;constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controlPointsPositionArray=new Float32Array,this.controlPointsColorArray=new Float32Array,this.linePositionArray=new Float32Array,this.histogramLineShader=this.registerDisposer(sP(this.gl,a4)),this.transferFunctionLineShader=this.registerDisposer((()=>{let e=new ru(this.gl);return sc(e),e.addAttribute("vec4","aLineStartEnd"),e.addOutputBuffer("vec4","out_color",0),e.addVarying("float","vColor"),e.setVertexMain(`
vec4 start = vec4(aLineStartEnd[0], aLineStartEnd[1], 0.0, 1.0);
vec4 end = vec4(aLineStartEnd[2], aLineStartEnd[3], 0.0, 1.0);
emitLine(start, end, 1.0);
`),e.setFragmentMain(`
out_color = vec4(0.35, 0.35, 0.35, getLineAlpha());
`),e.build()})()),this.transferFunctionShader=this.registerDisposer((()=>{let e=new ru(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addVarying("vec2","vTexCoord"),e.addOutputBuffer("vec4","out_color",0),e.addTextureSampler("sampler2D","uSampler",a3),e.addUniform("float","uTransferFunctionEnd"),e.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vTexCoord = (aVertexPosition + 1.0) / 2.0;
`),e.setFragmentMain(`
ivec2 texel = ivec2(floor(vTexCoord.x * uTransferFunctionEnd), 0);
out_color = texelFetch(uSampler, texel, 0);
`),e.build()})()),this.controlPointsShader=this.registerDisposer((()=>{let e=new ru(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addAttribute("vec3","aVertexColor"),e.addVarying("vec3","vColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
gl_PointSize = 14.0;
vColor = aVertexColor;
`),e.setFragmentMain(`
float vColorSum = vColor.r + vColor.g + vColor.b;
vec3 bordercolor = vec3(0.0, 0.0, 0.0);
if (vColorSum < 0.4) {
  bordercolor = vec3(1.0, 1.0, 1.0);
}
float dist = distance(gl_PointCoord, vec2(0.5, 0.5));
float alpha = smoothstep(0.25, 0.4, dist);
vec4 tempColor = vec4(mix(vColor, bordercolor, alpha), 1.0);
alpha = 1.0 - smoothstep(0.4, 0.5, dist);
out_color = tempColor * alpha;
`),e.build()})());let{element:t,gl:i}=this;this.transferFunction=this.registerDisposer(new a7(e.dataType,e.trackable,512)),this.controller=this.registerDisposer(new oo(t,e.dataType,this.transferFunction,()=>e.trackable.value,t=>{e.trackable.value=t})),this.dataValuesBuffer=this.registerDisposer(rv(i,WebGL2RenderingContext.ARRAY_BUFFER,or)).value,t.classList.add("neuroglancer-transfer-function-panel"),this.texture=this.registerDisposer(new ot(i)),this.textureVertexBuffer=this.registerDisposer(rv(i,WebGL2RenderingContext.ARRAY_BUFFER,on)).value,this.controlPointsVertexBuffer=this.registerDisposer(new rm(i,WebGL2RenderingContext.ARRAY_BUFFER)),this.controlPointsColorBuffer=this.registerDisposer(new rm(i,WebGL2RenderingContext.ARRAY_BUFFER)),this.linePositionBuffer=this.registerDisposer(new rm(i,WebGL2RenderingContext.ARRAY_BUFFER))}updateTransferFunctionPointsAndLines(){let e=this.parent.trackable.value.window;function t(e,t,i){for(let r=0;r<6;++r)e[t++]=i[0],e[t++]=i[1],e[t++]=i[2],e[t++]=i[3];return t}function i(e){return e>=-1&&e<=1}let{transferFunction:r}=this,{controlPoints:n}=r.trackable.value.sortedControlPoints,s=Math.max(n.length-1,0),a=new Float32Array(3*n.length),o=new Float32Array(2*n.length),l=0,d=null,u=null,c=n.map(t=>({input:2*eS(e,t.inputValue)-1,output:t.outputColor[3]/255*2-1}));if(n.length>0){let{firstPointIndexInWindow:e,lastPointIndexInWindow:t,pointClosestToLeftEdge:r,pointClosestToRightEdge:a}=function(){let e=null,t=null,r=null,s=null;for(let a=0;a<n.length;++a){let n=c[a];if(i(n.input)&&(e=e??a,t=a),n.input<-1)r=n;else if(n.input>1){s=n;break}}return{firstPointIndexInWindow:e,lastPointIndexInWindow:t,pointClosestToLeftEdge:r,pointClosestToRightEdge:s}}();if(null===e){let e=c[n.length-1].input<-1,t=c[0].input>1;e?function(){let e=n.length-1;s+=1;let t=c[e].output;d=Z.vh.fromValues(-1,t,1,t)}():!t&&n.length>1&&function(e,t){if(s+=1,null===e||null===t)throw Error("Could not find points closest to the left and right edges");let i=eS([e.input,t.input],-1),r=eS([e.input,t.input],1),n=ew([e.output,t.output],el.FLOAT32,i),a=ew([e.output,t.output],el.FLOAT32,r);d=Z.vh.fromValues(-1,n,1,a)}(r,a)}else{let i=c[e];i.input>-1&&(e>0?function(e,t){let i=c[e-1],r=eS([i.input,t.input],-1),n=ew([i.output,t.output],el.FLOAT32,r);d=Z.vh.fromValues(-1,n,t.input,t.output)}(e,i):d=Z.vh.fromValues(i.input,-1,i.input,i.output),s+=1);let r=c[t];r.input<1&&(t<n.length-1?function(e,t){let i=c[e+1],r=eS([t.input,i.input],1),n=ew([t.output,i.output],el.FLOAT32,r);u=Z.vh.fromValues(t.input,t.output,1,n)}(t,r):u=Z.vh.fromValues(r.input,r.output,1,r.output),s+=1)}}let h=[];for(let e=0;e<n.length;++e){let t=3*e,r=2*e,l=c[e].input,d=c[e].output,{outputColor:u}=n[e];if(a[t]=u[0]/255,a[t+1]=u[1]/255,a[t+2]=u[2]/255,o[r]=l,o[r+1]=d,e===n.length-1)break;if(!(i(l)&&i(d)))continue;s+=1;let p=Z.vh.fromValues(l,d,c[e+1].input,c[e+1].output);h.push(p)}let p=new Float32Array(24*s);for(let e of(null!==d&&(l=t(p,l,d)),h))l=t(p,l,e);null!==u&&t(p,l,u),this.controlPointsColorArray=a,this.controlPointsPositionArray=o,this.linePositionArray=p,this.controlPointsVertexBuffer.setData(this.controlPointsPositionArray),this.controlPointsColorBuffer.setData(this.controlPointsColorArray),this.linePositionBuffer.setData(this.linePositionArray)}histogramLineShader;transferFunctionLineShader;transferFunctionShader;controlPointsShader;drawIndirect(){let{transferFunctionLineShader:e,gl:t,transferFunctionShader:i,controlPointsShader:r,histogramLineShader:n}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{i.bind();let e=i.attribute("aVertexPosition");t.uniform1f(i.uniform("uTransferFunctionEnd"),511),this.textureVertexBuffer.bindToVertexAttrib(e,2,WebGL2RenderingContext.FLOAT);let r=i.textureUnit(a3);this.texture.updateAndActivate({lookupTable:this.transferFunction.lookupTable,textureUnit:r}),su(this.gl,512,1),t.disableVertexAttribArray(e),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}if(this.parent.histogramSpecifications.producerVisibility.visible){let{renderViewport:e}=this;n.bind(),sh(n,{width:e.logicalWidth,height:e.logicalHeight},1);let i=n.textureUnit(a4);t.uniform1f(n.uniform("uBoundsFraction"),eM(this.parent.dataType,this.parent.trackable.value.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+i),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),rS(t);let r=n.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(r,1,WebGL2RenderingContext.UNSIGNED_BYTE),su(t,sN,1),t.disableVertexAttribArray(r),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}if(this.controlPointsPositionArray.length>0){let{renderViewport:i}=this;e.bind();let n=e.attribute("aLineStartEnd");this.linePositionBuffer.bindToVertexAttrib(n,4,WebGL2RenderingContext.FLOAT),sh(e,{width:i.logicalWidth,height:i.logicalHeight},1),su(t,this.linePositionArray.length/24,1),t.disableVertexAttribArray(n),r.bind();let s=r.attribute("aVertexPosition");this.controlPointsVertexBuffer.bindToVertexAttrib(s,2,WebGL2RenderingContext.FLOAT);let a=r.attribute("aVertexColor");this.controlPointsColorBuffer.bindToVertexAttrib(a,3,WebGL2RenderingContext.FLOAT),t.drawArrays(t.POINTS,0,this.controlPointsPositionArray.length/2),t.disableVertexAttribArray(s),t.disableVertexAttribArray(a)}t.disable(WebGL2RenderingContext.BLEND)}update(){this.transferFunction.updateLookupTable(this.parent.trackable.value.window),this.updateTransferFunctionPointsAndLines()}isReady(){return!0}}let oa=se.fromObject({"shift?+mousedown0":{action:"add-or-drag-point"},"shift+dblclick0":{action:"remove-point"},"shift?+mousedown2":{action:"change-point-color"},"shift?+wheel":{action:"zoom-via-wheel"}});class oo extends eh.gj{element;dataType;transferFunction;getModel;setModel;currentGrabbedControlPointIndex;constructor(e,t,i,r,n){super(),this.element=e,this.dataType=t,this.transferFunction=i,this.getModel=r,this.setModel=n,this.currentGrabbedControlPointIndex=-1,e.title=oa.describe(),this.registerDisposer(new sa(e,oa)),ss(e,"add-or-drag-point",e=>{let t=e.detail;this.updateValue(this.addControlPoint(t)),so(t,e=>{this.updateValue(this.moveControlPoint(e))})}),ss(e,"remove-point",e=>{let t=e.detail,i=this.findControlPointIfNearCursor(t);-1!==i&&(this.transferFunction.removePoint(i),this.disableAutoPointUpdate(),this.updateValue({...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}))}),ss(e,"change-point-color",e=>{let t=e.detail,i=this.findControlPointIfNearCursor(t);if(-1!==i){let e=this.transferFunction.trackable.value.defaultColor,t=this.convertPanelSpaceColorToAbsoluteValue(e);this.transferFunction.updatePointColor(i,t),this.disableAutoPointUpdate(),this.updateValue({...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints})}}),ss(e,"zoom-via-wheel",e=>{let t=e.detail,i=sl(t),r=this.getTargetFraction(t),{dataType:n}=this,s=this.getModel(),a=ew(s.window,n,r*(1-i)),o=ew(s.window,n,(1-r)*i+r);if(a!==o){let e=[a,o];this.transferFunction.generateDefaultControlPoints(null,e),this.updateValue({...s,sortedControlPoints:this.transferFunction.sortedControlPoints,window:e})}})}disableAutoPointUpdate(){this.transferFunction.autoPointUpdateEnabled=!1}getTargetFraction(e){let t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}updateValue(e){void 0!==e&&this.setModel(e)}convertPanelSpaceInputToAbsoluteValue(e){return ew(this.transferFunction.trackable.value.window,this.dataType,e)}convertPanelSpaceColorToAbsoluteValue(e){return 3===e.length?Z.R3.fromValues(Math.round(255*e[0]),Math.round(255*e[1]),Math.round(255*e[2])):Z.vh.fromValues(Math.round(255*e[0]),Math.round(255*e[1]),Math.round(255*e[2]),Math.round(255*e[3]))}addControlPoint(e){let t=this.transferFunction.trackable.value.defaultColor,i=this.findControlPointIfNearCursor(e);if(-1!==i){this.currentGrabbedControlPointIndex=i;return}let r=this.getControlPointPosition(e);if(void 0===r)return;let{normalizedX:n,normalizedY:s}=r,a=Z.vh.fromValues(t[0],t[1],t[2],s);return this.disableAutoPointUpdate(),this.transferFunction.addPoint(new a5(this.convertPanelSpaceInputToAbsoluteValue(n),this.convertPanelSpaceColorToAbsoluteValue(a))),this.currentGrabbedControlPointIndex=this.findControlPointIfNearCursor(e),{...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}}moveControlPoint(e){let{controlPoints:t}=this.transferFunction.sortedControlPoints;if(-1!==this.currentGrabbedControlPointIndex&&this.currentGrabbedControlPointIndex<t.length){let i=this.getControlPointPosition(e);if(void 0===i)return;let{normalizedX:r,normalizedY:n}=i,s=t[this.currentGrabbedControlPointIndex],a=this.convertPanelSpaceInputToAbsoluteValue(r);for(let e=0;e<t.length;e++)t[e].inputValue===a&&e!==this.currentGrabbedControlPointIndex&&(a=s.inputValue);let o=Z.vh.clone(s.outputColor);return o[3]=Math.round(255*n),this.disableAutoPointUpdate(),this.currentGrabbedControlPointIndex=this.transferFunction.updatePoint(this.currentGrabbedControlPointIndex,new a5(a,o)),{...this.getModel(),sortedControlPoints:this.transferFunction.trackable.value.sortedControlPoints}}}getControlPointPosition(e){let t=this.element.getBoundingClientRect(),i=(e.clientX-t.left)/t.width,r=(t.bottom-e.clientY)/t.height;if(!(i<0)&&!(i>1)&&!(r<0)&&!(r>1))return i<.05/3?i=0:i>1-.05/3&&(i=1),r<.05?r=0:r>.95&&(r=1),{normalizedX:i,normalizedY:r}}findControlPointIfNearCursor(e){let t;let{transferFunction:i,dataType:r}=this,{window:n}=i.trackable.value,s=i.sortedControlPoints.controlPoints.length;function a(e){return e<0||e>=s?null:eS(n,i.sortedControlPoints.controlPoints[e].inputValue)}let o=this.getControlPointPosition(e);if(void 0===o)return -1;let l=o.normalizedX,d=o.normalizedY,u=i.findNearestControlPointIndex(l,n);if(-1===u)return -1;let c=a(u),h=Math.max(.05,1/(r==el.UINT64?Number(n[1]-n[0]):r==el.FLOAT32?20:n[1]-n[0]));return Math.abs(l-c)>h?-1:function(e){let t=[],r=i.sortedControlPoints.length;for(let o=0;o<r;o++){let r=a(o),u=null!==r?Math.abs(r-l):1/0;if(u<=e){var n;let e=(n=o)<0||n>=s?null:i.sortedControlPoints.controlPoints[n].outputColor[3]/255;t.push([o,Math.abs(e-d)+10*u])}}return 0===t.length?u:t.sort((e,t)=>e[1]-t[1])[0][0]}(h)}}class ol extends sE{display;dataType;trackable;histogramSpecifications;histogramIndex;transferFunctionPanel;autoRangeFinder;window;get autoPointUpdateEnabled(){return this.transferFunctionPanel.transferFunction.autoPointUpdateEnabled}set autoPointUpdateEnabled(e){this.transferFunctionPanel.transferFunction.autoPointUpdateEnabled=e}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}constructor(e,t,i,r,n,s){super(e),this.display=t,this.dataType=i,this.trackable=r,this.histogramSpecifications=n,this.histogramIndex=s,this.window=this.createWindowBoundInputs(),this.transferFunctionPanel=this.registerDisposer(new os(this)),this.registerDisposer(n.visibility.add(this.visibility));let{element:a}=this;a.classList.add("neuroglancer-transfer-function-widget"),a.appendChild(this.transferFunctionPanel.element),a.appendChild(this.window.container),this.window.container.dispatchEvent(new Event("change")),this.autoRangeFinder=this.registerDisposer(new sx(this)),this.autoRangeFinder.element.appendChild(this.createClearButton()),this.autoRangeFinder.element.appendChild(this.createColorPicker(r));let o=eP(this.trackable.value.window,eb[this.dataType]);0===this.trackable.value.sortedControlPoints.length&&o?this.autoRangeFinder.autoComputeRange(0,1):(this.autoPointUpdateEnabled=!1,this.trackable.value.sortedControlPoints.length>0&&o&&this.transferFunctionPanel.transferFunction.generateDefaultWindow()),this.updateControlPointsAndDraw(),this.registerDisposer(this.trackable.changed.add(()=>{this.updateControlPointsAndDraw()})),this.registerDisposer(this.display.updateFinished.add(()=>{this.autoRangeFinder.maybeAutoComputeRange()})),this.registerDisposer(this.autoRangeFinder.finished.add(()=>{this.generateDefaultControlPoints(this.autoRangeFinder.computedRange)}))}createClearButton(){let e=document.createElement("button");return e.classList.add("neuroglancer-transfer-function-clear-button"),e.textContent="Clear",e.title="Clear all control points",e.addEventListener("click",()=>{this.clearPoints()}),e}createColorPicker(e){let t=document.createElement("div");t.classList.add("neuroglancer-transfer-function-color-picker-container");let i=this.registerDisposer(new sg((0,J.mo)(e=>e.defaultColor,[e]),()=>Z.R3.fromValues(1,1,1)));return i.element.classList.add("neuroglancer-transfer-function-color-picker"),i.element.title="Transfer function color picker",i.element.addEventListener("change",()=>{e.value={...this.trackable.value,defaultColor:i.model.value}}),i.element.addEventListener("input",()=>{e.value={...this.trackable.value,defaultColor:i.model.value}}),t.appendChild(i.element),t}createWindowBoundInputs(){let e=this.dataType,t=this.trackable;function i(e){let t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-transfer-function-widget-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=`${0===e?"Lower":"Upper"} window for transfer function`,t}let r=document.createElement("div");r.classList.add("neuroglancer-transfer-function-window-bounds");let n=[i(0),i(1)];for(let i=0;i<2;++i){let r=n[i];r.addEventListener("input",()=>{sU(r)}),r.addEventListener("change",()=>{let n=t.value.window,s={range:n,window:n};try{let n=eD(e,r.value),a=sM(s,"window",i,n,!0).window;if(a[0]===a[1])throw Error("Window bounds cannot be equal");this.transferFunctionPanel.transferFunction.generateDefaultControlPoints(null,a),t.value={...t.value,window:a}}catch{s$(r,n[i])}})}return r.appendChild(n[0]),r.appendChild(n[1]),{container:r,inputs:n}}updateView(){for(let e=0;e<2;++e)s$(this.window.inputs[e],this.trackable.value.window[e]);this.transferFunctionPanel.scheduleRedraw()}updateControlPointsAndDraw(){this.transferFunctionPanel.update(),this.updateView()}updateTrackable(e){this.trackable.value=e}generateDefaultControlPoints(e=null){let t=this.transferFunctionPanel.transferFunction;t.generateDefaultControlPoints(e),this.updateTrackable({...this.trackable.value,sortedControlPoints:t.sortedControlPoints})}clearPoints(){let e=this.transferFunctionPanel.transferFunction.sortedControlPoints;e.clear(),this.updateTrackable({...this.trackable.value,sortedControlPoints:e}),this.autoPointUpdateEnabled=!0}}function od(e,t){"number"==typeof e&&(e=[e]);let i=Array(t);return(0,ef.Iw)(i,e,e=>{if(!Number.isInteger(e)||e<0)throw Error(`Expected non-negative integer, but received: ${JSON.stringify(e)}`);return e}),i}let ou=new Map([["slider",function(e,t){let i,r,n,s;let a=[];for(let[o,l]of("float"!==e&&"uint"!==e&&"int"!==e&&a.push("type must be float, int, or uint"),t)){let t=()=>{if("number"!=typeof l){a.push(`Expected ${o} argument to be a number`);return}return("int"===e||"uint"===e)&&(Number.isInteger(l)||a.push(`Expected ${o} argument to be an integer`),"uint"===e&&l<0&&a.push(`Expected ${o} argument to be an unsigned integer`)),l};"min"===o?i=t():"max"===o?r=t():"default"===o?s=t():"step"===o?n=t():a.push(`Invalid parameter: ${o}`)}return(void 0===i&&a.push("min must be specified"),void 0===r&&a.push("max must be specified"),void 0!==i&&void 0!==r&&(i>r&&a.push("min must be less than max"),void 0===n&&(n="float"===e?(r-i)/100:1),void 0!==s?(s<i||s>r)&&a.push("default must be within valid range"):s="float"===e?(i+r)/2:i),a.length>0)?{errors:a}:{control:{type:"slider",valueType:e,min:i,max:r,step:n,default:s},errors:void 0}}],["color",function(e,t){let i="white",r=[];for(let[n,s]of("vec3"!==e&&r.push("type must be vec3"),t))"default"===n?"string"!=typeof s?r.push("Expected default argument to be a string"):i=s:r.push(`Invalid parameter: ${n}`);return r.length>0?{errors:r}:{control:{type:"color",valueType:e,defaultString:i,default:Q(i)},errors:void 0}}],["invlerp",function(e,t,i){let{imageData:r,properties:n}=i;if(void 0!==r)return function(e,t,i){let r;let n=[];"invlerp"!==e&&n.push("type must be invlerp");let s=Array(i.channelRank).fill(0),{dataType:a}=i,o=!0,l=eb[a];for(let[e,i]of t)try{switch(e){case"range":l=eL(i,a);break;case"window":r=eE(eL(i,a));break;case"clamp":"boolean"!=typeof i?n.push(`Invalid clamp value: ${JSON.stringify(i)}`):o=i;break;case"channel":s=od(i,s.length);break;default:n.push(`Invalid parameter: ${e}`)}}catch(t){n.push(`Invalid ${e} value: ${t.message}`)}return n.length>0?{errors:n}:{control:{type:"imageInvlerp",dataType:a,clamp:o,default:{range:l,window:r??eT(l),channel:s}},errors:void 0}}(e,t,r);if(void 0!==n)return function(e,t,i){let r,n,s;let a=[];"invlerp"!==e&&a.push("type must be invlerp");let o=!0;for(let[e,l]of t)try{switch(e){case"range":r=eI(l);break;case"window":n=eI(l);break;case"clamp":"boolean"!=typeof l?a.push(`Invalid clamp value: ${JSON.stringify(l)}`):o=l;break;case"property":{let e=(0,ef.ZE)(l);if(!i.has(e))throw Error(`Property not defined: ${JSON.stringify(s)}`);s=e;break}default:a.push(`Invalid parameter: ${e}`)}}catch(t){a.push(`Invalid ${e} value: ${t.message}`)}if(a.length>0)return{errors:a};if(void 0===s)for(let e of i.keys()){s=e;break}let l=i.get(s);return void 0!==r&&(r=eN(r,l)),void 0!==n&&(n=eN(n,l)),{control:{type:"propertyInvlerp",clamp:o,properties:i,default:{range:r,window:n,property:s,dataType:l}},errors:void 0}}(e,t,n);let s=[];return s.push("invlerp control not supported"),{errors:s}}],["checkbox",function(e,t){let i=!1,r=[];for(let[n,s]of("bool"!==e&&r.push("type must be bool"),t))if("default"===n){if("boolean"!=typeof s){r.push(`Expected ${n} argument to be a boolean`);continue}i=s}else r.push(`Invalid parameter: ${n}`);return r.length>0?{errors:r}:{control:{type:"checkbox",valueType:e,default:i},errors:void 0}}],["transferFunction",function(e,t,i){let r;let n=i.imageData,s=n?.dataType,a=n?.channelRank,o=[],l=Array(a).fill(0),d=Z.R3.fromValues(1,1,1),u=new a8([],void 0!==s?s:el.FLOAT32);for(let[i,n]of("transferFunction"!==e&&o.push("type must be transferFunction"),void 0===s&&o.push("image data must be provided to use a transfer function"),t))try{switch(i){case"channel":l=od(n,l.length);break;case"defaultColor":d=Q(n);break;case"window":void 0!==s&&(r=eE(eL(n,s)));break;case"controlPoints":void 0!==s&&(u=ob(n,s));break;default:o.push(`Invalid parameter: ${i}`)}}catch(e){o.push(`Invalid ${i} value: ${e.message}`)}return(void 0===r&&(r=u.range),o.length>0)?{errors:o}:{control:{type:"transferFunction",dataType:s,default:{sortedControlPoints:u,channel:l,defaultColor:d,window:r}},errors:void 0}}]]);function oc(e,t={}){e=e.replace(/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/gm,e=>e.startsWith("/")?e.replace(/[^\s]/g," "):e);let i=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,r=[],n=new Map,s=e.replace(/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/gm,(s,a,o)=>{let l=a.match(i),d=()=>Math.max(0,e.substring(0,o).split("\n").length-1);if(null===l)return r.push({line:d(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";let u=l[1],c=l[2],h=l[3]??u,{parameters:p,errors:g}=function(e){let t=[],i=new Map;if(void 0===e)return{errors:t,parameters:i};let r=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;;){let n;if(0===(e=e.trim()).length)break;let s=e.match(r);if(null===s){t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let a=s[1],o=function(e){let t=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/,i=0,r=e;t:for(;e.length;){let r=e.match(t);if(null===r)break;let n=r[0];switch(n.charAt(0)){case"[":case"{":++i;break;case"]":case"}":if(--i<0)return -1;break;case",":if(0===i)break t;break;default:if(0===i){e=e.substring(n.length);break t}}e=e.substring(n.length)}return 0!==i?-1:r.length-e.length}(e=e.substring(s[0].length));if(o<=0){t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}try{n=JSON.parse(e.substring(0,o))}catch{t.push(`Invalid #uicontrol parameter value for ${a}: ${n}`);break}i.has(a)?t.push(`Duplicate #uicontrol parameter: ${a}`):i.set(a,n),(e=(e=e.substring(o)).trim()).length>0&&!e.startsWith(",")&&t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),e=e.substring(1)}return{parameters:i,errors:t}}(l[4]);for(let e of g)r.push({line:d(),message:e});if(n.has(c)&&r.push({line:d(),message:`Duplicate definition for control ${c}`}),g.length>0)return"";let f=ou.get(h);if(void 0===f)return r.push({line:d(),message:`Invalid control type ${h}`}),"";let m=f(u,p,t);if(void 0!==m.errors){for(let e of m.errors)r.push({line:d(),message:e});return""}return n.set(c,m.control),""});return{source:e,code:s,errors:r,controls:n}}function oh(e){return`u_shaderControl_${e}`}function op(e,t){let{builderValues:i}=e;for(let[r,n]of e.parseResult.controls){let e=oh(r),s=i[r];switch(n.type){case"imageInvlerp":{let i=[np(t,e,n.dataType,n.clamp),`
float ${e}() {
  return ${e}(getDataValue(${s.channel.join(",")}));
}
`];t.addFragmentCode(i),t.addFragmentCode(`#define ${r} ${e}
`);break}case"propertyInvlerp":{let i=s.property,a=[np(t,e,n.properties.get(i),n.clamp),`
float ${e}() {
  return ${e}(prop_${i}());
}
`];t.addVertexCode(a),t.addVertexCode(`#define ${r} ${e}
`);break}case"checkbox":{let e=`#define ${r} ${s.value}
`;t.addFragmentCode(e),t.addVertexCode(e);break}case"transferFunction":t.addFragmentCode(`#define ${r} ${e}
`),t.addFragmentCode(function(e,t,i,r){e.addUniform("highp float",`uTransferFunctionEnd_${t}`),e.addTextureSampler("sampler2D",`uTransferFunctionSampler_${t}`,`TransferFunction.${t}`);let n=np(e,t,i,!0),s=r6(i),a=`
vec4 ${t}_(float inputValue) {
  int index = clamp(int(round(inputValue * uTransferFunctionEnd_${t})), 0, int(uTransferFunctionEnd_${t}));
  return texelFetch(uTransferFunctionSampler_${t}, ivec2(index, 0), 0);
}
vec4 ${t}(${s} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${t});
  defaultMaxProjectionIntensity = v;
  return v < 0.0 ? vec4(0.0, 0.0, 0.0, 0.0) : ${t}_(clamp(v, 0.0, 1.0));
}
vec4 ${t}() {
  return ${t}(getDataValue(${r.join(",")}));
}
`;if(i!==el.UINT64&&i!==el.FLOAT32){let e=ed[i]?"int":"uint";a+=`
vec4 ${t}(${e} inputValue) {
  return ${t}(${s}(inputValue));
}
`}return[n[0],n[1],n[2],a]}(t,e,n.dataType,s.channel));break;default:t.addUniform(`highp ${n.valueType}`,e),t.addVertexCode(`#define ${r} ${e}
`),t.addFragmentCode(`#define ${r} ${e}
`)}}}function og(e,t){return"bigint"==typeof t?t.toString():t instanceof Map?Array.from(t.entries()):t}function of(e){if(void 0!==e)return JSON.stringify(Object.fromEntries(e),og)}class om{changed=new eO.K_;controls=void 0;get value(){return this.controls}set value(e){of(e)!==of(this.controls)&&(this.controls=e,this.changed.dispatch())}}class ov extends J.TU{dataType;defaultValue;constructor(e,t){super(t,i=>void 0===i?t:((0,ef.PT)(i),{range:(0,ef.Kh)(i,"range",t=>eL(t,e),t.range),window:(0,ef.Kh)(i,"window",t=>eE(eL(t,e)),t.window),channel:(0,ef.Kh)(i,"channel",e=>od(e,t.channel.length),t.channel)})),this.dataType=e,this.defaultValue=t}toJSON(){let{value:{range:e,window:t,channel:i},dataType:r,defaultValue:n}=this,s=eR(e,r,n.range),a=eR(t,r,n.window),o=(0,H.cO)(n.channel,i)?void 0:i;if(void 0!==s||void 0!==a||void 0!==o)return{range:s,window:a,channel:o}}}class oy extends J.TU{properties;defaultValue;constructor(e,t){super(t,i=>(function(e,t,i){if(void 0===e)return i;(0,ef.PT)(e);let r=(0,ef.Kh)(e,"property",e=>{if(e=(0,ef.ZE)(e),!t.has(e))throw Error(`Invalid value: ${JSON.stringify(e)}`);return e},i.property),n=t.get(r);return{property:r,dataType:n,range:(0,ef.Kh)(e,"range",e=>eL(e,n),i.range),window:(0,ef.Kh)(e,"window",e=>eE(eL(e,n)),i.window)}})(i,e,t)),this.properties=e,this.defaultValue=t}toJSON(){let{value:{range:e,window:t,property:i,dataType:r},defaultValue:n}=this,s=eb[r],a=eR(e??s,r,n.range??s),o=eR(t??s,r,n.window??s),l=i===n.property?void 0:i;if(void 0!==a||void 0!==o||void 0!==l)return{range:a,window:o,property:l}}}function ob(e,t){return new a8((0,ef.m7)(e,e=>{let i=t===el.UINT64&&"string"==typeof e[0]||"number"==typeof e[0];if(3!==e.length||!i||"string"!=typeof e[1]||"number"!=typeof e[2])throw Error(`Expected array of length 3 (x, "#RRGGBB", A), but received: ${JSON.stringify(e)}`);let r=eD(t,e[0]);if(7!==e[1].length||"#"!==e[1][0])throw Error(`Expected #RRGGBB, but received: ${JSON.stringify(e[1])}`);if(e[2]<0||e[2]>1)throw Error(`Expected opacity in range [0, 1], but received: ${JSON.stringify(e[2])}`);let n=Q(e[1]);function s(e){return Math.min(255,Math.max(Math.round(255*e),0))}return new a5(r,Z.vh.fromValues(s(n[0]),s(n[1]),s(n[2]),s(e[2])))}),t)}class oS extends J.TU{dataType;defaultValue;constructor(e,t){let i={...t,sortedControlPoints:t.sortedControlPoints.copy()};super(i,t=>(function(e,t,i){if(void 0===e)return i;(0,ef.PT)(e);let r=(0,ef.Kh)(e,"controlPoints",e=>ob(e,t),i.sortedControlPoints),n=(0,ef.Kh)(e,"window",e=>eL(e,t),i.window);return{sortedControlPoints:r,channel:(0,ef.Kh)(e,"channel",e=>od(e,i.channel.length),i.channel),defaultColor:(0,ef.Kh)(e,"defaultColor",e=>Q(e),i.defaultColor),window:n}})(t,e,i)),this.dataType=e,this.defaultValue=t}controlPointsToJson(e,t){return e.map(e=>{var i;return[(i=e.inputValue,t===el.UINT64?i.toString():i),er(Z.R3.fromValues(e.outputColor[0]/255,e.outputColor[1]/255,e.outputColor[2]/255)),e.outputColor[3]/255]})}toJSON(){let{value:{channel:e,sortedControlPoints:t,defaultColor:i,window:r},dataType:n,defaultValue:s}=this,a=eR(r,n,s.window),o=(0,H.cO)(s.channel,e)?void 0:e,l=(0,H.cO)(s.defaultColor,i)?void 0:er(i),d=(0,H.eK)(s.sortedControlPoints.controlPoints,t.controlPoints,(e,t)=>(0,H.cO)(e.outputColor,t.outputColor)&&e.inputValue===t.inputValue)?void 0:this.controlPointsToJson(t.controlPoints,n);if(void 0!==o||void 0!==l||void 0!==d||void 0!==a)return{channel:o,defaultColor:l,controlPoints:d,window:a}}}function ow(e){switch(e.type){case"slider":return{trackable:new J.TU(e.default,t=>{let i;if((i="float"===e.valueType?(0,ef.jz)(t):(0,ef.C$)(t))<e.min||i>e.max)throw Error(`${JSON.stringify(t)} is outside valid range [${e.min}, ${e.max}]`);return i}),getBuilderValue:()=>null};case"color":return{trackable:new ea(e.default),getBuilderValue:()=>null};case"imageInvlerp":return{trackable:new ov(e.dataType,e.default),getBuilderValue:t=>({channel:t.channel,dataType:e.dataType})};case"propertyInvlerp":return{trackable:new oy(e.properties,e.default),getBuilderValue:e=>({property:e.property,dataType:e.dataType})};case"checkbox":return{trackable:new i3(e.default),getBuilderValue:e=>({value:e})};case"transferFunction":return{trackable:new oS(e.dataType,e.default),getBuilderValue:t=>({channel:t.channel,dataType:e.dataType})}}}function oC(e,t){return JSON.stringify(e)+"\0"+t.source}function ox(e){let t={},i=[];for(let[r,n]of e.controls){let{trackable:e,getBuilderValue:s}=ow(n),a=s(e.value);t[r]=a,"propertyInvlerp"===n.type&&i.push(a.property)}return{builderValues:t,parseResult:e,key:oC(t,e),referencedProperties:i}}class oE extends eh.gj{fragmentMain;dataContext;channelCoordinateSpaceCombiner;changed;controls;parseErrors;processedFragmentMain;parseResult;builderState;histogramSpecifications;fragmentMainGeneration;dataContextGeneration;parseErrors_;processedFragmentMain_;parseResult_;controlsGeneration;parseResultChanged;constructor(e,t=(0,J.ne)({}),i){super(),this.fragmentMain=e,this.dataContext=t,this.channelCoordinateSpaceCombiner=i,this.changed=new eO.K_,this.controls=new om,this.fragmentMainGeneration=-1,this.dataContextGeneration=-1,this.parseErrors_=[],this.processedFragmentMain_="",this.controlsGeneration=-1,this.parseResultChanged=new eO.K_,this.state_=new Map,this.unparsedJson=void 0,this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();let r=this;this.parseErrors={changed:this.parseResultChanged,get value(){return r.handleFragmentMainChanged(),r.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return r.handleFragmentMainChanged(),r.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return r.parseResult_}},this.builderState=(0,J.mo)((e,t)=>{let i={},r=[];for(let[e,{control:n,trackable:s,getBuilderValue:a}]of t){let t=a(s.value);i[e]=t,"propertyInvlerp"===n.type&&r.push(t.property)}return{key:oC(i,e),parseResult:e,builderValues:i,referencedProperties:r}},[this.parseResult,this],(e,t)=>e.key===t.key);let n=(0,J.mo)(e=>{let t=[];for(let{control:i,trackable:r}of e.values())("imageInvlerp"===i.type||"transferFunction"===i.type)&&t.push({channel:r.value.channel});return t},[this],(e,t)=>(0,H.eK)(e,t,(e,t)=>(0,H.cO)(e.channel,t.channel))),s=(0,J.mo)(e=>{let t=[];for(let{control:i,trackable:r}of e.values())"propertyInvlerp"===i.type&&t.push(r.value.property);return t},[this],H.cO),a=(0,J.og)(e=>{let t=[];for(let{control:i,trackable:r}of e.values())if("imageInvlerp"===i.type||"transferFunction"===i.type)t.push(r.value.window);else if("propertyInvlerp"===i.type){let{dataType:e,range:i,window:n}=r.value;t.push(n??i??eb[e])}return t},this);this.histogramSpecifications=this.registerDisposer(new r7(n,s,a))}handleFragmentMainChanged(){let e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;let i=this.dataContext.value;if(null===i)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{let e=this.parseResult_=oc(this.fragmentMain.value,i);this.parseErrors_=e.errors,this.processedFragmentMain_=e.code,0===e.errors.length&&(this.controls.value=e.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){let e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;let t=this.controls.value;if(void 0===t)return;let i=!1,{state_:r,unparsedJson:n}=this;for(let[e,n]of r)void 0===t.get(e)&&(n.trackable.changed.remove(this.changed.dispatch),r.delete(e),i=!0);for(let[e,s]of t){let t=r.get(e);if(void 0!==t&&JSON.stringify(t.control)!==JSON.stringify(s)&&(t.trackable.changed.remove(this.changed.dispatch),t=void 0),void 0===t){let{trackable:n,getBuilderValue:a}=ow(s);(t={control:s,trackable:n,getBuilderValue:a}).trackable.changed.add(this.changed.dispatch),r.set(e,t),i=!0}if(void 0!==n&&Object.prototype.hasOwnProperty.call(n,e)){i=!0;try{t.trackable.restoreState(n[e])}catch{}}}void 0!==n&&(i=!0),this.unparsedJson=void 0,i&&this.changed.dispatch()}state_;get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}unparsedJson;restoreState(e){if(void 0===e)return;let{state:t}=this;if((0,ef.PT)(e),void 0===this.controls.value){this.unparsedJson=e,this.changed.dispatch();return}for(let[i,r]of t){let{trackable:t}=r;if(t.reset(),Object.prototype.hasOwnProperty.call(e,i))try{t.restoreState(e[i])}catch{}}this.unparsedJson=void 0}reset(){for(let e of this.state.values())e.trackable.reset();void 0!==this.unparsedJson&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){let{state:e}=this,{unparsedJson:t}=this;if(void 0!==t)return t;let i={},r=!0;for(let[t,n]of e){let e=n.trackable.toJSON();void 0!==e&&(i[t]=e,r=!1)}if(!r)return i}}function oT(e,t,i,r,n){let s=oh(i),a=t.uniform(s);switch(r.type){case"slider":switch(r.valueType){case"int":case"uint":e.uniform1i(a,n);break;case"float":e.uniform1f(a,n)}break;case"color":e.uniform3fv(a,n);break;case"imageInvlerp":ng(t,s,r.dataType,n.range);break;case"propertyInvlerp":{let{dataType:e}=n;ng(t,s,e,n.range??eb[e]);break}case"checkbox":break;case"transferFunction":!function(e,t,i,r,n=a6[i]){let{gl:s}=e;void 0===e.transferFunctionTextures.get(`TransferFunction.${t}`)&&e.transferFunctionTextures.set(`TransferFunction.${t}`,new oi(s));let a=e.bindAndUpdateTransferFunctionTexture(`TransferFunction.${t}`,r,i,n);if(void 0===a)throw Error("Failed to create transfer function texture");s.uniform1f(e.uniform(`uTransferFunctionEnd_${t}`),a-1),ng(e,t,i,r.range)}(t,s,r.dataType,n.sortedControlPoints)}}function ok(e,t,i,r){let{state:n}=i;if(i.controls.value===r)for(let[i,r]of n)oT(e,t,i,r.control,r.trackable.value);else for(let[i,s]of r){let r=n.get(i),a=void 0!==r&&JSON.stringify(r.control)===JSON.stringify(s)?r.trackable.value:s.default;oT(e,t,i,s,a)}}class oD extends J.SN{}class oL extends i7{constructor(){super((e,{showMatches:t,segmentationState:i})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(i.changed.add(this.changed.dispatch)),e.registerDisposer((0,J.Uw)((e,t)=>{if(null==t)return;let{segmentationGroupState:i}=t;e.registerDisposer(i.changed.add(this.changed.dispatch)),e.registerDisposer((0,J.Uw)((e,t)=>{let{visibleSegments:i}=t,r=0===i.size;e.registerDisposer(i.changed.add(()=>{let e=0===i.size;e!==r&&(r=e,this.changed.dispatch())}))},i))},i))})}get(e){let t=super.get(e);return void 0===t&&(t={segmentationState:new J.SN(void 0),showMatches:new i3(!1)},super.set(e,t)),t}}let oI=`
void main() {
  setColor(defaultColor());
}
`;class oP extends eh.gj{annotationProperties=new J.SN(void 0);shader=rh(oI);shaderControls=new oE(this.shader,(0,J.og)(e=>{let t=new Map;if(void 0===e)return null;for(let i of e){let e=eU[i.type];void 0!==e&&t.set(i.identifier,e)}return{properties:t}},this.annotationProperties));fallbackShaderControls=new J.SN(ox(oc(oI)));shaderError=rc();color=new ea(Z.R3.fromValues(1,1,0));relationshipStates=this.registerDisposer(new oL);ignoreNullSegmentFilter=new i3(!0);disablePicking=new J.SN(!1);displayUnfiltered=(0,J.og)((e,t)=>{for(let i of e.values())if(i.showMatches.value){if(!t)return!1;let e=i.segmentationState.value;if(null!=e&&e.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter);hoverState=new oD(void 0)}class oR extends eh.gj{transform;localPosition;source;role;dataSource;subsourceId;subsourceIndex;displayState;subsubsourceId;chunkTransform;constructor(e){super();let{transform:t,localPosition:i,source:r,role:n=iY.ANNOTATION}=e;this.transform=t,this.localPosition=i,this.source=this.registerDisposer(r),this.role=n,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer((0,J.og)(e=>i5(()=>t5(i8(e))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex,this.subsubsourceId=e.subsubsourceId}get sourceIndex(){let{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}}var oA=i(9023);let oM=Z._E.create();function oN(e,t,i){let{curPositionInChunks:r,fixedPositionWithinChunk:n}=e,{nonDisplayLowerClipBound:s,nonDisplayUpperClipBound:a}=e,{rank:o,chunkDataSize:l,lowerChunkBound:d,upperChunkBound:u}=e.source.spec;if(!t7(r,t,i,e.layerRank,e.fixedLayerToChunkTransform))return!1;for(let e=0;e<o;++e){let t=r[e];if(t<s[e]-.001||t>a[e]+.001)return!1;let i=l[e],o=r[e]=Math.min(u[e]-1,Math.max(d[e],Math.floor(t/i)));n[e]=t-o*i}return!0}let oV=new oA.d(Z.R3.create(),Z._E.create(),0);class oO extends iw{viewportNormalInGlobalCoordinates=Z.R3.create();viewportNormalInCanonicalCoordinates=Z.R3.create();centerDataPosition=Z.R3.create();pixelSize=0}class oF extends i${projectionParameters;visibleLayers;visibleSourcesStale;constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new Map,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((e,t)=>{(function(e,t){if(e.displayDimensionRenderInfo!==t.displayDimensionRenderInfo||e.pixelSize!==t.pixelSize)return!0;let{viewMatrix:i}=e,{viewMatrix:r}=t;for(let e=0;e<12;++e)if(i[e]!==r[e])return!0;return!1})(e,t)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[i,r]of t){let{allSources:t,visibleSources:n}=r;if(n.length=0,0===t.length||!function(e,t){let i=e.displayDimensionRenderInfo;return i===t||!!nz(i,t)&&(e.displayDimensionRenderInfo=t,!0)}(r,e))continue;let s=function(e,t){let i=t.length,r=0;if(i>1){let n=0;for(let s=0;s<i;++s){let{chunkLayout:i}=t[s],a=function(e,t){let i=0,r=Math.abs(e.detTransform),{transform:n,size:s}=e;for(let e=0;e<3;++e){let a=0;for(let i=0;i<3;++i)a+=t[4*i+2]*n[4*e+i];let o=s[e];i+=Math.abs(a)*o,r*=o}return r/i}(i,e);a>n&&(n=a,r=s)}}return r}(this.projectionParameters.value.viewMatrix,t.map(e=>e[0])),a=t[s];for(let e of i.filterVisibleSources(this,a))n.push(e);n.reverse()}}}function oB(e){let{rank:t,upperVoxelBound:i,maxVoxelsPerChunkLog2:r=18,chunkToViewTransform:n,displayRank:s,minBlockSize:a,maxBlockSize:o}=e,{lowerVoxelBound:l=new Uint32Array(t)}=e,d=new Float32Array(t);for(let e=0;e<t;++e){let t=0;for(let i=0;i<s;++i){let r=n[e*s+i];t+=r*r}d[e]=Math.sqrt(t)}let u=new Uint32Array(t);void 0!==a?u.set(a):u.fill(1);let c=Array(t);for(let e=0;e<t;++e){let t=Number.POSITIVE_INFINITY;0===d[e]?t=u[e]:(void 0!==i&&(t=2**Math.floor(Math.log2(i[e]-l[e]))),void 0!==o&&(t=Math.min(t,o[e]))),c[e]=t}r-=Math.log2(th(u));for(let e=0;e<r;++e){let e=function(){let e=1/0,i=-1;for(let r=0;r<t;++r){if(u[r]>=c[r])continue;let t=u[r]*d[r];t<e&&(e=t,i=r)}return i}();if(-1===e)break;u[e]*=2}return u}var o_=((N={})[N.ISOTROPIC=0]="ISOTROPIC",N[N.FLAT=1]="FLAT",N);function oU(e){let{rank:t,chunkDataSize:i,upperVoxelBound:r}=e,{lowerVoxelBound:n=new Float32Array(t)}=e,s=new Float32Array(t),a=new Float32Array(t);for(let e=0;e<t;++e)s[e]=Math.floor(n[e]/i[e]),a[e]=Math.floor((r[e]-1)/i[e]+1);return{rank:t,chunkDataSize:i,lowerChunkBound:s,upperChunkBound:a,lowerVoxelBound:n,upperVoxelBound:r}}let o$=new Float32Array(3),oz=new Float32Array(3),oG=Z._E.create(),oj=new Float32Array(24);function oW(e,t,i,r){let{lowerChunkDisplayBound:n,upperChunkDisplayBound:s}=t;for(let e=0;e<3;++e)o$[e]=Math.max(o$[e],n[e]),oz[e]=Math.min(oz[e],s[e]);let{curPositionInChunks:a,chunkDisplayDimensionIndices:o}=t;!function t(){if(!r(o$[0],o$[1],o$[2],oz[0],oz[1],oz[2],e))return;let n=0,s=Math.max(0,oz[0]-o$[0]),l=s;for(let e=1;e<3;++e){let t=Math.max(0,oz[e]-o$[e]);l*=t,t>s&&(s=t,n=e)}if(0===l)return;if(1===l){a[o[0]]=o$[0],a[o[1]]=o$[1],a[o[2]]=o$[2],i(o$,e);return}let d=o$[n],u=oz[n],c=Math.floor(.5*(d+u));oz[n]=c,t(),oz[n]=u,o$[n]=c,t(),o$[n]=d}()}function oq(e,t,i,r){if(!oN(i,e.globalPosition,t))return;let{size:n}=i.chunkLayout,s=Z._E.multiply(oG,e.viewProjectionMat,i.chunkLayout.transform);for(let e=0;e<3;++e){let t=n[e];for(let i=0;i<4;++i)s[4*e+i]*=t}(0,Z.th)(oj,s),o$.fill(Number.NEGATIVE_INFINITY),oz.fill(Number.POSITIVE_INFINITY),oW(oj,i,r,Z.Rq)}function oH(e,t){let{finiteRank:i}=t;if(3===i)return t;oV.finiteRank=i,Z.R3.copy(oV.size,t.size);let r=Z._E.copy(oV.transform,t.transform),n=Z._E.copy(oV.invTransform,t.invTransform);oV.detTransform=t.detTransform;let{invViewMatrix:s,width:a,height:o}=e,l=(0,Z.V2)(e.projectionMat);for(let e=i;e<3;++e){let t=s[12+e],i=t,n=t,d=Math.abs(s[e]*a);i-=d,n+=d;let u=Math.abs(s[e+4]*o);i-=u,n+=u;let c=Math.abs(s[e+8]*l);i-=c;let h=Math.max(1,(n+=c)-i);r[12+e]=i,r[5*e]=h}return Z._E.invert(n,r),oV}let oJ=Z.wO.create();function oK(e,t,i,r,n,s){let{displayDimensionRenderInfo:a,viewMatrix:o,projectionMat:l,width:d,height:u}=e,{voxelPhysicalScales:c}=a,h=Math.abs(Z.wO.determinant((0,Z.bZ)(oJ,o))),p=(0,Z.n_)(c),g=(0,Z.e6)(l)/h*p;if(0===r.length)return;let f=r[0],m=Math.abs(f.chunkLayout.detTransform)*p,{lowerClipDisplayBound:v,upperClipDisplayBound:y}=f;for(let e=0;e<3;++e)m*=y[e]-v[e];let b=Math.min(m,g),S=d*u,w=S/i**2/b,C=0;for(let i=r.length-1;i>=0&&C<w;--i){let a=r[i],o=a.source.spec,{chunkLayout:l}=a,d=(0,Z.n_)(l.size)*Math.abs(l.detTransform)*p,{limit:u,rank:c}=o,{nonDisplayLowerClipBound:h,nonDisplayUpperClipBound:g}=a,f=1;for(let e=0;e<c;++e){let t=g[e]-h[e];Number.isFinite(t)&&(f/=t)}let m=!0,v=C+u*f/d,y=(1/v)**(1/3),x=Math.sqrt(S/(v*b)),E=Math.min(1,(w-C)*d/f/o.limit);oq(e,t,a,()=>{m&&(n(a,i),m=!1),s(a,i,E,y,x)}),C=v}}let oZ=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;function oY(e,t){return{defineShader(i,r){let n=`prop_${r}`,s=`a_${n}`;i.addAttribute(`${e}`,s),i.addVertexCode(`${e} ${n}() { return ${s}; }`),i.addInitializer(e=>{let i=e.attribute(s),{gl:r}=e;e.vertexShaderInputBinders[n]=-1===i?{enable(){},disable(){},bind(){}}:{enable(e){r.enableVertexAttribArray(i),r.vertexAttribDivisor(i,e)},disable(){r.vertexAttribDivisor(i,0),r.disableVertexAttribArray(i)},bind(e,n){t(r,i,e,n)}}})}}}function oX(e,t,i,r){return oY(e,(e,n,s,a)=>{e.vertexAttribPointer(n,t,i,r,s,a)})}function oQ(e,t,i){return oY(e,(e,r,n,s)=>{e.vertexAttribIPointer(r,t,i,n,s)})}let o0={rgb:oX("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:oX("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:oX("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:oQ("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:oQ("highp int",1,WebGL2RenderingContext.INT),uint16:oQ("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:oQ("highp int",1,WebGL2RenderingContext.SHORT),uint8:oQ("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:oQ("highp int",1,WebGL2RenderingContext.BYTE)};class o1 extends eh.gj{gl;annotationType;rank;properties;serializedBytesPerAnnotation;serializedGeometryBytesPerAnnotation;propertyOffsets;propertyGroupBytes;propertyGroupCumulativeBytes;geometryDataStride;constructor(e,t,i,r){super(),this.gl=e,this.annotationType=t,this.rank=i,this.properties=r;let n=this.serializedGeometryBytesPerAnnotation=e1[t].serializedBytes(i),{offsets:s,serializedBytes:a,propertyGroupBytes:o}=ez(i,n,r);this.serializedBytesPerAnnotation=a,this.propertyOffsets=s,this.propertyGroupBytes=o,this.geometryDataStride=o[0];let l=this.propertyGroupCumulativeBytes=Array(o.length);l[0]=0;for(let e=1;e<o.length;++e)l[e]=l[e-1]+o[e-1]}defineProperties(e,t){let{properties:i,rank:r}=this;for(let n of t){let t=i[n];o0[t.type].defineShader(e,t.identifier,r)}let{propertyOffsets:n}=this,{propertyGroupBytes:s,propertyGroupCumulativeBytes:a}=this;e.addInitializer(e=>{let r=t.map(t=>e.vertexShaderInputBinders[`prop_${i[t].identifier}`]),o=r.length;e.vertexShaderInputBinders.properties={enable(e){for(let t=0;t<o;++t)r[t].enable(e)},bind(e,i){for(let l=0;l<o;++l){let{group:o,offset:d}=n[t[l]];r[l].bind(s[o],i+d+a[o]*e)}},disable(){for(let e=0;e<o;++e)r[e].disable()}}})}}class o2 extends o1{shaderControlState;fallbackShaderParameters;shaderError;pickIdsPerInstance;targetIsSliceView;constructor(e,t,i,r,n,s,a){super(e,t,i,r),this.shaderControlState=n,this.fallbackShaderParameters=s,this.shaderError=a,this.histogramShaders=new Map}getDependentShader(e,t){return rg(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(e,i)=>{let{rank:r,properties:n}=this,s=[],a=i.referencedProperties,o=i.parseResult.code;for(let e=0,t=n.length;e<t;++e){let t=n[e],i=`prop_${t.identifier}`;(a.includes(t.identifier)||o.match(RegExp(`\\b${i}\\b`)))&&s.push(e)}this.defineProperties(e,s),e.addUniform("highp vec3","uColor"),e.addUniform("highp uint","uSelectedIndex"),e.addVarying("highp vec4","vColor"),e.addUniform("highp vec3","uSubspaceMatrix",r),e.addUniform("highp mat4","uModelViewProjection"),e.addUniform("highp float","uModelClipBounds",2*r),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexCode(oZ),e.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),e.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);let l=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;for(let[t,n]of(e.addVertexCode(l),e.addFragmentCode(l),e.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${r}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),op(i,e),e.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerColor(vec3 color) { setPointMarkerColor(vec4(color, 1.0)); }
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`),o3))t!==this.annotationType&&n.defineShaderNoOpSetters(e);t(e),e.addVertexCode("\n#define main userMain\n"+rf(i.parseResult.code)+"\n#undef main\n")}})}setPartIndex(e,...t){let i=`
void setPartIndex(${t.map((e,t)=>`highp uint partIndex${t}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((e,t)=>`highp uint pickOffset${t} = pickBaseOffset + partIndex${t};`).join("\n")}
`;return 0===t.length&&(i+=`
  highp uint pickOffset0 = pickBaseOffset;
`),i+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((e,t)=>` || selectedIndex == pickOffset${t}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(i),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,i){let{shader:r,parameters:n}=e(t.renderContext.emitter);if(null===r)return;r.bind();let{gl:s}=this,{renderContext:a}=t,{annotationLayer:o}=t;if(ok(s,r,this.shaderControlState,n.parseResult.controls),s.uniform3fv(r.uniform("uSubspaceMatrix"),t.subspaceMatrix),s.uniform1fv(r.uniform("uModelClipBounds"),t.modelClipBounds),s.uniformMatrix4fv(r.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),a.emitPickID&&s.uniform1ui(r.uniform("uPickID"),t.basePickId),a.emitColor){let e=o.state.displayState.color.value;s.uniform3f(r.uniform("uColor"),e[0],e[1],e[2]),s.uniform1ui(r.uniform("uSelectedIndex"),t.selectedIndex)}let l=r.vertexShaderInputBinders.properties;l.enable(1),s.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),l.bind(t.count,t.bufferOffset),i(r),l.disable()}histogramShaders;getHistogramShader(e){let{histogramShaders:t}=this,i=t.get(e);if(void 0===i){let{gl:r}=this;i=r.memoize.get(JSON.stringify({t:"propertyHistogramGenerator",propertyType:e}),()=>{let t=new ru(r);return this.defineHistogramShader(t,e),t.build()}),t.set(e,i)}return i}defineHistogramShader(e,t){o0[t].defineShader(e,"histogram",0),e.addOutputBuffer("vec4","out_histogram",0);let i=eU[t];e.addVertexCode(np(e,"invlerpForHistogram",i,!1)),e.setVertexMain(`
float x = invlerpForHistogram(prop_histogram());
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
gl_PointSize = 1.0;
`),e.setFragmentMain("out_histogram = vec4(1.0, 1.0, 1.0, 1.0);")}computeHistograms(e,t){let{histogramSpecifications:i}=this.shaderControlState,r=i.properties.value,n=r.length,{properties:s}=this,a=s.length,{propertyOffsets:o}=this,{propertyGroupBytes:l,propertyGroupCumulativeBytes:d}=this,{gl:u}=this;u.enable(WebGL2RenderingContext.BLEND),u.disable(WebGL2RenderingContext.SCISSOR_TEST),u.disable(WebGL2RenderingContext.DEPTH_TEST),u.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE);let c=i.getFramebuffers(u),h=i.frameNumber;i.frameNumber=t,u.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer);for(let p=0;p<n;++p){let n=r[p];for(let r=0;r<a;++r){let a=s[r];if(a.identifier!==n)continue;let g=a.type,f=eU[g],m=this.getHistogramShader(g);m.bind();let v=m.vertexShaderInputBinders.prop_histogram;v.enable(0);let{group:y,offset:b}=o[r];ng(m,"invlerpForHistogram",f,i.bounds.value[p]),v.bind(l[y],e.bufferOffset+b+d[y]*e.count),c[p].bind(256,1),t!==h&&(u.clearColor(0,0,0,0),u.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),u.drawArrays(WebGL2RenderingContext.POINTS,0,e.count),v.disable();break}}u.disable(WebGL2RenderingContext.BLEND)}}let o3=new Map;function o4(e,t){o3.set(e,t)}function o6(e){return o3.get(e)}var o5=i(4571);function o8(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}class o9{source;state;constructor(e){this.source=e,this.state=it.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=it.GPU_MEMORY}freeGPUMemory(e){this.state=it.SYSTEM_MEMORY}}function o7(e){if("number"!=typeof e||e<0)throw Error(`Expected non-negative number as limit, but received: ${JSON.stringify(e)}`);return e}class le{sizeLimit;itemLimit;constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new J.TU(t,o7),this.itemLimit=new J.TU(e,o7)}}class lt extends i${gl;frameNumberCounter;capacities;visibleChunksChanged;pendingChunkUpdates;pendingChunkUpdatesTail;chunkUpdateDeadline;chunkUpdateDelay;enablePrefetch;constructor(e,t,i,r){super(),this.gl=t,this.frameNumberCounter=i,this.capacities=r,this.visibleChunksChanged=new eO.K_,this.pendingChunkUpdates=null,this.pendingChunkUpdatesTail=null,this.chunkUpdateDeadline=null,this.chunkUpdateDelay=30,this.enablePrefetch=new i3(!0,!0);let n=t=>({itemLimit:this.registerDisposer(iH.makeFromExisting(e,t.itemLimit)).rpcId,sizeLimit:this.registerDisposer(iH.makeFromExisting(e,t.sizeLimit)).rpcId});this.initializeCounterpart(e,{gpuMemoryCapacity:n(r.gpuMemory),systemMemoryCapacity:n(r.systemMemory),downloadCapacity:n(r.download),computeCapacity:n(r.compute),enablePrefetch:this.registerDisposer(iH.makeFromExisting(e,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let e;let t=this.chunkUpdateDeadline;e=null===t||Date.now()<t?0:this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),e)}processPendingChunkUpdates(e=!1){let t=this.chunkUpdateDeadline;e||null!==t||(t=Date.now()+30);let i=!1,r=0;for(;;){if(!e&&Date.now()>t){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}let n=this.pendingChunkUpdates;if(null==n)break;try{this.applyChunkUpdate(n)&&(i=!0)}finally{if(++r,null==(this.pendingChunkUpdates=n.nextUpdate)){this.pendingChunkUpdatesTail=null;break}}}return i&&this.visibleChunksChanged.dispatch(),r}handleFetch_(e,t){let{resolve:i,reject:r,signal:n}=t.promise;if(n.aborted){r(n.reason);return}let s=t.key,a=e.chunks.get(s);if(!a){r(Error(`No chunk found at ${s} for source ${e.constructor.name}`));return}let o=a.data;if(!o){r(Error(`At ${s} for source ${e.constructor.name}: chunk has no data`));return}i({value:o})}applyChunkUpdate(e){let t=!1,{rpc:i}=this,r=i.get(e.source);if(void 0!==r){if(void 0!==e.promise)this.handleFetch_(r,e);else if(void 0===e.id){for(let e of r.chunks.keys())r.deleteChunk(e);t=!0}else{let i=e.state;if(i===it.EXPIRED)r.deleteChunk(e.id);else{let n;let s=e.id;e.new?(n=r.getChunk(e),r.addChunk(s,n)):n=r.chunks.get(s);let a=n.state;if(i!==a)switch(i){case it.GPU_MEMORY:n.copyToGPU(this.gl),t=!0;break;case it.SYSTEM_MEMORY:a===it.GPU_MEMORY&&n.freeGPUMemory(this.gl);break;default:throw Error(`INTERNAL ERROR: Invalid chunk state: ${it[i]}`)}if(i<=it.SYSTEM_MEMORY){let{chunkRequesters:e}=r;if(void 0!==e){let t=e.get(s);if(void 0!==t)for(let e of t)e(n)}}}}return t}}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){let e=this.rpc,t=await e.promiseInvoke("ChunkQueueManager.requestChunkStatistics",{queue:this.rpcId}),i=new Map;for(let[r,n]of t){let t=e.get(r);void 0!==t&&i.set(t,n)}return i}}function li(e,t){let i=e.get(t.source),r=i.chunkManager.chunkQueueManager;if(i.immediateChunkUpdates){r.applyChunkUpdate(t)&&r.visibleChunksChanged.dispatch();return}let n=r.pendingChunkUpdatesTail;null==n?(r.pendingChunkUpdates=t,r.pendingChunkUpdatesTail=t,r.scheduleChunkUpdate()):(n.nextUpdate=t,r.pendingChunkUpdatesTail=t)}lt=o8([ij("ChunkQueueManager")],lt),iO("Chunk.update",function(e){li(this,e)}),iB("Chunk.retrieve",function(e,t){return new Promise((i,r)=>{e.promise={resolve:i,reject:r,signal:t},li(this,e)})}),iO("ChunkManager.chunkLayerStatistics",function(e){let t=this.get(e.id);for(let e of t.prevStatisticsLayers)e.numVisibleChunksNeeded=0,e.numVisibleChunksAvailable=0,e.numPrefetchChunksNeeded=0,e.numPrefetchChunksAvailable=0;for(let i of(t.prevStatisticsLayers.length=0,e.layers)){let e=this.get(i.id);if(void 0===e)continue;let r=e.layerChunkProgressInfo;r.numVisibleChunksAvailable=i.numVisibleChunksAvailable,r.numVisibleChunksNeeded=i.numVisibleChunksNeeded,r.numPrefetchChunksAvailable=i.numPrefetchChunksAvailable,r.numPrefetchChunksNeeded=i.numPrefetchChunksNeeded,t.prevStatisticsLayers.push(r)}t.layerChunkStatisticsUpdated.dispatch()});class lr extends i${chunkQueueManager;memoize;prevStatisticsLayers;layerChunkStatisticsUpdated;get gl(){return this.chunkQueueManager.gl}constructor(e){super(),this.chunkQueueManager=e,this.memoize=new o5.O1,this.prevStatisticsLayers=[],this.layerChunkStatisticsUpdated=new eO.K_,this.registerDisposer(e.addRef()),this.initializeCounterpart(e.rpc,{chunkQueueManager:e.rpcId})}getChunkSource(e,t){let i=e.encodeOptions(t);i.constructorId=ri(e);let r=(0,ef.hd)(i);return this.memoize.get(r,()=>{let r=new e(this,t);return r.initializeCounterpart(this.rpc,{}),r.key=i,r})}}lr=o8([ij("ChunkManager")],lr);class ln extends i${chunkManager;chunks;chunkRequesters;immediateChunkUpdates;constructor(e,t={}){super(),this.chunkManager=e,this.chunks=new Map,this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){let t=this.chunks.get(e);t.state===it.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw Error("Not implemented.")}invalidateCache(){this.rpc.invoke("ChunkSource.invalidate",{id:this.rpcId})}static encodeOptions(e){return{}}}function ls(e,t){class i extends e{parameters;constructor(...e){super(...e);let t=e[1];this.parameters=t.parameters}initializeCounterpart(e,t){t.parameters=this.parameters,super.initializeCounterpart(e,t)}static encodeOptions(t){return Object.assign({parameters:t.parameters},e.encodeOptions(t))}}return o8([ij(t.RPC_ID)],i)}class la extends i${layerChunkProgressInfo;constructor(e){super(),this.layerChunkProgressInfo=e}}var lo=i(4066);let ll=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function ld(e){return e.toString()}function lu(e){return e.useTemporaryVisibleSegments.value?e.temporaryVisibleSegments:e.visibleSegments}function lc(e,t){let i=lu(e),r=e.useTemporarySegmentEquivalences.value?e.temporarySegmentEquivalences:e.segmentEquivalences,n=r.disjointSets.visibleSegmentEquivalencePolicy.value;for(let e of i.keys())if(n&lo.BA.NONREPRESENTATIVE_EXCLUDED){let i=r.get(e);t(e,i)}else{if(!r.disjointSets.isMinElement(e))continue;for(let i of r.setElements(e))(!(n&lo.BA.REPRESENTATIVE_EXCLUDED)||!(n&lo.BA.MAX_REPRESENTATIVE)||(0x8000000000000000n&i)===0n)&&t(i,e)}}function lh(e,t=-4){return(Math.log2(e)-t)/.5}function lp(e,t=.0625,i){void 0===i&&(i=2**Math.round(16)-1);let r=(0,ef.Im)(t,i);return new J.TU(e,r)}class lg{visibility=new iK;changed=new eO.K_;logScaleOrigin;constructor(e=-4){this.logScaleOrigin=e}frameNumber=-1;spatialScales=new Map;numHistogramRows=1;value=new Uint32Array(40*this.numHistogramRows*2);fakeChunkCount=0;begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.fakeChunkCount=0,this.changed.dispatch())}add(e,t,i,r,n=!1){let{spatialScales:s,numHistogramRows:a,value:o}=this,l=s.get(e);if(void 0===l&&(l=s.size,s.set(e,l)),l>=a){this.numHistogramRows=a*=2;let e=new Uint32Array(80*a);e.set(o),this.value=o=e}let d=80*l+Math.min(Math.max(0,Math.round(lh(t,this.logScaleOrigin))),39);o[d]+=i,o[d+40]+=r,n&&(this.fakeChunkCount=this.fakeChunkCount+r)}}class lf extends iX{chunkManager;multiscaleSource;rpcId;rpcTransfer;localPosition;channelCoordinateSpace;transform;renderScaleTarget;renderScaleHistogram;dataHistogramSpecifications;getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}visibleSources;visibleSourcesList_;getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){let{visibleSources:i}=this,r=i.get(e);void 0!==r?(++r.refCount,r.chunkTransform=t):(i.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){let{visibleSources:t}=this,i=t.get(e);1!==i.refCount?--i.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){let{visibleSources:e,visibleSourcesList_:t}=this;if(0===t.length&&0!==e.size){for(let i of e.values())t.push(i);t.sort((e,t)=>Math.abs(e.chunkTransform.chunkToLayerTransformDet)-Math.abs(t.chunkTransform.chunkToLayerTransformDet))}return t}constructor(e,t,i){super(),this.chunkManager=e,this.multiscaleSource=t,this.rpcId=null,this.rpcTransfer={},this.visibleSources=new Map,this.visibleSourcesList_=[];let{renderScaleTarget:r=lp(1)}=i;this.renderScaleTarget=r,this.renderScaleHistogram=i.renderScaleHistogram,this.transform=i.transform,this.localPosition=i.localPosition,this.rpcTransfer=i.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer(i.dataHistogramSpecifications??new r7((0,J.ne)([]),(0,J.ne)([]),(0,J.ne)([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}initializeCounterpart(){let e=this.registerDisposer(new la(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(iH.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(iH.makeFromExisting(t,this.renderScaleTarget)).rpcId,...this.rpcTransfer}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return function*(e,t,i){let r;let n=1.1*e.projectionParameters.value.pixelSize,s=i[0].effectiveVoxelSize,a=t.renderScaleTarget.value,o=e=>{let t=n*a;for(let i=0;i<3;++i){let r=e[i];if(r>t&&r>1.01*s[i])return!0}return!1},l=(e,t)=>{let i=n*a;for(let r=0;r<3;++r){let n=e[r],s=t[r];if(Math.abs(i-n)<Math.abs(i-s)&&n<1.01*s)return!0}return!1},d=i.length-1;for(;;){let e=i[d];if(void 0!==r&&!l(e.effectiveVoxelSize,r)||(yield e,0===d||!o(e.effectiveVoxelSize)))break;r=e.effectiveVoxelSize,--d}}(e,this,t)}}lf.prototype.RPC_TYPE_ID="sliceview/RenderLayer";class lm extends iQ{draw(e,t){}isReady(e,t){return!0}}let lv=iZ(class extends oF{});function ly(e){return{source:e.source.addCounterpartRef(),effectiveVoxelSize:e.effectiveVoxelSize,layerRank:e.layerRank,nonDisplayLowerClipBound:e.nonDisplayLowerClipBound,nonDisplayUpperClipBound:e.nonDisplayUpperClipBound,lowerClipBound:e.lowerClipBound,upperClipBound:e.upperClipBound,lowerClipDisplayBound:e.lowerClipDisplayBound,upperClipDisplayBound:e.upperClipDisplayBound,chunkDisplayDimensionIndices:e.chunkDisplayDimensionIndices,lowerChunkDisplayBound:e.lowerChunkDisplayBound,upperChunkDisplayBound:e.upperChunkDisplayBound,fixedLayerToChunkTransform:e.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:e.combinedGlobalLocalToChunkTransform,chunkLayout:e.chunkLayout.toObject()}}function lb(e){return e.map(e=>e.map(ly))}function lS(e,t){for(let i of t)for(let{source:t}of i)e.removeSource(t),t.dispose()}class lw extends lv{chunkManager;layerManager;navigationState;wireFrame;gl;viewChanged;renderingStale;visibleChunksStale;visibleLayerList;offscreenFramebuffer;histogramInputTextures;offscreenFramebuffersWithHistograms;get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}histogramGenerator;computeHistograms(e,t){this.histogramGenerator.compute(e,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,t,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}sharedProjectionParameters;flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}constructor(e,t,i,r){super(new i1({parametersConstructor:oO,navigationState:i,update:(e,t)=>{let{invViewMatrix:i,centerDataPosition:r}=e;t.toMat4(i);let{canonicalVoxelFactors:n,voxelPhysicalScales:s}=e.displayDimensionRenderInfo;for(let e=0;e<3;++e)r[e]=i[12+e];let{logicalWidth:a,logicalHeight:o,projectionMat:l,viewportNormalInGlobalCoordinates:d,viewportNormalInCanonicalCoordinates:u}=e,{relativeDepthRange:c}=t;Z._E.ortho(l,-a/2,a/2,o/2,-o/2,-c,c),ig(e,l),ix(e);let{viewMatrix:h}=e;for(let e=0;e<3;++e){let t=d[e]=h[4*e+2];u[e]=t/n[e]}Z.R3.normalize(d,d),Z.R3.normalize(u,u);let p=0;for(let e=0;e<3;++e)p+=(s[e]*i[e])**2;p=Math.sqrt(p),e.pixelSize=p}})),this.chunkManager=e,this.layerManager=t,this.navigationState=i,this.wireFrame=r,this.viewChanged=new eO.K_,this.renderingStale=!0,this.visibleChunksStale=!0,this.visibleLayerList=[],this.histogramInputTextures=[],this.updateVisibleLayers=this.registerCancellable((0,ie.Z)(()=>{this.updateVisibleLayersNow()},0)),this.gl=e.gl,this.offscreenFramebuffer=this.registerDisposer(new rP(this.gl,{colorBuffers:rI(this.gl,1),depthBuffer:new rL(this.gl)})),this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer],this.histogramGenerator=ni.get(this.gl),this.registerDisposer(i),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((e,t)=>{e.displayDimensionRenderInfo!==t.displayDimensionRenderInfo&&this.updateVisibleLayers()}));let n=this.chunkManager.rpc,s=this.sharedProjectionParameters=this.registerDisposer(new i2(n,this.projectionParameters));this.initializeCounterpart(n,{chunkManager:e.rpcId,projectionParameters:s.rpcId}),this.registerDisposer(t.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(e.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}forEachVisibleChunk(e,t,i){!function(e,t,i,r,n){if(!oN(i,e.globalPosition,t))return;let{size:s}=r,a=Z._E.multiply(oG,e.viewProjectionMat,r.transform);for(let e=0;e<3;++e){let t=s[e];for(let i=0;i<4;++i)a[4*e+i]*=t}let{upperChunkDisplayBound:o}=i;Z._E.invert(oM,a);for(let e=0;e<3;++e){let t=oM[12+e]+1e-4/s[e],i=Math.abs(oM[e]),r=Math.abs(oM[4+e]),n=o[e],a=t-i-r;a=a>=n&&a<n+.001?n-1:Math.floor(a),o$[e]=a,oz[e]=Math.floor(t+i+r+1)}for(let e=0;e<3;++e){let t=a[4*e],i=a[4*e+1],r=a[4*e+2];oj[e]=t,oj[4+e]=-t,oj[8+e]=+i,oj[12+e]=-i,oj[16+e]=+r,oj[20+e]=-r}{let e=a[12],t=a[13],i=a[14];oj[3]=1+e,oj[7]=1-e,oj[11]=1+t,oj[15]=1-t,oj[19]=i,oj[23]=-i}oW(oj,i,n,Z.iG)}(this.projectionParameters.value,e.renderLayer.localPosition.value,e,t,()=>{i(e.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let e=0,t=0;for(let{visibleSources:i}of this.visibleLayers.values())for(let r of i){let i=oH(this.projectionParameters.value,r.chunkLayout),{source:n}=r,{chunks:s}=n;this.forEachVisibleChunk(r,i,i=>{let r=s.get(i);++t,r&&r.state===it.GPU_MEMORY&&++e})}return e===t}updateVisibleLayers;invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(e,t){t.push(e.localPosition.changed.add(()=>this.invalidateVisibleChunks())),t.push(e.redrawNeeded.add(this.viewChanged.dispatch)),t.push(e.transform.changed.add(this.updateVisibleLayers)),t.push(e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));let{renderScaleHistogram:i}=e;void 0!==i&&t.push(i.visibility.add(this.visibility)),t.push(e.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;let e=Date.now(),{visibleLayers:t,visibleLayerList:i}=this,{displayDimensionRenderInfo:r}=this.projectionParameters.value,n=this.rpc,s=!1;for(let a of(i.length=0,this.layerManager.readyRenderLayers()))if(a instanceof lf){i.push(a);let o=t.get(a);if(void 0===o){let i=[],n=new ik;o={messages:n,allSources:this.getTransformedSources(a,n),transformGeneration:a.transform.changed.count,visibleSources:[],disposers:i,lastSeenGeneration:e,displayDimensionRenderInfo:r},i.push(a.messages.addChild(o.messages)),t.set(a.addRef(),o),this.bindVisibleRenderLayer(a,i)}else{o.lastSeenGeneration=e;let t=a.transform.changed.count;if(o.transformGeneration===t&&o.displayDimensionRenderInfo===r)continue;let i=o.allSources;o.allSources=this.getTransformedSources(a,o.messages),lS(a,i),o.visibleSources.length=0,o.displayDimensionRenderInfo=r,o.transformGeneration=t}this.flushBackendProjectionParameters(),n.invoke("SliceView.addVisibleLayer",{id:this.rpcId,layerId:a.rpcId,sources:lb(o.allSources),displayDimensionRenderInfo:r}),s=!0}for(let[i,r]of t)r.lastSeenGeneration!==e&&(n.invoke("SliceView.removeVisibleLayer",{id:this.rpcId,layerId:i.rpcId}),t.delete(i),lS(i,r.allSources),(0,eh.k1)(r.disposers),i.dispose(),s=!0);return s&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),s}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(e){let{offscreenFramebuffersWithHistograms:t}=this,i=t[e];if(void 0===i){let{gl:r,histogramInputTextures:n,offscreenFramebuffer:s}=this;n.length<e&&n.push(...rI(r,e-n.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let a=[s.colorBuffers[0].addRef()];for(let t=0;t<e;++t)a.push(n[t].addRef());i=this.registerDisposer(new rP(r,{colorBuffers:a,depthBuffer:s.depthBuffer.addRef()})),t[e]=i}return i}updateRendering(){let e=this.projectionParameters.value,{width:t,height:i}=e;if(!this.renderingStale||!this.valid||0===t||0===i)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let{gl:r,offscreenFramebuffer:n}=this;n.bind(t,i),r.disable(r.SCISSOR_TEST),r.clearColor(0,0,0,0),r.colorMask(!0,!0,!0,!0),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let s=0,a=this.wireFrame.value,o={sliceView:this,projectionParameters:e,wireFrame:a};for(let e of this.visibleLayerList){let n=a?0:e.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(n).bind(t,i);for(let e=0;e<n;++e)r.clearBufferfv(WebGL2RenderingContext.COLOR,1+e,Z.Dv);r.enable(WebGL2RenderingContext.DEPTH_TEST),r.depthFunc(WebGL2RenderingContext.LESS),r.clearDepth(1),r.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),e.setGLBlendMode(r,s),e.draw(o),++s}r.disable(WebGL2RenderingContext.BLEND),r.disable(WebGL2RenderingContext.DEPTH_TEST),n.unbind()}disposed(){for(let[e,t]of this.visibleLayers)lS(e,t.allSources),(0,eh.k1)(t.disposers),e.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(e,t){let i=lk(this.projectionParameters.value.displayDimensionRenderInfo,e.transform.value,t=>e.getSources(t),t,e);for(let t of i)for(let i of t)e.addSource(i.source,i.chunkTransform);return i}}lw=function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([ij("SliceView")],lw);class lC extends ln{spec;constructor(e,t){super(e,t),this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){let t=ln.encodeOptions(e);return t.spec=lC.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}async fetchChunk(e,t,i){let r;let n=e.join(),s=this.chunks.get(n);if(void 0!==s&&s.state<=it.SYSTEM_MEMORY)return t(s);this.addRef();let{chunkRequesters:a}=this;void 0===a&&(a=this.chunkRequesters=new Map);let o=a.get(n);void 0===o&&(o=[],a.set(n,o));let l=new Promise(e=>{r=i=>e(t(i)),o.push(r)});try{return await this.rpc.promiseInvoke("ChunkManager.requestChunk",{source:this.rpcId,chunkGridPosition:e},i),await l}finally{let e=o.indexOf(r);o.splice(e,1),0===o.length&&a.delete(n),0===a.size&&(this.chunkRequesters=void 0),this.dispose()}}}class lx extends o9{chunkGridPosition;constructor(e,t){super(e),this.chunkGridPosition=t.chunkGridPosition,this.state=it.SYSTEM_MEMORY}}class lE extends eh.gj{gl;emitter;viewer;isProjection;copyVertexPositionsBuffer;textureCoordinateAdjustment;shaderGetter;defineShader(e,t,i,r){let n;e.addVarying("vec2","vTexCoord"),e.addUniform("sampler2D","uSampler"),e.addInitializer(e=>{this.gl.uniform1i(e.uniform("uSampler"),0)}),e.addUniform("vec4","uColorFactor"),e.addUniform("vec4","uBackgroundColor"),e.addUniform("mat4","uProjectionMatrix"),e.addUniform("vec4","uTextureCoordinateAdjustment"),e.require(r);let s=`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {`;n=t&&i?`
  discard;
}
else {
  emit(sampledColor * uColorFactor, 0u);
}
`:`
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`,e.setFragmentMain(`${s}${n}`),e.addAttribute("vec4","aVertexPosition"),e.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`)}constructor(e,t,i,r){super(),this.gl=e,this.emitter=t,this.viewer=i,this.isProjection=r,this.textureCoordinateAdjustment=new Float32Array(4),this.copyVertexPositionsBuffer=rb(this.gl),this.shaderGetter=rp(this,this.gl,{memoizeKey:"sliceview/SliceViewRenderHelper",parameters:this.viewer.hideCrossSectionBackground3D,getContextKey:({emitter:e,isProjection:t})=>`${ri(e)}${t}`,defineShader:(e,t,i)=>{this.defineShader(e,i,t.isProjection,t.emitter)}})}draw(e,t,i,r,n,s,a,o){let{gl:l,textureCoordinateAdjustment:d}=this;d[0]=n,d[1]=s,d[2]=a-n,d[3]=o-s;let u=this.shaderGetter({emitter:this.emitter,isProjection:this.isProjection}).shader;if(null===u)throw Error("Shader compilation failed in SliceViewRenderHelper.");u.bind(),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,e),l.disable(WebGL2RenderingContext.BLEND),l.uniformMatrix4fv(u.uniform("uProjectionMatrix"),!1,t),l.uniform4fv(u.uniform("uColorFactor"),i),l.uniform4fv(u.uniform("uBackgroundColor"),r),l.uniform4fv(u.uniform("uTextureCoordinateAdjustment"),d);let c=u.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(c,2),l.drawArrays(l.TRIANGLE_FAN,0,4),l.disableVertexAttribArray(c),l.bindTexture(l.TEXTURE_2D,null)}static get(e,t,i,r){return e.memoize.get(`sliceview/SliceViewRenderHelper:${ri(t)}`,()=>new lE(e,t,i,r))}}class lT{chunkManager;constructor(e){this.chunkManager=e}}function lk(e,t,i,r,n){r.clearMessages();let s=e=>(r.addMessage({severity:iT.error,message:e}),[]);if(void 0!==t.error)return s(t.error);let a=t.rank,o=t.unpaddedRank,{displayDimensionIndices:l,displayRank:d,canonicalVoxelFactors:u}=e,c=t8(t,l),{displayToLayerDimensionIndices:h}=c,p=new Float32Array(d*o),{modelToRenderLayerTransform:g}=t;for(let e=0;e<d;++e){let t=h[e];if(-1===t)continue;let i=u[e];for(let r=0;r<o;++r)p[d*r+e]=g[(a+1)*r+t]*i}let f=i({displayRank:d,multiscaleToViewTransform:p,modelChannelDimensionIndices:t.channelToRenderLayerDimensions}),{voxelPhysicalScales:m}=e;try{let e=e=>{let{chunkSource:i}=e,{spec:r}=i,{lowerClipBound:s=r.lowerVoxelBound,upperClipBound:a=r.upperVoxelBound}=e,l=t5(t,e.chunkToMultiscaleTransform),{chunkDataSize:u}=r,{channelToChunkDimensionIndices:h}=l,p=new Float32Array(o),g=new Float32Array(o);p.set(s),g.set(a);let f=h.length,{channelSpaceShape:v}=t;for(let e=0;e<f;++e){let i=h[e];if(-1===i)continue;let r=v[e];if(u[i]!==r)throw Error("Channel dimension "+t.layerDimensionNames[t.channelToRenderLayerDimensions[e]]+` has extent ${r} but corresponding chunk dimension has extent `+`${u[i]}`);p[i]=Number.NEGATIVE_INFINITY,g[i]=Number.POSITIVE_INFINITY}let y=t9(l,c),b=Z.R3.create(),S=Z.R3.create(),w=Z.R3.create(),C=Z.R3.create(),x=Z.R3.create(),{numChunkDisplayDims:E,chunkDisplayDimensionIndices:T}=y,{combinedGlobalLocalToChunkTransform:k,layerRank:D,combinedGlobalLocalRank:L}=l,I=new Float32Array(k);for(let e=0;e<E;++e){let t=T[e];for(let e=0;e<=L;++e)I[t+e*D]=0;t<o?(x[e]=r.chunkDataSize[t],b[e]=r.lowerChunkBound[t],S[e]=r.upperChunkBound[t],w[e]=s[t],C[e]=a[t],p[t]=Number.NEGATIVE_INFINITY,g[t]=Number.POSITIVE_INFINITY):(x[e]=1,b[e]=0,S[e]=1,w[e]=0,C[e]=1)}x.fill(1,E),b.fill(0,E),S.fill(1,E),w.fill(0,E),C.fill(1,E);let P=new oA.d(x,y.displaySubspaceModelMatrix,E),R=P.localSpatialVectorToGlobal(Z.R3.create(),Z.rn);for(let e=0;e<d;++e)R[e]=Math.abs(R[e]*m[e]);return R.fill(1,d),{layerRank:D,lowerClipBound:s,upperClipBound:a,nonDisplayLowerClipBound:p,nonDisplayUpperClipBound:g,renderLayer:n,source:i,lowerChunkDisplayBound:b,upperChunkDisplayBound:S,lowerClipDisplayBound:w,upperClipDisplayBound:C,effectiveVoxelSize:R,chunkLayout:P,chunkDisplayDimensionIndices:T,fixedLayerToChunkTransform:I,curPositionInChunks:new Float32Array(o),combinedGlobalLocalToChunkTransform:l.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(o),chunkTransform:l,chunkDisplayTransform:y}};return f.map(t=>t.map(t=>e(t)))}catch(r){for(let e of f)for(let{chunkSource:t}of e)t.dispose();let{globalDimensionNames:t}=e,i=Array.from(e.displayDimensionIndices.filter(e=>-1!==e),e=>t[e]).join(",\xa0");return s(`Cannot render (${i}) cross section: ${r.message}`)}}function lD(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}function lL(e){let t=0,{typeToIds:i}=e;for(let e of e_)t+=o6(e).pickIdsPerInstance*i[e].length;return t}class lI{buffer;bufferValid=!1;serializedAnnotations;numPickIds=0;constructor(e){this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){let{buffer:t}=this;void 0!==t&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}}class lP extends o9{data;constructor(e,t){super(e),void 0!==t.data&&(this.data=new lI(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;void 0!==t&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class lR extends lx{data;constructor(e,t){super(e,t),void 0!==t.data&&(this.data=new lI(t))}freeGPUMemory(e){super.freeGPUMemory(e);let{data:t}=this;void 0!==t&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class lA extends lC{parent;immediateChunkUpdates=!0;multiscaleToChunkTransform;constructor(e,t){super(e,t),(this.parent=t.parent).spatiallyIndexedSources.add(this);let{rank:i,chunkDataSize:r}=this.spec,n=this.multiscaleToChunkTransform=new Float32Array((i+1)**2);e9.SO(n,i+1,this.spec.chunkToMultiscaleTransform,i+1,i+1);for(let e=0;e<i;++e)for(let t=0;t<i+1;++t)n[(i+1)*t+e]/=r[e]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(e,t){t.parent=this.parent.rpcId,super.initializeCounterpart(e,t)}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new lR(this,e)}}lA=lD([ij("annotation.GeometryChunkSource")],lA);class lM extends ln{parent;relationshipIndex;immediateChunkUpdates;constructor(e,t,i){super(e,{}),this.parent=t,this.relationshipIndex=i,this.immediateChunkUpdates=!0}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new lP(this,e)}}lM=lD([ij("annotation.SubsetGeometryChunkSource")],lM);class lN extends o9{annotation;constructor(e,t){super(e),this.annotation=t.annotation}}class lV extends ln{parent;constructor(e,t){super(e),this.parent=t}getChunk(e){return new lN(this,e)}addChunk(e,t){super.addChunk(e,t);let{references:i}=this.parent,r=i.get(e);void 0!==r&&(r.value=t.annotation,r.changed.dispatch())}deleteChunk(e){let{references:t}=this.parent,i=t.get(e);void 0!==i&&(i.value=void 0,i.changed.dispatch())}}function lO(e,t,i,r){let n=new Uint8Array(e.data.length+r);for(let s of e_){if(s===i)continue;let a=e.typeToOffset[s],o=a;s>i&&(o+=r,e.typeToOffset[s]=o),n.set(e.data.subarray(a,a+e.typeToIds[s].length*t[s].serializedBytes),o)}return n}function lF(e,t,i,r,n,s,a,o){let l=e.typeToOffset[i],d=l,u=l,{propertyGroupBytes:c}=t[i],h=c.length,p=e.typeToIds[i].length;for(let t=0;t<h;++t){let i=c[t];r.set(e.data.subarray(d+n*i,d+s*i),u+a*i),d+=i*p,u+=i*o}}function lB(e,t,i){let r=t.type,{rank:n}=i[r],{serializedAnnotations:s}=e,a=s.typeToIds[r],o=s.typeToIdMaps[r],l=e1[r],d=i[r].serializedBytes,u=o.get(t.id);if(void 0===u){u=o.size,o.set(t.id,u);let e=lO(s,i,r,d);lF(s,i,r,e,0,u,0,u+1),a.push(t.id),s.data=e}let c=s.typeToOffset[r],h=new DataView(s.data.buffer,s.data.byteOffset,s.data.byteLength),p=eg===ep.LITTLE,g=i[r];l.serialize(h,c+g.propertyGroupBytes[0]*u,p,n,t),g.serialize(h,c,u,a.length,p,t.properties),e.bufferValid=!1}function l_(e,t,i,r){let{serializedAnnotations:n}=e,s=n.typeToIdMaps[t],a=s.get(i);if(void 0===a)return!1;let o=n.typeToIds[t],l=r[t].serializedBytes,d=lO(n,r,t,-l);lF(n,r,t,d,0,a,0,o.length-1),lF(n,r,t,d,a+1,o.length,a,o.length-1),o.splice(a,1),s.delete(i);for(let e=a,t=o.length;e<t;++e)s.set(o[e],e);return n.data=d,e.bufferValid=!1,!0}lV=lD([ij("annotation.MetadataChunkSource")],lV);class lU extends i${chunkManager;OPTIONS;key;metadataChunkSource;segmentFilteredSources;spatiallyIndexedSources;rank;relationships;properties;annotationPropertySerializers;constructor(e,t){super(),this.chunkManager=e,this.spatiallyIndexedSources=new Set,this.temporary=function(){let e=[],t=[],i=[];for(let r of e_)e[r]=[],t[r]=0,i[r]=new Map;return new lR(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:t,typeToIds:e,typeToIdMaps:i})}(),this.references=new Map,this.localUpdates=new Map,this.numCommitsInProgress=0,this.changed=new eO.K_,this.readonly=!1,this.metadataChunkSource=this.registerDisposer(new lV(this.chunkManager,this)),this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=ej(this.rank,this.properties);let i=this.segmentFilteredSources=[],{relationships:r}=t;this.relationships=r;for(let t=0,n=r.length;t<n;++t)i.push(this.registerDisposer(new lM(e,this,t)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw Error("not implemented")}temporary;references;localUpdates;initializeCounterpart(e,t){for(let t of(this.metadataChunkSource.initializeCounterpart(e,{}),this.segmentFilteredSources))t.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(e=>e.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=e6();let i=new eF(e.id);return i.value=e,this.references.set(i.id,i),i.registerDisposer(()=>{this.references.delete(i.id)}),this.applyLocalUpdate(i,!1,t,e),i}applyLocalUpdate(e,t,i,r){let{localUpdates:n}=this,{id:s}=e,a=this.localUpdates.get(s),o=e.value;if(null==o)throw Error("Cannot create local update from null annotation");if(void 0===a?(a={type:o.type,reference:e.addRef(),existingAnnotation:t?o:void 0,pendingCommit:void 0,commitInProgress:void 0},n.set(s,a),this.forEachPossibleChunk(o,e=>{let{data:t}=e;void 0!==t&&l_(t,o.type,s,this.annotationPropertySerializers)}),null!==r&&lB(this.temporary.data,r,this.annotationPropertySerializers)):(null===r?l_(this.temporary.data,o.type,o.id,this.annotationPropertySerializers):lB(this.temporary.data,r,this.annotationPropertySerializers),e.value=r),i){if(void 0!==a.commitInProgress)a.pendingCommit=r;else{if(null===r&&void 0===a.existingAnnotation){n.delete(s),a.reference.dispose();return}this.sendCommitRequest(a,r)}}this.notifyChanged(e.id,r||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke("annotation.commit",{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){let i=this.references.get(e),r=this.metadataChunkSource.chunks.get(e);void 0!==r&&(r.annotation=t||null),void 0!==i&&(i.value=t||null,i.changed.dispatch()),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}getReference(e){let t=this.references.get(e);if(void 0!==t)return t.addRef();t=new eF(e),this.references.set(e,t),this.rpc.invoke("annotation.reference.add",{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.rpc.invoke("annotation.reference.delete",{id:this.rpcId,annotation:e})});let i=this.metadataChunkSource.chunks.get(e);return void 0!==i&&(t.value=i.annotation),t}forEachPossibleChunk(e,t){let{relatedSegments:i}=e;if(void 0!==i){let e=i.length,{segmentFilteredSources:r}=this;for(let n=0;n<e;++n){let e=i[n];if(void 0===e)return;let s=r[n];for(let i of e){let e=s.chunks.get(ld(i));void 0!==e&&t(e)}}}let{rank:r}=this,n=new Float32Array(r),s=new Float32Array(r),a=new Float32Array(r);for(let i of this.spatiallyIndexedSources){switch(e.type){case eB.POINT:e9.DC(n,i.multiscaleToChunkTransform,r+1,e.point,r),s.set(n);break;case eB.LINE:case eB.AXIS_ALIGNED_BOUNDING_BOX:e9.DC(n,i.multiscaleToChunkTransform,r+1,e.pointA,r),e9.DC(s,i.multiscaleToChunkTransform,r+1,e.pointB,r);break;case eB.ELLIPSOID:e9.DC(n,i.multiscaleToChunkTransform,r+1,e.center,r),e9.lU(s,i.multiscaleToChunkTransform,r+1,e.radii,r);for(let e=0;e<r;++e){let t=n[e],i=s[e];n[e]=t-i,s[e]=t+i}}let o=1;for(let e=0;e<r;++e){let t=n[e],i=s[e],r=Math.min(t,i),a=Math.max(t,i);n[e]=Math.ceil(r-1),s[e]=Math.floor(a+1),o*=s[e]-n[e]}let{chunks:l}=i;for(let e=0;e<o;++e){let i=e;for(let e=0;e<r;++e){let t=n[e],r=s[e]-t,o=a[e]=i%r;i=(i-o)/r}let o=l.get(a.join());void 0!==o&&t(o)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){let i=this.localUpdates.get(e);if(void 0===i||void 0===i.commitInProgress)throw Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),null!==t&&i.reference.id!==t.id){if(null===i.commitInProgress)throw Error("Received invalid successful update notification");i.reference.id=t.id,this.references.delete(e),this.references.set(t.id,i.reference),this.localUpdates.delete(e),this.localUpdates.set(t.id,i),null!==i.reference.value&&(i.reference.value.id=t.id,l_(this.temporary.data,i.type,e,this.annotationPropertySerializers),lB(this.temporary.data,i.reference.value,this.annotationPropertySerializers)),i.reference.changed.dispatch()}i.existingAnnotation=t||void 0,i.commitInProgress=void 0;let{pendingCommit:r}=i;i.pendingCommit=void 0,null===t&&(r=void 0),void 0!==r?(null!==r&&(r.id=t.id),this.sendCommitRequest(i,r)):this.revertLocalUpdate(i)}numCommitsInProgress;commitStatus;disposed(){let{commitStatus:e}=this;void 0!==e&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,0===this.numCommitsInProgress?void 0!==this.commitStatus&&(this.commitStatus.dispose(),this.commitStatus=void 0):void 0===this.commitStatus&&(this.commitStatus=new s1(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){let i=this.localUpdates.get(e);if(void 0===i||void 0===i.commitInProgress)throw Error("Received invalid update notification");new s1().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(i),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){l_(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);let{existingAnnotation:t}=e;void 0!==t&&this.forEachPossibleChunk(t,e=>{let{data:i}=e;void 0!==i&&lB(i,t,this.annotationPropertySerializers)});let{reference:i}=e,{id:r}=i;i.value=t||null,i.changed.dispatch(),i.dispose(),this.localUpdates.delete(r)}changed;*[Symbol.iterator](){}readonly;childAdded;childUpdated;childCommitted;childDeleted}iO("annotation.commit",function(e){let t=this.get(e.id),i=e.annotationId,r=e.error;if(void 0!==r)t.handleFailedUpdate(i,r);else{let r=e.newAnnotation;t.handleSuccessfulUpdate(i,r)}});let l$={offset:0,completions:[]};function lz(e,t){return void 0===t?t:{...t,offset:t.offset+e}}function lG(e,t){let i=[];for(let r of t)r.startsWith(e)&&i.push({value:r});return i.sort((e,t)=>(0,s7.B)(e.value,t.value)),i}function lj(e,t,i,r){let n=[];for(let s of t){let t=i(s);t.startsWith(e)&&n.push({value:t,description:r(s)})}return n.sort((e,t)=>(0,s7.B)(e.value,t.value)),n}async function lW(e,t,i){if(e.startsWith("{"))return l$;let r=e.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],n=e.length-r.length,s=r.indexOf("=");if(-1===s){let e=await t(r);return{offset:e.offset+n,completions:e.completions.map(e=>({...e,value:`${e.value}=`}))}}return lz(n+s+1,await i(r.substring(0,s),r.substring(s+1)))}async function lq(e,t){return lW(e,async e=>{let i=[];for(let r of t){let t=r.key;t.value.startsWith(e)&&i.push(t)}return{offset:0,completions:i}},async(e,i)=>{for(let r of t)if(r.key.value===e)return{offset:0,completions:r.values.filter(e=>e.value.startsWith(i))};return l$})}async function lH(e,t){let i;let r=[],n=Number.POSITIVE_INFINITY;for(let e of(await Promise.allSettled(t))){if("rejected"===e.status)continue;let{value:t}=e;void 0!==t&&0!==t.completions.length&&(r.push(t),n=Math.min(n,t.offset))}if(0===r.length)return l$;if(1===r.length)return r[0];let s=[];for(let t of r)for(let r of(i=i??t.defaultCompletion,t.completions))t.offset!==n&&(r={...r,value:e.slice(n,t.offset)+r.value}),s.push(r);return{offset:n,completions:s,defaultCompletion:i}}let lJ="local://annotations",lK="local://equivalences";var lZ=((V={})[V.annotations=0]="annotations",V[V.equivalences=1]="equivalences",V);class lY{get scheme(){return"local"}get description(){return"Local in-memory"}async get(e){switch(e.url){case lJ:{let t;let{transform:i}=e;if(void 0===i){let{rank:i,names:r,scales:n,units:s}=e.globalCoordinateSpace.value,a=tw({rank:i,scales:n,units:s,names:r.map((e,t)=>`${t}`)}),o=tw({rank:i,scales:n,units:s,names:r});t={rank:i,sourceRank:i,inputSpace:a,outputSpace:o,transform:(0,e9.XD)(Float64Array,i+1)}}else t=tN(tx);return{modelTransform:t,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case lK:return{modelTransform:tN(tx),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:lj(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],e=>e.value,e=>e.description)}}}var lX=i(8709),lQ=i(6985),l0=i(6923);async function l1(e,t){let i,r,n;let{url:s,autoDetectDirectory:a}=t,{kvStoreContext:o}=e,l=(0,l0.kw)(s);if(l!==s){let e=(0,l0.mq)(l),n=o.getKvStoreAdapterProvider(e),a=s.slice(0,s.length-l.length-1),d=o.getKvStore(a);void 0!==n.completeUrl&&(r=(async()=>{let i=await n.completeUrl({url:e,base:d,signal:t.signal,progressListener:t.progressListener});return lz(s.length-l.length+e.scheme.length+1,i)})());try{i=n.getKvStore(e,d)}catch(e){if(void 0===r)throw e}}else{let e=(0,l0.mq)(l),n=o.getBaseKvStoreProvider(e);void 0!==n.completeUrl&&(r=(async()=>{let i=await n.completeUrl({url:e,signal:t.signal,progressListener:t.progressListener});return lz(e.scheme.length+1,i)})());try{i=n.getKvStore(e)}catch(e){if(void 0===r)throw e}}return void 0===i||i.store.getUrl(i.path)!==s||(n=(async()=>{let e;let r=await (0,lQ.RQ)(i.store,i.path,{signal:t.signal,progressListener:t.progressListener,responseKeys:"url"}),[,n,o]=l.match(/^((?:[a-zA-Z][a-zA-Z0-9-+.]*:)(?:.*\/)?)([^/]*)$/),d=s.length-o.length,u=[],c=s.length-l.length+n.length;for(let e of r.directories)u.push({value:e.substring(c)+"/"});if(!t.directoryOnly){let e=!0===t.singlePipelineComponent?"":"|";for(let t of r.entries)u.push({value:t.key.substring(c)+e})}if(void 0!==a&&""===o){let i=new Set,n=new Set;for(let e of r.entries)i.add(e.key.substring(c));for(let e of r.directories)n.add(e.substring(c));let o=await a().match({url:s,fileNames:i,subDirectories:n,signal:t.signal});for(let e of o)u.push({value:`|${e.suffix}`,description:e.description});1===o.length&&(e=`|${o[0].suffix}`)}return{offset:d,completions:u,defaultCompletion:e}})()),await lH(s,await Promise.all([r,n]))}async function l2(e,t){let{baseUrl:i,path:r}=t,{store:n,path:s}=e.kvStoreContext.getKvStore(i);if(!n.list)throw Error("Listing not supported");let a=s+r,o=Math.max(s.length,a.lastIndexOf("/")+1),l=await n.list(a,{signal:t.signal,progressListener:t.progressListener}),d=[];for(let e of l.directories)d.push({value:(0,l0.aU)(e.substring(o)+"/")});if(!t.directoryOnly)for(let e of l.entries)d.push({value:(0,l0.aU)(e.key.substring(o))});return{offset:o-s.length,completions:d}}var l3=i(4881);function l4(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}let l6=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/;class l5 extends eh.gj{sharedKvStoreContext;get credentialsManager(){return this.sharedKvStoreContext.credentialsManager}get chunkManager(){return this.sharedKvStoreContext.chunkManager}constructor(e){super(),this.sharedKvStoreContext=e,this.dataSources=new Map,this.kvStoreBasedDataSources=new Map,this.autoDetectRegistry=new l3._E}dataSources;kvStoreBasedDataSources;autoDetectRegistry;register(e){this.dataSources.set(e.scheme,e)}registerKvStoreBasedProvider(e){this.kvStoreBasedDataSources.set(e.scheme,e)}getProvider(e){let t=e.match(l6);if(null===t||void 0===t[1])throw Error('Data source URL must have the form "<scheme>://<path>".');let[,i,r]=t,n=this.dataSources.get(i);if(void 0===n)throw Error(`Unsupported data source: ${JSON.stringify(i)}.`);return[n,r,i]}async autoDetectFormat(e){let{matches:t,url:i}=await (0,l3.jv)({url:e.url,kvStoreContext:this.sharedKvStoreContext.kvStoreContext,signal:e.signal,progressListener:e.progressListener,autoDetectDirectory:()=>this.autoDetectRegistry.directorySpec,autoDetectFile:()=>this.autoDetectRegistry.fileSpec});if(1!==t.length){let i;throw i=0===t.length?"no format detected":`multiple formats detected: ${JSON.stringify(t)}`,Error(`Failed to auto-detect data source for ${JSON.stringify(e.url)}: ${i}`)}return`${i}|${t[0].suffix}`}async resolveKvStoreBasedDataSource(e){for(;;){let t=(0,l0.mq)((0,l0.kw)(e.url)),i=this.kvStoreBasedDataSources.get(t.scheme);if(void 0===i){let t=await this.autoDetectFormat(e);e={...e,url:t};continue}return await i.get({registry:this,url:t,kvStoreUrl:e.url.substring(0,e.url.length-t.url.length-1),signal:e.signal,progressListener:e.progressListener,state:e.state})}}async resolvePipeline(e){let t=(0,l0.pN)(e.url),i=t[0],r=i.scheme;if(void 0!==this.sharedKvStoreContext.kvStoreContext.baseKvStoreProviders.get(r))return await this.resolveKvStoreBasedDataSource(e);if(1!==t.length)throw Error(`${r}: scheme does not support | URL pipelines`);let n=i.suffix??"";if(!n.startsWith("//"))throw Error(`${r}: URLs must start with "${r}://"`);let s=n.substring(2);{let i=this.dataSources.get(r);if(void 0!==i)return await i.get({...e,url:t[0].url,providerScheme:r,providerUrl:s,registry:this,signal:e.signal??new AbortController().signal})}throw Error(`Unsupported scheme: ${r}:`)}async get(e){let t;let i=new Set,r=e.url;for(r=(r=r.trim()).replace(/\|+$/,"");;){i.add(r);let n=await this.resolvePipeline({...e,url:r});if(void 0===t&&(t=n.canonicalUrl),"targetUrl"in n){let{targetUrl:e}=n;if(i.has(e))throw Error(`Layer source redirection contains loop: ${JSON.stringify([...i,e])}`);if(i.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify([...i,e])}`);r=e;continue}return{...n,redirectLog:i,originalCanonicalUrl:t}}}convertLegacyUrl(e){try{let[t,i,r]=this.getProvider(e.url);if(void 0===t.convertLegacyUrl)return e.url;return t.convertLegacyUrl({...e,providerUrl:i,providerScheme:r,registry:this})}catch{return e.url}}async completeUrl(e){let{signal:t}=e,{url:i}=e,r=(0,l0.kw)(i),n=(0,l0.mq)(r),{scheme:s}=n;if(r===i&&!(n.suffix??"").startsWith("//")){let e=[],t=(t,i)=>{for(let r of t)i?.(r)!==!1&&e.push(r)};r===i?(t(this.sharedKvStoreContext.kvStoreContext.baseKvStoreProviders.values()),t(this.dataSources.values(),e=>!0!==e.hidden)):(t(this.kvStoreBasedDataSources.values()),t(this.sharedKvStoreContext.kvStoreContext.kvStoreAdapterProviders.values()));let n=r===i?"//":"";return{offset:i.length-r.length,completions:lj(s,e,({scheme:e})=>`${e}:${n}`,({description:e})=>e)}}if(void 0===n.suffix){let t=e.url.substring(0,e.url.length-r.length-1),{matches:s}=await (0,l3.jv)({url:t,kvStoreContext:this.sharedKvStoreContext.kvStoreContext,signal:e.signal,progressListener:e.progressListener,autoDetectDirectory:()=>this.autoDetectRegistry.directorySpec,autoDetectFile:()=>this.autoDetectRegistry.fileSpec});if(0===s.length)throw Error(`Failed to auto-detect data source for ${JSON.stringify(t)}`);return{offset:i.length-r.length,completions:lj(n.scheme,s,({suffix:e})=>e,({description:e})=>e)}}if(r===i){let i=this.dataSources.get(s);if(void 0!==i){if(void 0===i.completeUrl)return l$;let r=await i.completeUrl({registry:this,url:e.url,providerUrl:n.suffix.substring(2),signal:t??new AbortController().signal,progressListener:e.progressListener});return lz(s.length+3,r)}}{let a=this.kvStoreBasedDataSources.get(s);if(void 0!==a){if(void 0===a.completeUrl)return l$;let s=await a.completeUrl({registry:this,signal:t??new AbortController().signal,progressListener:e.progressListener,kvStoreUrl:i.substring(0,i.length-r.length-1),url:n});return lz(i.length-r.length+n.scheme.length+1,s)}}return await l1(this.sharedKvStoreContext,{url:i,signal:t,progressListener:e.progressListener,autoDetectDirectory:()=>this.autoDetectRegistry.directorySpec})}suggestLayerName(e){let t=(0,l0.pN)(e);for(let e=t.length-1;e>=0;--e){let{suffix:i}=t[e];if(i&&(i=i.replace(/^\/+/,"").replace(/\/+$/,"")))return function(e,t){let i=function(e,t){void 0===t&&(t=-1===e.indexOf("/")?":":"/");let i=e.lastIndexOf(t);return -1===i?0:i+1}(e,void 0);return e.substring(i)}(i)}}}class l8{base;scheme;constructor(e,t=e.scheme){this.base=e,this.scheme=t}get hidden(){return!0}get description(){return this.base.description}parseProviderUrl(e){if(e.includes("|"))throw Error("Only a single pipeline component supported");let{base:t,queryAndFragment:i}=(0,l0.kr)(e);return{kvStoreUrl:t,queryAndFragment:i,url:(0,l0.mq)(`${this.base.scheme}:${i}`)}}get(e){let{kvStoreUrl:t,url:i}=this.parseProviderUrl(e.providerUrl);return this.base.get({registry:e.registry,url:i,kvStoreUrl:t,state:e.state,signal:e.signal,progressListener:e.progressListener})}async completeUrl(e){let{kvStoreUrl:t,url:i,queryAndFragment:r}=this.parseProviderUrl(e.providerUrl);return""===r?await l1(e.registry.sharedKvStoreContext,{url:e.providerUrl,signal:e.signal,progressListener:e.progressListener,singlePipelineComponent:!0,directoryOnly:this.base.expectsDirectory}):this.base.completeUrl?this.base.completeUrl({registry:e.registry,signal:e.signal,progressListener:e.progressListener,kvStoreUrl:t,url:i}):l$}}function l9(e){return"boolean"==typeof e?{enabled:e}:((0,ef.PT)(e),{enabled:(0,ef.Kh)(e,"enabled",ef.JG)})}function l7(e,t){return"string"==typeof e?{url:e,transform:t,enableDefaultSubsources:!0,subsources:new Map}:((0,ef.PT)(e),{url:(0,ef.uq)(e,"url",ef.ZE),transform:(0,ef.uq)(e,"transform",tY)||t,enableDefaultSubsources:(0,ef.Kh)(e,"enableDefaultSubsources",ef.JG,!0),subsources:(0,ef.Kh)(e,"subsources",e=>(0,ef.ZI)(e,l9),new Map),state:(0,ef.Kh)(e,"state",ef.PT)})}function de(e){let t=tX(e.transform),i={},r=!0;for(let[t,n]of e.subsources){let e=n.enabled;void 0!==e&&(i[t]=e,r=!1)}return void 0===t&&r&&!0===e.enableDefaultSubsources&&void 0===e.state?e.url:{url:e.url,transform:t,subsources:r?void 0:i,enableDefaultSubsources:!0===e.enableDefaultSubsources&&void 0,state:e.state}}class dt{loadedDataSource;subsourceEntry;subsourceSpec;subsourceIndex;subsourceToModelSubspaceTransform;modelSubspaceDimensionIndices;enabled;activated;guardValues;messages;isActiveChanged;constructor(e,t,i,r,n){let s;this.loadedDataSource=e,this.subsourceEntry=t,this.subsourceSpec=i,this.subsourceIndex=r,this.activated=void 0,this.guardValues=[],this.messages=new ik,this.isActiveChanged=new eO.K_,s=void 0===i||void 0===i.enabled?t.default&&n:i.enabled;let a=e.dataSource.modelTransform.sourceRank,{modelSubspaceDimensionIndices:o}=t;if(void 0===o){o=Array(a);for(let e=0;e<a;++e)o[e]=e}let{subsourceToModelSubspaceTransform:l=e9.XD(Float32Array,o.length+1)}=t;this.enabled=s,this.subsourceToModelSubspaceTransform=l,this.modelSubspaceDimensionIndices=o,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),void 0!==this.activated){if((0,H.cO)(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t,e(this.activated=new eh.gj),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:iT.error,message:e});let{activated:t}=this;void 0!==t&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){let t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){let t=this.activated,{layer:i,transform:r}=this.loadedDataSource;return t.registerDisposer(t6(i.manager.root.coordinateSpace,i.localPosition.coordinateSpace,r,this,e))}}class di extends eh.gj{layerDataSource;dataSource;error;enabledSubsourcesChanged;activatedSubsourcesChanged;messages;transform;subsources;enableDefaultSubsources;get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}constructor(e,t,i){super(),this.layerDataSource=e,this.dataSource=t,this.error=void 0,this.enabledSubsourcesChanged=new eO.K_,this.activatedSubsourcesChanged=new eO.K_,this.messages=new ik,t.canChangeModelSpaceRank?(this.transform=new tq(tN(tw({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new tq(t.modelTransform),void 0!==i.transform&&(this.transform.spec=i.transform);let r=i.subsources;this.enableDefaultSubsources=i.enableDefaultSubsources,this.subsources=t.subsources.map((e,t)=>new dt(this,e,r.get(e.id),t,this.enableDefaultSubsources))}disposed(){for(let e of this.subsources){let{activated:t}=e;void 0!==t&&(e.activated=void 0,t.dispose())}}}class dr extends eh.gj{layer;changed;messages;progressListener;loadState_;spec_;specGeneration;refCounted_;constructor(e,t){super(),this.layer=e,this.changed=new eO.K_,this.messages=new ik,this.progressListener=new iL.Zi,this.loadState_=void 0,this.specGeneration=-1,this.refCounted_=void 0,this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),this.registerDisposer(e.messages.addChild(this.messages)),void 0===t?this.spec_=l4():this.spec=t}get spec(){let{loadState:e}=this;if(void 0!==e&&void 0===e.error){let t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let i=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==i?t.enabled:void 0}]})),state:this.spec.state})}return this.spec_}get loadState(){return this.loadState_}set spec(e){let{layer:t}=this;if(this.messages.clearMessages(),0===e.url.length){if(1!==t.dataSources.length){let e=t.dataSources.indexOf(this);if(-1!==e){t.dataSources.splice(e,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,void 0!==this.refCounted_&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}let i=new eh.gj,r=i.registerDisposer((0,eh.oq)(t.markLoading()));void 0!==this.refCounted_&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=i,this.spec_=e;let n=t.manager.dataSourceProviderRegistry,s=new AbortController;n.get({url:e.url,signal:s.signal,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform,state:e.state,progressListener:this.progressListener}).then(n=>{if(i.wasDisposed)return;this.messages.clearMessages();let s=i.registerDisposer(new di(this,n,e));s.registerDisposer(t.addCoordinateSpace(s.transform.outputSpace)),s.registerDisposer(s.transform.changed.add(this.changed.dispatch)),this.loadState_=s,s.registerDisposer(s.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),n.state&&i.registerDisposer(n.state.changed.add(()=>{this.spec.state=n.state?.toJSON(),t.specificationChanged.dispatch()}));let{originalCanonicalUrl:a}=n,o=this.layer.type;("auto"===o||"new"===o||e.setManually)&&void 0!==a&&a!==e.url&&(this.spec={...e,url:a}),r()}).catch(e=>{i.wasDisposed||(this.loadState_={error:e},this.messages.clearMessages(),this.messages.addMessage({severity:iT.error,message:i9(e)}),this.changed.dispatch())}),i.registerDisposer(()=>{s.abort()}),this.changed.dispatch()}disposed(){let e=this.refCounted_;void 0!==e&&e.dispose()}toJSON(){let{loadState:e}=this;return void 0===e||void 0!==e.error?de(this.spec):de({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{let i=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==i?t.enabled:void 0}]})),state:this.spec.state})}}let dn={side:"right",col:0,row:1/0,flex:1,size:300,minSize:100,visible:!1};class ds{defaultValue;value;changed;locationChanged;watchableVisible;constructor(e=dn,t=e){this.defaultValue=e,this.value=t,this.changed=new eO.MZ,this.locationChanged=new eO.MZ,this.locationChanged.add(this.changed.dispatch);let i=this;this.watchableVisible={get value(){return i.visible},set value(value){i.visible=value},changed:i.locationChanged}}toJSON(e=this.defaultValue){let t={},{value:i}=this;for(let r in i)i[r]!==e[r]&&(t[r]=i[r]);return t}get visible(){return this.value.visible}set visible(e){let{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(void 0===e)return;(0,ef.PT)(e);let i={side:(0,ef.Kh)(e,"side",e=>{if("left"!==e&&"right"!==e&&"top"!==e&&"bottom"!==e)throw Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(e)}`);return e},t.side),col:(0,ef.Kh)(e,"col",ef.jz,t.col),row:(0,ef.Kh)(e,"row",ef.jz,t.row),flex:(0,ef.Kh)(e,"flex",ef.jz,t.flex),size:(0,ef.Kh)(e,"size",ef.Sc,t.size),visible:(0,ef.Kh)(e,"visible",ef.JG,t.visible),minSize:t.minSize};this.value=i,this.locationChanged.dispatch()}}let da="tabs",dl="panels",dd={...dn,row:0},du={...dn,visible:!0,row:0};class dc extends eh.gj{panels;layer;location;constructor(e){super(),this.panels=e,this.location=new ds(du),this.tabsChanged=new eO.MZ,this.selectedTab=new J.SN(void 0),this.tabs=[],this.layer=this.panels.layer}initialize(){let{panels:e}=this;for(let t of(this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{e.specificationChanged.dispatch();let{layer:t}=this,{selectedLayer:i}=t.manager.root;if(i.layer?.layer!==t||this!==t.panels.panels[0])return;let r=this.location.value;i.location.value!==r&&(i.location.value=r,i.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{!this.location.visible&&this!==this.panels.panels[0]&&this.panels.removePanel(this)}),this.tabs)){let{hidden:e}=this.layer.tabs.options.get(t);e&&this.registerDisposer(e.changed.add(()=>{this.panels.updateTabs(),this.tabsChanged.dispatch()}))}}tabsChanged;selectedTab;explicitTabs;tabs;normalizeTabs(){let{tabs:e}=this;if(0===e.length){this.selectedTab.value=void 0;return}let t=this.layer.tabs.options,i=e=>t.get(e).order??0;e.sort((e,t)=>i(e)-i(t));let{selectedTab:r}=this,n=r.value;void 0!==n&&e.includes(n)||(r.value=e[0])}pin(){let{layer:e}=this,{selectedLayer:t}=e.manager.root;if(t.layer?.layer!==e||this!==e.panels.panels[0]||0===this.tabs.length)return;let{panels:i}=this,r=e.registerDisposer(new dc(i));i.panels.splice(0,1,r),i.panels.push(this),i.updateTabs(),r.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){let{panels:e}=this,t=e.panels.indexOf(this);if(-1===t||0===t)return;let{layer:i}=this,{selectedLayer:r}=i.manager.root,n=r.layer?.layer;r.visible&&null!=n&&n!==i&&n.panels.panels[0].pin(),e.panels.splice(t,1);let[s]=e.panels.splice(0,1,this);if(void 0===this.explicitTabs)i.unregisterDisposer(s);else{e.panels.push(s);for(let t=1,i=e.panels.length;t<i;++t){let i=e.panels[t];void 0===i.explicitTabs&&(i.explicitTabs=new Set(i.tabs))}}this.explicitTabs=void 0,e.updateTabs(),r.layer=i.managedLayer,r.location.value=this.location.value,r.location.locationChanged.dispatch(),r.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;let{panels:i}=this;{let{explicitTabs:t}=this;void 0!==t&&t.delete(e)}let{layer:r}=this,n=r.registerDisposer(new dc(i));n.location.value=t,n.explicitTabs=new Set([e]),i.panels.splice(1,0,n),i.updateTabs(),n.initialize(),r.manager.root.layerManager.layersChanged.dispatch(),i.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{let{explicitTabs:t}=this;void 0!==t&&t.delete(e)}{let{explicitTabs:i}=t;void 0!==i&&i.add(e)}let{panels:i}=this;i.updateTabs(),t.selectedTab.value=e,i.specificationChanged.dispatch()}mergeInto(e){let{explicitTabs:t}=e;if(void 0!==t)for(let e of this.tabs)t.add(e);let{panels:i}=this;i.removePanel(this)}}class dh{layer;panels;specificationChanged;updating;constructor(e){this.layer=e,this.specificationChanged=new eO.MZ,this.updating=!1,this.panels=[e.registerDisposer(new dc(this))]}restoreState(e){let{panels:t}=this;t[0].selectedTab.value=(0,ef.Kh)(e,"tab",ef.ZE);let{layer:i}=this,{tabs:r}=i,n=new Set(r.options.keys());(0,ef.Kh)(e,dl,e=>(0,ef.m7)(e,e=>{(0,ef.PT)(e);let r=new dc(this);r.location.restoreState(e),r.location.visible&&(r.selectedTab.value=(0,ef.Kh)(e,"tab",ef.ZE),r.explicitTabs=(0,ef.Kh)(e,da,e=>{let t=new Set;for(let i of(0,ef.zE)(e))n.has(i)&&(n.delete(i),t.add(i));return t}),void 0===r.explicitTabs?(r.tabs=Array.from(n),n.clear()):r.tabs=Array.from(r.explicitTabs),0!==r.tabs.length&&(r.normalizeTabs(),i.registerDisposer(r),r.initialize(),t.push(r)))})),t[0].tabs=Array.from(n),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;let t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){let{layer:e}=this,{tabs:t}=e,i=new Set(t.options.keys()),{panels:r}=this;this.updating=!0;let n=e=>{let t=e.tabs;if(void 0===e.explicitTabs)e.tabs=Array.from(i),i.clear();else for(let t of(e.tabs=Array.from(e.explicitTabs),e.tabs))i.delete(t);(0,H.cO)(t,e.tabs)||(e.normalizeTabs(),e.tabsChanged.dispatch())};for(let t=1;t<r.length;){let i=r[t];if(i.location.visible&&(n(i),0!==i.tabs.length)){++t;continue}r.splice(t,1),e.unregisterDisposer(i)}if(n(r[0]),0===r[0].tabs.length){let{selectedLayer:e}=this.layer.manager.root;e.layer?.layer===this.layer&&(e.location.visible=!1)}this.updating=!1}toJSON(){let{panels:e}=this,t={};if(t.tab=e[0].selectedTab.value,e.length>1){let i=[];for(let t=1,r=e.length;t<r;++t){let r=e[t],n=r.location.toJSON()??{};n.tab=r.selectedTab.value;let{explicitTabs:s}=r;void 0!==s&&(n[da]=Array.from(s)),i.push(n)}t[dl]=i}return t}}function dp(e,t){e.remove(t)}function dg(e,t){e.add(t)}let df="tool",dm="toolBindings",dv="localPosition",dy="localVelocity",db="localDimensions",dS="source",dw="pick";class dC{callbacks=[];defer(e){this.callbacks.push(e)}}let dx=[];class dE extends eh.gj{managedLayer;get localPosition(){return this.managedLayer.localPosition}get localVelocity(){return this.managedLayer.localVelocity}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}static type;static typeAbbreviation;get type(){return this.constructor.type}static supportsPickOption=!1;pick;selectionState;messages;initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=tp,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){let{rank:i}=e.localCoordinateSpace=this.localCoordinateSpace.value;if(0!==i){let r=(0,ef.Kh)(t,dv,e=>(0,ef.Iw)(new Float32Array(i),e,ef.jz));void 0===r?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=r)}void 0!==(e.annotationId=(0,ef.Kh)(t,"annotationId",ef.ZE))&&(e.annotationSourceIndex=(0,ef.Kh)(t,"annotationSource",ef.C$,0),e.annotationPartIndex=(0,ef.Kh)(t,"annotationPart",ef.C$),e.annotationSubsource=(0,ef.Kh)(t,"annotationSubsource",ef.ZE)),e.value=t.value}displaySelectionState(e,t,i){return!1}selectionStateToJson(e,t){let i={};if(e.localPositionValid){let{localPosition:t}=e;t.length>0&&(i.localPosition=Array.from(t))}return void 0!==e.annotationId&&(i.annotationId=e.annotationId,i.annotationPart=e.annotationPartIndex,i.annotationSource=e.annotationSourceIndex,i.annotationSubsource=e.annotationSubsource),null!=e.value&&(i.value=e.value),i}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;let i=this.localPosition.value,{localPosition:r}=e;r.length!==i.length?e.localPosition=i.slice():r.set(i),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;let i=t.localPosition,{localPosition:r}=e;r.length!==i.length?e.localPosition=i.slice():e.localPosition.set(i),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}layersChanged;readyStateChanged;specificationChanged;renderLayers;loadingCounter;get isReady(){return 0===this.loadingCounter}tabs;panels;tool;toolBinder;dataSourcesChanged;dataSources;get manager(){return this.managedLayer.manager}constructor(e){for(let t of(super(),this.managedLayer=e,this.pick=new i3(!0,!0),this.messages=new ik,this.layersChanged=new eO.K_,this.readyStateChanged=new eO.K_,this.specificationChanged=new eO.K_,this.renderLayers=[],this.loadingCounter=1,this.tabs=this.registerDisposer(new sD),this.panels=new dh(this),this.tool=this.registerDisposer(new av(this)),this.dataSourcesChanged=new eO.K_,this.dataSources=[],this.toolBinder=this.registerDisposer(new aS(this,this.manager.root.toolBinder)),this.localCoordinateSpaceCombiner.includeDimensionPredicate=t$,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.messages.changed.add(this.layersChanged.dispatch),dx))this.tabs.add(t.id,{label:t.label,order:t.order,getter:()=>t.getter(this)})}canAddDataSource(){return!0}addDataSource(e){let t=new dr(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){this.activateDataSubsources((function*(){for(let e of this.dataSources){let{loadState:t}=e;if(void 0!==t&&void 0===t.error)for(let e of t.subsources)if(e.enabled)yield e;else{let{activated:i}=e;e.messages.clearMessages(),void 0!==i&&(i.dispose(),e.activated=void 0,t.activatedSubsourcesChanged.dispatch())}}}).call(this))}decrementLoadingCounter(){0==--this.loadingCounter&&this.readyStateChanged.dispatch()}markLoading(){let e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return 1==++this.loadingCounter&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){let t=this.manager.root.coordinateSpaceCombiner.bind(e),i=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),i()}}initializationDone(){let e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,i,r){return void 0===e?[]:[l7(e,i)]}getDataSourceSpecifications(e){let t;let i=(0,ef.uq)(e,dS,e=>Array.isArray(e)?e.map(e=>l7(e)):"object"==typeof e?[l7(e)]:(t=e,[])),r=(0,ef.uq)(e,"transform",tZ);return i.push(...this.getLegacyDataSourceSpecifications(t,e,r,i)),0===(i=i.filter(e=>e.url)).length&&i.push(l4()),i}restoreState(e){for(let t of(this.tool.restoreState(e[df]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[db]),this.localPosition.restoreState(e[dv]),this.localVelocity.restoreState(e[dy]),this.toolBinder.restoreState(e[dm]),this.constructor.supportsPickOption&&this.pick.restoreState(e[dw]),this.getDataSourceSpecifications(e)))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);let{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){let{renderLayers:t,layersChanged:i}=this,r=t.indexOf(e);if(-1===r)throw Error("Attempted to remove invalid RenderLayer");t.splice(r,1),e.layerChanged.remove(i.dispatch),e.userLayer=void 0,e.dispose(),i.dispatch()}disposed(){let{layersChanged:e}=this;for(let t of((0,eh.k1)(this.dataSources),this.renderLayers))t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let i;let{renderLayers:r}=this,{pickedRenderLayer:n}=t;if(null!==n&&-1!==r.indexOf(n)&&(i=n.transformPickedValue(t),null!=(i=this.transformPickedValue(i))))return i;for(let t of r)if(null!=(i=t.getValueAt(e)))break;return this.transformPickedValue(i)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[dS]:function(e){if(0!==e.length)return 1===e.length?e[0].toJSON():e.map(e=>e.toJSON())}(this.dataSources),[df]:this.tool.toJSON(),[dm]:this.toolBinder.toJSON(),[db]:this.localCoordinateSpace.toJSON(),[dv]:this.localPosition.toJSON(),[dy]:this.localVelocity.toJSON(),[dw]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){let{globalPosition:i}=this.manager.root,{localPosition:r}=this;(0,H.zV)(i.value,t,e.globalToRenderLayerDimensions),(0,H.zV)(r.value,t,e.localToRenderLayerDimensions),r.changed.dispatch(),i.changed.dispatch()}}class dT extends eh.gj{manager;localCoordinateSpace;localCoordinateSpaceCombiner;localPosition;localVelocity;nonArchivedLayerIndex;readyStateChanged;layerChanged;specificationChanged;containers;layer_;get layer(){return this.layer_}unregisterUserLayer;set layer(e){let t=this.layer_;if(null!=t&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,null!=e){let t=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{t.forEach(e=>e())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){let{layer:e}=this;return e?.isReady}name_;get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}visible;archived;get supportsPickOption(){let e=this.layer;return null!==e&&e.constructor.supportsPickOption}get pickEnabled(){let e=this.layer;return null!==e&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){let t=this.layer;null!==t&&t.constructor.supportsPickOption&&(t.pick.value=e)}constructor(e,t){super(),this.manager=t,this.localCoordinateSpace=new tk,this.localCoordinateSpaceCombiner=new tJ(this.localCoordinateSpace,tU),this.localPosition=this.registerDisposer(new nT(this.localCoordinateSpace)),this.localVelocity=this.registerDisposer(new nI(this.localCoordinateSpace)),this.nonArchivedLayerIndex=-1,this.readyStateChanged=new eO.K_,this.layerChanged=new eO.K_,this.specificationChanged=new eO.K_,this.containers=new Set,this.layer_=null,this.visible=!0,this.archived=!1,this.name_=e,this.registerDisposer(new nR(this.manager.root.display,this.localPosition,this.localVelocity))}toJSON(){let e=this.layer;if(null===e)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(!0===e)for(let{layerManager:e}of(this.visible=!1,this.archived=!0,this.manager.root.subsets))e.has(this)&&e.removeManagedLayer(this);else{for(let{layerManager:e}of this.manager.root.subsets)e.has(this)||e.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}}class dk extends eh.gj{managedLayers=[];layerSet=new Set;layersChanged=new eO.K_;readyStateChanged=new eO.K_;specificationChanged=new eO.K_;boundPositions=new WeakSet;numDirectUsers=0;nonArchivedLayerIndexGeneration=-1;renderLayerToManagedLayerMapGeneration=-1;renderLayerToManagedLayerMap_=new Map;constructor(){super(),this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}scheduleRemoveLayersWithSingleRef=this.registerCancellable((0,ie.Z)(()=>this.removeLayersWithSingleRef(),0));updateNonArchivedLayerIndices(){let e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(let e of this.managedLayers)e.archived||(e.nonArchivedLayerIndex=t++);for(let e of this.managedLayers)e.archived&&(e.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(let i of this.managedLayers)if(!i.archived){if(t===e)return i;++t}}get renderLayerToManagedLayerMap(){let e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e)for(let i of(this.renderLayerToManagedLayerMapGeneration=e,t.clear(),this.managedLayers)){let e=i.layer;if(null!==e)for(let r of e.renderLayers)t.set(r,i)}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(i=>!!e(i)||(this.unbindManagedLayer(i),this.layerSet.delete(i),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){!(this.numDirectUsers>0)&&this.filter(e=>1!==e.refCount||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return 1==++this.numDirectUsers&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{0==--this.numDirectUsers&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,dg),this.layerSet.add(e),e.containers.add(this),void 0===t&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)e.visible&&e.layer&&(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,dp),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.manager.rootLayers.specificationChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){let t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(-1===t)throw Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){let i=this.managedLayers.length;if(e===t||e<0||e>=i||t<0||t>=i)return;let[r]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,r),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,i=0;for(;void 0!==this.getLayerByName(t);)t=e+ ++i;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(null!==t.layer)for(let e of t.layer.renderLayers)yield e}}}get visibleRenderLayers(){let e=this;return{*[Symbol.iterator](){for(let t of e.managedLayers)if(null!==t.layer&&t.visible)for(let e of t.layer.renderLayers)yield e}}}invokeAction(e){let t=new dC;for(let i of this.managedLayers){if(null===i.layer||!i.visible)continue;let r=i.layer;for(let i of(r.handleAction(e,t),r.renderLayers))i.handleAction(e)}for(let e of t.callbacks)e()}}class dD{changed=new eO.K_;coordinateSpace=tC;position=tp;unsnappedPosition=tp;active=!1;displayDimensions=void 0;pickedRenderLayer=null;pickedValue=0n;pickedOffset=0;pickedAnnotationLayer=void 0;pickedAnnotationId=void 0;pickedAnnotationBuffer=void 0;pickedAnnotationBufferBaseOffset=void 0;pickedAnnotationIndex=void 0;pickedAnnotationCount=void 0;pickedAnnotationType=void 0;pageX;pageY;forcerFunction=void 0;removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,void 0===e&&this.setActive(!1)}updateUnconditionally(){let{forcerFunction:e}=this;return void 0!==e&&(e(),this.active)}setActive(e){(this.active!==e||!0===e)&&(this.active=e,this.changed.dispatch())}}class dL extends eh.gj{layerManager;mouseState;changed;needsUpdate;constructor(e,t){super(),this.layerManager=e,this.mouseState=t,this.changed=new eO.K_,this.needsUpdate=!0,this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState,t=this.changed.count;if(e.active)for(let i of this.layerManager.managedLayers){let r=i.layer;if(i.visible&&null!==r){let{selectionState:i}=r;r.resetSelectionState(i),i.generation=t,r.captureSelectionState(i,e)}}}get(e){this.update();let{selectionState:t}=e;if(t.generation===this.changed.count)return t}toJSON(){this.update();let e={};for(let t of this.layerManager.managedLayers){let i=t.layer;if(i){let r=this.get(i);void 0!==r&&(e[t.name]=i.selectionStateToJson(r,!0))}}return e}}let dI={...dn,minSize:150,row:1},dP={...dI,visible:!0};class dR extends eh.gj{coordinateSpace;layerSelectedValues;changed;history;historyIndex;location;constructor(e,t){super(),this.coordinateSpace=e,this.layerSelectedValues=t,this.changed=new eO.K_,this.history=[],this.historyIndex=0,this.location=new ds(dI),this.pin=new J.SN(!0),this.registerDisposer((0,J.Uw)((e,i)=>{i||(this.capture(!0),e.registerDisposer(t.changed.add(e.registerCancellable((0,lX.Z)(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}value_;pin;get value(){return this.value_}goBack(){let e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return!!this.pin.value&&this.historyIndex+1<this.history.length}goForward(){if(!this.pin.value)return;let e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,void 0!==e&&this.pin.value){let{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>10&&t.splice(0,t.length-10),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,i=!0){if(!1===i&&(!this.location.visible||this.pin.value))return;let r={};e.initializeSelectionState(r),t(r)&&(this.location.visible=!0,!0===i?this.pin.value=!0:"toggle"===i&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:r}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){let e;let{value:t}=this;if(this.location.visible){if(e=this.location.toJSON(dP),this.pin.value&&void 0!==t){let i={};for(let e of t.layers){let{layer:t}=e,r=t.selectionStateToJson(e.state,!1);0===Object.keys(r).length&&(r=void 0),i[e.layer.managedLayer.name]=r}void 0!==t.position&&(e.position=Array.from(t.position)),e.layers=i}}else e=this.location.toJSON(dI),void 0!==(e=(0,ef.$Z)(e))&&(e.visible=!1);return e}select(){let{pin:e}=this;this.location.visible=!0,e.value=!e.value,e.value&&this.capture()}capture(e=!1){let t=function(e){let{mouseState:t}=e;if(!t.active)return;let i=[];for(let t of e.layerManager.managedLayers){let r=t.layer;if(null===r)continue;let n=e.get(r);if(void 0===n)continue;let s={};r.initializeSelectionState(s),r.copySelectionState(s,n),i.push({layer:r,state:s})}return{position:t.position.slice(),coordinateSpace:t.coordinateSpace,layers:i}}(this.layerSelectedValues);e&&void 0===t||(this.value=t)}restoreState(e){if(void 0===e){this.pin.value=!0,this.value=void 0;return}if(null===e){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}(0,ef.PT)(e),this.location.restoreState(e,dP);let t=this.coordinateSpace.value,i=(0,ef.Kh)(e,"position",e=>(0,ef.Iw)(new Float32Array(t.rank),e,ef.jz)),r=[];(0,ef.Kh)(e,"layers",e=>{(0,ef.PT)(e);let{layerManager:t}=this.layerSelectedValues;for(let[i,n]of Object.entries(e)){let e=t.getLayerByName(i);if(void 0===e)return;let s=e.layer;if(null===s)return;(0,ef.PT)(n);let a={};s.initializeSelectionState(a),s.selectionStateFromJson(a,n),r.push({layer:s,state:a})}}),this.pin.value=r.length>0||void 0!==i,this.value={position:i,coordinateSpace:t,layers:r}}}class dA extends eh.gj{view;messages;seenGeneration;state;constructor(e){super(),this.view=e,this.messages=new ik,this.seenGeneration=-1,this.state=void 0}}let dM=0;class dN extends eh.gj{layerManager;renderLayerType;view;roles;layerAdded;visibility;visibleLayers_;debouncedUpdateVisibleLayers;constructor(e,t,i,r,n,s){super(),this.layerManager=e,this.renderLayerType=t,this.view=i,this.roles=r,this.layerAdded=n,this.visibility=s,this.visibleLayers_=new Map,this.debouncedUpdateVisibleLayers=this.registerCancellable((0,ie.Z)(()=>this.updateVisibleLayers(),0)),this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(r.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){let e=++dM,{visibleLayers_:t,renderLayerType:i,layerAdded:r,roles:n}=this;for(let s of this.layerManager.readyRenderLayers())if(s instanceof i&&n.has(s.role)){let i=t.get(s);void 0===i&&((i=new dA(this.view)).registerDisposer(s.messages.addChild(i.messages)),i.registerDisposer(s.addRef()),i.registerDisposer(s.visibility.add(this.visibility)),t.set(s,i),r(s,i),s.attach(i)),i.seenGeneration=e}for(let[i,r]of t)r.seenGeneration!==e&&(t.delete(i),r.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}}function dV(e,t,i,r,n){return r.registerDisposer(new dN(e,t,r,i,(e,t)=>{t.registerDisposer(e.redrawNeeded.add(()=>r.scheduleRedraw()));let{backend:i}=e;i&&(i.rpc.invoke(iE.ny,{layer:i.rpcId,view:r.rpcId}),t.registerDisposer(()=>i.rpc.invoke(iE.ti,{layer:i.rpcId,view:r.rpcId}))),void 0!==n&&n(e,t),r.scheduleRedraw(),t.registerDisposer(()=>r.scheduleRedraw())},r.visibility))}class dO extends eh.gj{layerManager;changed;location;layer_;get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(!0===e&&void 0===t){let{managedLayers:i}=this.layerManager;i.length>0?t=this.layer=i[0]:e=!1}if(!0===e&&void 0!==t){let i=t.layer;(null===i||0===i.panels.panels[0].tabs.length)&&(e=!1)}this.visible!==e&&(this.location.visible=e,e||void 0===t||this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;let t=e.layer;null!==t&&t instanceof d2&&!t.dataSources.some(e=>0!==e.spec.url.length)&&dQ(e)}existingLayerDisposer;constructor(e){super(),this.layerManager=e,this.changed=new eO.K_,this.location=new ds(dd),this.registerDisposer(e),this.location.changed.add(()=>{this.changed.dispatch();let e=this.layer?.layer??void 0;if(void 0!==e){let t=this.location.value;if(t.visible){let i=e.panels.panels[0];i.location.value!==t&&(i.location.value=t,i.location.locationChanged.dispatch())}}})}set layer(e){if(e===this.layer_)return;let t=this.layer_;if(void 0!==t&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,void 0!==e){let t=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(t);let i=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{let r=e.layer;if(null!==r){let e=r.tool.value;void 0!==e&&e.deactivate()}e.unregisterDisposer(t),i()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){let e=this.location.toJSON();return void 0!==this.layer&&(e.layer=this.layer.name),(0,ef.$Z)(e)}restoreState(e){if(void 0===e){this.reset();return}(0,ef.PT)(e),this.location.restoreState(e);let t=(0,ef.uq)(e,"layer",ef.kt),i=void 0!==t?this.layerManager.getLayerByName(t):void 0;void 0===i&&(this.visible=!1),this.layer=i}reset(){this.location.reset(),this.layer=void 0}}class dF extends eh.gj{layerManager;filter;layerName_;layer_;changed;constructor(e,t){super(),this.layerManager=e,this.filter=t,this.changed=new eO.K_,this.validate=(0,ie.Z)(()=>{let{layerName_:e}=this;if(void 0!==e){let t=this.layerManager.getLayerByName(e);void 0!==t&&this.filter(t)?this.layer_=t:(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch()}},0),this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{let{layer_:e}=this;if(void 0!==e){if(this.layerManager.layerSet.has(e)&&this.filter(e)){let{name:t}=e;t!==this.layerName_&&(this.layerName_=t,this.changed.dispatch())}else this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch()}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(void 0!==e&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}validate;restoreState(e){let t=(0,ef.kt)(e);this.layerName=t}toJSON(){let{layer_:e}=this;return void 0!==e?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}}class dB extends eh.gj{layerManager;layer;predicate;getGroup;linkedLayers_;root_;changed;linkedLayersChanged;root;get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}constructor(e,t,i,r){super(),this.layerManager=e,this.layer=t,this.predicate=i,this.getGroup=r,this.linkedLayers_=new Set,this.changed=new eO.K_,this.linkedLayersChanged=new eO.K_,this.root_=t;let n=this;this.root={get value(){return n.root_},changed:n.changed}}reset(){this.isolate()}restoreState(e){if(void 0===e)return;let t=(0,ef.ZE)(e);this.linkByName(t)}toJSON(){let{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){let{getGroup:t,layer:i,root_:r}=this;if(r===i){let{linkedLayers_:e}=this;if(0!==e.size){for(let i of e){let e=t(i);e.root_=i,e.changed.dispatch()}e.clear(),this.linkedLayersChanged.dispatch()}return}let n=t(r);n.linkedLayers_.delete(i),n.linkedLayersChanged.dispatch(),this.root_=i,e&&this.changed.dispatch()}linkByName(e){let{layer:t}=this,{managedLayer:i}=t,{layerManager:r}=this,n=r.getLayerByName(e);if(void 0===n||n===i)return;let s=n.layer;null!==s&&this.predicate(s)&&this.linkToLayer(s)}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);let{getGroup:t}=this,i=t(e).root_;if(i===this.layer)return;let r=t(i);r.linkedLayers_.add(this.layer),r.linkedLayersChanged.dispatch(),this.root_=i,this.changed.dispatch()}disposed(){this.isolate(!1)}}function d_(e,t){let i=(0,ef.Kh)(t,"type",ef.ZE,"auto");e.archived=(0,ef.Kh)(t,"archived",ef.JG,!1),e.archived?e.visible=!1:e.visible=(0,ef.Kh)(t,"visible",ef.JG,!0);let r=dq.get(i)||d2;return e.layer=new r(e),t}function dU(e,t){try{let i=e.layer;if(null===i)return;i.restoreState(t),i.initializationDone()}catch(t){throw dQ(e),t}}function d$(e,t){try{(0,ef.PT)(t),d_(e,t),dU(e,t)}catch(t){throw dQ(e),t}}function dz(e,t,i){let r=new dT(t,e);return d$(r,i),r}class dG extends eh.gj{changed=new eO.K_}class dj extends dG{display;dataSourceProviderRegistry;layerManager;chunkManager;selectionState;selectedLayer;coordinateSpace;globalPosition;toolBinder;get rpc(){return this.chunkManager.rpc}get root(){return this}coordinateSpaceCombiner;subsets;layerSelectedValues;constructor(e,t,i,r,n,s,a,o,l){super(),this.display=e,this.dataSourceProviderRegistry=t,this.layerManager=i,this.chunkManager=r,this.selectionState=n,this.selectedLayer=s,this.coordinateSpace=a,this.globalPosition=o,this.toolBinder=l,this.subsets=new Set,this.coordinateSpaceCombiner=new tJ(a,tG),this.layerSelectedValues=n.layerSelectedValues,this.registerDisposer(i.layersChanged.add(this.changed.dispatch)),this.registerDisposer(i.specificationChanged.add(this.changed.dispatch))}reset(){this.layerManager.clear()}restoreState(e){let t;this.layerManager.clear(),Array.isArray(e)?t=e:((0,ef.PT)(e),t=Object.entries(e).map(([e,t])=>"string"==typeof t?{name:e,source:t}:((0,ef.PT)(t),{...t,name:e})));let i=[];for(let e of t){(0,ef.PT)(e);let t=this.layerManager.getUniqueLayerName((0,ef.uq)(e,"name",ef.ZE)),r=new dT(t,this);try{d_(r,e),this.layerManager.addManagedLayer(r),i.push({managedLayer:r,spec:e})}catch(e){r.dispose(),new s1().setErrorMessage(`Error creating layer ${JSON.stringify(t)}: `+(e instanceof Error)?e.message:""+e)}}for(let{managedLayer:e,spec:t}of i)try{dU(e,t)}catch(e){new s1().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(e instanceof Error)?e.message:""+e)}}add(e,t){-1===this.layerManager.managedLayers.indexOf(e)&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){let e=[],t=0;for(let i of this.layerManager.managedLayers){let r=i.toJSON();null!=r&&(e.push(r),++t)}if(0!==t)return e}get rootLayers(){return this.layerManager}}class dW extends dG{master;changed;get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}layerManager;constructor(e){super(),this.master=e,this.changed=new eO.K_,this.layerManager=this.registerDisposer(new dk),this.registerDisposer(e);let{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){let t=this.master.layerManager,i=[];for(let r of new Set((0,ef.m7)(e,ef.ZE))){let e=t.getLayerByName(r);if(void 0===e)throw Error(`Undefined layer referenced in subset specification: ${JSON.stringify(r)}`);e.archived||i.push(e)}for(let e of(this.layerManager.clear(),i))this.layerManager.addManagedLayer(e.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){-1===this.master.layerManager.managedLayers.indexOf(e)&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}}let dq=new Map,dH=new Map,dJ=[e=>{let{volume:t}=e;if(void 0===t)return;let i=dH.get(t.volumeType);if(void 0!==i)return{layerConstructor:i,priority:0}}];function dK(e,t=e.type){dq.set(t,e)}function dZ(e){dJ.push(e)}function dY(e,t){let i=e.layer;if(null===i)return;let r=i.toJSON(),n=new t(e);n.restoreState(r),n.initializationDone(),e.layer=n}function dX(e,t){return t!==e.name&&(t=e.manager.root.layerManager.getUniqueLayerName(t),e.name=t,e.layerChanged.dispatch(),!0)}function dQ(e){if(!e.wasDisposed)for(let t of e.containers)t.removeManagedLayer(e)}function d0(e,t){return void 0===e?t:void 0===t?e:e.priority<t.priority?t:e}function d1(e){let t;for(let i of e){let{subsourceEntry:e}=i,{subsource:r}=e;t=d0(t,function(e){let t;for(let i of dJ)t=d0(t,i(e));let{volume:i}=e;if(void 0!==i){let e=dH.get(i.volumeType);void 0!==e&&(t=d0(t,{layerConstructor:e,priority:0}))}return t}(r))}return t}class d2 extends dE{static type="new";static typeAbbreviation="new";detectedLayerConstructor;activateDataSubsources(e){this.detectedLayerConstructor=d1(e)?.layerConstructor}}function d3(e,t){let i=dz(e,"new layer",{type:"new"});e.add(i),t.layer=i,t.visible=!0}dK(d2),dK(class extends dE{static type="auto";static typeAbbreviation="auto";activateDataSubsources(e){let t=d1(e)?.layerConstructor;void 0!==t&&dY(this.managedLayer,t)}}),i(447);let d4="selectedAlpha",d6="notSelectedAlpha",d5="objectAlpha",d8="saturation",d9="hoverHighlight",d7="hideSegmentZero",ue="baseSegmentColoring",ut="ignoreNullVisibleSet",ui="segments",ur="equivalences",un="colorSeed",us="segmentColors",ua="meshRenderScale",uo="crossSectionRenderScale",ul="skeletonRendering",ud="codeVisible",uu="segmentQuery",uc="meshSilhouetteRendering",uh="linkedSegmentationGroup",up="linkedSegmentationColorGroup",ug="segmentDefaultColor",uf="anchorSegment",um="skeletonShaderControl";function uv(e,t,i,r){let n=document.createElement("label");n.classList.add("neuroglancer-layer-control-container");let s=document.createElement("div");s.classList.add("neuroglancer-layer-control-label-container");let a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label"),s.appendChild(a);let o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label-text-container"),o.appendChild(document.createTextNode(i.label)),a.appendChild(o),i.title&&(a.title=i.title),n.appendChild(s);let{control:l,controlElement:d}=i.makeControl(t,e,{labelContainer:s,labelTextContainer:o,display:t.manager.root.display,visibility:r});return d.classList.add("neuroglancer-layer-control-control"),d.draggable=!0,d.addEventListener("dragstart",e=>{e.stopPropagation(),e.preventDefault()}),n.appendChild(d),{controlContainer:n,label:a,labelContainer:s,labelTextContainer:o,control:l}}i(5621);class uy extends au{options;constructor(e,t){super(e),this.options=t}isLoading(){return!1}activate(e){if(this.isLoading())return;let{options:t}=this,{layer:i}=this,{isValid:r}=t;if(void 0!==r&&!r(i).value)return;let{header:n,body:s}=ak(e),{controlContainer:a,control:o,labelContainer:l}=uv(e,i,t,new iJ(iJ.VISIBLE));n.appendChild(l),s.appendChild(a),t.activateTool(e,o)}renderInPalette(e){if(this.isLoading())return;let{controlContainer:t}=uv(e,this.layer,this.options,new iJ(iJ.VISIBLE));return t.classList.add("neuroglancer-layer-options-control-container"),t}get description(){let{options:e}=this;return e.toolDescription??e.label}toJSON(){return this.options.toolJson}}function ub(e,t,i,r){let{controlContainer:n,label:s}=uv(e,t,i,r);return n.classList.add("neuroglancer-layer-options-control-container"),s.prepend(e.registerDisposer(new aC(t.toolBinder,i.toolJson,n)).element),n}function uS(e,t,i,r){let{isValid:n}=r;return void 0===n?ub(e,t,r,i):e.registerDisposer(new aB(n(t),(e,n,s)=>{e&&n.appendChild(ub(s,t,r,i))},i)).element}function uw(e,t){let{toolJson:i}=t,r="string"==typeof i?i:i.type;am(e,r,e=>new uy(e,t),(e,i)=>{let n=t.isValid?.(e);return(void 0!==n&&void 0!==i&&n.changed.addOnce(i),t.isValid?.(e).value===!1)?[]:[{type:r}]})}function uC(e){return{makeControl:(t,i)=>{let r=e(t),n=i.registerDisposer(new i4(r));return{control:n,controlElement:n.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}let ux=se.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function uE(e){return{makeControl:(t,i)=>{let r=e(t),n=i.registerDisposer(new a_(r));return{control:n,controlElement:n.element}},activateTool:(e,t)=>{e.bindInputEventMap(ux),e.bindAction("adjust-via-wheel",e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(e.detail)})}}}i(9177);class uT extends eh.gj{value;element;inputElement;numericInputElement;constructor(e,{min:t=0,max:i=1,step:r=.01}={}){super(),this.value=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input"),this.numericInputElement=document.createElement("input");let{element:n,inputElement:s,numericInputElement:a}=this;n.className="range-slider";let o=e=>{e.min=""+t,e.max=""+i,e.step=""+r,e.valueAsNumber=this.value.value,this.registerEventListener(e,"change",()=>this.inputValueChanged(e)),this.registerEventListener(e,"input",()=>this.inputValueChanged(e)),this.registerEventListener(e,"wheel",t=>{this.adjustViaWheel(e,t)})};s.type="range",o(s),a.type="number";let l=Math.max(t.toString().length,i.toString().length,Math.min(i,t+r).toString().length,Math.max(t,i-r).toString().length);a.style.width=l+2+"ch",o(a),n.appendChild(s),n.appendChild(a),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){let i=this.inputElement,{deltaY:r}=t;r>0?(i.stepUp(),this.inputValueChanged(e)):r<0&&(i.stepDown(),this.inputValueChanged(e))}disposed(){sy(this.element),super.disposed()}}let uk=se.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function uD(e){return{makeControl:(t,i)=>{let{value:r,options:n}=e(t),s=i.registerDisposer(new uT(r,n));return{control:s,controlElement:s.element}},activateTool:(e,t)=>{e.bindInputEventMap(uk),e.bindAction("adjust-via-wheel",e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(t.inputElement,e.detail)})}}}function uL(e,t){let i="";for(let r=0;r<=t&&parseFloat(i=e.toFixed(r))!==e;++r);return i}i(4282);let uI=se.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});class uP extends eh.gj{histogram;target;label;element;canvas;legend;legendRenderScale;legendSpatialScale;legendChunks;logScaleOrigin;unitOfTarget;ctx;hoverTarget;throttledUpdateView;debouncedUpdateView;adjustViaWheel(e){let t=this.getWheelMoveValue(e);if(0===t)return;this.hoverTarget.value=void 0;let i=Math.round(this.logScaleOrigin+20),r=eC([2**this.logScaleOrigin,2**(i-1)],this.target.value*2**Math.sign(t));this.target.value=r,e.preventDefault()}constructor(e,t){super(),this.histogram=e,this.target=t,this.label=document.createElement("div"),this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.legend=document.createElement("div"),this.legendRenderScale=document.createElement("div"),this.legendSpatialScale=document.createElement("div"),this.legendChunks=document.createElement("div"),this.logScaleOrigin=-4,this.unitOfTarget="px",this.ctx=this.canvas.getContext("2d"),this.hoverTarget=new J.SN(void 0),this.throttledUpdateView=this.registerCancellable((0,lX.Z)(()=>this.debouncedUpdateView(),200,{leading:!0,trailing:!0})),this.debouncedUpdateView=this.registerCancellable((0,ie.Z)(()=>this.updateView(),0));let{canvas:i,label:r,element:n,legend:s,legendRenderScale:a,legendSpatialScale:o,legendChunks:l}=this;r.className="neuroglancer-render-scale-widget-prompt",n.className="neuroglancer-render-scale-widget",n.title=uI.describe(),s.className="neuroglancer-render-scale-widget-legend",n.appendChild(r),n.appendChild(i),n.appendChild(s),a.title="Target resolution of data in screen pixels",l.title="Number of chunks rendered",s.appendChild(a),s.appendChild(l),s.appendChild(o),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new sa(i,uI)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));let d=e=>(function(e,t=-4){return 2**(.5*e+t)})(e.offsetX/i.width*40,this.logScaleOrigin);this.registerEventListener(i,"pointermove",e=>{this.hoverTarget.value=[d(e),e.offsetY]}),this.registerEventListener(i,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(ss(i,"set",e=>{this.target.value=d(e.detail)})),this.registerDisposer(ss(i,"adjust-via-wheel",e=>{this.adjustViaWheel(e.detail)})),this.registerDisposer(ss(i,"reset",e=>{this.reset(),e.preventDefault()}));let u=new ResizeObserver(()=>this.debouncedUpdateView());u.observe(i),this.registerDisposer(()=>u.disconnect()),this.updateView()}getWheelMoveValue(e){return e.deltaY}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){let e;let{ctx:t}=this,{canvas:i}=this,r=i.width=i.offsetWidth,n=i.height=i.offsetHeight,s=this.target.value,a=this.hoverTarget.value;{let{legendRenderScale:e}=this,t=function(e){if(e<1||e>1024){let t=0|Math.log2(e);return`${uL(e/2**t,1)}p${t}`}return Math.round(e)+""}(void 0===a?s:a[0]);e.textContent=t+" "+this.unitOfTarget}t.clearRect(0,0,r,n);let{histogram:o}=this,{value:l,spatialScales:d}=o;o.visibility.visible||l.fill(0);let u=Array.from(d.keys());u.sort();let c=Z.R3.create(),h=1,p=d.size,g=0,f=0;for(let e=0;e<40;++e){let t=0;for(let i=0;i<p;++i){let r=80*i+e,n=l[r],s=l[r+40];g+=n,f+=s,t+=n+s}h=Math.max(t,h)}f-=o.fakeChunkCount;let m=n/Math.log(1+h);function v(e){return n-Math.log(1+e)*m}if(void 0!==a){let t=Math.floor(lh(a[0],this.logScaleOrigin));if(t>=0&&t<40){let i=0,r=a[1];for(let n=p-1;n>=0;--n){let s=u[n],a=2*d.get(s)*40+t,o=l[a]+l[a+40];if(0===o)continue;let c=Math.round(v(i));if(Math.round(v(i+=o))<=r&&r<=c){e=s;break}}}}if(void 0!==e){g=0,f=0;let t=2*d.get(e)*40;for(let e=0;e<40;++e){let i=t+e;g+=l[i],f+=l[i+40]}Number.isFinite(e)?this.legendSpatialScale.textContent=ta(e,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${g}/${g+f}`;let y=u.map(t=>{let i;let r=t===e?.5:1;sp(c,i=Number.isFinite(t)?(.1*Math.log2(t)%1+1)%1:0,r,1);let n=er(c);return sp(c,i,r,.5),[n,er(c)]});for(let e=0;e<40;++e){let i=0;for(let n=p-1;n>=0;--n){let s=u[n],a=80*d.get(s)+e,o=l[a],c=l[a+40],h=o+c;if(0===h)continue;let p=Math.round(e*r/40),g=Math.round((e+1)*r/40),f=Math.round(v(i)),m=Math.round(v(i+=h)),b=(o*m+c*f)/h;t.fillStyle=y[n][1],t.fillRect(p,m,g-p,b-m),t.fillStyle=y[n][0],t.fillRect(p,b,g-p,f-b)}}{t.fillStyle="#fff";let e=lh(s,this.logScaleOrigin)*r/40;t.fillRect(Math.floor(e),0,1,n)}if(void 0!==a){let e=a[0];t.fillStyle="#888";let i=lh(e,this.logScaleOrigin)*r/40;t.fillRect(Math.floor(i),0,1,n)}}}let uR=se.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function uA(e,t=uP){return{makeControl:(i,r)=>{let{histogram:n,target:s}=e(i),a=r.registerDisposer(new t(n,s));return{control:a,controlElement:a.element}},activateTool:(e,t)=>{e.bindInputEventMap(uR),e.bindAction("adjust-via-wheel",e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(e.detail)}),e.bindAction("reset",e=>{e.stopPropagation(),e.preventDefault(),t.reset()})}}}i(1069);var uM=i(1607);let uN=se.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function uV(e){return{makeControl:(t,i)=>{let r=e(t),n=i.registerDisposer(new sg(r));return{control:n,controlElement:n.element}},activateTool:(e,t)=>{e.bindInputEventMap(uN),e.bindAction("adjust-via-wheel",e=>{e.stopPropagation(),e.preventDefault(),t.adjustHueViaWheel(e.detail)})}}}let uO=se.fromObject({escape:{action:"cancel"}});class uF extends eh.gj{model;element;constructor(e){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));let{element:t}=this;t.type="text",t.spellcheck=!1,t.autocomplete="off",this.registerDisposer(new aM(t,uO)).allShortcutsAreGlobal=!0,ss(t,"cancel",e=>{this.updateView(),t.blur(),e.stopPropagation(),e.preventDefault()}),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"blur",()=>this.updateModel()),this.updateView()}disposed(){sy(this.element)}updateView(){this.element.value=(this.model.value??"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}}function uB(e,t){t?e.displayState.segmentDefaultColor.value=Z.R3.fromValues(1,0,0):e.displayState.segmentDefaultColor.value=void 0}let u_=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:un,...function(){let e=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(t,i,{labelTextContainer:r})=>{let n=document.createElement("input");n.type="radio",n.addEventListener("change",()=>{uB(t,!n.checked)}),r.prepend(n);let s=document.createElement("div");s.classList.add("neuroglancer-segmentation-color-seed-control");let a=i.registerDisposer(new uF(t.displayState.segmentColorHash));s.appendChild(a.element);let o=sC({svg:uM,title:"Randomize",onClick:()=>e(t)});return s.appendChild(o),i.registerDisposer((0,J.Jk)(e=>{let t=void 0===e;s.style.visibility=t?"":"hidden",n.checked=t},t.displayState.segmentDefaultColor)),{controlElement:s,control:a}},activateTool:t=>{let{layer:i}=t.tool;uB(i,!1),e(i)}}}()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:ug,...function(){let e=uV(e=>e.displayState.segmentDefaultColor);return{...e,makeControl:(t,i,r)=>{let n=e.makeControl(t,i,r),{controlElement:s}=n,a=document.createElement("input");return a.type="radio",a.addEventListener("change",()=>{uB(t,a.checked),a.checked&&s.click()}),r.labelTextContainer.prepend(a),i.registerDisposer((0,J.Jk)(e=>{let t=void 0!==e;s.style.visibility=t?"":"hidden",a.checked=t},t.displayState.segmentDefaultColor)),n},activateTool:(t,i)=>{uB(t.tool.layer,!0),e.activateTool(t,i)}}}()},{label:"Saturation",toolJson:d8,title:"Saturation of segment colors",...uD(e=>({value:e.displayState.saturation}))},{label:"Opacity (on)",toolJson:d4,isValid:e=>e.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...uD(e=>({value:e.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:d6,isValid:e=>e.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...uD(e=>({value:e.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:uo,isValid:e=>e.has2dLayer,...uA(e=>({histogram:e.sliceViewRenderScaleHistogram,target:e.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:ua,isValid:e=>e.has3dLayer,...uA(e=>({histogram:e.displayState.renderScaleHistogram,target:e.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:d5,isValid:e=>e.has3dLayer,title:"Opacity of meshes and skeletons",...uD(e=>({value:e.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:uc,isValid:e=>e.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...uD(e=>({value:e.displayState.silhouetteRendering,options:{min:0,max:uU,step:.1}}))},{label:"Hide segment ID 0",toolJson:d7,title:"Disallow selection and display of segment id 0",...uC(e=>e.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:ue,title:"Color base segments individually",...uC(e=>e.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:ut,...uC(e=>e.displayState.ignoreNullVisibleSet)},{label:"Highlight on hover",toolJson:d9,title:"Highlight the segment under the mouse pointer",...uC(e=>e.displayState.hoverHighlight)},...u$("2d"),...u$("3d")],uU=10;function u$(e){return[{label:`Skeleton mode (${e})`,toolJson:`${ul}.mode${e}`,isValid:e=>e.hasSkeletonsLayer,...uE(t=>t.displayState.skeletonRenderingOptions[`params${e}`].mode)},{label:`Line width (${e})`,toolJson:`${ul}.lineWidth${e}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${e})`,title:`Skeleton line width (${e})`,...uD(t=>({value:t.displayState.skeletonRenderingOptions[`params${e}`].lineWidth,options:{min:1,max:40,step:1}}))}]}var uz=i(7688);function uG(e,t,i,r,n,s,a,o){let{lodScales:l}=e,d=0;for(;d+1<l.length&&0!==l[d+1];)++d;let u=[],c=0,h=0;function p(e,t){for(;;){if(0===c)return;let i=c-1,r=d-i,n=u[3*i],s=0===r?1:8,a=u[3*i+1],l=u[3*i+2];if(e===c){let e=t&s-1;h!==e&&-1!==n&&o(r,n,h,e,l),h=e+1;return}h!==s&&-1!==n&&o(r,n,h,s,l),h=a+1,--c}}let g=0,{octree:f}=e;!function(e,t,i,r,n,s,a){let{octree:o,lodScales:l,chunkGridSpatialOrigin:d,chunkShape:u}=e,c=l.length-1,h=t[0],p=t[4],g=t[8],f=t[1],m=t[5],v=t[9],y=t[3],b=t[7],S=t[11],w=t[15],C=y>0?0:1,x=b>0?0:1,E=S>0?0:1,T=i[16],k=i[17],D=i[18],L=i[19],I=-L*T*y+-L*k*b+-L*D*S+w,P=e.clipLowerBound[0],R=e.clipLowerBound[1],A=e.clipLowerBound[2],M=e.clipUpperBound[0],N=e.clipUpperBound[1],V=e.clipUpperBound[2],O=Math.max(Math.sqrt((h*n)**2+(f*s)**2),Math.sqrt((p*n)**2+(m*s)**2),Math.sqrt((g*n)**2+(v*s)**2));!function e(t,n,s){let c=1<<t,h=5*n,p=o[h],g=o[h+1],f=o[h+2],m=o[h+3],v=o[h+4],T=p*c*u[0]+d[0],k=g*c*u[1]+d[1],D=f*c*u[2]+d[2],L=T+c*u[0],F=k+c*u[1],B=D+c*u[2];if(T=Math.max(T,P),k=Math.max(k,R),D=Math.max(D,A),L=Math.min(L,M),F=Math.min(F,N),B=Math.min(B,V),(0,Z.Rq)(T,k,D,L,F,B,i)){var _,U,$;let i=Math.max(I,y*((_=T)+C*(L-_))+b*((U=k)+x*(F-U))+S*(($=D)+E*(B-$))+w)/O;if(0===s||i*r<s){let o=l[t];if(0!==o&&a(t,n,o/i,v>>>31),t>0&&(0===o||i*r<o)){let i=0===o?s:o,r=(0x7fffffff&v)>>>0;for(let n=m;n<r;++n)e(t-1,n,i)}}}}(c,o.length/5-1,0)}(e,t,i,r,n,s,(e,t,i,r)=>{if(!r&&!a(e,t,i)){g=Math.max(e,g);return}if(e<g)return;g=0;let n=5*t,s=f[n],o=1&s|f[n+1]<<1&2|f[n+2]<<2&4,l=d-e;p(l,o);let m=3*l;u[m]=r?-1:t,u[m+1]=o,u[m+2]=i,h=0,c=l+1}),p(0,0)}function uj(e,t,i){return`${e}/${t}:${i}`}class uW extends iQ{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}}var uq=i(1425);let uH=0n,uJ=0n;class uK{hashSeeds;loadFactor;size;table;tableSize;empty;maxRehashAttempts;maxAttempts;capacity;generation;mungedEmptyKey;constructor(e=uK.generateHashSeeds(3)){this.hashSeeds=e,this.loadFactor=.8,this.size=0,this.empty=0xffffffffffffffffn,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=uK.generateHashSeeds(e),this.mungedEmptyKey=void 0}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,i=Array(t);for(let e=0;e<t;++e)i[e]=this.getHash(e,this.empty);let{mungedEmptyKey:r}=this;if(void 0===r)i:for(;;){r=(0,em.ff)();for(let e=0;e<t;++e){let n=this.getHash(e,r);for(let e=0;e<t;++e)if(i[e]===n)continue i}this.mungedEmptyKey=r;break}let{table:n,empty:s}=this;for(let e=0;e<t;++e){let t=i[e];n[t]===s&&(n[t]=r)}try{e(n)}finally{for(let e=0;e<t;++e){let t=i[e];n[t]===r&&(n[t]=s)}}}static generateHashSeeds(e=3){return(0,eV.PP)(new Uint32Array(e))}getHash(e,t){let i=this.hashSeeds[e];return i=(0,uq.B)(i,Number(4294967295n&t)),i=(0,uq.B)(i,Number(t>>32n)),this.entryStride*(i&this.tableSize-1)}*keys(){let{empty:e,entryStride:t}=this,{table:i}=this;for(let r=0,n=i.length;r<n;r+=t){let t=i[r];t!==e&&(yield t)}}indexOf(e){let{table:t,empty:i}=this;if(e===i)return -1;for(let i=0,r=this.hashSeeds.length;i<r;++i){let r=this.getHash(i,e);if(t[r]===e)return r}return -1}chooseAnotherEmptyKey(){let e;let{empty:t,table:i,entryStride:r}=this;for(;(e=(0,em.ff)())===t||this.has(e););this.empty=e;for(let n=0,s=i.length;n<s;n+=r)i[n]===t&&(i[n]=e)}has(e){return -1!==this.indexOf(e)}delete(e){let t=this.indexOf(e);if(-1!==t){let{table:e}=this;return e[t]=this.empty,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,empty:t}=this;e.fill(t)}clear(){return 0!==this.size&&(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity&&(this.backupPending(),this.grow(e),this.restorePending(),!0)}swapPending(e,t){let i=uH;this.storePending(e,t),e[t]=i}storePending(e,t){uH=e[t]}backupPending(){uJ=uH}restorePending(){uH=uJ}tryToInsert(){let e=0,{empty:t,maxAttempts:i,table:r}=this,n=this.hashSeeds.length,s=Math.floor(Math.random()*n);for(;;){let a=this.getHash(s,uH);if(this.swapPending(r,a),uH===t)return!0;if(++e===i)break;s=(s+Math.floor(Math.random()*(n-1))+1)%n}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new BigUint64Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=void 0}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{empty:i,entryStride:r}=this;for(let t=0,n=e.length;t<n;t+=r)if(e[t]!==i&&(this.storePending(e,t),!this.tryToInsert()))return!1;return!0}grow(e){let t=this.table,{tableSize:i}=this;for(;i<e;)i*=2;for(;;){for(let e=0;e<this.maxRehashAttempts;++e)if(this.rehash(t,i))return;i*=2}}insertInternal(){for(++this.generation,uH===this.empty&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(2*this.tableSize),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class uZ extends uK{add(e){return!this.has(e)&&(uH=e,this.insertInternal(),!0)}[Symbol.iterator](){return this.keys()}}uZ.prototype.entryStride=1;let uY=0n,uX=0n;class uQ extends uK{set(e,t){return!this.has(e)&&(uH=e,uY=t,this.insertInternal(),!0)}get(e){let t=this.indexOf(e);if(-1!==t)return this.table[t+1]}swapPending(e,t){let i=uY;super.swapPending(e,t),e[t+1]=i}storePending(e,t){super.storePending(e,t),uY=e[t+1]}backupPending(){super.backupPending(),uX=uY}restorePending(){super.restorePending(),uY=uX}[Symbol.iterator](){return this.entries()}*entries(){let{empty:e,entryStride:t}=this,{table:i}=this;for(let r=0,n=i.length;r<n;r+=t){let t=i[r];if(t!==e){let e=i[r+1];yield[t,e]}}}}uQ.prototype.entryStride=2;class u0{texelsPerElement;textureInternalFormat;textureFormat;texelType;arrayElementsPerTexel;arrayConstructor;samplerPrefix}let u1=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],u2=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],u3=["","r","rg","rgb","rgba"],u4=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],u6=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],u5=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],u8=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],u9=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],u7=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],ce=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function ct(e){return e===el.FLOAT32?"":ed[e]?"i":"u"}function ci(e,t,i=1){switch(t){case el.UINT8:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=u4[i],e.textureFormat=u1[i],e.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,e.arrayElementsPerTexel=i,e.arrayConstructor=Uint8Array,e.samplerPrefix="u",e;case el.INT8:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=u6[i],e.textureFormat=u1[i],e.texelType=WebGL2RenderingContext.BYTE,e.arrayElementsPerTexel=i,e.arrayConstructor=Int8Array,e.samplerPrefix="i",e;case el.UINT16:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=u5[i],e.textureFormat=u1[i],e.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,e.arrayElementsPerTexel=i,e.arrayConstructor=Uint16Array,e.samplerPrefix="u",e;case el.INT16:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=u8[i],e.textureFormat=u1[i],e.texelType=WebGL2RenderingContext.SHORT,e.arrayElementsPerTexel=i,e.arrayConstructor=Int16Array,e.samplerPrefix="i",e;case el.UINT32:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=u9[i],e.textureFormat=u1[i],e.texelType=WebGL2RenderingContext.UNSIGNED_INT,e.arrayElementsPerTexel=1,e.arrayConstructor=Uint32Array,e.samplerPrefix="u",e;case el.INT32:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=u7[i],e.textureFormat=u1[i],e.texelType=WebGL2RenderingContext.INT,e.arrayElementsPerTexel=1,e.arrayConstructor=Int32Array,e.samplerPrefix="i",e;case el.UINT64:if(i<1||i>2)break;return e.texelsPerElement=1,e.textureInternalFormat=u9[2*i],e.textureFormat=u1[2*i],e.texelType=WebGL2RenderingContext.UNSIGNED_INT,e.arrayElementsPerTexel=2*i,e.arrayConstructor=Uint32Array,e.samplerPrefix="u",e;case el.FLOAT32:if(i<1||i>4)break;return e.texelsPerElement=1,e.textureInternalFormat=ce[i],e.textureFormat=u2[i],e.texelType=WebGL2RenderingContext.FLOAT,e.arrayElementsPerTexel=i,e.arrayConstructor=Float32Array,e.samplerPrefix="",e}throw Error(`No supported texture format for ${el[t]}[${i}].`)}function cr(e,t,i){let{arrayConstructor:r,arrayElementsPerTexel:n,textureInternalFormat:s,textureFormat:a,texelsPerElement:o}=t,{maxTextureSize:l}=e,d=i.BYTES_PER_ELEMENT/r.BYTES_PER_ELEMENT/n,u=i.length*d;if(u*o>l*l)throw Error("Number of elements exceeds maximum texture size: "+o+" * "+u);let c=Math.ceil(Math.log2(Math.ceil(u/l))),h=(1<<c)*o,p=Math.ceil(u/(1<<c));i.constructor!==r&&(i=new r(i.buffer,i.byteOffset,i.byteLength/r.BYTES_PER_ELEMENT));let g=(0,H.x0)(i,h*p*n);e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),rS(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,s,h,p,0,a,t.texelType,g)}function cn(e,t,i,r,n,s){let a=r6(n,s),o=[function(e){switch(e){case el.UINT8:return rG;case el.INT8:return rj;case el.UINT16:return rq;case el.INT16:return rH;case el.UINT32:return rJ;case el.INT32:return rK;case el.UINT64:return rN;case el.FLOAT32:return rW}}(n)],l=`
${a} ${e}(${r} index) {
`;switch(n){case el.UINT8:case el.UINT16:case el.UINT32:l+=`
  ${a} result;
  highp uvec4 temp;
  ${t}(${i}, index, temp);
  result.value = temp.${u3[s]};
  return result;
`;break;case el.INT8:case el.INT16:case el.INT32:l+=`
  ${a} result;
  highp ivec4 temp;
  ${t}(${i}, index, temp);
  result.value = temp.${u3[s]};
  return result;
`;break;case el.UINT64:o.push(rV),l+=`
  highp uvec4 temp;
  ${t}(${i}, index, temp);
  return unpackUint64leFromUint32(temp.${u3[2*s]});
`;break;case el.FLOAT32:o.push(rW),l+=`
  highp vec4 temp;
  ${t}(${i}, index, temp);
  return temp.${u3[s]};
`}return o.push(l+=`
}
`),o}class cs{key;readTextureValue;constructor(e){this.key=e,this.readTextureValue=`readTextureValue_${e}`}defineShader(e){}getReadTextureValueCode(e,t){let i=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let r=0;r<e;++r)i+=`, out ${t}vec4 output${r}`;i+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let t=0;t<e;++t)i+=`
  output${t} = texelFetch(sampler, ivec2(x + ${t}, y), 0);
`;return[rY,i+=`
}
`]}getAccessor(e,t,i,r=1){let n=ct(i);return[this.getReadTextureValueCode(1,n),...cn(e,this.readTextureValue,t,"highp uint",i,r)]}}class ca{key;textureDims;readTextureValue;constructor(e,t){this.key=e,this.textureDims=t,this.readTextureValue=`readTextureValue_${e}`}getReadTextureValueCode(e,t){let{textureDims:i}=this,r=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${i} p`;for(let i=0;i<e;++i)r+=`, out ${t}vec4 output${i}`;r+=`) {
`;for(let t=0;t<e;++t)r+=`
  output${t} = texelFetch(sampler, ivec${i}(p.x * ${e} + ${t}, p.y
                                         ${3===i?", p.z":""}), 0);
`;return r+`
}
`}getAccessor(e,t,i,r=1){let n=ct(i);return[this.getReadTextureValueCode(1,n),...cn(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,i,r)]}}let co=[rN,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],cl=ci(new u0,el.UINT64,1);class cd extends eh.gj{gl;hashTable;generation;texture;constructor(e,t){super(),this.gl=e,this.hashTable=t,this.generation=-1,this.texture=null,this.texture=e.createTexture()}copyToGPU(){let{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;let{gl:i,texture:r}=this;this.generation=t,i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r),e.tableWithMungedEmptyKey(e=>{cr(this.gl,cl,e)}),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){let{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new cd(e,t))}}class cu{prefix;numAlternatives;textureUnitSymbol;accessHelper;samplerName;hashSeedsName;hashKeyMask;readTable;constructor(e,t=3){this.prefix=e,this.numAlternatives=t,this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`),this.accessHelper=new cs(`gpuhashtable_${this.prefix}`),this.samplerName=e+"_sampler",this.hashSeedsName=e+"_seeds",this.hashKeyMask=e+"_keyMask",this.readTable=e+"_readTable"}defineShader(e){let{hashSeedsName:t,samplerName:i,numAlternatives:r,hashKeyMask:n}=this;e.addUniform("highp uint",t,r),e.addUniform("highp uint",n),e.addTextureSampler("usampler2D",i,this.textureUnitSymbol),e.addFragmentCode(co),e.addFragmentCode(rN),e.addFragmentCode(rO),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,el.UINT64,1));let s="";s+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let e=0;e<r;++e)s+=`
  {
    uint h = hashCombine(${t}[${e}], x) & ${n};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;s+=`
  return false;
}
`,e.addFragmentCode(s)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,i){i.copyToGPU();let r=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i.texture),e.uniform1ui(t.uniform(this.hashKeyMask),i.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),i.hashTable.hashSeeds)}disable(e,t){let i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}}class cc extends cu{defineShader(e){super.defineShader(e);let{numAlternatives:t,hashSeedsName:i,hashKeyMask:r}=this,n=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let e=0;e<t;++e)n+=`
  {
    uint h = hashCombine(${i}[${e}], x) & ${r};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;n+=`
  return false;
}
`,e.addFragmentCode(n)}get getFunctionName(){return`${this.prefix}_get`}}class ch{prefix;seedName;constructor(e){this.prefix=e,this.seedName=e+"_seed"}defineShader(e){let{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(rN),e.addFragmentCode(co),e.addFragmentCode(rM);let i=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec2 v;
`;for(let e=0;e<2;++e)i+=`
  v[${e}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;i+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(i)}enable(e,t,i){e.uniform1ui(t.uniform(this.seedName),i)}}let cp=new Float32Array(3);function cg(e){return`rgb(${100*e[0]}%,${100*e[1]}%,${100*e[2]}%)`}class cf{hashSeed;changed;constructor(e=(0,eV.ZU)()){this.hashSeed=e,this.changed=new eO.K_}static getDefault(){return new cf(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let i=(0,uq.B)(this.hashSeed,Number(4294967295n&t));return sp(e,(255&(i=(0,uq.B)(i,Number(t>>32n))))/255,.5+(i>>8&255)/255*.5,1),e}computeCssColor(e){return this.compute(cp,e),cg(cp)}randomize(){this.hashSeed=(0,eV.ZU)(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return 0===this.hashSeed?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){let t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}}class cm{prefix;hashMapShaderManager;constructor(e){this.prefix=e,this.hashMapShaderManager=new cc("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`
bool ${this.getFunctionName}(uint64_t x, out vec4 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    value.a = float((uintValue & 0xff000000u) >> 24) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,i){this.hashMapShaderManager.enable(e,t,i)}disable(e,t){this.hashMapShaderManager.disable(e,t)}}function cv(){return void 0===d&&(d=se.fromObject({"control+mousedown2":"select-position"})),d}function cy(){return void 0===c&&(c=se.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:dblclick0":"select","at:shift+dblclick0":"star","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[cv(),0]]})),c}i(532),i(5214);let cb="neuroglancer-drag-over",cS={row:"row",column:"col"},cw={left:"right",right:"left",top:"bottom",bottom:"top"},cC={left:"column",right:"column",top:"row",bottom:"row"},cx={left:"row",right:"row",top:"column",bottom:"column"},cE={row:"width",column:"height"},cT={row:"left",column:"top"},ck={row:"right",column:"bottom"},cD={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},cL={left:-1,right:1,top:-1,bottom:1};class cI extends eh.gj{sidePanelManager;location;element;visibility;getDragDropDescription(){return"side panel"}constructor(e,t=new ds){super(),this.sidePanelManager=e,this.location=t,this.element=document.createElement("div"),this.visibility=new iJ(iJ.VISIBLE);let{element:i}=this;i.classList.add("neuroglancer-side-panel"),i.draggable=!0,i.addEventListener("dragstart",e=>{this.sidePanelManager.startDrag(this.makeDragSource(),e),i.style.backgroundColor="black",setTimeout(()=>{i.style.backgroundColor=""},0),s6(e,i,"drag",`Drag ${this.getDragDropDescription()} to move it to the left/right/top/bottom of another panel`)}),i.addEventListener("dragend",e=>{this.sidePanelManager.endDrag(),s5(e,i,"drag")})}canCopy(){return!1}copyToNewLocation(e){}makeDragSource(){return{dropAsNewPanel:(e,t)=>{let i=this.location.value,r={...i,...e};if(console.log({oldLocation:i,newLocation:r}),"copy"===t){this.copyToNewLocation(r);return}this.location.value=r,this.location.locationChanged.dispatch()},getNewPanelDropEffect:e=>{let t=this.getDragDropDescription();return this.canCopy()?{description:t,...aa(e,"move",!0)}:{description:t,dropEffect:"move"}}}}close(){this.location.visible=!1}addTitleBar(e){let t;let i=document.createElement("div");i.classList.add("neuroglancer-side-panel-titlebar");let{title:r}=e;void 0!==r&&((t=document.createElement("div")).classList.add("neuroglancer-side-panel-title"),t.textContent=r,i.appendChild(t));let n=sY({title:"Close panel",onClick:()=>{this.close()}});return n.style.order="100",i.appendChild(n),this.element.appendChild(i),{titleBar:i,titleElement:t,closeButton:n}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",e=>{e.preventDefault(),e.stopPropagation()}),this.element.appendChild(e)}}class cP extends eh.gj{display;center;visibility;element;centerColumn;beforeRender;sides;registeredPanels;dragSource;layoutNeedsUpdate;get visible(){return this.visibility.visible}constructor(e,t,i=new iJ(iJ.VISIBLE)){super(),this.display=e,this.center=t,this.visibility=i,this.element=document.createElement("div"),this.centerColumn=document.createElement("div"),this.beforeRender=new eO.MZ,this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")},this.registeredPanels=new Set,this.layoutNeedsUpdate=!1,this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};let{element:r,centerColumn:n}=this;r.style.display="flex",r.style.flex="1",r.style.flexDirection="row",n.style.display="flex",n.style.flex="1",n.style.flexDirection="column",n.style.flexBasis="0px",n.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,cL[e]*(1/0),0,e,!1)}}hasDroppablePanel(){return void 0!==this.dragSource}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,i,r,n=!1){let s=document.createElement("div");s.className="neuroglancer-side-panel-drop-zone";let a=cC[r],l=cx[r];s.style[cE[l]]="10px",s.style[cE[a]]="100%",n?(s.style.position="absolute",s.style[r]="50%",s.style[cD[r]]="-${size/2}px"):(s.style.position="relative",s.style[cD[cw[r]]]="-10px");let d=e=>{let{dragSource:t}=this;if(void 0===t)return!1;e.preventDefault();let{dropEffect:i,description:r,dropEffectMessage:n,leaveHandler:o}=t.getNewPanelDropEffect(e);as(e,i);let l=`Drop to ${i} ${r} to new ${a}`;return n&&(l+=` (${n})`),s6(e,s,"drop",l,o),!0};return s.addEventListener("dragenter",e=>{d(e)&&(s.classList.add(cb),e.preventDefault())}),s.addEventListener("dragleave",e=>{s5(e,s,"drop"),s.classList.remove(cb)}),s.addEventListener("dragover",e=>{d(e)&&e.preventDefault()}),s.addEventListener("drop",r=>{let{dragSource:n}=this;if(void 0===n)return;s5(r,s,"drop"),s.classList.remove(cb);let a=cC[e];n.dropAsNewPanel({side:e,row:"column"===a?i:t,col:"row"===a?i:t},o??"none"),this.dragSource=void 0,r.preventDefault(),r.stopPropagation()}),s}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),e.panel?.dispose(),this.invalidateLayout()}disposed(){for(let{panel:e}of this.registeredPanels)e?.dispose();super.disposed()}invalidateLayout;render(){this.layoutNeedsUpdate=!1;let e={left:[],right:[],top:[],bottom:[]};for(let t of this.registeredPanels)e[t.location.value.side].push(t);let t=t=>this.renderSide(t,this.sides[t].flexGroups,e[t]),i=this;sS(this.element,function*(){yield i.sides.left.outerDropZoneElement,yield*t("left"),yield i.centerColumn,yield*t("right"),yield i.sides.right.outerDropZoneElement}()),sS(this.centerColumn,function*(){yield i.sides.top.outerDropZoneElement,yield*t("top"),yield i.center,yield*t("bottom"),yield i.sides.bottom.outerDropZoneElement}())}makeCrossGutter(e,t){let i=document.createElement("div");i.style.position="relative";let r=cx[e];i.className=`neuroglancer-resize-gutter-${"row"===r?"horizontal":"vertical"}`,i.addEventListener("pointerdown",n=>{if("button"in n&&0!==n.button)return;n.preventDefault();let s=this.sides[e].flexGroups[t];if(void 0===s||!s.visible)return;let a=s.element.getBoundingClientRect()[cE[r]],o=s.minSize,l=()=>{s6(n,i,"drag",`Drag to resize, current ${cE[r]} is ${s.crossSize}px`)};l(),so(n,(t,i,n)=>{a-=cL[e]*("row"===r?i:n),s.crossSize=Math.max(o,Math.round(a)),l(),this.invalidateLayout()},e=>{s5(e,i,"drag")})});let n=this.makeDropZone(e,t-.5*cL[e],0,e,!0);return i.appendChild(n),i}makeFlexGutter(e,t,i){let r=document.createElement("div");r.style.position="relative";let n=cC[e];r.className=`neuroglancer-resize-gutter-${"row"===n?"horizontal":"vertical"}`,r.addEventListener("pointerdown",s=>{if("button"in s&&0!==s.button)return;s.preventDefault();let a=this.sides[e].flexGroups[t];if(void 0===a||!a.visible)return;let{cells:o}=a,l=o[i];if(void 0===l||!l.registeredPanel.location.visible)return;let d=i+1;for(;d<o.length&&!o[d].registeredPanel.location.visible;)++d;if(d===o.length)return;let u=o[d],c=e=>{s6(e,r,"drag",`Drag to resize, current ${cE[n]} ratio is ${l.registeredPanel.location.value.flex} : ${u.registeredPanel.location.value.flex}`)};c(s),so(s,e=>{let t=l.registeredPanel.panel,i=u.registeredPanel.panel;if(void 0===t||void 0===i)return;let r=t.element.getBoundingClientRect(),s=i.element.getBoundingClientRect(),a=Math.max(.1,Math.min(.9,"column"===n?(e.clientY-r.top)/(s.bottom-r.top):(e.clientX-r.left)/(s.right-r.left))),o=l.registeredPanel.location.value,d=u.registeredPanel.location.value,h=o.flex+d.flex;l.registeredPanel.location.value={...o,flex:Math.round(a*h*100)/100},u.registeredPanel.location.value={...d,flex:Math.round((1-a)*h*100)/100},c(e),l.registeredPanel.location.locationChanged.dispatch(),u.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},e=>{s5(e,r,"drag")})});let s=this.makeDropZone(e,t,i+.5,cT[cC[e]],!0);return r.appendChild(s),r}renderSide(e,t,i){let r=cS[cx[e]],n=cS[cC[e]];i.sort((e,t)=>{let i=e.location.value,s=t.location.value,a=i[n]-s[n];return 0!==a?a:i[r]-s[r]});let s=this;return function*(){let a=0,o=i.length,l=0;for(;a<o;){let d=i[a].location.value[n],u=a,c=0,h=0;do{let e=i[u].location.value;if(e[n]!==d)break;e.visible&&(++c,h=Math.max(h,e.minSize)),++u}while(u<o);let p=c>0,g=t[l];if(void 0===g){let i=s.makeCrossGutter(e,l),r=document.createElement("div");r.className=`neuroglancer-side-panel-${cC[e]}`,g=t[l]={element:r,gutterElement:i,cells:[],crossSize:-1,minSize:h,visible:p,beginDropZone:s.makeDropZone(e,l,-1/0,cT[cC[e]]),endDropZone:s.makeDropZone(e,l,Infinity,ck[cC[e]])}}else g.visible=p,g.minSize=h,p||(g.crossSize=-1);sS(g.element,function*(){yield g.beginDropZone;let t=0;for(let o=a,d=0;o<u;++o,++d){let a=i[o],u=g.cells[d];void 0===u?u=g.cells[d]={registeredPanel:a,gutterElement:void 0}:u.registeredPanel=a;let p=u.registeredPanel.location.value;p.visible&&(g.crossSize=Math.max(h,-1===g.crossSize?p.size:g.crossSize)),(p[n]!==l||p[r]!==d||p.visible&&p.size!==g.crossSize)&&(u.registeredPanel.location.value={...p,[n]:l,[r]:d,size:p.visible?g.crossSize:p.size},u.registeredPanel.location.changed.dispatch());let f=p.visible&&s.visibility.visible,{panel:m}=a;if(!f){void 0!==m&&(m.dispose(),a.panel=void 0);continue}++t,void 0===m&&(m=a.panel=a.makePanel()),m.element.style.flex=c>1?`${p.flex}`:"1",yield m.element,t===c?u.gutterElement=void 0:(void 0===u.gutterElement&&(u.gutterElement=s.makeFlexGutter(e,l,d)),yield u.gutterElement)}yield g.endDropZone}()),g.cells.length=u-a,p&&(g.element.style[cE[cx[e]]]=`${g.crossSize}px`,cL[e]>0?(yield g.gutterElement,yield g.element):(yield g.element,yield g.gutterElement)),a=u,++l}t.length=l}()}}function cR(e={}){return sC({text:"↗",...e})}function cA(e){return e.closest(".neuroglancer-selection-details")}class cM extends cI{sidePanelManager;state;manager;selectedLayer;body;constructor(e,t,i,r){super(e,t.location),this.sidePanelManager=e,this.state=t,this.manager=i,this.selectedLayer=r,this.body=document.createElement("div");let{element:n,body:s}=this;n.classList.add("neuroglancer-selection-details"),this.registerDisposer(new sa(this.element,cv()));let{titleBar:a}=this.addTitleBar({title:"Selection"}),o=sC({svg:sf,title:"Previous selection",onClick:()=>{this.state.goBack()}}),l=sC({svg:sm,title:"Next selection",onClick:()=>{this.state.goForward()}});a.appendChild(o),a.appendChild(l),a.appendChild(this.registerDisposer(new aN(t.pin,{text:"\uD83D\uDCCC︎",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),s.classList.add("neuroglancer-selection-details-body"),this.addBody(s),s.appendChild(this.registerDisposer(new aB(t,(e,i,r)=>{if(!t.location.visible||(o.style.visibility=t.canGoBack()?"visible":"hidden",l.style.visibility=t.canGoForward()?"visible":"hidden",void 0===e))return;let{position:n}=e;if(void 0!==n){let t=document.createElement("div");t.classList.add("neuroglancer-selection-details-position");let r=aO({title:"Copy position",onClick:()=>{aI(a.map(e=>Math.floor(e)).join(", "))}});t.appendChild(r);let{coordinateSpace:{rank:n,names:s},position:a}=e;for(let e=0;e<n;++e){let i=document.createElement("span");i.classList.add("neuroglancer-selection-details-position-dimension");let r=document.createElement("span");r.classList.add("neuroglancer-selection-details-position-dimension-name"),r.textContent=s[e];let n=document.createElement("span");n.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),n.textContent=Math.floor(a[e]).toString(),i.appendChild(r),i.appendChild(n),t.appendChild(i)}let o=cR({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=a}});t.appendChild(o),i.appendChild(t)}for(let t of e.layers){let{layer:e}=t;i.appendChild(r.registerDisposer(new aB({value:void 0,changed:e.managedLayer.layerChanged},(i,r,n)=>{if(e.wasDisposed||!e.isReady)return;let s=document.createElement("div");if(s.classList.add("neuroglancer-selection-details-layer-body"),!e.displaySelectionState(t.state,s,n))return;let a=document.createElement("div");r.appendChild(a),a.classList.add("neuroglancer-selection-details-layer");let o=document.createElement("div");o.classList.add("neuroglancer-selection-details-layer-title"),o.textContent=e.managedLayer.name,o.addEventListener("click",()=>{this.selectedLayer.layer=e.managedLayer,this.selectedLayer.visible=!0}),o.title="Click to show layer side panel",a.appendChild(o),a.appendChild(s)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}}i(8468);var cN=i(8041);function cV(e={}){let t=sC({svg:cN,...e});return t.classList.add("neuroglancer-eye-icon"),t}var cO=i(194);i(1682);var cF=i(8086);function cB(e={}){let t=sC({svg:cF,...e});return t.classList.add("neuroglancer-star-icon"),t}class c_{key;value;label;constructor(e,t,i){this.key=e,this.value=t,this.label=i}toString(){let e;let{key:t,value:i,label:r}=this;return(e=void 0===i?`${t}`:`${t}→${i}`,void 0===r)?e:`${e} ${r}`}}class cU extends eh.gj{selectedSegment=0n;baseSelectedSegment=0n;hasSelectedSegment=!1;changed=new eO.K_;get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){let i;let{selectedSegment:r,baseSelectedSegment:n}=this,s=0n,a=0n;null==e?i=!1:"number"==typeof e?(s=a=(0,em.Fx)(e),i=!0):e instanceof c_?(s=e.value||e.key,a=e.key,i=!0):"bigint"==typeof e?(s=a=e,i=!0):i=!1,t&&0n===s&&(i=!1),i?i&&(!this.hasSelectedSegment||r!==s||n!==a)&&(this.selectedSegment=s,this.baseSelectedSegment=a,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&e===this.selectedSegment}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{let i;let r=e.get(t);void 0!==r&&(i=r.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}}function c$(e){e.useTemporarySegmentEquivalences.value=!1,e.useTemporaryVisibleSegments.value=!1,e.temporaryVisibleSegments.clear(),e.temporarySegmentEquivalences.clear()}function cz(e,t){let i,r,n;if(i="number"==typeof t?(0,em.Fx)(t):"string"==typeof t?(0,ef.tw)(t):t,null==e)return i;let{segmentEquivalences:s,segmentPropertyMap:{value:a}}=e.segmentationGroupState.value;0!==s.size?n=(r=s.get(i))===i?void 0:r:r=i;let o=a?.getSegmentLabel(r);return void 0===o&&void 0===n?i:new c_(i,n,o)}function cG(e,t){if(t instanceof c_)return t;let i=cz(e,t);return"bigint"==typeof i?new c_(i):i}function cj(e,t){let{length:i}=t;e.value<i&&(e.value=i)}function cW(e,t){return(0,J.Jk)(e=>t.style.setProperty("--neuroglancer-segment-list-width",`${e}ch`),e.segmentationGroupState.value.maxIdLength)}let cq=(()=>{let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry");let t=document.createElement("div");t.classList.add("neuroglancer-segment-list-entry-sticky"),e.appendChild(t);let i=aO({title:"Copy segment ID"});i.classList.add("neuroglancer-segment-list-entry-copy");let r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-copy-container");let n=r.childElementCount;r.appendChild(i);let s=t.childElementCount;t.appendChild(r);let a=t.childElementCount,o=cV({title:"Toggle segment visibility"});o.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),t.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-segment-list-entry-id-container");let d=t.childElementCount;t.appendChild(l);let u=document.createElement("div");u.classList.add("neuroglancer-segment-list-entry-id");let c=l.childElementCount;l.appendChild(u);let h=cB({title:"Star segment"});h.classList.add("neuroglancer-segment-list-entry-star");let p=t.childElementCount;t.appendChild(h);let g=document.createElement("span");g.classList.add("neuroglancer-segment-list-entry-name");let f=e.childElementCount;e.appendChild(g);let m=function(e={}){return sC({svg:cO,...e})}({title:"Filter by label"});m.classList.add("neuroglancer-segment-list-entry-filter");let v=e.childElementCount;return e.appendChild(m),{template:e,copyContainerIndex:s,copyIndex:n,visibleIndex:a,idContainerIndex:d,idIndex:c,labelIndex:f,filterIndex:v,starIndex:p,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),cH=(()=>{let e=cq.template.cloneNode(!0),t=e.children[0],i=t.children[cq.idContainerIndex],r=i.childElementCount,n=i.children[cq.idIndex].cloneNode(!0);n.classList.add("neuroglancer-segment-list-entry-unmapped-id"),i.appendChild(n);let s=t.children[cq.copyContainerIndex],a=s.childElementCount;return s.appendChild(s.children[cq.copyIndex].cloneNode(!0)),{...cq,template:e,unmappedIdIndex:r,unmappedCopyIndex:a}})(),cJ=new WeakMap;class cK{displayState;template;registerEventHandlers;constructor(e,t){if(this.displayState=e,this.template=t,void 0!==e){let t=cJ.get(e);void 0===t&&(t=function(e){let t=t=>{let i=t.currentTarget,r=BigInt(i.dataset.id);e.segmentSelectionState.set(r),cA(i)||e.selectSegment(r,!1)},i=t=>{let i=t.currentTarget,r=BigInt(i.dataset.id);e.selectSegment(r,!cA(i)||"toggle")},r=()=>{e.segmentSelectionState.set(null)},n=e=>e.currentTarget.closest(".neuroglancer-segment-list-entry"),s=e=>{aI(n(e).dataset.id),e.stopPropagation()},a=e=>{aI(n(e).dataset.unmappedId),e.stopPropagation()},o=t=>{let i=BigInt(n(t).dataset.id),{selectedSegments:r,visibleSegments:s}=e.segmentationGroupState.value,a=!s.has(i);a&&r.add(i),s.set(i,a),t.stopPropagation(),t.preventDefault()},l=t=>{let i=BigInt(n(t).dataset.id);e.filterBySegmentLabel(i),t.stopPropagation()},d=t=>{if(2!==t.button||t.ctrlKey||t.altKey||t.metaKey||t.shiftKey)return;let i=BigInt(t.currentTarget.dataset.id);e.moveToSegment(i)};return(u,c)=>{let{children:h}=u,p=h[0].children;u.addEventListener("mousedown",d);let g=p[c.copyContainerIndex];-1!==c.unmappedCopyIndex&&g.children[c.unmappedCopyIndex].addEventListener("click",a),g.children[c.copyIndex].addEventListener("click",s),u.addEventListener("mouseenter",t),u.addEventListener("mouseleave",r),p[c.visibleIndex].addEventListener("click",o),h[c.filterIndex].addEventListener("click",l),u.addEventListener("action:select-position",i),p[c.starIndex].addEventListener("click",t=>{let i=BigInt(n(t).dataset.id),{selectedSegments:r}=e.segmentationGroupState.value;r.set(i,!r.has(i))})}}(e),cJ.set(e,t)),this.registerEventHandlers=t}}static make(e,t){return new cK(e,t?cH:cq)}get(e){let{displayState:t}=this;return this.getWithNormalizedId(cG(t,e))}getWithNormalizedId(e){let{displayState:t}=this,{template:i}=this,r=i.template.cloneNode(!0),n=e.key,s=e.value??n,a=s.toString();r.dataset.id=a;let{children:o}=r,l=o[0].children,d=l[i.idContainerIndex];d.children[i.idIndex].textContent=a;let{unmappedIdIndex:u}=i;if(void 0!==t?this.registerEventHandlers(r,i):l[i.visibleIndex].style.display="none",-1!==u){let e=d.children[u];if(n!==s){let i=n.toString();r.dataset.unmappedId=i,e.textContent=i,void 0!==t&&cj(t.segmentationGroupState.value.maxIdLength,i)}else e.style.display="none",l[i.copyContainerIndex].children[i.unmappedCopyIndex].style.display="none"}return o[i.labelIndex].textContent=e.label??"",void 0!==t&&(this.updateWithId(r,s),cj(t.segmentationGroupState.value.maxIdLength,a)),r}update(e){let t=e.dataset.id;if(void 0===t)return;let i=BigInt(t);this.updateWithId(e,i)}updateWithId(e,t){let{children:i}=e,r=i[0].children,{template:n}=this,{displayState:s}=this,{segmentSelectionState:a}=s,{visibleSegments:o}=s.segmentationGroupState.value;r[n.visibleIndex].classList.toggle("neuroglancer-visible",o.has(t)),e.dataset.selected=(a.hasSelectedSegment&&a.selectedSegment===t).toString();let{selectedSegments:l}=s.segmentationGroupState.value;r[n.starIndex].classList.toggle("neuroglancer-starred",l.has(t));let d=r[n.idContainerIndex];cZ(d.children[n.idIndex],c3(this.displayState,t));let{unmappedIdIndex:u}=n;if(-1!==u){let t,i;if(s.baseSegmentColoring.value&&void 0!==(t=e.dataset.unmappedId)){let e=BigInt(t);i=c3(this.displayState,e)}else i=Z.rn;cZ(d.children[u],i)}}}function cZ(e,t){e.style.backgroundColor=cg(t),e.style.color=es(t)?"white":"black"}class cY extends cK{segmentPropertyMap;numericalProperties;numericalPropertyWidths;parentElement;constructor(e,t,i){let r=e.segmentationGroupState.value.segmentPropertyMap.value,n=(r?.numericalProperties??[]).filter(i);super(e,function(e){let t=cq.template.cloneNode(!0),i=[];for(let r=0;r<e;++r){i.push(t.childElementCount);let e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-extra-property"),e.style.width=`max(var(--neuroglancer-column-${r}-width), var(--neuroglancer-column-${r}-label-width))`,t.appendChild(e)}return{...cq,template:t,numericalPropertyIndices:i}}(n.length)),this.parentElement=t,this.segmentPropertyMap=r,this.numericalProperties=n,(this.numericalPropertyWidths=Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){let t=super.getWithNormalizedId(e),{numericalProperties:i}=this,{numericalPropertyIndices:r}=this.template;if(r.length>0){let n=this.segmentPropertyMap?.getSegmentInlineIndex(e.value??e.key)??-1;if(-1!==n){let{numericalPropertyWidths:e}=this;for(let s=0,a=r.length;s<a;++s){let a=i[s].values[n];if(!Number.isNaN(a)){let i=a.toString(),n=i.length;n>e[s]&&(e[s]=n,this.parentElement.style.setProperty(`--neuroglancer-column-${s}-width`,`${n}ch`)),t.children[r[s]].textContent=i}}}}return t}makeHeaderLabel(e,t,i){let r=document.createElement("span");r.textContent=e,r.classList.add("neuroglancer-segment-list-header-label"),r.classList.add("neuroglancer-segment-list-header-label"),"label"===e&&(i.style.textAlign="left");let n=document.createElement("span");n.classList.add("neuroglancer-segment-list-header-label-sort"),r.appendChild(n),n.textContent="▲";let s=function(e){let t=e.cloneNode(!0);return t.style.position="absolute",document.body.appendChild(t),t.getBoundingClientRect()}(r).width;return this.parentElement.style.setProperty(t,`${s}px`),i.appendChild(r),{id:e,label:r,sortIcon:n}}getHeader(){let{template:e}=this,t=e.template.cloneNode(!0),{children:i}=t,r=i[0].children;r[e.copyContainerIndex].style.visibility="hidden",r[e.visibleIndex].style.visibility="hidden",i[e.filterIndex].style.visibility="hidden";let n=r[e.idContainerIndex],s=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",n.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",i[e.labelIndex])],{numericalProperties:a}=this,{numericalPropertyIndices:o}=this.template;for(let e=0,i=o.length;e<i;++e){let i=a[e],r=this.makeHeaderLabel(i.id,`--neuroglancer-column-${e}-label-width`,t.children[o[e]]),{description:n}=i;n&&(r.label.title=n),s.push(r)}return{container:t,propertyLabels:s}}}function cX(e,t){return cK.make(e??void 0,!0).getWithNormalizedId(t)}function cQ(e,t,i){t.registerDisposer((0,J.w)((e,t)=>{e.registerDisposer(t.visibleSegments.changed.add(i)),e.registerDisposer(t.segmentEquivalences.changed.add(i))},e.segmentationGroupState)),t.registerDisposer((0,J.w)((e,t)=>{e.registerDisposer(t.segmentColorHash.changed.add(i)),e.registerDisposer(t.segmentDefaultColor.changed.add(i))},e.segmentationColorGroupState)),t.registerDisposer(e.saturation.changed.add(i)),t.registerDisposer(e.segmentSelectionState.changed.add(i)),t.registerDisposer(e.baseSegmentColoring.changed.add(i)),t.registerDisposer(e.hoverHighlight.changed.add(i))}function c0(e,t){let i=t.redrawNeeded.dispatch;cQ(e,t,i),t.registerDisposer((0,J.w)((e,t)=>{e.registerDisposer(t.temporaryVisibleSegments.changed.add(i)),e.registerDisposer(t.temporarySegmentEquivalences.changed.add(i)),e.registerDisposer(t.useTemporaryVisibleSegments.changed.add(i)),e.registerDisposer(t.useTemporarySegmentEquivalences.changed.add(i))},e.segmentationGroupState))}function c1(e,t){c0(e,t),t.registerDisposer(e.objectAlpha.changed.add(t.redrawNeeded.dispatch)),t.registerDisposer(e.transform.changed.add(t.redrawNeeded.dispatch)),t.registerDisposer(e.renderScaleTarget.changed.add(t.redrawNeeded.dispatch)),t.registerDisposer(e.transparentPickEnabled.changed.add(t.redrawNeeded.dispatch))}let c2=Z.vh.create();function c3(e,t,i=c2){let r;if(null==e)return i.fill(1),i;let n=e.segmentationColorGroupState.value,{segmentStatedColors:s}=n;if(0!==s.size&&void 0!==(r=n.segmentStatedColors.get(t)))return i[0]=Number(255n&r)/255,i[1]=(Number(65280n&r)>>>8)/255,i[2]=(Number(16711680n&r)>>>16)/255,i;let a=n.segmentDefaultColor.value;return void 0!==a?(i[0]=a[0],i[1]=a[1],i[2]=a[2]):n.segmentColorHash.compute(i,t),i}function c4(e,t={}){for(let i of ll)t[i]=e[i].rpcId;return t}let c6=iZ(la);class c5 extends c6{chunkManager;displayState;constructor(e,t,i){super(i),this.chunkManager=e,this.displayState=t;let r=t.segmentationGroupState.value;for(let e of ll)this.registerDisposer(r[e].addRef())}initializeCounterpartWithChunkManager(e){let{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,c4(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(iH.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(iH.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}}function c8(e,t,i,r,n){let s=Math.min(1,e.objectAlpha.value),a=e.baseSegmentColoring.value;lc(e.segmentationGroupState.value,(o,l)=>{let d=r?.registerUint64(t,o),u=i?function(e,t,i=1){c2[3]=i,c3(e,t,c2);let r=e.saturation.value;e.hoverHighlight.value&&e.segmentSelectionState.isSelected(t)&&(r>.5?r=r-=.5:r+=.5);for(let e=0;e<3;++e)c2[e]=c2[e]*r+(1-r);return c2[0]*=i,c2[1]*=i,c2[2]*=i,c2}(e,a?o:l,s):void 0;n(o,u,d,l)})}function c9(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}let c7=Z._E.create(),he=Z.wO.create();function ht(e,t){t.vertexBuffer=rm.fromData(e,t.meshData.vertexPositions,e.ARRAY_BUFFER,e.STATIC_DRAW),t.indexBuffer=rm.fromData(e,t.meshData.indices,e.ELEMENT_ARRAY_BUFFER,e.STATIC_DRAW),t.normalBuffer=rm.fromData(e,t.meshData.vertexNormals,e.ARRAY_BUFFER,e.STATIC_DRAW)}function hi(e){e.vertexBuffer.dispose(),e.indexBuffer.dispose(),e.normalBuffer.dispose()}let hr=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function hn(e){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(t,i,r){r.vertexBuffer.bindToVertexAttrib(i.attribute("aVertexPosition"),3,e,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}let hs={[uz.k_.float32]:hn(WebGL2RenderingContext.FLOAT),[uz.k_.uint16]:hn(WebGL2RenderingContext.UNSIGNED_SHORT),[uz.k_.uint10]:{defineShader:e=>{e.addAttribute("highp uint","aVertexPosition"),e.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(e,t,i){i.vertexBuffer.bindToVertexAttribI(t.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}};class ha{fragmentRelativeVertices;vertexPositionFormat;tempLightVec;vertexPositionHandler;constructor(e,t){this.fragmentRelativeVertices=e,this.vertexPositionFormat=t,this.tempLightVec=new Float32Array(4),this.vertexPositionHandler=hs[t]}beginLayer(e,t,i,r){let{lightDirection:n,ambientLighting:s,directionalLighting:a}=i,o=this.tempLightVec;Z.R3.scale(o,n,a),o[3]=s,e.uniform4fv(t.uniform("uLightDirection"),o);let l=r.silhouetteRendering.value;l>0&&e.uniform1f(t.uniform("uSilhouettePower"),l)}setColor(e,t,i){e.uniform4fv(t.uniform("uColor"),i)}setPickID(e,t,i){e.uniform1ui(t.uniform("uPickID"),i)}beginModel(e,t,i,r){let{projectionParameters:n}=i;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,Z._E.multiply(c7,n.viewProjectionMat,r)),(0,Z.bZ)(he,r),(0,Z.Jc)(he,he,n.displayDimensionRenderInfo.canonicalVoxelFactors),Z.wO.invert(he,he),Z.wO.transpose(he,he),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,he)}drawFragmentHelper(e,t,i,r,n){this.vertexPositionHandler.bind(e,t,i);let{meshData:s}=i;i.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),i.indexBuffer.bind();let{indices:a}=s;e.drawElements(s.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,n-r,2===a.BYTES_PER_ELEMENT?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,r*a.BYTES_PER_ELEMENT)}drawFragment(e,t,i){let{meshData:r}=i,{indices:n}=r;this.drawFragmentHelper(e,t,i,0,n.length)}drawMultiscaleFragment(e,t,i,r,n){let s=i.meshData.subChunkOffsets[r],a=i.meshData.subChunkOffsets[n];this.drawFragmentHelper(e,t,i,s,a)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){let t=e.registerDisposer((0,J.mo)(e=>e>0,[e.displayState.silhouetteRendering]));return rg(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(e,t)=>{this.vertexPositionHandler.defineShader(e),e.addAttribute("highp vec2","aVertexNormal"),e.addVarying("highp vec4","vColor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat3","uNormalMatrix"),e.addUniform("highp mat4","uModelViewProjection"),e.addUniform("highp uint","uPickID"),t&&e.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(e.addUniform("highp vec3","uFragmentOrigin"),e.addUniform("highp vec3","uFragmentShape")),e.addVertexCode(hr);let i="";this.fragmentRelativeVertices?i+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:i+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,i+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,t&&(i+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),e.setVertexMain(i),e.setFragmentMain("emit(vColor, uPickID);")}})}}class ho extends uW{chunkManager;source;displayState;meshShaderManager;getShader;backend;constructor(e,t,i){super(),this.chunkManager=e,this.source=t,this.displayState=i,this.meshShaderManager=new ha(!1,uz.k_.float32),this.getShader=this.meshShaderManager.makeGetter(this),c1(i,this),this.registerDisposer(i.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let r=this.backend=this.registerDisposer(new c5(e,i,this.layerChunkProgressInfo));r.RPC_TYPE_ID=uz.ve,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),r.visibility.add(this.visibility),this.registerDisposer(i.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:i,displayState:r,meshShaderManager:n}=this;if(r.objectAlpha.value<=0)return;let s=i0(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===s)return;let{shader:a}=this.getShader(e.emitter);if(null===a)return;a.bind(),n.beginLayer(i,a,e,this.displayState),n.beginModel(i,a,e,s);let o=this.source.chunks,l=0,d=0,{renderScaleHistogram:u}=this.displayState,c=this.source.fragmentSource.chunks;c8(r,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(t,r,s)=>{let u=ld(t),h=o.get(u);if(++l,void 0!==h)for(let t of(++d,e.emitColor&&n.setColor(i,a,r),e.emitPickID&&n.setPickID(i,a,s),l+=h.fragmentIds.length,h.fragmentIds)){let{key:e}=this.source.getFragmentKey(u,t),r=c.get(e);void 0!==r&&r.state===it.GPU_MEMORY&&(n.drawFragment(i,a,r),++d)}}),e.emitColor&&(u.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),u.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,d,l-d)),n.endLayer(i,a)}isReady(){let{displayState:e,source:t}=this,i=!0,r=t.fragmentSource.chunks;return lc(e.segmentationGroupState.value,e=>{let n=ld(e),s=t.chunks.get(n);if(void 0===s){i=!1;return}for(let e of s.fragmentIds){let{key:t}=this.source.getFragmentKey(n,e),s=r.get(t);if(void 0===s||s.state!==it.GPU_MEMORY){i=!1;return}}}),i}getObjectPosition(e,t){let i=this.displayState.transform.value;if(void 0!==i.error)return;let r=ld(e),n=this.source.chunks.get(r);if(void 0===n)return;let{rank:s}=i,a=new Float32Array(i.modelToRenderLayerTransform.length);e9.SO(a,s+1,i.modelToRenderLayerTransform,s+1,s+1);let o=new Float32Array(s);e9.DC(o,a,s+1,t,s);let{fragmentIds:l}=n,d=0,u=[];for(let e of l){let{key:t}=this.source.getFragmentKey(r,e),i=this.source.fragmentSource.chunks.get(t);if(void 0===i)continue;let{state:n,meshData:a}=i;(n===it.SYSTEM_MEMORY||n===it.GPU_MEMORY)&&(d+=a.vertexPositions.length/s,u.push(i))}let c=Math.max(1,Math.floor(1/(1e5/d))),h=new Float32Array(s),p=Number.POSITIVE_INFINITY;for(let e of u){let{meshData:t}=e,{vertexPositions:i}=t;if(!(i.length<s))for(let e=0;e<i.length;e+=s*c){let t=0;for(let r=0;r<s;r++)t+=(i[e+r]-o[r])**2;if(t<p){p=t;for(let t=0;t<s;t++)h[t]=i[e+t]}}}if(p===Number.POSITIVE_INFINITY)return;let g=new Float32Array(s);return e9.DC(g,i.modelToRenderLayerTransform,s+1,h,s),g}}class hl extends o9{fragmentIds;constructor(e,t){super(e),this.fragmentIds=t.fragmentIds}}class hd extends o9{vertexBuffer;indexBuffer;normalBuffer;meshData;constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),ht(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),hi(this)}}class hu extends ln{fragmentSource=this.registerDisposer(new hc(this.chunkManager,this));initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new hl(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}}class hc extends ln{meshSource;get key(){return this.meshSource.key}constructor(e,t){super(e),this.meshSource=t}getChunk(e){return new hd(this,e)}}function hh(e,t,i,r){let n=e.get(uj(t,i,r));return void 0!==n&&n.state===it.GPU_MEMORY}hc=c9([ij(uz.q7)],hc);class hp extends uW{chunkManager;source;displayState;meshShaderManager;getShader;backend;constructor(e,t,i){super(),this.chunkManager=e,this.source=t,this.displayState=i,this.meshShaderManager=new ha(t.format.fragmentRelativeVertices,t.format.vertexPositionFormat),this.getShader=this.meshShaderManager.makeGetter(this),c1(i,this),this.registerDisposer(i.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let r=this.backend=this.registerDisposer(new c5(e,i,this.layerChunkProgressInfo));r.RPC_TYPE_ID=uz.nL,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),r.visibility.add(this.visibility),this.registerDisposer(i.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){let{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let{gl:i,displayState:r,meshShaderManager:n}=this;if(r.objectAlpha.value<=0)return;let s=i0(r.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===s)return;let{shader:a}=this.getShader(e.emitter);if(null===a)return;a.bind(),n.beginLayer(i,a,e,this.displayState);let{renderScaleHistogram:o}=this.displayState;e.emitColor&&o.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),(0,Z.bZ)(he,s),(0,Z.Jc)(he,he,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);let l=Math.abs(Z.wO.determinant(he))**(1/3),{chunks:d}=this.source,u=this.source.fragmentSource.chunks,{projectionParameters:c}=e,h=Z._E.multiply(Z._E.create(),c.viewProjectionMat,s),p=(0,Z.th)(new Float32Array(24),h),g=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:f}=this.source.format;n.beginModel(i,a,e,s);let m=0,v=0;c8(r,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(t,r,s)=>{let y=ld(t),b=d.get(y);if(++m,void 0===b)return;++v;let{manifest:S}=b,{octree:w,chunkShape:C,chunkGridSpatialOrigin:x,vertexOffsets:E}=S;e.emitColor&&n.setColor(i,a,r),e.emitPickID&&n.setPickID(i,a,s),uG(S,h,p,g,c.width,c.height,(t,i,r)=>{let n=hh(u,y,t,i);return e.emitColor&&o.add(S.lodScales[t]*l,r,n?1:0,n?0:1),n},(e,t,r,s)=>{let o=uj(y,e,t),l=u.get(o),d=w[5*t],c=w[5*t+1],h=w[5*t+2],p=1<<e;f&&(i.uniform3f(a.uniform("uFragmentOrigin"),x[0]+d*C[0]*p+E[3*e+0],x[1]+c*C[1]*p+E[3*e+1],x[2]+h*C[2]*p+E[3*e+2]),i.uniform3f(a.uniform("uFragmentShape"),C[0]*p,C[1]*p,C[2]*p)),n.drawMultiscaleFragment(i,a,l,r,s)})}),o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,v,m-v),n.endLayer(i,a)}isReady(e,t){let{displayState:i}=this;if(i.objectAlpha.value<=0)return!0;let r=i0(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===r)return!1;let{chunks:n}=this.source,s=this.source.fragmentSource.chunks,{projectionParameters:a}=e,o=Z._E.multiply(Z._E.create(),a.viewProjectionMat,r),l=(0,Z.th)(new Float32Array(24),o),d=this.displayState.renderScaleTarget.value,u=!0;return lc(i.segmentationGroupState.value,e=>{if(!u)return;let t=ld(e),i=n.get(t);if(void 0===i){u=!1;return}let{manifest:r}=i;uG(r,o,l,d,a.width,a.height,(e,i)=>u=u&&hh(s,t,e,i),()=>{})}),u}getObjectPosition(e){let t=this.displayState.transform.value;if(void 0!==t.error)return;let i=this.source.chunks.get(ld(e));if(void 0===i)return;let{manifest:r}=i,{clipLowerBound:n,clipUpperBound:s}=r,{rank:a}=t,o=new Float32Array(a);for(let e=0;e<3;++e)o[e]=(n[e]+s[e])/2;let l=new Float32Array(a);return e9.DC(l,t.modelToRenderLayerTransform,a+1,o,a),l}}class hg extends o9{manifest;constructor(e,t){super(e),this.manifest=t.manifest}}class hf extends o9{meshData;vertexBuffer;indexBuffer;normalBuffer;constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),ht(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),hi(this)}}class hm extends ln{fragmentSource=this.registerDisposer(new hv(this.chunkManager,this));format;constructor(e,t){super(e,t),this.format=t.format}static encodeOptions(e){return{format:e.format,...ln.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new hg(this,e)}}class hv extends ln{meshSource;get key(){return this.meshSource.key}constructor(e,t){super(e),this.meshSource=t}getChunk(e){return new hf(this,e)}}function hy(e,t){return e^=t=Math.imul(t=((t=Math.imul(t,0xcc9e2d51)>>>0)<<15|t>>>17)>>>0,0x1b873593)>>>0,e=Math.imul(e=(e<<13|e>>>19)>>>0,5)+0xe6546b64>>>0}function hb(e,t){var i;let r=e;return r=hy(r,Number(4294967295n&t)),i=8^(r=hy(r,Number(t>>32n))),i^=i>>>16,i=Math.imul(i,0x85ebca6b)>>>0,i^=i>>>13,i*=0xc2b2ae35,(i^=i>>>16)>>>0}function hS(e,t){return t<=255?new Uint8Array(e):t<=65535?new Uint16Array(e):new Uint32Array(e)}hv=c9([ij(uz.Ff)],hv);class hw{inlineProperties;constructor(e){this.inlineProperties=e.inlineProperties}}class hC{segmentPropertyMap;inlineIdToIndex;tags;labels;numericalProperties;getSegmentInlineIndex(e){let{inlineIdToIndex:t}=this;return void 0===t?-1:function(e,t,i){let r=hb(0,i),n=e.length-1;for(;;){let s=e[r&=n];if(0===s)return -1;if(t[--s]===i)return s;++r}}(t,this.segmentPropertyMap.inlineProperties.ids,e)}constructor(e){this.segmentPropertyMap=e;let{inlineProperties:t}=e;void 0!==t&&(this.inlineIdToIndex=function(e){let t=e.length,i=Math.ceil(Math.log2(t))+1,r=hS(2**i,t+1);for(let i=0;i<t;++i)!function(e,t,i){let r=e.length-1;for(;;){if(0===e[t&=r]){e[t]=i;return}++t}}(r,hb(0,e[i]),i+1);return r}(t.ids)),this.tags=t?.properties.find(e=>"tags"===e.type),this.labels=t?.properties.find(e=>"label"===e.type),this.numericalProperties=t?.properties.filter(e=>"number"===e.type)??[]}getSegmentLabel(e){let t=this.getSegmentInlineIndex(e);if(-1===t)return;let{labels:i,tags:r}=this,n="";if(void 0!==i&&(n=i.values[t]),void 0!==r){let{tags:e,values:i}=r,s=i[t];for(let t=0,i=s.length;t<i;++t){let i=e[s.charCodeAt(t)];n.length>0&&(n+=" "),n+="#",n+=i}}if(0!==n.length)return n}}function hx(e,t,i){for(let r=0,n=i.length;r<n;++r)t[i[r]]=e[r]}function hE(e,t,i){let{type:r}=e;return"label"===r||"description"===r||"string"===r||"tags"===r?function(e,t,i){let r=Array(t);return r.fill(""),hx(e.values,r,i),{...e,values:r}}(e,t,i):function(e,t,i){let r=new Float32Array(t);return r.fill(Number.NaN),hx(e.values,r,i),{...e,values:r}}(e,t,i)}let hT=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function hk(e){return"\\u"+e.toString(16).padStart(4,"0")}function hD(e){return e?.tags||e?.labels?"label":"id"}function hL(e,t,i){if(0===i.size)return 0;let r=0;return!function(e,t,i){if(void 0===t)return;let{explicitIds:r}=t;if(void 0!==r){r.forEach(i);return}let{indices:n}=t;if(void 0!==n){let{ids:t}=e.segmentPropertyMap.inlineProperties;for(let e=0,r=n.length;e<r;++e)i(t[n[e]],e)}}(e,t,e=>{i.has(e)&&++r}),r}function hI(e,t,i,r){let n=e.includeTags.filter(e=>e!==t),s=e.excludeTags.filter(e=>e!==t);return!0===r&&(i?n:s).push(t),{...e,includeTags:n,excludeTags:s}}function hP(e,t){if(void 0===e||void 0!==e.ids||void 0!==e.errors)return!1;let{sortBy:i,includeColumns:r}=e;return void 0!==i.find(e=>e.fieldId===t)||r.includes(t)}class hR extends sE{layer;constructor(e){super(),this.layer=e;let{element:t}=this;t.appendChild(this.registerDisposer(new aB(e.displayState.segmentationGroupState.value.graph,(t,i,r)=>{t?.tabContents&&i.appendChild(t.tabContents(e,r,this))})).element)}}class hA{}class hM extends eh.gj{graph;segmentsState;constructor(e,t){super(),this.graph=e,this.segmentsState=t}createRenderLayers(e,t,i){return[]}}var hN=i(658);let hV="DisjointUint64Sets.add",hO="DisjointUint64Sets.clear",hF="DisjointUint64Sets.highBitRepresentativeChanged",hB="DisjointUint64Sets.deleteSet";class h_ extends iz{disjointSets=new hN.D;changed=new eO.K_;get value(){return this}static makeWithCounterpart(e,t){let i=new h_;return i.disjointSets.visibleSegmentEquivalencePolicy=t,i.registerDisposer(t.changed.add(()=>{hU(i)})),i.initializeCounterpart(e),t.value&&hU(i),i}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:i}=this;return i&&i.invoke(hV,{id:this.rpcId,a:e,b:t}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,i=e.length;t<i;++t)this.link(e[0],e[t])}has(e){return this.disjointSets.has(e)}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(hO,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(hB,{id:this.rpcId,x:e}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){void 0!==e&&(0,ef.m7)(e,e=>{let t;(0,ef.m7)(e,e=>{let i=(0,ef.tw)(e);void 0!==t&&this.link(t,i),t=i})})}assignFrom(e){for(let[t,i]of(this.clear(),e instanceof h_&&(e=e.disjointSets),e))this.link(t,i)}}function hU(e){e.rpc.invoke(hF,{id:e.rpcId,value:e.disjointSets.visibleSegmentEquivalencePolicy.value})}h_=function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([iW("DisjointUint64Sets")],h_),iO(hV,function(e){let t=this.get(e.id);t.disjointSets.link(e.a,e.b)&&t.changed.dispatch()}),iO(hO,function(e){let t=this.get(e.id);t.disjointSets.clear()&&t.changed.dispatch()}),iO(hF,function(e){this.get(e.id).disjointSets.visibleSegmentEquivalencePolicy.value=e.value}),iO(hB,function(e){let t=this.get(e.id);t.disjointSets.deleteSet(e.x)&&t.changed.dispatch()});class h$ extends hA{spanningTreeEdges=new Map;equivalences=new h_;connections=new Set;changed=new eO.MZ;link(e,t){for(let i of(this.equivalences.link(e,t),this.connections))i.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){for(let t of(this.equivalences.linkAll(e),this.connections))t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){for(let t of(this.equivalences.deleteSet(e),this.connections))t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(let e of this.connections)hz(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){let{spanningTreeEdges:i}=this,r=i.get(e);void 0===r&&(r=new Set,i.set(e,r));let n=i.get(t);void 0===n&&(n=new Set,i.set(t,n)),r.add(t),n.add(e)}removeSpanningTreeEdge(e,t){let{spanningTreeEdges:i}=this,r=i.get(e),n=i.get(t);r.delete(t),0===r.size&&i.delete(e),n.delete(e),0===n.size&&i.delete(t)}*getSpanningTreeNeighbors(e){let t=this.spanningTreeEdges.get(e);void 0!==t&&(yield*t)}restoreState(e){let{equivalences:t,spanningTreeEdges:i}=this;t.clear(),i.clear(),void 0!==e&&(0,ef.m7)(e,e=>{let i;(0,ef.m7)(e,e=>{let r=(0,ef.tw)(e);void 0!==i&&t.link(i,r)&&this.addSpanningTreeEdge(i,r),i=r})})}toJSON(){let{spanningTreeEdges:e}=this;if(0===e.size)return;let t=[];for(let[i,r]of e)for(let e of r)i>e||t.push([i,e]);return t.sort((e,t)=>(0,em._f)(e[0],t[0])||(0,em._f)(e[1],t[1])),t.map(e=>e.map(e=>e.toString()))}get visibleSegmentEquivalencePolicy(){return lo.BA.MIN_REPRESENTATIVE}async merge(e,t){let{equivalences:i}=this;return i.get(e)===i.get(t)?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),i.get(e))}async split(e,t){let i=this.computeSplit(e,t);if(void 0===i)throw Error("Segments are already split");let{includeBaseSegments:r,includeRepresentative:n,excludeBaseSegments:s,excludeRepresentative:a}=i,{equivalences:o}=this;this.deleteSet(e),this.linkAll(r),this.linkAll(s);let l=(e,t)=>{for(let i of e)for(let e of this.getSpanningTreeNeighbors(i))o.get(e)!==t&&this.removeSpanningTreeEdge(i,e)},d=o.get(e),u=o.get(t);for(let e of(l(r,d),l(s,u),this.connections)){let{selectedSegments:t,visibleSegments:i}=e.segmentsState;t.has(a)&&(t.delete(a),t.add(n),i.add(n))}return this.normalizeAll(),this.changed.dispatch(),{include:d,exclude:u}}trackSegment(e,t){return()=>{}}computeSplit(e,t){let{equivalences:i}=this,r=i.get(e);if(r!==i.get(t))return;let n=new hN.D;for(let e of i.setElements(r))if(e!==t)for(let i of this.getSpanningTreeNeighbors(e))i!==t&&n.link(e,i);let s=[],a=[],o=n.get(e),l=e,d=t;for(let e of i.setElements(r))n.get(e)===o?(s.push(e),e<l&&(l=e)):(a.push(e),e<d&&(d=e));return s.sort(em._f),a.sort(em._f),{includeBaseSegments:s,includeRepresentative:l,excludeBaseSegments:a,excludeRepresentative:d}}connect(e){let t=e.displayState.segmentationGroupState.value,i=new hG(this,t);return t.segmentEquivalences.assignFrom(this.equivalences),hz(t.visibleSegments,t.segmentEquivalences.disjointSets),i.registerDisposer(t.visibleSegments.changed.add(i.registerCancellable((0,ie.Z)(()=>hz(t.visibleSegments,t.segmentEquivalences.disjointSets),0)))),this.connections.add(i),i.registerDisposer(()=>{this.connections.delete(i)}),i}}function hz(e,t){let i=[];for(let r of e.keys()){let n=t.get(r);r!==n&&(i.push(n),e.delete(r))}for(let t of i)e.add(t)}class hG extends hM{computeSplit(e,t){return this.graph.computeSplit(e,t)}}var hj=i(5105);function hW(e,t){e.addVertexCode(sd),e.addUniform("highp vec3","uCircleParams"),e.addVarying("highp vec4","vCircleCoord"),e.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),t?e.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):e.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),e.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function hq(e,t,i){let{gl:r}=e;r.uniform3f(e.uniform("uCircleParams"),1/t.width,1/t.height,Math.max(1e-6,i.featherWidthInPixels))}function hH(e){e.addAttribute("int","aDummyVertexId",0),e.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}class hJ extends eh.gj{size;buffer;constructor(e){super(),this.buffer=new rm(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){let{buffer:t}=this,{gl:i}=t;t.bind(),e>this.size&&(this.size=e,i.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),i.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),i.vertexAttribDivisor(0,0),i.enableVertexAttribArray(0)}disable(){let{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new hJ(e))}}let hK=Z._E.create(),hZ=`void main() {
  emitDefault();
}
`,hY=[],hX=ci(new u0,el.FLOAT32,3);class hQ extends eh.gj{base;targetIsSliceView;textureAccessHelper;vertexIdHelper;get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){hH(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}edgeShaderGetter;nodeShaderGetter;get gl(){return this.base.gl}constructor(e,t){super(),this.base=e,this.targetIsSliceView=t,this.textureAccessHelper=new cs("vertexData"),this.vertexIdHelper=this.registerDisposer(hJ.get(this.gl)),this.edgeShaderGetter=rg(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(0!==t.parseResult.errors.length)throw Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),sc(e),e.addAttribute("highp uvec2","aVertexIndex"),e.addUniform("highp float","uLineWidth");let i=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),e.addFragmentCode(oZ);let{vertexAttributes:r}=this,n=r.length;for(let t=1;t<n;++t){let n=r[t];e.addVarying(`highp ${n.glslDataType}`,`vCustom${t}`),i+=`vCustom${t} = readAttribute${t}(vertexIndex);
`,e.addFragmentCode(`#define ${n.name} vCustom${t}
`)}e.setVertexMain(i),op(t,e),e.setFragmentMainFunction(rf(t.parseResult.code))}}),this.nodeShaderGetter=rg(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(0!==t.parseResult.errors.length)throw Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),hW(e,this.targetIsSliceView),e.addUniform("highp float","uNodeDiameter");let i=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;e.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),e.addFragmentCode(oZ);let{vertexAttributes:r}=this,n=r.length;for(let t=1;t<n;++t){let n=r[t];e.addVarying(`highp ${n.glslDataType}`,`vCustom${t}`),i+=`vCustom${t} = readAttribute${t}(vertexIndex);
`,e.addFragmentCode(`#define ${n.name} vCustom${t}
`)}e.setVertexMain(i),op(t,e),e.setFragmentMainFunction(rf(t.parseResult.code))}})}defineAttributeAccess(e){let{textureAccessHelper:t}=this;t.defineShader(e);let i=this.vertexAttributes.length;for(let e=hY.length;e<i;++e)hY[e]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${e}`);this.vertexAttributes.forEach((i,r)=>{e.addTextureSampler(`${ct(i.dataType)}sampler2D`,`uVertexAttributeSampler${r}`,hY[r]),e.addVertexCode(t.getAccessor(`readAttribute${r}`,`uVertexAttributeSampler${r}`,i.dataType,i.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,i,r){let{viewProjectionMat:n}=i.projectionParameters,s=Z._E.multiply(hK,n,r);e.uniformMatrix4fv(t.uniform("uProjection"),!1,s),this.vertexIdHelper.enable()}setColor(e,t,i){e.uniform4fv(t.uniform("uColor"),i)}setPickID(e,t,i){e.uniform1ui(t.uniform("uPickID"),i)}drawSkeleton(e,t,i,r,n){let{vertexAttributes:s}=this,a=s.length,{vertexAttributeTextures:o}=r;for(let i=0;i<a;++i){let r=WebGL2RenderingContext.TEXTURE0+t.textureUnit(hY[i]);e.activeTexture(r),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o[i])}{t.bind();let i=t.attribute("aVertexIndex");r.indexBuffer.bindToVertexAttribI(i,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(i,1),sh(t,n,this.targetIsSliceView?1:0),su(e,1,r.numIndices/2),e.vertexAttribDivisor(i,0),e.disableVertexAttribArray(i)}null!==i&&(i.bind(),hq(i,n,{featherWidthInPixels:this.targetIsSliceView?1:0}),su(i.gl,2,r.numVertices))}endLayer(e,t){let{vertexAttributes:i}=this,r=i.length;for(let i=0;i<r;++i){let r=t.textureUnit(hY[i])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(r),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}}var h0=((O={})[O.LINES=0]="LINES",O[O.LINES_AND_POINTS=1]="LINES_AND_POINTS",O);class h1 extends nb.B{constructor(e,t=e){super(h0,e,t)}}class h2 extends J.TU{constructor(e,t=e){super(e,ef.o7,t)}}class h3{compound=new nm;get changed(){return this.compound.changed}shader=rh(hZ);shaderControlState=new oE(this.shader);params2d={mode:new h1(1),lineWidth:new h2(2)};params3d={mode:new h1(0),lineWidth:new h2(1)};constructor(){let{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}reset(){this.compound.reset()}restoreState(e){void 0!==e&&this.compound.restoreState(e)}toJSON(){let e=this.compound.toJSON();for(let t of Object.values(e))if(void 0!==t)return e}}class h4 extends eh.gj{chunkManager;source;displayState;layerChunkProgressInfo;redrawNeeded;sharedObject;vertexAttributes;fallbackShaderParameters;get visibility(){return this.sharedObject.visibility}constructor(e,t,i){super(),this.chunkManager=e,this.source=t,this.displayState=i,this.layerChunkProgressInfo=new ia,this.redrawNeeded=new eO.K_,this.fallbackShaderParameters=new J.SN(ox(oc(hZ))),c1(i,this),this.displayState.shaderError.value=void 0;let{skeletonRenderingOptions:r}=i;this.registerDisposer(r.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));let n=this.sharedObject=this.registerDisposer(new c5(e,i,this.layerChunkProgressInfo));n.RPC_TYPE_ID=hj.f,n.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});let s=this.vertexAttributes=[h8];for(let[e,i]of t.vertexAttributes)s.push({name:e,dataType:i.dataType,numComponents:i.numComponents,webglDataType:function(e){if(e===el.FLOAT32)return WebGL2RenderingContext.FLOAT;throw Error(`Data type not supported by WebGL: ${el[e]}`)}(i.dataType),glslDataType:i.numComponents>1?`vec${i.numComponents}`:"float"})}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,i,r,n){let s;let a=r.lineWidth.value,{gl:o,source:l,displayState:d}=this;if(d.objectAlpha.value<=0)return;let u=i0(d.transform.value,e.projectionParameters.displayDimensionRenderInfo,n);if(void 0===u)return;s=1===r.mode.value?Math.max(5,2*a):a;let c=i.edgeShaderGetter(e.emitter),h=i.nodeShaderGetter(e.emitter),{shader:p,parameters:g}=c,{shader:f,parameters:m}=h;if(null===p||null===f)return;let{shaderControlState:v}=this.displayState.skeletonRenderingOptions;p.bind(),i.beginLayer(o,p,e,u),ok(o,p,v,g.parseResult.controls),o.uniform1f(p.uniform("uLineWidth"),a),f.bind(),i.beginLayer(o,f,e,u),o.uniform1f(f.uniform("uNodeDiameter"),s),ok(o,f,v,m.parseResult.controls);let y=l.chunks;c8(d,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(t,r,n)=>{let s=ld(t),a=y.get(s);void 0!==a&&a.state===it.GPU_MEMORY&&(void 0!==r&&(p.bind(),i.setColor(o,p,r),f.bind(),i.setColor(o,f,r)),void 0!==n&&(p.bind(),i.setPickID(o,p,n),f.bind(),i.setPickID(o,f,n)),i.drawSkeleton(o,p,f,a,e.projectionParameters))}),i.endLayer(o,p)}isReady(){let{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;let i=e.chunks,r=!0;return lc(t.segmentationGroupState.value,e=>{let t=ld(e),n=i.get(t);if(void 0===n||n.state!==it.GPU_MEMORY){r=!1;return}}),r}}class h6 extends uW{base;renderHelper;renderOptions;constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new hQ(e,!1)),this.renderOptions=e.displayState.skeletonRenderingOptions.params3d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){(e.emitColor||!e.alreadyEmittedPickID)&&this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}class h5 extends lm{base;renderHelper;renderOptions;constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new hQ(e,!0)),this.renderOptions=e.displayState.skeletonRenderingOptions.params2d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);let{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}let h8={dataType:el.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"};class h9 extends o9{vertexAttributes;indices;indexBuffer;numIndices;numVertices;vertexAttributeOffsets;vertexAttributeTextures;constructor(e,t){super(e),this.vertexAttributes=t.vertexAttributes;let i=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=i.length}copyToGPU(e){super.copyToGPU(e);let{attributeTextureFormats:t}=this.source,{vertexAttributes:i,vertexAttributeOffsets:r}=this,n=this.vertexAttributeTextures=[];for(let s=0,a=r.length;s<a;++s){let o=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),cr(e,t[s],i.subarray(r[s],s+1!==a?r[s+1]:i.length)),n[s]=o}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=rm.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);let{vertexAttributeTextures:t}=this;for(let i of t)e.deleteTexture(i);t.length=0,this.indexBuffer.dispose()}}let h7=new Map;class pe extends ln{attributeTextureFormats_;get attributeTextureFormats(){let e=this.attributeTextureFormats_;return void 0===e&&(e=this.attributeTextureFormats_=function(e){let t=[hX];for(let i of e.values())t.push(ci(new u0,i.dataType,i.numComponents));return t}(this.vertexAttributes)),e}getChunk(e){return new h9(this,e)}get vertexAttributes(){return h7}}var pt=((F={})[F.UNKNOWN=0]="UNKNOWN",F[F.IMAGE=1]="IMAGE",F[F.SEGMENTATION=2]="SEGMENTATION",F);function pi(e){let{rank:t,dataType:i,fillValue:r=i===el.UINT64?0n:0,compressedSegmentationBlockSize:n}=e,{baseVoxelOffset:s=new Float32Array(t)}=e;return{...oU(e),compressedSegmentationBlockSize:n,baseVoxelOffset:s,dataType:i,fillValue:r}}function pr(e){let{rank:t,lowerVoxelBound:i,upperVoxelBound:r}=e;if(!function(e){if(void 0!==e.compressedSegmentationBlockSize||2!==e.volumeType&&!e.volumeSourceOptions.discreteValues)return!1;switch(e.dataType){case el.UINT32:case el.UINT64:break;default:return!1}switch(e.rank){case 3:return!0;case 4:{let{chunkDataSize:t}=e;if(1!==t[3])return!1;return!0}default:return!1}}(e))return pi(e);let{volumeSourceOptions:{displayRank:n,multiscaleToViewTransform:s},chunkToMultiscaleTransform:a,chunkToViewTransform:o}=e;void 0===o&&(o=e9.Jp(new Float32Array(t*n),n,s,n,a,t+1,n,t,t));let{maxCompressedSegmentationBlockSize:l,chunkDataSize:d}=e;return pi({...e,compressedSegmentationBlockSize:Float32Array.from(oB({rank:t,chunkToViewTransform:o,displayRank:n,lowerVoxelBound:i,upperVoxelBound:r,maxVoxelsPerChunkLog2:9,maxBlockSize:void 0===l?d:function(e,t,i){let r=e.length;for(let n=0;n<r;++n)e[n]=Math.min(t[n],i[n]);return e}(new Uint32Array(t),d,l)}))})}function pn(e){let{rank:t}=e,{volumeSourceOptions:{displayRank:i,multiscaleToViewTransform:r,modelChannelDimensionIndices:n},chunkToMultiscaleTransform:s}=e,a=e9.Jp(new Float32Array(i*t),i,r,i,s,t+1,i,t,t),{minBlockSize:o}=e;void 0===o?(o=new Uint32Array(t)).fill(1):o=new Uint32Array(o);let{lowerVoxelBound:l,upperVoxelBound:d}=e;if(0!==n.length)for(let e of(0,Z.Mz)(s,t,n)){let t=d[e];void 0!==l&&(t-=l[e]),o[e]=t}let{chunkDataSizes:u=function(e){if(void 0!==e.chunkDataSizes)return e.chunkDataSizes;let{chunkLayoutPreference:t=0}=e;switch(t){case 0:return[oB(e)];case 1:return function(e){let t=[],{displayRank:i,chunkToViewTransform:r,rank:n}=e;if(i>3)throw Error("Unsupported view transform");if(i<3)return[oB(e)];for(let s=0;s<3;++s){let a=(s+2)%3,o=new Float32Array(r);for(let e=0;e<n;++e)o[e*i+a]=0;t[s]=oB({...e,chunkToViewTransform:o})}return t}(e)}}({...e,minBlockSize:o,chunkToViewTransform:a,displayRank:i})}=e;return u.map(t=>pr({...e,chunkDataSize:t,chunkToViewTransform:a}))}function ps(e,t,i,r){let{dataType:n}=t;t.defineShader(e,i);let s="",a="";if(0===i)s+="highp int ignoredChannelIndex";else for(let e=0;e<i;++e)0!==e&&(s+=", "),s+=`highp int channelIndex${e}`,a+=`, channelIndex${e}`;e.addFragmentCode(rA);let o=`
${r6(n)} getDataValue(${s}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${r}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${a});
}
${r6(n)} getInterpolatedDataValue(${s}) {
  highp vec3 positionWithinChunk = ${r};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${r6(n)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${r6(n)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${r6(n)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${a});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;e.addFragmentCode(o),i<=1&&e.addFragmentCode(`
${r6(n)} getDataValue() { return getDataValue(0); }
${r6(n)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}let pa=[];class po extends lC{chunkFormatHandler;tempChunkGridPosition;tempPositionWithinChunk;constructor(e,t){super(e,t),this.chunkFormatHandler=this.registerDisposer(function(e,t){for(let i of pa){let r=i(e,t);if(null!=r)return r}throw Error("No chunk format handler found.")}(e.chunkQueueManager.gl,this.spec));let i=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(i),this.tempPositionWithinChunk=new Uint32Array(i)}static encodeSpec(e){return{...super.encodeSpec(e),dataType:e.dataType,compressedSegmentationBlockSize:e.compressedSegmentationBlockSize&&Array.from(e.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(e.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){let i=this.spec.rank,r=this.tempChunkGridPosition,n=this.tempPositionWithinChunk,{spec:s}=this;{let{chunkDataSize:t}=s;for(let s=0;s<i;++s){let i=e[s],a=t[s],o=Math.floor(i/a);r[s]=o,n[s]=Math.floor(i-a*o)}}let a=this.chunks.get(r.join());if(void 0===a)return null;let o=a.chunkDataSize;for(let e=0;e<3;++e)if(n[e]>=o[e])return;if(0===t.channelSpaceShape.length)return a.getValueAt(n);let{numChannels:l,chunkChannelCoordinates:d,chunkChannelDimensionIndices:u}=t,c=u.length,h=0,p=Array(l);for(let e=0;e<l;++e){for(let e=0;e<c;++e)n[u[e]]=d[h++];p[e]=a.getValueAt(n)}return p}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}}class pl extends lx{chunkDataSize;get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t),this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}}class pd extends lT{}let pu=Z.R3.create(),pc=Z.R3.create(),ph=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),pp=(()=>{let e=[0,1,2,4,5,3,6,7],t=[0,1,2,5,3,4,6,7],i=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],r=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],n=new Int32Array(384);for(let s=0;s<8;++s)for(let a=0;a<i.length;++a){let o=8*t[s]+i[a];n[48*s+a]=e[r[o]]}return n})();function pg(e){e.addUniform("highp vec3","uPlaneNormal"),e.addUniform("highp float","uPlaneDistance"),e.addUniform("highp ivec2","uVertexIndex",24),e.addUniform("highp vec3","uVertexBasePosition",8),e.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),ph)}),e.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > 0.001) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -0.001) && (lambda <= (1.0 + 0.001))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function pf(e,t,i,r,n){let s=(0,Z._Z)(pu,t,r);Z.R3.normalize(s,s);let a=Z.R3.dot(Z.R3.transformMat4(pc,i,n),s);!function(e,t,i){let{gl:r}=e;r.uniform3fv(e.uniform("uPlaneNormal"),t),r.uniform1f(e.uniform("uPlaneDistance"),i);let n=function(e){let t=0;for(let i=0;i<3;++i)e[i]<0&&(t+=1<<i);return t}(t);r.uniform2iv(e.uniform("uVertexIndex"),pp.subarray(48*n,(n+1)*48))}(e,s,a)}let pm=Z._E.create();function pv(e,t,i){return e>t?i>e?e:t>i?t:i:i>t?t:e>i?e:i}class py extends lf{shaderGetter;tempChunkPosition;shaderParameters;highestResolutionLoadedVoxelSize;vertexIdHelper;constructor(e,t){let{shaderError:i=rc(),shaderParameters:r}=t;super(e.chunkManager,e,t);let{gl:n}=this;this.vertexIdHelper=this.registerDisposer(hJ.get(n)),this.shaderParameters=r;let{channelCoordinateSpace:s}=t;this.channelCoordinateSpace=void 0===s?(0,J.ne)(tC):s,this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch));let a=this.registerDisposer((0,J.mo)((e,t)=>({numChannelDimensions:e.rank,dataHistogramChannelSpecifications:t}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=rp(this,n,{memoizeKey:`volume/RenderLayer:${ri(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:r,encodeParameters:t.encodeShaderParameters,shaderError:i,extraParameters:a,defineShader:(e,t,i,r)=>{let{chunkFormat:n,dataHistogramsEnabled:s}=t,{dataHistogramChannelSpecifications:a,numChannelDimensions:o}=r;if(function(e,t){if(hH(e),pg(e),e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),t){sc(e),e.setVertexMain(`
int vertexIndex1 = gl_VertexID / 6;
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),e.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}e.addVarying("highp vec3","vChunkPosition"),e.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    0.001 * abs(uPlaneNormal);
`)}(e,null===n),e.addOutputBuffer("vec4","v4f_fragData0",0),e.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),null===n)return;ps(e,n,o,"vChunkPosition");let l=a.length;if(s&&l>0){let t="",{dataType:i}=n;for(let r=0;r<l;++r){let{channel:n}=a[r],s=`out_histogram${r}`;e.addOutputBuffer("vec4",s,1+r);let o=`getDataValue(${n.join(",")})`,l=`invlerpForHistogram${r}`;e.addFragmentCode(np(e,l,i,!1)),e.addFragmentCode(`
float getHistogramValue${r}() {
  return invlerpForHistogram${r}(${o});
}
`),t+=`{
float x = getHistogramValue${r}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${s} = vec4(x, x, x, 1.0);
}`}e.addFragmentCode(`void userMain();
void main() {
  ${t}
  userMain();
}
#define main userMain
`)}this.defineShader(e,i)},getContextKey:e=>`${e.chunkFormat?.shaderKey}/${e.dataHistogramsEnabled}`}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let{tempChunkPosition:t}=this;for(let{source:i,chunkTransform:r}of this.visibleSourcesList){if(!t7(t,e,this.localPosition.value,r.layerRank,r.combinedGlobalLocalToChunkTransform))continue;let n=i.getValueAt(t,r);if(null!=n)return n}return null}beginChunkFormat(e,t,i){let{gl:r}=this,n=this.dataHistogramSpecifications.visibility.visible,s=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:n}),{shader:a,parameters:o,fallback:l}=s;if(null!==a){if(a.bind(),null===t&&sh(a,i,1),null!==t){if(n){let{dataHistogramChannelSpecifications:e}=s.extraParameters,i=e.length,r=this.dataHistogramSpecifications.bounds.value;for(let e=0;e<i;++e)ng(a,`invlerpForHistogram${e}`,t.dataType,r[e])}this.initializeShader(e,a,o,l),t.beginDrawing(r,a)}}return s}endSlice(e,t,i){}draw(e){let t,i;let{sliceView:r}=e,{visibleSources:n}=r.visibleLayers.get(this);if(0===n.length)return;let{projectionParameters:s,wireFrame:a}=e,{gl:o}=this;this.vertexIdHelper.enable();let l=Z.R3.create(),{renderScaleHistogram:d}=this;void 0!==d&&d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.highestResolutionLoadedVoxelSize=void 0;let u=null,c=Z.R3.create(),h=()=>{null!==u&&(u.unbindTransferFunctionTextures(),null!==i&&i.endDrawing(o,u),this.endSlice(r,u,t.parameters))},p=!0;for(let e of n){let n;let g=oH(s,e.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:f}}=e,m=e.source,{fixedPositionWithinChunk:v,chunkDisplayDimensionIndices:y}=e;for(let e of y)v[e]=0;let b=a?null:m.chunkFormat;if(b!==i&&(i=b,h(),u=(t=this.beginChunkFormat(r,b,s)).shader),null===u)continue;let S=m.chunks;c.fill(1);let w=g.size,C=m.spec.rank;!function(e,t,i,r,n,s){let a=i.projectionParameters.value,{centerDataPosition:o}=a;pf(t,a.viewportNormalInGlobalCoordinates,o,s.transform,s.invTransform),e.uniformMatrix4fv(t.uniform("uProjectionMatrix"),!1,Z._E.multiply(pm,r,s.transform)),e.uniform3fv(t.uniform("uLowerClipBound"),n.lowerClipDisplayBound),e.uniform3fv(t.uniform("uUpperClipBound"),n.upperClipDisplayBound)}(o,u,r,s.viewProjectionMat,e,g),null!==b&&b.beginSource(o,u),p=!0;let x=0,E=0;if(r.forEachVisibleChunk(e,g,e=>{let t=S.get(e);if(t&&t.state===it.GPU_MEMORY){let e=t.chunkDataSize;if(e!==n){var i;n=e;for(let e=0;e<3;++e){let t=y[e];c[e]=-1===t||t>=C?1:n[t]}i=u,o.uniform3fv(i.uniform("uChunkDataSize"),c)}let{chunkGridPosition:r}=t;for(let e=0;e<3;++e){let t=y[e];l[e]=-1===t||t>=C?0:w[e]*r[t]}null!==b&&b.bindChunk(o,u,t,v,y,f,p),p=!1,function(e,t,i,r){if(e.uniform3fv(t.uniform("uTranslation"),i),r)su(t.gl,6,1);else e.drawArrays(e.TRIANGLE_FAN,0,6)}(o,u,l,a),++x}else++E}),(0!==x||0!==E)&&void 0!==d){let{effectiveVoxelSize:t}=e,i=pv(t[0],t[1],t[2]);x>0&&i<=(this.highestResolutionLoadedVoxelSize?pv(this.highestResolutionLoadedVoxelSize[0],this.highestResolutionLoadedVoxelSize[1],this.highestResolutionLoadedVoxelSize[2]):1/0)&&(this.highestResolutionLoadedVoxelSize=t),d.add(i,i/s.pixelSize,x,E)}}if(h(),this.vertexIdHelper.disable(),!e.wireFrame){let e=this.getDataHistogramCount();e>0&&r.computeHistograms(e,this.dataHistogramSpecifications)}}}class pb{disjointSets;generation;hashMap;constructor(e){this.disjointSets=e,this.generation=Number.NaN,this.hashMap=new uQ}update(){let{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;let{hashMap:i}=this;for(let[t,r]of(i.clear(),e.mappings()))i.set(t,r)}}}class pS extends py{displayState;segmentationGroupState;segmentColorShaderManager;segmentStatedColorShaderManager;gpuSegmentStatedColorHashTable;hashTableManager;gpuHashTable;gpuTemporaryHashTable;equivalencesShaderManager;equivalencesHashMap;temporaryEquivalencesHashMap;gpuEquivalencesHashTable;gpuTemporaryEquivalencesHashTable;constructor(e,t){super(e,{shaderParameters:new J.ny(e=>({hasEquivalences:e.registerDisposer((0,J.mo)(e=>0!==e.size,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:e.registerDisposer((0,J.mo)((e,t,i)=>0!==(i?t:e).size,[t.segmentStatedColors,t.tempSegmentStatedColors2d,t.useTempSegmentStatedColors2d])),hasSegmentDefaultColor:e.registerDisposer((0,J.mo)((e,t)=>void 0!==e||void 0!==t,[t.segmentDefaultColor,t.tempSegmentDefaultColor2d])),hasHighlightColor:e.registerDisposer((0,J.mo)(e=>void 0!==e,[t.highlightColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring,baseSegmentHighlighting:t.baseSegmentHighlighting})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition}),this.displayState=t,this.segmentColorShaderManager=new ch("segmentColorHash"),this.segmentStatedColorShaderManager=new cm("segmentStatedColor"),this.hashTableManager=new cu("visibleSegments"),this.equivalencesShaderManager=new cc("equivalences"),this.segmentationGroupState=t.segmentationGroupState.value,this.gpuHashTable=this.registerDisposer(cd.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable)),this.gpuTemporaryHashTable=cd.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable),this.equivalencesHashMap=new pb(this.segmentationGroupState.segmentEquivalences.disjointSets),this.temporaryEquivalencesHashMap=new pb(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets),this.gpuEquivalencesHashTable=this.registerDisposer(cd.get(this.gl,this.equivalencesHashMap.hashMap)),this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(cd.get(this.gl,this.temporaryEquivalencesHashMap.hashMap)),this.registerDisposer(this.shaderParameters),c0(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){this.gpuSegmentStatedColorHashTable?.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let i=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;i+=`return x;
}
`,e.addFragmentCode(i),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uFlags"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let r=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};
  uint64_t valueForHighlight = ${t.baseSegmentHighlighting?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(r+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),r+=`
  bool has = (uFlags & 2u) != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if ((uFlags & 1u) != 0u && uSelectedSegment == valueForHighlight.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
`,t.hasHighlightColor&&(e.addUniform("highp vec4","uHighlightColor"),r+=`
    emit(uHighlightColor);
    return;
`),r+=`
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let n=`vec4 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),n+=`
  vec4 rgba;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgba)) {
    return rgba;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec4","uSegmentDefaultColor"),n+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),n+=`  return vec4(segmentColorHash(value), 0.0);
`),n+=`
}
`,e.addFragmentCode(n),r+=`
  vec4 rgba = getMappedIdColor(valueForColor);
  if (rgba.a > 0.0) {
    alpha = rgba.a;
  }
  emit(vec4(mix(vec3(1.0,1.0,1.0), vec3(rgba), saturation), alpha));
`,e.setFragmentMain(r)}initializeShader(e,t,i){let{gl:r}=this,{displayState:n,segmentationGroupState:s}=this,{segmentSelectionState:a}=this.displayState,{segmentDefaultColor:{value:o},segmentColorHash:{value:l},highlightColor:{value:d},tempSegmentDefaultColor2d:{value:u}}=this.displayState,c=lu(s),h=this.displayState.ignoreNullVisibleSet.value,p=0,g=0,f=0;if(a.hasSelectedSegment&&n.hoverHighlight.value){let e=n.baseSegmentHighlighting.value?a.baseSelectedSegment:a.selectedSegment;p=Number(4294967295n&e),g=Number(e>>32n),f|=1}if(r.uniform1f(t.uniform("uSelectedAlpha"),n.selectedAlpha.value),r.uniform1f(t.uniform("uSaturation"),n.saturation.value),r.uniform1f(t.uniform("uNotSelectedAlpha"),n.notSelectedAlpha.value),r.uniform2ui(t.uniform("uSelectedSegment"),p,g),0===c.hashTable.size&&h&&(f|=2),r.uniform1ui(t.uniform("uFlags"),f),this.hashTableManager.enable(r,t,s.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),i.hasEquivalences){let e=s.useTemporarySegmentEquivalences.value;(e?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(r,t,e?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}let m=u||o;if(m){let[e,i,n,s]=m;r.uniform4f(t.uniform("uSegmentDefaultColor"),e,i,n,void 0===s?0:s)}else this.segmentColorShaderManager.enable(r,t,l);if(i.hasSegmentStatedColors){let e=n.useTempSegmentStatedColors2d.value?n.tempSegmentStatedColors2d.value:n.segmentStatedColors.value,{gpuSegmentStatedColorHashTable:i}=this;(void 0===i||i.hashTable!==e.hashTable)&&(i?.dispose(),this.gpuSegmentStatedColorHashTable=i=cd.get(r,e.hashTable)),this.segmentStatedColorShaderManager.enable(r,t,i)}void 0!==d&&r.uniform4fv(t.uniform("uHighlightColor"),d)}endSlice(e,t,i){let{gl:r}=this;this.hashTableManager.disable(r,t),i.hasEquivalences&&this.equivalencesShaderManager.disable(r,t),i.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(r,t),super.endSlice(e,t,i)}}function pw(e=.5){return new J.TU(e,ef.j2)}var pC=i(4797);i(9547);let px=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function pE(e,t,i){e.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,36*t,i)}let pT=Float32Array.from([0,0,0,0,0,1,9,1,0,0,1,0,1,10,0,1,0,0,1,1,11,1,1,0,1,1,1,12,0,0,0,0,1,0,13,0,0,1,0,1,1,14,1,0,0,1,1,0,15,1,0,1,1,1,1,16,0,0,0,1,0,0,17,0,0,1,1,0,1,18,0,1,0,1,1,0,19,0,1,1,1,1,1,20]),pk=Z._E.create(),pD=new Float32Array(6);class pL extends o2{defineShader(e){hH(e);let{rank:t}=this;r9(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}vertexIdHelper=this.registerDisposer(hJ.get(this.gl));enable(e,t,i){Z._E.invert(pk,t.modelViewProjectionMatrix),(0,Z.Mb)(pk,pD);let{numChunkDisplayDims:r}=t.chunkDisplayTransform;for(let e=0;e<r;++e)pD[e]=0,pD[e+3]=0;for(let e=r;e<3;++e){let t=Math.abs(pD[e+3]-pD[e]);pD[e]-=t,pD[e+3]+=t}super.enable(e,t,e=>{let r=e.vertexShaderInputBinders.Bounds;r.enable(1);let{gl:n}=this;n.uniform3fv(e.uniform("uModelSpaceBoundOffsets"),pD),n.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:s}=this;s.enable(),i(e),s.disable(),r.disable()})}}function pI(e){e.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function pP(e){e.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function pR(e){pP(e),e.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}class pA extends pL{edgeBoxCornerOffsetsBuffer=this.registerDisposer(rm.fromData(this.gl,(0,H.X9)(pT,7,1,6)));edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{let{rank:t}=this;this.defineShader(e),sc(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),pR(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)});boxCornerOffsetsBuffer=this.registerDisposer(rm.fromData(this.gl,(0,H.X9)(ph,3,1,6)));cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{let{rank:t}=this;this.defineShader(e),hW(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),pR(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = 1u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)});drawEdges(e){let{gl:t}=this;this.enable(this.edgeShaderGetter,e,i=>{let r=i.attribute("aBoxCornerOffset1"),n=i.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1,28,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(n,4,WebGL2RenderingContext.FLOAT,!1,28,12),sh(i,e.renderContext.projectionParameters,1),su(t,12,e.count),t.disableVertexAttribArray(r),t.disableVertexAttribArray(n)})}drawCorners(e){let{gl:t}=this;this.enable(this.cornerShaderGetter,e,i=>{let r=i.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(r,3,WebGL2RenderingContext.FLOAT,!1),hq(i,e.renderContext.projectionParameters,{featherWidthInPixels:0}),su(i.gl,8,e.count),t.disableVertexAttribArray(r)})}draw(e){this.drawEdges(e),this.drawCorners(e)}}class pM extends pL{faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{let{rank:t}=this;super.defineShader(e),pg(e),sc(e),e.addVarying("highp float","vClipCoefficient"),pR(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / 6;
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)});fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{let{rank:t}=this;super.defineShader(e),pg(e),e.addVarying("highp float","vClipCoefficient"),pI(e),e.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});enableForBoundingBox(e,t,i){super.enable(e,t,e=>{let r=t.renderContext.sliceView.projectionParameters.value;pf(e,r.viewportNormalInGlobalCoordinates,r.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),i(e)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{!function(e,t,i,r,n){e.drawArraysInstanced(t,0,6,n)}(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,0,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{sh(t,e.renderContext.projectionParameters,1),su(t.gl,6,e.count)})}}o4(eB.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:pM,perspectiveViewRenderHelper:pA,defineShaderNoOpSetters(e){pP(e),pI(e)},pickIdsPerInstance:27,snapPosition(e,t,i,r){let n=new Float32Array(t,i,2*e.length);r>=1&&r<9&&function(e,t){let i=e.length;for(let r=0;r<i;++r){let n=t[r],s=t[r+i],a=e[r];e[r]=Math.abs(n-a)<Math.abs(s-a)?n:s}}(e,n)},getRepresentativePoint(e,t,i){e.set(t.pointA)},updateViaRepresentativePoint(e,t,i){let r=t.length,{pointA:n,pointB:s}=e,a=new Float32Array(r),o=new Float32Array(r);for(let e=0;e<r;++e){let i=a[e]=t[e];o[e]=s[e]+(i-n[e])}return{...e,pointA:a,pointB:o}}});function pN(e){e.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function pV(e){e.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}class pO extends o2{defineShader(e){hH(e);let{rank:t}=this;r9(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}vertexIdHelper=this.registerDisposer(hJ.get(this.gl));edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{let{rank:t}=this;this.defineShader(e),sc(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),pN(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)});endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{let{rank:t}=this;this.defineShader(e),hW(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),pV(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / 6;
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)});enable(e,t,i){super.enable(e,t,e=>{let r=e.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:n}=this;n.enable(),i(e),n.disable(),r.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{sh(t,e.renderContext.projectionParameters,1),su(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{hq(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),su(t.gl,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}}o4(eB.LINE,{sliceViewRenderHelper:pO,perspectiveViewRenderHelper:pO,defineShaderNoOpSetters(e){pN(e),pV(e)},pickIdsPerInstance:3,snapPosition(e,t,i,r){let n=new Float32Array(t,i,2*e.length);0===r?function(e,t){let i=e.length;(0,Z._r)(e,t.subarray(0,i),t.subarray(i),e)}(e,n):function(e,t,i){let r=e.length,n=r*i;for(let i=0;i<r;++i)e[i]=t[n+i]}(e,n,r-1)},getRepresentativePoint(e,t,i){e.set(0===i||1===i?t.pointA:t.pointB)},updateViaRepresentativePoint(e,t,i){let r={...e},n=t.length;switch(i){case 0:{let{pointA:i,pointB:r}=e,s=new Float32Array(n),a=new Float32Array(n);for(let e=0;e<n;++e){let n=s[e]=t[e];a[e]=r[e]+(n-i[e])}return{...e,pointA:s,pointB:a}}case 1:return{...e,pointA:new Float32Array(t)};case 2:return{...e,pointB:new Float32Array(t)}}return r}});class pF extends o2{defineShaderCommon(e){let{rank:t}=this;r9(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{hH(e),hW(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)});makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{hH(t),sc(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)});shaderGetter2d=this.makeShaderGetter2d(2);shaderGetter1d=this.makeShaderGetter2d(1);vertexIdHelper=this.registerDisposer(hJ.get(this.gl));enable(e,t,i){super.enable(e,t,e=>{let r=e.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset);let{vertexIdHelper:n}=this;n.enable(),i(e),n.disable(),r.disable()})}draw(e){let{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,t=>{hq(t,e.renderContext.projectionParameters,{featherWidthInPixels:1}),su(t.gl,1,e.count)});break;case 2:case 1:this.enable(2===t?this.shaderGetter2d:this.shaderGetter1d,e,t=>{sh(t,e.renderContext.projectionParameters,1),su(t.gl,1,e.count)})}}}o4(eB.POINT,{sliceViewRenderHelper:pF,perspectiveViewRenderHelper:pF,defineShaderNoOpSetters(e){e.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(e,t,i){e.set(new Float32Array(t,i,e.length))},getRepresentativePoint(e,t){e.set(t.point)},updateViaRepresentativePoint:(e,t)=>({...e,point:new Float32Array(t)})});let pB=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,p_=[pB,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`],pU=[pB,`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function p$(e,t){let i=new Float32Array((e+1)*(t+1)*3),r=0;for(let n=0;n<=e;++n){let s=n*Math.PI/e,a=Math.sin(s),o=Math.cos(s);for(let e=0;e<=t;++e){let n=2*e*Math.PI/t,s=Math.sin(n),l=Math.cos(n);i[r++]=l*a,i[r++]=o,i[r++]=s*a}}return i}function pz(e,t){let i=new Uint16Array(e*t*6),r=0;for(let n=0;n<e;n++)for(let e=0;e<t;e++){let s=n*(t+1)+e,a=s+t+1;i[r++]=s,i[r++]=a,i[r++]=s+1,i[r++]=a,i[r++]=a+1,i[r++]=s+1}return i}class pG extends eh.gj{vertexBuffer;indexBuffer;numIndices;constructor(e,t,i){super(),this.vertexBuffer=this.registerDisposer(rv(e,WebGL2RenderingContext.ARRAY_BUFFER,p$,t,i)).value,this.indexBuffer=this.registerDisposer(rv(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,pz,t,i)).value,this.numIndices=t*i*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){let i=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(i)}}let pj=Z._E.create();class pW extends o2{defineShader(e){let{rank:t}=this;r9(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,i){super.enable(e,t,e=>{let r=e.vertexShaderInputBinders.CenterAndRadii;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset),i(e),r.disable()})}}class pq extends pW{sphereRenderHelper=this.registerDisposer(new pG(this.gl,10,10));shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)});tempLightVec=new Float32Array(4);draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:i}=t,r=this.tempLightVec,{lightDirection:n,ambientLighting:s,directionalLighting:a}=e.renderContext;Z.R3.scale(r,n,a),r[3]=s,i.uniform4fv(t.uniform("uLightDirection"),r),i.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,Z._E.transpose(Z._E.create(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}}class pH extends pW{shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{hH(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(p_),e.addVertexCode(pU),e.addVertexCode(sd),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)});vertexIdHelper=this.registerDisposer(hJ.get(this.gl));draw(e){this.enable(this.shaderGetter,e,t=>{let{gl:i}=t,r=e.renderContext.sliceView.projectionParameters.value,n=Z._E.multiply(pj,e.renderSubspaceInvModelMatrix,r.invViewMatrix);i.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,n),i.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,r.projectionMat),Z._E.invert(pj,n),i.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,pj);let{vertexIdHelper:s}=this;s.enable(),su(i,1,e.count),s.disable()})}}o4(eB.ELLIPSOID,{sliceViewRenderHelper:pH,perspectiveViewRenderHelper:pq,defineShaderNoOpSetters(e){e.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(e,t){e.set(t.center)},updateViaRepresentativePoint:(e,t)=>({...e,center:new Float32Array(t)})});let pJ=Z._E.create(),pK=Z.R3.create();function pZ(e){e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),e.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}let pY={defineShader(e){pZ(e),sc(e),e.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),e.setVertexMain(`
int edgeIndex = gl_VertexID / 6;
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(e,t){sh(e,t,1)},draw(e,t,i){let{gl:r}=e,{chunkLayout:n}=t;Z._E.multiply(pJ,i.viewProjectionMat,n.transform),r.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,pJ),r.uniform3fv(e.uniform("uChunkDataSize"),n.size),r.uniform3fv(e.uniform("uLowerClipBound"),t.lowerClipDisplayBound),r.uniform3fv(e.uniform("uUpperClipBound"),t.upperClipDisplayBound);let s=n.size,{curPositionInChunks:a,chunkDisplayDimensionIndices:o}=t;for(let e=0;e<3;++e){let t=o[e];pK[e]=(-1===t?0:a[t])*s[e]}r.uniform3fv(e.uniform("uTranslation"),pK),su(r,12,1)}},pX={defineShader(e){pg(e),pZ(e),sc(e),e.setVertexMain(`
int vertexIndex1 = gl_VertexID / 6;
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(e,t){sh(e,t,1)},draw(e,t,i){let{gl:r}=e,{chunkLayout:n}=t;Z._E.multiply(pJ,i.viewProjectionMat,n.transform),r.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,pJ),r.uniform3fv(e.uniform("uChunkDataSize"),n.size),r.uniform3fv(e.uniform("uLowerClipBound"),t.lowerClipDisplayBound),r.uniform3fv(e.uniform("uUpperClipBound"),t.upperClipDisplayBound);let s=n.size,{curPositionInChunks:a,chunkDisplayDimensionIndices:o}=t;for(let e=0;e<3;++e){let t=o[e];pK[e]=(-1===t?0:a[t])*s[e]}r.uniform3fv(e.uniform("uTranslation"),pK),pf(e,i.viewportNormalInGlobalCoordinates,i.centerDataPosition,n.transform,n.invTransform),su(r,6,1)}},pQ=Z._E.create();class p0 extends iZ(la){chunkManager;source;segmentationStates;constructor(e,t,i,r){super(r),this.chunkManager=e,this.source=t,this.segmentationStates=i,this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:t.rpcId,segmentationStates:this.serializeDisplayState()}),this.registerDisposer(i.changed.add(()=>{let e={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke("annotation/RenderLayer.updateSegmentation",e)}))}serializeDisplayState(){let{value:e}=this.segmentationStates;if(void 0!==e)return e.map(e=>null==e?e:c4(e.segmentationGroupState.value))}}p0=function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([ij("annotation/RenderLayer")],p0);class p1 extends eh.gj{chunkManager;state;layerChunkProgressInfo;buffer;numPickIds;generation;redrawNeeded;serializedAnnotations;get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}handleChangeAffectingBuffer;sharedObject;get visibility(){let{sharedObject:e}=this;if(void 0!==e)return e.visibility}segmentationStates;constructor(e,t){super(),this.chunkManager=e,this.state=t,this.layerChunkProgressInfo=new ia,this.numPickIds=0,this.generation=-1,this.redrawNeeded=new eO.K_,this.serializedAnnotations=void 0,this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()},this.registerDisposer(t),this.segmentationStates=this.registerDisposer((0,J.mo)((e,t)=>{let{displayState:i,source:r}=this.state,{relationshipStates:n}=i;return i.displayUnfiltered.value?void 0:r.relationships.map(e=>{let t=n.get(e);return t.showMatches.value?t.segmentationState.value:void 0})},[this.state.displayState.relationshipStates,this.state.displayState.ignoreNullSegmentFilter],(e,t)=>void 0===e||void 0===t?e===t:(0,H.cO)(e,t))),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer((0,J.Uw)((e,t)=>{if(this.handleChangeAffectingBuffer(),void 0!==t)for(let i of t)null!=i&&e.registerDisposer((0,J.w)((e,t)=>{e.registerDisposer(t.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),e.registerDisposer(t.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},i.segmentationGroupState))},this.segmentationStates)),this.source instanceof e3||(this.sharedObject=this.registerDisposer(new p0(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));let{displayState:i}=this.state;this.registerDisposer(i.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get gl(){return this.chunkManager.gl}updateBuffer(){let{source:e}=this;if(e instanceof e3){let t=e.changed.count;if(this.generation!==t){let{buffer:i}=this;void 0===i&&(i=this.buffer=this.registerDisposer(new rm(this.chunkManager.gl))),this.generation=t;let r=this.serializedAnnotations=function(e,t){let i=new e8(e.annotationPropertySerializers);for(let r of e)(void 0===t||t(r))&&i.add(r);return i.serialize()}(e,function(e){if(void 0!==e)return t=>{let{relatedSegments:i}=t;if(void 0===i)return!1;for(let t=0,r=i.length;t<r;++t){let r=e[t];if(null==r)continue;let{visibleSegments:n,segmentEquivalences:s}=r.segmentationGroupState.value;for(let e of i[t])if(n.has(s.get(e)))return!0}return!1}}(this.segmentationStates.value));i.setData(this.serializedAnnotations.data),this.numPickIds=lL(r)}}}}function p2(e){let{chunkTransform:t}=e,{unpaddedRank:i}=t.modelTransform,r=new Float32Array(2*i),n=new Float32Array(3*i);n.fill(0),r.fill(1,i);let{numChunkDisplayDims:s,chunkDisplayDimensionIndices:a}=e;for(let e=0;e<s;++e){let t=a[e];r[i+t]=0,n[3*t+e]=1}return{modelClipBounds:r,renderSubspaceTransform:n}}function p3(e,t,i){let r;i.clearMessages();let n=e=>{i.addMessage({severity:iT.error,message:e})};if(void 0!==e.error)return n(e.error);let s=t8(e.modelTransform,t.displayDimensionIndices);try{r=t9(e,s)}catch(e){return n(e.message)}let{modelClipBounds:a,renderSubspaceTransform:o}=p2(r);return{chunkTransform:e,chunkDisplayTransform:r,modelClipBounds:a,renderSubspaceTransform:o}}function p4(e,t){return class extends e{base;renderScaleHistogram;curRank;renderHelpers;tempChunkPosition;handleRankChanged(){let{rank:e}=this.base.source;if(e===this.curRank)return;this.curRank=e,this.tempChunkPosition=new Float32Array(e);let{renderHelpers:i,gl:r}=this;for(let e of i)e.dispose();let{properties:n}=this.base.source,{displayState:s}=this.base.state;for(let a of e_){let o=o6(a),l=o[t],d=i[a]=new l(r,a,e,n,s.shaderControls,s.fallbackShaderControls,s.shaderError);d.pickIdsPerInstance=o.pickIdsPerInstance,d.targetIsSliceView="sliceViewRenderHelper"===t}}constructor(e,t){super(),this.base=e,this.renderScaleHistogram=t,this.curRank=-1,this.renderHelpers=[],this.isAnnotation=!0;let i=e.visibility;void 0!==i&&this.registerDisposer(i.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(let e of this.renderHelpers)e.dispose()}),this.role=e.state.role,this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged(),this.registerDisposer(this.base.state.displayState.shaderControls.histogramSpecifications.producerVisibility.add(this.visibility))}attach(e){super.attach(e),this.handleRankChanged();let{chunkTransform:t}=this,i=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:i,chunkRenderParameters:p3(t,i,e.messages)}}updateAttachmentState(e){let t=e.state;this.handleRankChanged();let{chunkTransform:i}=this,r=e.view.displayDimensionRenderInfo.value;return void 0!==t&&t.chunkTransform===i&&t.displayDimensionRenderInfo===r?t.chunkRenderParameters:(t.chunkTransform=i,t.displayDimensionRenderInfo=r,t.chunkRenderParameters=p3(i,r,e.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(e,t){let{modelClipBounds:i}=t,r=this.curRank,{chunkTransform:n}=t;t7(i.subarray(0,r),e.projectionParameters.globalPosition,this.base.state.localPosition.value,n.layerRank,n.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(e,t,i,r=1){if(!e.bufferValid){let{buffer:t}=e;void 0===t&&(t=e.buffer=new rm(this.gl));let{serializedAnnotations:i}=e;t.setData(i.data),e.numPickIds=lL(i),e.bufferValid=!0}this.drawGeometry(e,t,i,r)}drawGeometry(e,t,i,r=1){let{base:n}=this,{chunkDisplayTransform:s}=i,{serializedAnnotations:a}=e,{typeToIdMaps:o,typeToOffset:l}=a,d=0;t.emitPickID&&(d=t.pickIDs.register(this,e.numPickIds,0n,e));let u=n.hoverState.value,c=Z._E.multiply(pQ,t.projectionParameters.viewProjectionMat,s.displaySubspaceModelMatrix),h={annotationLayer:n,renderContext:t,selectedIndex:0,basePickId:d,buffer:e.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:c,modelClipBounds:i.modelClipBounds,subspaceMatrix:i.renderSubspaceTransform,renderSubspaceModelMatrix:s.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:s.displaySubspaceInvModelMatrix,chunkDisplayTransform:s},p=this.base.state.displayState.shaderControls.histogramSpecifications.visibleHistograms>0;for(let e of e_){let i=o[e],n=i.size;if(n>0){let s=o6(e),a=0xffffffff;if(void 0!==u){let e=i.get(u.id);void 0!==e&&(a=e*s.pickIdsPerInstance)}n=Math.round(n*r),h.count=n,h.bufferOffset=l[e],h.selectedIndex=a;let o=this.renderHelpers[e];o.draw(h),p&&(o.computeHistograms(h,t.frameNumber),t.bindFramebuffer()),h.basePickId+=n*s.pickIdsPerInstance}}}updateMouseState(e,t,i,r){let{serializedAnnotations:n}=r,{typeToIds:s,typeToOffset:a}=n,o=this.curRank,l=this.chunkTransform;if(void 0===l.error)for(let t of e_){let r=s[t],d=o6(t),{pickIdsPerInstance:u}=d;if(i<r.length*u){let s=Math.floor(i/u),c=r[s],h=i%u;e.pickedAnnotationId=c,e.pickedAnnotationLayer=this.base.state,e.pickedOffset=h,e.pickedAnnotationBuffer=n.data.buffer,e.pickedAnnotationType=t,e.pickedAnnotationBufferBaseOffset=n.data.byteOffset+a[t],e.pickedAnnotationIndex=s,e.pickedAnnotationCount=r.length;let p=this.tempChunkPosition,{chunkToLayerTransform:g,combinedGlobalLocalToChunkTransform:f,layerRank:m}=l,{globalToRenderLayerDimensions:v}=l.modelTransform,{position:y}=e;if(!t7(p,y,this.base.state.localPosition.value,m,f))return;let b=this.base.source.annotationPropertySerializers[t];d.snapPosition(p,e.pickedAnnotationBuffer,e.pickedAnnotationBufferBaseOffset+e.pickedAnnotationIndex*b.propertyGroupBytes[0],h);let S=v.length;for(let e=0;e<S;++e){let t=v[e];if(-1===t)continue;let i=g[(o+1)*o+t];for(let e=0;e<o;++e)i+=p[e]*g[e*(m+1)+t];Number.isFinite(i)&&(y[e]=i)}return}i-=r.length*u}}transformPickedValue(e){let{pickedAnnotationBuffer:t}=e;if(void 0===t)return;let{properties:i}=this.base.source;if(0===i.length)return;let{pickedAnnotationBufferBaseOffset:r,pickedAnnotationType:n,pickedAnnotationIndex:s,pickedAnnotationCount:a}=e,{annotationPropertySerializers:o}=this.base.source,l=Array(i.length);return o[n].deserialize(new DataView(t),r,s,a,ep.LITTLE===eg,l),function(e,t){switch(e.type){case"rgb":return er(et(t));case"rgba":return er(ei(t));default:return eW(e,t)}}(i[0],l[0])}isAnnotation}}let p6=e=>class extends e{layerChunkProgressInfo=this.base.layerChunkProgressInfo;draw(e,t){let i=this.updateAttachmentState(t);if(0===this.curRank||void 0===i)return;this.updateModelClipBounds(e,i);let{source:r}=this.base;if(r instanceof e3){let{base:t}=this;t.updateBuffer(),this.drawGeometry(t,e,i)}else{let{renderScaleHistogram:t}=this;t.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(r.temporary.data,e,i);let{value:n}=this.base.segmentationStates,s=0,a=0;if(void 0!==n)for(let t=0,o=n.length;t<o;++t){let o=n[t];if(null==o)continue;let l=r.segmentFilteredSources[t].chunks;lc(o.segmentationGroupState.value,t=>{let r=ld(t),n=l.get(r);if(void 0!==n&&n.state===it.GPU_MEMORY){let{data:t}=n;if(void 0===t)return;this.drawGeometryChunkData(t,e,i),++s}else++a})}t.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,s,a)}}isReady(){let{base:e}=this,{source:t}=e;if(!(t instanceof lU))return!0;let{value:i}=this.base.segmentationStates;if(void 0===i)return!0;for(let e=0,r=i.length;e<r;++e){let r=i[e];if(null===r)return!1;if(void 0===r)continue;let n=t.segmentFilteredSources[e].chunks,s=!1;if(lc(r.segmentationGroupState.value,e=>{let t=ld(e);n.has(t)||(s=!0)}),s)return!1}return!0}},p5=p4(uW,"perspectiveViewRenderHelper");class p8 extends p6(p5){}let p9=e=>{class t extends e{renderScaleTarget;constructor(e){super(e.annotationLayer,e.renderScaleHistogram),this.renderScaleTarget=e.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));let t=this.registerDisposer(new la(this.layerChunkProgressInfo)),i=this.base.chunkManager.rpc;t.RPC_TYPE_ID="annotation/SpatiallyIndexedRenderLayer",t.initializeCounterpart(i,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(iH.makeFromExisting(i,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(iH.makeFromExisting(i,this.renderScaleTarget)).rpcId}),this.backend=t}backend;attach(e){super.attach(e),e.state.sources=e.registerDisposer((0,J.Uw)((t,i,r)=>{let n=lk(r,i,e=>this.base.state.source.getSources(e),e.messages,this);for(let e of n)for(let i of e)t.registerDisposer(i.source),Object.assign(i,p2(i.chunkDisplayTransform));return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke("annotation/PerspectiveRenderLayer:updateSources",{layer:this.backend.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:r,sources:lb(n)}),this.redrawNeeded.dispatch(),n},this.base.state.transform,e.view.displayDimensionRenderInfo))}wireFrameRenderHelper=this instanceof lm?pX:pY;wireFrameShaderGetter=rg(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof lm}`,parameters:(0,J.ne)(void 0),defineShader:e=>{this.wireFrameRenderHelper.defineShader(e)}});draw(e,t){let i;let r=this.updateAttachmentState(t);if(0===this.curRank||void 0===r)return;let n=t.state.sources.value;if(0===n.length)return;this.updateModelClipBounds(e,r);let{renderScaleHistogram:s}=this;s.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let{projectionParameters:a}=e;if(e.wireFrame){let{shader:t}=this.wireFrameShaderGetter(e.emitter);if(null===t)return;t.bind(),this.wireFrameRenderHelper.initialize(t,a),i=t}oK(a,this.base.state.localPosition.value,this.renderScaleTarget.value,n[0],()=>{},(t,n,o,l,d)=>{let u;let c=t.source.chunks.get(t.curPositionInChunks.join());if(void 0===c||c.state!==it.GPU_MEMORY)u=0;else{let{data:n}=c;if(void 0===n)return;void 0!==i?this.wireFrameRenderHelper.draw(i,t,a):this.drawGeometryChunkData(n,e,r,o),u=1}s.add(l,d,u,1-u)})}isReady(e,t){let i=this.updateAttachmentState(t);if(0===this.curRank||void 0===i)return;let r=t.state.sources.value;if(0===r.length)return;this.updateModelClipBounds(e,i);let{projectionParameters:n}=e,s=!0;return oK(n,this.base.state.localPosition.value,this.renderScaleTarget.value,r[0],()=>{},(e,t,i,r,n)=>{let a=e.source.chunks.get(e.curPositionInChunks.join());if(void 0===a||a.state!==it.GPU_MEMORY){s=!1;return}}),s}}return t},p7=p9(p5),ge=p9(p4(lm,"sliceViewRenderHelper")),gt=p6(p4(lm,"sliceViewRenderHelper"));var gi=i(9314);function gr(e={}){return sC({svg:gi,...e})}var gn=i(888);function gs(e={}){let t=sC({svg:gn,...e});return t.firstElementChild.style.fill="white",t}class ga{anchorIndex=0;anchorClientOffset=0;splice(e){let{anchorIndex:t}=this,i=0;for(let r of e){if(t<(i+=r.retainCount))break;let{deleteCount:e}=r;if(t<i+e){t=i;break}let{insertCount:n}=r;t=t-e+n,i+=n-n}this.anchorIndex=t}}class go{startIndex=0;endIndex=0;anchorIndex=0;anchorOffset=0;scrollOffset=0;viewportWidth=0}class gl{itemSize=[];totalKnownSize=0;numItemsInTotalKnownSize=0;get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){return this.itemSize[e]??this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,i=0){for(;t<e;++t)i+=this.getEstimatedSize(t);for(;t>e;--t)i-=this.getEstimatedSize(t-1);return i}getRangeSize(e,t){let i=0,{itemSize:r,averageSize:n}=this;for(let s=e;s<t;++s)i+=r[s]??n;return i}splice(e){let{itemSize:t}=this;t=this.itemSize=(0,H.x)(t,e),this.totalKnownSize=t.reduce((e,t)=>e+t,0),this.numItemsInTotalKnownSize=t.reduce(e=>e+1,0)}}class gd extends eh.gj{element=document.createElement("div");scrollContent=document.createElement("div");header=document.createElement("div");body=document.createElement("div");topItems=document.createElement("div");bottomItems=document.createElement("div");renderedItems=[];renderGeneration=-1;listGeneration=-1;newRenderedItems=[];state=new ga;renderParams=new go;newRenderParams=new go;sizes=new gl;source;debouncedUpdateView=this.registerCancellable((0,io.H)(()=>this.updateView()));resizeObserver=new ResizeObserver(()=>this.debouncedUpdateView());constructor(e){super();let{selectedIndex:t}=e;void 0!==t&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);let i=this.source=e.source;this.sizes.itemSize.length=i.length;let{element:r,header:n,body:s,scrollContent:a,topItems:o,bottomItems:l}=this;this.resizeObserver.observe(r),this.registerDisposer(()=>this.resizeObserver.disconnect()),r.appendChild(a),r.style.overflowAnchor="none",a.appendChild(n),a.appendChild(s),n.style.position="sticky",n.style.zIndex="1",n.style.top="0",e.horizontalScroll?(a.style.width="min-content",a.style.minWidth="100%",n.style.width="min-content",n.style.minWidth="100%",l.style.width="min-content",l.style.minWidth="100%"):(a.style.width="100%",n.style.width="100%",l.style.width="100%"),s.appendChild(o),s.appendChild(l),o.style.width="min-content",o.style.position="relative",o.style.height="0",o.style.minWidth="100%",l.style.height="0",l.style.position="relative",r.addEventListener("scroll",()=>{let e=r.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-e,this.renderParams.scrollOffset=e,this.debouncedUpdateView()}),void 0!==i.changed&&this.registerDisposer(i.changed.add(e=>{this.sizes.splice(e),this.state.splice(e),this.renderedItems.length=0,this.debouncedUpdateView()})),void 0!==i.renderChanged&&this.registerDisposer(i.renderChanged.add(this.debouncedUpdateView))}updateView(){let e;let{element:t}=this,i=t.clientHeight-this.header.offsetHeight,r=t.clientWidth,{source:n,state:s,sizes:a}=this,o=n.length,{body:l,topItems:d,bottomItems:u}=this,{changed:c,renderChanged:h}=n;for(;;){var p;let t;e=this.newRenderParams;let n=this.renderParams;if(!function(e,t,i,r,n,s){let a,o,l,d,u;let{anchorIndex:c,anchorClientOffset:h}=s,p=n.getEstimatedOffset(c);if(0===r||0===n.totalKnownSize)o=Math.min(i,(a=Math.max(0,c-5))+10),u=c,l=0,d=h;else{let e=(d=Math.max(0,Math.min(Math.max(0,n.getEstimatedTotalSize()-r),d=p-h)))-1*r,s=d-.5*r,g=d+r+.5*r,f=p-h+r+1*r;a=Math.min(i,t.startIndex);let m=n.getEstimatedOffset(a,c,p);if(m<e)for(;a+1<i;++a){let e=n.getEstimatedSize(a);if(m+e>=s)break;m+=e}if(m>=s)for(;m>e&&a>0;--a)m-=n.getEstimatedSize(a-1);o=Math.min(i,t.endIndex);let v=n.getEstimatedOffset(o,c,p);if(v<g)for(;v<=f&&o+1<=i;++o)v+=n.getEstimatedSize(o);else if(v>=f)for(;o>a;--o){let e=n.getEstimatedSize(o-1);if(v-e<g)break;v-=e}for(u=c,l=p;u<a;++u)l+=n.getEstimatedSize(u);for(;u>o;--u)l-=n.getEstimatedSize(u-1)}e.startIndex=a,e.endIndex=o,e.anchorIndex=u,e.anchorOffset=l,e.scrollOffset=d}(e,n,o,i,a,s),e.viewportWidth=r,void 0!==h&&h.count!==this.renderGeneration||void 0!==c&&c.count!==this.listGeneration?(this.renderGeneration=void 0===h?-1:h.count,this.listGeneration=void 0===c?-1:c.count,t=!0,this.renderedItems.length=0):t=!1,!t&&!((p=e).startIndex<n.startIndex)&&!(p.endIndex>n.endIndex)&&(0===p.viewportWidth||0!==n.viewportWidth)){n.scrollOffset=e.scrollOffset,e=n;break}this.renderParams=e,this.newRenderParams=n;let l=this.renderedItems,f=this.newRenderedItems;f.length=0,this.renderedItems=f,this.newRenderedItems=l;let{source:m}=this,{render:v}=m,{startIndex:y,endIndex:b,anchorIndex:S}=e;function*g(e,t){for(let i=e;i<t;++i){let e=l[i];void 0===e&&(e=v.call(m,i)),f[i]=e,yield e}}sS(d,g(y,S)),sS(u,g(S,b));for(let e=y;e<b;++e){let t=f[e].getBoundingClientRect().height,i=a.itemSize[e];void 0!==i&&(a.totalKnownSize-=i,--a.numItemsInTotalKnownSize),a.itemSize[e]=t,a.totalKnownSize+=t,++a.numItemsInTotalKnownSize}}!function(e,t){let i=t.getEstimatedOffset(e.anchorIndex),r=e.anchorOffset;e.anchorOffset=i,e.scrollOffset+=i-r}(e,a),s.anchorIndex=e.anchorIndex,s.anchorClientOffset=e.anchorOffset-e.scrollOffset;let f=a.getRangeSize(e.startIndex,e.anchorIndex),m=a.getEstimatedTotalSize()||0;l.style.height=`${m}px`,d.style.top=`${e.anchorOffset-f}px`,u.style.top=`${e.anchorOffset}px`,t.scrollTop=e.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){let{startIndex:t,endIndex:i}=this.renderParams,{renderedItems:r}=this;for(let n=t;n<i;++n){let t=r[n];void 0!==t&&e(t,n)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){let t=this.sizes.getEstimatedOffset(e),i=t+this.sizes.getEstimatedSize(e),r=this.element.scrollTop;if(t<r)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else{if(!(t>r)||!(i>r+this.element.offsetHeight))return;this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight}this.debouncedUpdateView()}disposed(){sy(this.element)}}class gu extends eh.gj{changed=new eO.K_;isLoadingChanged=new eO.K_;states=[];relationships=[];loadingCount=0;get value(){return this.states}get isLoading(){return 0!==this.loadingCount}markLoading(){return this.loadingCount++,()=>{0==--this.loadingCount&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{let i=e.sourceIndex-t.sourceIndex;return 0!==i?i:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){let e=new Set;for(let t of this.states)for(let i of t.source.relationships)e.add(i);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{let t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}}function gc(e,t,i){void 0===t.error&&e.setLayerPosition(t.modelTransform,i)}function gh(e,t,i){let{layerRank:r}=t,n=new Float32Array(r);e1[e.type].visitGeometry(e,(e,s)=>{n.set(e);let a=new Float32Array(r);(s?e9.lU:e9.DC)(a,t.chunkToLayerTransform,r+1,n,r),i(a,s)})}class gp extends sE{layer;displayState;previousSelectedState;previousHoverId;previousHoverAnnotationLayerState;virtualListSource;virtualList;listElements;updated;mutableControls;headerRow;get annotationStates(){return this.layer.annotationStates}attachedAnnotationStates;updateAttachedAnnotationLayerStates(){let e=this.annotationStates.states,{attachedAnnotationStates:t}=this,i=new Map;for(let[i,r]of t)e.includes(i)||(t.delete(i),r.refCounted.dispose());for(let r of e){let e=t.get(r);if(void 0!==e){i.set(r,e);continue}let n=r.source,s=new eh.gj;n instanceof e3&&(s.registerDisposer(n.childAdded.add(e=>this.addAnnotationElement(e,r))),s.registerDisposer(n.childUpdated.add(e=>this.updateAnnotationElement(e,r))),s.registerDisposer(n.childDeleted.add(e=>this.deleteAnnotationElement(e,r)))),s.registerDisposer(r.transform.changed.add(this.forceUpdateView)),i.set(r,{refCounted:s,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=i,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}forceUpdateView;globalDimensionIndices;localDimensionIndices;curCoordinateSpaceGeneration;prevCoordinateSpaceGeneration;columnWidths;gridTemplate;updateCoordinateSpace(){let e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,i=[],r=[];for(let e=0,r=t.rank;e<r;++e)this.annotationStates.states.some(t=>{let i=t.transform.value;return void 0===i.error&&-1!==i.globalToRenderLayerDimensions[e]})&&i.push(e);for(let t=0,i=e.rank;t<i;++t)this.annotationStates.states.some(e=>{let i=e.transform.value;return void 0===i.error&&-1!==i.localToRenderLayerDimensions[t]})&&r.push(t);this.localDimensionIndices=r,this.globalDimensionIndices=i,++this.curCoordinateSpaceGeneration}constructor(e,t){super(),this.layer=e,this.displayState=t,this.previousSelectedState=void 0,this.previousHoverId=void 0,this.previousHoverAnnotationLayerState=void 0,this.virtualListSource={length:0,render:e=>this.render(e),changed:new eO.MZ},this.virtualList=new gd({source:this.virtualListSource}),this.listElements=[],this.updated=!1,this.mutableControls=document.createElement("div"),this.headerRow=document.createElement("div"),this.attachedAnnotationStates=new Map,this.forceUpdateView=()=>{this.updated=!1,this.updateView()},this.globalDimensionIndices=[],this.localDimensionIndices=[],this.curCoordinateSpaceGeneration=-1,this.prevCoordinateSpaceGeneration=-1,this.columnWidths=[],this.gridTemplate="",this.element.classList.add("neuroglancer-annotation-layer-view"),this.selectedAnnotationState=(0,J.og)((e,t)=>{if(void 0===e)return;let{layer:i}=this,r=e.layers.find(e=>e.layer===i)?.state;if(void 0===r)return;let{annotationId:n}=r;if(void 0===n)return;let s=this.annotationStates.states.find(e=>e.sourceIndex===r.annotationSourceIndex&&(void 0===r.annotationSubsource||e.subsourceId===r.annotationSubsource));if(void 0!==s)return{annotationId:n,annotationLayerState:s,pin:t}},e.manager.root.selectionState,e.manager.root.selectionState.pin),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(this.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");let i=document.createElement("div");if(i.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this),e.constructor.supportColorPickerInAnnotationTab){let e=this.registerDisposer(new sg(this.displayState.color));e.element.title="Change annotation display color",this.registerDisposer(new i6((0,J.og)(e=>null!==e.match(/\bdefaultColor\b/),t.shaderControls.processedFragmentMain),e.element)),i.appendChild(e.element)}let{mutableControls:r}=this,n=sC({text:e1[eB.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new gw(this.layer,{})}});r.appendChild(n);let s=sC({text:e1[eB.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new gT(this.layer,{})}});r.appendChild(s);let a=sC({text:e1[eB.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new gk(this.layer,{})}});r.appendChild(a);let o=sC({text:e1[eB.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new gD(this.layer,{})}});r.appendChild(o);let l=sC({title:"The left icons allow you to select the type of the anotation. Color and other display settings are available in the 'Rendering' tab.",svg:pC,clickable:!1});l.style.marginLeft="auto",r.appendChild(l),i.appendChild(r),this.element.appendChild(i),this.element.appendChild(this.headerRow);let{virtualList:d}=this;d.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(d.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});let c=(void 0===u&&(u=se.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[cv(),0]]})),u);this.registerDisposer(new sa(this.virtualList.element,c)),this.virtualList.element.title=c.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}getRenderedAnnotationListElement(e,t,i=!1){let r=this.attachedAnnotationStates.get(e);if(void 0===r)return;let n=r.idToIndex.get(t);if(void 0===n)return;let s=r.listOffset+n;return i&&this.virtualList.scrollItemIntoView(n),this.virtualList.getItemElement(s)}clearSelectionClass(){let{previousSelectedState:e}=this;if(void 0===e)return;this.previousSelectedState=void 0;let t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);void 0!==t&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){let{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(void 0!==t){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;let i=this.getRenderedAnnotationListElement(t,e);void 0!==i&&i.classList.remove("neuroglancer-annotation-hover")}}selectedAnnotationState;updateSelectionView(){let e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||void 0!==t&&void 0!==e&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,void 0===e))return;let i=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);void 0!==i&&i.classList.add("neuroglancer-annotation-selected")}updateHoverView(){let e,t;let i=this.displayState.hoverState.value;void 0!==i&&(e=i.id,t=i.annotationLayerState);let{previousHoverId:r,previousHoverAnnotationLayerState:n}=this;if(e===r&&t===n||(this.clearHoverClass(),this.previousHoverId=e,this.previousHoverAnnotationLayerState=t,void 0===e))return;let s=this.getRenderedAnnotationListElement(t,e);void 0!==s&&s.classList.add("neuroglancer-annotation-hover")}render(e){let{annotation:t,state:i}=this.listElements[e];return this.makeAnnotationListElement(t,i)}setColumnWidth(e,t){t+=2;let{columnWidths:i}=this;!(i[e]>t)&&(i[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;let{columnWidths:e}=this;e.length=0;let{headerRow:t}=this,i=document.createElement("div");i.style.gridColumn="symbol";let r=document.createElement("div");r.style.gridColumn="delete",sv(t),t.appendChild(i);let n=0,s="[symbol] 2ch",a=(e,i)=>{let r=document.createElement("div");r.classList.add("neuroglancer-annotations-view-dimension");let a=document.createElement("span");a.classList.add("neuroglancer-annotations-view-dimension-name"),a.textContent=e.names[i];let o=document.createElement("scale");o.classList.add("neuroglancer-annotations-view-dimension-scale"),o.textContent=ta(e.scales[i],e.units[i],{precision:2}),r.appendChild(a),r.appendChild(o),r.style.gridColumn=`dim ${n+1}`,this.setColumnWidth(n,o.textContent.length+a.textContent.length+3),s+=` [dim] var(--neuroglancer-column-${n}-width)`,++n,t.appendChild(r)},o=this.layer.manager.root.coordinateSpace.value;for(let e of this.globalDimensionIndices)a(o,e);let l=this.layer.localCoordinateSpace.value;for(let e of this.localDimensionIndices)a(l,e);t.appendChild(r),s+=" [delete] 2ch",this.gridTemplate=s,t.style.gridTemplateColumns=s,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1,{listElements:t}=this;for(let[i,r]of(t.length=0,this.attachedAnnotationStates)){if(i.source.readonly||(e=!0),void 0!==i.chunkTransform.value.error)continue;let{source:n}=i,s=Array.from(n);r.annotations=s;let{idToIndex:a}=r;a.clear();for(let e=0,t=s.length;e<t;++e)a.set(s[e].id,e);for(let e of s)t.push({state:i,annotation:e})}let i=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:i,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(let t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let i=this.attachedAnnotationStates.get(t);if(void 0!==i){let r=i.annotations.length;i.annotations.push(e),i.idToIndex.set(e.id,r);let n=i.listOffset+r;this.listElements.splice(n,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:n,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let i=this.attachedAnnotationStates.get(t);if(void 0!==i){let t=i.idToIndex.get(e.id);if(void 0!==t){let r=i.listOffset+t;i.annotations[t]=e,this.listElements[r].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}let i=this.attachedAnnotationStates.get(t);if(void 0!==i){let{idToIndex:t}=i,r=t.get(e);if(void 0!==r){let n=i.listOffset+r,{annotations:s}=i;s.splice(r,1),t.delete(e);for(let e=r,i=s.length;e<i;++e)t.set(s[e].id,e);this.listElements.splice(n,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:n,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){let i;let r=t.chunkTransform.value,n=document.createElement("div");n.classList.add("neuroglancer-annotation-list-entry"),n.dataset.color=t.displayState.color.toString(),n.style.gridTemplateColumns=this.gridTemplate;let s=document.createElement("div");s.className="neuroglancer-annotation-icon",s.textContent=e1[e.type].icon,n.appendChild(s);let a=()=>{!t.source.readonly&&void 0===i&&((i=gs({title:"Delete annotation",onClick:i=>{i.stopPropagation(),i.preventDefault();let r=t.source.getReference(e.id);try{t.source.delete(r)}finally{r.dispose()}}})).classList.add("neuroglancer-annotation-list-entry-delete"),n.appendChild(i))},o=0;if(gh(e,r,(e,t)=>{++o;let i=document.createElement("div");i.className="neuroglancer-annotation-position",n.appendChild(i);let s=0,l=(t,r)=>{for(let n of t){let t=r[n];if(-1!==t){let r=Math.floor(e[t]),n=document.createElement("div"),a=r.toString();n.textContent=a,n.classList.add("neuroglancer-annotation-coordinate"),n.style.gridColumn=`dim ${s+1}`,this.setColumnWidth(s,a.length),i.appendChild(n)}++s}};l(this.globalDimensionIndices,r.modelTransform.globalToRenderLayerDimensions),l(this.localDimensionIndices,r.modelTransform.localToRenderLayerDimensions),a()}),e.description){++o;let t=document.createElement("div");t.classList.add("neuroglancer-annotation-description"),t.textContent=e.description,n.appendChild(t)}s.style.gridRow=`span ${o}`,void 0!==i&&(i.style.gridRow=`span ${o}`),n.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),n.addEventListener("action:select-position",i=>{i.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),n.addEventListener("action:pin-annotation",i=>{i.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),n.addEventListener("action:move-to-annotation",t=>{t.stopPropagation(),t.preventDefault();let{layerRank:i}=r,n=new Float32Array(i),s=new Float32Array(i);(function(e,t){switch(t.type){case eB.AXIS_ALIGNED_BOUNDING_BOX:case eB.LINE:tu(e,t.pointA,t.pointB),function(e,t,i){let r=e.length;for(let i=0;i<r;++i)e[i]=.5*t[i]}(e,e,0);break;case eB.POINT:e.set(t.point);break;case eB.ELLIPSOID:e.set(t.center)}})(n,e),e9.DC(s,r.chunkToLayerTransform,i+1,n,i),gc(this.layer,r,s)});let l=this.selectedAnnotationState.value;return void 0!==l&&l.annotationLayerState===t&&l.annotationId===e.id&&n.classList.add("neuroglancer-annotation-selected"),n}}class gg extends sE{layer;layerView;constructor(e){super(),this.layer=e,this.layerView=this.registerDisposer(new gp(e,e.annotationDisplayState));let{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}}function gf(e,t=!1){let i=[],{relationships:r}=e.source,{relationshipStates:n}=e.displayState;for(let e=0,s=r.length;e<s;++e){let s=n.get(r[e]).segmentationState.value;if(null!=s&&s.segmentSelectionState.hasSelectedSegment){i[e]=[s.segmentSelectionState.selectedSegment],t&&(i[e]=[...i[e],s.segmentSelectionState.baseSelectedSegment]);continue}i[e]=[]}return i.map(e=>BigUint64Array.from(e))}class gm extends ac{constructor(e,t){super(e)}get annotationLayer(){for(let e of this.layer.annotationStates.states)if(!e.source.readonly)return e}}let gv="annotatePoint",gy="annotateLine",gb="annotateBoundingBox",gS="annotateSphere";class gw extends gm{trigger(e){let{annotationLayer:t}=this;if(void 0!==t&&e.updateUnconditionally()){let i=gC(e,t);if(void 0===i)return;let r={id:"",description:"",relatedSegments:gf(t),point:i,type:eB.POINT,properties:t.source.properties.map(e=>e.default)},n=t.source.add(r,!0);this.layer.selectAnnotation(t,n.id,!0),n.dispose()}}get description(){return"annotate point"}toJSON(){return gv}}function gC(e,t){let i=t.chunkTransform.value;if(void 0!==i.error)return;let r=new Float32Array(i.modelTransform.unpaddedRank);if(t7(r,e.unsnappedPosition,t.localPosition.value,i.layerRank,i.combinedGlobalLocalToChunkTransform))return r}class gx extends gm{inProgressAnnotation=new J.SN(void 0);trigger(e){let{annotationLayer:t,inProgressAnnotation:i}=this;if(void 0!==t&&e.updateUnconditionally()){let r=()=>{let r=i.value,n=r.reference,s=this.getUpdatedAnnotation(n.value,e,t);JSON.stringify(e2(s,t.source))!==JSON.stringify(e2(n.value,t.source))&&(r.annotationLayer.source.update(n,s),this.layer.selectAnnotation(t,n.id,!0))};if(void 0===i.value){let n=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,n.id,!0);let s=e.changed.add(r);i.value={annotationLayer:t,reference:n,disposer:()=>{s(),n.dispose()}}}else{r();let e=i.value;e.annotationLayer.source.commit(e.reference),e.disposer(),i.value=void 0}}}disposed(){this.deactivate(),super.disposed()}deactivate(){let e=this.inProgressAnnotation.value;void 0!==e&&(e.annotationLayer.source.delete(e.reference),e.disposer(),this.inProgressAnnotation.value=void 0)}}class gE extends gx{getInitialAnnotation(e,t){let i=gC(e,t);return{id:"",type:this.annotationType,description:"",pointA:i,pointB:i,properties:t.source.properties.map(e=>e.default)}}getUpdatedAnnotation(e,t,i){let r=gC(t,i);return void 0===r?e:{...e,pointB:r}}}class gT extends gE{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,i){let r=super.getUpdatedAnnotation(e,t,i),{pointA:n,pointB:s}=r,a=n.length;for(let e=0;e<a;++e)n[e]===s[e]&&(s[e]+=1);return r}toJSON(){return gb}}gT.prototype.annotationType=eB.AXIS_ALIGNED_BOUNDING_BOX;class gk extends gE{getBaseSegment=!1;get description(){return"annotate line"}initialRelationships;getInitialAnnotation(e,t){let i=super.getInitialAnnotation(e,t);return this.initialRelationships=i.relatedSegments=gf(t,this.getBaseSegment),i}getUpdatedAnnotation(e,t,i){let r=super.getUpdatedAnnotation(e,t,i),n=this.initialRelationships,s=gf(i,this.getBaseSegment);return void 0===n?r.relatedSegments=s:r.relatedSegments=Array.from(s,(e,t)=>{let i=n[t];return e=e.filter(e=>!i.includes(e)),BigUint64Array.from([...i,...e])}),r}toJSON(){return gy}}gk.prototype.annotationType=eB.LINE;class gD extends gx{getInitialAnnotation(e,t){let i=gC(e,t);return{type:eB.ELLIPSOID,id:"",description:"",segments:gf(t),center:i,radii:Z.R3.fromValues(0,0,0),properties:t.source.properties.map(e=>e.default)}}getUpdatedAnnotation(e,t,i){let r=gC(t,i);if(void 0===r)return e;let n=e.center,s=n.length;for(let e=0;e<s;++e)r[e]=Math.abs(n[e]-r[e]);return{...e,radii:r}}get description(){return"annotate ellipsoid"}toJSON(){return gS}}af(gv,(e,t)=>new gw(e,t)),af(gb,(e,t)=>new gT(e,t)),af(gy,(e,t)=>new gk(e,t)),af(gS,(e,t)=>new gD(e,t));let gL=se.fromObject({enter:{action:"commit"},escape:{action:"cancel"}}),gI="annotationColor";function gP(e){class t extends e{annotationStates=this.registerDisposer(new gu);annotationDisplayState=new oP;annotationCrossSectionRenderScaleHistogram=new lg;annotationCrossSectionRenderScaleTarget=lp(8);annotationProjectionRenderScaleHistogram=new lg;annotationProjectionRenderScaleTarget=lp(8);static supportColorPickerInAnnotationTab=!0;constructor(...e){let t;super(...e),this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new gg(this)});let i=()=>{let e=this.isReady;e&&void 0!==t?(t(),t=void 0):e||void 0!==t||(t=this.annotationStates.markLoading())};this.readyStateChanged.add(i),i();let{mouseState:r}=this.manager.layerSelectedValues;this.registerDisposer(r.changed.add(()=>{if(r.active){let{pickedAnnotationLayer:e}=r;if(void 0!==e&&this.annotationStates.states.includes(e)){let t=this.annotationDisplayState.hoverState.value;(void 0===t||t.id!==r.pickedAnnotationId||t.partIndex!==r.pickedOffset||t.annotationLayerState!==e)&&(this.annotationDisplayState.hoverState.value={id:r.pickedAnnotationId,partIndex:r.pickedOffset,annotationLayerState:e});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(e){}restoreState(e){super.restoreState(e),this.annotationDisplayState.color.restoreState(e[gI])}captureSelectionState(e,t){super.captureSelectionState(e,t);let i=t.pickedAnnotationLayer;void 0!==i&&this.annotationStates.states.includes(i)&&(e.annotationId=t.pickedAnnotationId,e.annotationType=t.pickedAnnotationType,e.annotationBuffer=new Uint8Array(t.pickedAnnotationBuffer,t.pickedAnnotationBufferBaseOffset),e.annotationIndex=t.pickedAnnotationIndex,e.annotationCount=t.pickedAnnotationCount,e.annotationPartIndex=t.pickedOffset,e.annotationSourceIndex=i.sourceIndex,e.annotationSubsource=i.subsourceId)}displayAnnotationState(e,t,i){if(void 0===e.annotationId)return!1;let r=this.annotationStates.states.find(t=>t.sourceIndex===e.annotationSourceIndex&&t.subsubsourceId===e.annotationSubsubsourceId&&(void 0===e.annotationSubsource||t.subsourceId===e.annotationSubsource));if(void 0===r)return!1;let n=i.registerDisposer(r.source.getReference(e.annotationId));return t.appendChild(i.registerDisposer(new aB(i.registerDisposer(new J.ny(()=>({annotation:n,chunkTransform:r.chunkTransform}))),({annotation:t,chunkTransform:i},s,a)=>{let o;if(null==t){if(void 0!==e.annotationType&&void 0!==e.annotationBuffer){let i=e1[e.annotationType],n=r.source.rank,s=i.serializedBytes(n),a=e.annotationBuffer.byteOffset,l=new DataView(e.annotationBuffer.buffer),d=ep.LITTLE===eg,{properties:u}=r.source,c=new eG(n,s,u),h=e.annotationIndex,p=e.annotationCount;t=i.deserialize(l,a+c.propertyGroupBytes[0]*h,d,n,e.annotationId),c.deserialize(l,a,h,p,d,t.properties=Array(u.length)),r.source.hasNonSerializedProperties()&&(o="Loading...")}else o=null===t?"Annotation not found":"Loading..."}if(null!=t){let e=void 0===i.error?i.layerRank:0,o=document.createElement("div");o.classList.add("neuroglancer-selected-annotation-details-position-grid"),o.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${e}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,s.appendChild(o);let l=e1[t.type],d=document.createElement("div");if(d.className="neuroglancer-selected-annotation-details-icon",d.textContent=l.icon,o.appendChild(d),0!==e){let{layerDimensionNames:r}=i.modelTransform;for(let t=0;t<e;++t){let e=document.createElement("div");e.classList.add("neuroglancer-selected-annotation-details-position-dim"),e.textContent=r[t],e.style.gridColumn=`dim ${t+1}`,o.appendChild(e)}gh(t,i,(t,r)=>{let n=aO({title:"Copy position",onClick:()=>{aI(t.map(e=>Math.floor(e)).join(", "))}});n.style.gridColumn="copy",o.appendChild(n);for(let i=0;i<e;++i){let e=document.createElement("div");e.classList.add("neuroglancer-selected-annotation-details-position-coord"),e.style.gridColumn=`coord ${i+1}`,e.textContent=Math.floor(t[i]).toString(),o.appendChild(e)}if(!r){let e=cR({title:"Move to position",onClick:()=>{gc(this,i,t)}});e.style.gridColumn="move",o.appendChild(e)}})}if(!r.source.readonly){let e=gs({title:"Delete annotation",onClick:()=>{r.source.delete(n)}});e.classList.add("neuroglancer-selected-annotation-details-delete"),o.appendChild(e)}let{relationships:u,properties:c}=r.source,h=r.source.readonly,p=document.createElement("label");p.classList.add("neuroglancer-annotation-property");let g=document.createElement("span");g.classList.add("neuroglancer-annotation-property-label"),g.textContent="ID",p.appendChild(g);let f=document.createElement("span");f.classList.add("neuroglancer-annotation-property-value"),f.textContent=n.id,p.appendChild(f),s.appendChild(p);for(let e=0,i=c.length;e<i;++e){let i=c[e],r=document.createElement("label");r.classList.add("neuroglancer-annotation-property");let n=document.createElement("span");n.classList.add("neuroglancer-annotation-property-label"),n.textContent=i.identifier,r.appendChild(n);let{description:a}=i;void 0!==a&&(r.title=a);let o=t.properties[e],l=document.createElement("span");switch(l.classList.add("neuroglancer-annotation-property-value"),i.type){case"rgb":{let e=et(o),t=er(e);l.textContent=t,l.style.backgroundColor=t,l.style.color=es(e)?"white":"black";break}case"rgba":{let e=et(o);l.textContent=er(ei(o)),l.style.backgroundColor=er(et(o)),l.style.color=es(e)?"white":"black";break}default:l.textContent=eW(i,o)}r.appendChild(l),s.appendChild(r)}let{relatedSegments:m}=t;for(let e=0,t=u.length;e<t;++e){let t=void 0===m?new BigUint64Array(0):m[e];if(0===t.length&&h)continue;let i=e,o=u[e];s.appendChild(a.registerDisposer(function(e,t,i,r){return new aB(i,(i,n,s)=>{let a;let o=document.createElement("div");o.classList.add("neuroglancer-related-segment-list"),null!=i&&s.registerDisposer(cW(i,o));let l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list-header");let d=aO({title:"Copy segment IDs",onClick:()=>{aI(Array.from(t,e=>e.toString()).join(", "))}});if(l.appendChild(d),null!=i&&((a=document.createElement("input")).type="checkbox",a.addEventListener("change",()=>{let{visibleSegments:e}=i.segmentationGroupState.value,r=t.some(t=>!e.has(t));for(let i of t)e.set(i,r)}),l.appendChild(a)),void 0!==r){let e=gs({title:"Remove all IDs",onClick:()=>{r(new BigUint64Array(0))}});l.appendChild(e)}let u=document.createElement("span");if(u.classList.add("neuroglancer-related-segment-list-title"),u.textContent=e,l.appendChild(u),void 0!==r){let e=gr({title:"Add related segment ID",onClick:()=>{let e=new eh.gj,n=s.registerDisposer((0,eh.oq)(e)),a=document.createElement("div");a.classList.add("neuroglancer-segment-list-entry"),a.classList.add("neuroglancer-segment-list-entry-new");let l=aO({});if(l.classList.add("neuroglancer-segment-list-entry-copy"),a.appendChild(l),null!=i){let e=document.createElement("input");e.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.type="checkbox",a.appendChild(e)}let d=gs({title:"Cancel adding new segment ID",onClick:()=>{n()}});d.classList.add("neuroglancer-segment-list-entry-delete"),a.appendChild(d);let u=document.createElement("input");u.autocomplete="off",u.spellcheck=!1,u.classList.add("neuroglancer-segment-list-entry-id"),e.registerDisposer(new aM(u,gL)).allShortcutsAreGlobal=!0;let c=()=>{try{let e=(0,ef.tw)(u.value);return u.dataset.valid="true",e}catch{u.dataset.valid="false";return}};c(),u.addEventListener("input",()=>{c()}),u.addEventListener("blur",()=>{let e=c();void 0!==e&&r(BigUint64Array.from([...t,e])),n()}),ss(u,"cancel",n),ss(u,"commit",()=>{let e=c();void 0!==e&&r(BigUint64Array.from([...t,e])),n()}),a.appendChild(u),o.appendChild(a),u.focus(),e.registerDisposer(()=>{u.value="",a.remove()})}});l.appendChild(e)}o.appendChild(l);let c=[],h=cK.make(i??void 0,!1);for(let e of t){let i=h.get(e);if(c.push(i),void 0!==r){let n=gs({title:"Remove ID",onClick:i=>{r(t.filter(t=>t!==e)),i.stopPropagation()}});n.classList.add("neuroglancer-segment-list-entry-delete"),i.children[0].appendChild(n)}o.appendChild(i)}if(null!=i){let e=s.registerCancellable((0,io.H)(()=>{let{visibleSegments:e}=i.segmentationGroupState.value,r=0;for(let i of t)e.has(i)&&++r;for(let e of c)h.update(e);a.checked=r===t.length&&r>0,a.indeterminate=r>0&&r<t.length}));e(),e.flush(),cQ(i,s,e),s.registerDisposer(i.segmentationGroupState.changed.add(e))}n.appendChild(o)})}(o,t,r.displayState.relationshipStates.get(o).segmentationState,h?void 0:e=>{let t=n.value;if(null==t)return;let{relatedSegments:s}=t;(s=void 0===s?r.source.relationships.map(()=>new BigUint64Array(0)):s.slice())[i]=e;let a={...t,relatedSegments:s};r.source.update(n,a),r.source.commit(n)})).element)}if(!r.source.readonly||t.description){if(r.source.readonly){let e=document.createElement("div");e.className="neuroglancer-annotation-details-description",e.textContent=t.description||"",s.appendChild(e)}else{let e=document.createElement("textarea");e.value=t.description||"",e.rows=3,e.className="neuroglancer-annotation-details-description",e.placeholder="Description",e.addEventListener("change",()=>{let i=e.value;r.source.update(n,{...t,description:i||void 0}),r.source.commit(n)}),s.appendChild(e)}}}if(void 0!==o){let e=document.createElement("div");e.classList.add("neuroglancer-selection-annotation-status"),e.textContent=o,s.appendChild(e)}})).element),!0}displaySelectionState(e,t,i){let r=this.displayAnnotationState(e,t,i);return super.displaySelectionState(e,t,i)&&(r=!0),r}addLocalAnnotations(e,t,i){let{subsourceEntry:r}=e,n=new oR({localPosition:this.localPosition,transform:e.getRenderLayerTransform(),source:t,displayState:this.annotationDisplayState,dataSource:e.loadedDataSource.layerDataSource,subsourceIndex:e.subsourceIndex,subsourceId:r.id,role:i});this.annotationDisplayState.annotationProperties.value=[],this.addAnnotationLayerState(n,e)}addStaticAnnotations(e){let{subsourceEntry:t}=e,{staticAnnotations:i}=t.subsource;return void 0!==i&&(e.activate(()=>{this.addLocalAnnotations(e,i,iY.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(e,t){let i=t.activated;i.registerDisposer(this.annotationStates.add(e));let r=new p1(this.manager.chunkManager,e.addRef());if(r.source instanceof lU){let e=new ge({annotationLayer:r.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});i.registerDisposer(t.messages.addChild(e.messages));let n=new p7({annotationLayer:r.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});i.registerDisposer(t.messages.addChild(n.messages)),i.registerDisposer((0,J.Uw)((t,i)=>{i&&(t.registerDisposer(this.addRenderLayer(e.addRef())),t.registerDisposer(this.addRenderLayer(n.addRef())))},this.annotationDisplayState.displayUnfiltered))}{let e=new gt(r,this.annotationCrossSectionRenderScaleHistogram);i.registerDisposer(this.addRenderLayer(e)),i.registerDisposer(t.messages.addChild(e.messages))}{let e=new p8(r.addRef(),this.annotationProjectionRenderScaleHistogram);i.registerDisposer(this.addRenderLayer(e)),i.registerDisposer(t.messages.addChild(e.messages))}}selectAnnotation(e,t,i){this.manager.root.selectionState.captureSingleLayerState(this,i=>(i.annotationId=t,i.annotationSourceIndex=e.sourceIndex,i.annotationSubsource=e.subsourceId,i.annotationSubsubsourceId=e.subsubsourceId,!0),i)}toJSON(){let e=super.toJSON();return e[gI]=this.annotationDisplayState.color.toJSON(),e}}return t}i(6921);let gR="selectSegments",gA="mousedown0",gM=se.fromObject({[`at:alt?+shift?+${gA}`]:"drag-select-segments"});class gN extends au{toJSON(){return gR}activate(e){let{layer:t}=this,{body:i,header:r}=ak(e),n=0,s=!1;e.bindInputEventMap(gM);let a=()=>aP.value&n4.ALT?2:1,o=e=>{n!==e&&(n=e,s=!1,l())},l=()=>{sv(i);let e=document.createElement("span");switch(n){case 0:r.textContent="Select/Deselect segments",e.textContent=`${gA} to select segments; alt+${gA} to deselect segments.`;break;case 1:case 2:r.textContent=`${1===n?"Select":"Deselect"} segments`,e.textContent=`Drag to ${1===n?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}i.appendChild(e)};l();let d=()=>{if(0===n)return;let{segmentSelectionState:e}=t.displayState;if(e.hasSelectedSegment){let i=e.selectedSegment,{selectedSegments:r,visibleSegments:s}=t.displayState.segmentationGroupState.value;switch(n){case 1:r.add(i),s.add(i);break;case 2:r.delete(i)}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{s&&d()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(l)),e.registerDisposer(aP.changed.add(()=>{0!==n&&o(a())}));let u=(e,t)=>{e.stopPropagation(),o(t),d();let i=e.detail.screenX,r=e.detail.screenY;so(e.detail,(e,t,n)=>{if(!s){let t=e.screenX-i,n=e.screenY-r;t*t+n*n>25&&(d(),s=!0)}},e=>{s=!1,o(0)})};e.bindAction("drag-select-segments",e=>u(e,a()))}get description(){return"select"}}i(4504);let gV="mergeSegments",gO="splitSegments",gF=se.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),gB=se.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}});class g_ extends au{lastAnchorBaseSegment=new J.SN(void 0);constructor(e){super(e);let t=()=>{let t=e.anchorSegment.value;if(void 0===t)return;let{segmentSelectionState:i}=e.displayState;if(!i.hasSelectedSegment)return;let{segmentEquivalences:r}=e.displayState.segmentationGroupState.value,n=r.get(t);if(i.selectedSegment!==n)return;let s=i.baseSelectedSegment,a=(0,lo.Lr)(s),o=r.disjointSets.visibleSegmentEquivalencePolicy.value;(!(o&lo.BA.NONREPRESENTATIVE_EXCLUDED)||!a)&&(!(o&lo.BA.REPRESENTATIVE_EXCLUDED)||a)&&(this.lastAnchorBaseSegment.value=s)};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return gV}activate(e){let t=this.layer.displayState.segmentationGroupState.value,i=()=>{let e=this.layer.anchorSegment.value,i=this.lastAnchorBaseSegment.value;if(void 0===e)return{anchorSegment:void 0,error:"Select anchor segment for merge"};let r=t.segmentEquivalences.get(e);return t.visibleSegments.has(r)?void 0===i||t.segmentEquivalences.get(i)!==r?{anchorSegment:e,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:i,error:void 0}:{anchorSegment:e,error:"Anchor segment must be in visible set"}},r=()=>{let{anchorSegment:e,error:r}=i();if(void 0===e||void 0!==r)return{anchorSegment:e,error:r,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:n}=this.layer,s=n.segmentSelectionState.baseValue;return void 0===s||n.segmentSelectionState.selectedSegment===t.segmentEquivalences.get(e)?{anchorSegment:e,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:e,otherSegment:s,error:void 0,anchorSegmentValid:!0}},{body:n,header:s}=ak(e);s.textContent="Merge segments",n.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(gF),e.registerDisposer(()=>{c$(t)});let a=()=>{sv(n);let{displayState:e}=this.layer,{anchorSegment:i,otherSegment:s,anchorSegmentValid:a,error:o}=r(),l=e=>{let t=cX(this.layer.displayState,e);return t.classList.add("neuroglancer-segment-list-entry-double-line"),t};if(void 0!==i&&n.appendChild(l(cG(e,i))),void 0!==o){let e=document.createElement("span");e.textContent=o,n.appendChild(e)}if(void 0!==s){let t=document.createElement("span");t.textContent=" merge ",n.appendChild(t),n.appendChild(l(cG(e,s)))}let{segmentEquivalences:d}=t;if(!a){c$(t);return}t.useTemporaryVisibleSegments.value=!0;let u=t.temporaryVisibleSegments;u.clear(),u.add(d.get(i)),void 0!==s&&u.add(d.get(s))};a(),e.registerDisposer(cW(this.layer.displayState,n));let o=e.registerCancellable((0,io.H)(a));cQ(this.layer.displayState,e,o),e.registerDisposer(this.layer.anchorSegment.changed.add(o)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(o)),e.bindAction("merge-segments",e=>{e.stopPropagation(),(async()=>{let{graph:{value:e}}=t;if(void 0===e)return;let{anchorSegment:i,otherSegment:n,error:s}=r();if(void 0!==i&&void 0!==n&&void 0===s)try{await e.merge(i,n),s1.showTemporaryMessage("Merge performed")}catch(e){s1.showTemporaryMessage(`Merge failed: ${e}`)}})()}),e.bindAction("set-anchor",e=>{e.stopPropagation();let{segmentSelectionState:i}=this.layer.displayState,r=i.baseValue;if(void 0===r)return;let n=this.layer.anchorSegment.value;if(t.visibleSegments.add(r),void 0===n||n!==r){this.layer.anchorSegment.value=r;return}})}get description(){return"merge"}}class gU extends au{toJSON(){return gO}activate(e){let t=this.layer.displayState.segmentationGroupState.value,i=()=>{let e=this.layer.anchorSegment.value;if(void 0===e)return{anchorSegment:void 0,error:"Select anchor segment for split"};let i=t.segmentEquivalences.get(e);return t.visibleSegments.has(i)?{anchorSegment:e,error:void 0}:{anchorSegment:e,error:"Anchor segment must be in visible set"}},{body:r,header:n}=ak(e);n.textContent="Split segments",r.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(gB);let s=()=>{let{anchorSegment:e,error:r}=i();if(void 0===e||void 0!==r)return{anchorSegment:e,error:r,otherSegment:void 0,anchorSegmentValid:!1};let{displayState:n}=this.layer,s=n.segmentSelectionState.baseValue;return void 0===s||n.segmentSelectionState.selectedSegment!==t.segmentEquivalences.get(e)||s===e?{anchorSegment:e,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:e,otherSegment:s,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{c$(t)});let a=()=>{let e,i;sv(r);let{displayState:n}=this.layer,{anchorSegment:a,otherSegment:o,anchorSegmentValid:l,error:d}=s();(()=>{let{segmentEquivalences:r}=t,{graphConnection:{value:n}}=this.layer;if(!l||void 0===n){c$(t);return}if(t.useTemporaryVisibleSegments.value=!0,void 0!==o){let r=n.computeSplit(a,o);if(void 0!==r){e=new c_(a,r.includeRepresentative),i=new c_(o,r.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;let n=r.includeRepresentative,s=r.excludeRepresentative,l=t.temporarySegmentEquivalences;for(let e of(l.clear(),r.includeBaseSegments))l.link(e,n);for(let e of r.excludeBaseSegments)l.link(e,s);let d=t.temporaryVisibleSegments;d.clear(),d.add(n),d.add(s);return}}t.useTemporarySegmentEquivalences.value=!1;let s=t.temporaryVisibleSegments;s.clear(),s.add(r.get(a))})();let u=e=>{let t=cX(this.layer.displayState,e);return t.classList.add("neuroglancer-segment-list-entry-double-line"),t};if(void 0!==a&&r.appendChild(u(e??cG(n,a))),void 0!==d){let e=document.createElement("span");e.textContent=d,r.appendChild(e)}if(void 0!==i){let e=document.createElement("span");e.textContent=" split ",r.appendChild(e),r.appendChild(u(i))}};e.registerDisposer(cW(this.layer.displayState,r)),a();let o=e.registerCancellable((0,io.H)(a));cQ(this.layer.displayState,e,o),e.registerDisposer(this.layer.anchorSegment.changed.add(o));let l=async e=>{let{graph:{value:i}}=t;if(void 0===i)return;let{anchorSegment:r,otherSegment:n,error:a}=s();if(void 0!==r&&void 0!==n&&void 0===a)try{await i.split(r,n),e&&t.visibleSegments.add(t.segmentEquivalences.get(n)),s1.showTemporaryMessage("Split performed")}catch(e){s1.showTemporaryMessage(`Split failed: ${e}`)}};e.bindAction("split-segments",e=>{e.stopPropagation(),l(!1)}),e.bindAction("split-and-select-segments",e=>{e.stopPropagation(),l(!0)}),e.bindAction("set-anchor",e=>{e.stopPropagation();let{segmentSelectionState:i}=this.layer.displayState,r=i.baseValue;if(void 0===r)return;t.visibleSegments.add(r);let n=this.layer.anchorSegment.value;if(void 0===n||n!==r){this.layer.anchorSegment.value=r;return}})}get description(){return"split"}}class g$ extends eh.gj{segmentationDisplayState;parentElement;length;changed;explicitSegments;debouncedUpdate;constructor(e,t){super(),this.segmentationDisplayState=e,this.parentElement=t,this.changed=new eO.MZ,this.debouncedUpdate=(0,ie.Z)(()=>this.update(),0)}updateRendering(e){this.segmentWidgetFactory.update(e)}segmentWidgetFactory;updateRenderedItems(e){e.forEachRenderedItem(e=>{this.updateRendering(e)})}}class gz extends g${segmentationDisplayState;parentElement;constructor(e,t){super(e,t),this.segmentationDisplayState=e,this.parentElement=t,this.render=e=>{let{explicitSegments:t}=this,i=t[e];return this.segmentWidgetFactory.get(i)},this.update(),this.registerDisposer(e.segmentationGroupState.value.selectedSegments.changed.add(this.debouncedUpdate))}update(){let e=[],{selectedSegments:t}=this.segmentationDisplayState.segmentationGroupState.value,i=[...t],{explicitSegments:r}=this;void 0===r?e.push({retainCount:0,insertCount:i.length,deleteCount:0}):e.push(...(0,H.wG)(r,i,(e,t)=>e===t)),this.explicitSegments=i,this.length=i.length,this.changed.dispatch(e)}render}class gG extends g${query;segmentPropertyMap;segmentationDisplayState;parentElement;prevQuery;queryResult;prevQueryResult;statusText;selectedMatches;visibleMatches;matchStatusTextPrefix;selectedSegmentsGeneration;visibleSegmentsGeneration;get numMatches(){return this.queryResult.value?.count??0}update(){var e;let t;let i=this.query.value,{segmentPropertyMap:r}=this;this.prevQueryResult.value=this.queryResult.value;let n=this.prevQueryResult.value;if(this.prevQuery===i)t=n;else{let e=function(e,t){let i;if(null!==t.match(hT)){let e=t.split(/[\s,]+/),i=new Set;for(let t=0,r=e.length;t<r;++t){let r;let n=e[t];if(""!==n){try{r=(0,ef.tw)(n)}catch{continue}i.add(r)}}return{ids:Array.from(i).sort(em._f)}}let r={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},n=e?.segmentPropertyMap.inlineProperties?.properties,s=e?.tags,a=s?.tags||[],o=a.map(e=>e.toLowerCase()),l=e?.labels,d=[];for(let s=0;s<t.length;s=i){let u=t.indexOf(" ",s);i=-1===u?u=t.length:u+1;let c=t.substring(s,u);if(0===c.length)continue;let h=(e,t)=>{let i=e.toLowerCase(),n=o.indexOf(i);if(-1===n){d.push({begin:t,end:u,message:`Invalid tag: ${e}`});return}if(e=a[n],r.includeTags.includes(e)||r.excludeTags.includes(e)){d.push({begin:t,end:u,message:`Duplicate tag: ${e}`});return}return e};if(c.startsWith("#")){let e=h(c.substring(1),s+1);void 0!==e&&r.includeTags.push(e);continue}if(c.startsWith("-#")){let e=h(c.substring(2),s+2);void 0!==e&&r.excludeTags.push(e);continue}if(c.startsWith("<")||c.startsWith(">")){let e=c.substring(1).toLowerCase();if("id"!==e&&"label"!==e){let t=n?.find(t=>t.id.toLowerCase()===e&&("number"===t.type||"label"===t.type||"string"===t.type));if(void 0===t){d.push({begin:s+1,end:u,message:`Invalid field: ${e}`});continue}e=t.id}if(void 0!==r.sortBy.find(t=>t.fieldId===e)){d.push({begin:s+1,end:u,message:`Duplicate sort field: ${e}`});continue}r.sortBy.push({order:c[0],fieldId:e});continue}if(c.startsWith("|")){let e=c.substring(1).toLowerCase();if("id"===e||"label"===e)continue;let t=n?.find(t=>t.id.toLowerCase()===e&&("number"===t.type||"string"===t.type));if(void 0===t){d.push({begin:s+1,end:u,message:`Invalid field: ${e}`});continue}if(e=t.id,r.sortBy.find(t=>t.fieldId===e)||r.includeColumns.find(t=>t===e))continue;r.includeColumns.push(e);continue}if(c.startsWith("/")){if(void 0!==r.regexp){d.push({begin:s,end:u,message:"Only one regular expression allowed"});continue}if(void 0!==r.prefix){d.push({begin:s,end:u,message:"Prefix cannot be combined with regular expression"});continue}if(void 0===l&&0==a.length){d.push({begin:s,end:u,message:"No label property"});continue}try{r.regexp=new RegExp(c.substring(1))}catch{d.push({begin:s,end:u,message:"Invalid regular expression syntax"})}continue}let p=c.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)(-?[0-9.].*)$/);if(null!==p){let t,i=p[1].toLowerCase(),n=p[2],a=e?.numericalProperties.find(e=>e.id.toLowerCase()===i);if(void 0===a){d.push({begin:s,end:s+i.length,message:`Invalid numerical field: ${i}`});continue}i=a.id;try{t=eD(a.dataType,p[3])}catch(e){d.push({begin:s+p[1].length+p[2].length,end:u,message:e.message});continue}let o=r.numericalConstraints.find(e=>e.fieldId===i);void 0===o&&(o={fieldId:i,bounds:a.bounds},r.numericalConstraints.push(o));let l=eC(a.bounds,o.bounds[0]),c=eC(a.bounds,o.bounds[1]),h=c,g=l;switch(n){case"<":h=eA(a.dataType,t,-1);break;case"<=":h=t;break;case"=":h=g=t;break;case">=":g=t;break;case">":g=eA(a.dataType,t,1)}if(g=ek(l,g)>0?l:g,h=0>ek(c,h)?c:h,ek(g,h)>0){d.push({begin:s,end:u,message:"Constraint would not match any values"});continue}o.bounds=[g,h];continue}if(void 0!==r.regexp){d.push({begin:s,end:u,message:"Prefix cannot be combined with regular expression"});continue}if(void 0===l&&0==a.length){d.push({begin:s,end:u,message:"No label property"});continue}void 0!==r.prefix?r.prefix+=` ${c}`:r.prefix=c}return d.length>0?{errors:d}:(0===r.sortBy.length&&r.sortBy.push({fieldId:hD(e),order:"<"}),r)}(r,i);t=function(e,t){let i,r;if(void 0!==t.errors)return{query:t,total:-1,count:0,errors:t.errors};if(void 0!==t.ids){let{ids:e}=t;return{query:t,total:-1,explicitIds:e,count:e.length}}let n=e?.segmentPropertyMap?.inlineProperties;if(void 0===n)return{query:t,count:0,total:-1};let s=n?.properties,a=n.ids.length,o=e?.tags?.tags?.length||0,l=hS(a,a),d=hS(o,o);d.fill(1);for(let e=0;e<a;++e)l[e]=e;let u=e=>{let t=l.length,i=0;for(let r=0;r<t;++r){let t=l[r];e(t)&&(l[i]=t,++i)}l=l.subarray(0,i)};if(void 0!==t.regexp||void 0!==t.prefix){let{regexp:i,prefix:r}=t;if(void 0!==e.labels){let t=e.labels.values;void 0!==i&&u(e=>null!==t[e].match(i)),void 0!==r&&u(e=>t[e].startsWith(r))}if(0==l.length&&void 0!==i||void 0==e.labels&&void 0!=i){l=hS(a,a);for(let e=0;e<a;++e)l[e]=e;(t=>{let i=e.tags.tagDescriptions,r=e.tags.tags;d.fill(0);for(let e=0;e<i.length;e++)null!==i[e].match(t)&&(d[e]=1),null!==r[e].match(t)&&(d[e]=1)})(i),t.regexp=void 0}}let{includeTags:c,excludeTags:h}=t,p=e.tags;if(c.length>0||h.length>0){let{values:e,tags:t}=p,i=[];for(let e of c)i.push([t.indexOf(e),1]);for(let e of h)i.push([t.indexOf(e),0]);i.sort((e,t)=>e[0]-t[0]);let r="^",n=0,s=e=>{e<n||(r+=`[${hk(n)}-${hk(e)}]*`)};for(let[e,t]of i)s(e-1),t&&(r+=hk(e)),n=e+1;s(65535);let a=new RegExp(r+="$");u(t=>null!==e[t].match(a))}let{numericalConstraints:g}=t;if(g.length>0){let t=e.numericalProperties,n=g.length,s=2**n-1;i=hS(l.length,s);for(let e=0;e<n;++e){let r=g[e],{values:n}=t.find(e=>e.id===r.fieldId),s=2**e,[a,o]=r.bounds;for(let e=0,t=l.length;e<t;++e){let t=n[l[e]];i[e]|=s*(t>=a&&t<=o)}}let a=(l=(r=l).slice()).length,o=0;for(let e=0;e<a;++e)i[e]===s&&(l[o]=l[e],++o);l=l.subarray(0,o)}let f=[];if(void 0!==p){let e=[],{tags:i,values:r,tagDescriptions:n}=p,s=new Uint32Array(i.length);for(let e=0,t=l.length;e<t;++e){let t=r[l[e]];for(let e=0,i=t.length;e<i;++e)++s[t.charCodeAt(e)]}for(let r=0,a=i.length;r<a;++r){if(0===d[r])continue;let a=s[r],o=i[r],l=n[r],u={tag:o,tagIndex:r,count:s[r],desc:l};t.includeTags.includes(o)||t.excludeTags.includes(o)?e.push(u):a>0&&f.push(u)}e.push(...f),f=e}let m=(e,t)=>{if("number"!==e.type){let{values:i}=e;l.sort((e,r)=>(0,s7.B)(i[e],i[r])*t)}else{let i=e.values;l.sort((e,r)=>(i[e]-i[r])*t)}},v=t=>{void 0!==p&&m(p,t);let i=e?.labels;void 0!==i&&m(i,t)},{sortBy:y}=t;for(let e=y.length-1;e>=0;--e){let{fieldId:t,order:i}=y[e],r="<"===i?1:-1;if("id"===t){if(e+1===y.length){if("<"===i)continue;l.reverse();continue}l.sort((e,t)=>r*(e-t))}else"label"===t?v(r):m(s.find(e=>e.id===t),r)}return{query:t,intermediateIndices:r,intermediateIndicesMask:i,indices:l,tags:f,count:l.length,total:a}}(r,e)}let s=[],a=!1,o="",l=void 0===(e=t.query).ids&&(void 0!==e.errors||!(e.numericalConstraints.length>0)&&!(e.includeTags.length>0)&&!(e.excludeTags.length>0)&&!e.prefix&&!e.regexp);l||void 0===this.explicitSegments||(s.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,a=!0);let{explicitIds:d}=t;void 0!==d?this.explicitSegments=d:this.explicitSegments=void 0,n!==t&&(s.push({retainCount:0,deleteCount:n?.count??0,insertCount:t.count}),a=!0,this.queryResult.value=t),void 0!==t.explicitIds?o=`${t.count} ids`:l?o=`${t.count} total ids`:t.total>0&&(o=`${t.count} match /${t.total} total ids`);let{selectedSegments:u,visibleSegments:c}=this.segmentationDisplayState.segmentationGroupState.value,h=u.changed.count,p=c.changed.count,g=this.selectedSegmentsGeneration,f=this.visibleSegmentsGeneration,m=n!==t;this.selectedSegmentsGeneration=h,this.visibleSegmentsGeneration=p,(g!==h||m)&&(this.selectedMatches=t.count>0?hL(r,t,u):0),(f!==p||m)&&(this.visibleMatches=t.count>0?hL(r,t,c):0);let v=o;this.selectedMatches>0&&(v=this.selectedMatches===this.visibleMatches?`${this.selectedMatches} vis/${v}`:this.visibleMatches>0?`${this.visibleMatches} vis/${this.selectedMatches} star/${v}`:`${this.selectedMatches} star/${v}`),this.statusText.value=v,this.prevQuery=i,this.matchStatusTextPrefix=o,this.length=t.count,a&&this.changed.dispatch(s)}constructor(e,t,i,r){super(i,r),this.query=e,this.segmentPropertyMap=t,this.segmentationDisplayState=i,this.parentElement=r,this.queryResult=new J.SN(void 0),this.prevQueryResult=new J.SN(void 0),this.statusText=new J.SN(""),this.selectedMatches=0,this.visibleMatches=0,this.matchStatusTextPrefix="",this.selectedSegmentsGeneration=-1,this.visibleSegmentsGeneration=-1,this.render=e=>{let t;let{explicitSegments:i}=this;if(void 0!==i)t=i[e];else{let i=this.queryResult.value.indices[e],{ids:r}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;t=r[i]}return this.segmentWidgetFactory.get(t)},this.update(),this.registerDisposer(i.segmentationGroupState.value.selectedSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(i.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),e&&this.registerDisposer(e.changed.add(this.debouncedUpdate))}render}let gj=se.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}});function gW(e){sb(e,Math.max(1,e.value.length+.1))}function gq(e,t){let i;if(Number.isInteger(t))i=t.toString();else{let e=t.toString(),r=t.toPrecision(6);i=e.length<r.length?e:r}e.value=i,gW(e)}function gH(e,t,i){let r=e?.query,n=r?.sortBy;if(void 0===n)return;let{includeColumns:s}=r,a=n.find(e=>e.fieldId===i)?.order,o=s.filter(e=>e!==i);for(let e of n)"id"!==e.fieldId&&"label"!==e.fieldId&&e.fieldId!==i&&o.push(e.fieldId);t({...r,sortBy:[{fieldId:i,order:"<"===a?">":"<"}],includeColumns:o})}function gJ(e,t,i){let r=e?.query?.sortBy,n=r?.find(e=>e.fieldId===i)?.order;t.textContent=">"===n?"▼":"▲",t.style.visibility=void 0===n?"":"visible",t.title=`Sort by ${i} in ${"<"===n?"descending":"ascending"} order`}class gK extends eh.gj{segmentPropertyMap;queryResult;setQuery;listElement;properties;propertyHistograms;bounds;throttledUpdate;debouncedRender;debouncedSetQuery;constructor(e,t,i){let r;super(),this.segmentPropertyMap=e,this.queryResult=t,this.setQuery=i,this.propertyHistograms=[],this.bounds={window:new J.SN([]),range:new J.SN([])},this.throttledUpdate=this.registerCancellable((0,lX.Z)(()=>this.updateHistograms(),100)),this.debouncedRender=this.registerCancellable((0,io.H)(()=>this.updateHistogramRenderings())),this.debouncedSetQuery=this.registerCancellable((0,ie.Z)(()=>this.setQueryFromBounds(),200));let n=e?.numericalProperties,s=[];if(void 0!==n&&n.length>0){r=document.createElement("details");let e=document.createElement("summary");e.textContent=`${n.length} numerical propert${n.length>1?"ies":"y"}`,r.appendChild(e),r.classList.add("neuroglancer-segment-query-result-numerical-list");let t=this.bounds.window.value;for(let e=0,i=n.length;e<i;++e){let i=n[e],a=this.makeNumericalPropertySummary(e,i);s.push(a),r.appendChild(a.element),t[e]=i.bounds}}this.listElement=r,this.properties=s,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){let e=this.queryResult.value;if(void 0===e||void 0===e.indices)return;let t=e.query,i=[],r=this.bounds.range.value,{properties:n}=this;for(let e=0,t=n.length;e<t;++e){let t=n[e].property;i.push({fieldId:t.id,bounds:r[e]})}this.setQuery({...t,numericalConstraints:i})}getBounds(e){let{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){let{property:i}=this.properties[e],r=ex(i.bounds,t.range);ek(r[0],r[1])>0&&(r=[r[1],r[0]]);let n=ex(i.bounds,t.window),s=this.getBounds(e);eP(n,s.window)||(this.bounds.window.value[e]=n,this.bounds.window.changed.dispatch()),eP(r,s.range)||(this.bounds.range.value[e]=r,this.bounds.range.changed.dispatch())}setBound(e,t,i,r){r=eC(this.segmentPropertyMap.numericalProperties[i].bounds,r);let n=sM(this.getBounds(i),e,t,r,!0);this.setBounds(i,n)}handleNewQueryResult(){let e=this.queryResult.value,{listElement:t}=this;if(void 0!==t){if(e?.indices!==void 0){let{numericalConstraints:t}=e.query,{numericalProperties:i}=this.segmentPropertyMap,r=this.bounds.range.value,n=t.length,s=i.length;r.length=s;for(let e=0;e<s;++e)r[e]=i[e].bounds;for(let e=0;e<n;++e){let n=t[e];r[i.findIndex(e=>e.id===n.fieldId)]=n.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){let e=this.queryResult.value,{listElement:t}=this;void 0!==t&&(!function(e,t,i,r){if(void 0===e){i.length=0,r.length=0;return}let{numericalProperties:n}=e,s=n.length;if(void 0===t?.indices){i.length=0;return}for(let e=0;e<s;++e){let s=i[e],a=r[e],o=n[e];!(void 0!==s&&s.queryResult===t&&eP(s.window,a))&&(i[e]=function(e,t,i){let{values:r}=t,[n,s]=i,a=s<=n?0:256/(s-n),o=new Uint32Array(258),{numericalConstraints:l}=e.query,d=l.findIndex(e=>e.fieldId===t.id);if(-1===d){let t=e.indices;for(let e=0,i=t.length;e<i;++e){let i=r[t[e]];!Number.isNaN(i)&&++o[Math.min(255,Math.max(-1,(i-n)*a))+1>>>0]}}else{let t=e.intermediateIndices,i=e.intermediateIndicesMask,s=2**l.length-1-2**d;for(let e=0,l=t.length;e<l;++e)if((i[e]&s)===s){let i=r[t[e]];!Number.isNaN(i)&&++o[Math.min(255,Math.max(-1,(i-n)*a))+1>>>0]}}return{queryResult:e,histogram:o,window:i}}(t,o,a))}}(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();let{listElement:e}=this;if(void 0===e)return;let{propertyHistograms:t}=this;if(0===t.length){e.style.display="none";return}e.style.display="";let{properties:i}=this;for(let e=0,r=i.length;e<r;++e)this.updateNumericalPropertySummary(e,i[e],t[e])}makeNumericalPropertySummary(e,t){let i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-numerical-plot-container");let r=document.createElement("img");r.classList.add("neuroglancer-segment-query-result-numerical-plot");let n=new sR(r,t.dataType,()=>this.getBounds(e),t=>this.setBounds(e,t)),s=document.createElement("span");s.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");let a=document.createElement("input");a.type="checkbox",a.addEventListener("click",()=>{!function(e,t,i){if(void 0===e||void 0===e.indices)return;let r=e.query,{sortBy:n,includeColumns:s}=r;hP(r,i)?(n=n.filter(e=>e.fieldId!==i),s=s.filter(e=>e!==i)):s.push(i),t({...r,sortBy:n,includeColumns:s})}(this.queryResult.value,this.setQuery,t.id)});let o=i=>{let r;let n=document.createElement("div");n.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),n.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${i}`);let o=r=>{let n=function(e,t){let i=document.createElement("input");return i.addEventListener("focus",()=>{i.select()}),i.classList.add(`neuroglancer-segment-query-result-numerical-plot-${e}-bound`),i.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),i.type="text",i.spellcheck=!1,i.autocomplete="off",i.title=(0===t?"Lower":"Upper")+" bound "+("range"===e?"range":"for distribution"),i.addEventListener("input",()=>{gW(i)}),i}(i,r);return n.addEventListener("change",()=>{if(void 0!==this.bounds[i].value[e]){try{let s=eD(t.dataType,n.value);this.setBound(i,r,e,s),this.bounds[i].changed.dispatch()}catch{}gq(n,this.bounds[i].value[e][r])}}),n},l=[o(0),o(1)];if("range"===i){(r=[document.createElement("div"),document.createElement("div"),document.createElement("div")])[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),r[1].appendChild(a);let e=document.createElement("span");e.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),e.appendChild(document.createTextNode(t.id)),e.appendChild(s),e.addEventListener("click",()=>{gH(this.queryResult.value,this.setQuery,t.id)}),r[1].appendChild(e);let{description:i}=t;i&&(r[1].title=i),n.appendChild(r[0]),n.appendChild(l[0]);let o=document.createElement("div");o.textContent="≤",o.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),n.appendChild(o),n.appendChild(r[1]);let d=document.createElement("div");d.textContent="≤",d.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),n.appendChild(d),n.appendChild(l[1]),n.appendChild(r[2])}else n.appendChild(l[0]),n.appendChild(l[1]);return{container:n,spacers:r,inputs:l}},l={range:o("range"),window:o("window")};return i.appendChild(l.range.container),i.appendChild(r),i.appendChild(l.window.container),{property:t,controller:n,element:i,plotImg:r,boundElements:l,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:a,sortIcon:s}}updateNumericalPropertySummary(e,t,i){let r=t.bounds.window,n=this.bounds.window.value[e],s=t.bounds.range,a=this.bounds.range.value[e],{property:o}=t,l=this.queryResult.value,d=hP(l?.query,o.id);if(t.columnCheckbox.checked=d,t.columnCheckbox.title=d?"Remove column from result table":"Add column to result table",gJ(l,t.sortIcon,o.id),t.propertyHistogram===i&&eP(r,n)&&eP(s,a))return;let{histogram:u}=i,c="http://www.w3.org/2000/svg",h=document.createElementNS(c,"svg");h.setAttribute("width","1"),h.setAttribute("height","1"),h.setAttribute("preserveAspectRatio","none");let p=document.createElementNS(c,"rect"),g=eS(n,a[0]),f=eS(n,a[1]);p.setAttribute("x",`${g}`),p.setAttribute("y","0"),p.setAttribute("width",`${f-g}`),p.setAttribute("height","1"),p.setAttribute("fill","#4f4f4f"),h.appendChild(p);let m=u.length,v=(e,t,r)=>{let s=document.createElementNS(c,"polyline"),a="",o=0;for(let t=e;t<r;++t)o+=u[t];if(0===o)return;let l=eS(n,i.window[0]),d=eS(n,i.window[1]),h=(e,t)=>{let i=e/(m-2);a+=` ${l*(1-i)+d*i},${1-t}`};0!==e&&h(e,0);let p=0;for(let i=e;i<t;++i)p+=u[i],h(i,p/o);return s.setAttribute("fill","none"),s.setAttribute("stroke-width","1px"),s.setAttribute("points",a),s.setAttribute("vector-effect","non-scaling-stroke"),s};{let e=v(0,m-1,m);void 0!==e&&(e.setAttribute("stroke","cyan"),h.appendChild(e))}if(!eP(o.bounds,a)){let e=Math.floor(Math.max(0,Math.min(1,eS(i.window,a[0])))*(m-2)),t=Math.ceil(Math.max(0,Math.min(1,eS(i.window,a[1])))*(m-2)),r=v(e,t,t);void 0!==r&&(r.setAttribute("stroke","white"),h.appendChild(r))}let y=new XMLSerializer().serializeToString(h);t.plotImg.src=`data:image/svg+xml;base64,${btoa(y)}`,t.propertyHistogram=i;for(let e=0;e<2;++e)r[e]=n[e],gq(t.boundElements.window.inputs[e],n[e]),s[e]=a[e],gq(t.boundElements.range.inputs[e],a[e]);let b=t.boundElements.range.spacers,S=ex(n,a),w=eM(o.dataType,n),C=eS(n,S[0])*w,x=eS(n,S[1])*w+(1-w);b[0].style.width=`${100*C}%`,b[2].style.width=`${(1-x)*100}%`}}class gZ extends eh.gj{listSource;group;element;selectionStatusContainer;starAllButton;selectionStatusMessage;copyAllSegmentsButton;copyVisibleSegmentsButton;visibilityToggleAllButton;statusChanged;debouncedUpdateStatus;makeSegmentsVisible(e){let{visibleSegments:t}=this.group,i=Array.from(this.listSegments());t.set(i,e)}invertVisibility(){let e=[],t=[],{visibleSegments:i}=this.group;for(let r of this.listSegments())i.has(r)?t.push(r):e.push(r);i.set(e,!0),i.set(t,!1)}selectSegments(e,t=!1){let{selectedSegments:i,visibleSegments:r}=this.group,n=Array.from(this.listSegments());(e||!t)&&i.set(n,e),t&&r.set(n,e)}copySegments(e=!1){let t=[...this.listSegments()];e&&(t=t.filter(e=>this.group.visibleSegments.has(e))),t.sort(em._f),aI(t.join(", "))}constructor(e,t){super(),this.listSource=e,this.group=t,this.element=document.createElement("div"),this.selectionStatusContainer=document.createElement("span"),this.selectionStatusMessage=document.createElement("span"),this.statusChanged=new eO.K_,this.debouncedUpdateStatus=(0,ie.Z)(()=>this.updateStatus(),0);let{element:i}=this;i.style.display="contents",this.starAllButton=cB({title:"Click to toggle star status, shift+click to unstar non-visible segments.",onClick:e=>{let t=this.starAllButton.classList.contains("neuroglancer-starred");if(e.shiftKey){let e=[];for(let t of this.group.selectedSegments)this.group.visibleSegments.has(t)||e.push(t);this.group.selectedSegments.delete(e);return}this.selectSegments(!t,!1)}}),this.copyAllSegmentsButton=aO({title:"Copy all segment IDs",onClick:()=>{this.copySegments(!1)}}),this.copyVisibleSegmentsButton=aO({title:"Copy visible segment IDs",onClick:()=>{this.copySegments(!0)}}),this.visibilityToggleAllButton=cV({onClick:e=>{if(e.shiftKey){this.invertVisibility();return}this.makeSegmentsVisible(!this.visibilityToggleAllButton.classList.contains("neuroglancer-visible"))}});let{selectionStatusContainer:r}=this;this.selectionStatusMessage.classList.add("neuroglancer-segment-list-status-message"),r.classList.add("neuroglancer-segment-list-status"),r.appendChild(this.copyAllSegmentsButton),r.appendChild(this.starAllButton),r.appendChild(this.visibilityToggleAllButton),r.appendChild(this.copyVisibleSegmentsButton),r.appendChild(this.selectionStatusMessage),this.element.appendChild(r),this.registerDisposer(t.visibleSegments.changed.add(this.debouncedUpdateStatus)),this.registerDisposer(t.selectedSegments.changed.add(this.debouncedUpdateStatus)),this.registerDisposer(e.changed.add(this.debouncedUpdateStatus))}*listSegments(){}updateStatus(){let e;let{listSource:t,group:i,starAllButton:r,selectionStatusMessage:n,copyAllSegmentsButton:s,copyVisibleSegmentsButton:a,visibilityToggleAllButton:o}=this;t.debouncedUpdate.flush();let{visibleSegments:l,selectedSegments:d}=i,u=0,c=0,h=0,p="",g=d.size,f=l.size;t instanceof gG?(h=t.numMatches,u=t.visibleMatches,c=t.selectedMatches,p=t.statusText.value):p=`${f}/${g} visible`;let m=h?u:f,v=h?c:g,y=h||g;r.classList.toggle("neuroglancer-starred",v===y),r.classList.toggle("neuroglancer-indeterminate",v>0&&v!==y),n.textContent=p,s.title=`Copy all ${y} ${h?"matching":"starred"} segment(s)`,a.title=`Copy ${m} ${h?"visible matching":"visible"} segment(s)`,s.style.visibility=y?"visible":"hidden",a.style.visibility=m?"visible":"hidden",r.style.visibility=y?"visible":"hidden",o.style.visibility=y?"visible":"hidden";let b=m===y;o.classList.toggle("neuroglancer-visible",b);let S=m>0&&m!==y;o.classList.toggle("neuroglancer-indeterminate",S),e=b?`Click to hide ${y} segment ID(s).`:`Click to show ${y-m} segment ID(s).`,S&&(e+="  Shift+click to invert visibility."),o.title=e,this.statusChanged.dispatch()}}class gY extends gZ{listSource;group;constructor(e,t){super(e,t),this.listSource=e,this.group=t}listSegments(){return this.group.selectedSegments[Symbol.iterator]()}}class gX extends gZ{listSource;segmentPropertyMap;debouncedUpdateQueryModel;updateQuery(){let{listSource:e,debouncedUpdateQueryModel:t}=this;t(),t.flush(),e.debouncedUpdate.flush()}listSegments(){let{listSource:e,segmentPropertyMap:t}=this;return this.updateQuery(),function*(e,t){if(void 0===t)return;let{explicitIds:i}=t;if(void 0!==i)for(let e of i)yield e;let{indices:r}=t;if(void 0!==r){let{ids:t}=e.segmentPropertyMap.inlineProperties;for(let e=0,i=r.length;e<i;++e){let i=r[e];yield t[i]}}}(t,e.queryResult.value)}constructor(e,t,i,r,n,s,a){let o;super(t,i),this.listSource=t,this.segmentPropertyMap=r,this.debouncedUpdateQueryModel=a;let l=e=>{s.focus(),s.select();let t=function(e,t){let{ids:i}=t;if(void 0!==i)return i.map(e=>e.toString()).join(", ");let r="",{prefix:n,regexp:s}=t;for(let e of(void 0!==n?r=n:void 0!==s&&(r=`/${s}`),t.includeTags))r.length>0&&(r+=" "),r+=`#${e}`;for(let e of t.excludeTags)r.length>0&&(r+=" "),r+=`-#${e}`;for(let i of t.numericalConstraints){let{fieldId:t,bounds:n}=i,[s,a]=n,o=e.numericalProperties.find(e=>e.id===t);if(!eP(o.bounds,n)){if(0===ek(s,a)){r.length>0&&(r+=" "),r+=`${t}=${s}`;continue}if(ek(s,o.bounds[0])>0){r.length>0&&(r+=" ");let e=eA(o.dataType,s,-1),i=s.toString(),n=e.toString();o.dataType!==el.FLOAT32||i.length<=n.length?r+=`${t}>=${i}`:r+=`${t}>${n}`}if(0>ek(a,o.bounds[1])){r.length>0&&(r+=" ");let e=eA(o.dataType,a,1),i=a.toString(),n=e.toString();o.dataType!==el.FLOAT32||i.length<=n.length?r+=`${t}<=${i}`:r+=`${t}<${n}`}}}let{sortBy:a}=t;if(1===a.length){let t=a[0];"<"===t.order&&t.fieldId===hD(e)&&(a=[])}for(let e of a)r.length>0&&(r+=" "),r+=`${e.order}${e.fieldId}`;for(let e of t.includeColumns)r.length>0&&(r+=" "),r+=`|${e}`;return r}(r,e);document.execCommand("insertText",!1,t),n.value=t,s.select()},d=document.createElement("div");d.classList.add("neuroglancer-segment-query-result-statistics");let u=document.createElement("div");u.classList.add("neuroglancer-segment-query-result-statistics-separator");let c=document.createElement("ul");c.classList.add("neuroglancer-segment-query-errors"),this.element.prepend(c,d,u),this.registerEventListener(s,"input",()=>{a()}),this.registerDisposer(ss(s,"cancel",()=>{s.focus(),s.select(),document.execCommand("delete"),s.blur(),s.value="",n.value=""})),this.registerDisposer(ss(s,"toggle-listed",()=>{this.toggleMatches()})),this.registerDisposer(ss(s,"hide-all",()=>{i.visibleSegments.clear()})),this.registerDisposer(ss(s,"hide-listed",()=>{a(),a.flush(),t.debouncedUpdate.flush();let{visibleSegments:e}=i;this.listSource instanceof gz?e.clear():e.delete(Array.from(this.listSegments()))}));let h=this.registerDisposer(new gK(r,t.queryResult,l));{let{listElement:e}=h;void 0!==e&&d.appendChild(e)}let p=e=>{let t=e?.errors;if(sv(c),void 0!==t)for(let e of t){let t=document.createElement("li");t.textContent=e.message,c.appendChild(t)}};(0,J.Jk)(i=>{if(t.segmentWidgetFactory=new cY(t.segmentationDisplayState,t.parentElement,e=>hP(i?.query,e.id)),e.scrollToTop(),sv(e.header),void 0!==r){let r=t.segmentWidgetFactory.getHeader();for(let e of(r.container.classList.add("neuroglancer-segment-list-header"),r.propertyLabels)){let{label:r,sortIcon:n,id:s}=e;r.addEventListener("click",()=>{gH(t.queryResult.value,l,s)}),gJ(i,n,s)}e.header.appendChild(r.container)}if(p(i),u.style.display="none",o?.remove(),void 0===i)return;let{query:n}=i;void 0===n.errors&&void 0===n.ids&&(void 0!==(o=function(e,t){let{tags:i}=e;if(void 0===i||0===i.length)return;let r=e.query,n=document.createElement("div");for(let{tag:s,count:a,desc:o}of(n.classList.add("neuroglancer-segment-query-result-tag-list"),i)){let i;let l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");let d=document.createElement("span");d.classList.add("neuroglancer-segment-query-result-tag-name"),s!==o&&void 0!==o&&""!==o?d.textContent=s+" ("+o+")":d.textContent=s,n.appendChild(l);let u=r.includeTags.includes(s),c=r.excludeTags.includes(s);i=u?"Remove tag from required set":c?"Remove tag from excluded set":"Add tag to required set",d.addEventListener("click",()=>{t(hI(r,s,!0,!u&&!c))}),d.title=i;let h=u||c,p=i=>{let n=i?a:e.count-a,o=document.createElement("div");if(o.classList.add("neuroglancer-segment-query-result-tag-toggle"),o.classList.add(`neuroglancer-segment-query-result-tag-${i?"include":"exclude"}`),l.appendChild(o),!h&&0===n)return;let d=i?u:c;o.appendChild(new aN({get value(){return d},set value(value){t(hI(r,s,i,value))},changed:eO.LP},{text:i?"+":"-",enableTitle:`Add tag to ${i?"required":"exclusion"} set`,disableTitle:`Remove tag from ${i?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};p(!0),p(!1),l.appendChild(d);let g=document.createElement("span");g.classList.add("neuroglancer-segment-query-result-tag-count"),h||(g.textContent=a.toString()),l.appendChild(g)}return n}(i,l))&&d.appendChild(o),(h.properties.length>0||void 0!==o)&&(u.style.display=""))},t.queryResult)}toggleMatches(){let{listSource:e}=this;this.updateQuery(),e.debouncedUpdate.flush();let t=e.queryResult.value;if(void 0===t)return;let{visibleMatches:i}=e,r=i!==t.count;return this.selectSegments(r,!0),!0}}class gQ extends sE{layer;constructor(e){super(),this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new aB(e.displayState.segmentationGroupState.value.graph,(t,i,r)=>{if(void 0===t||t.tabContents)return;let n=document.createElement("div");n.className="neuroglancer-segmentation-toolbox",n.appendChild(aE(r,e.toolBinder,{toolJson:gV,label:"Merge",title:"Merge segments"})),n.appendChild(aE(r,e.toolBinder,{toolJson:gO,label:"Split",title:"Split segments"})),i.appendChild(n)})).element);let i=document.createElement("div");i.className="neuroglancer-segmentation-toolbox",i.appendChild(aE(this,e.toolBinder,{toolJson:gR,label:"Select",title:"Select/Deselect segments"})),t.appendChild(i);let r=document.createElement("input");r.classList.add("neuroglancer-segment-list-query"),r.addEventListener("focus",()=>{r.select()}),this.registerDisposer(new aM(r,gj)).allShortcutsAreGlobal=!0;let{segmentQuery:n}=this.layer.displayState,s=this.registerCancellable((0,ie.Z)(()=>{n.value=r.value},200));r.autocomplete="off",r.title=gj.describe(),r.spellcheck=!1,r.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer((0,J.Jk)(e=>{r.value=e},n)),this.registerDisposer((0,J.Jk)(e=>{Date.now()-e<100&&(setTimeout(()=>{r.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(r),t.appendChild(this.registerDisposer(new aB(e.displayState.segmentPropertyMap,(t,i,a)=>{let o=a.registerDisposer(new gG(n,t,e.displayState,i)),l=a.registerDisposer(new gz(e.displayState,i)),d=a.registerDisposer(new gd({source:o,horizontalScroll:!0})),u=a.registerDisposer(new gd({source:l,horizontalScroll:!0})),c=e.displayState.segmentationGroupState.value,h=a.registerDisposer(new gX(d,o,c,t,n,r,s));h.element.appendChild(d.element),i.appendChild(h.element);let p=a.registerDisposer(new gY(l,c));p.element.appendChild(u.element),i.appendChild(p.element);let g=()=>{let e=""!==o.query.value||o.numMatches>0,t=l.length>0||!e;h.element.style.display=e?"contents":"none",p.element.style.display=t?"contents":"none"};a.registerDisposer(h.statusChanged.add(g)),a.registerDisposer(p.statusChanged.add(g)),h.updateStatus(),p.updateStatus();let f=a.registerCancellable((0,io.H)(()=>{o.updateRenderedItems(d),l.updateRenderedItems(u)})),{displayState:m}=this.layer;cQ(m,a,f),a.registerDisposer(m.segmentationGroupState.value.selectedSegments.changed.add(f)),d.element.classList.add("neuroglancer-segment-list"),d.element.classList.add("neuroglancer-preview-list"),u.element.classList.add("neuroglancer-segment-list"),a.registerDisposer(e.bindSegmentListWidth(d.element)),a.registerDisposer(e.bindSegmentListWidth(u.element)),a.registerDisposer(new sa(d.element,cv())),a.registerDisposer(new sa(u.element,cv())),l.segmentWidgetFactory=new cY(l.segmentationDisplayState,l.parentElement,e=>hP(void 0,e.id)),u.scrollToTop(),sv(u.header)})).element)}}let g0=(0,i(7902).Z)({next:"next0",prev:"prev0"}),g1=new class{next0;prev0;constructor(){g0.initializeHead(this)}},g2=window.top===window,g3=(0,ie.Z)(()=>{if(!g2)return;let{activeElement:e}=document;if(null===e||e===document.body){let e=g0.front(g1);null!==e&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{g3()},!0),window.addEventListener("blur",()=>{g3()},!0);class g4 extends eh.gj{element;prev0;next0;lastFocusedElement;scheduleUpdateFocus;constructor(e){super(),this.element=e,this.prev0=null,this.next0=null,this.lastFocusedElement=null,this.scheduleUpdateFocus=this.registerCancellable((0,ie.Z)(()=>{let{activeElement:e}=document,{element:t}=this;!(t.contains(e)||sw(e))&&(null!=e&&(e===this.lastFocusedElement||e.contains(t))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0)),e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),g0.insertBefore(g1,this),this.registerEventListener(e,"focus",()=>{g0.pop(this),g0.insertAfter(g1,this)}),g3()}disposed(){g0.pop(this),super.disposed()}}i(8213);let g6=0,g5=se.fromObject({escape:{action:"close"}});class g8 extends eh.gj{container;content;keyMap=new se;constructor(){super(),this.keyMap.addParent(g5,Number.NEGATIVE_INFINITY),++g6;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new g4(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new aM(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.close()}),t.focus()}close(){this.dispose()}disposed(){--g6,document.body.removeChild(this.container),super.disposed()}}i(6054);class g9 extends eh.gj{group;element;topRow;label;selectElement;linkedLayers;unlinkButton;constructor(e){super(),this.group=e,this.element=document.createElement("div"),this.topRow=document.createElement("div"),this.label=document.createElement("label"),this.selectElement=document.createElement("select"),this.linkedLayers=document.createElement("div"),this.unlinkButton=document.createElement("button");let{element:t,label:i,topRow:r,selectElement:n,linkedLayers:s,unlinkButton:a}=this;r.appendChild(i),r.appendChild(n),r.appendChild(a),a.textContent="Unlink",a.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(r),t.appendChild(s),this.updateView();let o=(0,ie.Z)(()=>this.updateView(),0);this.registerEventListener(n,"change",()=>{this.updateModel(),o()}),this.registerDisposer(this.group.changed.add(o)),this.registerDisposer(this.group.linkedLayersChanged.add(o)),this.registerDisposer(this.group.layerManager.layersChanged.add(o))}updateModel(){let e=this.selectElement.value;""===e&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){let{selectElement:e,group:t}=this,{predicate:i}=t;sv(e);let r=0!==this.group.rootGroup.linkedLayers.size;this.unlinkButton.style.display=r?"":"none";let{linkedLayers:n}=this,s=0!==t.linkedLayers.size;if(n.style.display=s?"":"none",this.unlinkButton.textContent=s?"Unlink all":"Unlink",s)for(let i of(this.element.style.display="",e.style.display="none",sv(n),t.linkedLayers)){let e=document.createElement("div");e.classList.add("neuroglancer-linked-layer-widget-layer");let t=sY({title:"Unlink layer",onClick:()=>{this.group.getGroup(i).isolate()}});e.appendChild(t),e.appendChild(document.createTextNode(i.managedLayer.name)),n.appendChild(e)}else{e.style.display="";let r=document.createElement("option");e.appendChild(r);let n=0;for(let r of this.group.layerManager.managedLayers){let s=r.layer;if(null!==s&&s!==t.layer&&i(s)){++n;let t=document.createElement("option"),{name:i}=r;t.textContent=i,t.value=i,e.appendChild(t)}}e.value=t.toJSON()??"",this.element.style.display=0===n?"none":""}}}var g7=i(4631),fe=i.n(g7),ft=i(936);i(3256),i(7665),i(7671),i(8512);class fi{indented;column;type;align;prev;constructor(e,t,i,r,n){this.indented=e,this.column=t,this.type=i,this.align=r,this.prev=n}}function fr(e){let t={},i=e.split(" ");for(let e=0;e<i.length;++e)t[i[e]]=!0;return t}let fn="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",fs="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";var fa=i(7750);(B=fe()).defineMode("glsl",function(e,t){let i;let r=e.indentUnit,n=t.keywords||fr(fn),s=t.builtins||fr(fs),a=t.blockKeywords||fr("case do else for if switch while struct"),o=t.atoms||fr("null"),l=t.hooks||{},d=t.multiLineStrings,u=/[+\-*&%=<>!?|/]/;function c(e,t){let r=e.next();if(l[r]){let i=l[r](e,t);if(!1!==i)return i}if('"'==r||"'"==r){var p;return t.tokenize=(p=r,function(e,t){let i=!1,r,n=!1;for(;null!=(r=e.next());){if(r==p&&!i){n=!0;break}i=!i&&"\\"==r}return(n||!(i||d))&&(t.tokenize=c),"string"}),t.tokenize(e,t)}if(/[[\]{}(),;:.]/.test(r))return i=r,"bracket";if(/\d/.test(r))return e.eatWhile(/[\w.]/),"number";if("/"==r){if(e.eat("*"))return t.tokenize=h,h(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if("#"==r)return e.eatWhile(/[\S]+/),e.eatWhile(/[\s]+/),e.eatWhile(/[\S]+/),e.eatWhile(/[\s]+/),"comment";if(u.test(r))return e.eatWhile(u),"operator";e.eatWhile(/[\w$_]/);let g=e.current();return Object.hasOwn(n,g)?(Object.hasOwn(a,g)&&(i="newstatement"),"keyword"):Object.hasOwn(s,g)?"builtin":Object.hasOwn(o,g)?"atom":"word"}function h(e,t){let i=!1,r;for(;r=e.next();){if("/"==r&&i){t.tokenize=c;break}i="*"==r}return"comment"}function p(e,t,i){return e.context=new fi(e.indented,t,i,null,e.context)}function g(e){let t=e.context.type;return(")"==t||"]"==t||"}"==t)&&(e.indented=e.context.indented),e.context=e.context.prev}return{startState:function(e){return{tokenize:null,context:new fi((e||0)-r,0,"top",!1),indented:0,startOfLine:!0}},token:function(e,t){let r=t.context;if(e.sol()&&(null==r.align&&(r.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return null;i=null;let n=(t.tokenize||c)(e,t);if("comment"==n||"meta"==n)return n;if(null==r.align&&(r.align=!0),(";"==i||":"==i)&&"statement"==r.type)g(t);else if("{"==i)p(t,e.column(),"}");else if("["==i)p(t,e.column(),"]");else if("("==i)p(t,e.column(),")");else if("}"==i){for(;"statement"==r.type;)r=g(t);for("}"==r.type&&(r=g(t));"statement"==r.type;)r=g(t)}else i==r.type?g(t):("}"==r.type||"top"==r.type||"statement"==r.type&&"newstatement"==i)&&p(t,e.column(),"statement");return t.startOfLine=!1,n},indent:function(e,t){if(e.tokenize!=c&&null!=e.tokenize)return 0;let i=t&&t.charAt(0),n=e.context,s=i==n.type;return"statement"==n.type?n.indented+("{"==i?0:r):n.align?n.column+(s?0:1):n.indented+(s?0:r)},electricChars:"{}"}}),B.defineMIME("text/x-glsl",{name:"glsl",keywords:fr(fn),builtins:fr(fs),blockKeywords:fr("case do else for if switch while struct"),atoms:fr("null"),hooks:{"#":function(e,t){return!!t.startOfLine&&(e.skipToEnd(),"meta")}}});class fo extends eh.gj{state;textEditor;get element(){return this.textEditor.getWrapperElement()}changingValue;debouncedValueUpdater;constructor(e){super(),this.state=e,this.changingValue=!1,this.debouncedValueUpdater=(0,ie.Z)(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},500),this.textEditor=fe()(e=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));let{shaderControlState:t}=this.state;void 0!==t&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();let i=new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&this.textEditor.refresh()},{root:document.body});i.observe(this.element),this.registerDisposer(()=>i.disconnect())}updateErrorState(){let e;let{sourceStringNumber:t=1}=this.state,i=this.state.shaderError.value,{shaderControlState:r}=this.state;e=void 0!==r?r.parseErrors.value:[],void 0===i&&0===e.length?this.setValidState(void 0):null!=i||0!==e.length?(this.textEditor.setOption("lint",{getAnnotations:()=>{let r=[];for(let t of e)r.push({message:t.message,severity:"error",from:fe().Pos(t.line)});if(null!=i){if("ShaderCompilationError"===i.name)for(let e of i.errorMessages)r.push({message:e.message,severity:"error",from:fe().Pos(e.file===t&&e.line||0)});else"ShaderLinkError"===i.name?r.push({message:i.log,severity:"error",from:fe().Pos(0)}):r.push({message:i.message,severity:"error",from:fe().Pos(0)})}return r}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),!0===e?t.classList.add("valid-input"):!1===e&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,sy(this.element),this.textEditor=void 0,super.disposed()}}function fl(e,t,i,r,n){let s=document.createElement("div");s.style.flex="1";let a=document.createElement("div");a.className=n,a.appendChild(document.createTextNode("Shader")),a.appendChild(s),e.registerDisposer(new i6(e.codeVisible,t.element));let o=new aN(e.codeVisible,{enableTitle:"Show code",disableTitle:"Hide code",backgroundScheme:"dark",svg:ft});return a.appendChild(o.element),a.appendChild(function(e={}){return sC({svg:fa,...e})}({title:"Show larger editor view",onClick:()=>{new i(e)}})),a.appendChild(function(e={}){return sC({text:"?",...e})}(r)),a}function fd(e,t){var i,r,n;let{shaderControlState:s}=e,a=s.state.get(t);if(void 0===a)return;let{control:o}=a;switch(o.type){case"slider":return uD(()=>({value:a.trackable,options:{min:o.min,max:o.max,step:o.step}}));case"color":return uV(()=>a.trackable);case"checkbox":return uC(()=>a.trackable);case"imageInvlerp":return i=()=>({dataType:o.dataType,defaultChannel:o.default.channel,watchableValue:a.trackable,channelCoordinateSpaceCombiner:s.channelCoordinateSpaceCombiner,histogramSpecifications:s.histogramSpecifications,histogramIndex:l(),legendShaderOptions:e.legendShaderOptions}),{makeControl:(e,t,r)=>{let{watchableValue:n,channelCoordinateSpaceCombiner:s,dataType:a,defaultChannel:o,histogramSpecifications:l,legendShaderOptions:d,histogramIndex:u}=i(e);if(void 0!==s&&0!==o.length){let e=t.registerDisposer(new nT(s.combined)),i=t.registerDisposer(new aZ(e,s,{copyButton:!1}));t.registerDisposer(e.changed.add(()=>{let t=Array.from(e.value,e=>Math.floor(e)),i=n.value;(0,H.cO)(i.channel,t)||(n.value={...n.value,channel:t})}));let a=()=>{let t=e.value,i=n.value;(0,H.cO)(t,i.channel)||(t.set(i.channel),e.changed.dispatch())};a(),t.registerDisposer(n.changed.add(a)),r.labelContainer.appendChild(i.element)}let c=t.registerDisposer(new sG(r.visibility,r.display,a,n,l,u,0===o.length?d:void 0));return{control:c,controlElement:c.element}},activateTool:(e,t)=>{sq(e,t)}};case"propertyInvlerp":return r=()=>({properties:o.properties,watchableValue:a.trackable,histogramSpecifications:s.histogramSpecifications,histogramIndex:l(),legendShaderOptions:e.legendShaderOptions}),{makeControl:(e,t,i)=>{let{watchableValue:n,properties:s,histogramSpecifications:a,legendShaderOptions:o,histogramIndex:l}=r(e);{let e=document.createElement("select");for(let[t,i]of s){let r=document.createElement("option");r.textContent=`${t} (${el[i].toLowerCase()})`,r.value=t,e.appendChild(r)}let r=()=>{e.value=n.value.property};t.registerEventListener(e,"change",()=>{let t=e.value,i=s.get(t),{window:r,range:a}=n.value;n.value={window:void 0!==r?eN(r,i):void 0,range:void 0!==a?eN(a,i):void 0,property:t,dataType:i}}),t.registerDisposer(n.changed.add(r)),r(),i.labelContainer.appendChild(e)}let d={changed:n.changed,get value(){let{dataType:e,window:t,range:i}=n.value;return void 0===i&&(i=eb[e]),{window:eT(t??i),range:i}},set value(newValue){let{window:e,range:t}=newValue;n.value={...n.value,window:e,range:t}}},u=(0,J.mo)(e=>e.dataType,[n]),c=t.registerDisposer(new sj(i.visibility,i.display,u,d,a,l,o));return{control:c,controlElement:c.element}},activateTool:(e,t)=>{sq(e,t)}};case"transferFunction":return n=()=>({dataType:o.dataType,watchableValue:a.trackable,channelCoordinateSpaceCombiner:s.channelCoordinateSpaceCombiner,defaultChannel:o.default.channel,histogramSpecifications:s.histogramSpecifications,histogramIndex:l()}),{makeControl:(e,t,i)=>{let{watchableValue:r,channelCoordinateSpaceCombiner:s,defaultChannel:a,histogramSpecifications:o,histogramIndex:l,dataType:d}=n(e);if(void 0!==s&&0!==a.length){let e=t.registerDisposer(new nT(s.combined)),n=t.registerDisposer(new aZ(e,s,{copyButton:!1}));t.registerDisposer(e.changed.add(()=>{let t=Array.from(e.value,e=>Math.floor(e)),i=r.value;(0,H.cO)(i.channel,t)||(r.value={...r.value,channel:t})}));let a=()=>{let t=e.value,i=r.value;(0,H.cO)(i.channel,t)||(t.set(i.channel),e.changed.dispatch())};a(),t.registerDisposer(r.changed.add(a)),i.labelContainer.appendChild(n.element)}let u=t.registerDisposer(new ol(i.visibility,i.display,d,r,o,l));return{control:u,controlElement:u.element}},activateTool:(e,t)=>{!function(e,t){e.bindInputEventMap(oa)}(e,0)}}}function l(e=o.type){let i=t=>{if("imageInvlerp"===e||"transferFunction"===e)return"imageInvlerp"===t||"transferFunction"===t;if("propertyInvlerp"===e)return"propertyInvlerp"===t;throw Error(`${e} does not support histogram index.`)},r=0;for(let[e,{control:{type:n}}]of s.state){if(e===t)break;i(n)&&r++}return r}}function fu(e,t,i){return{label:i,toolJson:{type:t,[fp]:i},makeControl:(t,r,n)=>fd(e(t),i).makeControl(t,r,n),activateTool:(t,r)=>fd(e(t.tool.layer),i).activateTool(t,r)}}class fc extends sE{state;display;layer;options;controlDisposer;toolId;constructor(e,t,i,r={}){super(r.visibility),this.state=e,this.display=t,this.layer=i,this.options=r,this.controlDisposer=void 0;let{toolId:n=fh}=r;this.toolId=n;let{element:s}=this;s.style.display="contents";let{controls:a}=e;this.registerDisposer(a.changed.add(this.registerCancellable((0,ie.Z)(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){let{element:e}=this;void 0!==this.controlDisposer&&(this.controlDisposer.dispose(),sv(e));let t=this.controlDisposer=new eh.gj,i=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(let r of this.state.state.keys())e.appendChild(uS(t,this.layer,this.visibility,fu(i,this.toolId,r)))}disposed(){this.controlDisposer?.dispose(),super.disposed()}}let fh="shaderControl",fp="control";class fg extends uy{layerShaderControls;control;constructor(e,t,i,r){super(e,fu(()=>t,i,r)),this.layerShaderControls=t,this.control=r;let n=this.registerCancellable((0,ie.Z)(()=>{void 0===t.shaderControlState.state.get(r)&&this.unbind()}));this.registerDisposer(t.shaderControlState.controls.changed.add(n))}isLoading(){let{shaderControlState:e}=this.layerShaderControls;return void 0===e.state.get(this.control)}}function ff(e,t,i=fh){am(e,i,(e,r)=>{let n=(0,ef.uq)(r,fp,ef.ZE);return new fg(e,t(e),i,n)},(e,i)=>{let{shaderControlState:r}=t(e);return void 0!==i&&r.controls.changed.addOnce(i),Array.from(r.state.keys(),e=>({type:fh,[fp]:e}))})}function fm(e){return new fo({fragmentMain:e.displayState.skeletonRenderingOptions.shader,shaderError:e.displayState.shaderError,shaderControlState:e.displayState.skeletonRenderingOptions.shaderControlState})}class fv extends sE{layer;constructor(e){super(),this.layer=e;let{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{let i=this.registerDisposer(new g9(e.displayState.linkedSegmentationGroup));i.label.textContent="Linked to: ",t.appendChild(i.element)}{let i=this.registerDisposer(new g9(e.displayState.linkedSegmentationColorGroup));i.label.textContent="Colors linked to: ",t.appendChild(i.element)}for(let i of u_)t.appendChild(uS(this,e,this.visibility,i));let i=this.registerDisposer(new aB(e.hasSkeletonsLayer,(t,i,r)=>{if(!t)return;let n=r.registerDisposer(fm(this.layer));i.appendChild(fl(this.layer,n,fy,{title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"},"neuroglancer-segmentation-dropdown-skeleton-shader-header")),i.appendChild(n.element),i.appendChild(r.registerDisposer(new fc(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:um})).element),n.textEditor.refresh()},this.visibility));t.appendChild(i.element)}}class fy extends g8{layer;codeWidget;constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(fm(e)),this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}class fb extends iz{hashTable=new uQ;changed=new eO.MZ;get value(){return this}static makeWithCounterpart(e){let t=new fb;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:i}=this;i&&i.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e){return this.hashTable.get(e)}[Symbol.iterator](){return this.hashTable.entries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){for(let[t,i]of(this.clear(),e))this.set(t,i)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,i]of this.hashTable.entries())e[t.toString()]=i.toString();return e}}fb=function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([iW("Uint64Map")],fb),iO("Uint64Map.set",function(e){let t=this.get(e.id);t.set_(e.key,e.value)&&t.changed.dispatch()}),iO("Uint64Map.delete",function(e){let t=this.get(e.id);t.delete_(e.key)&&t.changed.dispatch()}),iO("Uint64Map.clear",function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()});class fS{changed=new eO.MZ;data=new Set;dispose(){this.data.clear()}get size(){return this.data.size}get value(){return this}has(e){return this.data.has(e)}add(e){let{data:t}=this;if("bigint"!=typeof e){let i=[];for(let r of e)t.has(r)||(i.push(r),t.add(r));0!==i.length&&this.changed.dispatch(i,!0)}else{if(t.has(e))return;t.add(e),this.changed.dispatch(e,!0)}}[Symbol.iterator](){return this.data.values()}delete(e){let{data:t}=this;if("bigint"!=typeof e){let i=[];for(let r of e)t.has(r)&&(t.delete(r),i.push(r));0!==i.length&&this.changed.dispatch(i,!1)}else{if(!t.has(e))return;t.delete(e),this.changed.dispatch(e,!1)}}set(e,t){t?this.add(e):this.delete(e)}clear(){this.data.size>0&&(this.data.clear(),this.changed.dispatch(null,!1))}toJSON(){return Array.from(this.data,e=>e.toString())}assignFrom(e){this.clear();let t=e.data,{data:i}=this,r=Array.from(t);for(let e of t)i.add(e);this.changed.dispatch(r,!0)}}class fw extends iz{hashTable=new uZ;changed=new eO.MZ;get value(){return this}static makeWithCounterpart(e){let t=new fw;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}reserve_(e){return this.hashTable.reserve(e)}reserve(e){if(this.reserve_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.reserve",{id:this.rpcId,value:e})}}add_(e){let t=!1;for(let i of e)t=this.hashTable.add(i)||t;return t}add(e){let t="bigint"==typeof e?[e]:e;if(this.add_(t)){let{rpc:i}=this;i&&i.invoke("Uint64Set.add",{id:this.rpcId,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}keys(){return this.hashTable.keys()}delete_(e){let t=!1;for(let i of e)t=this.hashTable.delete(i)||t;return t}delete(e){let t="bigint"==typeof e?[e]:e;if(this.delete_(t)){let{rpc:i}=this;i&&i.invoke("Uint64Set.delete",{id:this.rpcId,value:t}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=[];for(let t of this.keys())e.push(t.toString());return e.sort(),e}assignFrom(e){for(let t of(this.clear(),e.keys()))this.add(t)}}fw=function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([iW("Uint64Set")],fw),iO("Uint64Set.reserve",function(e){let t=this.get(e.id);t.reserve_(e.value)&&t.changed.dispatch()}),iO("Uint64Set.add",function(e){let t=this.get(e.id);t.add_(e.value)&&t.changed.dispatch()}),iO("Uint64Set.delete",function(e){let t=this.get(e.id);t.delete_(e.value)&&t.changed.dispatch()}),iO("Uint64Set.clear",function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()});class fC extends eh.gj{layer;specificationChanged;constructor(e){super(),this.layer=e,this.specificationChanged=new eO.MZ,this.localGraph=new h$,this.selectedSegments=this.registerDisposer(new fS),this.segmentPropertyMap=new J.SN(void 0),this.graph=new J.SN(void 0),this.localSegmentEquivalences=!1,this.maxIdLength=new J.SN(1),this.hideSegmentZero=new i3(!0,!0),this.segmentQuery=new J.TU("",ef.ZE);let{specificationChanged:t}=this;this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch);let{selectedSegments:i}=this,r=this.visibleSegments=this.registerDisposer(fw.makeWithCounterpart(e.manager.rpc));this.segmentEquivalences=this.registerDisposer(h_.makeWithCounterpart(e.manager.rpc,e.registerDisposer((0,J.mo)(e=>e?.visibleSegmentEquivalencePolicy||lo.BA.MIN_REPRESENTATIVE,[this.graph])))),this.temporaryVisibleSegments=e.registerDisposer(fw.makeWithCounterpart(e.manager.rpc)),this.temporarySegmentEquivalences=e.registerDisposer(h_.makeWithCounterpart(e.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy)),this.useTemporaryVisibleSegments=e.registerDisposer(iH.make(e.manager.rpc,!1)),this.useTemporarySegmentEquivalences=e.registerDisposer(iH.make(e.manager.rpc,!1)),r.changed.add(t.dispatch),i.changed.add(t.dispatch),i.changed.add((e,t)=>{t||(e?r.delete(e):r.clear())}),r.changed.add((e,t)=>{t&&e&&i.add(e)})}restoreState(e){(0,ef.Kh)(e,d7,e=>this.hideSegmentZero.restoreState(e)),(0,ef.Kh)(e,ur,e=>{this.localGraph.restoreState(e)}),(0,ef.Kh)(e,ui,e=>{let{segmentEquivalences:t,selectedSegments:i,visibleSegments:r}=this;(0,ef.m7)(e,e=>{let n=String(e),s=n.startsWith("!");s&&(n=n.substring(1));let a=(0,ef.tw)(n),o=t.get(a);i.add(o),s||r.add(o)})}),(0,ef.Kh)(e,uu,e=>this.segmentQuery.restoreState(e))}toJSON(){let e={};e[d7]=this.hideSegmentZero.toJSON();let{selectedSegments:t,visibleSegments:i}=this;t.size>0?e[ui]=[...t].map(e=>i.has(e)?e.toString():"!"+e.toString()):e[ui]=[];let{segmentEquivalences:r}=this;return this.localSegmentEquivalences&&r.size>0&&(e[ur]=r.toJSON()),e[uu]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.selectedSegments.assignFrom(e.selectedSegments),this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}localGraph;visibleSegments;selectedSegments;segmentPropertyMap;graph;segmentEquivalences;localSegmentEquivalences;maxIdLength;hideSegmentZero;segmentQuery;temporaryVisibleSegments;temporarySegmentEquivalences;useTemporaryVisibleSegments;useTemporarySegmentEquivalences}class fx extends eh.gj{layer;specificationChanged;constructor(e){super(),this.layer=e,this.specificationChanged=new eO.MZ,this.segmentColorHash=cf.getDefault(),this.segmentStatedColors=this.registerDisposer(new fb),this.tempSegmentStatedColors2d=this.registerDisposer(new fb),this.segmentDefaultColor=new eo,this.tempSegmentDefaultColor2d=new J.SN(void 0),this.highlightColor=new J.SN(void 0);let{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.tempSegmentStatedColors2d.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch),this.tempSegmentDefaultColor2d.changed.add(t.dispatch),this.highlightColor.changed.add(t.dispatch)}restoreState(e){(0,ef.Kh)(e,un,e=>this.segmentColorHash.restoreState(e)),(0,ef.Kh)(e,ug,e=>this.segmentDefaultColor.restoreState(e)),(0,ef.Kh)(e,us,e=>{for(let[t,i]of(0,ef.ZI)(e,e=>Q(String(e)))){let e=(0,ef.tw)(t),r=BigInt(ee(i));this.segmentStatedColors.set(e,r)}})}toJSON(){let e={};e[un]=this.segmentColorHash.toJSON(),e[ug]=this.segmentDefaultColor.toJSON();let{segmentStatedColors:t}=this;if(t.size>0){let i=e[us]={};for(let[e,r]of t)i[e.toString()]=er(et(Number(r)))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.tempSegmentStatedColors2d.assignFrom(e.tempSegmentStatedColors2d),this.segmentDefaultColor.value=e.segmentDefaultColor.value,this.highlightColor.value=e.highlightColor.value}segmentColorHash;segmentStatedColors;tempSegmentStatedColors2d;segmentDefaultColor;tempSegmentDefaultColor2d;highlightColor}class fE extends eh.gj{linkedGroup;propertyName;curRoot;curGroupState;get changed(){return this.linkedGroup.root.changed}get value(){let e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;let t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){let{curGroupState:e}=this;void 0!==e&&(t.assignFrom(e),e.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){this.curGroupState?.dispose()}constructor(e,t){super(),this.linkedGroup=e,this.propertyName=t,this.value}}class fT{layer;constructor(e){this.layer=e,this.segmentSelectionState=new cU,this.selectedAlpha=pw(.5),this.saturation=pw(1),this.notSelectedAlpha=pw(0),this.hoverHighlight=new i3(!0,!0),this.silhouetteRendering=new J.TU(0,ef.lu,0),this.objectAlpha=pw(1),this.ignoreNullVisibleSet=new i3(!0,!0),this.skeletonRenderingOptions=new h3,this.shaderError=rc(),this.renderScaleHistogram=new lg,this.renderScaleTarget=lp(1),this.baseSegmentColoring=new i3(!1,!1),this.baseSegmentHighlighting=new i3(!1,!1),this.moveToSegment=e=>{this.layer.moveToSegment(e)},e.displayState=this,this.linkedSegmentationGroup=e.registerDisposer(new dB(e.manager.rootLayers,e,e=>e instanceof fD,e=>e.displayState.linkedSegmentationGroup)),this.linkedSegmentationColorGroup=this.layer.registerDisposer(new dB(e.manager.rootLayers,e,e=>e instanceof fD,e=>e.displayState.linkedSegmentationColorGroup)),this.originalSegmentationGroupState=e.registerDisposer(new fC(e)),this.originalSegmentationColorGroupState=e.registerDisposer(new fx(e)),this.transparentPickEnabled=e.pick,this.useTempSegmentStatedColors2d=e.registerDisposer(iH.make(e.manager.rpc,!1)),this.segmentationGroupState=this.layer.registerDisposer(new fE(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new fE(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.selectSegment=e.selectSegment,this.filterBySegmentLabel=e.filterBySegmentLabel,this.hideSegmentZero=this.layer.registerDisposer(new J.ip(this.segmentationGroupState,e=>e.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new J.kp(this.segmentationColorGroupState,e=>e.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new J.kp(this.segmentationColorGroupState,e=>e.segmentStatedColors)),this.tempSegmentStatedColors2d=this.layer.registerDisposer(new J.kp(this.segmentationColorGroupState,e=>e.tempSegmentStatedColors2d)),this.segmentDefaultColor=this.layer.registerDisposer(new J.kp(this.segmentationColorGroupState,e=>e.segmentDefaultColor)),this.tempSegmentDefaultColor2d=this.layer.registerDisposer(new J.kp(this.segmentationColorGroupState,e=>e.tempSegmentDefaultColor2d)),this.highlightColor=this.layer.registerDisposer(new J.kp(this.segmentationColorGroupState,e=>e.highlightColor)),this.segmentQuery=this.layer.registerDisposer(new J.ip(this.segmentationGroupState,e=>e.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new J.ip(this.segmentationGroupState,e=>e.segmentPropertyMap))}segmentSelectionState;selectedAlpha;saturation;notSelectedAlpha;hoverHighlight;silhouetteRendering;objectAlpha;ignoreNullVisibleSet;skeletonRenderingOptions;shaderError;renderScaleHistogram;renderScaleTarget;selectSegment;transparentPickEnabled;baseSegmentColoring;baseSegmentHighlighting;useTempSegmentStatedColors2d;filterBySegmentLabel;moveToSegment;linkedSegmentationGroup;linkedSegmentationColorGroup;originalSegmentationGroupState;originalSegmentationColorGroupState;segmentationGroupState;segmentationColorGroupState;hideSegmentZero;segmentColorHash;segmentStatedColors;tempSegmentStatedColors2d;segmentDefaultColor;tempSegmentDefaultColor2d;highlightColor;segmentQuery;segmentPropertyMap}let fk=gP(dE);class fD extends fk{sliceViewRenderScaleHistogram=new lg;sliceViewRenderScaleTarget=lp(1);codeVisible=new i3(!0);graphConnection=new J.SN(void 0);bindSegmentListWidth(e){return cW(this.displayState,e)}segmentQueryFocusTime=new J.SN(Number.NEGATIVE_INFINITY);selectSegment=(e,t)=>{this.manager.root.selectionState.captureSingleLayerState(this,t=>(t.value=e,!0),t)};filterBySegmentLabel=e=>{let{label:t}=cG(this.displayState,e);t&&this.filterSegments(t)};filterSegments=e=>{this.displayState.segmentationGroupState.value.segmentQuery.value=e,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer};displayState=new fT(this);anchorSegment=new J.TU(void 0,e=>void 0===e?void 0:(0,ef.tw)(e));constructor(e){super(e),this.codeVisible.changed.add(this.specificationChanged.dispatch),this.registerDisposer((0,J.w)((e,t)=>{e.registerDisposer(t.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer((0,J.w)((e,t)=>{e.registerDisposer(t.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.hoverHighlight.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new fv(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new gQ(this)});let t=this.registerDisposer((0,J.mo)(e=>void 0===e,[this.displayState.segmentationGroupState.value.graph]));this.tabs.add("graph",{label:"Graph",order:-25,getter:()=>new hR(this),hidden:t}),this.tabs.default="rendering"}get volumeOptions(){return{volumeType:pt.SEGMENTATION}}has2dLayer=this.registerDisposer((0,J.og)(e=>e.some(e=>e instanceof pS),{changed:this.layersChanged,value:this.renderLayers}));has3dLayer=this.registerDisposer((0,J.og)(e=>e.some(e=>e instanceof ho||e instanceof hp||e instanceof h6||e instanceof h5),{changed:this.layersChanged,value:this.renderLayers}));hasSkeletonsLayer=this.registerDisposer((0,J.og)(e=>e.some(e=>e instanceof h6),{changed:this.layersChanged,value:this.renderLayers}));activateDataSubsources(e){let t;let i=[],r=this.displayState.linkedSegmentationGroup.root.value===this;for(let n of e){if(this.addStaticAnnotations(n))continue;let{volume:e,mesh:s,segmentPropertyMap:a,segmentationGraph:o,local:l}=n.subsourceEntry.subsource;if(e instanceof pd){if(e.dataType===el.FLOAT32){n.deactivate("Data type not compatible with segmentation layer");continue}n.activate(()=>n.addRenderLayer(new pS(e,{...this.displayState,transform:n.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else void 0!==s?n.activate(()=>{let e={...this.displayState,transform:n.getRenderLayerTransform()};if(s instanceof hu)n.addRenderLayer(new ho(this.manager.chunkManager,s,e));else if(s instanceof hm)n.addRenderLayer(new hp(this.manager.chunkManager,s,e));else{let t=new h4(this.manager.chunkManager,s,e);n.addRenderLayer(new h6(t.addRef())),n.addRenderLayer(new h5(t))}},this.displayState.segmentationGroupState.value):void 0!==a?r?(n.activate(()=>{}),i.push(a)):n.deactivate("Not supported on non-root linked segmentation layers"):void 0!==o?r?void 0!==t?n.deactivate("Only one segmentation graph is supported"):(t=o,n.activate(e=>{let t=o.connect(this);e.registerDisposer(()=>{t.dispose(),this.graphConnection.value=void 0});let i={...this.displayState,transform:n.getRenderLayerTransform()},r=t.createRenderLayers(this.manager.chunkManager,i,this.localPosition);for(let e of(this.graphConnection.value=t,r))n.addRenderLayer(e)})):n.deactivate("Not supported on non-root linked segmentation layers"):l===lZ.equivalences?r?void 0!==t?n.deactivate("Only one segmentation graph is supported"):(t=this.displayState.originalSegmentationGroupState.localGraph,n.activate(e=>{this.graphConnection.value=e.registerDisposer(t.connect(this)),e.registerDisposer(()=>{this.graphConnection.value=void 0})})):n.deactivate("Not supported on non-root linked segmentation layers"):n.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=this.manager.chunkManager.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:i.map(e=>ri(e))},()=>{let e=function(e){for(;;){if(0===e.length)return;if(1===e.length)return e[0];let r=[];for(let n=0,s=e.length;n<s;n+=2)if(n+1===s)r.push(e[n]);else{var t,i;r.push((t=e[n],i=e[n+1],new hw({inlineProperties:function(e,t){let i;if(void 0===e)return t;if(void 0===t)return e;let r=0,n=e.ids.length,s=t.ids.length,a=new Uint32Array(n),o=new Uint32Array(s),l=e.ids,d=t.ids;if((0,H.FD)(n,s,(e,t)=>(0,em._f)(l[e],d[t]),e=>{a[e]=r,++r},e=>{o[e]=r,++r},(e,t)=>{a[e]=r,o[t]=r,++r}),r===n)i=l;else if(r===s)i=d;else{i=new BigUint64Array(r);for(let e=0;e<n;++e)i[a[e]]=l[e];for(let e=0;e<s;++e)i[o[e]]=d[e]}let u=[];if(r===n)u.push(...e.properties);else for(let t of e.properties)u.push(hE(t,r,a));if(r===s)u.push(...t.properties);else for(let e of t.properties)u.push(hE(e,r,o));return{ids:i,properties:u}}(t.inlineProperties,i.inlineProperties)})))}e=r}}(i);if(void 0!==e)return new hC(e)}),this.displayState.originalSegmentationGroupState.graph.value=t}getLegacyDataSourceSpecifications(e,t,i,r){let n=super.getLegacyDataSourceSpecifications(e,t,i,r),s=(0,ef.Kh)(t,"mesh",e=>null===e?null:(0,ef.ZE)(e)),a=(0,ef.Kh)(t,"skeletons",e=>null===e?null:(0,ef.ZE)(e));if(void 0!==s||void 0!==a)for(let e of n)e.enableDefaultSubsources=!1,e.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return null!=s&&n.push(l7(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:s,type:"mesh"}))),null!=a&&n.push(l7(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:a,type:"skeletons"}))),void 0!==t[ur]&&void 0===r.find(e=>e.url===lK)&&n.push({url:lK,enableDefaultSubsources:!0,transform:{outputSpace:tx,sourceRank:0,transform:void 0,inputSpace:tx},subsources:new Map}),n}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[d4]),this.displayState.saturation.restoreState(e[d8]),this.displayState.notSelectedAlpha.restoreState(e[d6]),this.displayState.hoverHighlight.restoreState(e[d9]),this.displayState.objectAlpha.restoreState(e[d5]),this.displayState.baseSegmentColoring.restoreState(e[ue]),this.displayState.silhouetteRendering.restoreState(e[uc]),this.displayState.ignoreNullVisibleSet.restoreState(e[ut]);let{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[ul]);let i=e.skeletonShader;void 0!==i&&t.shader.restoreState(i),this.codeVisible.restoreState(ud),this.displayState.renderScaleTarget.restoreState(e[ua]),this.anchorSegment.restoreState(e[uf]),this.sliceViewRenderScaleTarget.restoreState(e[uo]);let r=(0,ef.Kh)(e,uh,ef.ZE);void 0!==r&&this.displayState.linkedSegmentationGroup.linkByName(r);let n=(0,ef.Kh)(e,up,e=>!1===e?void 0:(0,ef.ZE)(e),r);void 0!==n&&this.displayState.linkedSegmentationColorGroup.linkByName(n),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){let e=super.toJSON();e[d4]=this.displayState.selectedAlpha.toJSON(),e[d6]=this.displayState.notSelectedAlpha.toJSON(),e[d8]=this.displayState.saturation.toJSON(),e[d5]=this.displayState.objectAlpha.toJSON(),e[d9]=this.displayState.hoverHighlight.toJSON(),e[ue]=this.displayState.baseSegmentColoring.toJSON(),e[ut]=this.displayState.ignoreNullVisibleSet.toJSON(),e[uc]=this.displayState.silhouetteRendering.toJSON(),e[uf]=this.anchorSegment.toJSON(),e[ul]=this.displayState.skeletonRenderingOptions.toJSON(),e[ud]=this.codeVisible.toJSON(),e[ua]=this.displayState.renderScaleTarget.toJSON(),e[uo]=this.sliceViewRenderScaleTarget.toJSON();let{linkedSegmentationGroup:t,linkedSegmentationColorGroup:i}=this.displayState;return e[uh]=t.toJSON(),i.root.value!==t.root.value&&(e[up]=i.toJSON()??!1),e[ur]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),i.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return null==e?e:cz(this.displayState,e)}handleAction(e,t){switch(e){case"recolor":this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break;case"clear-segments":if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break;case"select":case"star":{if(!this.pick.value)break;let{segmentSelectionState:i}=this.displayState;if(i.hasSelectedSegment){let r=i.selectedSegment,n=this.displayState.segmentationGroupState.value,s="select"===e?n.visibleSegments:n.selectedSegments,a=!s.has(r);(a||void 0===t.segmentationToggleSegmentState)&&(t.segmentationToggleSegmentState=a),t.defer(()=>{t.segmentationToggleSegmentState===a&&s.set(r,a)})}}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);let{value:i}=e;"number"==typeof i&&(i=i.toString());try{e.value=(0,ef.tw)(i)}catch{e.value=void 0}}selectionStateToJson(e,t){let i=super.selectionStateToJson(e,t),{value:r}=e;return r instanceof c_?t?i.value={key:r.key.toString(),value:r.value?r.value.toString():void 0,label:r.label}:i.value=(r.value||r.key).toString():"bigint"==typeof r&&(i.value=r.toString()),i}displaySegmentationSelection(e,t,i){let r;let{value:n}=e;if("number"==typeof n||"string"==typeof n)try{r=(0,ef.tw)(n)}catch{return!1}if("bigint"==typeof n)r=n;else{if(!(n instanceof c_))return!1;r=n.key}let{displayState:s}=this,a=cG(s,r),{segmentEquivalences:o,segmentPropertyMap:{value:l}}=this.displayState.segmentationGroupState.value,d=o.get(r),u=cX(this.displayState,a);if(cQ(s,i,i.redraw),i.registerDisposer(cW(s,u)),u.classList.add("neuroglancer-selection-details-segment"),t.appendChild(u),void 0!==l){let{inlineProperties:e}=l.segmentPropertyMap;if(void 0!==e){let i=l.getSegmentInlineIndex(d);if(-1!==i){for(let r of e.properties)if("label"!==r.type){if("description"===r.type){let e=r.values[i];if(!e)continue;let n=document.createElement("div");n.classList.add("neuroglancer-selection-details-segment-description"),n.textContent=e,t.appendChild(n)}else if("number"===r.type||"string"===r.type){let e=r.values[i];if("number"===r.type?Number.isNaN(e):!e)continue;let n=document.createElement("div");n.classList.add("neuroglancer-selection-details-segment-property");let s=document.createElement("div");s.classList.add("neuroglancer-selection-details-segment-property-name"),s.textContent=r.id,r.description&&(s.title=r.description);let a=document.createElement("div");a.classList.add("neuroglancer-selection-details-segment-property-value"),a.textContent=e.toString(),n.appendChild(s),n.appendChild(a),t.appendChild(n)}}}}}return!0}displaySelectionState(e,t,i){let r=this.displaySegmentationSelection(e,t,i);return super.displaySelectionState(e,t,i)&&(r=!0),r}moveToSegment(e){for(let t of this.renderLayers){if(!(t instanceof hp||t instanceof ho))continue;let i=t.displayState.transform.value;if(void 0!==i.error)return;let{rank:r,globalToRenderLayerDimensions:n}=i,{globalPosition:s}=this.manager.root,a=new Float32Array(r),o=[];for(let e=0;e<r;e++)o[n[e]]=e;(0,H.zV)(a,s.value,o);let l=t instanceof ho?t.getObjectPosition(e,a):t.getObjectPosition(e);if(void 0!==l){this.setLayerPosition(i,l);return}}s1.showTemporaryMessage(`No position information loaded for segment ${e}`)}static type="segmentation";static typeAbbreviation="seg";static supportsPickOption=!0}!function(e){for(let t of u_)uw(e,t)}(fD),dK(fD),_=pt.SEGMENTATION,dH.set(_,fD),dZ(e=>{if(void 0!==e.mesh)return{layerConstructor:fD,priority:1}}),ff(fD,e=>({shaderControlState:e.displayState.skeletonRenderingOptions.shaderControlState}),um),am(fD,gV,e=>new g_(e)),am(fD,gO,e=>new gU(e)),am(fD,gR,e=>new gN(e));class fL extends eh.gj{ref;element;selectElement;constructor(e){super(),this.ref=e,this.element=document.createElement("label"),this.selectElement=document.createElement("select"),this.registerDisposer(e);let{element:t,selectElement:i}=this;t.appendChild(i),this.updateView(),this.registerEventListener(i,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add((0,ie.Z)(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){let{selectElement:e,ref:t}=this,{filter:i}=t;sv(e);let r=document.createElement("option");for(let t of(e.appendChild(r),this.ref.layerManager.managedLayers))if(i(t)){let i=document.createElement("option"),{name:r}=t;i.textContent=r,i.value=r,e.appendChild(i)}e.value=t.layerName||""}}let fI="annotations",fP="annotationProperties",fR="annotationRelationships",fA="crossSectionAnnotationSpacing",fM="projectionAnnotationSpacing",fN="shader",fV="shaderControls",fO="annotationColor";function fF(e){let t=e.layer;return null===t||t instanceof fD}let fB="linkedSegmentationLayer",f_="filterBySegmentation",fU="ignoreNullSegmentFilter",f$="codeVisible";class fz extends eh.gj{layerManager;annotationStates;annotationDisplayState;changed;curGeneration;wasLoading;constructor(e,t,i){super(),this.layerManager=e,this.annotationStates=t,this.annotationDisplayState=i,this.changed=new eO.K_,this.curGeneration=-1,this.wasLoading=void 0,this.map=new Map,this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){let e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;let{map:i}=this,r=!1;for(let t of this.annotationStates.relationships){let n=i.get(t);void 0===n&&(n=this.addRelationship(t),r=!0),n.seenGeneration=e}if(!t){let{relationshipStates:t}=this.annotationDisplayState;for(let[n,s]of i)s.seenGeneration!==e&&(i.delete(n),t.delete(n),r=!0)}r&&this.changed.dispatch()}addRelationship(e){let t=this.annotationDisplayState.relationshipStates.get(e),i=new dF(this.layerManager.addRef(),fF);i.registerDisposer(i.changed.add(()=>{t.segmentationState.value=void 0===i.layerName?void 0:function(e){if(void 0===e)return null;let t=e.layer;return null!==t&&t instanceof fD?t.displayState:null}(i.layer)}));let{showMatches:r}=t,n={layerRef:i,showMatches:r,seenGeneration:-1};return i.changed.add(this.changed.dispatch),r.changed.add(this.changed.dispatch),this.map.set(e,n),n}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(let e of this.map.values())e.showMatches.reset()}toJSON(){let e;let{map:t}=this;if(0===t.size)return{};let i=[];for(let[r,n]of t){n.showMatches.value&&i.push(r);let{layerName:t}=n.layerRef;void 0!==t&&((e=e||{})[r]=t)}return i.sort(),{[fB]:e,[f_]:0===i.length?void 0:i}}restoreState(e){let{isLoading:t}=this.annotationStates;(0,ef.Kh)(e,fB,e=>{for(let i of("string"==typeof e&&(e={segments:e}),(0,ef.PT)(e),Object.keys(e))){let r=(0,ef.ZE)(e[i]),n=this.map.get(i);if(void 0===n){if(!t)continue;n=this.addRelationship(i)}n.layerRef.layerName=r}for(let[t,i]of this.map)Object.prototype.hasOwnProperty.call(e,t)||(i.layerRef.layerName=void 0)}),(0,ef.Kh)(e,f_,e=>{for(let i of("boolean"==typeof e&&(e=!0===e?["segments"]:[]),(0,ef.zE)(e))){let e=this.map.get(i);if(void 0===e){if(!t)continue;e=this.addRelationship(i)}e.showMatches.value=!0}})}disposed(){let{map:e}=this;for(let t of e.values())this.unbind(t);e.clear(),super.disposed()}map}class fG extends eh.gj{relationship;state;element;seenGeneration;constructor(e,t){super(),this.relationship=e,this.state=t,this.element=document.createElement("label"),this.seenGeneration=-1;let{element:i}=this,r=this.registerDisposer(new i4(t.showMatches)),n=new fL(t.layerRef);i.appendChild(r.element),i.appendChild(document.createTextNode(e)),i.appendChild(n.element)}}class fj extends eh.gj{linkedSegmentationLayers;widgets;element;constructor(e){super(),this.linkedSegmentationLayers=e,this.widgets=new Map,this.element=document.createElement("div"),this.element.style.display="contents";let t=this.registerCancellable((0,io.H)(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){let{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,i=t.changed.count,{widgets:r}=this;for(let[e,t]of r)t.seenGeneration!==i&&(t.dispose(),r.delete(e));sS(this.element,(function*(){for(let n of t.relationships){let t=r.get(n);void 0===t&&(t=new fG(n,e.get(n))),t.seenGeneration=i,yield t.element}}).call(this))}disposed(){for(let e of(super.disposed(),this.widgets.values()))e.dispose()}}let fW=gP(dE);class fq extends fW{localAnnotations;codeVisible=new i3(!0);localAnnotationProperties;localAnnotationRelationships;localAnnotationsJson=void 0;pointAnnotationsJson=void 0;static supportColorPickerInAnnotationTab=!1;linkedSegmentationLayers=this.registerDisposer(new fz(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState));disposed(){let{localAnnotations:e}=this;void 0!==e&&e.dispose(),super.disposed()}constructor(e){super(e),this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.codeVisible.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.annotationProjectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new fK(this)}),this.tabs.default="annotations"}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.codeVisible.restoreState(e[f$]),this.localAnnotationsJson=e[fI],this.localAnnotationProperties=(0,ef.Kh)(e,fP,eZ),this.localAnnotationRelationships=(0,ef.Kh)(e,fR,ef.zE,["segments"]),this.pointAnnotationsJson=e.points,this.annotationCrossSectionRenderScaleTarget.restoreState(e[fA]),this.annotationProjectionRenderScaleTarget.restoreState(e[fM]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[fU]),this.annotationDisplayState.shader.restoreState(e[fN]),this.annotationDisplayState.shaderControls.restoreState(e[fV])}getLegacyDataSourceSpecifications(e,t,i,r){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,i,r);let n=(0,ef.Kh)(t,"voxelSize",e=>(0,ef.Iw)(new Float64Array(3),e,e=>(0,ef.o7)(e)/1e9));if(void 0!==n){let e=tw({rank:3,units:["m","m","m"],scales:n,names:["x","y","z"]});i=void 0===i?{outputSpace:e,sourceRank:3,transform:void 0,inputSpace:e}:{...i,inputSpace:e}}return[{url:lJ,transform:i,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){let t,i=!1;for(let r of e){let{subsourceEntry:e}=r,{local:n}=e.subsource,s=e=>void 0!==t&&(0,ef.hd)(e)!==(0,ef.hd)(t)?(r.deactivate("Annotation properties are not compatible"),!1):(t=e,!0);if(n===lZ.annotations){if(i){r.deactivate("Only one local annotations source per layer is supported");continue}if(i=!0,!s(this.localAnnotationProperties??[]))continue;r.activate(t=>{let i=this.localAnnotations=new e4(r.loadedDataSource.transform,this.localAnnotationProperties??[],this.localAnnotationRelationships);try{i.restoreState(this.localAnnotationsJson)}catch{}t.registerDisposer(()=>{i.dispose(),this.localAnnotations=void 0}),t.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{!function(e,t){void 0!==t&&(0,ef.m7)(t,(t,i)=>{e.add({type:eB.POINT,id:""+i,point:(0,ef.ET)(t),properties:[]})})}(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;let n=new oR({localPosition:this.localPosition,transform:t.registerDisposer(t6(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,r.loadedDataSource.transform,void 0)),source:i.addRef(),displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:e.id,role:iY.ANNOTATION});this.addAnnotationLayerState(n,r)});continue}let{annotation:a}=e.subsource;if(void 0!==a){if(!s(a.properties))continue;r.activate(()=>{let t=new oR({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:a,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:e.id,role:iY.ANNOTATION});this.addAnnotationLayerState(t,r)});continue}r.deactivate("Not compatible with annotation layer")}let r=this.annotationDisplayState.annotationProperties.value;(0,ef.hd)(r)!==(0,ef.hd)(t)&&(this.annotationDisplayState.annotationProperties.value=t)}initializeAnnotationLayerViewTab(e){let t=e.registerDisposer((0,J.og)(e=>e.some(e=>e.source instanceof lU),this.annotationStates)),i=e.registerDisposer(new aB(t,(e,t,i)=>{if(e){{let e=i.registerDisposer(new uP(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));e.label.textContent="Spacing (cross section)",t.appendChild(e.element)}{let e=i.registerDisposer(new uP(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));e.label.textContent="Spacing (projection)",t.appendChild(e.element)}}}));e.element.insertBefore(i.element,e.element.firstChild);{let t=e.registerDisposer(new i4(this.annotationDisplayState.ignoreNullSegmentFilter)),i=document.createElement("label");i.appendChild(document.createTextNode("Ignore null related segment filter")),i.title="Display all annotations if filtering by related segments is enabled but no segments are selected",i.appendChild(t.element),e.element.appendChild(i)}e.element.appendChild(e.registerDisposer(new fj(this.linkedSegmentationLayers)).element)}toJSON(){let e=super.toJSON();e[fA]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[f$]=this.codeVisible.toJSON(),e[fM]=this.annotationProjectionRenderScaleTarget.toJSON(),void 0!==this.localAnnotations?e[fI]=this.localAnnotations.toJSON():void 0!==this.localAnnotationsJson&&(e[fI]=this.localAnnotationsJson),e[fP]=function(e){if(void 0!==e&&0!==e.length)return e.map(eK)}(this.localAnnotationProperties);let{localAnnotationRelationships:t}=this;return e[fR]=1===t.length&&"segments"===t[0]?void 0:t,e[fU]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[fN]=this.annotationDisplayState.shader.toJSON(),e[fV]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}static type="annotation";static typeAbbreviation="ann"}function fH(e){return new fo({shaderError:e.annotationDisplayState.shaderError,fragmentMain:e.annotationDisplayState.shader,shaderControlState:e.annotationDisplayState.shaderControls})}class fJ extends g8{layer;codeWidget;constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(fH(this.layer)),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}class fK extends sE{layer;codeWidget;constructor(e){super(),this.layer=e;let{element:t}=this;this.codeWidget=this.registerDisposer(fH(this.layer)),t.classList.add("neuroglancer-annotation-rendering-tab");let i=this.registerDisposer(new aB(e.annotationDisplayState.annotationProperties,(e,t)=>{if(void 0===e||0===e.length)return;let i=document.createElement("div");for(let r of(t.appendChild(i),i.classList.add("neuroglancer-annotation-shader-property-list"),e)){let e=document.createElement("div");e.classList.add("neuroglancer-annotation-shader-property");let t=document.createElement("span");t.classList.add("neuroglancer-annotation-shader-property-type"),t.textContent=r.type;let n=document.createElement("span");n.classList.add("neuroglancer-annotation-shader-property-identifier"),n.textContent=`prop_${r.identifier}`,e.appendChild(t),e.appendChild(n);let{description:s}=r;void 0!==s&&(e.title=s),i.appendChild(e)}})).element;e.registerDisposer(new i6(e.codeVisible,i)),t.appendChild(i),t.appendChild(fl(this.layer,this.codeWidget,fJ,{title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/annotation/rendering.md"},"neuroglancer-annotation-dropdown-shader-top-row")),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new fc(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element),t.appendChild(uS(this,e,this.visibility,fZ[fO]))}}let fZ={[fO]:{label:"Annotation color",title:"Annotation shader default color (enabled with 'defaultColor()' in the shader code)",toolJson:fO,...uV(e=>e.annotationDisplayState.color),isValid:e=>(0,J.og)(e=>null!==e.match(/\bdefaultColor\b/),e.annotationDisplayState.shaderControls.processedFragmentMain)}};for(let e of Object.values(fZ))uw(fq,e);dK(fq),dK(fq,"pointAnnotation"),dZ(e=>e.local===lZ.annotations?{layerConstructor:fq,priority:100}:void 0!==e.annotation?{layerConstructor:fq,priority:1}:void 0),ff(fq,e=>({shaderControlState:e.annotationDisplayState.shaderControls})),i(320);var fY=((U={})[U.DEFAULT=0]="DEFAULT",U[U.ADDITIVE=1]="ADDITIVE",U);let fX=new Map([[0,e=>{e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}],[1,e=>{e.blendFunc(e.SRC_ALPHA,e.ONE)}]]),fQ=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function f0(e,t){e.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
void emitIntensity(float value) {
}
`),e.addFragmentCode(oZ),op(t,e),e.setFragmentMainFunction(rf(t.parseResult.code))}class f1 extends py{opacity;blendMode;shaderControlState;constructor(e,t){let{opacity:i,blendMode:r,shaderControlState:n}=t;super(e,{...t,fallbackShaderParameters:new J.SN(ox(oc(fQ,{imageData:{dataType:e.dataType,channelRank:t.channelCoordinateSpace?.value?.rank??0}}))),encodeShaderParameters:e=>e.key,shaderParameters:n.builderState,dataHistogramSpecifications:n.histogramSpecifications}),this.shaderControlState=n,this.opacity=i,this.blendMode=r,this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(0!==t.parseResult.errors.length)throw Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),f0(e,t)}initializeShader(e,t,i){let{gl:r}=this;r.uniform1f(t.uniform("uOpacity"),this.opacity.value),ok(r,t,this.shaderControlState,i.parseResult.controls)}setGLBlendMode(e,t){let i=this.blendMode.value;i===fY.ADDITIVE||t>0?(e.enable(e.BLEND),fX.get(i)(e)):e.disable(WebGL2RenderingContext.BLEND)}}var f2=(($={})[$.OFF=0]="OFF",$[$.ON=1]="ON",$[$.MAX=2]="MAX",$[$.MIN=3]="MIN",$);function f3(e=0){return new nb.B(f2,e)}function f4(e){return 2===e||3===e}function f6(e){return f4(e.mode.value)}let f5=Z.wO.create();function f8(e,t,i,r,n,s){if(0===r.length)return;let{viewMatrix:a,projectionMat:o,displayDimensionRenderInfo:l}=e,{voxelPhysicalScales:d}=l,u=(0,Z.n_)(d),c=(0,Z.V2)(o),h=(c/i)**3,p=Z.wO.determinant((0,Z.bZ)(f5,a)),g={spatialScales:new Map,activeIndex:-1},f=e=>Math.abs(r[e].chunkLayout.detTransform*p),m=r.length-1,v=f(m);for(let e=m;e>=0;--e){let t=f(e),i=Math.cbrt(t*u/p),r=c/Math.cbrt(t);g.spatialScales.set(i,r),t-h>=0&&(v=t,m=e),g.activeIndex=m}let y=Math.cbrt(v*u/p),b=c/Math.cbrt(v),S=!0,w=r[m];oq(e,t,w,(e,t)=>{S&&(n(w,m,y,b,t,g),S=!1),s(w,m,e)})}let f9=Symbol("depthSamplerTextureUnit"),f7=`
void emitRGBA(vec4 rgba) {
  float correctedAlpha = clamp(rgba.a * uBrightnessFactor * uGain, 0.0, 1.0);
  float weightedAlpha = correctedAlpha * computeOITWeight(correctedAlpha, depthAtRayPosition);
  outputColor += vec4(rgba.rgb * weightedAlpha, weightedAlpha);
  revealage *= 1.0 - correctedAlpha;
}
`,me=Z._E.create(),mt=new Float32Array(24);function mi(){return[1,Math.round(21)]}function mr(e){let t=mi();return eC([2**t[0],2**t[1]-1],Math.round(e))}class mn extends uW{gain;multiscaleSource;transform;channelCoordinateSpace;localPosition;shaderControlState;depthSamplesTarget;chunkResolutionHistogram;mode;backend;highestResolutionLoadedVoxelSize;modeOverride;vertexIdHelper;dataHistogramSpecifications;shaderGetter;histogramShaderGetter;get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}histogramIndexBuffer;constructor(e){super(),this.gain=e.gain,this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.depthSamplesTarget=e.depthSamplesTarget,this.chunkResolutionHistogram=e.chunkResolutionHistogram,this.mode=e.mode,this.modeOverride=f3(),this.dataHistogramSpecifications=this.shaderControlState.histogramSpecifications,this.histogramIndexBuffer=this.registerDisposer(rv(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(256))),this.registerDisposer(this.chunkResolutionHistogram.visibility.add(this.visibility)),this.registerDisposer(this.dataHistogramSpecifications.producerVisibility.add(this.visibility));let t=this.registerDisposer((0,J.mo)((e,t,i,r)=>({numChannelDimensions:e.rank,mode:i===f2.OFF?t:i,dataHistogramChannelSpecifications:r}),[this.channelCoordinateSpace,this.mode,this.modeOverride,this.dataHistogramSpecifications.channels]));this.shaderGetter=rp(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:e,chunkFormat:t,wireFrame:i})=>`${ri(e)}:${t.shaderKey}:${i}`,shaderError:e.shaderError,extraParameters:t,defineShader:(e,{emitter:t,chunkFormat:i,wireFrame:r},n,s)=>{if(0!==n.parseResult.errors.length)throw Error("Invalid UI control specification");hH(e),e.addFragmentCode(`
#define VOLUME_RENDERING true
`);let a=f7,o=`
  emitAccumAndRevealage(outputColor, 1.0 - revealage, 0u);
`,l=`
void emitIntensity(float value) {
}
`,d="";if(f4(s.mode)){let t=s.mode===f2.MIN?"1.0 - value":"value";e.addFragmentCode(`
float savedDepth = 0.0;
float savedIntensity = 0.0;
vec4 newColor = vec4(0.0);
float userEmittedIntensity = -100.0;
`),l=`
float convertIntensity(float value) {
  return clamp(${t}, 0.0, 1.0);
}
void emitIntensity(float value) {
  userEmittedIntensity = value;
}
float getIntensity() {
  float intensity = userEmittedIntensity > -100.0 ? userEmittedIntensity : defaultMaxProjectionIntensity;
  return convertIntensity(intensity);
}
`,a=`
void emitRGBA(vec4 rgba) {
  float alpha = clamp(rgba.a, 0.0, 1.0);
  newColor = vec4(rgba.rgb * alpha, alpha);
}
`,o=`
  gl_FragDepth = savedIntensity;
`,d=`
  float newIntensity = getIntensity();
  bool intensityChanged = newIntensity > savedIntensity;
  savedIntensity = intensityChanged ? newIntensity : savedIntensity; 
  savedDepth = intensityChanged ? depthAtRayPosition : savedDepth;
  outputColor = intensityChanged ? newColor : outputColor;
  emit(outputColor, savedDepth, savedIntensity, uPickId);
  defaultMaxProjectionIntensity = 0.0;
  userEmittedIntensity = -100.0;
`}if(t(e),e.addUniform("highp float","uNearLimitFraction"),e.addUniform("highp float","uFarLimitFraction"),e.addUniform("highp int","uMaxSteps"),e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uModelViewProjectionMatrix"),e.addUniform("highp mat4","uInvModelViewProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp float","uChunkNumber"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),e.addUniform("highp float","uBrightnessFactor"),e.addUniform("highp float","uGain"),e.addUniform("highp uint","uPickId"),e.addVarying("highp vec4","vNormalizedPosition"),e.addTextureSampler("sampler2D","uDepthSampler",f9),e.addVertexCode(px),e.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),e.addFragmentCode(`
vec3 curChunkPosition;
float depthAtRayPosition;
vec4 outputColor;
float revealage;
void userMain();
`),ps(e,i,s.numChannelDimensions,"curChunkPosition"),e.addFragmentCode([l,a,`
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGBA(vec4(value, value, value, value));
}
void emitTransparent() {
  emitIntensity(0.0);
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
float computeDepthFromClipSpace(vec4 clipSpacePosition) {
  float NDCDepthCoord = clipSpacePosition.z / clipSpacePosition.w;
  return (NDCDepthCoord + 1.0) * 0.5;
}
vec2 computeUVFromClipSpace(vec4 clipSpacePosition) {
  vec2 NDCPosition = clipSpacePosition.xy / clipSpacePosition.w;
  return (NDCPosition + 1.0) * 0.5;
}
`]),r){let t=`
  emit(outputColor, 0u);
`;f4(s.mode)&&(t=`
  emit(outputColor, 1.0, uChunkNumber, uPickId);
            `),e.setFragmentMainFunction(`
void main() {
  outputColor = vec4(uChunkNumber, uChunkNumber, uChunkNumber, 1.0);
  emitIntensity(uChunkNumber);
  ${t}
}
`)}else e.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  revealage = 1.0;
  for (int rayStep = startStep; rayStep < endStep; ++rayStep) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(rayStep) * stepSize);
    vec4 clipSpacePosition = uModelViewProjectionMatrix * vec4(position, 1.0);
    depthAtRayPosition = computeDepthFromClipSpace(clipSpacePosition);
    vec2 uv = computeUVFromClipSpace(clipSpacePosition);
    float depthInBuffer = texture(uDepthSampler, uv).r;
    bool rayPositionBehindOpaqueObject = (1.0 - depthAtRayPosition) < depthInBuffer;
    if (rayPositionBehindOpaqueObject) {
      break;
    }
    curChunkPosition = position - uTranslation;
    userMain();
    ${d}
  }
  ${o}
}
`);e.addFragmentCode(oZ),op(n,e),e.addFragmentCode("\n#define main userMain\n"+rf(n.parseResult.code)+"\n#undef main\n")}}),this.histogramShaderGetter=rp(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayerHistogram",parameters:e.shaderControlState.builderState,getContextKey:({chunkFormat:e})=>`${e.shaderKey}`,shaderError:e.shaderError,extraParameters:t,defineShader:(e,{chunkFormat:t},i,r)=>{e.addOutputBuffer("vec4","outputValue",null),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp int","uHistogramIndex"),e.addAttribute("float","aInput1"),e.addVertexCode(`
vec3 chunkSamplePosition;
          `);let n=r.numChannelDimensions;t.defineShader(e,n,!0);let{dataType:s}=t,a="",o="";if(0===n)a+="highp int ignoredChannelIndex";else for(let e=0;e<n;++e)0!==e&&(a+=", "),a+=`highp int channelIndex${e}`,o+=`, channelIndex${e}`;let l=`
${r6(s)} getDataValue(${a}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(chunkSamplePosition), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}`;e.addVertexCode(l),n<=1&&e.addVertexCode(`
${r6(s)} getDataValue() { return getDataValue(0); }
`);let d=r.dataHistogramChannelSpecifications,u=d.length,c=`
  float x;
  switch (uHistogramIndex) {`;for(let t=0;t<u;++t){let{channel:i}=d[t],r=`getDataValue(${i.join(",")})`,n=`invlerpForHistogram${t}`;e.addVertexCode(np(e,n,s,!1)),e.addVertexCode(`
float getHistogramValue${t}() {
  return invlerpForHistogram${t}(${r});
}
`),c+=`
  case ${t}:
    x = getHistogramValue${t}();
    break;`}c+=`
  }
`,e.addVertexCode(rQ),e.setVertexMain(`
  vec3 rand3val = vec3(
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID), float(gl_InstanceID))),
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + float(gl_InstanceID))),
    simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 20.0, 15.0 + float(gl_InstanceID))));
  chunkSamplePosition = rand3val * (uChunkDataSize - 1.0);
${c}
  if (x < 0.0) x = 0.0;
  else if (x > 1.0) x = 1.0;
  else x = (1.0 + x * 253.0) / 255.0;
  gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
  gl_PointSize = 1.0;`),e.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
          `)}}),this.vertexIdHelper=this.registerDisposer(hJ.get(this.gl)),this.registerDisposer(this.depthSamplesTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.gain.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));let{chunkManager:i}=this.multiscaleSource,r=this.registerDisposer(new la(this.layerChunkProgressInfo)),n=i.rpc;r.RPC_TYPE_ID="volume_rendering/VolumeRenderingRenderLayer",r.initializeCounterpart(n,{chunkManager:i.rpcId,localPosition:this.registerDisposer(iH.makeFromExisting(n,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(iH.makeFromExisting(n,this.depthSamplesTarget)).rpcId}),this.backend=r}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer((0,J.Uw)((t,i,r)=>{let n=lk(r,i,e=>this.multiscaleSource.getSources(e),e.messages,this);for(let e of n)for(let i of e)t.registerDisposer(i.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke("volume_rendering/VolumeRenderingRenderLayer/update",{layer:this.backend.rpcId,view:e.view.rpcId,sources:lb(n),displayDimensionRenderInfo:r}),this.redrawNeeded.dispatch(),n},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){let i,r,n,s,a;if(!e.emitColor)return;let o=t.state.sources.value;if(0===o.length)return;let l=0,d=0,u={spatialScales:new Map,activeIndex:0},c=null,h=Z.R3.create(),{gl:p}=this;this.vertexIdHelper.enable(),this.modeOverride.value=f2.OFF;let{chunkResolutionHistogram:g}=this;g.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let f=()=>{if(null===c)return;c.unbindTransferFunctionTextures(),null!==i&&i.endDrawing(p,c);let e=c.textureUnit(f9);if(p.activeTexture(WebGL2RenderingContext.TEXTURE0+e),p.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),0!==y||0!==b){let e=u.spatialScales.size-1,t=new Set([mr(d)]);u.spatialScales.forEach((i,r)=>{let n=mr(i);e===u.activeIndex||t.has(n)||(g.add(r,i,0,10,!0),t.add(n)),e--}),g.add(l,d,y,b)}},m=!0,{projectionParameters:v}=e,y=0,b=0,S=1,w=this.multiscaleSource.rank,C=Z.R3.create(),x=this.getDataHistogramCount()>0&&!e.wireFrame&&!e.sliceViewsPresent&&(!e.isContinuousCameraMotionInProgress||e.force3DHistogramForAutoRange),E=!f4(this.mode.value)&&!e.isContinuousCameraMotionInProgress&&!e.wireFrame,T=f4(this.mode.value)||E?e.pickIDs.register(this):0,k=[],D=[];if(p.enable(WebGL2RenderingContext.CULL_FACE),p.cullFace(WebGL2RenderingContext.FRONT),f8(e.projectionParameters,this.localPosition.value,this.depthSamplesTarget.value,o[0],(t,o,g,m,y,b)=>{l=g,d=m,u=b,this.highestResolutionLoadedVoxelSize=t.effectiveVoxelSize;let S=oH(v,t.chunkLayout),w=t.source,{fixedPositionWithinChunk:C,chunkDisplayDimensionIndices:x}=t;for(let e of x)C[e]=0;let E=w.chunkFormat;if(E!==i&&(i=E,f(),null!==(c=(r=this.shaderGetter({emitter:e.emitter,chunkFormat:E,wireFrame:e.wireFrame})).shader)&&(c.bind(),null!==E&&(ok(p,c,this.shaderControlState,r.parameters.parseResult.controls),this.bindDepthBufferTexture(e,c),E.beginDrawing(p,c),E.beginSource(p,c)))),s=void 0,null===c)return;n=w.chunks,h.fill(1);let k=Z._E.multiply(me,v.viewProjectionMat,S.transform);(0,Z.th)(mt,k);let D=Z._E.create();Z._E.invert(D,k);let{near:L,far:I,adjustedNear:P,adjustedFar:R}=function(e,t,i){let r=0,n=0;for(let s=0;s<3;++s){let a=e[16+s],o=a*t[s],l=a*i[s];r+=Math.min(o,l),n+=Math.max(o,l)}let s=-e[19],a=Math.max(s,r),o=e[23],l=Math.min(o,n);return{near:s,far:o,adjustedNear:a,adjustedFar:l}}(mt,t.lowerClipDisplayBound,t.upperClipDisplayBound),A=this.depthSamplesTarget.value;a={uNearLimitFraction:(P-L)/(I-L),uFarLimitFraction:(R-L)/(I-L),uMaxSteps:this.depthSamplesTarget.value,uBrightnessFactor:m/A,uGain:Math.exp(this.gain.value),uPickId:T,uLowerClipBound:t.lowerClipDisplayBound,uUpperClipBound:t.upperClipDisplayBound,uModelViewProjectionMatrix:k,uInvModelViewProjectionMatrix:D},this.setShaderUniforms(c,a)},t=>{if(null===c)return;let r=t.curPositionInChunks.join(),a=n.get(r);if(void 0!==a&&a.state===it.GPU_MEMORY){let r=t.chunkLayout.size,o=a.chunkDataSize,{chunkDisplayDimensionIndices:l,fixedPositionWithinChunk:d,chunkTransform:{channelToChunkDimensionIndices:u}}=t;if(e.wireFrame){let e=S/n.size;p.uniform1f(c.uniform("uChunkNumber"),e),++S}if(o!==s){s=o;for(let e=0;e<3;++e){let t=l[e];h[e]=-1===t||t>=w?1:s[t]}p.uniform3fv(c.uniform("uChunkDataSize"),h)}let{chunkGridPosition:g}=a;for(let e=0;e<3;++e){let t=l[e];C[e]=-1===t||t>=w?0:r[e]*g[t]}if(p.uniform3fv(c.uniform("uTranslation"),C),null!=i&&i.bindChunk(p,c,a,d,l,u,m),x||E){k.push({chunk:a,fixedPositionWithinChunk:d,chunkDisplayDimensionIndices:l,channelToChunkDimensionIndices:u,chunkFormat:i});let e=Z.R3.create(),t=Z.R3.create();Z.R3.copy(e,h),Z.R3.copy(t,C),D.push({uChunkDataSize:e,uTranslation:t})}pE(p,1,1),m=!1,++y}else++b}),f(),c=null,i=null,E){p.enable(WebGL2RenderingContext.DEPTH_TEST),p.depthMask(!0),p.disable(WebGL2RenderingContext.BLEND),p.depthFunc(WebGL2RenderingContext.GREATER),e.emitter=e.maxProjectionEmit,e.bindMaxProjectionBuffer(),this.modeOverride.value=f2.MAX;let t=()=>{null!==c&&(c.unbindTransferFunctionTextures(),null!==i&&i.endDrawing(p,c))};m=!0;for(let n=0;n<y;++n){let s=k[n],o=D[n],l=s.chunkFormat;if(l!==i&&(i=l,t(),null!==(c=(r=this.shaderGetter({emitter:e.emitter,chunkFormat:l,wireFrame:e.wireFrame})).shader)&&void 0!==a&&(c.bind(),null!=l&&(ok(p,c,this.shaderControlState,r.parameters.parseResult.controls),this.bindDepthBufferTexture(e,c),this.setShaderUniforms(c,a),l.beginDrawing(p,c),l.beginSource(p,c)))),null===c)break;null!=l&&l.bindChunk(p,c,s.chunk,s.fixedPositionWithinChunk,s.chunkDisplayDimensionIndices,s.channelToChunkDimensionIndices,m),p.uniform3fv(c.uniform("uTranslation"),o.uTranslation),p.uniform3fv(c.uniform("uChunkDataSize"),o.uChunkDataSize),pE(p,1,1),m=!1}this.modeOverride.value=f2.OFF}if(this.vertexIdHelper.disable(),p.disable(WebGL2RenderingContext.CULL_FACE),x){let e=null,t=()=>{null!==e&&(e.unbindTransferFunctionTextures(),null!==i&&i.endDrawing(p,e))},r=(e,t)=>{let i=e.reduce((e,t)=>e*t,1);return Math.max(Math.round(Math.min(i/2,i/t*16384)/256),1)};i=null;let{dataType:n,dataHistogramSpecifications:s}=this,a=s.getFramebuffers(p),o=this.getDataHistogramCount();for(let e=0;e<o;++e)a[e].bind(256,1),p.clearColor(0,0,0,1),p.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let l=this.dataHistogramSpecifications.bounds.value;p.enable(WebGL2RenderingContext.BLEND),p.disable(WebGL2RenderingContext.DEPTH_TEST);let d=D.reduce((e,t)=>e+t.uChunkDataSize.reduce((e,t)=>e*t,1),0);for(let s=0;s<y;++s){m=!0;let u=k[s],c=D[s],h=u.chunkFormat;if(h!==i){if(i=h,t(),null!==(e=this.histogramShaderGetter({chunkFormat:h}).shader))null!=h&&(h.beginDrawing(p,e),h.beginSource(p,e)),e.bind();else break}if(null===e)break;p.uniform3fv(e.uniform("uChunkDataSize"),c.uChunkDataSize),null!=i&&i.bindChunk(p,e,u.chunk,u.fixedPositionWithinChunk,u.chunkDisplayDimensionIndices,u.channelToChunkDimensionIndices,m),this.histogramIndexBuffer.value.bindToVertexAttrib(e.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);let g=r(c.uChunkDataSize,d);for(let t=0;t<o;++t)a[t].bind(256,1),ng(e,`invlerpForHistogram${t}`,n,l[t]),p.uniform1i(e.uniform("uHistogramIndex"),t),p.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,256,g);m=!1}t()}(E||x)&&(()=>{let t=!f4(this.mode.value)&&!e.isContinuousCameraMotionInProgress;f4(this.mode.value)||t?(p.depthMask(!0),p.disable(WebGL2RenderingContext.BLEND),p.depthFunc(WebGL2RenderingContext.GREATER)):(p.depthMask(!1),p.enable(WebGL2RenderingContext.BLEND),p.depthFunc(WebGL2RenderingContext.LESS),e.bindVolumeRenderingBuffer())})()}bindDepthBufferTexture(e,t){let{gl:i}=this;if(void 0!==e.depthBufferTexture&&null!==e.depthBufferTexture){let r=t.textureUnit(f9);i.activeTexture(WebGL2RenderingContext.TEXTURE0+r),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e.depthBufferTexture)}else throw Error("Depth buffer texture ID for volume rendering is undefined or null")}setShaderUniforms(e,t){let{gl:i}=this;i.uniformMatrix4fv(e.uniform("uModelViewProjectionMatrix"),!1,t.uModelViewProjectionMatrix),i.uniformMatrix4fv(e.uniform("uInvModelViewProjectionMatrix"),!1,t.uInvModelViewProjectionMatrix),i.uniform1f(e.uniform("uNearLimitFraction"),t.uNearLimitFraction),i.uniform1f(e.uniform("uFarLimitFraction"),t.uFarLimitFraction),i.uniform1f(e.uniform("uGain"),t.uGain),i.uniform1ui(e.uniform("uPickId"),t.uPickId),i.uniform1i(e.uniform("uMaxSteps"),t.uMaxSteps),i.uniform3fv(e.uniform("uLowerClipBound"),t.uLowerClipBound),i.uniform3fv(e.uniform("uUpperClipBound"),t.uUpperClipBound),i.uniform1f(e.uniform("uBrightnessFactor"),t.uBrightnessFactor)}isReady(e,t){let i=t.state.sources.value;if(0===i.length)return!0;let r=!1;return f8(e.projectionParameters,this.localPosition.value,this.depthSamplesTarget.value,i[0],()=>{},e=>{let t=e.source.chunks.get(e.curPositionInChunks.join());(void 0===t||t.state!==it.GPU_MEMORY)&&(r=!0)}),!r}}i(6674);let ms=se.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}});class ma{id;element;nameContainer;nameElement;lowerElement;upperElement;constructor(e){this.id=e,this.element=document.createElement("div"),this.nameContainer=document.createElement("div"),this.nameElement=document.createElement("input"),this.lowerElement=document.createElement("div"),this.upperElement=document.createElement("div");let{element:t,nameContainer:i,nameElement:r,lowerElement:n,upperElement:s}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),i.classList.add("neuroglancer-channel-dimensions-widget-name-container"),r.classList.add("neuroglancer-channel-dimensions-widget-name"),i.appendChild(r),n.classList.add("neuroglancer-channel-dimensions-widget-lower"),s.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(i),t.appendChild(n),t.appendChild(s),i.draggable=!0,r.disabled=!0,r.spellcheck=!1,r.autocomplete="off",r.required=!0,r.placeholder=" ",i.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",i.addEventListener("dblclick",()=>{r.disabled=!1,r.focus(),r.select()}),r.addEventListener("focus",()=>{r.select()})}}class mo extends eh.gj{combiner;element;dimensionWidgets;curCoordinateSpace;dragSource;reorderDimensionTo(e,t){if(e===t)return;let{coordinateSpace:i}=this;i.value=t0(i.value,e,t)}coordinateSpace;constructor(e){super(),this.combiner=e,this.element=document.createElement("div"),this.dimensionWidgets=[],this.curCoordinateSpace=void 0,this.dragSource=void 0,this.coordinateSpace=e.combined;let{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");let i=this.registerCancellable((0,io.H)(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(i)),this.registerDisposer(new aM(t,ms)).allShortcutsAreGlobal=!0,this.registerDisposer(ss(t,"cancel",e=>{this.forceUpdateView();let{target:t}=e;t instanceof HTMLElement&&t.blur()})),this.updateView()}makeNewDimensionWidget(e){let t=new ma(e);return t.nameContainer.addEventListener("dragstart",e=>{this.dragSource=t,e.stopPropagation(),e.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",e=>{let{dragSource:i}=this;if(void 0===i||i===t)return;let{dimensionWidgets:r}=this,n=r.indexOf(i),s=r.indexOf(t);-1!==n&&-1!==s&&(e.preventDefault(),this.reorderDimensionTo(s,n))}),t.nameContainer.addEventListener("dragend",e=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",e=>{t.nameElement.disabled=!0;let{relatedTarget:i}=e;!this.dimensionWidgets.some(e=>e.nameElement===i)&&(this.updateNames()||this.forceUpdateView())}),t.nameElement.addEventListener("input",()=>{let{nameElement:e}=t;sb(e),this.updateNameValidity()}),ss(t.nameElement,"commit",()=>{this.updateNames()}),ss(t.nameElement,"tab-forward",e=>this.selectAdjacentField(e,t,1)),ss(t.nameElement,"tab-backward",e=>this.selectAdjacentField(e,t,-1)),t}selectAdjacentField(e,t,i){e.stopPropagation();let{dimensionWidgets:r}=this,n=r.indexOf(t);if(-1===n)return;let s=n+i;if(s<0||s>=r.length)return;let a=r[s];a.nameElement.disabled=!1,a.nameElement.focus(),e.preventDefault()}updateNames(){let{dimensionWidgets:e,coordinateSpace:t}=this,i=t.value,r=e.map(e=>e.nameElement.value);if(this.combiner.getRenameValidity(r).includes(!1))return!1;let n=i.names;if((0,H.cO)(n,r))return!1;let s=i.timestamps.map((e,t)=>n[t]===r[t]?e:Date.now()),a={...i,names:r,timestamps:s};return t.value=a,!0}updateNameValidity(){let{dimensionWidgets:e}=this,t=e.map(e=>e.nameElement.value),i=t.length,r=this.combiner.getRenameValidity(t);for(let t=0;t<i;++t)e[t].nameElement.dataset.isValid=!1===r[t]?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){let{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;let{element:t}=this,i=this.dimensionWidgets,r=this.dimensionWidgets=e.ids.map(e=>i.find(t=>t.id===e)||this.makeNewDimensionWidget(e));sS(t,(function*(){let{names:t,rank:i,bounds:n}=e;for(let e=0;e<i;++e){let i=r[e];i.nameElement.value=t[e],i.nameElement.dataset.isValid=void 0,sb(i.nameElement);let[s,a]=tD(n,e);i.lowerElement.textContent=s.toString(),i.upperElement.textContent=a.toString(),yield i.element}}).call(this))}}let ml="opacity",md="blend",mu="shader",mc="codeVisible",mh="shaderControls",mp="crossSectionRenderScale",mg="channelDimensions",mf="volumeRendering",mm="volumeRenderingGain",mv="volumeRenderingDepthSamples",my=gP(dE),[mb,mS]=mi();class mw extends my{opacity=pw(.5);blendMode=(function(e=0){return new nb.B(fY,e)})();codeVisible=new i3(!0);fragmentMain=(function(e=fQ){return rh(e)})();shaderError=rc();dataType=new J.SN(void 0);sliceViewRenderScaleHistogram=new lg;sliceViewRenderScaleTarget=lp(1);volumeRenderingGain=(function(e=1){return new J.TU(e,ef.jz)})(0);volumeRenderingChunkResolutionHistogram=new lg(mb);volumeRenderingDepthSamplesTarget=lp(64,2**mb,2**mS-1);channelCoordinateSpace=new tk;channelCoordinateSpaceCombiner=new tJ(this.channelCoordinateSpace,tz);channelSpace=this.registerDisposer((0,J.og)(e=>i5(()=>(function(e){let{rank:t}=e,{bounds:{lowerBounds:i,upperBounds:r}}=e;if(i.some(e=>0!==e))throw Error("Lower bounds of channel coordinate space must all be 0");if(r.some(e=>!Number.isInteger(e)||e<=0||e>=0x100000000))throw Error("Upper bounds of channel coordinate space must all be positive integers");let n=new Uint32Array(r),s=th(n),a=new Uint32Array(s*t);for(let e=0;e<s;++e){let i=e;for(let r=0;r<t;++r){let s=i%n[r];i=(i-s)/n[r],a[e*t+r]=s}}return{channelCoordinateSpace:e,shape:n,numChannels:s,coordinates:a}})(e)),this.channelCoordinateSpace));volumeRenderingMode=f3();shaderControlState=this.registerDisposer(new oE(this.fragmentMain,this.registerDisposer((0,J.mo)((e,t)=>void 0===e?null:{imageData:{dataType:e,channelRank:t.rank}},[this.dataType,this.channelCoordinateSpace],(e,t)=>JSON.stringify(e)===JSON.stringify(t))),this.channelCoordinateSpaceCombiner));markLoading(){let e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){let t=super.addCoordinateSpace(e),i=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),i()}}constructor(e){super(e),this.localCoordinateSpaceCombiner.includeDimensionPredicate=tU,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.codeVisible.changed.add(this.specificationChanged.dispatch),this.volumeRenderingGain.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRenderingMode.changed.add(this.specificationChanged.dispatch),this.volumeRenderingDepthSamplesTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new mE(this)}),this.tabs.default="rendering"}activateDataSubsources(e){let t;for(let i of e){if(this.addStaticAnnotations(i))continue;let{subsourceEntry:e}=i,{subsource:r}=e,{volume:n}=r;if(!(n instanceof pd)){i.deactivate("Not compatible with image layer");continue}if(t&&n.dataType!==t){i.deactivate(`Data type must be ${el[n.dataType].toLowerCase()}`);continue}t=n.dataType,i.activate(e=>{i.addRenderLayer(new f1(n,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:i.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));let t=e.registerDisposer(new mn({gain:this.volumeRenderingGain,multiscaleSource:n,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:i.getRenderLayerTransform(this.channelCoordinateSpace),depthSamplesTarget:this.volumeRenderingDepthSamplesTarget,chunkResolutionHistogram:this.volumeRenderingChunkResolutionHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace,mode:this.volumeRenderingMode}));e.registerDisposer(i.messages.addChild(t.messages)),e.registerDisposer((0,J.Uw)((e,i)=>{i!==f2.OFF&&e.registerDisposer(this.addRenderLayer(t.addRef()))},this.volumeRenderingMode)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[ml]),this.codeVisible.restoreState(e[mc]),(0,ef.Kh)(e,md,e=>this.blendMode.restoreState(e)),this.fragmentMain.restoreState(e[mu]),this.shaderControlState.restoreState(e[mh]),this.sliceViewRenderScaleTarget.restoreState(e[mp]),this.channelCoordinateSpace.restoreState(e[mg]),(0,ef.Kh)(e,mf,e=>{"boolean"==typeof e?this.volumeRenderingMode.value=e?f2.ON:f2.OFF:this.volumeRenderingMode.restoreState(e)}),(0,ef.Kh)(e,mm,e=>this.volumeRenderingGain.restoreState(e)),(0,ef.Kh)(e,mv,e=>this.volumeRenderingDepthSamplesTarget.restoreState(e))}toJSON(){let e=super.toJSON();return e[ml]=this.opacity.toJSON(),e[md]=this.blendMode.toJSON(),e[mc]=this.codeVisible.toJSON(),e[mu]=this.fragmentMain.toJSON(),e[mh]=this.shaderControlState.toJSON(),e[mp]=this.sliceViewRenderScaleTarget.toJSON(),e[mg]=this.channelCoordinateSpace.toJSON(),e[mf]=this.volumeRenderingMode.toJSON(),e[mm]=this.volumeRenderingGain.toJSON(),e[mv]=this.volumeRenderingDepthSamplesTarget.toJSON(),e}displayImageSelectionState(e,t){let{value:i}=e;if(null==i)return!1;let r=this.channelSpace.value;if(void 0!==r.error)return!1;let{numChannels:n,coordinates:s,channelCoordinateSpace:{names:a,rank:o}}=r,l=document.createElement("div");l.classList.add("neuroglancer-selection-details-value-grid");let d="[copy] 0fr ";0!==o&&(d+=`repeat(${o}, [dim] 0fr [coord] 0fr) `),d+="[value] 1fr",l.style.gridTemplateColumns=d;for(let e=0;e<n;++e){let t=0===o?i:i[e],r=null==t?"":t.toString(),n=aO({title:"Copy value",onClick:()=>{aI(r)}});l.appendChild(n);for(let t=0;t<o;++t){let i=document.createElement("div");i.classList.add("neuroglancer-selection-details-value-grid-dim"),i.textContent=a[t],l.appendChild(i);let r=document.createElement("div");r.classList.add("neuroglancer-selection-details-value-grid-coord"),r.textContent=s[e*o+t].toString(),l.appendChild(r)}let d=document.createElement("div");d.classList.add("neuroglancer-selection-details-value-grid-value"),d.textContent=r,l.appendChild(d)}return t.appendChild(l),!0}displaySelectionState(e,t,i){let r=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,i)&&(r=!0),r}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),f0(e,t)},initializeShader:e=>{let t=e.shader;ok(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}static type="image";static typeAbbreviation="img"}function mC(e){return new fo({shaderError:e.shaderError,fragmentMain:e.fragmentMain,shaderControlState:e.shaderControlState})}let mx=[{label:"Resolution (slice)",toolJson:mp,...uA(e=>({histogram:e.sliceViewRenderScaleHistogram,target:e.sliceViewRenderScaleTarget}))},{label:"Blending (slice)",toolJson:md,...uE(e=>e.blendMode)},{label:"Opacity (slice)",toolJson:ml,...uD(e=>({value:e.opacity}))},{label:"Volume rendering (experimental)",toolJson:mf,...uE(e=>e.volumeRenderingMode)},{label:"Gain (3D)",toolJson:mm,isValid:e=>(0,J.mo)(e=>e===f2.ON,[e.volumeRenderingMode]),...uD(e=>({value:e.volumeRenderingGain,options:{min:-10,max:10,step:.1}}))},{label:"Resolution (3D)",toolJson:mv,isValid:e=>(0,J.mo)(e=>e!==f2.OFF,[e.volumeRenderingMode]),...uA(e=>({histogram:e.volumeRenderingChunkResolutionHistogram,target:e.volumeRenderingDepthSamplesTarget}),class extends uP{unitOfTarget="samples";logScaleOrigin=1;getWheelMoveValue(e){return-e.deltaY}})}];for(let e of mx)uw(mw,e);class mE extends sE{layer;codeWidget;constructor(e){super(),this.layer=e;let{element:t}=this;for(let i of(this.codeWidget=this.registerDisposer(mC(this.layer)),t.classList.add("neuroglancer-image-dropdown"),mx))t.appendChild(uS(this,e,this.visibility,i));t.appendChild(fl(this.layer,this.codeWidget,mT,{title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"},"neuroglancer-image-dropdown-top-row")),t.appendChild(this.registerDisposer(new mo(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new fc(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}}class mT extends g8{layer;codeWidget;constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(mC(this.layer)),this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}function mk(e){return class extends e{sharedKvStoreContext;constructor(...e){super(...e);let t=e[1];this.sharedKvStoreContext=t.sharedKvStoreContext.addRef()}initializeCounterpart(e,t){let{sharedKvStoreContext:i}=this;t.sharedKvStoreContext=i.rpcId,super.initializeCounterpart(e,t)}}}dK(mw),z=pt.IMAGE,dH.set(z,mw),dZ(e=>{let{volume:t}=e;if(void 0!==t&&t.volumeType===pt.UNKNOWN)return{layerConstructor:mw,priority:-100}}),ff(mw,e=>({shaderControlState:e.shaderControlState,legendShaderOptions:e.getLegendShaderOptions()})),i(9760);var mD=i(8956);class mL extends eh.gj{gl;length;webglType;buffer;constructor(e){super(),this.gl=e,this.buffer=this.registerDisposer(new rm(e))}resize(e){let t;if(e<256){let i=t=new Uint8Array(e);for(let t=0;t<e;++t)i[t]=t;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){let i=t=new Uint16Array(e);for(let t=0;t<e;++t)i[t]=t;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{let i=t=new Uint32Array(e);for(let t=0;t<e;++t)i[t]=t;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(void 0===this.length||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){let i=e.attribute("aIndexRaw");i>=0&&(this.bindToVertexAttrib(i),0!==t&&this.gl.vertexAttribDivisor(i,t))}}function mI(e){e.addAttribute("highp uint","aIndexRaw"),e.addVertexCode(rJ),e.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}class mP{name;constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){let i=t.attribute(this.name);e.bindToVertexAttribI(i,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}}let mR=`void main() {
  emitGray();
}
`;class mA{shaderError=rc();fragmentMain=rh(mR);shaderControlState=new oE(this.fragmentMain)}function mM(e){return r6(e.dataType,e.numComponents)}let mN=[],mV=ci(new u0,el.FLOAT32,3);function mO(e){let t=new Set,i=[];for(let r of e){let e=r.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_"),n="",s=0;for(;t.has(e+n);)n=""+ ++s;i.push(e+n)}return i}class mF{attributeNames;attributeInfo;tempLightVec;textureAccessHelper;indexBufferHelper;constructor(e,t){this.attributeNames=e,this.attributeInfo=t,this.tempLightVec=new Float32Array(4),this.textureAccessHelper=new cs("vertexData"),this.indexBufferHelper=new mP("vertexIndex")}defineAttributeAccess(e,t){let{textureAccessHelper:i}=this;i.defineShader(e);let{attributeNames:r}=this,n=2+r.length;for(let e=mN.length;e<n;++e)mN[e]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${e}`);n=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",mN[n++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",mN[n++]),e.addVertexCode(i.getAccessor("readVertexPosition","uVertexAttributeSampler0",el.FLOAT32,3)),e.addVertexCode(i.getAccessor("readVertexNormal","uVertexAttributeSampler1",el.FLOAT32,3));let s=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((a,o)=>{e.addTextureSampler(`${ct(a.dataType)}sampler2D`,`uVertexAttributeSampler${n}`,mN[n]);let l=mM(a);e.addVarying(`highp ${l}`,`vCustom${o}`),e.addFragmentCode(`
#define ${r[o]} vCustom${o}
`),e.addVertexCode(i.getAccessor(`readAttribute${o}`,`uVertexAttributeSampler${n}`,a.dataType,a.numComponents)),s+=`vCustom${o} = readAttribute${o}(${t});
`,++n}),e.addVertexMain(s)}defineShader(e){e.require(mI),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(oZ),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,i){let{lightDirection:r,ambientLighting:n,directionalLighting:s,projectionParameters:a}=i,{viewProjectionMat:o}=a;e.uniformMatrix4fv(t.uniform("uProjection"),!1,o);let l=this.tempLightVec;Z.R3.scale(l,r,s),l[3]=n,e.uniform4fv(t.uniform("uLightDirection"),l)}setPickID(e,t,i){e.uniform1ui(t.uniform("uPickID"),i)}beginObject(e,t,i){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,i)}bindVertexData(e,t,i){let r=0,n=i=>{let n=WebGL2RenderingContext.TEXTURE0+t.textureUnit(mN[r]);e.activeTexture(n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),++r};n(i.vertexTexture),n(i.normalTexture);let{attributeNames:s}=this;i.vertexAttributeTextures.forEach((e,t)=>{void 0!==s[t]&&n(e)})}disableVertexData(e,t){let i=2,r=this.attributeInfo.length,{attributeNames:n}=this;for(let e=0;e<r;++e)void 0!==n[e]&&++i;for(let r=0;r<i;++r){let i=t.textureUnit(mN[r])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(i),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,i,r){r.ensure(i.numIndices).bind(t),this.bindVertexData(e,t,i.vertexData),this.indexBufferHelper.bind(i.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,i.numIndices)}endLayer(e,t){!function(e,t,i=!1){let r=t.attribute("aIndexRaw");r>=0&&(i&&e.vertexAttribDivisor(r,0),e.disableVertexAttribArray(r))}(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}}class mB{vertexPositions;vertexNormals;vertexTexture;normalTexture;vertexAttributes;vertexAttributeTextures;copyToGPU(e,t){let i=(t,i)=>{let r=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r),cr(e,i,t),r};this.vertexTexture=i(this.vertexPositions,mV),this.normalTexture=i(this.vertexNormals,mV),this.vertexAttributeTextures=this.vertexAttributes.map((e,r)=>i(e,t[r])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);let{vertexAttributeTextures:t}=this;for(let i of t)e.deleteTexture(i);t.length=0}}class m_ extends o9{indexBuffer;numIndices;indices;vertexData;constructor(e,t){super(e);let i=this.vertexData=new mB;i.vertexPositions=t.vertexPositions,i.vertexNormals=t.vertexNormals,i.vertexAttributes=t.vertexAttributes;let r=this.indices=t.indices;this.numIndices=r.length}copyToGPU(e){var t;super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=(t=this.indices,rm.fromData(e,t,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW))}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}}class mU extends ls(mk(ln),mD.J6){attributeTextureFormats=this.info.vertexAttributes.map(e=>ci(new u0,e.dataType,e.numComponents));get info(){return this.parameters.info}getChunk(e){return new m_(this,e)}}let m$=iZ(i$);class mz extends m${}class mG extends uW{source;displayState;transform;shaderManager;shaders;sharedObject;shaderGetter;countingBuffer;constructor(e,t,i){var r;super(),this.source=e,this.displayState=t,this.transform=i,this.shaders=new Map,this.sharedObject=this.registerDisposer(new mz),this.shaderManager=new mF(mO(e.info.vertexAttributes.map(e=>e.name)),e.info.vertexAttributes),this.shaderGetter=rg(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new J.SN(ox(oc(mR))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:e=>e.key,shaderError:this.displayState.shaderError,defineShader:(e,t)=>{if(0!==t.parseResult.errors.length)throw Error("Invalid UI control specification");op(t,e),this.shaderManager.defineShader(e),e.setFragmentMainFunction(rf(t.parseResult.code))}}),this.countingBuffer=this.registerDisposer((r=this.gl).memoize.get("IndexBuffer",()=>new mL(r))),this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(i.changed.add(this.redrawNeeded.dispatch));let{sharedObject:n}=this;n.visibility.add(this.visibility),n.RPC_TYPE_ID=mD.V4,n.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){let{shaders:e}=this;for(let t of e.values())null!==t&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return null!==this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)}get gl(){return this.source.gl}isReady(){let e=this.source.chunks.get(mD.Sk);return void 0!==e&&e.state===it.GPU_MEMORY}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;let i=i0(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===i)return;let r=this.source.chunks.get(mD.Sk);if(void 0===r||r.state!==it.GPU_MEMORY)return;let{shader:n,parameters:s}=this.shaderGetter(e.emitter);if(null===n)return;let{gl:a}=this,o=this.shaderManager;n.bind(),o.beginLayer(a,n,e),ok(a,n,this.displayState.shaderControlState,s.parseResult.controls);let{pickIDs:l}=e;o.beginObject(a,n,i),e.emitPickID&&o.setPickID(a,n,l.register(this,r.numIndices/3)),o.drawFragment(a,n,r,this.countingBuffer),o.endLayer(a,n)}transformPickedValue(e){let{pickedOffset:t}=e,i=this.source.chunks.get(mD.Sk);if(void 0===i)return;let r=3*t,{indices:n}=i;if(r>=n.length)return;let s=n[r],a=[],{attributeNames:o}=this.shaderManager;return i.vertexData.vertexAttributes.forEach((e,t)=>{let i=o[t];void 0!==i&&a.push(`${i}=${e[s].toPrecision(6)}`)}),a.join(", ")}}async function mj(e,t,i){let r=await e.chunkManager.memoize.getAsync({type:"single_mesh:getMeshInfo",url:t},i,async r=>await e.chunkManager.rpc.promiseInvoke(mD.Wl,{sharedKvStoreContext:e.rpcId,parameters:{meshSourceUrl:t}},{signal:r.signal,progressListener:i.progressListener}));return e.chunkManager.getChunkSource(mU,{sharedKvStoreContext:e,parameters:{meshSourceUrl:t,info:r}})}class mW{scheme;description;constructor(e,t){this.scheme=e,this.description=t}get singleFile(){return!0}async get(e){(0,l0.zY)(e.url);let t=await mj(e.registry.sharedKvStoreContext,`${e.url.scheme}://${e.kvStoreUrl}`,e),i=tw({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{canonicalUrl:`${e.kvStoreUrl}|${e.url.scheme}:`,modelTransform:tN(i),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}}let mq="shader",mH="shaderControls",mJ="codeVisible";class mK extends dE{managedLayer;displayState;codeVisible;vertexAttributes;constructor(e){super(e),this.managedLayer=e,this.displayState=new mA,this.codeVisible=new i3(!0),this.vertexAttributes=new J.SN(void 0),this.codeVisible.changed.add(this.specificationChanged.dispatch),this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new mQ(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.codeVisible.restoreState(e[mJ]),this.displayState.fragmentMain.restoreState(e[mq]),this.displayState.shaderControlState.restoreState(e[mH])}activateDataSubsources(e){let t=!1;for(let i of e){let{subsourceEntry:e}=i,{subsource:r}=e,{singleMesh:n}=r;if(void 0!==n){if(t){i.deactivate("Only one single-mesh source supported");continue}t=!0,i.activate(e=>{i.addRenderLayer(new mG(n,this.displayState,i.getRenderLayerTransform())),this.vertexAttributes.value=n.info.vertexAttributes,e.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}i.deactivate("Not compatible with image layer")}}toJSON(){let e=super.toJSON();return e[mq]=this.displayState.fragmentMain.toJSON(),e[mH]=this.displayState.shaderControlState.toJSON(),e[mJ]=this.codeVisible.toJSON(),e}static type="mesh";static typeAbbreviation="msh"}function mZ(e){return new fo({fragmentMain:e.displayState.fragmentMain,shaderError:e.displayState.shaderError,shaderControlState:e.displayState.shaderControlState})}class mY extends eh.gj{attributes;element;constructor(e){super(),this.attributes=e,this.element=document.createElement("div"),this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){let{element:e}=this,t=this.attributes.value;if(void 0===t){sv(e);return}let i=mO(t.map(e=>e.name)),r=t.length;for(let n=0;n<r;++n){let r=t[n],s=document.createElement("div");s.className="neuroglancer-single-mesh-attribute";let a=document.createElement("div");a.className="neuroglancer-single-mesh-attribute-type",a.textContent=mM(r);let o=document.createElement("div");if(o.className="neuroglancer-single-mesh-attribute-name",o.textContent=i[n],s.appendChild(a),s.appendChild(o),void 0!==r.min&&void 0!==r.max){let e=document.createElement("neuroglancer-single-mesh-attribute-minmax");e.className="neuroglancer-single-mesh-attribute-range",e.textContent=`[${r.min.toPrecision(6)}, ${r.max.toPrecision(6)}]`,s.appendChild(e)}e.appendChild(s)}}disposed(){sy(this.element)}}function mX(e){return new mY(e.vertexAttributes)}class mQ extends sE{layer;attributeWidget;codeWidget;constructor(e){super(),this.layer=e;let{element:t}=this;this.attributeWidget=this.registerDisposer(mX(e)),this.codeWidget=this.registerDisposer(mZ(e)),t.classList.add("neuroglancer-single-mesh-dropdown"),t.appendChild(fl(this.layer,this.codeWidget,m0,{title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"},"neuroglancer-single-mesh-dropdown-top-row")),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new fc(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}}class m0 extends g8{layer;attributeWidget;codeWidget;constructor(e){super(),this.layer=e,this.attributeWidget=this.registerDisposer(mX(e)),this.codeWidget=this.registerDisposer(mZ(e)),this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}dK(mK),dZ(e=>{if(void 0!==e.singleMesh)return{layerConstructor:mK,priority:2}}),ff(mK,e=>({shaderControlState:e.displayState.shaderControlState}));var m1=i(5898);function m2(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}class m3 extends i${provider;constructor(e,t){super(),this.provider=e,this.registerDisposer(e),this.initializeCounterpart(t)}get(e,t){return this.provider.get(e,t)}}m3=m2([ij(m1.yP)],m3),iB(m1.LD,function(e,t){return this.get(e.providerId).get(e.invalidCredentials,t).then(e=>({value:e}))});class m4 extends i${base;constructor(e,t){super(),this.base=e,this.initializeCounterpart(t)}getCredentialsProvider(e,t){return this.base.getCredentialsProvider(e,t)}}function m6(){return e=>class extends e{credentialsProvider;constructor(...e){super(...e);let t=e[1];this.credentialsProvider=t.credentialsProvider?.addRef()}initializeCounterpart(e,t){let{credentialsProvider:i}=this;t.credentialsProvider=function(e,t){if(void 0===t)return;let i=e.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:ri(t)},()=>new m3(t.addRef(),e.rpc)),r=i.addCounterpartRef();return i.dispose(),r}(this.chunkManager,i),super.initializeCounterpart(e,t)}static encodeOptions(t){let i=e.encodeOptions(t),{credentialsProvider:r}=t;return i.credentialsProvider=void 0===r?void 0:ri(r),i}}}m4=m2([ij(m1.Yn)],m4),iB(m1.Wd,async function(e,t){let i=this.get(e.managerId).base.getCredentialsProvider(e.key,e.parameters);return{value:await i.get(e.invalidCredentials,t)}});var m5=i(4406),m8=i(2258);let m9="boss";async function m7(e,t,i){return(0,m8.ru)(t,i).catch(r=>{if(500!==r.status&&401!==r.status&&403!==r.status&&504!==r.status)throw r;return(0,m5.q)(e,t,i,e=>{let t=new Headers(i.headers);return t.set("Authorization",`Bearer ${e}`),{...i,headers:t}},e=>{let{status:t}=e;if(403===t||401===t)return"refresh";throw e})})}var ve=i(5675);class vt extends ls(m6()(po),ve.Yz){}class vi extends ls(m6()(hu),ve.i6){}let vr=new Map;vr.set("image",pt.IMAGE),vr.set("annotation",pt.SEGMENTATION);let vn=new Set(["npz","jpeg"]),vs=Uint32Array.of(512,512,16);var va=((G=va||{})[G.NANOMETERS=0]="NANOMETERS",G[G.MICROMETERS=1]="MICROMETERS",G[G.MILLIMETERS=2]="MILLIMETERS",G[G.CENTIMETERS=3]="CENTIMETERS",G);function vo(e){let t;(0,ef.PT)(e);let i=(0,ef.uq)(e,"type",ef.ZE),r=!1;return"DOWNSAMPLED"===(0,ef.uq)(e,"downsample_status",ef.ZE)&&(r=!0),{channelType:i,description:(0,ef.uq)(e,"description",ef.ZE),volumeType:(void 0===(t=vr.get(i))&&(t=pt.UNKNOWN),t),dataType:(0,ef.uq)(e,"datatype",e=>(0,ef.CT)(e,el)),downsampled:r,scales:[],key:(0,ef.uq)(e,"name",ef.ZE),baseResolution:(0,ef.uq)(e,"base_resolution",ef.C$)}}class vl extends pd{baseUrl;credentialsProvider;experimentInfo;parameters;get dataType(){return this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}experiment;channel;meshPath;meshUrl;channelInfo;scales;coordinateFrame;encoding;window;get rank(){return 3}constructor(e,t,i,r,n,s){if(super(e),this.baseUrl=t,this.credentialsProvider=i,this.experimentInfo=r,this.parameters=s,this.meshPath=void 0,this.meshUrl=void 0,void 0===n){let e=Array.from(r.channels.keys());if(1!==e.length)throw Error(`Experiment contains multiple channels: ${JSON.stringify(e)}`);n=e[0]}let a=r.channels.get(n);if(void 0===a)throw Error(`Specified channel ${JSON.stringify(n)} is not one of the supported channels ${JSON.stringify(Array.from(r.channels.keys()))}`);if(this.channel=n,this.channelInfo=a,this.scales=a.scales,void 0===r.coordFrame)throw Error(`Specified experiment ${JSON.stringify(r.key)} does not have a valid coordinate frame`);this.coordinateFrame=r.coordFrame,!1===this.channelInfo.downsampled&&(this.scales=[a.scales[0]]),this.experiment=r.key;let o=(0,ef.kt)(s.window);if(void 0!==o){let e=Z.K4.create(),t=o.split(/,/);if(2===t.length)e[0]=(0,ef.jz)(t[0]),e[1]=(0,ef.jz)(t[1]);else if(1===t.length)e[0]=0,e[1]=(0,ef.jz)(t[1]);else throw Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(o)}`);if(this.window=e,this.window[0]===this.window[1])throw Error(`Invalid window. First element must be different from second: ${JSON.stringify(o)}.`)}let l=(0,ef.kt)(s.meshurl);void 0!==l&&(this.meshUrl=l);let d=(0,ef.kt)(s.encoding);if(void 0===d)d=this.dataType===el.UINT8?"jpeg":"npz";else if(!vn.has(d))throw Error(`Invalid encoding: ${JSON.stringify(d)}.`);this.encoding=d}getSources(e){let t=this.scales[0].downsampleFactors,{rank:i}=this;return(0,H.PK)(this.scales.map(r=>{let n=this.coordinateFrame.voxelOffsetBase,s=Z.R3.create();for(let e=0;e<3;++e)s[e]=Math.ceil(n[e]);let a=r.downsampleFactors,o=i+1,l=new Float32Array(o*o);l[l.length-1]=1;for(let e=0;e<3;++e){let r=a[e]/t[e];l[o*e+e]=r,l[o*i+e]=s[e]*r}4===i&&(l[3*o+3]=1);let d=r.imageSize;return pn({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:l,chunkDataSizes:[vs],baseVoxelOffset:s,upperVoxelBound:d,volumeSourceOptions:e}).map(e=>({chunkSource:this.chunkManager.getChunkSource(vt,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:r.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:l}))}))}getMeshSource(){return void 0!==this.meshUrl?this.chunkManager.getChunkSource(vi,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}}let vd=/^([^/?]+)\/([^/?]+)(?:\/([^/?]+))?(?:\?(.*))?$/;function vu(e,t,i,r,n,s){return e.memoize.getAsync({hostname:t,collection:n,experiment:r,type:"boss:getExperimentInfo"},s,s=>m7(i,`${t}/latest/collection/${n}/experiment/${r}/`,s).then(e=>e.json()).then(a=>((0,ef.PT)(a),Promise.all((0,ef.uq)(a,"channels",a=>(0,ef.m7)(a,a=>{var o,l,d,u,c,h,p;return o=e,l=t,d=i,u=r,c=n,h=a,p=s,o.memoize.getAsync({hostname:l,collection:c,experiment:u,channel:h,type:"boss:getChannelInfo"},p,e=>m7(d,`${l}/latest/collection/${c}/experiment/${u}/channel/${h}/`,e).then(e=>e.json()).then(vo))}))).then(r=>{let n=new Map;return r.forEach(e=>{n.set(e.key,e)}),function(e,t,i,r,n){let s=r.coordFrameKey;return e.memoize.getAsync({hostname:t,coordinateframe:s,experimentInfo:r,type:"boss:getCoordinateFrame"},n,e=>m7(i,`${t}/latest/coord/${s}/`,e).then(e=>e.json()).then(e=>(function(e,t){(0,ef.PT)(e);let i=(0,ef.uq)(e,"voxel_unit",e=>(0,ef.CT)(e,va)),r=function(e){switch(e){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}(i),n=new Float32Array(3),s=new Float64Array(3),a=new Float64Array(3),o=new Float64Array(3),l=["x","y","z"];for(let t=0;t<3;++t){let i=l[t];n[t]=(0,ef.uq)(e,`${i}_voxel_size`,ef.o7),s[t]=n[t]/r,a[t]=(0,ef.uq)(e,`${i}_start`,ef.C$),o[t]=(0,ef.uq)(e,`${i}_stop`,ef.C$)}return t.coordFrame={voxelSizeBaseInMeters:s,voxelSizeBaseInOriginalUnits:n,voxelOffsetBase:a,imageSizeBase:o,voxelUnit:i,names:l},t})(e,r)))}(e,t,i,{channels:n,scalingLevels:(0,ef.uq)(a,"num_hierarchy_levels",ef.C$),coordFrameKey:(0,ef.uq)(a,"coord_frame",ef.ZE),coordFrame:void 0,key:(0,ef.uq)(a,"name",ef.ZE),collection:(0,ef.uq)(a,"collection",ef.ZE)},s)}))))}let vc=/^((?:http|https):\/\/[^/?]+)\/(.*)$/,vh=[],vp=[],vg=new l3._E;function vf(e){vh.push(e)}function vm(e){vp.push(e)}vf(new class{get scheme(){return"boss"}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e,t){let i=function(e){let t=e.match(/^(?:https:\/\/[^.]+([^/]+))/);if(null===t)throw Error(`Unable to construct auth server hostname from base hostname ${e}.`);return`https://auth${t[1]}/auth`}(t);return e.getCredentialsProvider(m9,i)}get(e){let t=e.providerUrl.match(vc);if(null===t)throw Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);let i=this.getCredentialsProvider(e.registry.credentialsManager,e.providerUrl);return function(e,t,i,r,n){let s=r.match(vd);if(null===s)throw Error(`Invalid volume path ${JSON.stringify(r)}`);let a=s[1],o=s[2],l=s[3],d=(0,ef.Re)(s[4]||"");return e.memoize.getAsync({hostname:t,path:r,type:"boss:getVolume"},n,async r=>{let n=await vu(e,t,i,o,a,r),s=await e.memoize.getAsync({hostname:t,collection:a,experiment:n.key,channel:l,downsample:!0,type:"boss:getDownsampleInfoForChannel"},r,e=>m7(i,`${t}/latest/downsample/${a}/${n.key}/${l}`,e).then(e=>e.json())).then(e=>(function(e,t,i){let r=t.coordFrame;if(void 0===r)throw Error(`Missing coordinate frame information for experiment ${t.key}. A valid coordinate frame is required to retrieve downsampling information.`);let n=t.channels.get(i);if(void 0===n)throw Error(`Specified channel ${JSON.stringify(i)} is not one of the supported channels ${JSON.stringify(Array.from(t.channels.keys()))}`);return n.scales=function(e,t){(0,ef.PT)(e);let i=(0,ef.uq)(e,"voxel_size",e=>(0,ef.ZI)(e,ef.et)),r=(0,ef.uq)(e,"extent",e=>(0,ef.ZI)(e,ef.gV)),n=(0,ef.uq)(e,"num_hierarchy_levels",ef.C$),s=[];for(let e=0;e<n;e++){let n=String(e),a=i.get(n),o=r.get(n);if(void 0===a||void 0===o)throw Error(`Missing voxel_size/extent for resolution ${n}.`);let l=new Float32Array(3);for(let e=0;e<3;++e)l[e]=a[e]/t[e];s[e]={downsampleFactors:l,imageSize:o,key:n}}return s}(e,r.voxelSizeBaseInOriginalUnits),t.channels.set(i,n),t})(e,n,l)),u=new vl(e,t,i,s,l,d),c=s.coordFrame,h={lowerBounds:c.voxelOffsetBase,upperBounds:Float64Array.from(c.imageSizeBase,(e,t)=>c.voxelOffsetBase[t]+e)};return{modelTransform:tN(tw({rank:3,names:c.names,units:["m","m","m"],scales:c.voxelSizeBaseInMeters,boundingBoxes:[tP(h)]})),subsources:[{id:"default",default:!0,subsource:{volume:u}},{id:"bounds",default:!0,subsource:{staticAnnotations:e5(h)}}]}})}(e.registry.chunkManager,t[1],i,t[2],e)}async completeUrl(e){let t=e.providerUrl.match(vc);if(null===t)throw null;let i=t[1],r=this.getCredentialsProvider(e.registry.credentialsManager,t[1]),n=t[2],s=await function(e,t,i,r,n){var s;let a=r.match(/^(?:([^/]+)(?:\/?([^/]*)(?:\/?([^/]*)(?:\/?([^/]*)?))?)?)?$/);if(null===a||void 0===a[1])return Promise.reject(null);if(void 0===a[2]){let r=a[1]||"";return e.memoize.getAsync({hostname:t,type:"boss:getCollections"},n,e=>m7(i,`${t}/latest/collection/`,e).then(e=>e.json()).then(e=>(0,ef.uq)(e,"collections",e=>(0,ef.m7)(e,ef.ZE)))).then(e=>({offset:0,completions:lj(r,e,e=>e+"/",()=>void 0)}))}if(void 0===a[3]){let r=a[2]||"";return(s=a[1],e.memoize.getAsync({hostname:t,collection:s,type:"boss:getExperiments"},n,e=>m7(i,`${t}/latest/collection/${s}/experiment/`,e).then(e=>e.json()).then(e=>(0,ef.uq)(e,"experiments",e=>(0,ef.m7)(e,ef.ZE))))).then(e=>({offset:a[1].length+1,completions:lj(r,e,e=>e+"/",()=>void 0)}))}return vu(e,t,i,a[2],a[1],n).then(e=>{let t=lj(a[3],e.channels,e=>e[0],e=>`${e[1].channelType} (${el[e[1].dataType]})`);return{offset:a[1].length+a[2].length+2,completions:t}})}(e.registry.chunkManager,i,r,n,e);return lz(t[1].length+1,s)}});class vv extends eh.gj{}function vy(e){let t,i;return async(r,n)=>((void 0===i||void 0!==r&&t?.generation===r.generation)&&(t=void 0,i=(0,o5.E7)(async i=>t=await e(r,i))),i(n??{}))}function vb(e){let t=0;return vy((i,r)=>e(r).then(e=>({generation:++t,credentials:e})))}class vS{providers=new Map;topLevelManager=this;register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){let i=this.providers.get(e);if(void 0===i)throw Error(`No registered credentials provider: ${JSON.stringify(e)}`);return i(t,this.topLevelManager)}}class vw extends eh.gj{base;memoize;constructor(e){super(),this.base=e,this.memoize=new o5.O1}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}}class vC extends vw{constructor(){super(new vS),this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}}class vx extends vv{baseProvider;anonymousCredentials;anonymous;constructor(e,t){super(),this.baseProvider=e,this.anonymousCredentials=t,this.anonymous=!0,this.get=vy((e,t)=>this.anonymous&&void 0===e?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(e,t)))}get}let vE=new Map;function vT(e,t){vE.set(e,t)}function vk(e,t){let i;let{requestDescription:r="login"}=e,n=new s1(!0);return new Promise((s,a)=>{let o=(0,iD.z6)(t,e=>{i?.abort(e),i=void 0,n.dispose(),a(e)});function l(t=`${e.description} ${r} required.`,i=`Request ${r}.`){n.setText(t+"  ");let s=document.createElement("button");s.textContent=i,n.element.appendChild(s),s.addEventListener("click",()=>{d(!1)})}function d(t){i?.abort(),i=new AbortController,l(`Waiting for ${e.description} ${r}...`,"Retry"),e.get(i.signal,t).then(e=>{void 0!==i&&(i=void 0,n.dispose(),o?.[Symbol.dispose]()),s(e)},s=>{void 0!==i&&(i=void 0,n.setVisible(!0),n.setModal(!0),t?l():l(`${e.description} ${r} failed: ${s}.`,"Retry"))})}!0===e.supportsImmediate?d(!0):(l(),n.setVisible(!0),n.setModal(!0))})}class vD extends Error{constructor(){super("Authentication window was closed")}}function vL(e,t){window.addEventListener("beforeunload",()=>{e.close()},{signal:t.signal});let i=setInterval(()=>{e.closed&&t.abort(new vD)},1e3);t.signal.addEventListener("abort",()=>{try{e.close()}catch{}clearInterval(i)})}function vI(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(vI=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}async function vP(e,t){var r,n;let s;let a=(0,eV.c0)(),o=(0,eV.c0)(),l=(r={state:a,clientId:e.clientId,redirect_uri:new URL(i(2959),i.b).href,authServer:e.authServer,nonce:o},s=`${r.authServer}/realms/BOSS/protocol/openid-connect/auth?client_id=${encodeURIComponent(r.clientId)}&redirect_uri=${encodeURIComponent(r.redirect_uri)}&response_mode=fragment&response_type=code%20id_token%20token`,r.state&&(s+=`&state=${r.state}`),r.nonce&&(s+=`&nonce=${r.nonce}`),s),d=new AbortController;t=AbortSignal.any([d.signal,t]);try{let e=open(l);if(null===e)throw Error("Failed to create authentication popup window");return vL(e,d),await (0,iD.oi)((n=d.signal,new Promise((t,i)=>{window.addEventListener("message",r=>{if(r.origin===location.origin&&r.source===e)try{let e=(0,ef.PT)(JSON.parse(r.data));if("bossAuthCallback"!==(0,ef.uq)(e,"service",ef.ZE))throw Error("Unexpected service");if((0,ef.uq)(e,"state",ef.ZE)!==a)throw Error("invalid state");let i=(0,ef.uq)(e,"access_token",ef.ZE);t(i)}catch(e){i(Error(`Received unexpected authentication response: ${e.message}`)),console.error("Response received: ",r.data)}},{signal:n})})),t)}finally{d.abort()}}class vR extends vv{authServer;constructor(e){super(),this.authServer=e,this.get=vb(async e=>{let t={stack:[],error:void 0,hasError:!1};try{return function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(t,new iL.Vi(e.progressListener,{message:`Requesting Boss access token from ${this.authServer}`}),!1),await vk({description:"Boss",get:e=>vP({realm:"boss",clientId:"endpoint",authServer:this.authServer},e)},e.signal)}catch(e){t.error=e,t.hasError=!0}finally{vI(t)}})}get}vT(m9,e=>new vR(e));var vA=i(7399);let vM="google-brainmaps";function vN(e,t,i,r={}){return(0,vA.i)(t,`${e.serverUrl}${i}`,r)}var vV=i(3488);function vO(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0});return t}function vF(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(vF=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}class vB extends ls(m6()(po),vV.LV){}class v_ extends ls(m6()(hm),vV.f5){}class vU extends ls(m6()(hu),vV.i6){}class v$ extends ls(m6()(pe),vV.zT){}class vz extends ls(m6()(lA),vV.WM){}let vG=new Map;function vj(e){(0,ef.PT)(e);try{return{corner:(0,ef.uq)(e,"corner",e=>(0,ef.V3)(Z.R3.create(),e,ef.jz)),size:(0,ef.uq)(e,"size",e=>(0,ef.V3)(Z.R3.create(),e,ef.o7)),metadata:(0,ef.uq)(e,"metadata",ef.kt)}}catch(e){throw Error(`Failed to parse bounding box: ${e.message}`)}}vG.set("UINT8",el.UINT8),vG.set("FLOAT",el.FLOAT32),vG.set("UINT32",el.UINT32),vG.set("UINT64",el.UINT64);class vW{numChannels;dataType;voxelSize;upperVoxelBound;boundingBoxes;constructor(e){try{(0,ef.PT)(e),this.numChannels=(0,ef.uq)(e,"channelCount",ef.Sc),this.dataType=(0,ef.uq)(e,"channelType",e=>(0,ef.DY)(e,vG)),this.voxelSize=(0,ef.uq)(e,"pixelSize",e=>(0,ef.V3)(Z.R3.create(),e,ef.o7)),this.upperVoxelBound=(0,ef.uq)(e,"volumeSize",e=>(0,ef.V3)(Z.R3.create(),e,ef.Sc)),this.boundingBoxes=(0,ef.uq)(e,"boundingBox",e=>void 0===e?[]:(0,ef.m7)(e,vj))}catch(e){throw Error(`Failed to parse BrainMaps volume geometry: ${e.message}`)}}}function vq(e){return(0,ef.PT)(e),{name:(0,ef.uq)(e,"name",ef.ZE),type:(0,ef.uq)(e,"type",ef.ZE)}}let vH="([0-9]+)",vJ=RegExp(`^(.*)_${vH}x${vH}x${vH}_lod([0-9]+)_([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)$`);class vK{scales;numChannels;dataType;box;constructor(e){try{(0,ef.PT)(e);let t=this.scales=(0,ef.uq)(e,"geometry",e=>(0,ef.m7)(e,e=>new vW(e)));if(0===t.length)throw Error("Expected at least one scale.");let i=t[0],r=this.numChannels=i.numChannels,n=this.dataType=i.dataType;for(let e=1,i=t.length;e<i;++e){let i=t[e];if(i.dataType!==n)throw Error(`Scale ${e} has data type ${el[i.dataType]} but scale 0 has data type ${el[n]}.`);if(i.numChannels!==r)throw Error(`Scale ${e} has ${i.numChannels} channel(s) but scale 0 has ${r} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(i.upperVoxelBound)}}catch(e){throw Error(`Failed to parse BrainMaps multiscale volume specification: ${e.message}`)}}getModelSpace(e=!1){let t=this.scales[0],i=["x","y","z"],r=["m","m","m"],n=Array.from(t.voxelSize,e=>e/1e9),s=Array.from(t.upperVoxelBound);return e&&(i.push("c^"),r.push(""),n.push(1),[0,0,0].push(0),s.push(this.numChannels)),tw({names:i,units:r,scales:Float64Array.from(n),boundingBoxes:[tP({lowerBounds:new Float64Array(i.length),upperBounds:Float64Array.from(s)})]})}}class vZ extends pd{instance;credentialsProvider;volumeId;changeSpec;multiscaleVolumeInfo;volumeType;get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return 1!==this.multiscaleVolumeInfo.numChannels?4:3}encoding;jpegQuality;chunkLayoutPreference;constructor(e,t,i,r,n,s,a){super(e),this.instance=t,this.credentialsProvider=i,this.volumeId=r,this.changeSpec=n,this.multiscaleVolumeInfo=s,this.encoding=a.encoding,this.jpegQuality=a.jpegQuality,this.chunkLayoutPreference=a.chunkLayoutPreference;let o=pt.IMAGE;this.dataType===el.UINT64&&(o=pt.SEGMENTATION),this.volumeType=o}getSources(e){let t=vV.ke.RAW;(this.dataType===el.UINT64||this.dataType===el.UINT32)&&this.volumeType===pt.SEGMENTATION&&this.encoding!==vV.ke.RAW?t=vV.ke.COMPRESSED_SEGMENTATION:this.volumeType===pt.IMAGE&&this.dataType===el.UINT8&&1===this.multiscaleVolumeInfo.numChannels&&this.encoding!==vV.ke.RAW&&!0!==e.discreteValues&&(t=vV.ke.JPEG);let i=t===vV.ke.JPEG?this.jpegQuality:void 0,r=this.scales[0],{upperVoxelBound:n}=r,s=Z.R3.create(),{rank:a}=this;return(0,H.PK)(this.scales.map((o,l)=>{let d;Z.R3.divide(s,o.voxelSize,r.voxelSize);let u=o.upperVoxelBound,{numChannels:c}=o,h=new Float32Array((a+1)**2);h[(a+1)*a+a]=1;let p=new Float32Array(a);1!==c&&(u=Float32Array.of(...u,c),d=Uint32Array.of(1,1,1,c),h[(a+1)*3+3]=1,p[3]=c);for(let e=0;e<3;++e)h[(a+1)*e+e]=s[e],p[e]=n[e]/s[e];return pn({rank:a,minBlockSize:d,chunkToMultiscaleTransform:h,dataType:o.dataType,upperVoxelBound:u,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:Z.R3.fromValues(64,64,64)}).map(e=>({chunkSource:this.chunkManager.getChunkSource(vB,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:l,encoding:t,jpegQuality:i,instance:this.instance}}),chunkToMultiscaleTransform:h,upperClipBound:p}))}))}}function vY(e){try{return(0,ef.PT)(e),{id:(0,ef.uq)(e,"id",ef.ZE),label:(0,ef.uq)(e,"label",ef.ZE),description:(0,ef.uq)(e,"description",ef.kt)}}catch(e){throw Error(`Failed to parse project: ${e.message}`)}}function vX(e,t){try{return(0,ef.PT)(e),(0,ef.uq)(e,t,e=>void 0===e?[]:(0,ef.m7)(e,ef.ZE))}catch(e){throw Error(`Error parsing dataset list: ${e.message}`)}}let vQ=ls(m6()(lU),vV.Jb);class v0 extends vQ{credentialsProvider;constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t}),this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){let{upperVoxelBound:e}=this.parameters,t=oU({rank:3,chunkDataSize:e,upperVoxelBound:e}),i=Z._E.create();return[[{chunkSource:this.chunkManager.getChunkSource(vz,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:i,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:i}]]}}let v1=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}];function v2(e){return e.getCredentialsProvider(vM)}class v3{instance;scheme;constructor(e,t){this.instance=e,this.scheme=t}get description(){return this.instance.description}getMultiscaleInfo(e,t,i){return e.chunkManager.memoize.getAsync({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance},i,async i=>{let r=await vN(this.instance,v2(e.credentialsManager),`/v1beta2/volumes/${t}`,i);return new vK(await r.json())})}getMeshesInfo(e,t,i){return e.chunkManager.memoize.getAsync({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance},i,i=>vN(this.instance,v2(e.credentialsManager),`/v1beta2/objects/${t}/meshes`,i).then(e=>e.json()).then(e=>(function(e){try{return(0,ef.PT)(e),(0,ef.uq)(e,"meshes",e=>void 0===e?[]:(0,ef.m7)(e,vq))}catch(e){throw Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}})(e)))}get(e){let{volumeId:t,changeSpec:i,meshName:r,parameters:n}=function(e){let t;let i=e.match(/^([^:?/]+:[^:?/]+:[^:?/]+)(?::([^:?/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(null===i)throw Error(`Invalid Brain Maps volume key: ${JSON.stringify(e)}.`);void 0!==i[2]&&(t={changeStackId:i[2]});let r=(0,ef.Re)(i[4]||"");return{volumeId:i[1],changeSpec:t,meshName:i[3],parameters:r}}(e.providerUrl);(0,ef.PT)(n);let s=(0,ef.Kh)(n,"encoding",e=>(0,ef.CT)(e,vV.ke)),a=(0,ef.Kh)(n,"jpegQuality",e=>{let t=(0,ef.C$)(e);if(t<1||t>100)throw Error(`Expected integer in range [1, 100], but received: ${e}`);return t},70),o={encoding:s,chunkLayoutPreference:(0,ef.Kh)(n,"chunkLayout",e=>(0,ef.CT)(e,o_)),jpegQuality:a};return e.registry.chunkManager.memoize.getAsync({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:i,brainmapsOptions:o},e,async n=>{let s=v2(e.registry.credentialsManager),[a,l]=await Promise.all([this.getMultiscaleInfo(e.registry,t,n),this.getMeshesInfo(e.registry,t,n)]),d=new vZ(e.registry.chunkManager,this.instance,s,t,i,a,o),u={modelTransform:tN(a.getModelSpace(1!==a.numChannels)),subsources:[{id:void 0===r?"default":"volume",subsource:{volume:d},default:void 0===r}]},c=e5(a.box);a.scales[0].boundingBoxes.forEach((e,t)=>{c.add({type:eB.AXIS_ALIGNED_BOUNDING_BOX,description:e.metadata,pointA:e.corner,pointB:Z.R3.add(Z.R3.create(),e.corner,e.size),id:`boundingBox${t}`,properties:[]})}),u.subsources.push({id:"bounds",subsource:{staticAnnotations:c},default:!0});let h=function(e,t){let i=function(e,t){let i=new Map,r=e.scales[0],n=new Set;for(let e of t){if("TRIANGLES"!==e.type)continue;let t=e.name.match(vJ);if(null===t)continue;let s=t[1],a=i.get(s);void 0===a&&(a={key:s,chunkShape:Z.R3.create(),lods:[]},i.set(s,a));let o=parseInt(t[5]);if(void 0!==a.lods[o]){n.add(s);continue}let l=Z.R3.fromValues(parseInt(t[2],10),parseInt(t[3],10),parseInt(t[4],10)),d=new Uint32Array(3);for(let e=0;e<3;++e)d[e]=Math.ceil(r.upperVoxelBound[e]/l[e]);a.lods[o]={info:e,scale:parseFloat(t[6]),relativeBlockShape:l,gridShape:d}}let s=[];r:for(let e of i.values()){if(n.has(e.key))continue;let t=e.lods[0];if(void 0===t)continue;let i=t.relativeBlockShape;Z.R3.multiply(e.chunkShape,i,r.voxelSize);for(let t=1;t<e.lods.length;++t){let r=e.lods[t];if(void 0===r)continue r;let{relativeBlockShape:n}=r;for(let e=0;e<3;++e){let t=n[e],r=i[e];if(t<r||t%r!=0)continue r;n[e]=t/r}}i.fill(1),s.push(e)}return s}(e,t),r=[],n=e=>{!r.some(t=>t.name===e.name)&&r.push(e)},s=new Set;for(let e of i)for(let t of(n({multi:e,single:void 0,name:e.key,partOfMultiscale:!1}),e.lods))s.add(t.info);for(let e of t)n({single:e,multi:void 0,name:e.name,partOfMultiscale:s.has(e)});return r}(a,l),p=(n,o)=>{let l;let{single:d}=n;if(void 0!==d)l="TRIANGLES"===d.type?e.registry.chunkManager.getChunkSource(vU,{credentialsProvider:s,parameters:{instance:this.instance,volumeId:t,meshName:d.name,changeSpec:i}}):e.registry.chunkManager.getChunkSource(v$,{credentialsProvider:s,parameters:{instance:this.instance,volumeId:t,meshName:n.name,changeSpec:i}});else{let r=n.multi;l=e.registry.chunkManager.getChunkSource(v_,{credentialsProvider:s,format:{fragmentRelativeVertices:!1,vertexPositionFormat:uz.k_.float32},parameters:{instance:this.instance,volumeId:t,info:r,changeSpec:i}})}u.subsources.push({id:void 0===r?`/${n.name}`:"default",subsource:{mesh:l},subsourceToModelSubspaceTransform:function(e){let t=Z._E.create(),i=e.scales[0].voxelSize;for(let e=0;e<3;++e)t[5*e]=1/i[e];return t}(a),modelSubspaceDimensionIndices:[0,1,2],default:o})};if(void 0!==r){let e=h.find(e=>e.name===r);if(void 0===e)throw Error(`Mesh/skeleton source not found: ${JSON.stringify(e)}`);p(e,!0)}else{let e=!0;for(let t of h)t.partOfMultiscale||(p(t,e),e=!1)}return void 0!==i&&u.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.registry.chunkManager.getChunkSource(v0,{parameters:{volumeId:t,changestack:i.changeStackId,instance:this.instance,upperVoxelBound:a.scales[0].upperVoxelBound},credentialsProvider:s})}}),u})}getProjectList(e,t){return e.chunkManager.memoize.getAsync({instance:this.instance,type:"brainmaps:getProjectList"},t,async t=>{let i={stack:[],error:void 0,hasError:!1};try{vO(i,new iL.Vi(t.progressListener,{message:`Retrieving ${this.instance.description} project list`}),!1);let r=await vN(this.instance,v2(e.credentialsManager),"/v1beta2/projects",t);return function(e){try{return(0,ef.PT)(e),(0,ef.uq)(e,"project",e=>void 0===e?[]:(0,ef.m7)(e,vY))}catch(e){throw Error(`Error parsing project list: ${e.message}`)}}(await r.json())}catch(e){i.error=e,i.hasError=!0}finally{vF(i)}})}getDatasetList(e,t,i){return e.chunkManager.memoize.getAsync({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},i,async i=>{let r={stack:[],error:void 0,hasError:!1};try{vO(r,new iL.Vi(i.progressListener,{message:`Retrieving ${this.instance.description} dataset list for ${t}`}),!1);let n=await vN(this.instance,v2(e.credentialsManager),`/v1beta2/datasets?project_id=${t}`);return vX(await n.json(),"datasetIds")}catch(e){r.error=e,r.hasError=!0}finally{vF(r)}})}getVolumeList(e,t,i,r){return e.chunkManager.memoize.getAsync({instance:this.instance,type:`brainmaps:${t}:${i}:getVolumeList`},r,async r=>{let n={stack:[],error:void 0,hasError:!1};try{vO(n,new iL.Vi(r.progressListener,{message:`Retrieving ${this.instance.description} volume list for ${t}:${i}`}),!1);let s=await vN(this.instance,v2(e.credentialsManager),`/v1beta2/volumes?project_id=${t}&dataset_id=${i}`,r),a=vX(await s.json(),"volumeId"),o=t.length+i.length+2,l=[];for(let e of a)l.push(e.substring(o));return l}catch(e){n.error=e,n.hasError=!0}finally{vF(n)}})}getChangeStackList(e,t,i){return e.chunkManager.memoize.getAsync({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},i,async i=>{let r={stack:[],error:void 0,hasError:!1};try{var n;vO(r,new iL.Vi(i.progressListener,{message:`Retrieving ${this.instance.description} change stack list for ${t}`}),!1);let s=await vN(this.instance,v2(e.credentialsManager),`/v1beta2/changes/${t}/change_stacks`,i);return n=await s.json(),(0,ef.uq)(n,"changeStackId",e=>void 0===e?void 0:(0,ef.m7)(e,ef.ZE))}catch(e){r.error=e,r.hasError=!0}finally{vF(r)}})}async completeUrl(e){let{providerUrl:t}=e,i=t.match(/^([^:/?]*)(?::([^:/?]*)(?::([^:/?]*)(?::([^:/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(null===i)throw null;let[,r,n,s,a,o,l]=i;if(void 0!==l)return lz(t.length-l.length,await lq(l,v1));if(void 0!==o){let i=`${r}:${n}:${s}`,a=await this.getMeshesInfo(e.registry,i,e),l=[],d=new Set;for(let e of a)if(e.name.startsWith(o))switch(e.type){case"LINE_SEGMENTS":l.push({value:e.name,description:"Skeletons"});break;case"TRIANGLES":{l.push({value:e.name,description:"Mesh (single-resolution)"});let t=e.name.match(vJ);if(null!==t){let e=t[1];if(d.has(e))break;d.add(e),l.push({value:e,description:"Mesh (multi-resolution)"})}}}return l.sort((e,t)=>(0,s7.B)(e.value,t.value)),{offset:t.length-o.length,completions:l}}if(void 0!==a){let i=`${r}:${n}:${s}`,o=await this.getChangeStackList(e.registry,i,e);if(void 0===o)throw null;return{offset:t.length-a.length,completions:lG(a,o)}}if(void 0!==s)return{offset:t.length-s.length,completions:lG(s,await this.getVolumeList(e.registry,r,n,e))};if(void 0!==n){let i=await this.getDatasetList(e.registry,r,e);return{offset:t.length-n.length,completions:lG(n,i.map(e=>`${e}:`))}}return{offset:0,completions:lj(r,await this.getProjectList(e.registry,e),e=>`${e.id}:`,e=>e.label)}}}if(vf(new v3({description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"},"brainmaps")),"undefined"!=typeof NEUROGLANCER_BRAINMAPS_SERVERS)for(let[e,t]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))vf(new v3(t,`brainmaps-${e}`));function v4(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(v4=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}async function v6(e,t){let r=(0,eV.c0)(),n=function(e){let t=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${encodeURIComponent(e.clientId)}`,r=new URL(i(7984),i.b).href;t+=`&redirect_uri=${r}`;let n="token",{scopes:s}=e;return s.includes("email")&&s.includes("openid")&&(n="token%20id_token"),t+=`&response_type=${n}`,!0===e.includeGrantedScopes&&(t+="&include_granted_scopes=true"),t+=`&scope=${encodeURIComponent(s.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),void 0!==e.nonce&&(t+=`&nonce=${e.nonce}`),void 0!==e.authUser&&(t+=`&authuser=${e.authUser}`),t}({state:r,nonce:(0,eV.c0)(),clientId:e.clientId,scopes:e.scopes,approvalPrompt:e.approvalPrompt,loginHint:e.loginHint,immediate:e.immediate,authUser:e.authUser}),s=new AbortController;t=AbortSignal.any([s.signal,t]);try{var a,o;let i;if(e.immediate)i=function(e,t){let i=document.createElement("iframe");return i.src=e,i.style.display="none",i.addEventListener("load",()=>{null==i.contentDocument&&t.abort(Error("Immediate authentication failed"))},{signal:t.signal}),document.body.appendChild(i),t.signal.addEventListener("abort",()=>{sy(i)}),i.contentWindow}(n,s);else{let e=open(n);if(null===e)throw Error("Failed to create authentication popup window");vL(e,s),i=e}return await (0,iD.oi)((a=i,o=s.signal,new Promise((e,t)=>{window.addEventListener("message",i=>{if(i.origin===location.origin&&i.source===a)try{let t=(0,ef.PT)(i.data);if((0,ef.uq)(t,"state",ef.ZE)!==r)throw Error("invalid state");let n=(0,ef.uq)(t,"id_token",ef.ZE),s={accessToken:(0,ef.uq)(t,"access_token",ef.ZE),tokenType:(0,ef.uq)(t,"token_type",ef.ZE),expiresIn:(0,ef.uq)(t,"expires_in",ef.ZE),scope:(0,ef.uq)(t,"scope",ef.ZE),email:function(e){let t=e.split(".");try{if(3!==t.length)throw Error("Invalid JWT format");let e=atob(t[1]),i=JSON.parse(e);return(0,ef.PT)(i),(0,ef.uq)(i,"email",ef.ZE)}catch(e){throw Error(`Failed to decode id token: ${e.message}`)}}(n)};e(s)}catch(e){t(Error(`Received unexpected authentication response: ${e.message}`)),console.error("Response received: ",i.data)}},{signal:o})})),t)}finally{s.abort()}}class v5 extends vv{options;constructor(e){super(),this.options=e,this.get=vb(async e=>{let t={stack:[],error:void 0,hasError:!1};try{return function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(t,new iL.Vi(e.progressListener,{message:`Requesting ${this.options.description} OAuth2 access token`}),!1),await vk({description:this.options.description,supportsImmediate:!0,get:(e,t)=>v6({clientId:this.options.clientId,scopes:this.options.scopes,immediate:t,authUser:0},e)},e.signal)}catch(e){t.error=e,t.hasError=!0}finally{v4(t)}})}get}class v8 extends v5{constructor(e){super({clientId:e,scopes:["https://www.googleapis.com/auth/brainmaps","openid","email"],description:"Brain Maps"})}}vT(vM,()=>new v8("639403125587-4k5hgdfumtrvur8v48e3pr7oo91d765k.apps.googleusercontent.com"));var v9=i(7484);function v7(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(v7=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}class ye extends ls(mk(po),v9.j){}class yt extends pd{sharedKvStoreContext;info;get dataType(){return el.UINT8}get volumeType(){return pt.IMAGE}get rank(){return this.info.modelSpace.rank}url;constructor(e,t,i){super(e.chunkManager),this.sharedKvStoreContext=e,this.info=i,this.url=t.substring(0,t.lastIndexOf("."))+"_files"}getSources(e){let{rank:t}=this,i=[Uint32Array.of(this.info.tilesize,this.info.tilesize,3)];return(0,H.PK)(this.info.levels.map((r,n,s)=>{let a=1<<n,o=t+1,l=new Float32Array(o*o);l[l.length-1]=1;let{upperBounds:d}=this.info.modelSpace.boundingBoxes[0].box,u=new Float32Array(t);for(let e=0;e<2;++e)l[o*e+e]=a,u[e]=d[e]/a;return l[2*o+2]=1,u[2]=d[2],pn({rank:t,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:Float32Array.of(r.width,r.height,3),volumeType:this.volumeType,chunkDataSizes:i,volumeSourceOptions:e}).map(e=>({chunkSource:this.chunkManager.getChunkSource(ye,{sharedKvStoreContext:this.sharedKvStoreContext,spec:e,parameters:{url:`${this.url}/${s.length-1-n}/`,encoding:this.info.encoding,format:this.info.format,overlap:this.info.overlap,tilesize:this.info.tilesize}}),chunkToMultiscaleTransform:l,upperClipBound:u}))}))}}async function yi(e){let t=new TextDecoder().decode(e.prefix),i=new DOMParser().parseFromString(t,"text/xml");return"Image"===i.documentElement.tagName&&"http://schemas.microsoft.com/deepzoom/2009"===i.documentElement.namespaceURI?[{suffix:"deepzoom:",description:"Deep Zoom"}]:[]}let yr=new class{get scheme(){return"deepzoom"}get description(){return"Deep Zoom data source"}get(e){return(0,l0.zY)(e.url),e.registry.chunkManager.memoize.getAsync({type:"deepzoom:get",url:e.kvStoreUrl},e,async t=>{let i=await function(e,t,i){if(t.endsWith(".json")||t.includes(".json?"))throw Error("DZI-JSON: OpenSeadragon hack not supported yet.");return e.chunkManager.memoize.getAsync({type:"deepzoom:metadata",url:t},i,async i=>{let r={stack:[],error:void 0,hasError:!1};try{!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(r,new iL.Vi(i.progressListener,{message:`Reading Deep Zoom metadata from ${t}`}),!1);let{response:n}=await e.kvStoreContext.read(t,{...i,throwIfMissing:!0}),s=await n.text(),a=new DOMParser().parseFromString(s,"text/xml").documentElement,o=(0,ef.PT)(a.getElementsByTagName("Size").item(0));return{width:(0,ef.Sc)(o.getAttribute("Width")),height:(0,ef.Sc)(o.getAttribute("Height")),tilesize:(0,ef.Sc)((0,ef.ZE)(a.getAttribute("TileSize"))),overlap:(0,ef.C$)((0,ef.ZE)(a.getAttribute("Overlap"))),format:(0,ef.ZE)(a.getAttribute("Format"))}}catch(e){r.error=e,r.hasError=!0}finally{v7(r)}})}(e.registry.sharedKvStoreContext,e.kvStoreUrl,t);return function(e,t,i){let r=function(e){let{width:t,height:i,tilesize:r,overlap:n,format:s}=e,a=(0,ef.CT)(s,v9.W),o=[],l=t,d=i;for(;l>1||d>1;)o.push({width:l,height:d}),l=Math.ceil(l/2),d=Math.ceil(d/2);o.push({width:l,height:d});let u=Float64Array.of(1/1e9,1/1e9,1),c=new Float64Array(3);return{levels:o,modelSpace:tw({rank:3,names:["x","y","c^"],units:["m","m",""],scales:u,boundingBoxes:[tP({lowerBounds:c,upperBounds:Float64Array.of(t,i,3)})]}),overlap:n,tilesize:r,format:s,encoding:a}}(i),n=new yt(e,t,r),{modelSpace:s}=r,a=[{id:"default",default:!0,subsource:{volume:n}},{id:"bounds",default:!0,subsource:{staticAnnotations:e5(s.bounds)}}];return{modelTransform:tN(s),subsources:a,canonicalUrl:`${t}|deepzoom:`}}(e.registry.sharedKvStoreContext,e.kvStoreUrl,i)})}};vm(yr),vf(new l8(yr)),function(e){e.registerFileFormat({prefixLength:500,suffixLength:0,match:yi})}(vg);let yn="DVID";var ys=i(2600);function ya(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(ya=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}let yo=new Map;yo.set("uint8",el.UINT8),yo.set("uint32",el.UINT32),yo.set("uint64",el.UINT64);class yl{obj;get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}constructor(e){this.obj=e,(0,ef.PT)(e),(0,ef.uq)(e,"TypeName",ef.ZE)}}class yd{obj;name;base;lowerVoxelBound;upperVoxelBoundInclusive;voxelSize;blockSize;numLevels;constructor(e,t,i){this.obj=e,this.name=t,this.base=i}}class yu extends ls(m6()(po),ys.Yz){}class yc extends ls(m6()(pe),ys.zT){}class yh extends ls(m6()(hu),ys.i6){}class yp extends yd{encoding;dataType;meshSrc;skeletonSrc;constructor(e,t,i,r,n){super(e,t,i),this.encoding=r;let s=(0,ef.uq)(e,"Extended",ef.PT),a=(0,ef.uq)(s,"Values",e=>(0,ef.m7)(e,ef.PT));if(a.length<1)throw Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");this.numLevels=1;let o=new Set(n);if(r===ys.ke.COMPRESSED_SEGMENTATIONARRAY){let e=(0,ef.uq)(s,"MaxDownresLevel",ef.Sc);this.numLevels=e+1}else for(;o.has(t+"_"+this.numLevels.toString());)this.numLevels+=1;o.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",o.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=(0,ef.uq)(a[0],"DataType",e=>(0,ef.DY)(e,yo)),this.voxelSize=(0,ef.uq)(s,"VoxelSize",e=>(0,ef.Iw)(Z.R3.create(),e,ef.o7)),this.blockSize=(0,ef.uq)(s,"BlockSize",e=>(0,ef.Iw)(Z.R3.create(),e,ef.o7)),this.lowerVoxelBound=(0,ef.uq)(s,"MinPoint",e=>(0,ef._s)(Z.R3.create(),e)),this.upperVoxelBoundInclusive=(0,ef.uq)(s,"MaxPoint",e=>(0,ef._s)(Z.R3.create(),e))}get volumeType(){return this.encoding===ys.ke.COMPRESSED_SEGMENTATION||this.encoding===ys.ke.COMPRESSED_SEGMENTATIONARRAY?pt.SEGMENTATION:pt.IMAGE}getSources(e,t,i,r){let{encoding:n}=this,s=[];for(let a=0;a<this.numLevels;++a){let o=2**a,l=2**-a,d=Z.R3.create(),u=Z.R3.create();for(let e=0;e<3;++e){let t=Math.floor(this.lowerVoxelBound[e]*l);d[e]=t-t%64;let i=Math.ceil((this.upperVoxelBoundInclusive[e]+1)*l);u[e]=i,i%64!=0&&(u[e]+=64-i%64)}let c=t.dataInstanceKey;n!==ys.ke.COMPRESSED_SEGMENTATIONARRAY&&a>0&&(c+="_"+a.toString());let h={baseUrl:t.baseUrl,nodeKey:t.nodeKey,dataInstanceKey:c,dataScale:a.toString(),encoding:n},p=Z._E.create();for(let e=0;e<3;++e)p[5*e]=o,p[12+e]=d[e]*o;let g=pn({rank:3,chunkToMultiscaleTransform:p,dataType:this.dataType,baseVoxelOffset:d,upperVoxelBound:Z.R3.subtract(Z.R3.create(),u,d),volumeType:this.volumeType,volumeSourceOptions:i,compressedSegmentationBlockSize:n===ys.ke.COMPRESSED_SEGMENTATION||n===ys.ke.COMPRESSED_SEGMENTATIONARRAY?Z.R3.fromValues(8,8,8):void 0}).map(t=>({chunkSource:e.getChunkSource(yu,{spec:t,parameters:h,credentialsProvider:r}),chunkToMultiscaleTransform:p}));s.push(g)}return(0,H.PK)(s)}}class yg{alias;description;errors=[];dataInstances=new Map;uuid;vnodes=new Set;constructor(e){if(e instanceof yg){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}(0,ef.PT)(e),this.alias=(0,ef.uq)(e,"Alias",ef.ZE),this.description=(0,ef.uq)(e,"Description",ef.ZE);let t=(0,ef.uq)(e,"DataInstances",ef.PT),i=Object.keys(t);for(let e of i)try{this.dataInstances.set(e,function(e,t,i){(0,ef.PT)(e);let r=(0,ef.uq)(e,"Base",e=>new yl(e));switch(r.typeName){case"uint8blk":case"grayscale8":{let n=-1!==r.compressionName.indexOf("jpeg");return new yp(e,t,r,n?ys.ke.JPEG:ys.ke.RAW,i)}case"labels64":case"labelblk":return new yp(e,t,r,ys.ke.COMPRESSED_SEGMENTATION,i);case"labelarray":case"labelmap":return new yp(e,t,r,ys.ke.COMPRESSED_SEGMENTATIONARRAY,i);default:throw Error(`DVID data type ${JSON.stringify(r.typeName)} is not supported.`)}}(t[e],e,i))}catch(i){let t=`Failed to parse data instance ${JSON.stringify(e)}: ${i.message}`;console.log(t),this.errors.push(t)}let r=(0,ef.uq)(e,"DAG",ef.PT);for(let e of Object.keys((0,ef.uq)(r,"Nodes",ef.PT)))this.vnodes.add(e)}}class yf{repositories;constructor(e){this.repositories=function(e){try{let t=(0,ef.ZI)(e,e=>new yg(e)),i=new Map;for(let[e,r]of t)for(let t of(i.set(e,r),r.vnodes))if(t!==e){let e=new yg(r);i.set(t,e)}for(let[e,t]of i)t.uuid=e;return i}catch(e){throw Error(`Failed to parse DVID repositories info: ${e.message}`)}}(e)}getNode(e){let t=[];for(let i of this.repositories.keys())i.startsWith(e)&&t.push(i);if(1!==t.length)throw Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}}function ym(e,t,i,r){return e.memoize.getAsync({type:"dvid:getServerInfo",baseUrl:t},r,async e=>{let r={stack:[],error:void 0,hasError:!1};try{var n;!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(r,new iL.Vi(e.progressListener,{message:`Retrieving repository info for DVID server ${t}`}),!1);let s=await (n=`${t}/api/repos/info`,(0,m5.q)(i,n,e,(e,t)=>{let i={...t};return e.token&&(i.headers={...i.headers,Authorization:`Bearer ${e}`}),i},e=>{let{status:t}=e;if(403===t||401===t)return"refresh";throw e}));return new yf(await s.json())}catch(e){r.error=e,r.hasError=!0}finally{ya(r)}})}class yv extends pd{baseUrl;nodeKey;dataInstanceKey;info;credentialsProvider;get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}constructor(e,t,i,r,n,s){super(e),this.baseUrl=t,this.nodeKey=i,this.dataInstanceKey=r,this.info=n,this.credentialsProvider=s}getSources(e){return this.info.getSources(this.chunkManager,{baseUrl:this.baseUrl,nodeKey:this.nodeKey,dataInstanceKey:this.dataInstanceKey},e,this.credentialsProvider)}}let yy=/^((?:http|https):\/\/[^/]+)\/([^/]+)\/([^/]+)(\?.*)?$/;function yb(e){if(e.startsWith("https"))return e+"/api/server/token"}async function yS(e){let t=e.providerUrl.match(/^((?:http|https):\/\/[^/]+)\/([^?]*).*$/);if(null===t)throw null;let i=t[1],r=t[2],n=yb(i),s=await ym(e.registry.chunkManager,i,e.registry.credentialsManager.getCredentialsProvider(yn,{dvidServer:i,authServer:n}),e);return lz(i.length+1,function(e,t){let i=t.match(/^(?:([^/]+)(?:\/([^/]*))?)?$/);if(null===i)throw Error("Invalid DVID URL syntax.");if(void 0===i[2])return{offset:0,completions:lj(t,e.repositories.values(),e=>e.uuid+"/",e=>`${e.alias}: ${e.description}`)};let r=i[1],n=e.getNode(r);return lz(r.length+1,{offset:0,completions:lj(i[2],n.dataInstances.values(),e=>e.name,e=>`${e.base.typeName}`)})}(s,r))}function yw(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(yw=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}async function yC(e,t){let i=await (0,m8.ru)(e,{method:"GET",credentials:"include",signal:t});return{token:await i.text()}}vf(new class{get scheme(){return"dvid"}get description(){return"DVID"}get(e){return function(e){let t=function(e){let t=e.match(yy);if(null===t)throw Error(`Invalid DVID URL: ${JSON.stringify(e)}.`);let i={baseUrl:t[1],nodeKey:t[2],dataInstanceKey:t[3]},r=t[4];if(r&&r.length>1){let e=(0,ef.Re)(r.substring(1));e.user&&(i.user=e.user)}return i.authServer=yb(i.baseUrl),i}(e.providerUrl),{baseUrl:i,nodeKey:r,dataInstanceKey:n}=t;return e.registry.chunkManager.memoize.getAsync({type:"dvid:MultiscaleVolumeChunkSource",baseUrl:i,nodeKey:r,dataInstanceKey:n},e,async s=>{let a=e.registry.credentialsManager.getCredentialsProvider(yn,{dvidServer:t.baseUrl,authServer:t.authServer}),o=(await ym(e.registry.chunkManager,i,a,s)).getNode(r);if(void 0===o)throw Error(`Invalid node: ${JSON.stringify(r)}.`);let l=o.dataInstances.get(n);if(!(l instanceof yp))throw Error(`Invalid data instance ${n}.`);return function(e,t,i,r){let n=t.baseUrl,s=t.nodeKey,a=t.dataInstanceKey,o={lowerBounds:new Float64Array(i.lowerVoxelBound),upperBounds:Float64Array.from(i.upperVoxelBoundInclusive,e=>e+1)},l=tw({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(i.voxelSize,e=>e/1e9),boundingBoxes:[tP(o)]}),d=new yv(e.registry.chunkManager,n,s,a,i,r),u={modelTransform:tN(l),subsources:[{id:"default",subsource:{volume:d},default:!0}]};if(i.meshSrc){let n=Z._E.create();for(let e=0;e<3;++e)n[5*e]=1/i.voxelSize[e];u.subsources.push({id:"meshes",default:!0,subsource:{mesh:e.registry.chunkManager.getChunkSource(yh,{parameters:{...t,dataInstanceKey:i.meshSrc},credentialsProvider:r})},subsourceToModelSubspaceTransform:n})}return i.skeletonSrc&&u.subsources.push({id:"skeletons",default:!0,subsource:{mesh:e.registry.chunkManager.getChunkSource(yc,{parameters:{...t,dataInstanceKey:i.skeletonSrc},credentialsProvider:r})}}),u.subsources.push({id:"bounds",subsource:{staticAnnotations:e5(o)},default:!0}),u}(e,t,l,a)})}(e)}completeUrl(e){return yS(e)}});class yx extends vv{authServer;constructor(e){super(),this.authServer=e,this.get=vb(async e=>{let t={stack:[],error:void 0,hasError:!1};try{let{authServer:i}=this;if(!i)return{token:""};return function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(t,new iL.Vi(e.progressListener,{message:`Requesting DVID access token from ${i}`}),!1),await vk({description:`DVID server ${this.authServer}`,supportsImmediate:!0,get:async(e,t)=>{if(t)return await yC(i,e);let r=i.match(/^[^/]+\/\/[^/.]+\.([^/]+)/);if(r){let e=`https://flyemlogin.${r[1]}/login`;throw Error(`Please log into ${e} and then refresh the neurogalncer page to try again.
If you are unable to log into ${e}, please check your authorization server ${i} to make sure it is correct.`)}throw Error(`Please check your authorization server ${i} to make sure it is correct.`)}},e.signal)}catch(e){t.error=e,t.hasError=!0}finally{yw(t)}})}get}class yE extends vx{constructor(e,t){super(new yx(t),{})}}vT(yn,e=>new yE(e.dvidServer,e.authServer)),i(8611);var yT=i(3078);class yk{url;static RPC_ID="graphene/ChunkedGraphSource"}class yD{manifestUrl;fragmentUrl;lod;sharding;nBitsForLayerId;static RPC_ID="graphene/MeshSource"}async function yL(e){if(e.response){let t;return"application/json"===e.response.headers.get("content-type")?(await e.response.json()).message:await e.response.text()}}var yI=i(602);function yP(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(yP=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}class yR extends ls(mk(po),yI.Yz){}class yA extends ls(mk(hu),yI.i6){}class yM extends ls(mk(hm),yI.f5){}class yN extends ls(mk(pe),yI.zT){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}}class yV{key;encoding;resolution;voxelOffset;size;chunkSizes;compressedSegmentationBlockSize;sharding;hidden;constructor(e,t){(0,ef.PT)(e);let i=1===t?3:4,r=this.resolution=new Float64Array(i),n=this.voxelOffset=new Float32Array(i),s=this.size=new Float32Array(i);if(4===i&&(r[3]=1,s[3]=t),(0,ef.uq)(e,"resolution",e=>(0,ef.Iw)(r.subarray(0,3),e,ef.o7)),(0,ef.Kh)(e,"voxel_offset",e=>(0,ef.Iw)(n.subarray(0,3),e,ef.C$)),(0,ef.uq)(e,"size",e=>(0,ef.Iw)(s.subarray(0,3),e,ef.Sc)),this.chunkSizes=(0,ef.uq)(e,"chunk_sizes",e=>(0,ef.m7)(e,e=>{let r=new Uint32Array(i);return 4===i&&(r[3]=t),(0,ef.Iw)(r.subarray(0,3),e,ef.Sc),r})),0===this.chunkSizes.length)throw Error("No chunk sizes specified.");if(this.sharding=(0,ef.uq)(e,"sharding",yj),void 0!==this.sharding&&1!==this.chunkSizes.length)throw Error("Sharding requires a single chunk size per scale");(this.encoding=(0,ef.uq)(e,"encoding",e=>(0,ef.CT)(e,yI.ke)))===yI.ke.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=(0,ef.uq)(e,"compressed_segmentation_block_size",e=>(0,ef.Iw)(Z.R3.create(),e,ef.Sc))),this.key=(0,ef.uq)(e,"key",ef.ZE),this.hidden=(0,ef.uq)(e,"hidden",ef.ds)??!1}}function yO(e){(0,ef.PT)(e);let t=(0,ef.uq)(e,"data_type",e=>(0,ef.CT)(e,el)),i=(0,ef.uq)(e,"num_channels",ef.Sc),r=(0,ef.uq)(e,"type",e=>(0,ef.CT)(e,pt)),n=(0,ef.uq)(e,"mesh",ef.kt),s=(0,ef.uq)(e,"skeletons",ef.kt),a=(0,ef.uq)(e,"segment_properties",ef.kt),o=(0,ef.uq)(e,"scales",e=>(0,ef.m7)(e,e=>new yV(e,i)));if(0===o.length)throw Error("Expected at least one scale");let l=o[0],d=1===i?3:4,u=new Float64Array(d),c=new Float64Array(d),h=new Float64Array(d),p=["x","y","z"],g=["m","m","m"];for(let e=0;e<3;++e)u[e]=l.resolution[e]/1e9,c[e]=l.voxelOffset[e],h[e]=c[e]+l.size[e];return 4===d&&(u[3]=1,h[3]=i,p[3]="c^",g[3]=""),{dataType:t,volumeType:r,mesh:n,skeletons:s,segmentPropertyMap:a,scales:o,modelSpace:tw({rank:d,names:p,units:g,scales:u,boundingBoxes:[tP({lowerBounds:c,upperBounds:h})]})}}class yF extends pd{sharedKvStoreContext;url;info;get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}constructor(e,t,i){super(e.chunkManager),this.sharedKvStoreContext=e,this.url=t,this.info=i}getSources(e){let t=this.info.scales[0].resolution,{rank:i}=this;return(0,H.PK)(this.info.scales.filter(e=>!e.hidden).map(r=>{let{resolution:n}=r,s=i+1,a=new Float32Array(s*s);a[a.length-1]=1;let{lowerBounds:o,upperBounds:l}=this.info.modelSpace.boundingBoxes[0].box,d=new Float32Array(i),u=new Float32Array(i);for(let e=0;e<3;++e){let c=n[e]/t[e];a[s*e+e]=c;let h=r.voxelOffset[e];a[s*i+e]=h*c,d[e]=o[e]/c-h,u[e]=l[e]/c-h}return 4===i&&(a[3*s+3]=1,d[3]=o[3],u[3]=l[3]),pn({rank:i,dataType:this.dataType,chunkToMultiscaleTransform:a,upperVoxelBound:r.size,volumeType:this.volumeType,chunkDataSizes:r.chunkSizes,baseVoxelOffset:r.voxelOffset,compressedSegmentationBlockSize:r.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(e=>({chunkSource:this.chunkManager.getChunkSource(yR,{sharedKvStoreContext:this.sharedKvStoreContext,spec:e,parameters:{url:(0,l0.J8)(this.sharedKvStoreContext.kvStoreContext.resolveRelativePath(this.url,r.key)),encoding:r.encoding,sharding:r.sharding}}),chunkToMultiscaleTransform:a,lowerClipBound:d,upperClipBound:u}))}))}}let yB=ls(mk(lU),yI.Jb);class y_ extends ls(mk(lA),yI.WM){}class yU extends yB{metadata;constructor(e,t){let{parameters:i}=t;super(e,{rank:i.rank,relationships:i.relationships.map(e=>e.name),properties:i.properties,sharedKvStoreContext:t.sharedKvStoreContext,parameters:i}),this.readonly=!0,this.metadata=t.metadata}getSources(){return[this.metadata.spatialIndices.map(e=>{let{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(y_,{sharedKvStoreContext:this.sharedKvStoreContext,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}}function y$(e){return(0,ef.uq)(e,"transform",e=>{let t=Z._E.create();return void 0!==e&&(0,ef.Iw)(t.subarray(0,12),e,ef.jz),Z._E.transpose(t,t),t})}async function yz(e,t,i){let r=await yK(e,t,!1,i);return void 0===r?{metadata:void 0}:function(e){let t;(0,ef.PT)(e);let i=(0,ef.uq)(e,"@type",ef.ZE);if("neuroglancer_legacy_mesh"===i)t=void 0;else if("neuroglancer_multilod_draco"!==i)throw Error(`Unsupported mesh type: ${JSON.stringify(i)}`);else{let i=(0,ef.uq)(e,"lod_scale_multiplier",ef.o7),r=(0,ef.uq)(e,"vertex_quantization_bits",ef.Sc);t={lodScaleMultiplier:i,transform:y$(e),sharding:(0,ef.uq)(e,"sharding",yj),vertexQuantizationBits:r}}return{metadata:t,segmentPropertyMap:(0,ef.uq)(e,"segment_properties",ef.kt)}}(r)}function yG(e){return void 0===e?yI.qm.RAW:(0,ef.CT)(e,yI.qm)}function yj(e){if(void 0===e)return;(0,ef.PT)(e);let t=(0,ef.uq)(e,"@type",ef.ZE);if("neuroglancer_uint64_sharded_v1"!==t)throw Error(`Unsupported sharding format: ${JSON.stringify(t)}`);let i=(0,ef.uq)(e,"hash",e=>(0,ef.CT)(e,yI.wC)),r=(0,ef.uq)(e,"preshift_bits",ef.C$),n=(0,ef.uq)(e,"shard_bits",ef.C$),s=(0,ef.uq)(e,"minishard_bits",ef.C$);return{hash:i,preshiftBits:r,shardBits:n,minishardBits:s,minishardIndexEncoding:(0,ef.uq)(e,"minishard_index_encoding",yG),dataEncoding:(0,ef.uq)(e,"data_encoding",yG)}}async function yW(e,t,i){return function(e){(0,ef.PT)(e);let t=(0,ef.uq)(e,"@type",ef.ZE);if("neuroglancer_skeletons"!==t)throw Error(`Unsupported skeleton type: ${JSON.stringify(t)}`);let i=y$(e),r=new Map;return(0,ef.uq)(e,"vertex_attributes",e=>{void 0!==e&&(0,ef.m7)(e,e=>{(0,ef.PT)(e);let t=(0,ef.uq)(e,"id",ef.ZE);if(""===t)throw Error("vertex attribute id must not be empty");if(r.has(t))throw Error(`duplicate vertex attribute id ${JSON.stringify(t)}`);let i=(0,ef.uq)(e,"data_type",e=>(0,ef.CT)(e,el)),n=(0,ef.uq)(e,"num_components",ef.Sc);r.set(t,{dataType:i,numComponents:n})})}),{metadata:{transform:i,vertexAttributes:r,sharding:(0,ef.uq)(e,"sharding",yj)},segmentPropertyMap:(0,ef.uq)(e,"segment_properties",ef.kt)}}(await yK(e,t,!0,i))}function yq(){return tw({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function yH(e,t,i){let r;let{metadata:n,segmentPropertyMap:s}=await yz(e,t,i);if(void 0===n){var a;return{source:(a={url:t,lod:0},e.chunkManager.getChunkSource(yA,{parameters:a,sharedKvStoreContext:e})),transform:Z._E.create(),segmentPropertyMap:s}}let{vertexQuantizationBits:o}=n;if(10===o)r=uz.k_.uint10;else if(16===o)r=uz.k_.uint16;else throw Error(`Invalid vertex quantization bits: ${o}`);return{source:e.chunkManager.getChunkSource(yM,{sharedKvStoreContext:e,parameters:{url:t,metadata:n},format:{fragmentRelativeVertices:!0,vertexPositionFormat:r}}),transform:n.transform,segmentPropertyMap:s}}async function yJ(e,t,i){let{metadata:r,segmentPropertyMap:n}=await yW(e,t,i);return{source:e.chunkManager.getChunkSource(yN,{sharedKvStoreContext:e,parameters:{url:t,metadata:r}}),transform:r.transform,segmentPropertyMap:n}}function yK(e,t,i,r){return e.chunkManager.memoize.getAsync({type:"precomputed:metadata",url:t},r,async r=>{let n={stack:[],error:void 0,hasError:!1};try{let s=(0,l0.Yq)(t,"info");!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(n,new iL.Vi(r.progressListener,{message:`Reading neuroglancer_precomputed metadata from ${s}`}),!1);let a=await e.kvStoreContext.read(s,{...r,throwIfMissing:i});if(void 0===a)return;return await a.response.json()}catch(e){n.error=e,n.hasError=!0}finally{yP(n)}})}function yZ(e){let t=Z._E.create(),i=e.scales[0].resolution;for(let e=0;e<3;++e)t[5*e]=1/i[e];return t}async function yY(e,t,i,r){let n=yO(i),s=new yF(e,t,n),{modelSpace:a}=n,o=[{id:"default",default:!0,subsource:{volume:s}},{id:"bounds",default:!0,subsource:{staticAnnotations:e5(a.bounds)}}];if(void 0!==n.segmentPropertyMap){let i=(0,l0.J8)(e.kvStoreContext.resolveRelativePath(t,n.segmentPropertyMap)),s=y3(await yK(e,i,!0,r));o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:s}})}if(void 0!==n.mesh){let i=(0,l0.J8)(e.kvStoreContext.resolveRelativePath(t,n.mesh)),{source:s,transform:a}=await yH(e,i,r),l=yZ(n);Z._E.multiply(l,l,a),o.push({id:"mesh",default:!0,subsource:{mesh:s},subsourceToModelSubspaceTransform:l})}if(void 0!==n.skeletons){let i=(0,l0.J8)(e.kvStoreContext.resolveRelativePath(t,n.skeletons)),{source:s,transform:a}=await yJ(e,i,r),l=yZ(n);Z._E.multiply(l,l,a),o.push({id:"skeletons",default:!0,subsource:{mesh:s},subsourceToModelSubspaceTransform:l})}return{modelTransform:tN(a),subsources:o}}async function yX(e,t,i){let{source:r,transform:n,segmentPropertyMap:s}=await yJ(e,t,i),a=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:n}];if(void 0!==s){let r=(0,l0.J8)(e.kvStoreContext.resolveRelativePath(t,s)),n=y3(await yK(e,r,!0,i));a.push({id:"properties",default:!0,subsource:{segmentPropertyMap:n}})}return{modelTransform:tN(yq()),subsources:a}}function yQ(e,t,i){(0,ef.PT)(i);let r=(0,ef.uq)(i,"key",ef.ZE);return{url:(0,l0.J8)(e.resolveRelativePath(t,r)),sharding:(0,ef.uq)(i,"sharding",yj)}}class y0{url;coordinateSpace;parameters;spatialIndices;constructor(e,t,i){this.url=t,(0,ef.PT)(i);let r=(0,ef.uq)(i,"dimensions",tE),{rank:n}=r,s=(0,ef.uq)(i,"lower_bound",e=>(0,ef.Iw)(new Float64Array(n),e,ef.jz)),a=(0,ef.uq)(i,"upper_bound",e=>(0,ef.Iw)(new Float64Array(n),e,ef.jz));this.coordinateSpace=tw({rank:n,names:r.names,units:r.units,scales:r.scales,boundingBoxes:[tP({lowerBounds:s,upperBounds:a})]}),this.parameters={type:(0,ef.uq)(i,"annotation_type",e=>(0,ef.CT)(e,eB)),rank:n,relationships:(0,ef.uq)(i,"relationships",i=>(0,ef.m7)(i,i=>{let r=yQ(e,t,i),n=(0,ef.uq)(i,"id",ef.ZE);return{...r,name:n}})),properties:(0,ef.uq)(i,"properties",eZ),byId:(0,ef.uq)(i,"by_id",i=>yQ(e,t,i))},this.spatialIndices=(0,ef.uq)(i,"spatial",i=>(0,ef.m7)(i,i=>{let r=yQ(e,t,i),a=(0,ef.uq)(i,"grid_shape",e=>(0,ef.Iw)(new Float32Array(n),e,ef.Sc)),o=(0,ef.uq)(i,"chunk_size",e=>(0,ef.Iw)(new Float32Array(n),e,ef.o7)),l=(0,ef.uq)(i,"limit",ef.Sc),d=new Float32Array(n);for(let e=0;e<n;++e)d[e]=a[e]*o[e];let u=e9.XD(Float32Array,n+1);for(let e=0;e<n;++e)u[(n+1)*n+e]=s[e];let c={limit:l,chunkToMultiscaleTransform:u,...oU({rank:n,chunkDataSize:o,upperVoxelBound:d})};return c.upperChunkBound=a,{parameters:r,spec:c,limit:l}})),this.spatialIndices.reverse()}}async function y1(e,t,i){let{source:r,transform:n,segmentPropertyMap:s}=await yH(e,t,i),a=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:n}];if(void 0!==s){let r=(0,l0.J8)(e.kvStoreContext.resolveRelativePath(t,s)),n=y3(await yK(e,r,!0,i));a.push({id:"properties",default:!0,subsource:{segmentPropertyMap:n}})}return{modelTransform:tN(yq()),subsources:a}}function y2(e){(0,ef.PT)(e);let t=(0,ef.uq)(e,"ids",e=>{let t=(e=(0,ef.zE)(e)).length,i=new BigUint64Array(t);for(let r=0;r<t;++r)i[r]=(0,ef.tw)(e[r]);return i}),i=t.length;return function(e){let{ids:t}=e;if(function(e){for(let t=1,i=e.length;t<i;++t)if(e[t]<=e[0])return!1;return!0}(t))return e;let i=t.length,r=hS(i,i-1);for(let e=0;e<i;++e)r[e]=e;r.sort((e,i)=>(0,em._f)(t[e],t[i]));let n=new BigUint64Array(i);for(let e=0;e<i;++e){let i=r[e];n[e]=t[i]}return{ids:n,properties:e.properties.map(e=>{let{values:t}=e,n=new t.constructor(i);for(let e=0;e<i;++e)n[e]=t[r[e]];return{...e,values:n}})}}({ids:t,properties:(0,ef.uq)(e,"properties",e=>(0,ef.m7)(e,e=>{(0,ef.PT)(e);let t=(0,ef.uq)(e,"id",ef.ZE),r=(0,ef.Kh)(e,"description",ef.ZE),n=(0,ef.uq)(e,"type",e=>{if("label"!==e&&"description"!==e&&"string"!==e&&"tags"!==e&&"number"!==e)throw Error(`Invalid property type: ${JSON.stringify(e)}`);return e});if("tags"===n){let s=(0,ef.uq)(e,"tags",ef.zE),a=(0,ef.Kh)(e,"tag_descriptions",ef.zE);if(void 0===a)(a=Array(s.length)).fill("");else if(a.length!==s.length)throw Error(`Expected tag_descriptions to have length: ${s.length}`);return{id:t,description:r,type:n,tags:s,tagDescriptions:a,values:(0,ef.uq)(e,"values",e=>{if(!Array.isArray(e)||e.length!==i)throw Error(`Expected ${i} values, but received: ${e.length}`);return e.map(e=>String.fromCharCode(...e))})}}if("number"===n){let s=(0,ef.uq)(e,"data_type",e=>(0,ef.CT)(e,el));if(s===el.UINT64)throw Error("uint64 properties not supported");let a=(0,ef.uq)(e,"values",e=>{if(!Array.isArray(e)||e.length!==i)throw Error(`Expected ${i} values, but received: ${e.length}`);return ec[s].from(e)}),o=1/0,l=-1/0;for(let e=a.length-1;e>=0;--e){let t=a[e];t<o&&(o=t),t>l&&(l=t)}return{id:t,description:r,type:n,dataType:s,values:a,bounds:[o,l]}}return{id:t,description:r,type:n,values:(0,ef.uq)(e,"values",e=>{if((0,ef.zE)(e),e.length!==i)throw Error(`Expected ${i} values, but received: ${e.length}`);return e})}}))})}function y3(e){try{let t=(0,ef.uq)(e,"@type",ef.ZE);if("neuroglancer_segment_properties"!==t)throw Error(`Unsupported segment property map type: ${JSON.stringify(t)}`);let i=(0,ef.Kh)(e,"inline",y2);return new hw({inlineProperties:i})}catch(e){throw Error(`Error parsing segment property map: ${e.message}`)}}let y4=/^([^#]*)(?:#(.*))?$/;class y6{get scheme(){return"neuroglancer-precomputed"}get expectsDirectory(){return!0}get description(){return"Neuroglancer Precomputed data source"}get(e){let{authorityAndPath:t,query:i,fragment:r}=(0,l0.DY)(e.url.suffix);if(i)throw Error(`Invalid URL ${JSON.stringify(e.url.url)}: query parameters not supported`);if(t)throw Error(`Invalid URL ${JSON.stringify(e.url.url)}: non-empty path not supported`);let n=(0,ef.Re)(r??""),s=(0,l0.J8)(e.kvStoreUrl);return e.registry.chunkManager.memoize.getAsync({type:"precomputed:get",url:s,parameters:n},e,async t=>{let i;let{sharedKvStoreContext:r}=e.registry,a=await yK(r,s,"mesh"!==n.type,t),o=`${s}|${e.url.scheme}:`;(0,ef.PT)(a);let l=(0,ef.Kh)(a,"redirect",ef.ZE);if(void 0!==l)return{canonicalUrl:o,targetUrl:l};let d=(0,ef.Kh)(a,"@type",ef.ZE);switch(d){case"neuroglancer_skeletons":i=await yX(r,s,t);break;case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":i=await y1(r,s,t);break;case"neuroglancer_annotations_v1":i=function(e,t,i){let r=new y0(e.kvStoreContext,t,i);return{modelTransform:tN(r.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:e.chunkManager.getChunkSource(yU,{sharedKvStoreContext:e,metadata:r,parameters:r.parameters})}}]}}(r,s,a);break;case"neuroglancer_segment_properties":i={modelTransform:tN(tx),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:y3(a)}}]};break;case"neuroglancer_multiscale_volume":case void 0:i=await yY(r,s,a,t);break;default:throw Error(`Invalid type: ${JSON.stringify(d)}`)}return i.canonicalUrl=o,i})}}function y5(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(y5=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}function y8(e,t=0){let i=Z.vh.clone([...e]);return i[3]=t,i}let y9=Z.R3.fromValues(1,0,0),y7=Z.R3.fromValues(0,0,1),be=y8(y9,.5),bt=y8(y7,.5),bi=y8(y9,.25),br=y8(y7,.25),bn=Z.vh.fromValues(.5,.5,.5,.01),bs=BigInt(ee(be)),ba=BigInt(ee(bt)),bo=BigInt(ee(bn)),bl=Z.vh.fromValues(0,0,0,.5);class bd extends ls(mk(hu),yD){getFragmentKey(e,t){return function(e){if("~"===e.charAt(0)){let t=e.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}return{key:e,fragmentId:e}}(t)}}class bu{segmentationUrl;meshingUrl;supported_api_versions;constructor(e,t){let i=e.match(/^((?:middleauth\+)?https?:\/\/[.\w:\-/]+)\/segmentation\/(?:1\.0|table)\/([^/]+)\/?$/);if(null===i)throw Error(`Graph URL invalid: ${e}`);this.segmentationUrl=`${i[1]}/segmentation/api/v1/table/${i[2]}`,this.meshingUrl=`${i[1]}/meshing/api/v1/table/${i[2]}`;try{(0,ef.PT)(t),this.supported_api_versions=(0,ef.uq)(t,"supported_api_versions",e=>(0,ef.m7)(e,ef.Iq))}catch{this.supported_api_versions=[0]}if(!1===this.supported_api_versions.includes(1))throw Error(`This Neuroglancer branch requires Graph Server version 1, but the server only supports version(s) ${this.supported_api_versions}.`)}}class bc{chunkSize;nBitsForLayerId;constructor(e){(0,ef.PT)(e),this.chunkSize=(0,ef.uq)(e,"chunk_size",e=>(0,ef.Iw)(Z.R3.create(),e,ef.Sc)),this.nBitsForLayerId=(0,ef.Kh)(e,"n_bits_for_layer_id",ef.Sc,8)}}class bh extends yF{info;constructor(e,t){super(e,t.dataUrl,t),this.info=t}getChunkedGraphSource(){let{rank:e}=this,t=this.info.scales[0],i=function(e){let{rank:t,dataType:i}=e,{baseVoxelOffset:r=new Float32Array(t)}=e;return{...oU(e),baseVoxelOffset:r,dataType:i}}({rank:e,dataType:this.info.dataType,upperVoxelBound:t.size,chunkDataSize:Uint32Array.from(this.info.graph.chunkSize),baseVoxelOffset:t.voxelOffset}),r=e+1,n=new Float32Array(r*r);n[n.length-1]=1;let{lowerBounds:s,upperBounds:a}=this.info.modelSpace.boundingBoxes[0].box,o=new Float32Array(e),l=new Float32Array(e);for(let i=0;i<3;++i)n[r*i+i]=1,n[r*e+i]=t.voxelOffset[i],o[i]=s[i],l[i]=a[i];return{chunkSource:this.chunkManager.getChunkSource(bq,{spec:i,sharedKvStoreContext:this.sharedKvStoreContext,parameters:{url:`${this.info.app.segmentationUrl}/node`}}),chunkToMultiscaleTransform:n,lowerClipBound:o,upperClipBound:l}}}function bp(e){return(0,ef.uq)(e,"transform",e=>{let t=Z._E.create();return void 0!==e&&(0,ef.Iw)(t.subarray(0,12),e,ef.jz),Z._E.transpose(t,t),t})}async function bg(e,t,i){let r;try{r=await by(e,t,!1,i)}catch(e){if((0,m8.XD)(e))return{metadata:void 0};throw e}return function(e){let t;(0,ef.PT)(e);let i=(0,ef.uq)(e,"@type",ef.ZE);if("neuroglancer_legacy_mesh"===i){let i=(0,ef.uq)(e,"sharding",bm);t=void 0===i?void 0:{lodScaleMultiplier:0,transform:bp(e),sharding:i,vertexQuantizationBits:10}}else if("neuroglancer_multilod_draco"!==i)throw Error(`Unsupported mesh type: ${JSON.stringify(i)}`);else{let i=(0,ef.uq)(e,"lod_scale_multiplier",ef.o7),r=(0,ef.uq)(e,"vertex_quantization_bits",ef.Sc);t={lodScaleMultiplier:i,transform:bp(e),sharding:(0,ef.uq)(e,"sharding",bm),vertexQuantizationBits:r}}return{metadata:t,segmentPropertyMap:(0,ef.uq)(e,"segment_properties",ef.kt)}}(r)}function bf(e){return void 0===e?yI.qm.RAW:(0,ef.CT)(e,yI.qm)}function bm(e){if(void 0===e)return;(0,ef.PT)(e);let t=[];for(let i in e){let r=Number(i);t[r]=function(e){if(void 0===e)return;(0,ef.PT)(e);let t=(0,ef.uq)(e,"@type",ef.ZE);if("neuroglancer_uint64_sharded_v1"!==t)throw Error(`Unsupported sharding format: ${JSON.stringify(t)}`);let i=(0,ef.uq)(e,"hash",e=>(0,ef.CT)(e,yI.wC)),r=(0,ef.uq)(e,"preshift_bits",ef.C$),n=(0,ef.uq)(e,"shard_bits",ef.C$),s=(0,ef.uq)(e,"minishard_bits",ef.C$);return{hash:i,preshiftBits:r,shardBits:n,minishardBits:s,minishardIndexEncoding:(0,ef.uq)(e,"minishard_index_encoding",bf),dataEncoding:(0,ef.uq)(e,"data_encoding",bf)}}(e[r])}return t}async function bv(e,t,i,r,n){let{metadata:s,segmentPropertyMap:a}=await bg(e,i,n),o={manifestUrl:t,fragmentUrl:i,lod:0,sharding:s?.sharding,nBitsForLayerId:r},l=s?.transform||Z._E.create();return{source:e.chunkManager.getChunkSource(bd,{sharedKvStoreContext:e,parameters:o}),transform:l,segmentPropertyMap:a}}function by(e,t,i,r){return e.chunkManager.memoize.getAsync({type:"precomputed:metadata",url:t},r,async r=>{let n={stack:[],error:void 0,hasError:!1};try{let s=(0,l0.Yq)(t,"info");!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(n,new iL.Vi(r.progressListener,{message:`Reading graphene metadata from ${s}`}),!1);let a=await e.kvStoreContext.read(s,{...r,throwIfMissing:i});if(void 0===a)return;return await a.response.json()}catch(e){n.error=e,n.hasError=!0}finally{y5(n)}})}async function bb(e,t,i,r,n){let s=function(e,t){let i=yO(e),r=(0,ef.uq)(e,"data_dir",ef.ZE),n=(0,ef.uq)(e,"app",e=>new bu(t,e)),s=(0,ef.uq)(e,"graph",e=>new bc(e));return{...i,app:n,graph:s,dataUrl:r}}(i,t),a=new bh(e,s),o=new bB;n&&o.restoreState(n);let l=new bj(s,a,o),{modelSpace:d}=s,u=[{id:"default",default:!0,subsource:{volume:a}},{id:"graph",default:!0,subsource:{segmentationGraph:l}},{id:"bounds",default:!0,subsource:{staticAnnotations:e5(d.bounds)}}];if(void 0!==s.segmentPropertyMap){let i=(0,l0.J8)(e.kvStoreContext.resolveRelativePath(t,s.segmentPropertyMap)),n=y3(await by(e,i,!0,r));u.push({id:"properties",default:!0,subsource:{segmentPropertyMap:n}})}if(void 0!==s.mesh){let{source:t,transform:i}=await bv(e,s.app.meshingUrl,(0,l0.J8)(e.kvStoreContext.resolveRelativePath(s.dataUrl,s.mesh)),s.graph.nBitsForLayerId,r),n=function(e){let t=Z._E.create(),i=e.scales[0].resolution;for(let e=0;e<3;++e)t[5*e]=1/i[e];return t}(s);Z._E.multiply(n,n,i),u.push({id:"mesh",default:!0,subsource:{mesh:t},subsourceToModelSubspaceTransform:n})}return{modelTransform:tN(d),subsources:u,state:o}}function bS(e){for(let t of e.dataSources){let{loadState:e}=t;if(void 0!==e&&void 0===e.error){for(let t of e.subsources)if(t.enabled&&"graph"===t.subsourceEntry.id)return t}}}function bw(e,t,i,r){let{subsourceEntry:n}=t,s=new e4(t.loadedDataSource.transform,[],["associated segments"]),a=new oP;a.color.value.set(r),a.relationshipStates.set("associated segments",{segmentationState:new J.SN(e.displayState),showMatches:new i3(!1)});let o=new oR({localPosition:e.localPosition,transform:t.getRenderLayerTransform(),source:s,displayState:a,dataSource:t.loadedDataSource.layerDataSource,subsourceIndex:t.subsourceIndex,subsourceId:n.id,subsubsourceId:i,role:iY.ANNOTATION});return e.addAnnotationLayerState(o,t),o}function bC(e,t){return(0,ef.uq)(e,t,ef.tw)}function bx(e){let t=bC(e,bI);return{segmentId:t,rootId:bC(e,bP),position:(0,ef.uq)(e,bR,e=>(0,ef.ET)(e))}}let bE="error",bT="multicut",bk="focusSegment",bD="sinks",bL="sources",bI="segmentId",bP="rootId",bR="position",bA="merge",bM="merges",bN="autosubmit",bV="sink",bO="source",bF="mergedRoot";class bB{changed=new eO.K_;multicutState=new bU;mergeState=new b_;constructor(){this.multicutState.changed.add(()=>{this.changed.dispatch()}),this.mergeState.changed.add(()=>{this.changed.dispatch()})}reset(){this.multicutState.reset(),this.mergeState.reset()}toJSON(){return{[bT]:this.multicutState.toJSON(),[bA]:this.mergeState.toJSON()}}restoreState(e){(0,ef.Kh)(e,bT,e=>{this.multicutState.restoreState(e)}),(0,ef.Kh)(e,bA,e=>{this.mergeState.restoreState(e)})}}class b_ extends eh.gj{changed=new eO.K_;merges=new J.SN([]);autoSubmit=new i3(!1);constructor(){super(),this.registerDisposer(this.merges.changed.add(this.changed.dispatch))}reset(){this.merges.value=[],this.autoSubmit.reset()}toJSON(){let{merges:e,autoSubmit:t}=this,i=e=>({[bI]:e.segmentId.toString(),[bP]:e.rootId.toString(),[bR]:[...e.position]});return{[bM]:e.value.filter(e=>e.source).map(e=>{let t={id:e.id,locked:e.locked,[bV]:i(e.sink),[bO]:i(e.source)};return e.mergedRoot&&(t[bF]=e.mergedRoot.toString()),e.error&&(t[bE]=e.error),t}),[bN]:t.toJSON()}}restoreState(e){this.merges.value=(0,ef.uq)(e,bM,e=>(0,ef.m7)(e,e=>(function(e){let t=(0,ef.Kh)(e,bF,ef.tw),i=(0,ef.uq)(e,"id",ef.ZE),r=(0,ef.Kh)(e,bE,ef.ZE);return{id:i,locked:!1,sink:bx(e[bV]),source:bx(e[bO]),mergedRoot:t,error:r}})(e))),this.autoSubmit.restoreState((0,ef.Kh)(e,bN,ef.JG))}}class bU extends eh.gj{focusSegment;blueGroup;changed;sinks;sources;constructor(e=new J.TU(void 0,e=>e),t=new J.SN(!1)){super(),this.focusSegment=e,this.blueGroup=t,this.changed=new eO.K_,this.sinks=new J.GF,this.sources=new J.GF;let i=()=>{0===this.sinks.size&&0===this.sources.size&&(this.focusSegment.value=void 0)};this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(i)),this.registerDisposer(this.sources.changed.add(i)),this.registerDisposer(this.blueGroup.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(this.changed.dispatch)),this.registerDisposer(this.sources.changed.add(this.changed.dispatch))}reset(){this.focusSegment.value=void 0,this.blueGroup.value=!1,this.sinks.clear(),this.sources.clear()}toJSON(){let{focusSegment:e,sinks:t,sources:i}=this,r=e=>({[bI]:e.segmentId.toString(),[bP]:e.rootId.toString(),[bR]:[...e.position]});return{[bk]:e.toJSON()?.toString(),[bD]:[...t].map(r),[bL]:[...i].map(r)}}restoreState(e){let t=e=>(0,ef.m7)(e,e=>bx(e));(0,ef.Kh)(e,bk,e=>{this.focusSegment.restoreState((0,ef.tw)(e))});let i=(0,ef.uq)(e,bD,t),r=(0,ef.uq)(e,bL,t);for(let e of i)this.sinks.add(e);for(let e of r)this.sources.add(e)}swapGroup(){this.blueGroup.value=!this.blueGroup.value}get activeGroup(){return this.blueGroup.value?this.sources:this.sinks}get segments(){return[...this.redSegments,...this.blueSegments]}get redSegments(){return[...this.sinks].filter(e=>e.segmentId!==e.rootId).map(e=>e.segmentId)}get blueSegments(){return[...this.sources].filter(e=>e.segmentId!==e.rootId).map(e=>e.segmentId)}}class b$ extends hM{graph;layer;chunkSource;state;annotationLayerStates;mergeAnnotationState;constructor(e,t,i,r){super(e,t.displayState.segmentationGroupState.value),this.graph=e,this.layer=t,this.chunkSource=i,this.state=r,this.annotationLayerStates=[],this.lastDeselectionMessageExists=!1,this.deleteMergeSubmission=e=>{let{mergeAnnotationState:t}=this;e.locked=!1,t.source.delete(t.source.getReference(e.id))},this.submitMerge=async(e,t=1)=>{this.graph;let i=bS(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(e=>e/1e-9);e.error=void 0;for(let r=1;r<=t;r++)try{return await this.graph.graphServer.mergeSegments(e.sink,e.source,i)}catch(i){if(r===t)throw e.error=i.message||"unknown",i}return 0n};let n=t.displayState.segmentationGroupState.value;n.selectedSegments.changed.add((e,t)=>{null!==e&&(e="bigint"==typeof e?[e]:e),this.selectedSegmentsChanged(e,t)}),n.visibleSegments.changed.add((e,t)=>{null!==e&&(e="bigint"==typeof e?[e]:e),this.visibleSegmentsChanged(e,t)});let{annotationLayerStates:s,state:{multicutState:a}}=this,o=bS(t),l=bw(t,o,"sinks",y9),d=bw(t,o,"sources",y7);bY(a.sinks,l),bY(a.sources,d),s.push(l,d),t.tool.value instanceof b3&&(t.tool.value=void 0),this.mergeAnnotationState=bw(t,o,"grapheneMerge",y9);{let{mergeState:e}=r,{merges:i,autoSubmit:s}=e,{mergeAnnotationState:a}=this,{visibleSegments:o}=n;for(let e of i.value)a.source.add(function(e){let{sink:t,source:i}=e;return{id:e.id,type:eB.LINE,pointA:t.position.slice(),pointB:i.position.slice(),relatedSegments:[BigUint64Array.of(t.rootId,t.segmentId,i.rootId,i.segmentId)],properties:[]}}(e));a.source.childAdded.add(e=>{!1===Array.from(e.relatedSegments[0],e=>o.has(e))[0]?(setTimeout(()=>{let{tool:e}=t;e.value instanceof b3&&e.value.deactivate()},0),s1.showTemporaryMessage("Cannot merge a hidden segment.")):i.value.length<b6?i.value=[...i.value,b4(e,!0)]:(setTimeout(()=>{let{tool:e}=t;e.value instanceof b3&&e.value.deactivate()},0),s1.showTemporaryMessage(`Maximum of ${b6} simultanous merges allowed.`))}),a.source.childCommitted.add(e=>{let t=a.source.getReference(e),r=t.value;if(r){let e=r.relatedSegments[0],n=Array.from(e,e=>o.has(e));e.length<4&&(a.source.delete(t),s1.showTemporaryMessage("Cannot merge segment with itself.")),!1===n[2]&&(a.source.delete(t),s1.showTemporaryMessage("Cannot merge a hidden segment."));let l=i.value.find(e=>e.id===t.id);if(l&&!l?.locked){let e=b4(r,!1);l.sink=e.sink,l.source=e.source,i.changed.dispatch(),s.value&&this.bulkMerge([l])}}t.dispose()}),a.source.childDeleted.add(e=>{let t=!1,r=i.value.filter(i=>{let r=i.id!==e||i.locked;return r||(t=!0),r});t&&(i.value=r)})}}createRenderLayers(e,t,i){return[new bH(e,this.chunkSource.getChunkedGraphSource(),t,i,this.graph.info.graph.nBitsForLayerId)]}lastDeselectionMessage;lastDeselectionMessageExists;visibleSegmentsChanged(e,t){let{segmentsState:i}=this,{focusSegment:{value:r}}=this.graph.state.multicutState;if(r&&!i.visibleSegments.has(r)&&(i.selectedSegments.has(r)?s1.showTemporaryMessage("Can't hide active multicut segment.",3e3):s1.showTemporaryMessage("Can't deselect active multicut segment.",3e3),i.selectedSegments.add(r),i.visibleSegments.add(r),e&&(e=e.filter(e=>e!==r))),null===e){let e=this.segmentsState.selectedSegments.size;this.segmentsState.segmentEquivalences.clear(),s1.showTemporaryMessage(`Hid all ${e} segments.`,3e3);return}for(let r of e)if(!t){let e=[...i.segmentEquivalences.setElements(r)].length;i.segmentEquivalences.deleteSet(r),this.lastDeselectionMessage&&this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1),this.lastDeselectionMessage=s1.showMessage(`Hid ${e} segments.`),this.lastDeselectionMessageExists=!0,setTimeout(()=>{this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1)},2e3)}}selectedSegmentsChanged(e,t){let{segmentsState:i}=this;if(null===e){let e=this.segmentsState.selectedSegments.size;s1.showTemporaryMessage(`Deselected all ${e} segments.`,3e3);return}for(let r of e){let e=1n==r>>BigInt(64-this.graph.info.graph.nBitsForLayerId);t&&e&&this.graph.getRoot(r).then(e=>{i.visibleSegments.has(r)&&i.visibleSegments.add(e),i.selectedSegments.delete(r),i.selectedSegments.add(e)})}}computeSplit(e,t){}getMeshSource(){let{layer:e}=this;for(let t of e.dataSources){let{loadState:e}=t;if(e instanceof di){let{subsources:t}=e.dataSource,i=t.filter(e=>"graph"===e.id)[0];if(i?.subsource.segmentationGraph&&i.subsource.segmentationGraph!==this.graph)continue;let r=t.filter(e=>"mesh"===e.id)[0];if(r)return r.subsource.mesh}}}meshAddNewSegments(e){let t=this.getMeshSource();if(t)for(let i of e)t.rpc.invoke("GrapheneMeshSource:NewSegment",{rpcId:t.rpcId,segment:i})}async submitMulticut(e){let{state:{multicutState:t}}=this,{sinks:i,sources:r}=t;if(0===i.size||0===r.size)return s1.showTemporaryMessage("Must select both red and blue groups to perform a multi-cut.",7e3),!1;let n=await this.graph.graphServer.splitSegments([...i],[...r],e);if(0===n.length)return s1.showTemporaryMessage("No split found.",3e3),!1;let s=t.focusSegment.value;t.reset();let{segmentsState:a}=this;for(let e of(a.selectedSegments.delete(s),[...i,...r]))a.selectedSegments.delete(e.rootId);return this.meshAddNewSegments(n),a.selectedSegments.add(n),a.visibleSegments.add(n),!0}deleteMergeSubmission;submitMerge;async bulkMerge(e){let t;let{merges:i}=this.state.mergeState;e=e.filter(e=>!e.locked&&e.source);let r=await (t=e,new Promise(e=>{if(0===t.length){e([]);return}let r=[],n=(e,i)=>{for(let n of(r.push(e),t))n.source&&n.source.rootId===e&&(n.source.rootId=i),n.sink.rootId===e&&(n.sink.rootId=i)},s=0,a=0,o=(l,d)=>{if(s===t.length||0===d.length)return;a++;let u=[],c=()=>{++h===d.length&&(a-=1),0===a&&e(r)},h=0;for(let e of d)e.locked=!0,e.status="trying...",i.changed.dispatch(),this.submitMerge(e,3).then(t=>{n(e.source.rootId,t),n(e.sink.rootId,t),e.status="done",e.mergedRoot=t,i.changed.dispatch(),o(s+=1,u),u=[],c(),b2(5e3).then(()=>{this.deleteMergeSubmission(e)})}).catch(()=>{i.changed.dispatch(),u.push(e),s>l&&(o(s,u),u=[]),c()})};o(s,t)})),n=[];for(let t of e)t.error?(t.locked=!1,t.status=t.error):t.mergedRoot&&n.push(t.mergedRoot);let s=await this.graph.graphServer.filterLatestRoots(n),{visibleSegments:a,selectedSegments:o}=this.layer.displayState.segmentationGroupState.value;o.delete(r),this.meshAddNewSegments(s),o.add(s),a.add(s),i.changed.dispatch()}}async function bz(e,t){let i;let r=()=>{};t.initialMessage&&((i=new s1(!0)).setText(t.initialMessage),r=i.dispose.bind(i));try{let t=await e;return r(),t}catch(e){if(e instanceof m8.oo&&e.response){let{errorPrefix:r=""}=t,n=await yL(e);if(n)throw i||(i=new s1(!0)),i.setErrorMessage(r+n),i.setVisible(!0),Error(`[${e.response.status}] ${r}${n}`)}throw e}}Symbol("Graph Server Not Specified.");class bG{httpSource;constructor(e,t){this.httpSource=function(e,t){let{store:i,path:r}=e.getKvStore(t);if(!(i instanceof yT.Z))throw Error(`Non-HTTP URL ${JSON.stringify(t)} not supported`);let{fetchOkImpl:n,baseUrl:s}=i;if(s.includes("?"))throw Error(`Invalid URL ${s}: query parameters not supported`);return{fetchOkImpl:n,baseUrl:(0,l0.Lj)(s,r)}}(e.kvStoreContext,t)}async getRoot(e,t=""){let i=new Date(t).valueOf()/1e3,{fetchOkImpl:r,baseUrl:n}=this.httpSource,s=await bz(r(`${n}/node/${String(e)}/root?int64_as_str=1${Number.isNaN(i)?"":`&timestamp=${i}`}`,{}).then(e=>e.json()),{initialMessage:`Retrieving root for segment ${e}`,errorPrefix:"Could not fetch root: "});return(0,ef.tw)(s.root_id)}async mergeSegments(e,t,i){let{fetchOkImpl:r,baseUrl:n}=this.httpSource,s=r(`${n}/merge?int64_as_str=1`,{method:"POST",body:JSON.stringify([[String(e.segmentId),...e.position.map((e,t)=>e*i[t])],[String(t.segmentId),...t.position.map((e,t)=>e*i[t])]])});try{let e=await s,t=await e.json();return(0,ef.tw)(t.new_root_ids[0])}catch(e){if(e instanceof m8.oo)throw Error(await yL(e));throw e}}async splitSegments(e,t,i){let{fetchOkImpl:r,baseUrl:n}=this.httpSource,s=r(`${n}/split?int64_as_str=1`,{method:"POST",body:JSON.stringify({sources:e.map(e=>[String(e.segmentId),...e.position.map((e,t)=>e*i[t])]),sinks:t.map(e=>[String(e.segmentId),...e.position.map((e,t)=>e*i[t])])})}),a=await bz(s,{initialMessage:`Splitting ${e.length} sources from ${t.length} sinks`,errorPrefix:"Split failed: "}),o=await a.json(),l=Array(o.new_root_ids.length);for(let e=0;e<l.length;++e)l[e]=(0,ef.tw)(o.new_root_ids[e]);return l}async filterLatestRoots(e){let{fetchOkImpl:t,baseUrl:i}=this.httpSource,r=t(`${i}/is_latest_roots`,{method:"POST",body:JSON.stringify({node_ids:e.map(e=>e.toString())})}),n=await bz(r.then(e=>e.json()),{errorPrefix:"Could not check latest: "}),s=[];for(let[t,i]of n.is_latest.entries())i&&s.push(e[t]);return s}}class bj extends hA{info;chunkSource;state;connections;graphServer;constructor(e,t,i){super(),this.info=e,this.chunkSource=t,this.state=i,this.connections=new Set,this.graphServer=new bG(t.sharedKvStoreContext,e.app.segmentationUrl)}connect(e){let t=new b$(this,e,this.chunkSource,this.state);return this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}get visibleSegmentEquivalencePolicy(){return lo.BA.MAX_REPRESENTATIVE|lo.BA.NONREPRESENTATIVE_EXCLUDED}getRoot(e){return this.graphServer.getRoot(e)}tabContents(e,t,i){let r=document.createElement("div");r.style.display="contents";let n=document.createElement("div");n.className="neuroglancer-segmentation-toolbox",n.appendChild(aE(t,e.toolBinder,{toolJson:bJ,label:"Multicut",title:"Multicut segments"})),n.appendChild(aE(t,e.toolBinder,{toolJson:bK,label:"Merge",title:"Merge segments"})),r.appendChild(n),r.appendChild(t.registerDisposer(new bZ(e,e.annotationDisplayState)).element);let s=i.element;return s.classList.add("neuroglancer-annotations-tab"),s.classList.add("neuroglancer-graphene-tab"),r}async merge(e,t){return 0n}async split(e,t){return{include:e,exclude:t}}trackSegment(e,t){return()=>{console.log("trackSegment... do nothing",e,t)}}}class bW extends lC{}class bq extends ls(mk(bW),yk){}class bH extends lm{chunkManager;source;displayState;localPosition;layerChunkProgressInfo;sharedObject;chunkTransform;leafRequestsActive;leafRequestsStatusMessage;constructor(e,t,i,r,n){super(),this.chunkManager=e,this.source=t,this.displayState=i,this.localPosition=r,this.layerChunkProgressInfo=new ia,this.leafRequestsActive=this.registerDisposer(iH.make(e.rpc,!0)),this.chunkTransform=this.registerDisposer((0,J.og)(e=>i5(()=>t5(i8(e))),this.displayState.transform));let s=this.sharedObject=this.backend=this.registerDisposer(new c5(e,i,this.layerChunkProgressInfo));s.RPC_TYPE_ID="ChunkedGraphLayer",s.initializeCounterpartWithChunkManager({source:t.chunkSource.addCounterpartRef(),localPosition:this.registerDisposer(iH.makeFromExisting(e.rpc,this.localPosition)).rpcId,leafRequestsActive:this.leafRequestsActive.rpcId,nBitsForLayerId:this.registerDisposer(iH.make(e.rpc,n)).rpcId}),this.registerDisposer(s.visibility.add(this.visibility)),this.registerDisposer(this.leafRequestsActive.changed.add(()=>{this.showOrHideMessage(this.leafRequestsActive.value)}))}attach(e){super.attach(e);let t=this.chunkTransform.value,i=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:i},e.state.source=e.registerDisposer((0,J.Uw)((t,i,r)=>{let n=lk(r,i,e=>[[this.source]],e.messages,this);return e.view.flushBackendProjectionParameters(),this.sharedObject.rpc.invoke("ChunkedGraphLayer:updateSources",{layer:this.sharedObject.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:r,sources:lb(n)}),n[0][0]},this.displayState.transform,e.view.displayDimensionRenderInfo))}isReady(){return!0}showOrHideMessage(e){this.leafRequestsStatusMessage&&e?(this.leafRequestsStatusMessage.dispose(),this.leafRequestsStatusMessage=void 0,s1.showTemporaryMessage("Loading chunked graph segmentation...",3e3)):this.leafRequestsStatusMessage||e||(this.leafRequestsStatusMessage=s1.showMessage("At this zoom level, chunked graph segmentation will not be loaded. Please zoom in if you wish to load it."))}}let bJ="grapheneMulticutSegments",bK="grapheneMergeSegments";class bZ extends gp{layer;displayState;constructor(e,t){super(e,t),this.layer=e,this.displayState=t;let{graphConnection:{value:i}}=e;if(i instanceof b$)for(let e of i.annotationLayerStates)this.annotationStates.add(e)}get annotationStates(){return void 0===this._annotationStates&&(this._annotationStates=this.registerDisposer(new gu)),this._annotationStates}}let bY=(e,t)=>{let i=t.source;i.childDeleted.add(t=>{let i=[...e].find(e=>e.annotationReference?.id===t);i&&e.delete(i)});let r=e=>{let t={id:"",point:e.position,type:eB.POINT,properties:[],relatedSegments:[BigUint64Array.of(e.segmentId,e.rootId)]},r=i.add(t);e.annotationReference=r};for(let t of(e.changed.add((e,t)=>{if(null===e){for(let e of i)i.delete(i.getReference(e.id));return}t?r(e):e.annotationReference&&i.delete(e.annotationReference)}),e))r(t)},bX=(e,t)=>{if(t.updateUnconditionally())return function(e,t){let i=bS(t).getRenderLayerTransform(),r=i5(()=>t5(i8(i.value)));if(void 0!==r.error)return;let n=new Float32Array(r.modelTransform.unpaddedRank);if(t7(n,e,t.localPosition.value,r.layerRank,r.combinedGlobalLocalToChunkTransform))return n}(t.unsnappedPosition,e)},bQ=se.fromObject({"at:shift?+control+mousedown0":{action:"set-anchor"},"at:shift?+keyg":{action:"swap-group"},"at:shift?+enter":{action:"submit"}});class b0 extends au{toJSON(){return bJ}activate(e){let{layer:t}=this,{graphConnection:{value:i}}=t;if(!i||!(i instanceof b$))return;let{state:{multicutState:r},segmentsState:n}=i;if(void 0===r)return;let{body:s,header:a}=ak(e);a.textContent="Multicut segments",s.classList.add("graphene-multicut-status"),s.appendChild(sC({text:"Swap",title:"Swap group",onClick:()=>{r.swapGroup()}})),s.appendChild(sC({text:"Clear",title:"Clear multicut",onClick:()=>{r.reset()}}));let o=async()=>{l.classList.toggle("disabled",!0);let t=bS(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(e=>e/1e-9);i.submitMulticut(t).then(t=>{l.classList.toggle("disabled",!1),t&&e.cancel()})},l=sC({text:"Submit",title:"Submit multicut",onClick:()=>{o()}});s.appendChild(l);let d=document.createElement("div");d.className="activeGroupIndicator",d.innerHTML="Active Group: ",s.appendChild(d);let{displayState:u}=this.layer,c=u.segmentationGroupState.value,h=u.baseSegmentHighlighting.value,p=u.highlightColor.value;e.bindInputEventMap(bQ),e.registerDisposer(()=>{g(),u.baseSegmentHighlighting.value=h,u.highlightColor.value=p});let g=()=>{c$(c),u.useTempSegmentStatedColors2d.value=!1,u.tempSegmentStatedColors2d.value.clear(),u.tempSegmentDefaultColor2d.value=void 0,u.highlightColor.value=void 0},f=()=>{g(),d.classList.toggle("blueGroup",r.blueGroup.value);let e=r.focusSegment.value;if(void 0!==e){for(let t of(u.baseSegmentHighlighting.value=!0,u.highlightColor.value=r.blueGroup.value?br:bi,n.useTemporaryVisibleSegments.value=!0,n.useTemporarySegmentEquivalences.value=!0,n.temporaryVisibleSegments.add(e),r.segments))n.temporaryVisibleSegments.add(t);for(let t of n.segmentEquivalences.setElements(e))n.temporaryVisibleSegments.has(t)||n.temporarySegmentEquivalences.link(e,t);for(let t of(u.tempSegmentDefaultColor2d.value=bl,u.tempSegmentStatedColors2d.value.set(e,bo),r.redSegments))u.tempSegmentStatedColors2d.value.set(t,bs);for(let e of r.blueSegments)u.tempSegmentStatedColors2d.value.set(e,ba);u.useTempSegmentStatedColors2d.value=!0}};f(),e.registerDisposer(r.changed.add(f)),e.registerDisposer(c.segmentEquivalences.changed.add((0,ie.Z)(()=>f(),0))),e.bindAction("swap-group",e=>{e.stopPropagation(),r.swapGroup()}),e.bindAction("set-anchor",e=>{e.stopPropagation();let t=b1(this,c.visibleSegments);if(!t)return;let{rootId:i,segmentId:n}=t,{focusSegment:s,segments:a}=r;if(void 0===s.value&&(s.value=i),s.value!==i){s1.showTemporaryMessage(`The selected supervoxel has root segment ${i}, but the supervoxels already selected have root ${s.value}`,12e3);return}if(i!==n){for(let e of a)if(e===n){s1.showTemporaryMessage(`Supervoxel ${n} has already been selected`,7e3);return}}r.activeGroup.add(t)}),e.bindAction("submit",e=>{e.stopPropagation(),o()})}get description(){return"multicut"}}let b1=(e,t)=>{let{layer:i,mouseState:r}=e,{segmentSelectionState:{value:n,baseValue:s}}=i.displayState;if(!s||!n)return;if(!t.has(n)){s1.showTemporaryMessage("The selected supervoxel is of an unselected segment",7e3);return}let a=bX(i,r);if(void 0!==a)return{rootId:n,segmentId:s,position:a}},b2=e=>new Promise((t,i)=>{setTimeout(t,e)});class b3 extends gk{annotationState;getBaseSegment;constructor(e,t){super(e,{}),this.annotationState=t,this.getBaseSegment=!0;let{inProgressAnnotation:i}=this,{displayState:r}=t;if(!r)return;let{disablePicking:n}=r;this.registerDisposer(i.changed.add(()=>{n.value=void 0!==i.value}))}get annotationLayer(){return this.annotationState}get description(){return"merge line"}toJSON(){return b9}}function b4(e,t){let i=e.relatedSegments[0],r={id:e.id,locked:!1,sink:{position:e.pointA.slice(),rootId:i[0],segmentId:i[1]}};return t||(r.source={position:e.pointB.slice(),rootId:i[2],segmentId:i[3]}),r}let b6=10,b5=se.fromObject({"at:shift?+enter":{action:"submit"}});class b8 extends au{activate(e){let{graphConnection:{value:t},tool:i}=this.layer;if(!t||!(t instanceof b$))return;let{state:{mergeState:r}}=t;if(void 0===r)return;let{merges:n,autoSubmit:s}=r,a=new b3(this.layer,t.mergeAnnotationState);i.value=a,e.registerDisposer(()=>{i.value=void 0});let{body:o,header:l}=ak(e);l.textContent="Merge segments",o.classList.add("graphene-merge-segments-status"),e.bindInputEventMap(b5);let d=async()=>{n.value.filter(e=>e.locked).length||(u.classList.toggle("disabled",!0),await t.bulkMerge(n.value),u.classList.toggle("disabled",!1))},u=sC({text:"Submit",title:"Submit merge",onClick:async()=>{d()}});o.appendChild(u),e.bindAction("submit",async e=>{e.stopPropagation(),d()}),o.appendChild(sC({text:"Clear",title:"Clear pending merges",onClick:()=>{for(let e of(a.deactivate(),n.value))e.locked||t.deleteMergeSubmission(e)}}));let c=e.registerDisposer(new i4(s)),h=document.createElement("label");h.appendChild(document.createTextNode("auto-submit")),h.title="auto-submit merges",h.appendChild(c.element),o.appendChild(h);let p=document.createElement("div");p.classList.add("graphene-merge-segments-merges"),o.appendChild(p);let g=cK.make(this.layer.displayState,!0),f=e=>{let t=g.getWithNormalizedId(e);return t.classList.add("neuroglancer-segment-list-entry-double-line"),t},m=e=>{let t=document.createElement("div");t.classList.add("graphene-merge-segments-point");let i=f(cG(this.layer.displayState,e));return t.appendChild(i),t},v=e=>{let i=document.createElement("div");if(i.classList.add("graphene-merge-segments-submission"),i.appendChild(m(e.sink.rootId)),e.source&&(i.appendChild(document.createElement("div")).textContent="ꕹ",i.appendChild(m(e.source.rootId))),e.locked||i.appendChild(gs({title:"Delete merge",onClick:i=>{i.stopPropagation(),i.preventDefault(),t.deleteMergeSubmission(e)}})),e.status){let t=document.createElement("div");t.classList.add("graphene-merge-segments-submission-status"),t.textContent=e.status,i.appendChild(t)}return i},y=()=>{for(;p.firstChild;)p.removeChild(p.firstChild);for(let e of n.value)p.appendChild(v(e))};e.registerDisposer(n.changed.add(y)),y()}toJSON(){return bK}get description(){return"merge segments"}}am(fD,bJ,e=>new b0(e,!0)),am(fD,bK,e=>new b8(e,!0));let b9="annotateMergeLine";af(b9,(e,t)=>new b3(e,t)),vf(new l8(new class{get scheme(){return"graphene"}get description(){return"Graphene data source"}get(e){(0,l0.zY)(e.url);let t=(0,l0.J8)(e.kvStoreUrl);return e.registry.chunkManager.memoize.getAsync({type:"graphene:get",url:t},e,async i=>{let r=await by(e.registry.sharedKvStoreContext,t,!0,i);(0,ef.PT)(r);let n=(0,ef.Kh)(r,"redirect",ef.ZE),s=`${e.url.scheme}://${t}`;if(void 0!==n)return{canonicalUrl:s,targetUrl:n};let a=(0,ef.Kh)(r,"@type",ef.ZE);switch(a){case"neuroglancer_multiscale_volume":case void 0:{let n=await bb(e.registry.sharedKvStoreContext,t,r,i,e.state);return n.canonicalUrl=s,n}default:throw Error(`Invalid type: ${JSON.stringify(a)}`)}})}}));var b7=i(835);function Se(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(Se=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}class St extends ls(mk(po),b7.Y){}class Si extends pd{sharedKvStoreContext;multiscaleMetadata;scales;dataType;volumeType;baseScaleIndex;modelSpace;get rank(){return this.modelSpace.rank}constructor(e,t,i){let r,n;if(super(e.chunkManager),this.sharedKvStoreContext=e,this.multiscaleMetadata=t,this.scales=i,i.forEach((e,t)=>{if(void 0!==e){if(void 0===n&&(n=t),void 0!==r&&e.dataType!==r)throw Error(`Scale s${t} has data type ${el[e.dataType]} but expected ${el[r]}.`);r=e.dataType}}),void 0===r)throw Error("At least one scale must be specified.");let s=i[n],a=i[n];this.dataType=r,this.volumeType=pt.IMAGE,this.baseScaleIndex=n;let o=t.modelSpace,{rank:l}=o;this.modelSpace=tw({names:o.names,scales:o.scales,units:o.units,boundingBoxes:[{transform:(0,e9.Kt)(Float64Array,s.downsamplingFactors,!1),box:{lowerBounds:new Float64Array(l),upperBounds:new Float64Array(a.size)}}],coordinateArrays:o.coordinateArrays})}getSources(e){let{scales:t,rank:i}=this;return(0,H.PK)(t.filter(e=>void 0!==e).map(t=>{let r=(0,e9.Kt)(Float32Array,t.downsamplingFactors);return pn({rank:i,chunkToMultiscaleTransform:r,dataType:t.dataType,upperVoxelBound:t.size,volumeType:this.volumeType,chunkDataSizes:[t.chunkSize],volumeSourceOptions:e}).map(e=>({chunkSource:this.chunkManager.getChunkSource(St,{sharedKvStoreContext:this.sharedKvStoreContext,spec:e,parameters:{url:t.url,encoding:t.encoding}}),chunkToMultiscaleTransform:r}))}))}}async function Sr(e,t,i,r){let n=function(e,t){let i=e.getKvStore(t),r=[],n=i.path.substring(0,i.path.length-1);for(;;){let e=(0,l0.V8)(n);if(r.push({attributesJsonUrl:i.store.getUrl((0,l0.Vo)(n,"attributes.json")),directoryUrl:i.store.getUrl(e),relativePath:i.path.substring(e.length)}),""===n)break;let t=n.lastIndexOf("/");n=n.substring(0,t)}return r}(e.kvStoreContext,t),s=await Promise.all(n.map((t,s)=>{var a,o;return a=t.attributesJsonUrl,o=i&&s===n.length-1,e.chunkManager.memoize.getAsync({type:"n5:attributes.json",url:a},r,async t=>{let i={stack:[],error:void 0,hasError:!1};try{!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(i,new iL.Vi(t.progressListener,{message:`Reading n5 metadata from ${a}`}),!1);let r=await e.kvStoreContext.read(a,{...t,throwIfMissing:o});if(void 0===r)return;let n=await r.response.json();try{return(0,ef.PT)(n)}catch(e){throw Error(`Error reading attributes from ${a}`,{cause:e})}}catch(e){i.error=e,i.hasError=!0}finally{Se(i)}})})),a=s.findLastIndex(e=>void 0!==e);if(-1===a)return;s.reverse();let o=n[a];return{attributes:Object.assign({},...s.filter(e=>void 0!==e)),rootUrl:o.directoryUrl,pathFromRoot:o.relativePath}}function Sn(e,t){if(-1!==e&&t!==e)throw Error(`Rank mismatch, received ${t} but expected ${e}`);return t}function Ss(e){return Float64Array.from((0,ef.m7)(e,ef.o7))}function Sa(e){let t=(0,ef.f6)(e);if(0===t.length)throw Error("Expected non-empty array");let i=-1;return{all:(0,ef.m7)(t,e=>{let t=Ss(e);return i=Sn(i,t.length),t}),single:void 0,rank:i}}let So=["x","y","z","t","c"];async function Sl(e,t,i,r){let n,s;(0,ef.PT)(i);let a=-1,o=(0,ef.Kh)(i,"resolution",e=>{let t=Float64Array.from((0,ef.m7)(e,ef.o7));return a=Sn(a,t.length),t}),l=(0,ef.Kh)(i,"axes",e=>{let t=(0,ef.m7)(e,ef.ZE);return a=Sn(a,t.length),t}),d=(0,ef.Kh)(i,"units",e=>{let t=(0,ef.m7)(e,tl);return a=Sn(a,t.length),t}),u={unit:"m",exponent:-9};(0,ef.Kh)(i,"downsamplingFactors",e=>{let{single:t,all:i,rank:r}=function(e){let t=(0,ef.f6)(e);if(0===t.length)throw Error("Expected non-empty array");if(Array.isArray(t[0]))return Sa(t);let i=Ss(e);return{all:void 0,single:i,rank:i.length}}(e);a=Sn(a,r),void 0!==t&&(n=t),void 0!==i&&(s=i)}),(0,ef.Kh)(i,"pixelResolution",e=>{u=(0,ef.uq)(e,"unit",tl),(0,ef.Kh)(e,"dimensions",e=>{o=Float64Array.from((0,ef.m7)(e,ef.o7)),a=Sn(a,o.length)})}),(0,ef.Kh)(i,"scales",e=>{let{all:t,rank:i}=Sa(e);a=Sn(a,i),s=t});let c=(0,ef.Kh)(i,"dimensions",e=>{let t=(0,ef.m7)(e,ef.Sc);return a=Sn(a,t.length),t});if(-1===a)throw Error("Unable to determine rank of dataset");void 0===d&&(d=Array(a)).fill(u),void 0===o&&(o=new Float64Array(a)).fill(1);for(let e=0;e<a;++e)o[e]=td(o[e],d[e].exponent);let h=Array(a);void 0!==l&&(0,ef.Kh)(i,"coordinateArrays",e=>{(0,ef.PT)(e);for(let t=0;t<a;++t){let i=l[t];if(Object.prototype.hasOwnProperty.call(e,i)){let r=(0,ef.zE)(e[i]);h[t]={explicit:!1,labels:r,coordinates:Array.from(r,(e,t)=>t)},d[t]={unit:"",exponent:0},o[t]=1}}}),void 0===l&&(l=function(e){let t=So.slice(0,e);for(;t.length<e;)t.push(`d${t.length+1}`);return t}(a));let p=tw({rank:a,valid:!0,names:l,scales:o,units:d.map(e=>e.unit),coordinateArrays:h});if(void 0===c){if(void 0===s){let n=await Sd(e,t,r);if(0===n.length)throw Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:p,url:t,attributes:i,scales:n.map(e=>({url:`${t}${e}/`,downsamplingFactors:void 0}))}}return{modelSpace:p,url:t,attributes:i,scales:s.map((e,i)=>({url:`${t}s${i}/`,downsamplingFactors:e}))}}return void 0===n&&(n=new Float64Array(a)).fill(1),{modelSpace:p,url:t,attributes:i,scales:[{url:t,downsamplingFactors:n}]}}async function Sd(e,t,i){let r=await e.kvStoreContext.list(t,{responseKeys:"suffix",...i}),n=[];for(let e of r.directories)e.match(/^s(?:0|[1-9][0-9]*)$/)&&(n[Number(e.substring(1))]=e);return n}let Su=new class{get scheme(){return"n5"}get expectsDirectory(){return!0}get description(){return"N5 data source"}get(e){(0,l0.uh)(e.url);let t=(0,l0.J8)((0,l0.Yq)((0,l0.J8)(e.kvStoreUrl),e.url.suffix??"")),{sharedKvStoreContext:i}=e.registry;return e.registry.chunkManager.memoize.getAsync({type:"n5:MultiscaleVolumeChunkSource",url:t},e,async r=>{let n=await Sr(i,t,!1,r);if(void 0===n)throw Error("N5 metadata not found");let{attributes:s,rootUrl:a,pathFromRoot:o}=n,l=await Sl(i,t,s,r),d=await Promise.all(l.scales.map(async(e,t)=>{if(void 0===e)return;let{attributes:n}=await Sr(i,e.url,!0,r);if(void 0!==n)try{return function(e,t,i,r){let n;(0,ef.PT)(t);let s=(0,ef.uq)(t,"dataType",e=>(0,ef.CT)(e,el)),a=Float32Array.from((0,ef.uq)(t,"dimensions",e=>(0,ef.m7)(e,ef.Sc))),o=(0,ef.uq)(t,"blockSize",e=>(0,ef.Iw)(new Uint32Array(a.length),e,ef.Sc));if((0,ef.Kh)(t,"compression",e=>{(n=(0,ef.uq)(e,"type",e=>(0,ef.CT)(e,b7.k)))===b7.k.GZIP&&!0===(0,ef.Kh)(e,"useZlib",ef.JG,!1)&&(n=b7.k.ZLIB)}),void 0===n&&(n=(0,ef.uq)(t,"compressionType",e=>(0,ef.CT)(e,b7.k))),void 0===r&&void 0===(r=(0,ef.Kh)(t,"downsamplingFactors",e=>(0,ef.Iw)(new Float64Array(a.length),e,ef.o7)))){if(0===i)(r=new Float64Array(a.length)).fill(1);else throw Error("Expected downsamplingFactors attribute")}return{url:e,dataType:s,encoding:n,size:a,chunkSize:o,downsamplingFactors:r}}(e.url,n,t,e.downsamplingFactors)}catch(t){throw Error(`Error parsing array metadata at ${e.url}`,{cause:t})}})),u=new Si(i,l,d);return{canonicalUrl:`${a}|${e.url.scheme}:${o}`,modelTransform:tN(u.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:u}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:e5(u.modelSpace.bounds)}}]}})}async completeUrl(e){return(0,l0.uh)(e.url),l2(e.registry.sharedKvStoreContext,{baseUrl:(0,l0.J8)(e.kvStoreUrl),path:e.url.suffix??"",directoryOnly:!0,signal:e.signal,progressListener:e.progressListener})}};function Sc(e){return Error(`Nggraph server ${e} does not allow requests from Neuroglancer instance ${self.origin}`)}async function Sh(e){let t=new s1(!1),i=new Promise((t,i)=>{window.addEventListener("message",function r(n){if((n.origin||n.originalEvent.origin)!==e||"string"!=typeof n.data)return;let s=()=>{window.removeEventListener("message",r,!1)};"badorigin"===n.data?(s(),i(Sc(e))):(s(),t(n.data))},!1)});!function i(r,n){t.element.textContent=r+" ";let s=document.createElement("button");s.textContent=n,t.element.appendChild(s),s.addEventListener("click",()=>{window.open(`${e}/login?origin=${encodeURIComponent(self.origin)}`),i(`Waiting for login to nggraph server ${e}...`,"Retry")})}(`Nggraph server ${e} login required.`,"Login");try{return{token:await i}}finally{t.dispose()}}vm(Su),vf(new l8(Su)),function(e){e.registerDirectoryFormat((0,l3.HP)(new Set(["attributes.json"]),{suffix:"n5:",description:"N5"}))}(vg);class Sp extends vv{serverUrl;constructor(e){super(),this.serverUrl=e,this.get=vb(async()=>{let e=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(e.status){case 200:return{token:await e.text()};case 401:return await Sh(this.serverUrl);case 403:throw Sc(this.serverUrl);default:throw m8.oo.fromResponse(e)}})}get}function Sg(e){return(0,ef.PT)(e),{id:(0,ef.uq)(e,"id",ef.tw),baseSegments:(0,ef.uq)(e,"base_segment_ids",e=>(0,ef.m7)(e,ef.tw)),baseSegmentParents:(0,ef.uq)(e,"base_segment_parent_ids",e=>(0,ef.m7)(e,ef.tw)),name:(0,ef.uq)(e,"name",ef.ZE),tags:(0,ef.uq)(e,"tags",ef.zE),numVoxels:(0,ef.uq)(e,"num_voxels",ef.C$),bounds:(0,ef.uq)(e,"bounds",e=>(0,ef.m7)(e,e=>(0,ef.jz)(e))),lastLogId:(0,ef.uq)(e,"last_log_id",e=>null==e?null:(0,ef.tw)(e))}}let Sf=0;class Sm extends hM{constructor(e,t){super(e,t);let i=()=>{this.ignoreVisibleSegmentsChanged||this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(i)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(i)),this.visibleSegmentsChanged()}computeSplit(e,t){let{segmentEquivalences:i}=this.segmentsState,r=i.get(e);if((0,lo.Lr)(r)||i.get(t)!==r)return;let n=this.segmentQueries.get(r);if(void 0===n)return;let{current:s}=n;if(void 0===s)return;let{baseSegments:a,baseSegmentParents:o}=s,l=o.length,d=new hN.D;for(let i=0;i<l;++i){let r=a[i],n=o[i];r!==t&&n!==t&&(d.link(r,n),console.log(`Linking ${r} - ${n} == ${e}? ${e===r} ${e===n} :: unioned with include = ${e===d.get(r)}, with exclude = ${t===d.get(r)}`))}let u=[],c=[],h=d.get(e);for(let e of a)d.get(e)===h?u.push(e):c.push(e);return console.log("include = "+u.map(e=>e.toString()).join(",")),console.log("exclude = "+c.map(e=>e.toString()).join(",")),{includeRepresentative:r,includeBaseSegments:u,excludeRepresentative:lo.tr,excludeBaseSegments:c}}debouncedVisibleSegmentsChanged=this.registerCancellable((0,ie.Z)(()=>this.visibleSegmentsChanged(),0));segmentQueries=new Map;ignoreVisibleSegmentsChanged=!1;segmentEquivalencesChanged=this.registerCancellable((0,ie.Z)(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();let{segmentQueries:e}=this,{segmentEquivalences:t}=this.segmentsState;for(let[i,r]of(t.clear(),e)){if(void 0===r.current||(0,lo.Lr)(r.id))continue;let{id:e,baseSegments:i}=r.current;if(i.length>0){for(let r of i)t.link(r,e);r.addedEquivalences=!0}else r.addedEquivalences=!1}},0));registerVisibleSegment(e){let t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:Sf,disposer:this.graph.watchSegment(e,e=>this.handleSegmentUpdate(t.id,e))};this.segmentQueries.set(e,t),console.log(`adding to segmentQueries: ${e}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);let i=this.segmentQueries.get(e);if("invalid"===t){i.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(i.id),this.segmentsState.temporaryVisibleSegments.delete(i.id)}finally{this.ignoreVisibleSegmentsChanged=!1}i.addedEquivalences&&this.segmentEquivalencesChanged();return}if("error"===t){i.current=void 0,i.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}i.current=t;let r=i.id,n=t.id;if(n!==r){i.id=n;let s=this.segmentQueries.get(n);console.log(`removing from segmentQueries: ${e} due to rename -> ${n}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(r)&&this.segmentsState.visibleSegments.add(n),this.segmentsState.selectedSegments.has(r)&&(this.segmentsState.selectedSegments.delete(r),this.segmentsState.selectedSegments.add(n)),this.segmentsState.temporaryVisibleSegments.has(r)&&(this.segmentsState.temporaryVisibleSegments.delete(r),this.segmentsState.temporaryVisibleSegments.add(n))}finally{this.ignoreVisibleSegmentsChanged=!1}void 0===s?(console.log(`adding to segmentQueries due to rename -> ${n}`),this.segmentQueries.set(n,i),this.segmentEquivalencesChanged()):(null!==t.lastLogId&&("object"!=typeof s.current||null===s.current.lastLogId||s.current.lastLogId<t.lastLogId)&&(s.current=t,this.segmentEquivalencesChanged()),i.disposer())}else i.current=t,(0,lo.Lr)(i.id)||this.segmentEquivalencesChanged()}visibleSegmentsChanged(){let{segmentsState:e}=this,{segmentQueries:t}=this,i=++Sf,r=e=>{for(let r of e.keys()){if(r===lo.tr)continue;let e=t.get(r);if(void 0!==e){e.seenGeneration=i;continue}this.registerVisibleSegment(r)}};for(let[n,s]of(r(e.visibleSegments),r(e.temporaryVisibleSegments),t))s.seenGeneration!==i&&(console.log(`removing from segmentQueries due to seenGeneration: ${n}`),t.delete(n),s.disposer(),s.addedEquivalences&&this.segmentEquivalencesChanged())}}class Sv extends hA{chunkManager;serverUrl;entityName;startingWebsocket;websocket;watchesById;watches;nextWatchId;numOpenFailures;constructor(e,t,i){super(),this.chunkManager=e,this.serverUrl=t,this.entityName=i,this.startingWebsocket=!1,this.websocket=void 0,this.watchesById=new Map,this.watches=new Set,this.nextWatchId=0,this.numOpenFailures=0}get visibleSegmentEquivalencePolicy(){return lo.BA.MAX_REPRESENTATIVE|lo.BA.REPRESENTATIVE_EXCLUDED}startWebsocket(){if(this.startingWebsocket||0===this.watches.size)return;this.startingWebsocket=!0;let e=new s1(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{let{numOpenFailures:t}=this;if(t>1){let e=1e3*Math.min(16,2**t);await new Promise(t=>setTimeout(t,e))}let i=new URL("/graph/watch/"+encodeURIComponent((await SC(this.chunkManager,this.serverUrl,this.entityName).get()).credentials.token),this.serverUrl);i.protocol=i.protocol.replace("http","ws");let r=new WebSocket(i.href);r.onclose=()=>{void 0!==e&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},r.onopen=()=>{void 0!==e&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=r,this.nextWatchId=0;try{for(let e of this.watches){r.send(JSON.stringify({watch:{segment_id:e.segment.toString()}}));let t=this.nextWatchId++;e.watchId=t,this.watchesById.set(t,e)}}catch{}},r.onmessage=e=>{let t,i;try{let r=JSON.parse(e.data);(0,ef.PT)(r);let n=(0,ef.uq)(r,"watch_id",ef.C$),s=this.watchesById.get(n);if(void 0===s)return;i=s;let a=(0,ef.uq)(r,"state",ef.ZE);t="invalid"===a||"error"===a?a:(0,ef.uq)(r,"info",Sg)}catch(t){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,e.data,t);return}console.log("got update",t),i.callback(t)}})()}connect(e){return new Sm(this,e.displayState.segmentationGroupState.value)}trackSegment(e,t){return this.watchSegment(e,e=>{if("invalid"===e)t(null);else{if("error"===e)return;t(e.id)}})}watchSegment(e,t){let i={callback:t,segment:e,watchId:-1};this.watches.add(i);let{websocket:r}=this;if(void 0!==r)try{r.send(JSON.stringify({watch:{segment_id:e.toString()}}));let t=this.nextWatchId++;i.watchId=t,this.watchesById.set(t,i)}catch{}else this.startWebsocket();return()=>{let{websocket:e}=this;if(void 0!==e&&e.readyState===WebSocket.OPEN){let t=i.watchId;this.watchesById.delete(t);try{e.send(JSON.stringify({unwatch:{watch_id:t}}))}catch{}}this.watches.delete(i)}}async merge(e,t){let i=await Sx(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return(0,ef.PT)(i),(0,ef.uq)(i,"merged",ef.tw)}async split(e,t){let i=await Sx(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return(0,ef.PT)(i),{include:(0,ef.uq)(i,"include",ef.tw),exclude:(0,ef.uq)(i,"exclude",ef.tw)}}}function Sy(e){let t=e.match("^(https?://[^/]+)/(.*)$");if(null===t)throw Error(`Invalid nggraph url: ${JSON.stringify(e)}`);return{serverUrl:t[1],id:t[2]}}function Sb(e,t,i,r){return(0,m5.q)(e,`${t}${i}`,r,(e,t)=>{let i=new Headers(t.headers);return i.set("Authorization",e.token),{...t,headers:i}},e=>{let{status:t}=e;if(401===t)return"refresh";throw e}).then(e=>e.json())}class SS extends vv{parentCredentialsProvider;serverUrl;entityName;constructor(e,t,i){super(),this.parentCredentialsProvider=e,this.serverUrl=t,this.entityName=i,this.get=vb(async()=>{let e=await Sb(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:e.token,entityType:e.entity_type,role:e.role}})}get}function Sw(e,t){return e.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:t},()=>new Sp(t))}function SC(e,t,i){return e.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:t,entityName:i},()=>new SS(Sw(e,t),t,i))}function Sx(e,t,i,r,n){return Sb(SC(e,t,i),t,r,n)}vf(new class{get scheme(){return"nggraph"}get description(){return"nggraph data source"}get(e){let{serverUrl:t,id:i}=Sy(e.providerUrl);return e.registry.chunkManager.memoize.getAsync({type:"nggraph:get",serverUrl:t,id:i},e,async r=>{let n=SC(e.registry.chunkManager,t,i),{entityType:s}=(await n.get(void 0,r)).credentials;if("graph"!==s)throw Error(`Unsupported entity type: ${JSON.stringify(s)}`);let{datasource_url:a}=await Sx(e.registry.chunkManager,t,i,"/graph/config",{method:"POST",...r}),o=await e.registry.get({...e,url:a}),l=new Sv(e.registry.chunkManager,t,i),d=[...o.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:l}}];return{modelTransform:o.modelTransform,subsources:d}})}async completeUrl(e){let{serverUrl:t,id:i}=Sy(e.providerUrl),r=await e.registry.chunkManager.memoize.getAsync({type:"nggraph:list",serverUrl:t},e,async i=>{var r,n,s,a;return a=await (r=e.registry.chunkManager,n="/list",s={method:"POST",...i},Sb(Sw(r,t),t,n,s)),(0,ef.PT)(a),(0,ef.uq)(a,"entities",e=>(0,ef.m7)(e,e=>{(0,ef.PT)(e);let t=(0,ef.uq)(e,"entity",ef.ZE);return{id:t,entityType:(0,ef.uq)(e,"entity_type",ef.ZE),accessRole:(0,ef.uq)(e,"access_role",ef.ZE)}}))});return{offset:t.length+1,completions:lj(i,r,e=>e.id,e=>`${e.entityType} (${e.accessRole})`)}}});var SE=i(2147);class ST extends ls(mk(po),SE.L){}class Sk extends pd{sharedKvStoreContext;url;info;constructor(e,t,i){super(e.chunkManager),this.sharedKvStoreContext=e,this.url=t,this.info=i}get dataType(){return this.info.dataType}get volumeType(){return pt.UNKNOWN}get rank(){return this.info.rank}getSources(e){let{info:t}=this,i=e9.XD(Float32Array,t.rank+1),r=pr({rank:t.rank,volumeType:pt.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:i,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(ST,{sharedKvStoreContext:this.sharedKvStoreContext,spec:r,parameters:{url:this.url}}),chunkToMultiscaleTransform:i}]]}}function SD(e,t,i,r){async function n(n){let s;let{prefix:a}=n;if(a.length<t+i.length)return[];let o=new DataView(a.buffer,a.byteOffset,a.byteLength);if(o.getInt32(0,!0)===e)s=ep.LITTLE;else{if(o.getInt32(0,!1)!==e)return[];s=ep.BIG}for(let e=0;e<i.length;++e)if(i.charCodeAt(e)!==a[e+t])return[];return[{suffix:"nifti:",description:`NIfTI ${r} (${ep[s].toLowerCase()}-endian)`}]}return{prefixLength:t+i.length,suffixLength:0,match:n}}let SL=new class{get scheme(){return"nifti"}get description(){return"NIfTI"}get singleFile(){return!0}get(e){var t,i;return(0,l0.zY)(e.url),t=e.registry.sharedKvStoreContext,i=e.kvStoreUrl,t.chunkManager.memoize.getAsync({type:"nifti/getVolume",url:i},e,async e=>{let r=await t.chunkManager.rpc.promiseInvoke(SE._,{sharedKvStoreContext:t.rpcId,url:i},{signal:e.signal,progressListener:e.progressListener}),n=new Sk(t,i,r),s={lowerBounds:new Float64Array(r.rank),upperBounds:Float64Array.from(r.volumeSize)},a=tw({rank:r.rank,names:r.sourceNames,scales:r.sourceScales,units:r.units,boundingBoxes:[tP(s)]}),o=tw({rank:r.rank,names:r.viewNames,scales:r.viewScales,units:r.units});return{canonicalUrl:`${i}|nifti:`,subsources:[{id:"default",default:!0,subsource:{volume:n}},{id:"bounds",default:!0,subsource:{staticAnnotations:e5(s)}}],modelTransform:{sourceRank:r.rank,rank:r.rank,inputSpace:a,outputSpace:o,transform:r.transform}}})}};vm(SL),vf(new l8(SL)),vg.registerFileFormat(SD(348,344,"n+1\0","v1")),vg.registerFileFormat(SD(540,4,"n+2\0\r\n\x1a\n","v2"));let SI=new mW("obj","Wavefront OBJ mesh");vm(SI),vf(new l8(SI)),vm(new y6),vf(new class extends l8{constructor(){super(new y6,"precomputed")}convertLegacyUrl(e){let{url:t,parameters:i}=function(e){let[,t,i]=e.match(y4);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),{url:t,parameters:(0,ef.Re)(i||"")}}(e.providerUrl);return"mesh"===e.type&&(i.type="mesh"),e.providerScheme+"://"+function(e,t){let i=(0,ef.qs)(t);return i&&(e+=`#${i}`),e}(t,i)}}),function(e){e.registerDirectoryFormat((0,l3.HP)(new Set(["info"]),{suffix:"neuroglancer-precomputed:",description:"Neuroglancer Precomputed data source"}))}(vg);var SP=i(3074);let SR=new Set(["jpg","raw16","png","png16"]),SA=[{name:"minX",type:"number"},{name:"minY",type:"number"},{name:"minZ",type:"number"},{name:"maxX",type:"number"},{name:"maxY",type:"number"},{name:"maxZ",type:"number"},{name:"encoding",type:Array.from(SR).join(" | ")},{name:"numLevels",type:"integer"},{name:"tileSize",type:"number"},{name:"channel",type:"string"}],SM=ls(po,SP.xd);class SN extends SM{}let SV=new Set(["COMPLETE","READ_ONLY"]),SO=new Set(["LOADING"]);function SF(e){let t=(0,ef.m7)(e,ef.PT);if(t.length<1)throw Error("No stacks found for owner object.");let i=new Map,r=(0,ef.uq)(t[0],"stackId",S_);for(let e of t){let t=(0,ef.uq)(e,"stackId",SB),r=function(e){(0,ef.PT)(e);let t=(0,ef.uq)(e,"state",ef.ZE),i=[],r=Z.R3.create(),n=Z.R3.create();if(SV.has(t)){var s;let t=(0,ef.uq)(e,"stats",ef.PT);r=function(e){(0,ef.PT)(e);let t=(0,ef.uq)(e,"stackBounds",ef.PT),i=Z.R3.create();return i[0]=(0,ef.uq)(t,"minX",ef.nH),i[1]=(0,ef.uq)(t,"minY",ef.nH),i[2]=(0,ef.uq)(t,"minZ",ef.nH),i}(t),n=function(e){(0,ef.PT)(e);let t=(0,ef.uq)(e,"stackBounds",ef.PT),i=Z.R3.create();return i[0]=(0,ef.uq)(t,"maxX",ef.nH)+1,i[1]=(0,ef.uq)(t,"maxY",ef.nH)+1,i[2]=(0,ef.uq)(t,"maxZ",ef.nH)+1,i}(t),Object.prototype.hasOwnProperty.call(t,"channelNames")&&(s=t,(0,ef.PT)(s),i=(0,ef.uq)(s,"channelNames",e=>(0,ef.m7)(e,ef.ZE)))}else if(!SO.has(t))return;return{lowerVoxelBound:r,upperVoxelBound:n,voxelResolution:(0,ef.uq)(e,"currentVersion",SU),project:(0,ef.uq)(e,"stackId",S$),channels:i}}(e);if(void 0!==r){let e=r.project,n=i.get(e);if(void 0===n){let t=new Map;i.set(e,{stacks:t}),n=i.get(e)}n.stacks.set(t,r)}}return{owner:r,projects:i}}function SB(e){return(0,ef.PT)(e),(0,ef.uq)(e,"stack",ef.ZE)}function S_(e){return(0,ef.PT)(e),(0,ef.uq)(e,"owner",ef.ZE)}function SU(e){(0,ef.PT)(e);let t=Z.R3.create();try{t[0]=(0,ef.uq)(e,"stackResolutionX",ef.nH),t[1]=(0,ef.uq)(e,"stackResolutionY",ef.nH),t[2]=(0,ef.uq)(e,"stackResolutionZ",ef.nH)}catch{t[0]=1,t[1]=1,t[2]=1}return t}function S$(e){return(0,ef.PT)(e),(0,ef.uq)(e,"project",ef.ZE)}function Sz(e){let t=e.paths["/v1/owner/{owner}/project/{project}/stack/{stack}/z/{z}/box/{x},{y},{width},{height},{scale}/raw-image"];return void 0===t?(console.warn("Could not retrieve API schema, skipping dynamic parameter hints"),SA):t.get.parameters.filter(({required:e})=>!1===e).filter(({name:e})=>"scale"!==e).concat(SA)}class SG extends pd{baseUrl;ownerInfo;project;parameters;get dataType(){return"raw16"===this.parameters.encoding||"png16"===this.parameters.encoding?el.UINT16:el.UINT8}get volumeType(){return pt.IMAGE}channel;stack;stackInfo;dims;encoding;numLevels;minX;minY;minZ;maxX;maxY;maxZ;renderArgs;get rank(){return 3}constructor(e,t,i,r,n,s,a){super(e),this.baseUrl=t,this.ownerInfo=i,this.project=n,this.parameters=a;let o=i.projects.get(n);if(void 0===o)throw Error(`Specified project ${JSON.stringify(n)} does not exist for specified owner ${JSON.stringify(i.owner)}`);if(void 0===r){let e=Array.from(o.stacks.keys());if(1!==e.length)throw Error(`Dataset contains multiple stacks: ${JSON.stringify(e)}`);r=e[0]}let l=o.stacks.get(r);if(void 0===l)throw Error(`Specified stack ${JSON.stringify(r)} is not one of the supported stacks: `+JSON.stringify(Array.from(o.stacks.keys())));this.stack=r,this.stackInfo=l,void 0!==s&&s.length>0&&(this.channel=s);let d=new Set(SA.map(({name:e})=>e));for(let[e,t]of(this.renderArgs={},Object.entries(a)))d.has(e)||(this.renderArgs[e]=t);this.minX=(0,ef.a6)(a.minX),this.minY=(0,ef.a6)(a.minY),this.minZ=(0,ef.a6)(a.minZ),this.maxX=(0,ef.a6)(a.maxX),this.maxY=(0,ef.a6)(a.maxY),this.maxZ=(0,ef.a6)(a.maxZ),void 0!==this.minX&&(l.lowerVoxelBound[0]=this.minX),void 0!==this.minY&&(l.lowerVoxelBound[1]=this.minY),void 0!==this.minZ&&(l.lowerVoxelBound[2]=this.minZ),void 0!==this.maxX&&(l.upperVoxelBound[0]=this.maxX),void 0!==this.maxY&&(l.upperVoxelBound[1]=this.maxY),void 0!==this.maxZ&&(l.upperVoxelBound[2]=this.maxZ);let u=(0,ef.kt)(a.encoding);if(void 0===u)u="jpg";else if(!SR.has(u))throw Error(`Invalid encoding: ${JSON.stringify(u)}.`);this.encoding=u,this.numLevels=(0,ef.a6)(a.numlevels),this.dims=Z.R3.create();let c=(0,ef.a6)(a.tilesize);void 0===c&&(c=1024),this.dims[0]=c,this.dims[1]=c,this.dims[2]=1}getSources(e){let t=[],i=this.numLevels;void 0===i&&(i=function(e,t){let i=0;for(let t=0;t<2;t++)i=Math.max(i,e.upperVoxelBound[t]);if(t>=i)return 1;let r=0;for(;i>t;)i/=2,r++;return r}(this.stackInfo,this.dims[0]));let{lowerVoxelBound:r,upperVoxelBound:n}=this.stackInfo;for(let e=0;e<i;e++){let i=Z._E.create(),s=Uint32Array.of(1,1,1);for(let t=0;t<2;++t)i[5*t]=2**e,s[t]=this.dims[t];let a=Z.R3.create(),o=Z.R3.create(),l=Z.R3.create(),d=Z.R3.create();for(let e=0;e<3;e++){let t=i[5*e],s=l[e]=r[e]/t,u=d[e]=n[e]/t;a[e]=Math.floor(s),o[e]=Math.ceil(u)}let u=pi({rank:3,chunkDataSize:s,dataType:this.dataType,lowerVoxelBound:a,upperVoxelBound:o}),c=this.chunkManager.getChunkSource(SN,{spec:u,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,renderArgs:this.renderArgs,dims:`${this.dims[0]}_${this.dims[1]}`,level:e,encoding:this.encoding}});t.push([{chunkSource:c,chunkToMultiscaleTransform:i,lowerClipBound:l,upperClipBound:d}])}return(0,H.PK)(t)}}async function Sj(e,t,i,r){return e.memoize.getAsync({type:"render:getOwnerInfo",hostname:t,owner:i},r,e=>(0,m8.ru)(`${t}/render-ws/v1/owner/${i}/stacks`,e).then(e=>e.json()).then(SF))}async function SW(e,t,i){return e.memoize.getAsync({type:"render:getQueryParameterInfo",hostname:t},i,e=>(0,m8.ru)(`${t}/render-ws/swagger.json`,e).then(e=>e.json()).then(Sz))}let Sq=/^([^/?]+)(?:\/([^/?]+))?(?:\/([^/?]+))(?:\/([^/?]*))?(?:\?(.*))?$/,SH=/^((?:(?:(?:http|https):\/\/[^,/]+)[^/?]))\/(.*)$/;async function SJ(e,t,i,r){let n=i.match(/^(?:([^/]+)(?:\/([^/]*))?(?:\/([^/]*))?(\/.*?)?)?$/);if(null===n||void 0===n[2])throw null;let s=n[1].length+1;if(void 0===n[3])return{offset:s,completions:lj(n[2]||"",(await Sj(e,t,n[1],r)).projects,e=>e[0]+"/",()=>void 0)};if(s+=n[2].length+1,void 0===n[4]){let i=n[3]||"",a=(await Sj(e,t,n[1],r)).projects.get(n[2]);if(void 0===a)throw null;return{offset:s,completions:lj(i,a.stacks,e=>e[0]+"/",e=>e[1].project)}}s+=n[3].length+1;let a=n[4].substr(1)||"",o=(await Sj(e,t,n[1],r)).projects.get(n[2]);if(void 0===o)throw null;let l=o.stacks.get(n[3]);if(void 0===l)throw null;let d=l.channels;if(0===d.length)throw null;return{offset:s,completions:lj(a,d,e=>e,()=>void 0)}}async function SK(e,t,i,r){let n=await SW(e,t,r),s=i.lastIndexOf("&"),a=-1===s?0:s+1,[o]=i.slice(a).split("=");return{offset:a,completions:lj(o,n,e=>e.name,e=>e.type)}}async function SZ(e,t,i){let r=e.match(SH);if(null===r)throw null;let n=r[1],[s,a]=r[2].split("?"),o=r[1].length+1;return void 0===a?lz(o,await SJ(t,n,s,i)):lz(o+=s.length+1,await SK(t,n,a,i))}vf(new class{get scheme(){return"render"}get description(){return"Render"}get(e){return function(e,t,i){let r,n;{let e=t.match(SH);if(null===e)throw Error(`Invalid render volume path: ${JSON.stringify(t)}`);r=e[1],n=e[2]}let s=n.match(Sq);if(null===s)throw Error(`Invalid volume path ${JSON.stringify(n)}`);let a=s[1],o=s[2],l=s[3],d=s[4],u=(0,ef.Re)(s[5]||"");return e.memoize.getAsync({type:"render:MultiscaleVolumeChunkSource",hostname:r,path:n},i,async t=>{let i=await Sj(e,r,a,t),n=new SG(e,r,i,l,o,d,u),s=tw({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(n.stackInfo.voxelResolution,e=>e/1e9),boundingBoxes:[tP({lowerBounds:new Float64Array(n.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(n.stackInfo.upperVoxelBound)})]});return{modelTransform:tN(s),subsources:[{id:"default",default:!0,subsource:{volume:n}},{id:"bounds",default:!0,subsource:{staticAnnotations:e5(s.bounds)}}]}})}(e.registry.chunkManager,e.providerUrl,e)}completeUrl(e){return SZ(e.providerUrl,e.registry.chunkManager,e)}});let SY=new mW("vtk","VTK mesh");vm(SY),vf(new l8(SY));var SX=i(6363);function SQ(e,t,i){(0,ef.PT)(e);let r=(0,ef.uq)(e,"name",e=>t((0,ef.ZE)(e))),n=(0,ef.uq)(e,"configuration",e=>(void 0===e?e={}:(0,ef.PT)(e),i(e,r)));return{name:r,configuration:n}}function S0(e){let{name:t,configuration:i}=SQ(e,e=>{let t=S1.get(e);if(void 0===t)throw Error(`Unknown codec: ${JSON.stringify(e)}`);return t},e=>e);return{resolver:t,configuration:i}}let S1=new Map;function S2(e){S1.set(e.name,e)}function S3(e,t){let i=[],r=[],n=[],s=[];r.push(t);let a=(0,ef.m7)(e,S0),o=a.length,l=0;for(;l<o;++l){let{resolver:e,configuration:n}=a[l];if(e.kind!==SX.i.arrayToArray)break;let{configuration:s,encodedArrayInfo:o}=e.resolve(n,t);r.push(o),t=o,i.push({kind:SX.i.arrayToArray,name:e.name,configuration:s})}if(l===o||a[l].resolver.kind!==SX.i.arrayToBytes)throw Error("Missing array -> bytes codec");let{codecSpec:d,layoutInfo:u,encodedSize:c,shardingInfo:h}=(()=>{let{resolver:e,configuration:i}=a[l],{configuration:r,shardingInfo:n,encodedSize:s}=e.resolve(i,t);if(void 0!==n&&l+1!==o)throw Error("bytes -> bytes codecs not supported following sharding codec");let d=e.getDecodedArrayLayoutInfo(r,t);return{codecSpec:{name:e.name,kind:SX.i.arrayToBytes,configuration:r},layoutInfo:d,encodedSize:s,shardingInfo:n}})();n[l]=u,s.push(c);let p=[];for(++l;l<o;){let{resolver:e,configuration:t}=a[l];if(e.kind!==SX.i.bytesToBytes)throw Error(`Expected bytes -> bytes codec, but received ${JSON.stringify(e.name)} of kind ${SX.i[e.kind]}`);let{configuration:i,encodedSize:r}=e.resolve(t,c);p.push({name:e.name,kind:e.kind,configuration:i}),s.push(r),++l}for(let e=i.length-1;e>=0;--e)n[e]=a[e].resolver.getDecodedArrayLayoutInfo(i[e].configuration,r[e],n[e+1]);return{[SX.i.arrayToArray]:i,[SX.i.arrayToBytes]:d,[SX.i.bytesToBytes]:p,arrayInfo:r,layoutInfo:n,shardingInfo:h,encodedSize:s}}S2({name:"blosc",kind:SX.i.bytesToBytes,resolve:e=>((0,ef.PT)(e),{configuration:{}})}),S2({name:"zstd",kind:SX.i.bytesToBytes,resolve:e=>((0,ef.PT)(e),{configuration:{}})});var S4=i(6758);for(let e of(S2({name:"bytes",kind:SX.i.arrayToBytes,resolve(e,t){(0,ef.PT)(e);let i=(0,ef.uq)(e,"endian",e=>{switch(e){case"little":return ep.LITTLE;case"big":return ep.BIG;case void 0:if(1===eu[t.dataType])return eg}throw Error(`Invalid endian value: ${JSON.stringify(e)}`)}),r=t.chunkShape.reduce((e,t)=>e*t,1);return{configuration:{endian:i},encodedSize:eu[t.dataType]*r}},getDecodedArrayLayoutInfo:(e,t)=>({physicalToLogicalDimension:Array.from(t.chunkShape,(e,t)=>t),readChunkShape:t.chunkShape})}),S2({name:"crc32c",kind:SX.i.bytesToBytes,resolve(e,t){let i;return void 0!==t&&(i=t+4),{configuration:{},encodedSize:i}}}),["gzip","zlib"]))S2({name:e,kind:SX.i.bytesToBytes,resolve:e=>((0,ef.PT)(e),{configuration:{level:(0,ef.uq)(e,"level",ef.C$)}})});var S6=i(6252);let S5=new Map;for(let[e,t]of(S5.set("|u1",{endianness:ep.LITTLE,dataType:el.UINT8}),S5.set("|i1",{endianness:ep.LITTLE,dataType:el.INT8}),[["<",ep.LITTLE],[">",ep.BIG]])){for(let i of["u","i"])S5.set(`${e}${i}8`,{endianness:t,dataType:el.UINT64});S5.set(`${e}u2`,{endianness:t,dataType:el.UINT16}),S5.set(`${e}i2`,{endianness:t,dataType:el.INT16}),S5.set(`${e}u4`,{endianness:t,dataType:el.UINT32}),S5.set(`${e}i4`,{endianness:t,dataType:el.INT32}),S5.set(`${e}f4`,{endianness:t,dataType:el.FLOAT32})}function S8(e){return(0,ef.m7)(e,e=>{if("number"!=typeof e||!Number.isInteger(e)||e<0)throw Error(`Expected non-negative integer, but received: ${JSON.stringify(e)}`);return e})}function S9(e,t){return(0,ef.Iw)(Array(t),e,e=>{if("number"!=typeof e||!Number.isInteger(e)||e<=0)throw Error(`Expected positive integer, but received: ${JSON.stringify(e)}`);return e})}function S7(e){if("."!==e&&"/"!==e)throw Error(`Expected "." or "/", but received: ${JSON.stringify(e)}`);return e}let we=new Map([["",{unit:"",scale:1}],["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:3600}],["day",{unit:"s",scale:86400}]]);for(let e of["meter","second"])for(let t of te){let{longPrefix:i,prefix:r}=t;if(void 0===i)continue;let n={unit:e[0],scale:10**t.exponent};we.set(`${i}${e}`,n),we.set(`${r}${e[0]}`,n)}function wt(e){let t,i;if(null===e)return{scale:1,unit:""};if("string"!=typeof e)throw Error(`Expected string but received: ${JSON.stringify(e)}`);let r=e.trim(),n=r.match(/^([-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)(?:[eE][-+]?\d+)?)\s*(.*)/);null===n?(t=1,i=r):(t=Number(n[1]),i=n[2]);let s=we.get(i);if(void 0===s)throw Error(`Unsupported unit: ${JSON.stringify(i)}`);return{unit:s.unit,scale:t*s.scale}}function wi(e,t){switch(e){case el.UINT8:case el.INT8:case el.UINT16:case el.INT16:case el.UINT32:case el.INT32:case el.UINT64:if("number"!=typeof t||!Number.isInteger(t))throw Error(`Expected integer but received: ${JSON.stringify(t)}`);if(e===el.UINT64)return BigInt(t);return t;case el.FLOAT32:if("number"==typeof t)return t;if("string"==typeof t){if("Infinity"===t)return Number.POSITIVE_INFINITY;if("-Infinity"===t)return Number.NEGATIVE_INFINITY;if("NaN"===t)return new Float32Array(Uint32Array.of(0x7fc00000).buffer)[0];if(t.match(/^0x[a-fA-F0-9]+$/))return new Float32Array(Uint32Array.of(Number(t)).buffer)[0]}throw Error(`Expected number, "Infinity", "-Infinity", "NaN", or hex string but received: ${JSON.stringify(t)}`)}}var wr=((j={})[j.START=0]="START",j[j.END=1]="END",j);S2({name:"sharding_indexed",kind:SX.i.arrayToBytes,resolve(e,t){(0,ef.PT)(e);let i=(0,ef.uq)(e,"chunk_shape",e=>S9(e,t.chunkShape.length)),r=(0,ef.Kh)(e,"index_location",e=>(0,ef.CT)(e,wr,/^[a-z]+$/),1),n=Array.from(t.chunkShape,(e,r)=>{let n=i[r];if(e%n!=0)throw Error(`sub-chunk shape of ${JSON.stringify(n)} does not evenly divide outer chunk shape of ${JSON.stringify(t.chunkShape)}`);return e/n}),s=Array.from(n);s.push(2);let a=(0,ef.uq)(e,"index_codecs",e=>S3(e,{dataType:el.UINT64,chunkShape:s}));if(void 0===a.encodedSize[a.encodedSize.length-1])throw Error("index_codecs must specify fixed-size encoding");let o=(0,ef.uq)(e,"codecs",e=>S3(e,{dataType:t.dataType,chunkShape:i}));return{configuration:{indexCodecs:a,subChunkCodecs:o,subChunkShape:i,subChunkGridShape:n,indexLocation:r},shardingInfo:{subChunkShape:i,subChunkGridShape:n,subChunkCodecs:o}}},getDecodedArrayLayoutInfo:(e,t)=>e.subChunkCodecs.layoutInfo[0]}),S2({name:"transpose",kind:SX.i.arrayToArray,resolve(e,t){(0,ef.PT)(e);let{order:i,inverseOrder:r}=(0,ef.uq)(e,"order",e=>{let i=t.chunkShape.length,r=Array(i),n=Array(i);if("C"===e)for(let e=0;e<i;++e)r[e]=e,n[e]=e;else if("F"===e)for(let e=0;e<i;++e)r[e]=i-e-1,n[e]=i-e-1;else(0,ef.Iw)(r,e,(t,r)=>{if("number"!=typeof t||!Number.isInteger(t)||t<0||t>=i)throw Error(`Expected integer in range [0, ${i}) but received: ${JSON.stringify(t)}`);if(void 0!==n[t])throw Error(`Invalid permutation: ${JSON.stringify(e)}`);return n[t]=r,t});return{order:r,inverseOrder:n}}),n={dataType:t.dataType,chunkShape:Array.from(i,e=>t.chunkShape[e])};return{configuration:{encodedToDecoded:i,decodedToEncoded:r},encodedArrayInfo:n}},getDecodedArrayLayoutInfo:(e,t,i)=>({physicalToLogicalDimension:Array.from(i.physicalToLogicalDimension,t=>e.encodedToDecoded[t]),readChunkShape:Array.from(e.decodedToEncoded,e=>i.readChunkShape[e])})});let wn=new Set(["0.4","0.5-dev","0.5"]),ws=new Map([["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:3600}],["day",{unit:"s",scale:86400}]]);for(let e of["meter","second"])for(let t of te){let{longPrefix:i}=t;void 0!==i&&ws.set(`${i}${e}`,{unit:e[0],scale:10**t.exponent})}function wa(e){(0,ef.PT)(e);let t=(0,ef.uq)(e,"name",ef.ZE),i=(0,ef.Kh)(e,"type",ef.ZE),r=(0,ef.Kh)(e,"unit",e=>{let t=ws.get(e);if(void 0===t)throw Error(`Unsupported unit: ${JSON.stringify(e)}`);return t},{unit:"",scale:1});return{name:t,unit:r.unit,scale:r.scale,type:i}}function wo(e){let t=(0,ef.m7)(e,wa);return tw({names:t.map(e=>{let{name:t,type:i}=e;return"channel"===i?`${t}'`:t}),scales:Float64Array.from(t,e=>e.scale),units:t.map(e=>e.unit)})}let wl=new Map([["scale",function(e,t){let i=(0,ef.uq)(t,"scale",t=>(0,ef.Iw)(new Float64Array(e),t,ef.o7));return e9.Kt(Float64Array,i)}],["identity",function(e,t){return e9.XD(Float64Array,e+1)}],["translation",function(e,t){let i=(0,ef.uq)(t,"translation",t=>(0,ef.Iw)(new Float64Array(e),t,ef.jz));return e9.Z4(Float64Array,i)}]]);function wd(e,t){let i=e9.XD(Float64Array,e+1);return void 0===t||(0,ef.m7)(t,t=>{let r=function(e,t){(0,ef.PT)(t);let i=(0,ef.uq)(t,"type",ef.ZE),r=wl.get(i);if(void 0===r)throw Error(`Unsupported coordinate transform type: ${JSON.stringify(i)}`);return r(e,t)}(e,t);i=e9.Jp(new Float64Array(i.length),e+1,r,e+1,i,e+1,e+1,e+1,e+1)}),i}function wu(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(wu=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}class wc extends ls(mk(po),S4.Y){}class wh extends pd{sharedKvStoreContext;multiscale;volumeType;get dataType(){return this.multiscale.dataType}get modelSpace(){return this.multiscale.coordinateSpace}get rank(){return this.multiscale.coordinateSpace.rank}constructor(e,t){super(e.chunkManager),this.sharedKvStoreContext=e,this.multiscale=t,this.volumeType=pt.IMAGE}getSources(e){return(0,H.PK)(this.multiscale.scales.map(t=>{let{metadata:i}=t,{rank:r,codecs:n,shape:s}=i,a=n.layoutInfo[0].readChunkShape,{physicalToLogicalDimension:o}=i.codecs.layoutInfo[0],l=new Uint32Array(r),d=new Float32Array(r),u=new Float32Array((r+1)**2);u[(r+1)**2-1]=1;for(let e=0;e<r;++e){let t=o[r-1-e];l[e]=a[t],d[e]=s[t],u[e+t*(r+1)]=1}let c=new Float32Array((r+1)**2);return e9.Jp(c,r+1,t.transform,r+1,u,r+1,r+1,r+1,r+1),pn({rank:r,chunkToMultiscaleTransform:c,dataType:i.dataType,upperVoxelBound:d,volumeType:this.volumeType,chunkDataSizes:[l],volumeSourceOptions:e,fillValue:i.fillValue}).map(e=>({chunkSource:this.chunkManager.getChunkSource(wc,{sharedKvStoreContext:this.sharedKvStoreContext,spec:e,parameters:{url:t.url,metadata:i}}),chunkToMultiscaleTransform:c}))}))}}function wp(e,t,i,r){return e.chunkManager.memoize.getAsync({type:"zarr:json",url:t},r,async r=>{let n={stack:[],error:void 0,hasError:!1};try{!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(n,new iL.Vi(r.progressListener,{message:`Reading ${i} from ${t}`}),!1);let s=await e.kvStoreContext.read(t,r);if(void 0===s)return;return await s.response.json()}catch(e){n.error=e,n.hasError=!0}finally{wu(n)}})}let wg=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];async function wf(e,t,i){let r=await Promise.all(t.scales.map(async t=>{let r=await wm(e,t.url,{...i,expectedNodeType:"array"});if(void 0===r)throw Error(`zarr v{zarrVersion} array metadata not found at ${t.url}`);return r})),n=r[0].dataType,s=r.length,a=t.coordinateSpace.rank;for(let e=0;e<s;++e){let i=t.scales[e],s=r[e];if(s.rank!==a)throw Error(`Expected zarr array at ${JSON.stringify(i.url)} to have rank ${a}, but received: ${s.rank}`);if(s.dataType!==n)throw Error(`Expected zarr array at ${JSON.stringify(i.url)} to have data type ${el[n]}, but received: ${el[s.dataType]}`)}let o=new Float64Array(a),l=new Float64Array(a),d=t.scales[0],u=r[0];for(let e=0;e<a;++e){let t=o[e]=d.transform[(a+1)*a+e];l[e]=t+u.shape[e]}let c=tP({lowerBounds:o,upperBounds:l}),{coordinateSpace:h}=t;return{coordinateSpace:tw({names:h.names,units:h.units,scales:h.scales,boundingBoxes:[c]}),dataType:n,scales:t.scales.map((e,t)=>{let i=r[t];return{url:e.url,transform:e.transform,metadata:i}})}}async function wm(e,t,i){if(2===i.zarrVersion){let[r,n]=await Promise.all([wp(e,`${t}.zarray`,"zarr v2 array metadata",i),wp(e,`${t}.zattrs`,"zarr v2 attributes",i)]);if(void 0===r){if(void 0===n||"array"===i.expectedNodeType)return;return{zarrVersion:2,nodeType:"group",userAttributes:(0,ef.PT)(n)}}if("group"===i.expectedNodeType)return;return function(e,t,i){try{(0,ef.PT)(e),(0,ef.uq)(e,"zarr_format",e=>{(0,ef.j5)(e,2)});let r=(0,ef.uq)(e,"shape",S8),n=r.length,s=(0,ef.uq)(e,"chunks",e=>S9(e,n)),a=(0,ef.uq)(e,"order",e=>{if("C"!==e&&"F"!==e)throw Error(`Expected "C" or "F", but received: ${JSON.stringify(e)}`);return e}),o=(0,ef.Kh)(e,"dimension_separator",void 0===i?S7:e=>(0,ef.j5)(e,i),i??"."),l=(0,ef.uq)(e,"dtype",e=>(function(e){let t=S5.get(e);if(void 0===t)throw Error(`Unsupported numpy data type: ${JSON.stringify(e)}`);return t})((0,ef.ZE)(e))),d=l.dataType,u=(0,ef.uq)(e,"fill_value",e=>null===e?0:wi(d,e)),c=[];"F"===a&&c.push({name:"transpose",configuration:{order:Array.from(r,(e,t)=>n-t-1)}}),c.push({name:"bytes",configuration:{endian:l.endianness===ep.LITTLE?"little":"big"}}),(0,ef.uq)(e,"compressor",e=>{if(null===e)return;(0,ef.PT)(e);let t=(0,ef.uq)(e,"id",ef.ZE);switch(t){case"blosc":c.push({name:"blosc",configuration:{cname:(0,ef.uq)(e,"cname",ef.ZE),clevel:(0,ef.uq)(e,"clevel",ef.C$),typesize:eu[d],shuffle:(0,ef.uq)(e,"shuffle",e=>{switch(e){case -1:return 1===eu[d]?"bitshuffle":"shuffle";case 0:return"noshuffle";case 1:return"shuffle";case 2:return"bitshuffle"}throw Error(`Invalid value: ${JSON.stringify(e)}`)}),blocksize:(0,ef.Kh)(e,"blocksize",ef.C$,0)}});break;case"zlib":case"gzip":case"zstd":c.push({name:t,configuration:{level:(0,ef.uq)(e,"level",ef.C$)}});break;default:throw Error(`Unsupported compressor: ${JSON.stringify(t)}`)}});let h=S3(c,{dataType:d,chunkShape:s});return{zarrVersion:2,nodeType:"array",rank:n,shape:r,chunkShape:s,dataType:d,fillValue:u,dimensionNames:(0,ef.uq)(t,"_ARRAY_DIMENSIONS",e=>(0,ef.ah)(e,n)),dimensionUnits:(0,ef.uq)(t,"dimension_units",e=>(0,ef.ah)(e,n)),userAttributes:t,dimensionSeparator:o,chunkKeyEncoding:S6.$.V2,codecs:h}}catch(e){throw Error(`Error parsing zarr v2 metadata: ${e.message}`)}}(r,n??{},i.explicitDimensionSeparator)}if(3===i.zarrVersion){let r=await wp(e,`${t}zarr.json`,"zarr v3 metadata",i);if(void 0===r)return;if(void 0!==i.explicitDimensionSeparator)throw Error("dimension_separator query parameter not supported for zarr v3");return function(e,t){try{(0,ef.PT)(e),(0,ef.uq)(e,"zarr_format",e=>{(0,ef.j5)(e,3)});let i=(0,ef.uq)(e,"node_type",e=>{if(void 0!==t&&(0,ef.j5)(e,t),"array"!==e&&"group"!==e)throw Error(`Expected "array" or "group" but received: ${JSON.stringify(e)}`);return e});if(t=i,"group"===i)return{zarrVersion:3,nodeType:"group",userAttributes:(0,ef.Kh)(e,"attributes",ef.PT,{})};let r=(0,ef.uq)(e,"shape",S8),n=r.length,s=(0,ef.uq)(e,"dimension_names",e=>(0,ef.ah)(e??void 0,n)),a=(0,ef.uq)(e,"data_type",e=>(0,ef.CT)(e,el,/^[a-z0-9]+$/)),{configuration:o}=(0,ef.uq)(e,"chunk_grid",e=>SQ(e,e=>(0,ef.j5)(e,"regular"),e=>(0,ef.uq)(e,"chunk_shape",e=>S9(e,n)))),{userAttributes:l,dimensionUnits:d}=(0,ef.uq)(e,"attributes",e=>{void 0===e&&(e={}),(0,ef.PT)(e);let t=(0,ef.uq)(e,"dimension_units",e=>(0,ef.ah)(e,n));return{userAttributes:e,dimensionUnits:t}}),{configuration:u,name:c}=(0,ef.uq)(e,"chunk_key_encoding",e=>SQ(e,e=>(0,ef.CT)(e,S6.$,/^(v2|default)$/),(e,t)=>(0,ef.Kh)(e,"separator",S7,t===S6.$.DEFAULT?"/":"."))),h=(0,ef.uq)(e,"fill_value",e=>wi(a,e)),p=(0,ef.uq)(e,"codecs",e=>S3(e,{dataType:a,chunkShape:o}));return{zarrVersion:3,nodeType:i,rank:n,shape:r,chunkShape:o,dataType:a,fillValue:h,dimensionNames:s,dimensionUnits:d,chunkKeyEncoding:c,dimensionSeparator:u,userAttributes:l,codecs:p}}catch(i){let e=void 0===t?"":`${t} `;throw Error(`Error parsing zarr v3 ${e}metadata: ${i.message}`)}}(r,i.expectedNodeType)}let[r,n]=await Promise.all([wm(e,t,{...i,zarrVersion:2}),wm(e,t,{...i,zarrVersion:3})]);if(void 0!==r&&void 0!==n)throw Error("Both zarr v2 and v3 metadata found");return r??n}function wv(e){let{authorityAndPath:t,query:i,fragment:r}=(0,l0.DY)(e.url.suffix);if(i)throw Error(`Invalid URL ${JSON.stringify(e.url.url)}: query parameters not supported`);return{kvStoreUrl:(0,l0.J8)(e.kvStoreUrl),additionalPath:t??"",fragment:r}}class wy{zarrVersion;constructor(e){this.zarrVersion=e}get scheme(){return`zarr${this.zarrVersion??""}`}get expectsDirectory(){return!0}get description(){let e=void 0===this.zarrVersion?"":` v${this.zarrVersion}`;return`Zarr${e} data source`}get(e){let{kvStoreUrl:t,additionalPath:i,fragment:r}=wv(e);t=(0,l0.J8)((0,l0.Yq)(t,i));let n=(0,ef.Re)(r||"");(0,ef.PT)(n);let s=(0,ef.Kh)(n,"dimension_separator",S7);return e.registry.chunkManager.memoize.getAsync({type:"zarr:MultiscaleVolumeChunkSource",kvStoreUrl:t,dimensionSeparator:s},e,async i=>{let r;let{sharedKvStoreContext:n}=e.registry,a=await wm(n,t,{...i,zarrVersion:this.zarrVersion,explicitDimensionSeparator:s});if(void 0===a)throw Error("No zarr metadata found");if("group"===a.nodeType){let e=function(e,t,i){let r=t.ome,n=void 0==r?t.multiscales:r.multiscales;if(!Array.isArray(n))return;let s=[];for(let t of n){if("object"!=typeof t||null==t||Array.isArray(t))return;let n=void 0==r?t.version:r.version;if(void 0===n)return;if(!wn.has(n)){s.push(`OME multiscale metadata version ${JSON.stringify(n)} is not supported`);continue}if("0.5"===n&&3!==i){s.push(`OME multiscale metadata version ${JSON.stringify(n)} is not supported for zarr v${i}`);continue}return function(e,t){let i=(0,ef.uq)(t,"axes",wo),r=i.rank,n=(0,ef.uq)(t,"coordinateTransformations",e=>wd(r,e)),s=(0,ef.uq)(t,"datasets",t=>(0,ef.m7)(t,t=>{let i=function(e,t,i){let r=(0,ef.uq)(i,"path",ef.ZE);return{url:`${t}${r}/`,transform:(0,ef.uq)(i,"coordinateTransformations",t=>wd(e,t))}}(r,e,t);return i.transform=e9.Jp(new Float64Array((r+1)**2),r+1,n,r+1,i.transform,r+1,r+1,r+1,r+1),i}));if(0===s.length)throw Error("At least one scale must be specified");let a=s[0].transform,o=new Float64Array(r);for(let e=0;e<r;++e){let t=o[e]=a[e*(r+1)+e];i.scales[e]*=t}for(let e of s){let t=e.transform;for(let e=0;e<r;++e){let i=0;for(let n=0;n<r;++n)i+=.5*t[n*(r+1)+e];t[r*(r+1)+e]-=i}for(let e=0;e<r;++e)for(let i=0;i<=r;++i)t[i*(r+1)+e]/=o[e]}return{coordinateSpace:i,scales:s}}(e,t)}if(0!==s.length)throw Error(s[0])}(t,a.userAttributes,a.zarrVersion);if(void 0===e)throw Error("Neither array nor OME multiscale metadata found");r=await wf(n,e,{...i,zarrVersion:a.zarrVersion,explicitDimensionSeparator:s})}else r=function(e,t){let i=function(e,t){let i=new Set,r=2===t?"d":"dim_";return e.map((e,t)=>{if(null===e){let n=t;for(;;){if(e=`${r}${n}`,!i.has(e))return i.add(e),e;++n}}if(!i.has(e))return i.add(e),e;let n=1;for(;;){let t=`${e}${n}`;if(!i.has(t))return i.add(t),t;++n}})}(t.dimensionNames,t.zarrVersion),r=t.dimensionUnits.map(wt),n=tw({names:i,scales:Float64Array.from(Array.from(r,e=>e.scale)),units:Array.from(r,e=>e.unit),boundingBoxes:[tP({lowerBounds:new Float64Array(t.rank),upperBounds:Float64Array.from(t.shape)})]}),s=e9.XD(Float64Array,t.rank+1);return{coordinateSpace:n,dataType:t.dataType,scales:[{url:e,transform:s,metadata:t}]}}(t,a);let o=new wh(n,r);return{canonicalUrl:`${t}|zarr${a.zarrVersion}:`,modelTransform:tN(o.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:o}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:e5(o.modelSpace.bounds)}}]}})}async completeUrl(e){let{kvStoreUrl:t,additionalPath:i,fragment:r}=wv(e);if(void 0===r)return l2(e.registry.sharedKvStoreContext,{baseUrl:t,path:i,directoryOnly:!0,signal:e.signal,progressListener:e.progressListener});if(3===this.zarrVersion)throw Error("URL fragment parameters not supported");return lz(e.url.url.length-r.length,await lq(r,wg))}}for(let e of[new wy,new wy(2),new wy(3)])vm(e),vf(new l8(e));!function(e){e.registerDirectoryFormat((0,l3.HP)(new Set([".zarray",".zattrs"]),{suffix:"zarr2:",description:"Zarr v2 data source"}))}(vg),function(e){e.registerDirectoryFormat((0,l3.HP)(new Set(["zarr.json"]),{suffix:"zarr3:",description:"Zarr v3 data source"}))}(vg),i(7439),i(2298),i(8679);var wb=i(8580),wS=i(9858),ww=i(6249);class wC extends i${chunkManager;credentialsManager;kvStoreContext;constructor(e,t){super(),this.chunkManager=e,this.credentialsManager=t,this.kvStoreContext=new wb.e,this.initializeCounterpart(e.rpc,{chunkManager:e.rpcId,credentialsManager:t.rpcId}),wS.u.applyToContext(this),wx.applyToContext(this)}}wC=function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a}([ij(ww.F0)],wC);let wx=new wS.X;var wE=i(732);function wT(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(wT=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}async function wk(e,t={}){let i=(0,l0.kr)(e).base,{fetchOkImpl:r=m8.ru,signal:n,progressListener:s}=t,a=await r(e,{headers:{accept:"text/html"},signal:n,progressListener:s}),o=a.headers.get("content-type");if(null===o||null===/\btext\/html\b/i.exec(o))throw Error("HTML directory listing not supported");let l=await a.text();if((0,wE.xT)(l))throw Error("HTML directory listing not supported, S3-compatible API detected");let d=new DOMParser().parseFromString(l,"text/html"),u=d.evaluate("//a/@href",d,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=new Set;for(let e=0,t=u.snapshotLength;e<t;++e){let t=u.snapshotItem(e).textContent;if(null===t)continue;let r=(0,l0.kr)(t).base;if(r){let e=new URL(r,i).toString();e.startsWith(i)&&e!==i&&c.add(e)}}return Array.from(c)}async function wD(e,t,i,r){let n={stack:[],error:void 0,hasError:!1};try{let{progressListener:s}=r;!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(n,s&&new iL.Vi(s,{message:`Requesting HTML directory listing for ${e}`}),!1);let{base:a,queryAndFragment:o}=(0,l0.kr)(e),l=a+(0,l0.aU)(t),d=l+o,u=d.match(/^([a-z]+:\/\/.*\/)([^/?#]*)$/);if(null===u)throw Error(`Invalid HTTP URL: ${d}`);let[,c]=u,h=await wk(c+o,{fetchOkImpl:i,signal:r.signal,progressListener:r.progressListener}),p=[],g=[];for(let e of h){if(!e.startsWith(l))continue;let t=decodeURIComponent(e.substring(a.length));t.endsWith("/")?g.push(t.substring(0,t.length-1)):p.push({key:t})}return(0,lQ.Mt)({entries:p,directories:g})}catch(e){n.error=e,n.hasError=!0}finally{wT(n)}}class wL extends yT.Z{list(e,t){let{memoize:i}=this.sharedKvStoreContext.chunkManager,r=(0,wE.vi)(i,this.baseUrlForDisplay);return null===r?wD(this.baseUrl,e,this.fetchOkImpl,t):void 0!==r?(0,wE.g6)((0,l0.Lj)(this.baseUrl,e),this.baseUrlForDisplay,i,this.fetchOkImpl,t):Promise.any([wD(this.baseUrl,e,this.fetchOkImpl,t),(0,wE.g6)((0,l0.Lj)(this.baseUrl,e),this.baseUrlForDisplay,i,this.fetchOkImpl,t)])}}(0,yT.X)(wx,wL);let wI="refs/branch.main/ZZZZZZZZ.json",wP=new Set(["refs","snapshots"]),wR="branch.",wA="tag.";function wM(e){return e.length>0&&!e.includes("/")}async function wN(e,t,i){let r=await e.rpc.promiseInvoke(ww.cn,{sharedKvStoreContext:e.rpcId,url:t,byteRange:i.byteRange,throwIfMissing:i.throwIfMissing},{signal:i.signal,progressListener:i.progressListener});if(void 0!==r)return{response:new Response(r.data),offset:r.offset,length:r.data.byteLength,totalSize:r.totalSize}}function wV(e,t,i){return e.rpc.promiseInvoke(ww.aJ,{sharedKvStoreContext:e.rpcId,url:t},{signal:i.signal,progressListener:i.progressListener})}iB(ww.md,async function(e,t){let i=this.get(e.sharedKvStoreContext);return{value:await i.kvStoreContext.stat(e.url,t)}}),iB(ww.cn,async function(e,t){let i=this.get(e.sharedKvStoreContext),r=await i.kvStoreContext.read(e.url,{...t,byteRange:e.byteRange,throwIfMissing:e.throwIfMissing});if(void 0===r)return{value:void 0};let n=await r.response.arrayBuffer();return{value:{data:n,offset:r.offset,totalSize:r.totalSize},transfers:[n]}}),iB(ww.Bg,async function(e,t){let{store:i,path:r}=this.get(e.sharedKvStoreContext).kvStoreContext.getKvStore(e.url);return{value:await i.list(r,t)}}),iB(ww.aJ,async function(e,t){let i;let{kvStoreContext:r}=this.get(e.sharedKvStoreContext),{url:n}=e,s=(0,l0.kw)(n);if(s===n){let e=(0,l0.mq)(s),n=r.getBaseKvStoreProvider(e);void 0!==n.completeUrl&&(i=await n.completeUrl({url:e,...t}))}else{let e=(0,l0.mq)(s),a=r.getKvStoreAdapterProvider(e),o=n.slice(0,n.length-s.length-1),l=r.getKvStore(o);void 0!==a.completeUrl&&(i=await a.completeUrl({url:e,base:l,...t}))}return{value:i}});class wO{sharedKvStoreContext;constructor(e){this.sharedKvStoreContext=e}stat(e,t){var i,r;return i=this.sharedKvStoreContext,r=this.getUrl(e),i.rpc.promiseInvoke(ww.md,{sharedKvStoreContext:i.rpcId,url:r},{signal:t.signal,progressListener:t.progressListener})}read(e,t){return wN(this.sharedKvStoreContext,this.getUrl(e),t)}}class wF extends wO{list(e,t){var i,r;return i=this.sharedKvStoreContext,r=this.getUrl(e),i.rpc.promiseInvoke(ww.Bg,{sharedKvStoreContext:i.rpcId,url:r},{signal:t.signal,progressListener:t.progressListener})}}class wB extends wF{baseUrl;refSpec;constructor(e,t,i){super(e),this.baseUrl=t,this.refSpec=i}getUrl(e){return function(e,t){var i;let{baseUrl:r,refSpec:n}=e,s=void 0===n?"":`@${"branch"in(i=n)?wR+(0,l0.aU)(i.branch):"tag"in i?wA+(0,l0.aU)(i.tag):i.snapshot}/`;return r+`|icechunk:${s}${(0,l0.aU)(t)}`}(this,e)}get supportsOffsetReads(){return!0}get supportsSuffixReads(){return!0}}function w_(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0});return t}function wU(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(wU=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}async function w$(e,t){let i=new AbortController;t=AbortSignal.any([i.signal,t]);try{var r;let n=function(e,t,i){let r=window.outerHeight-window.innerHeight+window.innerHeight/2-325,n=window.innerWidth/2-200;return window.open(e,void 0,`toolbar=no, menubar=no, width=${400}, height=${650}, top=${r}, left=${n}`)}(`${e}/api/v1/authorize`,400,650);if(null===n)throw Error("Failed to create authentication popup window");return vL(n,i),await (0,iD.oi)((r=i.signal,new Promise((t,i)=>{window.addEventListener("message",r=>{if(r.source===n)try{let i=(0,ef.PT)(r.data),n=(0,ef.uq)(i,"token",ef.ZE),s=(0,ef.uq)(i,"app_urls",ef.zE);t({tokenType:"Bearer",accessToken:n,url:e,appUrls:s})}catch(e){i(Error(`Received unexpected authentication response: ${e.message}`)),console.error("Response received: ",r.data)}},{signal:r})})),t)}finally{i.abort()}}wx.registerKvStoreAdapterProvider(function(e){return{scheme:"icechunk",description:"Icechunk repository",getKvStore(t,i){let{baseUrl:r,version:n,path:s}=function(e,t){(0,l0.uh)(e);try{let[,i,r]=(e.suffix??"").match(/^(?:@([^/]*)(?:\/|$))?(.*)$/);return{baseUrl:t.store.getUrl((0,l0.V8)(t.path)),version:function(e){if(void 0!==e){if(e.startsWith(wR)){let t=e.substring(wR.length);if(!wM(t))throw Error(`Invalid branch name: ${JSON.stringify(t)}`);return{branch:decodeURIComponent(t)}}if(e.startsWith(wA)){let t=e.substring(wA.length);if(!wM(t))throw Error(`Invalid tag name: ${JSON.stringify(t)}`);return{tag:decodeURIComponent(t)}}if(null!==e.match(/^[0-9ABCDEFGHJKMNPQRSTVWXYZ]{20}$/))return{snapshot:e};throw Error(`Invalid ref spec: ${JSON.stringify(e)}`)}}(i),path:decodeURIComponent(r)}}catch(t){throw Error(`Invalid URL: ${e.url}`,{cause:t})}}(t,i);return{store:new wB(e,r,n),path:s}},completeUrl(t){let{base:i,url:r}=t;return wV(e,`${i.store.getUrl(i.path)}|${r.url}`,t)}}}),function(e){e.registerDirectoryFormat({fileNames:new Set([wI]),subDirectories:wP,match:async({fileNames:e,subDirectories:t})=>{if(!e.has(wI)){for(let e of wP)if(!t.has(e))return[]}return[{suffix:"icechunk:",description:"Icechunk repository"}]}})}(wx.autoDetectRegistry),(0,i(5139).X)(wx,wL);let wz="auth_token_v2";class wG extends vv{serverUrl;alreadyTriedLocalStorage;constructor(e){super(),this.serverUrl=e,this.alreadyTriedLocalStorage=!1,this.get=vb(async e=>{let t={stack:[],error:void 0,hasError:!1};try{var i,r;let n;if(!this.alreadyTriedLocalStorage&&(this.alreadyTriedLocalStorage=!0,n=function(e){let t=localStorage.getItem(`${wz}_${e}`);return t?JSON.parse(t):null}(this.serverUrl)))return n;return w_(t,new iL.Vi(e.progressListener,{message:`Waiting for middleauth login to ${this.serverUrl}`}),!1),n=await vk({description:`middleauth server ${this.serverUrl}`,requestDescription:"login",get:e=>w$(this.serverUrl,e)},e.signal),i=this.serverUrl,r=n,localStorage.setItem(`${wz}_${i}`,JSON.stringify(r)),n}catch(e){t.error=e,t.hasError=!0}finally{wU(t)}})}get}class wj extends Error{url;constructor(e){super(),this.url=e}}class wW extends vv{serverUrl;credentialsManager;credentials;constructor(e,t){super(),this.serverUrl=e,this.credentialsManager=t,this.credentials=void 0,this.get=vb(async e=>{let t;{let i={stack:[],error:void 0,hasError:!1};try{w_(i,new iL.Vi(e.progressListener,{message:`Determining authentication server for ${this.serverUrl}`}),!1);let r=await fetch(`${this.serverUrl}/auth_info`,{signal:e.signal});t=await r.json()}catch(e){i.error=e,i.hasError=!0}finally{wU(i)}}let i=this.credentialsManager.getCredentialsProvider("middleauth",t.login_url);if(this.credentials=await i.get(this.credentials,e),this.credentials.credentials.appUrls.includes(this.serverUrl))return this.credentials.credentials;throw new s1(!1).setText(`middleauth: unverified app ${this.serverUrl}`),new wj(this.serverUrl)})}get}function wq(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0});return t}function wH(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(wH=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}function wJ(e){return Error(`ngauth server ${e} does not allow requests from Neuroglancer instance ${self.origin}`)}async function wK(e,t){let i=new AbortController;t=AbortSignal.any([i.signal,t]);try{var r,n,s;let a=window.open(`${e}/login?origin=${encodeURIComponent(self.origin)}`);if(null===a)throw Error("Failed to create authentication popup window");return vL(a,i),await (0,iD.oi)((r=e,n=a,s=i.signal,new Promise((e,t)=>{window.addEventListener("message",i=>{if(i.source!==n||(i.origin||i.originalEvent.origin)!==r)return;let{data:s}=i;if("badorigin"===i.data){t(wJ(r));return}try{(0,ef.PT)(s);let t=(0,ef.uq)(s,"token",ef.ZE);e({token:t})}catch(e){t(Error(`Received unexpected authentication response: ${e.message}`)),console.error("ngauth: Received unexpected message from ${serverUrl}",i)}},{signal:s})})),t)}finally{i.abort()}}vT("middleauth",e=>new wG(e)),vT("middleauthapp",(e,t)=>new wW(e,t)),i(8366);class wZ extends vv{serverUrl;constructor(e){super(),this.serverUrl=e,this.get=vb(async e=>{let t={stack:[],error:void 0,hasError:!1};try{wq(t,new iL.Vi(e.progressListener,{message:`Requesting ngauth login token from ${this.serverUrl}`}),!1);try{let t=await (0,m8.ru)(`${this.serverUrl}/token`,{method:"POST",credentials:"include",signal:e.signal});return{token:await t.text()}}catch(t){if(t instanceof m8.oo)switch(t.status){case 401:return await vk({description:`ngauth server ${this.serverUrl}`,requestDescription:"login",get:e=>wK(this.serverUrl,e)},e.signal);case 403:throw wJ(this.serverUrl)}throw t}}catch(e){t.error=e,t.hasError=!0}finally{wH(t)}})}get}class wY extends vv{ngauthCredentialsProvider;serverUrl;bucket;constructor(e,t,i){super(),this.ngauthCredentialsProvider=e,this.serverUrl=t,this.bucket=i,this.get=vb(async e=>{let t={stack:[],error:void 0,hasError:!1};try{wq(t,new iL.Vi(e.progressListener,{message:`Requesting access token for gs://${this.bucket} from ${this.serverUrl}`}),!1);let i=await (0,m5.q)(this.ngauthCredentialsProvider,`${this.serverUrl}/gcs_token`,{method:"POST",signal:e.signal},(e,t)=>({...t,body:JSON.stringify({token:e.token,bucket:this.bucket})}),e=>{let{status:t}=e;if(401===t)return"refresh";throw e});return{tokenType:"Bearer",accessToken:(await i.json()).token}}catch(e){t.error=e,t.hasError=!0}finally{wH(t)}})}get}vT("ngauth",e=>new wZ(e)),vT("ngauth_gcs",(e,t)=>new wY(t.getCredentialsProvider("ngauth",e.authServer),e.authServer,e.bucket));var wX=i(9922);class wQ extends wF{baseUrl;version;constructor(e,t,i){super(e),this.baseUrl=t,this.version=i}getUrl(e){return(0,wX.k)(this,e)}get supportsOffsetReads(){return!0}get supportsSuffixReads(){return!0}}wx.registerKvStoreAdapterProvider(function(e){return{scheme:"ocdbt",description:"OCDBT database",getKvStore(t,i){let{baseUrl:r,version:n,path:s}=(0,wX.r)(t,i);return{store:new wQ(e,r,n),path:s}},completeUrl(t){let{base:i,url:r}=t;return wV(e,`${i.store.getUrl(i.path)}|${r.url}`,t)}}}),function(e){e.registerDirectoryFormat((0,l3.HP)(new Set(["manifest.ocdbt"]),{suffix:"ocdbt:",description:"OCDBT database"}))}(wx.autoDetectRegistry);var w0=i(3126);function w1(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,i){var r=Error(i);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};return(w1=function(e){function i(i){e.error=e.hasError?new t(i,e.error,"An error was suppressed during disposal."):i,e.hasError=!0}var r,n=0;return function t(){for(;r=e.stack.pop();)try{if(!r.async&&1===n)return n=0,e.stack.push(r),Promise.resolve().then(t);if(r.dispose){var s=r.dispose.call(r.value);if(r.async)return n|=2,Promise.resolve(s).then(t,function(e){return i(e),t()})}else n|=1}catch(e){i(e)}if(1===n)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}class w2 extends w0.S{list(e,t){let i={stack:[],error:void 0,hasError:!1};try{let{progressListener:r}=t;if(!function(e,t,i){if(null!=t){var r,n;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(i){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose],i&&(n=r)}if("function"!=typeof r)throw TypeError("Object not disposable.");n&&(r=function(){try{n.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:r,async:i})}else i&&e.stack.push({async:!0})}(i,void 0===r?void 0:new iL.Vi(r,{message:`Listing prefix ${this.getUrl(e)}`}),!1),this.knownToBeVirtualHostedStyle)return(0,wE.ib)(this.baseUrl,e,this.fetchOkImpl,t);return(0,wE.g6)((0,l0.Lj)(this.baseUrl,e),this.baseUrlForDisplay,this.sharedKvStoreContext.chunkManager.memoize,this.fetchOkImpl,t)}catch(e){i.error=e,i.hasError=!0}finally{w1(i)}}}async function w3(e){let{suffix:t}=e;return void 0===t||void 0===function(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=e.length;for(let e=i-22;e>=0;--e){if(0x6054b50!==t.getUint32(e,!0)||t.getUint16(e+20,!0)!==i-e-22)continue;let r=t.getUint16(e+4,!0),n=t.getUint16(e+10,!0),s=t.getUint32(e+12,!0),a=t.getUint32(e+16,!0);return{eocdrOffset:e,diskNumber:r,entryCount:n,centralDirectorySize:s,centralDirectoryOffset:a}}}(t)?[]:[{suffix:"zip:",description:"ZIP archive"}]}(0,w0.X)(wx,w2),i(4606);class w4 extends wF{base;constructor(e,t){super(e),this.base=t}getUrl(e){return this.base.getUrl()+`|zip:${(0,l0.aU)(e)}`}get supportsOffsetReads(){return!0}get supportsSuffixReads(){return!0}}wx.registerKvStoreAdapterProvider(function(e){return{scheme:"zip",description:"ZIP archive",getKvStore:(t,i)=>((0,l0.uh)(t),{store:new w4(e,new lQ.f2(i.store,i.path)),path:decodeURIComponent(t.suffix??"")})}}),function(e){e.registerFileFormat({prefixLength:0,suffixLength:4118,match:w3})}(wx.autoDetectRegistry),i(2950);let w6=Symbol("SingleTextureVolumeChunk.textureUnit"),w5=Symbol("SingleTextureVolumeChunk.textureLayout");class w8 extends eh.gj{shaderKey;dataType;constructor(e,t){super(),this.shaderKey=e,this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",w6)}beginDrawing(e,t){let i=t.textureUnit(w6);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),t[w5]=null}endDrawing(e,t){e.bindTexture(rd[this.shaderSamplerType],null),t[w5]=null}bindChunk(e,t,i,r,n,s,a){let o=i.textureLayout;(t[w5]!==o||a)&&(t[w5]=o,this.setupTextureLayout(e,t,o,r,n,s)),e.bindTexture(rd[this.shaderSamplerType],i.texture)}beginSource(e,t){}}class w9 extends pl{texture=null;data;textureLayout;constructor(e,t){super(e,t),this.data=t.data}copyToGPU(e){if(super.copyToGPU(e),null===this.data)return;let t=this.texture=e.createTexture(),i=rd[this.chunkFormat.shaderSamplerType];e.bindTexture(i,t),this.setTextureData(e),e.bindTexture(i,null)}freeGPUMemory(e){super.freeGPUMemory(e),null!==this.data&&(e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null)}}class w7 extends eh.gj{chunkDataSize;textureDims;strides;textureShape;constructor(e,t,i){super(),this.chunkDataSize=t,this.textureDims=i;let r=t.length,n=0;for(let e of t)1!==e&&++n;let s=this.strides=new Uint32Array(r*i),a=3===i?e.max3dTextureSize:e.maxTextureSize,o=0,l=1,d=this.textureShape=new Uint32Array(this.textureDims);d.fill(1);for(let e=0;e<r;++e){let r;let u=t[e];if(1===u)continue;let c=u*l;c>a||1!==l&&o+n<i?(++o,l=u,r=1):(r=l,l=c),s[i*e+o]=r,d[o]=l}}static get(e,t,i){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${i}`,()=>new w7(e,t,i))}}let Ce=new Uint32Array(15);class Ct extends w8{textureDims;texelsPerElement;textureInternalFormat;textureFormat;texelType;arrayElementsPerTexel;arrayConstructor;samplerPrefix;shaderSamplerType;textureAccessHelper;static get(e,t,i){let r=`sliceview.UncompressedChunkFormat:${t}:${i}`;return e.memoize.get(r,()=>new Ct(e,t,r,i))}constructor(e,t,i,r){super(i,t),this.textureDims=r,ci(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${r}D`,this.textureAccessHelper=new ca("chunkData",r)}defineShader(e,t,i=!1){super.defineShader(e,t);let{textureDims:r}=this,n=`ivec${this.textureDims}`,{textureAccessHelper:s}=this,a=(4+t)*r;Ce.length<a&&(Ce=new Uint32Array(a)),e.addUniform(`highp ${n}`,"uVolumeChunkStrides",4+t);let o=s.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType),l=r6(this.dataType),d=`
${l} getDataValueAt(highp ivec3 p`;for(let e=0;e<t;++e)d+=`, highp int channelIndex${e}`;d+=`) {
  highp ${n} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let e=0;e<t;++e)d+=`
  offset += channelIndex${e} * uVolumeChunkStrides[${4+e}];
`;d+=`
  return readVolumeData(offset);
}
`,i?(e.addVertexCode(o),e.addVertexCode(d)):(e.addFragmentCode(o),e.addFragmentCode(d))}setupTextureLayout(e,t,i,r,n,s){let a=Ce,o=s.length,{strides:l}=i,d=r.length,{textureDims:u}=this;for(let e=0;e<u;++e){let t=0;for(let i=0;i<d;++i)t+=r[i]*l[i*u+e];a[e]=t}for(let e=0;e<3;++e){let t=n[e];if(!(t>=d))for(let i=0;i<u;++i)a[(e+1)*u+i]=l[t*u+i]}for(let e=0;e<o;++e){let t=s[e];if(-1===t)a.fill(0,(4+e)*u,(4+e+1)*u);else for(let i=0;i<u;++i)a[(4+e)*u+i]=l[t*u+i]}let c=(4+o)*u;3===u?e.uniform3iv(t.uniform("uVolumeChunkStrides"),a,0,c):e.uniform2iv(t.uniform("uVolumeChunkStrides"),a,0,c)}getTextureLayout(e,t){return w7.get(e,t,this.textureDims)}setTextureData(e,t,i){let{textureShape:r}=t;(3===this.textureDims?function(e,t,i,r,n,s){let{arrayConstructor:a,textureInternalFormat:o,textureFormat:l,texelsPerElement:d}=t;i.constructor!==a&&(i=new a(i.buffer,i.byteOffset,i.byteLength/a.BYTES_PER_ELEMENT)),e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,o,r*d,n,s,0,l,t.texelType,i)}:function(e,t,i,r,n){let{arrayConstructor:s,textureInternalFormat:a,textureFormat:o,texelsPerElement:l}=t;i.constructor!==s&&(i=new s(i.buffer,i.byteOffset,i.byteLength/s.BYTES_PER_ELEMENT)),e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),rS(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,a,r*l,n,0,o,t.texelType,i)})(e,this,i,r[0],r[1],r[2])}}class Ci extends w9{setTextureData(e){let t;let{source:i}=this,{chunkFormatHandler:r}=i,{chunkFormat:n}=r;this.chunkDataSize===i.spec.chunkDataSize?this.textureLayout=t=r.textureLayout.addRef():this.textureLayout=t=n.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,t,this.data)}getValueAt(e){let{data:t}=this;if(null===t)return this.source.spec.fillValue;let{chunkDataSize:i}=this,r=0,n=1,s=e.length;for(let t=0;t<s;++t)r+=n*e[t],n*=i[t];return t[r]}}class Cr extends eh.gj{textureLayout;texture}class Cn extends eh.gj{chunkFormat;textureLayout;fillValueChunk;constructor(e,t){super();let i=0;for(let e of t.chunkDataSize)e>1&&++i;let r=i>=3?3:2;this.chunkFormat=this.registerDisposer(Ct.get(e,t.dataType,r)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.UncompressedChunkFormat.fillValue:${t.chunkDataSize.length}:${t.dataType}:${t.fillValue}:${r}`,()=>(function(e,t,i,r,n){let{dataType:s}=t,a=ec[s].of(i),o=new Uint32Array(r);o.fill(1);let l=new w7(e,o,n);l.strides.fill(0);let d=e.createTexture(),u=rd[t.shaderSamplerType];e.bindTexture(u,d),t.setTextureData(e,l,a),e.bindTexture(u,null);let c=new Cr;return c.textureLayout=l,c.texture=d,c})(e,this.chunkFormat,t.fillValue,t.chunkDataSize.length,r)))}getChunk(e,t){let i=new Ci(e,t);return null===i.data&&(i.texture=this.fillValueChunk.texture,i.textureLayout=this.fillValueChunk.textureLayout),i}}function Cs(e,t,i,r,n,s){let a=0,o=0,l=1,d=1;for(let e=0;e<3;++e){let t=n[e],s=r[e],u=Math.floor(t/s),c=t%s;a+=u*l,l*=Math.ceil(i[e]/s),o+=c*d,d*=s}let u=t+2*a,c=e[u],h=e[u+1],p=0xffffff&c,g=c>>24&255;if(g>0){let i=e[(t+h&0xffffff)+Math.floor(o*g/32)];p+=s*(i>>o*g%32&(1<<g)-1)}return p}W=(e,t)=>null==t.compressedSegmentationBlockSize?new Cn(e,t):null,pa.push(W);class Ca extends eh.gj{subchunkGridSize;singleton;constructor(e,t){super();let i=this.subchunkGridSize=Z.R3.create();for(let r=0;r<3;++r)i[r]=Math.ceil(e[r]/t[r]);this.singleton=!1}static get(e,t,i){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${(0,Z.m0)(t)},${(0,Z.m0)(i)}`,()=>new Ca(t,i))}}let Co=ci(new u0,el.UINT32),Cl=new Uint32Array(16);class Cd extends w8{subchunkSize;numChannels;static get(e,t,i,r){let n=`sliceview.CompressedSegmentationChunkFormat:${t}:${r}`,s=`${n}:${(0,Z.m0)(i)}`;return e.memoize.get(s,()=>new Cd(t,i,r,n))}textureAccessHelper;get shaderSamplerType(){return"usampler2D"}constructor(e,t,i,r){super(r,e),this.subchunkSize=t,this.numChannels=i,this.textureAccessHelper=new cs("chunkData")}defineShader(e,t){super.defineShader(e,t);let i=4*(4+t);Cl.length<i&&(Cl=new Uint32Array(i));let{textureAccessHelper:r}=this;r.defineShader(e),e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(rZ);let{dataType:n}=this,s=r6(n);n===el.UINT64?e.addFragmentCode(rN):e.addFragmentCode(rJ),e.addFragmentCode(r.getAccessor("compressedSegmentationChunkFormat_readTextureValue","uVolumeChunkSampler",el.UINT32,1));let a=`
uint compressedSegmentationChunkFormat_getChannelOffset(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return compressedSegmentationChunkFormat_readTextureValue(uint(channelIndex)).value;
}
${s} getDataValueAt(highp ivec3 p`;for(let e=0;e<t;++e)a+=`, highp int channelIndex${e}`;a+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let e=0;e<t;++e)a+=`
  chunkPositionFull += channelIndex${e} * uVolumeChunkStrides[${4+e}];
`;a+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(compressedSegmentationChunkFormat_getChannelOffset(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = compressedSegmentationChunkFormat_readTextureValue(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = compressedSegmentationChunkFormat_readTextureValue(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = compressedSegmentationChunkFormat_readTextureValue(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===el.UINT64?"2u":"1u"};
  }
  ${s} result;
`,n===el.UINT64?a+=`
  result.value[0] = compressedSegmentationChunkFormat_readTextureValue(outputValueOffset).value;
  result.value[1] = compressedSegmentationChunkFormat_readTextureValue(outputValueOffset+1u).value;
`:a+=`
  result.value = compressedSegmentationChunkFormat_readTextureValue(outputValueOffset).value;
`,a+=`
  return result;
}
`,e.addFragmentCode(a)}setupTextureLayout(e,t,i,r,n,s){let{subchunkGridSize:a}=i;e.uniform3i(t.uniform("uSubchunkGridSize"),a[0],a[1],a[2]);let o=Cl,l=s.length;if(o.fill(0),!i.singleton){for(let e=0;e<3;++e){o[e]=r[e];let t=n[e];-1!==t&&(o[4*(e+1)+t]=1)}for(let e=0;e<l;++e){let t=s[e];-1!==t&&(o[4*(4+e)+t]=1)}}e.uniform4iv(t.uniform("uVolumeChunkStrides"),o,0,(l+4)*4)}setTextureData(e,t,i){cr(e,Co,i)}getTextureLayout(e,t){return Ca.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);let{subchunkSize:i}=this;e.uniform3i(t.uniform("uSubchunkSize"),i[0],i[1],i[2])}}class Cu extends w9{setTextureData(e){let{data:t}=this,{chunkFormat:i}=this,r=this.textureLayout=i.getTextureLayout(e,this.chunkDataSize);i.setTextureData(e,r,t)}getValueAt(e){var t;let{chunkDataSize:i,chunkFormat:r}=this,{data:n}=this;if(null===n)return this.source.spec.fillValue;let s=n[e[3]||0];return r.dataType===el.UINT64?BigInt(n[t=Cs(n,s,i,r.subchunkSize,e,2)+s])|BigInt(n[t+1])<<32n:n[Cs(n,s,i,r.subchunkSize,e,1)+s]}}class Cc extends eh.gj{textureLayout;texture}class Ch extends eh.gj{chunkFormat;fillValueChunk;constructor(e,t){super();let{dataType:i}=t;if(i!==el.UINT64&&i!==el.UINT32)throw Error(`Unsupported compressed segmentation data type: ${el[i]}`);this.chunkFormat=this.registerDisposer(Cd.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.CompressedSegmentationChunkFormat.fillValue:${t.dataType}:${t.fillValue}:${this.chunkFormat.numChannels}`,()=>(function(e,t,i){let{dataType:r,numChannels:n}=t,s=new Uint32Array(n+2+(r===el.UINT64?2:1));s[0]=n,s[n]=2,r===el.UINT64?(s[n+2]=Number(4294967295n&i),s[n+3]=Number(i>>32n)):s[n+2]=i;let a=new Ca(Uint32Array.of(1,1,1),Z.R3.fromValues(1,1,1));a.singleton=!0;let o=e.createTexture(),l=rd[t.shaderSamplerType];e.bindTexture(l,o),t.setTextureData(e,a,s),e.bindTexture(l,null);let d=new Cc;return d.textureLayout=a,d.texture=o,d})(e,this.chunkFormat,t.fillValue)))}getChunk(e,t){let i=new Cu(e,t);return null===i.data&&(i.texture=this.fillValueChunk.texture,i.textureLayout=this.fillValueChunk.textureLayout),i}}q=(e,t)=>null!=t.compressedSegmentationBlockSize?new Ch(e,t):null,pa.push(q),i(4636),i(9308),i(5995);var Cp=i(4649);function Cg(e,t=e.value){e.style.minWidth=t.length+1+"ch"}let Cf="neuroglancer-coordinate-space-transform-singleton";function Cm(e,t,i){let r,n;return i&&(e+=.5,t+=.5),{lower:e===Number.NEGATIVE_INFINITY?"(-∞,":`[${Math.floor(e)},`,upper:t===Number.POSITIVE_INFINITY?"+∞)":`${Math.floor(t)})`}}let Cv=se.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function Cy(){let e=document.createElement("div"),t=document.createElement("input");e.classList.add("neuroglancer-coordinate-space-transform-scale-container"),t.spellcheck=!1,t.autocomplete="off",t.size=1,t.classList.add("neuroglancer-coordinate-space-transform-scale"),e.appendChild(t);let i=document.createElement("div"),r=document.createElement("span");r.innerHTML=Cp,i.appendChild(r);let n=document.createTextNode("");return i.appendChild(n),i.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),e.appendChild(i),{cellElement:e,inputElement:t,suggestionElement:i}}function Cb(e,t,i,r,n){if(void 0===t||t.scale===i&&t.unit===r)e.style.display="none";else{e.style.display="";let i=ta(t.scale,t.unit,{elide1:!1});e.lastChild.textContent=i,e.title=`${n}${i}`}}function CS(){let e=document.createElement("input");return e.spellcheck=!1,e.autocomplete="off",e.size=1,e.placeholder=" ",e.classList.add("neuroglancer-coordinate-space-transform-output-name"),e}function Cw(e,t,i){let r=e.map(e=>to(e.value));if(r.includes(void 0))return!1;let n=Float64Array.from(r,e=>e.scale),s=Array.from(r,e=>e.unit),a=i.value,{scales:o,units:l,rank:d}=a;for(let e=0;e<d;++e)t[e]||(n[e]=o[e],s[e]=l[e]);if((0,H.cO)(o,n)&&(0,H.cO)(l,s))return!1;let u=a.timestamps.map((e,t)=>n[t]===o[t]&&s[t]===l[t]?e:Date.now()),c=tw({valid:a.valid,rank:a.rank,scales:n,units:s,timestamps:u,ids:a.ids,names:a.names,boundingBoxes:a.boundingBoxes,coordinateArrays:a.coordinateArrays});return i.value=c,!0}function CC(e,t,i,r){let n=new Float64Array(e.scales),s=Array.from(e.units);if(n[t]===i&&s[t]===r)return e;let a=Array.from(e.timestamps);return n[t]=i,s[t]=r,a[t]=Date.now(),{...e,scales:n,units:s,timestamps:a}}class Cx extends eh.gj{transform;localCombiner;globalCombiner;element;coefficientContainer;translationContainer;outputNameContainer;outputScaleContainer;inputNameContainer;inputScaleContainer;inputLowerBoundsContainer;inputUpperBoundsContainer;coefficientElements;inputNameElements;outputNameElements;outputScaleElements;outputScaleSuggestionElements;inputScaleSuggestionElements;inputScaleElements;inputBoundsElements;outputBoundsElements;addSourceDimensionIcon;addOutputDimensionIcon;addOutputDimensionCell;addOutputDimensionInput;inputScaleModified;outputScaleModified;curSourceRank;curRank;curTransform;addingSourceDimension;resetToIdentityButton;resetToDefaultButton;constructor(e,t,i){super(),this.transform=e,this.localCombiner=t,this.globalCombiner=i,this.element=document.createElement("div"),this.coefficientContainer=document.createElement("div"),this.translationContainer=document.createElement("div"),this.outputNameContainer=document.createElement("div"),this.outputScaleContainer=document.createElement("div"),this.inputNameContainer=document.createElement("div"),this.inputScaleContainer=document.createElement("div"),this.inputLowerBoundsContainer=document.createElement("div"),this.inputUpperBoundsContainer=document.createElement("div"),this.coefficientElements=[],this.inputNameElements=[],this.outputNameElements=[],this.outputScaleElements=[],this.outputScaleSuggestionElements=[],this.inputScaleSuggestionElements=[],this.inputScaleElements=[],this.inputBoundsElements=[],this.outputBoundsElements=[],this.addSourceDimensionIcon=sC({svg:gi,text:"S"}),this.addOutputDimensionIcon=sC({svg:gi,text:"V"}),this.addOutputDimensionCell=document.createElement("div"),this.addOutputDimensionInput=CS(),this.inputScaleModified=[],this.outputScaleModified=[],this.curSourceRank=-1,this.curRank=-1,this.curTransform=void 0,this.addingSourceDimension=!1,this.resetToIdentityButton=sC({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{let{transform:e}=this,t=e.value.rank;e.transform=(0,e9.XD)(Float64Array,t+1)}}),this.resetToDefaultButton=sC({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{let{transform:e}=this;if(e.mutableSourceRank)return;let{defaultTransform:t}=e,{outputSpace:i}=t,r=i.ids.map(()=>++tf);e.value={...t,outputSpace:{...i,ids:r}}}});let{element:r}=this;this.registerDisposer(new aM(r,Cv)).allShortcutsAreGlobal=!0,r.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new sa(r,Cv));let n=(0,io.H)(()=>this.updateView());this.registerDisposer(e.changed.add(n));let{coefficientContainer:s,translationContainer:a,outputNameContainer:o,inputNameContainer:l,inputScaleContainer:d,inputLowerBoundsContainer:u,inputUpperBoundsContainer:c,outputScaleContainer:h,addOutputDimensionCell:p,addOutputDimensionIcon:g,addSourceDimensionIcon:f,resetToIdentityButton:m,resetToDefaultButton:v}=this;s.style.display="contents",a.style.display="contents",o.style.display="contents",l.style.display="contents",d.style.display="contents",h.style.display="contents",u.style.display="contents",c.style.display="contents";let y=document.createElement("div");for(let[e,t]of(y.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),m.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),v.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),y.appendChild(m),y.appendChild(v),r.appendChild(y),[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]])){let i=document.createElement("div");i.classList.add(`neuroglancer-coordinate-space-transform-${e}-label`),i.classList.add("neuroglancer-coordinate-space-transform-label"),i.textContent=t,r.appendChild(i)}e.mutableSourceRank&&p.appendChild(f),p.appendChild(g),p.classList.add("neuroglancer-coordinate-space-transform-output-extend");let b="Embed in additional output dimension",S="Extend to additional source dimension";g.title=b,f.title=S,p.appendChild(this.addOutputDimensionInput),p.dataset.isActive="false",g.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=b,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),f.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=S,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),r.appendChild(s),r.appendChild(o),r.appendChild(l),r.appendChild(d),r.appendChild(h),r.appendChild(u),r.appendChild(c),s.appendChild(a),r.addEventListener("input",e=>{let{target:t}=e;if(t instanceof HTMLInputElement){Cg(t);let e=this.inputScaleElements.indexOf(t);if(-1!==e){this.inputScaleModified[e]=!0,this.updateScaleValidity(t);return}if(-1!==(e=this.outputScaleElements.indexOf(t))){this.outputScaleModified[e]=!0,this.updateScaleValidity(t);return}if(-1!==(e=this.outputNameElements.indexOf(t))){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(t)){this.updateCoefficientValidity(t);return}}});let w=(e,t,i)=>{ss(r,e,e=>{e.stopPropagation();let r=e.target;if(!(r instanceof HTMLInputElement)||0!==i&&(r.selectionStart!==r.selectionEnd||r.selectionStart!==(1===i?r.value.length:0)))return;let n=this.getElementGridPosition(r);if(void 0===n)return;let s=this.getElementByGridPosition(n.row+t,n.col+i);null!==s&&(s.focus(),e.preventDefault())})};w("move-up",-1,0),w("move-down",1,0),w("move-left",0,-1),w("move-right",0,1);let C=(e,t)=>{e.addEventListener("focusout",i=>{let{relatedTarget:r}=i;!(r instanceof Node&&e.contains(r))&&t(i)})};C(s,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),C(o,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),C(d,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),C(h,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),ss(r,"cancel",e=>{this.curTransform=void 0,this.updateView(),e.target.blur()}),ss(s,"commit",()=>{this.updateModelTransform()}),ss(o,"commit",()=>{this.updateModelOutputNames()}),ss(d,"commit",()=>{this.updateModelInputScales()}),ss(h,"commit",()=>{this.updateModelOutputScales()}),r.addEventListener("focusin",e=>{let{target:t}=e;t instanceof HTMLInputElement&&t.select()}),this.updateView()}updateWillBeDeletedAttributes(e){let{rank:t}=this.transform.value;void 0===e&&(e=Array(t)).fill(!1);let{coefficientElements:i,inputBoundsElements:r,inputScaleElements:n}=this;for(let s=0;s<t;++s){let a=e[s];for(let r=0;r<=t;++r){let n=i[t*r+s],o=r<t&&e[r];n.dataset.willBeDeleted=(a||o).toString()}n[s].dataset.willBeDeleted=a.toString();let{lower:o,upper:l}=r[s];o.dataset.willBeDeleted=a.toString(),l.dataset.willBeDeleted=a.toString()}}updateAddOutputDimensionCellStyle(){let{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(0!==e.value.length||document.activeElement===e).toString()}updateOutputNameValidity(){let{outputNameElements:e}=this,t=e.map(e=>e.value),{value:{sourceRank:i,rank:r},mutableSourceRank:n}=this.transform;if(e.length!==r+1)return;let s=t_(t),a=Array(r);a.fill(!1);for(let o=0;o<=r;++o){let r=s[o];0===t[o].length&&(n||o>=i)&&(r=!0,a[o]=!0),e[o].dataset.isValid=r.toString()}this.updateWillBeDeletedAttributes(a),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){let t=void 0!==to(e.value);e.dataset.isValid=t.toString()}updateCoefficientValidity(e){let t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{let t=this.outputNameElements.indexOf(e);if(-1!==t)return{row:t,col:-2}}{let t=this.inputScaleElements.indexOf(e);if(-1!==t)return{row:-1,col:t}}{let t=this.coefficientElements.indexOf(e),{rank:i}=this.transform.value;if(-1!==t)return{row:t%i,col:Math.floor(t/i)}}{let t=this.outputScaleElements.indexOf(e);if(-1!==t)return{row:t,col:-1}}}getElementByGridPosition(e,t){let{rank:i}=this.transform.value;return -1===e?t<0||t>=i?null:this.inputScaleElements[t]:-2===t?e<0||e>i?null:this.outputNameElements[e]:-1===t?e<0||e>=i?null:this.outputScaleElements[e]:e<0||e>=i||t<0||t>i?null:this.coefficientElements[t*i+e]}dimensionRefCount(e){return(tU(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return Cw(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return Cw(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){let e=this.outputNameElements.map(e=>e.value),{value:t,mutableSourceRank:i}=this.transform,{outputSpace:r,rank:n,sourceRank:s}=t;if(e.length!==n+1)return;let a=[],o=[],l=0!==e[n].length,d=s;for(let t=0;t<=n;++t){let r=e[t];if(0===r.length){if(t<s){if(!i)return!1;--d}continue}o.push(r),a.push(t)}if(!tB(o))return!1;let u=r.names;if(!l&&(0,H.cO)(u,o))return!0;let c=t.inputSpace,h=t.outputSpace,p=t.transform;if(l){let t,i;this.addingSourceDimension&&++d;let s=e[n],a=(tU(s)?this.localCombiner:this.globalCombiner).combined.value,o=a.names.indexOf(s);-1!==o?(t=a.units[o],i=a.scales[o]):(t="",i=1);let l=c.boundingBoxes.map(e=>tM(e,n,n+1));this.addingSourceDimension||l.push(tA(n+1,n)),c=tw({valid:c.valid,rank:n+1,names:[...c.names,""],ids:[...c.ids,++tf],timestamps:[...c.timestamps,Date.now()],scales:Float64Array.from([...c.scales,i]),units:[...c.units,t],boundingBoxes:l,coordinateArrays:[...c.coordinateArrays,void 0]}),h=tw({valid:r.valid,rank:n+1,names:[...r.names,s],ids:[...r.ids,++tf],timestamps:[...r.timestamps,Date.now()],scales:Float64Array.from([...r.scales,i]),units:[...r.units,t],coordinateArrays:[...r.coordinateArrays,void 0]}),p=(0,e9.w9)(new Float64Array((n+2)**2),n+1,p,n)}p=tK(Float64Array,p,c.rank,a,a),c=tQ(c,a);let g=(h=tQ(h,a)).ids.map((e,t)=>{let i=a[t];if(i===n)return e;let r=o[t],s=u[i];return r===s||1===this.dimensionRefCount(s)&&this.dimensionRefCount(r)===(u.includes(r)?1:0)?e:++tf}),f=h.timestamps.map((e,t)=>{let i=a[t];return i===n||o[t]===u[i]?e:Date.now()}),m={rank:(h={...h,names:o,ids:g,timestamps:f}).rank,sourceRank:d,outputSpace:h,inputSpace:c,transform:p};return this.transform.value=m,!0}updateModelTransform(){let e=this.coefficientElements,{rank:t}=this.transform.value,i=new Float64Array((t+1)**2);i[i.length-1]=1;for(let r=0;r<t;++r)for(let n=0;n<=t;++n){let s=parseFloat(e[n*t+r].value);if(!Number.isFinite(s))return!1;i[n*(t+1)+r]=s}return this.transform.transform=i,!0}updateViewOutputNames(){let{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;let{outputNameElements:i}=this,{names:r}=e;for(let e=0;e<t;++e){let t=i[e];t.value=r[e],t.dataset.isValid="true",Cg(t)}i[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){let{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:i}=this;for(let r=0;r<t;++r)for(let n=0;n<=t;++n){let s=i[n*t+r];s.value=e[n*(t+1)+r].toString(),s.dataset.isValid="true",Cg(s)}}ensureViewRankUpdated(){let e=this.transform.value,{rank:t}=e,i=e.sourceRank;if(this.curSourceRank===i&&this.curRank===t)return;let{inputBoundsElements:r,inputNameElements:n,inputScaleElements:s}=this,{element:a,coefficientElements:o,outputNameElements:l,outputScaleElements:d,outputScaleSuggestionElements:u,inputScaleSuggestionElements:c,outputBoundsElements:h,coefficientContainer:p,translationContainer:g,outputNameContainer:f,inputNameContainer:m,inputScaleContainer:v,inputLowerBoundsContainer:y,inputUpperBoundsContainer:b,outputScaleContainer:S}=this;a.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,a.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,sv(p),sv(g),p.appendChild(g),sv(f),sv(m),sv(v),sv(y),sv(b),sv(S),n.length=0,s.length=0,r.length=0,d.length=0,u.length=0,c.length=0,o.length=0,l.length=0,h.length=0;for(let e=0;e<t;++e){let t=t=>{t.classList.add("neuroglancer-coordinate-space-transform-input"),e>=i&&t.classList.add(Cf)};{let i=document.createElement("div");i.classList.add("neuroglancer-coordinate-space-transform-input-name"),t(i),i.style.gridRowStart="sourceNames",i.style.gridColumnStart=`sourceDim ${e+1}`,m.appendChild(i),n.push(i)}{let{cellElement:i,inputElement:r,suggestionElement:n}=Cy();i.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),t(i),i.style.gridRowStart="sourceScales",i.style.gridColumnStart=`sourceDim ${e+1}`,v.appendChild(i),s.push(r),c.push(n);let a=e;n.addEventListener("click",()=>{let e=t2(this.transform,a);void 0!==e&&(this.transform.inputSpace.value=CC(this.transform.inputSpace.value,a,e.scale,e.unit))})}{let i=document.createElement("div");t(i),i.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),i.style.gridRowStart="sourceLower",i.style.gridColumnStart=`sourceDim ${e+1}`,y.appendChild(i);let n=document.createElement("div");t(n),n.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),n.style.gridRowStart="sourceUpper",n.style.gridColumnStart=`sourceDim ${e+1}`,b.appendChild(n),r.push({lower:i,upper:n})}}for(let e=0;e<t;++e){for(let r=0;r<=t;++r){let n=document.createElement("input");n.classList.add("neuroglancer-coordinate-space-transform-coeff"),n.spellcheck=!1,n.autocomplete="off",n.size=1,n.style.gridRowStart=`outputDim ${e+1}`,n.placeholder=" ",n.style.gridColumnStart=`sourceDim ${r+1}`,o[r*t+e]=n,r===t?n.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):r===i&&n.classList.add(Cf),(r===t?g:p).appendChild(n)}{let{cellElement:t,suggestionElement:i,inputElement:r}=Cy();t.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),t.style.gridRowStart=`outputDim ${e+1}`,t.style.gridColumnStart="outputScales";let n=e;i.addEventListener("click",()=>{let{value:e}=this.transform,t=t1(e,n);void 0!==t&&(this.transform.outputSpace.value=CC(e.outputSpace,n,t.scale,t.unit))}),u.push(i),S.appendChild(t),d.push(r)}{let t=document.createElement("div");t.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),t.style.gridRowStart=`outputDim ${e+1}`,t.style.gridColumnStart="outputNames";let r=CS();r.title="Rebind to a different dimension",e>=i?r.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(r.title+=", or delete to remove source dimension"),r.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",l.push(r),f.appendChild(t),t.appendChild(r);let n=document.createElement("div");n.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),t.appendChild(n);let s=document.createElement("div");s.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),t.appendChild(s),h.push({lower:n,upper:s}),t.addEventListener("mousedown",e=>{e.target!==r&&(r.focus(),e.preventDefault())})}}l.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",f.appendChild(this.addOutputDimensionCell),this.curSourceRank=i,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;let{inputSpace:e,rank:t,sourceRank:i}=this.transform.value,{inputBoundsElements:r,inputNameElements:n,inputScaleElements:s,inputScaleSuggestionElements:a}=this,{names:o,scales:l,units:d,bounds:{lowerBounds:u,upperBounds:c,voxelCenterAtIntegerCoordinates:h}}=e;for(let e=0;e<t;++e){let t;let p=s[e],g=l[e],f=d[e];if(p.value=ta(g,f,{elide1:!1}),p.dataset.isValid="true",Cg(p),e<i){let i=o[e];i||(i=`${e}`),n[e].textContent=i,t=`source dimension ${i}`,p.title=`Override scale of ${t}`}else t="singleton dimension",p.title=`Set extent of ${t}`;let{lower:m,upper:v}=Cm(u[e],c[e],h[e]),y=r[e];y.lower.textContent=m,y.lower.title=`Lower bound of ${t}`,y.upper.title=`Upper bound of ${t}`,y.upper.textContent=v,Cb(a[e],t2(this.transform,e),g,f,`Revert scale of ${t} to `)}}updateViewOutputScales(){let{value:e}=this.transform,{rank:t,names:i,units:r,scales:n,bounds:{lowerBounds:s,upperBounds:a,voxelCenterAtIntegerCoordinates:o}}=e.outputSpace,{outputScaleElements:l,outputBoundsElements:d,outputScaleSuggestionElements:u}=this;for(let c=0;c<t;++c){let t=l[c],h=n[c],p=r[c];t.value=ta(h,p,{elide1:!1}),Cg(t);let g=i[c];t.dataset.isValid="true";let f=`Change coordinates of ${tU(g)?"local":"global"} dimension ${g}`;t.title=`${f} (does not rescale the source)`;let{lower:m,upper:v}=Cm(s[c],a[c],o[c]),y=d[c];y.lower.textContent=m,y.upper.textContent=v,Cb(u[c],t1(e,c),h,p,`${f} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){let{transform:{value:i,mutableSourceRank:r,defaultTransform:n}}=this,{rank:s}=i;this.resetToIdentityButton.style.visibility=e||!(0,e9.GU)(i.transform,s+1,s+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!r&&(e||t||!function(e,t){let{rank:i,sourceRank:r}=e;if(i!==t.rank||r!==t.sourceRank)return!1;let{inputSpace:n}=e,{inputSpace:s}=t;return!!((0,H.cO)(s.scales,n.scales)&&(0,H.cO)(s.units,n.units)&&(0,H.cO)(t.outputSpace.names,e.outputSpace.names))&&tj(e.transform,i,e.outputSpace.scales,t.transform,i,t.outputSpace.scales)}(n,i))?"visible":"hidden"}updateView(){let e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){sy(this.element),super.disposed()}}i(4939);class CE{element=document.createElement("ul");constructor(){this.element.classList.add("neuroglancer-progress")}spanElements=new Map;spans=new iL.QF;addSpan(e){if(1!==this.spans.add(e))return;let t=document.createElement("li");t.textContent=e.message,this.spanElements.set(e.id,t),this.element.appendChild(t)}removeSpan(e){if(0!==this.spans.deleteKey(e))return;let{spanElements:t}=this,i=t.get(e);t.delete(e),this.element.removeChild(i)}}let CT="neuroglancer-multiline-autocomplete-completion-active";function Ck(e){let t=document.createElement("div");return t.textContent=e.value,t}let CD={splitPattern:/.*/gs,getSeparatorNode:()=>document.createElement("wbr")};function CL(e){let t=document.createElement("div");t.className="neuroglancer-multiline-autocomplete-completion-with-description",t.textContent=e.value;let i=document.createElement("div");return i.className="neuroglancer-multiline-autocomplete-completion-description",i.textContent=e.description||"",t.appendChild(i),t}let CI=se.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}});class CP extends eh.gj{element=document.createElement("div");inputElement=document.createElement("span");hintElement=document.createElement("span");completionsVirtualList=void 0;onCommit=new eO.MZ;onInput=new eO.MZ;prevInputValue="";completionsVisible=!1;activeCompletionPromise=null;activeCompletionAbortController=void 0;activeCompletionProgressListener=void 0;completionErrorElement;hasFocus=!1;completionResult=null;dropdownContentsStale=!0;hasResultForDropdown=!1;commonPrefix="";completionDisabled=-1;disableCompletion(){let e=this.getSelectionRange();this.completionDisabled=void 0!==e&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){let e=window.getSelection();if(null===e||0===e.rangeCount)return;let t=e.getRangeAt(0),{inputElement:i}=this,r=document.createRange();r.setStart(i,0),r.setEnd(t.startContainer,t.startOffset);let n=r.toString().length;return{begin:n,end:n+e.toString().length}}setValueAndSelection(e,t){let i=-1!==this.completionDisabled;this.onInput.dispatch(e);let{inputElement:r,syntaxHighlighter:n}=this;sv(r);let s=0,a=void 0!==t?document.createRange():void 0,o=!0;for(let i of e.match(n.splitPattern)){if(!i)continue;o||r.appendChild(n.getSeparatorNode(i)),o=!1;let e=s+i.length,l=document.createTextNode(i);if(r.appendChild(l),void 0!==a){let{begin:i,end:r}=t;i>=s&&i<=e&&a.setStart(l,i-s),r>=s&&r<=e&&a.setEnd(l,r-s)}s=e}if(void 0!==a){o&&(a.setStart(r,0),a.setEnd(r,0));let e=window.getSelection();null!==e&&(e.removeAllRanges(),e.addRange(a))}this.completionDisabled=i&&void 0!==t&&t.end===t.begin?t.end:-1}activeIndex=-1;dropdownStyleStale=!0;scheduleUpdateCompletions;completer;resizeHandler=()=>{this.updateDropdownStyle()};resizeObserver=new ResizeObserver(this.resizeHandler);syntaxHighlighter;constructor(e){super(),this.completer=e.completer;let{delay:t=200,syntaxHighlighter:i=CD}=e;this.syntaxHighlighter=i;let r=this.scheduleUpdateCompletions=(0,ie.Z)(()=>{let e=this.activeCompletionAbortController=new AbortController,t=this.makeCompletionProgressListener(),i=this.activeCompletionPromise=this.completer({value:this.value,selectionRange:this.getSelectionRange()},e.signal,t);null!==i&&i.then(e=>{this.activeCompletionPromise===i&&(this.setCompletions(e),this.activeCompletionPromise=null,this.removeProgressListener())},e=>{this.activeCompletionPromise===i&&(this.removeProgressListener(),this.showCompletionError(e))})},t);this.registerDisposer(()=>{r.cancel()});let{element:n,inputElement:s,hintElement:a}=this;n.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(n),this.registerDisposer(()=>this.resizeObserver.unobserve(s)),s.contentEditable="true",s.spellcheck=!1,n.appendChild(s),n.appendChild(a),n.appendChild(document.createTextNode("​")),s.classList.add("neuroglancer-multiline-autocomplete-input"),a.classList.add("neuroglancer-multiline-autocomplete-hint"),s.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),s.addEventListener("copy",e=>{let{clipboardData:t}=e;if(null!==t){let e=window.getSelection();null!==e&&!e.isCollapsed&&e.containsNode(s,!0)&&t.setData("text/plain",e.toString())}e.preventDefault(),e.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{let e=this.getSelectionRange(),{completionDisabled:t}=this;(void 0===e||e.begin!==t||e.end!==t)&&(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),n.addEventListener("pointerdown",e=>{let{target:t}=e;if(t instanceof Node){if(s.contains(t))return;let{completionsVirtualList:e}=this;if(e?.element.contains(t))return}s===document.activeElement&&(this.moveCaretToEndOfInput(),e.stopPropagation(),e.preventDefault())}),n.addEventListener("click",()=>{s.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();let e=document.createRange(),{childNodes:t}=s;e.setStart(s,0),0===t.length?e.setEnd(s,0):e.setEndAfter(t[t.length-1]);let i=window.getSelection();null!==i&&(i.removeAllRanges(),i.addRange(e)),this.debouncedUpdateHintState()}});let o=this.registerCancellable((0,ie.Z)(()=>{if(document.activeElement===this.inputElement)return;this.hasFocus&&(this.hasFocus=!1,this.updateDropdown()),this.debouncedUpdateHintState();let e=window.getSelection();null!==e&&e.containsNode(this.inputElement,!0)&&e.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}));this.registerEventListener(this.inputElement,"blur",o),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0}),this.registerDisposer(new aM(s,CI)).allShortcutsAreGlobal=!0,ss(s,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),ss(s,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),ss(s,"home",()=>{this.moveCaretToBeginningOfInput()}),ss(s,"end",()=>{this.moveCaretToEndOfInput()}),ss(s,"choose-active-completion-or-prefix",e=>{this.selectActiveCompletion(!0)&&e.preventDefault()}),ss(s,"commit",e=>{if(this.selectActiveCompletion(!1))e.stopPropagation();else{let e=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,e)}}),ss(s,"cancel",e=>{e.stopPropagation(),this.cancel()&&(e.detail.preventDefault(),e.detail.stopPropagation())})}removeProgressListener(){void 0!==this.activeCompletionProgressListener&&(this.element.removeChild(this.activeCompletionProgressListener.element),this.activeCompletionProgressListener=void 0)}makeCompletionProgressListener(){let e=new CE;return this.element.appendChild(e.element),e.element.classList.add("neuroglancer-multiline-autocomplete-progress"),this.activeCompletionProgressListener=e,this.updateDropdownStyle(),e}showCompletionError(e){if(null===e)return;let t=document.createElement("div");this.completionErrorElement=t,t.classList.add("neuroglancer-multiline-autocomplete-error"),t.textContent=i9(e),this.element.appendChild(t),this.updateDropdownStyle()}shouldAttemptCompletion(){let{inputElement:e}=this;if(document.activeElement!==e)return!1;let t=this.getSelectionRange();return void 0!==t&&t.end===t.begin&&t.end!==this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}debouncedUpdateHintState=this.registerCancellable((0,ie.Z)(()=>this.updateHintState(),0));updateHintState(){if(this.debouncedUpdateHintState.cancel(),!this.shouldAttemptCompletion()){this.hideCompletions();return}let{value:e}=this;e!==this.prevInputValue&&(this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions())}handleDropdownClick(e){let{completionsVirtualList:t}=this;if(void 0===t)return;let i=t.element;for(let t=e.target;t instanceof HTMLElement&&t!==i;t=t.parentElement){let e=t.dataset.completionIndex;if(void 0!==e){this.selectCompletion(Number(e));break}}}cycleActiveCompletion(e){if(null===this.completionResult)return;let{activeIndex:t}=this,i=this.completionResult.completions.length;t=-1===t?e>0?0:i-1:(t+e+i)%i,this.setActiveIndex(t)}shouldShowDropdown(){let{completionResult:e}=this;return null!==e&&!!this.hasFocus&&this.hasResultForDropdown}updateDropdownStyle(){let e=this.completionsVirtualList?.element??this.activeCompletionProgressListener?.element??this.completionErrorElement;void 0!==e&&function(e,t,{horizontal:i=!1,vertical:r=!0,topMargin:n=6,bottomMargin:s=6,leftMargin:a=6,rightMargin:o=6,maxHeight:l=!0,maxWidth:d=!0}={}){let u=t.getBoundingClientRect();if(i){let t=e.ownerDocument.documentElement.clientWidth,i=u.right,r=t-u.left;i>r?(e.style.left="",e.style.right=`${t-u.right}px`,d&&(e.style.maxWidth=i-a+"px")):(e.style.right="",e.style.left=`${u.left}px`,d&&(e.style.maxWidth=r-o+"px"))}if(r){let t=e.ownerDocument.documentElement.clientHeight,i=u.top-n,r=t-u.bottom-s;e.style.left=`${u.left}px`,e.style.width=`${u.width}px`,e.style.maxWidth=`${u.width}px`,i>3*r?(e.style.top="",e.style.bottom=`${t-u.top}px`,l&&(e.style.maxHeight=i+"px")):(e.style.top=`${u.bottom}px`,e.style.bottom="",l&&(e.style.maxHeight=r+"px"))}}(e,this.element,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){void 0!==e&&e.dispose();let t=this.completionResult,{makeElement:i=Ck}=t;(e=this.completionsVirtualList=new gd({source:{length:t.completions.length,render:e=>{let r=t.completions[e],n=i.call(t,r);return n.classList.add("neuroglancer-multiline-autocomplete-completion"),n.dataset.completionIndex=`${e}`,this.activeIndex===e&&n.classList.add(CT),n}},selectedIndex:-1===this.activeIndex?void 0:this.activeIndex})).element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",e=>{this.inputElement.focus(),e.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);let{activeIndex:t}=this;-1!==t&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(void 0!==e&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let{completions:t}=e;if(0===t.length)return;let i=this.prevInputValue;if(void 0!==i){if(this.completionResult=e,1===t.length){let r=t[0];e.showSingleResult?this.hasResultForDropdown=!0:r.value.startsWith(i)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let t=e.defaultCompletion??function(e){let t=e[Symbol.iterator](),{value:i,done:r}=t.next();if(r)return"";let n=i.length;for(;n>0;){let{value:e,done:r}=t.next();if(r)break;let s=0;for(;s<n&&i.charCodeAt(s)===e.charCodeAt(s);++s);n=s}return i.substring(0,n)}(function*(){for(let t of e.completions)yield t.value}()),r=this.getCompletedValue(t);r.startsWith(i)&&(this.commonPrefix=r,this.setHintValue(r))}this.updateDropdown()}}setHintValue(e){let t=this.prevInputValue;if(void 0===t)return;e!==t&&e.startsWith(t)||(e=""),e=e.substring(t.length);let{hintElement:i,syntaxHighlighter:r}=this;sv(i);let n=!0;for(let t of e.match(r.splitPattern)){if(!t)continue;n||i.appendChild(r.getSeparatorNode(t)),n=!1;let e=document.createTextNode(t);i.appendChild(e)}}setActiveIndex(e){if(!this.dropdownContentsStale){let{activeIndex:t}=this,{completionsVirtualList:i}=this;if(void 0!==i){if(-1!==t){let e=i.getItemElement(t);void 0!==e&&e.classList.remove(CT)}if(-1!==e){let t=i.getItemElement(e);void 0!==t&&t.classList.add(CT),i.scrollItemIntoView(e)}}}-1!==e&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,i=this.prevInputValue;return void 0===i?"":i.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){let e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);let i=window.getSelection();null!==i&&(i.removeAllRanges(),i.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){let e=document.createRange(),{inputElement:t}=this,{childNodes:i}=t,r=i[i.length-1];void 0===r?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(r),e.setEndAfter(r));let n=window.getSelection();null!==n&&(n.removeAllRanges(),n.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(-1===t){if(!e)return!1;let{completionResult:i}=this;if(null!==i&&1===i.completions.length)t=0;else{let{commonPrefix:e}=this;return e.length>this.value.length&&(this.value=e,this.moveCaretToEndOfInput(),!0)}}let i=this.getCompletedValueByIndex(t);return this.value!==i&&(this.value=i,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0,this.activeCompletionAbortController?.abort(),this.activeCompletionAbortController=void 0,this.activeCompletionPromise=null,this.removeProgressListener()}clearCompletions(){if(this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,null!==this.completionResult){this.activeIndex=-1,this.completionResult=null,this.commonPrefix="";let{completionsVirtualList:e}=this;void 0!==e&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}let{completionErrorElement:e}=this;void 0!==e&&(this.element.removeChild(e),this.completionErrorElement=void 0)}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){let{completionsVirtualList:e}=this;void 0!==e&&e.dispose(),sy(this.element),this.cancelActiveCompletion(),super.disposed()}}let CR={splitPattern:/\|?[^|:/_]*(?:[:/_]+)?/g,getSeparatorNode:e=>{if(!e.startsWith("|")||!(e.length>1))return document.createElement("wbr");{let e=document.createElement("span");return e.classList.add("neuroglancer-multiline-autocomplete-linebreak"),e}}};class CA extends CP{dataSourceView;dirty;constructor(e){let{manager:t}=e.source.layer;super({completer:async({value:e},i,r)=>({...await t.dataSourceProviderRegistry.completeUrl({url:e,signal:i,progressListener:r}),makeElement:CL,showSingleResult:!0}),syntaxHighlighter:CR,delay:0}),this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new J.SN(!1);let i=e=>{e!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};i(""),this.onInput.add(i)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}}class CM extends eh.gj{model;element;generation;constructor(e){super(),this.model=e,this.element=document.createElement("ul"),this.generation=-1,this.element.classList.add("neuroglancer-layer-data-sources-source-messages");let t=this.registerCancellable((0,io.H)(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>sy(this.element)),this.updateView()}updateView(){let{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;let{element:i}=this;sv(i);let r=new Set;for(let t of e){let e=`${t.severity} ${t.message}`;if(r.has(e))continue;r.add(e);let n=document.createElement("li");i.appendChild(n),n.classList.add("neuroglancer-message"),n.classList.add(`neuroglancer-message-${iT[t.severity]}`),n.textContent=t.message}}}class CN extends eh.gj{loadedSubsource;element;constructor(e,t){super(),this.loadedSubsource=t,this.element=document.createElement("div");let{element:i}=this;i.classList.add("neuroglancer-layer-data-source-subsource");let r=document.createElement("label"),n=document.createElement("span"),s=()=>{r.dataset.isActive=(void 0!==t.activated||!t.enabled).toString()};s(),this.registerDisposer(t.isActiveChanged.add(s)),this.registerDisposer(e.enabledSubsourcesChanged.add(s));let a=this.registerDisposer(new i4({get value(){return t.enabled},set value(value){t.enabled=value,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));r.classList.add("neuroglancer-layer-data-sources-info-line"),r.appendChild(a.element);let o=document.createElement("span");o.classList.add("neuroglancer-layer-data-sources-source-id");let{id:l}=t.subsourceEntry;"default"!==l&&(o.textContent=l),r.appendChild(o),n.classList.add("neuroglancer-layer-data-sources-source-type");let d=this.registerDisposer(new CM(this.loadedSubsource.messages));i.appendChild(r),r.appendChild(n),i.appendChild(d.element);let u="",{subsource:c}=t.subsourceEntry,{volume:h}=c;if(h instanceof pd)u=`${el[h.dataType].toLowerCase()} volume`;else if(c.mesh instanceof hu)u="meshes (single-res.)";else if(c.mesh instanceof hm)u="meshes (multi-res.)";else if(c.mesh instanceof pe)u="skeletons";else if(void 0!==c.segmentPropertyMap)u="segment property map";else if(void 0!==c.local)switch(c.local){case lZ.annotations:u="Local annotations";break;case lZ.equivalences:u="local segmentation graph"}else void 0!==c.staticAnnotations?u="default annotations":void 0!==c.annotation?u="annotations":void 0!==c.singleMesh?u="single mesh":void 0!==c.segmentationGraph&&(u="segmentation graph");n.textContent=u}}class CV extends eh.gj{source;element;constructor(e){super(),this.source=e,this.element=document.createElement("div");let{element:t}=this,i=document.createElement("label");for(let r of(i.classList.add("neuroglancer-layer-data-sources-source-default"),i.appendChild(this.registerDisposer(new i4({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(value){if(e.enableDefaultSubsources===value)return;if(e.enableDefaultSubsources=value,value)for(let t of e.subsources)t.enabled=t.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}})).element),i.appendChild(document.createTextNode("Enable default subsource set")),i.title="Enable the default set of subsources for this data source.",t.appendChild(i),e.subsources))t.appendChild(this.registerDisposer(new CN(e,r)).element);let{transform:r}=e;if(r.mutableSourceRank||0!==r.value.sourceRank){let t=this.registerDisposer(new Cx(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(t.element)}this.registerDisposer(()=>sy(this.element))}}class CO extends eh.gj{tab;source;element;urlInput;seenGeneration;generation;loadedView;constructor(e,t){super(),this.tab=e,this.source=t,this.element=document.createElement("div"),this.seenGeneration=0,this.generation=-1;let i=this.urlInput=this.registerDisposer(new CA(this));i.onCommit.add((t,r)=>{let{source:n}=this,s=n.spec,a=this.source.layer;if(i.dirty.value=!1,t&&t===s.url){r&&void 0!==e.detectedLayerConstructor&&CF(n.layer);return}if(a instanceof d2)try{let e=a.manager.dataSourceProviderRegistry.suggestLayerName(t);e&&dX(a.managedLayer,e)}catch{}n.spec={...s,url:t,setManually:!0}});let{element:r}=this;r.classList.add("neuroglancer-layer-data-source"),r.appendChild(i.element),r.appendChild(this.registerDisposer(new CM(t.messages)).element);let n=new CE;r.appendChild(n.element),t.progressListener.addListener(n),this.registerDisposer(()=>t.progressListener.removeListener(n)),this.updateView()}updateView(){let e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;let{loadState:t}=this.source,{loadedView:i}=this;if(void 0!==i){if(i.source===t)return;i.dispose(),i=this.loadedView=void 0}t instanceof di&&(i=this.loadedView=new CV(t),this.element.appendChild(i.element))}disposed(){let{loadedView:e}=this;void 0!==e&&e.dispose(),sy(this.element),super.disposed()}}function CF(e){if(e instanceof d2){let t=e.detectedLayerConstructor;if(void 0!==t)return dY(e.managedLayer,t),!0}return!1}class CB extends sE{layer;generation;sourceViews;addDataSourceIcon;layerTypeDetection;layerTypeElement;dataSourcesContainer;reRender;constructor(e){super(),this.layer=e,this.generation=-1,this.sourceViews=new Map,this.addDataSourceIcon=gr({title:"Add additional data source"}),this.layerTypeDetection=document.createElement("div"),this.layerTypeElement=document.createElement("span"),this.dataSourcesContainer=document.createElement("div"),this.detectedLayerConstructor=void 0;let{element:t,dataSourcesContainer:i}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),i.classList.add("neuroglancer-layer-data-sources-container");let{addDataSourceIcon:r}=this;if(r.style.alignSelf="start",r.addEventListener("click",()=>{let e=this.layer.addDataSource(void 0);this.updateView();let t=this.sourceViews.get(e);void 0!==t&&t.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof d2){let{layerTypeDetection:i,layerTypeElement:r}=this;i.style.display="none",r.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),i.appendChild(document.createTextNode("Create as ")),i.appendChild(r),i.appendChild(document.createTextNode(" layer")),t.appendChild(i),i.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),i.addEventListener("click",()=>{CF(e)})}let n=this.reRender=(0,io.H)(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(n)),this.registerDisposer(this.visibility.changed.add(n)),this.updateView()}detectedLayerConstructor;updateLayerTypeDetection(){let e=(()=>{let e=this.layer;if(!(e instanceof d2))return;let t=e.detectedLayerConstructor;if(void 0!==t){for(let e of this.sourceViews.values())if(e.urlInput.dirty.value)return;return t}})();if(e===this.detectedLayerConstructor)return;let{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,void 0!==e){let{layerTypeElement:i}=this;i.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){let{sourceViews:e}=this;for(let t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;let e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;let t=Date.now(),{sourceViews:i}=this,{layer:r}=this;for(let[e,n]of(sS(this.dataSourcesContainer,(function*(){let e=!0,{dataSources:n}=r;for(let r of n){let s=i.get(r);void 0===s&&((s=new CO(this,r)).registerDisposer(s.urlInput.dirty.changed.add(this.reRender)),i.set(r,s)),s.seenGeneration=t,s.updateView();let a=r.spec.url;1===n.length&&""===a&&setTimeout(()=>{s.urlInput.inputElement.focus()},0),e=0===r.spec.url.length,yield s.element}e||(yield this.addDataSourceIcon)}).call(this)),i))n.seenGeneration!==t&&(n.dispose(),i.delete(e))}this.updateLayerTypeDetection()}}dx.push({id:"source",label:"Source",order:-100,getter:e=>new CB(e)}),i(7550);var C_=i(9648),CU=i(9158),C$=i(7317),Cz=i(4345),CG=i(754);class Cj extends eh.gj{gl;frameNumberCounter;worker;chunkQueueManager;chunkManager;get rpc(){return this.chunkQueueManager.rpc}constructor(e,t){super(),this.gl=e,this.frameNumberCounter=t,this.worker=new Worker(new URL(i.p+i.u("162"),i.b),Object.assign({},{type:"module"},{type:void 0})),this.chunkQueueManager=this.registerDisposer(new lt(new iU(this.worker,!0),this.gl,this.frameNumberCounter,{gpuMemory:new le({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new le({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new le({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new le({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new lr(this.chunkQueueManager))}}function CW(e,t){return i=>{i.style.flex=e,t(i)}}function Cq(e,t){return i=>{for(let r of(i.style.display="flex",i.style.flexDirection=e,t)){let e=i.ownerDocument.createElement("div");i.appendChild(e),r(e)}}}i(1167),i(5125);let CH=Z._E.create();function CJ(e,t){let i=Z._E.identity(CH),{globalPosition:r,displayDimensionRenderInfo:{canonicalVoxelFactors:n,displayDimensionIndices:s}}=e;for(let e=0;e<3;++e){let a=s[e];i[12+e]=-1===a?0:r[a],i[5*e]=t/n[e]}return Z._E.multiply(i,e.viewProjectionMat,i),i}class CK extends eh.gj{gl;vertexBuffer;colorBuffer;trivialColorShader;constructor(e){super(),this.gl=e,this.vertexBuffer=this.registerDisposer(rm.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.colorBuffer=this.registerDisposer(rm.fromData(e,new Float32Array([1,0,0,.5,1,0,0,.5,0,1,0,.5,0,1,0,.5,0,0,1,.5,0,0,1,.5]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(e.memoize.get("trivialColorShader",()=>{let t=new ru(e);return t.addVarying("vec4","vColor"),t.addOutputBuffer("vec4","v4f_fragColor",null),t.setFragmentMain("v4f_fragColor = vColor;"),t.addAttribute("vec4","aVertexPosition"),t.addAttribute("vec4","aColor"),t.addUniform("mat4","uProjectionMatrix"),t.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),t.build()}))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new CK(e))}draw(e,t=!0){let i=this.trivialColorShader,r=this.gl;i.bind(),r.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,e);let n=i.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(n,4);let s=i.attribute("aColor");this.colorBuffer.bindToVertexAttrib(s,4),t&&(r.colorMask(!1,!1,!1,!0),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),r.colorMask(!0,!0,!0,!0),r.enable(r.BLEND),r.blendFunc(r.ONE_MINUS_DST_ALPHA,r.DST_ALPHA)),r.lineWidth(1),r.drawArrays(r.LINES,0,6),t&&r.disable(r.BLEND),r.disableVertexAttribArray(n),r.disableVertexAttribArray(s)}}var CZ=i(9443);i(444);class CY{renderLayers=[null];pickData=[null];values=[0,0,0];nextPickID=1;clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,i=1,r=null){return this.register(e,i,t,r)}register(e,t=1,i=0n,r=null){let{renderLayers:n,values:s}=this,a=this.nextPickID;this.nextPickID+=t;let o=n.length;n[o]=e;let l=3*o;return s[l]=a,s[l+1]=Number(4294967295n&i),s[l+2]=Number(i>>32n),this.pickData[o]=r,a}setMouseState(e,t){let{renderLayers:i,values:r}=this,n=0,s=i.length-1;for(;n<s;){let e=Math.ceil(n+(s-n)/2);r[3*e]>t?s=e-1:n=e}let a=e.pickedRenderLayer=i[n],o=3*n,l=e.pickedOffset=t-r[o],d=e.pickedValue=(0,em.jT)(r[o+1],r[o+2]);e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;let u=this.pickData[n];null!==a&&a.updateMouseState(e,d,l,u)}}let CX=Math.PI/20;function CQ(e,t){return Math.sqrt(e*e+t*t)}function C0(e){let[t,i]=e;t.identifier>i.identifier&&([i,t]=[t,i]);let r=t.clientX-i.clientX,n=t.clientY-i.clientY;return{distance:CQ(r,n),angle:Math.atan2(r,n)}}class C1 extends eh.gj{target;eventMap;dispatch(e,t,i,r=t.eventPhase){sr(e,t,r,i,this.eventMap)}prevTouches;prevEvent;moved;prevAngle;rotated;prevDistance;pinched;prevCenterX;prevCenterY;translated;startHold;numPriorTaps;priorTapNumTouches;tapStartTime;tapEndTime;curTapNumTouches;handleTouchEvent(e){if(e.target!==this.target)return;e.preventDefault();let t=new Map,{prevTouches:i,prevEvent:r}=this,n=0,s=0;for(let i of e.targetTouches)t.set(i.identifier,i),n+=i.clientX,s+=i.clientY;for(let[e,r]of(n/=t.size,s/=t.size,i.entries())){let n=t.get(e);if(void 0===n)i.delete(e);else{let e=n.clientX-r.clientX,t=n.clientY-r.clientY;(Math.abs(e)>=10||Math.abs(t)>=10)&&(this.moved=!0)}}if(void 0===r||r.targetTouches.length!==t.size||0===t.size){if(this.moved=!1,"touchstart"===e.type)this.startHold(e,e.eventPhase,n,s),(void 0===r||0===r.targetTouches.length)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if("touchend"===e.type){let t=Date.now();if(0===e.targetTouches.length&&t-this.tapStartTime<400){(this.curTapNumTouches!==this.priorTapNumTouches||t-this.tapEndTime>=500)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=t,this.priorTapNumTouches=this.curTapNumTouches;let i={event:e,centerX:n,centerY:s};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,i)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=n,this.prevCenterY=s,this.translated=!1,2===t.size){let{distance:e,angle:i}=C0(t.values());this.prevDistance=e,this.prevAngle=i,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:a,prevCenterY:o,translated:l}=this,d=n-a,u=s-o;if(!1===l&&CQ(d,u)>=10&&(l=this.translated=!0),!0===l&&(0!==d||0!==u)){this.prevCenterX=n,this.prevCenterY=s;let i={event:e,deltaX:d,deltaY:u,centerX:n,centerY:s};this.dispatch(`touchtranslate${t.size}`,e,i)}if(2===t.size){let{distance:i,angle:r}=C0(t.values()),{pinched:a,rotated:o,prevDistance:l,prevAngle:d}=this;!1===a&&Math.abs(i-l)>=20&&(this.pinched=a=!0);let u=function(e,t){let i=2*Math.PI,r=Math.abs(e-t)%i;return Math.min(r,i-r)}(r,d);if(!1===o&&u>=CX&&(this.rotated=o=!0),!0===a&&i!==l){this.prevDistance=i;let t={event:e,distance:i,prevDistance:l,centerX:n,centerY:s};this.dispatch("touchpinch",e,t)}!0===o&&r!==d&&(this.prevAngle=r,this.dispatch("touchrotate",e,{event:e,centerX:n,centerY:s,angle:r,prevAngle:d}))}}constructor(e,t){super(),this.target=e,this.eventMap=t,this.prevTouches=new Map,this.moved=!1,this.prevAngle=0,this.rotated=!1,this.prevDistance=0,this.pinched=!1,this.prevCenterX=0,this.prevCenterY=0,this.translated=!1,this.startHold=this.registerCancellable((0,lX.Z)((e,t,i,r)=>{this.dispatch(`touchhold${e.targetTouches.length}`,e,{event:e,centerX:i,centerY:r},t)},1e3,{leading:!1,trailing:!0})),this.numPriorTaps=0,this.priorTapNumTouches=0,this.tapStartTime=0,this.tapEndTime=0,this.curTapNumTouches=0,this.registerEventListener(e,"touchstart",e=>{this.handleTouchEvent(e)}),this.registerEventListener(e,"touchmove",e=>{this.handleTouchEvent(e)}),this.registerEventListener(e,"touchend",e=>{this.handleTouchEvent(e)})}}let C2=Z.R3.create();class C3{pickIDs=new CY;viewportWidth=0;viewportHeight=0;invTransform=Z._E.create();frameNumber=-1}class C4{buffer=null;glWindowX=0;glWindowY=0;frameNumber;sync}let C6=(()=>{let e=(e,t)=>(e-5)**2+(t-5)**2,t=new Uint32Array(121),i=0;for(let r=0;r<11;++r)for(let n=0;n<11;++n)e(r,n)>25||(t[i++]=11*n+r);return(t=t.subarray(0,i)).sort((t,i)=>{let r=t%11,n=i%11;return e(r,(t-r)/11)-e(n,(i-n)/11)}),t})();function C5(e,t,i,r,n,s,a){let o=r-5,l=n-5;if(!(o>=0)||!(l>=0)||!(o+11<=s)||!(l+11<=a))for(let r=0;r<11;++r)for(let n=0;n<11;++n){let d=o+n,u=l+r;(d<0||u<0||d>=s||u>=a)&&(e[t+(11*u+d)*i]=0)}}class C8 extends iv{viewer;mouseX;mouseY;pickRequestPending;mouseStateForcer;isMovingToMousePosition;inputEventMap;pickingData;pickRequests;pickBufferContents;pickTimerId;cancelPickRequests(){let{gl:e}=this;for(let t of this.pickRequests){let{sync:i}=t;null!==i&&e.deleteSync(i),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){let{gl:t}=this,{buffer:i}=e;null===i?(i=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,i),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,3872,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,i);let{renderViewport:r}=this,n=this.mouseX-r.visibleLeftFraction*r.logicalWidth,s=r.height-(this.mouseY-r.visibleTopFraction*r.logicalHeight);this.issuePickRequest(n,s),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=n,e.glWindowY=s,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),-1===this.pickTimerId&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;let{pickRequests:a}=this;e!==a[0]&&(a[1]=a[0],a[0]=e),this.nextPickRequestTime=Date.now()+30}completePickInternal(e){let{gl:t}=this,{pickBufferContents:i}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,i),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);let{pickingData:r}=this,{frameNumber:n}=e;this.completePickRequest(e.glWindowX,e.glWindowY,i,r[0].frameNumber===n?r[0]:r[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let i,r=this.context.frameNumber,n=-1;e&&(n=--r-1);let{pickRequests:s}=this,{gl:a}=this,o=!1,l=!1;for(let e of s){let{sync:s}=e;if(null===s)continue;let{frameNumber:d}=e;if(!l&&d>=r-1){if(t||a.getSyncParameter(s,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(e),l=!0;else if(d!==n){o=!0;continue}}a.deleteSync(s),e.sync=null,i=e}let{pickTimerId:d}=this;o&&-1===d?this.scheduleCheckForPickRequestCompletion():o||-1===d||(window.clearTimeout(d),this.pickTimerId=-1),!e&&void 0!==i&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(i)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){let{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);let{pickingData:i}=this;i[0]=i[1];let r=this.context.frameNumber,n=i[1];if(n.frameNumber=r,n.viewportWidth=e,n.viewportHeight=t,n.pickIDs.clear(),!this.drawWithPicking(n)){n.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}nextPickRequestTime;pendingPickRequestTimerId;pendingPickRequestTimerExpired;canIssuePickRequest(){let e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:i}=this;return!(e<t)||(-1===i&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1)}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;let e=this.context.frameNumber,{gl:t}=this,{pickRequests:i}=this;for(let r of i){let{sync:i}=r;if(null!==i){if(!(r.frameNumber<e-1))continue;t.deleteSync(i)}this.issuePickRequestInternal(r);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}let i=this.context.frameNumber,r=this.pickingData[1];r.frameNumber===i&&this.renderViewport.width===r.viewportWidth&&this.renderViewport.height===r.viewportHeight&&(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}isMovingToMousePositionOnPick;constructor(e,t,i){super(e,t,i.visibility),this.viewer=i,this.mouseX=-1,this.mouseY=-1,this.pickRequestPending=!1,this.mouseStateForcer=()=>this.blockOnPickRequest(),this.isMovingToMousePosition=!1,this.pickingData=[new C3,new C3],this.pickRequests=[new C4,new C4],this.pickBufferContents=new Float32Array(968),this.pickTimerId=-1,this.nextPickRequestTime=0,this.pendingPickRequestTimerId=-1,this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,this.pickRequestPending&&this.attemptToIssuePickRequest()},this.isMovingToMousePositionOnPick=!1,this.inputEventMap=i.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),"undefined"!=typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP&&!0===NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new g4(t)),this.registerDisposer(new aM(t,this.inputEventMap)),this.registerDisposer(new sa(t,this.inputEventMap,e=>{this.onMousemove(e)})),this.registerDisposer(new C1(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",e=>{e.target!==t&&this.onMouseout()},!0),ss(t,"select-position",()=>{this.viewer.selectionDetailsState.select()}),ss(t,"snap",()=>{this.navigationState.pose.snap()}),ss(t,"zoom-in",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.zoomBy(.5)}),ss(t,"zoom-out",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.zoomBy(2)}),ss(t,"depth-range-decrease",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.depthRange.value*=.5}),ss(t,"depth-range-increase",()=>{this.context.flagContinuousCameraMotion(),this.navigationState.depthRange.value*=2});for(let e=0;e<3;++e){let i=Z.lA[e];for(let r of[-1,1]){let n=r<0?"-":"+";ss(t,`rotate-relative-${i}${n}`,()=>{this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateRelative(Z.nn[e],.1*r)});let s=Z.R3.create();ss(t,`${i}${n}`,()=>{this.context.flagContinuousCameraMotion();let{navigationState:t}=this;s[0]=0,s[1]=0,s[2]=0,s[e]=r,t.pose.translateVoxelsRelative(s)})}}for(let e of(ss(t,"zoom-via-wheel",e=>{this.context.flagContinuousCameraMotion();let t=e.detail;this.onMousemove(t,!1),this.zoomByMouse(sl(t))}),ss(t,"adjust-depth-range-via-wheel",e=>{this.context.flagContinuousCameraMotion();let t=e.detail;this.navigationState.depthRange.value*=sl(t)}),ss(t,"translate-via-mouse-drag",e=>{so(e.detail,(e,t,i)=>{this.context.flagContinuousCameraMotion(),this.translateByViewportPixels(t,i)})}),ss(t,"translate-in-plane-via-touchtranslate",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e;this.translateByViewportPixels(t.deltaX,t.deltaY)}),ss(t,"translate-z-via-touchtranslate",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e,{navigationState:i}=this;C2[0]=0,C2[1]=0,C2[2]=t.deltaY+t.deltaX,i.pose.translateVoxelsRelative(C2)}),[1,10]))ss(t,`z+${e}-via-wheel`,t=>{this.context.flagContinuousCameraMotion();let i=t.detail,{navigationState:r}=this,n=0!==i.deltaY?i.deltaY:i.deltaX;C2[0]=0,C2[1]=0,C2[2]=(n>0?-1:1)*e,r.pose.translateVoxelsRelative(C2)});ss(t,"move-to-mouse-position",()=>{let{mouseState:e}=this.viewer;e.updateUnconditionally()&&(this.navigationState.position.value=e.position)}),ss(t,"snap",()=>this.navigationState.pose.snap()),ss(t,"move-annotation",e=>{let{mouseState:t}=this.viewer,i=t.pickedAnnotationId,r=t.pickedAnnotationLayer;if(void 0!==r&&!r.source.readonly&&void 0!==i){e.stopPropagation();let n=r.source.getReference(i),s=n.value,a=o6(s.type),o=t.pickedOffset,{chunkTransform:{value:l}}=r;if(void 0!==l.error)return;let{layerRank:d}=l,u=new Float32Array(d);a.getRepresentativePoint(u,s,t.pickedOffset);let c=Z.K4.set(Z.K4.create(),0,0);t.updateUnconditionally()&&so(e.detail,(e,t,i)=>{Z.K4.add(c,c,[t,i]);let h=new Float32Array(d);e9.DC(h,l.chunkToLayerTransform,d+1,u,d);let{displayDimensionIndices:p}=this.navigationState.pose.displayDimensions.value;(function(e,t,i,r){let{globalToRenderLayerDimensions:n}=i;for(let i=0;i<3;++i){let s=0,a=r[i];if(-1!==a){let e=n[a];-1!==e&&(s=t[e])}e[i]=s}})(C2,h,l.modelTransform,p),this.translateDataPointByViewportPixels(C2,C2,c[0],c[1]),function(e,t,i,r){let{globalToRenderLayerDimensions:n}=i;for(let i=0;i<3;++i){let s=r[i];if(-1!==s){let r=n[s];-1!==r&&(e[r]=t[i])}}}(h,C2,l.modelTransform,p);let g=new Float32Array(d);e9.DC(g,l.layerToChunkTransform,d+1,h,d);let f=a.updateViaRepresentativePoint(s,g,o);r.source.update(n,f)},e=>{r.source.commit(n),n.dispose()})}}),ss(t,"delete-annotation",()=>{let{mouseState:e}=this.viewer,t=e.pickedAnnotationId,i=e.pickedAnnotationLayer;if(void 0!==i&&!i.source.readonly&&void 0!==t){let e=i.source.getReference(t);try{i.source.delete(e)}finally{e.dispose()}}}),ss(t,"zoom-via-touchpinch",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e;this.handleMouseMove(t.centerX,t.centerY);let i=t.prevDistance/t.distance;i>.1&&i<10&&this.zoomByMouse(i)})}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){let{element:i}=this,r=i.getBoundingClientRect(),n=e-(r.left+i.clientLeft),s=t-(r.top+i.clientTop),{mouseState:a}=this.viewer;a.pageX=e+window.scrollX,a.pageY=t+window.scrollY,a.setForcer(this.mouseStateForcer),this.updateMousePosition(n,s)}onMousemove(e,t=!0){let{element:i}=this;(!t||e.target===i)&&this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let{element:t}=this;if(e.target!==t||1!==e.targetTouches.length)return;let{clientX:i,clientY:r}=e.targetTouches[0];this.handleMouseMove(i,r)}disposed(){let{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);let{gl:t}=this;this.cancelPickRequests();let{pendingPickRequestTimerId:i}=this;for(let e of(-1!==i&&window.clearTimeout(i),this.pickRequests))t.deleteBuffer(e.buffer);super.disposed()}}let C9=[1.5,2,3,5,7.5,10];class C7{allowedSignificands=C9;targetLengthInPixels=0;physicalSizePerPixel=0;physicalBaseUnit;lengthInPixels;physicalLength;physicalUnit;prevPhysicalSizePerPixel=0;prevTargetLengthInPixels=0;prevPhysicalUnit="\0";update(){let{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;let i=t*e,r=Math.floor(Math.log10(i)),n=10**r,s=i/n,a=1;for(let e of this.allowedSignificands)if(Math.abs(e-s)<Math.abs(a-s))a=e;else break;let o=a*n,l=tn(o);return this.lengthInPixels=Math.round(o/e),this.physicalUnit=`${l.prefix}${this.physicalBaseUnit}`,this.physicalLength=a*10**(r-l.exponent),!0}}class xe extends eh.gj{gl;dimensions;texture;width;height;label;factor;priorOptions;prevLabel;constructor(e,t=new C7){super(),this.gl=e,this.dimensions=t,this.texture=null,this.width=0,this.height=0,this.label="",this.factor=1,this.priorOptions=void 0,this.prevLabel=""}update(e){let{dimensions:t,label:i}=this,{texture:r}=this;if(!t.update()&&null!==r&&e===this.priorOptions&&i===this.prevLabel)return;null===r&&(r=this.texture=this.gl.createTexture());let{width:n,height:s}=function(e,t,i,r,n){let s=document.createElement("canvas"),a=s.getContext("2d"),o=n.textHeightInPixels*n.scaleFactor,l=`bold ${o}px ${n.fontName}`;a.font=l,a.fillStyle="white";let d=`${r}${e.physicalLength} ${e.physicalUnit}`,u=a.measureText(d),c=Math.max(e.lengthInPixels,u.width),h=n.barHeightInPixels*n.scaleFactor,p=n.barTopMarginInPixels*n.scaleFactor,g=h+p+o,f=n.paddingInPixels*n.scaleFactor,m=g+2*f,v=c+2*f;return s.width=v,s.height=m,a.font=l,a.textAlign="center",a.fillStyle="rgba(0, 0, 0, 0.3)",a.fillRect(0,0,v,m),a.fillStyle="white",a.fillText(d,v/2,m-f-h-p),a.fillRect(f,m-f-h,e.lengthInPixels,h),t.activeTexture(WebGL2RenderingContext.TEXTURE0+t.tempTextureUnit),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),t.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),t.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),t.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),t.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),t.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),t.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),t.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,s),t.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),{width:v,height:m}}(t,this.gl,r,i,e);this.priorOptions=e,this.prevLabel=i,this.width=n,this.height=s}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}}class xt extends eh.gj{gl;scaleBarCopyHelper;scaleBars;constructor(e){super(),this.gl=e,this.scaleBars=[],this.scaleBarCopyHelper=this.registerDisposer(rR.get(this.gl));for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new xe(e)))}draw(e,t,i,r,n){let{scaleBars:s}=this,{displayRank:a,displayDimensionIndices:o,canonicalVoxelFactors:l,globalDimensionNames:d,displayDimensionUnits:u,displayDimensionScales:c}=t,{factors:h}=i,p=Math.min(n.maxWidthFraction*e.logicalWidth,n.maxWidthInPixels*n.scaleFactor),g=0;for(let e=0;e<a;++e){let t,i,n;let a=o[e],f=u[e],m=h[a];for(t=0;t<g&&((n=(i=s[t]).dimensions).physicalBaseUnit!==f||i.factor!==m);++t);t===g&&(++g,(i=s[t]).label="",n=i.dimensions,i.factor=m,n.physicalBaseUnit=f,n.targetLengthInPixels=p,n.physicalSizePerPixel=c[e]*r/l[e]),i.label+=`${d[a]} `}let{gl:f,scaleBarCopyHelper:m}=this,v=n.bottomPixelOffset*n.scaleFactor;for(let t=g-1;t>=0;--t){let i=s[t];1===g?i.label="":i.label+=": ",i.update(n),f.viewport(n.leftPixelOffset*n.scaleFactor-e.visibleLeftFraction*e.logicalWidth,v-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,i.width,i.height),m.draw(i.texture),v+=i.height+n.marginPixelsBetweenScaleBars*n.scaleFactor}}}let xi={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2,maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function xr(e){let t={...xi};for(let i of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])(0,ef.uq)(e,i,e=>{void 0!==e&&(t[i]=(0,ef.nH)(e))});return(0,ef.uq)(e,"fontName",e=>{void 0!==e&&(t.fontName=(0,ef.ZE)(e))}),t}class xn extends J.TU{constructor(){super(xi,xr)}}let xs=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,xa=[`
float computeOITWeight(float alpha, float depth) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -depth * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,`
void emitAccumAndRevealage(vec4 accum, float revealage, highp uint pickId) {
  v4f_fragData0 = vec4(accum.rgb, revealage);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a, gl_FragCoord.z);
  vec4 accum = color * weight;
  emitAccumAndRevealage(accum, color.a, pickId);
}
`];function xo(e){e.addOutputBuffer("vec4","out_color",0),e.addOutputBuffer("highp vec4","out_z",1),e.addOutputBuffer("highp vec4","out_pickId",2),e.addFragmentCode(xs)}function xl(e){e.addOutputBuffer("vec4","v4f_fragData0",0),e.addOutputBuffer("vec4","v4f_fragData1",1),e.addFragmentCode(xa)}function xd(e){e.addOutputBuffer("vec4","out_color",0),e.addOutputBuffer("highp vec4","out_z",1),e.addOutputBuffer("highp vec4","out_intensity",2),e.addOutputBuffer("highp vec4","out_pickId",3),e.addFragmentCode(`
void emit(vec4 color, float depth, float intensity, highp uint pickId) {
  float pickIdFloat = float(pickId);
  float bufferDepth = 1.0 - depth;
  out_color = color;
  out_z = vec4(bufferDepth, bufferDepth, bufferDepth, 1.0);
  out_intensity = vec4(intensity, intensity, intensity, 1.0);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}`)}let xu=Z.R3.create(),xc=Z.vh.create(),xh=Z._E.create();function xp(e){e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}function xg(e){e.addOutputBuffer("vec4","v4f_fragData0",0),e.addOutputBuffer("vec4","v4f_fragData1",1),e.addFragmentCode(xa),e.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

emitAccumAndRevealage(accum, 1.0 - revealage, 0u);
`)}function xf(e){e.addOutputBuffer("vec4","v4f_fragData0",0),e.addOutputBuffer("vec4","v4f_fragData1",1),e.addFragmentCode(xa),e.setFragmentMain(`
vec4 color = getValue0();
float bufferDepth = getValue1().r;
float weight = computeOITWeight(color.a, 1.0 - bufferDepth);
vec4 accum = color * weight;
float revealage = color.a;

emitAccumAndRevealage(accum, revealage, 0u);
`)}function xm(e){e.addOutputBuffer("vec4","out_color",0),e.addOutputBuffer("highp vec4","out_z",1),e.addOutputBuffer("highp vec4","out_pickId",2),e.setFragmentMain(`
out_color = vec4(0.0);
out_z = getValue0();
out_pickId = getValue1();
`)}function xv(e){e.addOutputBuffer("highp vec4","out_z",0),e.addOutputBuffer("highp vec4","out_pickId",1),e.setFragmentMain(`
out_z = getValue0();
out_pickId = getValue2();
gl_FragDepth = getValue1().r;
`)}let xy=iZ(i$);class xb extends xy{panel;sharedProjectionParameters;constructor(e){super(),this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new i2(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}}class xS extends C8{sliceViewRenderHelper;projectionParameters;visibleLayerTracker;hasVolumeRendering=!1;get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}frameRateCalculator=new iu(6,8,8,60);isContinuousCameraMotionInProgress=!1;get shouldDownsample(){return this.viewer.enableAdaptiveDownsampling.value&&this.isContinuousCameraMotionInProgress&&this.hasVolumeRendering}sliceViews=this.registerDisposer(new i7((e,t,i)=>{e.registerDisposer(i),e.registerDisposer(i.visibility.add(this.visibility))}));axesLineHelper=this.registerDisposer(CK.get(this.gl));offscreenFramebuffer=this.registerDisposer(new rP(this.gl,{colorBuffers:[new rD(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new rD(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new rD(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new rT(this.gl)}));transparentConfiguration_;volumeRenderingConfiguration_;maxProjectionConfiguration_;maxProjectionPickConfiguration_;offscreenCopyHelper=this.registerDisposer(rR.get(this.gl));transparencyCopyHelper=this.registerDisposer(rR.get(this.gl,xp,2));transparentToTransparentCopyHelper=this.registerDisposer(rR.get(this.gl,xg,2));maxProjectionColorCopyHelper=this.registerDisposer(rR.get(this.gl,xf,2));maxProjectionPickCopyHelper=this.registerDisposer(rR.get(this.gl,xm,2));maxProjectionToPickCopyHelper=this.registerDisposer(rR.get(this.gl,xv,3));sharedObject;scaleBars=this.registerDisposer(new xt(this.gl));flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}constructor(e,t,i){super(e,t,i),this.sliceViewRenderHelper=this.registerDisposer(lE.get(this.gl,xo,this.viewer,!0)),this.projectionParameters=this.registerDisposer(new i1({navigationState:this.navigationState,update:(e,t)=>{let{invViewMatrix:i,projectionMat:r,logicalWidth:n,logicalHeight:s}=e,a=n/s,o=Math.PI/4,{relativeDepthRange:l}=t,d=t.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){let e=Math.max(.1,1-l),t=1+l;Z._E.ortho(r,-a,a,-1,1,e,t)}else{let e=1/Math.tan(o/2),t=Math.max(.1,1-(l/=e)),i=1+l;d*=e,Z._E.perspective(r,o,a,t,i)}ig(e,r),t.pose.toMat4(i,d),Z._E.scale(i,i,Z.R3.set(xu,1,-1,-1)),Z._E.translate(i,i,Z.nn["2"]),ix(e)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());let r=this.sharedObject=this.registerDisposer(new xb(this));if(r.RPC_TYPE_ID=CZ.w,r.initializeCounterpart(i.rpc,{}),r.visibility.add(this.visibility),this.visibleLayerTracker=dV(this.viewer.layerManager,uW,this.viewer.visibleLayerRoles,this),this.registerDisposer(this.context.continuousCameraMotionFinished.add(()=>{this.isContinuousCameraMotionInProgress=!1,this.hasVolumeRendering&&(this.scheduleRedraw(),this.frameRateCalculator.resetForNewFrameSet())})),this.registerDisposer(this.context.continuousCameraMotionStarted.add(()=>{this.isContinuousCameraMotionInProgress=!0})),ss(t,"rotate-via-mouse-drag",e=>{so(e.detail,(e,t,i)=>{this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateRelative(Z.nn["1"],t/4*Math.PI/180),this.navigationState.pose.rotateRelative(Z.nn["0"],-i/4*Math.PI/180)})}),ss(t,"rotate-in-plane-via-touchrotate",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e;this.navigationState.pose.rotateRelative(Z.nn["2"],t.angle-t.prevAngle)}),ss(t,"rotate-out-of-plane-via-touchtranslate",e=>{this.context.flagContinuousCameraMotion();let{detail:t}=e;this.navigationState.pose.rotateRelative(Z.nn["1"],t.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(Z.nn["0"],-t.deltaY/4*Math.PI/180)}),i.showSliceViewsCheckbox){let e=this.registerDisposer(new i4(i.showSliceViews));e.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let t=document.createElement("label");t.className="perspective-panel-show-slice-views neuroglancer-noselect",t.appendChild(document.createTextNode("Sections")),t.appendChild(e.element),this.element.appendChild(t)}this.registerDisposer(i.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(i.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.wireFrame.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.hideCrossSectionBackground3D.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}translateByViewportPixels(e,t){let{viewProjectionMat:i,invViewProjectionMat:r,logicalWidth:n,logicalHeight:s}=this.projectionParameters.value,{pose:a}=this.viewer.navigationState;a.updateDisplayPosition(a=>{Z.R3.transformMat4(xu,a,i),xu[0]+=-2*e/n,xu[1]+=2*t/s,Z.R3.transformMat4(a,xu,r)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(!0),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(let[e,t]of this.sliceViews)if((t||this.viewer.showSliceViews.value)&&!e.isReady())return!1;this.ensureBoundsUpdated();let{width:e,height:t}=this.renderViewport;if(0===e||0===t)return!0;let i={projectionParameters:this.projectionParameters.value},{visibleLayers:r}=this.visibleLayerTracker;for(let[e,t]of r)if(!e.isReady(i,t))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;let{offscreenFramebuffer:e,renderViewport:{width:t,height:i}}=this,r=t*i,n=new Float32Array(4*r);try{e.bindSingle(1),this.gl.readPixels(0,0,t,i,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,n)}finally{e.framebuffer.unbind()}let s=new Float32Array(r);for(let e=0;e<r;++e)s[e]=n[4*e];return s}issuePickRequest(e,t){let{offscreenFramebuffer:i}=this;i.readPixelFloat32IntoBuffer(1,e-5,t-5,0,11,11),i.readPixelFloat32IntoBuffer(2,e-5,t-5,1936,11,11)}completePickRequest(e,t,i,r){let{mouseState:n}=this.viewer;n.pickedRenderLayer=null,C5(i,0,4,e,t,r.viewportWidth,r.viewportHeight);let s=C6.length;for(let a=0;a<s;++a){let s=C6[a],o=i[4*s];if(0===o)continue;let l=s%11,d=(s-l)/11,u=1-o;xu[0]=2*(e+l-5)/r.viewportWidth-1,xu[1]=2*(t+d-5)/r.viewportHeight-1,xu[2]=2*u-1,Z.R3.transformMat4(xu,xu,r.invTransform);let{position:c,unsnappedPosition:h}=n,{value:p}=this.navigationState.position,g=p.length;c.length!==g&&(c=n.position=new Float32Array(g)),h.length!==g&&(h=n.unsnappedPosition=new Float32Array(g)),c.set(p),n.coordinateSpace=this.navigationState.coordinateSpace.value;let f=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:m}=f;for(let e=0,t=m.length;e<t;++e)c[m[e]]=xu[e];h.set(c);let v=i[484+4*s];r.pickIDs.setMouseState(n,v),n.displayDimensions=f,n.setActive(!0);return}n.setActive(!1)}translateDataPointByViewportPixels(e,t,i,r){let{viewProjectionMat:n,invViewProjectionMat:s,width:a,height:o}=this.projectionParameters.value;return Z.R3.transformMat4(xu,t,n),xu[0]+=2*i/a,xu[1]+=-2*r/o,Z.R3.transformMat4(e,xu,s)}get transparentConfiguration(){let e=this.transparentConfiguration_;return void 0===e&&(e=this.transparentConfiguration_=this.registerDisposer(new rP(this.gl,{colorBuffers:rI(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}get volumeRenderingConfiguration(){let e=this.volumeRenderingConfiguration_;return void 0===e&&(e=this.volumeRenderingConfiguration_=this.registerDisposer(new rP(this.gl,{colorBuffers:rI(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:new rT(this.gl)}))),e}get maxProjectionConfiguration(){let e=this.maxProjectionConfiguration_;return void 0===e&&(e=this.maxProjectionConfiguration_=this.registerDisposer(new rP(this.gl,{colorBuffers:[new rD(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new rD(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new rD(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new rD(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new rT(this.gl)}))),e}get maxProjectionPickConfiguration(){let e=this.maxProjectionPickConfiguration_;return void 0===e&&(e=this.maxProjectionPickConfiguration_=this.registerDisposer(new rP(this.gl,{colorBuffers:rI(this.gl,2,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),depthBuffer:new rT(this.gl)}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;let{width:t,height:i}=this.renderViewport,r=this.viewer.showSliceViews.value;for(let[e,t]of this.sliceViews)(t||r)&&e.updateRendering();let n=this.gl,s=()=>{n.drawBuffers(this.offscreenFramebuffer.singleAttachmentList)},a=()=>{this.offscreenFramebuffer.bind(t,i)};a(),n.disable(n.SCISSOR_TEST),n.enable(WebGL2RenderingContext.STENCIL_TEST),n.stencilMask(0xffffffff),n.clearStencil(0),n.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),n.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),n.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);let o=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(o[0],o[1],o[2],0),n.clear(n.DEPTH_BUFFER_BIT),n.clearBufferfv(WebGL2RenderingContext.COLOR,0,[o[0],o[1],o[2],0]),n.clearBufferfv(WebGL2RenderingContext.COLOR,1,Z.Dv),n.clearBufferfv(WebGL2RenderingContext.COLOR,2,Z.Dv),n.enable(n.DEPTH_TEST);let l=this.projectionParameters.value,d=Z.R3.create();Z.R3.transformQuat(d,Z.nn["2"],this.navigationState.pose.orientation.orientation),Z.R3.scale(d,d,-1);let u={wireFrame:this.viewer.wireFrame.value,projectionParameters:l,lightDirection:d,ambientLighting:.2,directionalLighting:.8,pickIDs:e.pickIDs,emitter:xo,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1,bindFramebuffer:a,frameNumber:this.context.frameNumber,sliceViewsPresent:this.sliceViews.size>0,isContinuousCameraMotionInProgress:this.isContinuousCameraMotionInProgress,force3DHistogramForAutoRange:this.context.force3DHistogramForAutoRange};Z._E.copy(e.invTransform,l.invViewProjectionMat);let{visibleLayers:c}=this.visibleLayerTracker,h=!1,p=!1,g=!1,f=!1;for(let[e,t]of c)e.isTransparent?(h=!0,e.isVolumeRendering&&(f=!0,p=p||!this.isContinuousCameraMotionInProgress||f6(e))):e.isAnnotation?g=!0:e.draw(u,t);if(this.hasVolumeRendering=f,this.drawSliceViews(u),g){for(let[e,t]of(n.enable(WebGL2RenderingContext.BLEND),n.depthFunc(WebGL2RenderingContext.LEQUAL),n.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),c))e.isAnnotation&&(e.base.state.displayState.disablePicking.value?(s(),e.draw(u,t),u.bindFramebuffer()):e.draw(u,t));n.depthFunc(WebGL2RenderingContext.LESS),n.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),n.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),h){let e=t,r=i;if(this.shouldDownsample){this.frameRateCalculator.setFrameDeltas(this.context.getLastFrameTimesInMs(this.frameRateCalculator.numberOfStoredFrameDeltas));let n=this.frameRateCalculator.calculateDownsamplingRate(il.MEAN);if(n>1){let s=t/i;r=Math.round((e=Math.round(t/n))/s)}}let s=()=>{},o=()=>{},l=()=>{};if(this.hasVolumeRendering){u.maxProjectionEmit=xd;let{maxProjectionConfiguration:t}=this;s=()=>{t.bind(e,r)},n.depthMask(!0),s(),u.bindMaxProjectionBuffer=s,n.clearColor(0,0,0,0),n.clearDepth(0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT);let{maxProjectionPickConfiguration:i}=this;(o=()=>{i.bind(e,r)})(),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT),(l=()=>{this.volumeRenderingConfiguration.bind(e,r)})(),u.bindVolumeRenderingBuffer=l,n.clearDepth(1),n.clearColor(0,0,0,1),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT)}let{transparentConfiguration:d}=this;u.bindFramebuffer=()=>{d.bind(t,i)},u.bindFramebuffer(),n.depthMask(!1),n.enable(WebGL2RenderingContext.BLEND),n.clearColor(0,0,0,1),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),u.emitter=xl,n.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),u.emitPickID=!1;let h=0;for(let[e,t]of c)if(e.isVolumeRendering){u.depthBufferTexture=this.offscreenFramebuffer.colorBuffers[1].texture;let i=f6(e),r=!i&&!this.isContinuousCameraMotionInProgress&&!u.wireFrame;if(i?(n.depthMask(!0),n.disable(WebGL2RenderingContext.BLEND),n.depthFunc(WebGL2RenderingContext.GREATER),2!==h&&(u.emitter=xd,s())):(1!==h&&(u.emitter=xl,l()),n.disable(WebGL2RenderingContext.DEPTH_TEST),h=1),e.draw(u,t),n.enable(WebGL2RenderingContext.DEPTH_TEST),!r&&!i)continue;o(),this.maxProjectionToPickCopyHelper.draw(this.maxProjectionConfiguration.colorBuffers[1].texture,this.maxProjectionConfiguration.colorBuffers[2].texture,this.maxProjectionConfiguration.colorBuffers[3].texture),n.enable(WebGL2RenderingContext.BLEND),n.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),i&&(l(),n.depthMask(!1),n.disable(WebGL2RenderingContext.DEPTH_TEST),this.maxProjectionColorCopyHelper.draw(this.maxProjectionConfiguration.colorBuffers[0].texture,this.maxProjectionConfiguration.colorBuffers[1].texture)),s(),u.emitter=xd,n.depthMask(!0),n.clearColor(0,0,0,0),n.clearDepth(0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT),n.clearDepth(1),n.clearColor(0,0,0,1),n.depthMask(!1),n.enable(WebGL2RenderingContext.DEPTH_TEST),n.depthFunc(WebGL2RenderingContext.LESS),h=2}else e.isTransparent&&(0!==h&&(u.emitter=xl,u.bindFramebuffer()),h=0,e.draw(u,t));for(let[e,t]of(n.disable(WebGL2RenderingContext.DEPTH_TEST),f&&(u.bindFramebuffer(),this.transparentToTransparentCopyHelper.draw(this.volumeRenderingConfiguration.colorBuffers[0].texture,this.volumeRenderingConfiguration.colorBuffers[1].texture)),n.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.offscreenFramebuffer.bindSingle(0),this.transparencyCopyHelper.draw(d.colorBuffers[0].texture,d.colorBuffers[1].texture),n.depthMask(!0),n.disable(WebGL2RenderingContext.BLEND),n.enable(WebGL2RenderingContext.DEPTH_TEST),u.bindFramebuffer=a,a(),n.enable(WebGL2RenderingContext.STENCIL_TEST),n.drawBuffers([n.NONE,n.COLOR_ATTACHMENT1,n.COLOR_ATTACHMENT2]),u.emitter=xo,u.emitPickID=!0,u.emitColor=!1,n.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),n.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),n.stencilMask(2),p&&this.maxProjectionPickCopyHelper.draw(this.maxProjectionPickConfiguration.colorBuffers[0].texture,this.maxProjectionPickConfiguration.colorBuffers[1].texture),c))e.isTransparent&&e.transparentPickEnabled&&!e.isVolumeRendering&&e.draw(u,t);for(let[e,t]of(n.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),n.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),n.stencilMask(0),c))e.isTransparent&&!e.transparentPickEnabled&&e.draw(u,t)}if(n.stencilMask(0xffffffff),n.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){n.drawBuffers([n.COLOR_ATTACHMENT0]),n.disable(WebGL2RenderingContext.DEPTH_TEST),n.enable(WebGL2RenderingContext.BLEND),n.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);let{scaleBars:e}=this,t=this.viewer.scaleBarOptions.value;e.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,t),n.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){let{sliceViewRenderHelper:t}=this,{lightDirection:i,ambientLighting:r,directionalLighting:n,projectionParameters:{viewProjectionMat:s}}=e,a=this.viewer.showSliceViews.value;for(let[e,o]of this.sliceViews){if(!o&&!a)continue;let{width:l,height:d,invViewMatrix:u,viewportNormalInCanonicalCoordinates:c}=e.projectionParameters.value;if(0===l||0===d||!e.valid)continue;let h=r+Math.abs(Z.R3.dot(i,c))*n;Z._E.identity(xh),xh[0]=l/2,xh[5]=-d/2,Z._E.multiply(xh,u,xh),Z._E.multiply(xh,s,xh);let p=this.viewer.crossSectionBackgroundColor.value;xc[0]=p[0],xc[1]=p[1],xc[2]=p[2],xc[3]=1,t.draw(e.offscreenFramebuffer.colorBuffers[0].texture,xh,Z.vh.fromValues(h,h,h,1),xc,0,0,1,1)}}drawAxisLines(){let{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,i=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,{gl:r}=this;r.drawBuffers([r.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(CJ(t,e*i),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}}function xw(e){e.addOutputBuffer("vec4","out_fragColor",0),e.addOutputBuffer("highp vec4","out_pickId",1),e.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function xC(e){e.addOutputBuffer("vec4","out_fragColor",null),e.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}let xx=Z.R3.create(),xE=Z.R3.create(),xT=Z.vh.create();class xk extends C8{sliceView;sliceViewRenderHelper;axesLineHelper;colorFactor;pickIDs;flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}visibleLayerTracker;get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}offscreenFramebuffer;offscreenCopyHelper;scaleBars;get navigationState(){return this.sliceView.navigationState}constructor(e,t,i,r){super(e,t,r),this.sliceView=i,this.axesLineHelper=this.registerDisposer(CK.get(this.gl)),this.colorFactor=Z.vh.fromValues(1,1,1,1),this.pickIDs=new CY,this.offscreenFramebuffer=this.registerDisposer(new rP(this.gl,{colorBuffers:[new rD(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new rD(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]})),this.offscreenCopyHelper=this.registerDisposer(rR.get(this.gl)),this.scaleBars=this.registerDisposer(new xt(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(lE.get(this.gl,xC,this.viewer,!1)),r.wireFrame.changed.add(()=>this.scheduleRedraw()),ss(t,"rotate-via-mouse-drag",e=>{let{mouseState:t}=this.viewer;if(t.updateUnconditionally()){let i=Float32Array.from(t.position);so(e.detail,(e,t,r)=>{this.context.flagContinuousCameraMotion();let{pose:n}=this.navigationState,s=Z.R3.transformQuat(xx,Z.nn["0"],n.orientation.orientation),a=Z.R3.transformQuat(xE,Z.nn["1"],n.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(a,-t/4*Math.PI/180,i),this.viewer.navigationState.pose.rotateAbsolute(s,-r/4*Math.PI/180,i)})}}),ss(t,"rotate-in-plane-via-touchrotate",e=>{let{detail:t}=e,{mouseState:i}=this.viewer;this.handleMouseMove(t.centerX,t.centerY),i.updateUnconditionally()&&(this.context.flagContinuousCameraMotion(),this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,t.angle-t.prevAngle,i.position))}),this.registerDisposer(i),this.visibleLayerTracker=dV(this.viewer.layerManager,lm,this.viewer.visibleLayerRoles,this),this.registerDisposer(r.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(i.visibility.add(this.visibility)),this.registerDisposer(i.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(r.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(r.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(r.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}translateByViewportPixels(e,t){let{pose:i}=this.viewer.navigationState;i.updateDisplayPosition(i=>{Z.R3.set(i,-e,-t,0),Z.R3.transformMat4(i,i,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,i,r){let n=this.sliceView.projectionParameters.value;return Z.R3.transformMat4(e,t,n.viewMatrix),Z.R3.set(e,e[0]+i,e[1]+r,e[2]),Z.R3.transformMat4(e,e,n.invViewMatrix),e}isReady(){if(!this.visible)return!1;let{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;let t={projectionParameters:e.projectionParameters.value,sliceView:e};for(let[e,i]of this.visibleLayerTracker.visibleLayers)if(!e.isReady(t,i))return!1;return!0}drawWithPicking(e){let{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();let i=t.projectionParameters.value,{width:r,height:n,invViewProjectionMat:s}=i;Z._E.copy(e.invTransform,s);let{gl:a}=this;this.offscreenFramebuffer.bind(r,n),a.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),a.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let o=this.viewer.crossSectionBackgroundColor.value;xT[0]=o[0],xT[1]=o[1],xT[2]=o[2],xT[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,Z.TL,this.colorFactor,xT,0,0,1,1);let{visibleLayers:l}=this.visibleLayerTracker,{pickIDs:d}=this;d.clear();let u=()=>{a.disable(WebGL2RenderingContext.SCISSOR_TEST),a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.offscreenFramebuffer.bind(r,n)};u();let c={wireFrame:this.viewer.wireFrame.value,projectionParameters:i,pickIDs:d,emitter:xw,emitColor:!0,emitPickID:!0,sliceView:t,bindFramebuffer:u,frameNumber:this.context.frameNumber};for(let[e,t]of l)e.draw(c,t);if(a.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){let e=Math.min(i.logicalWidth,i.logicalHeight)/4*1.5,{zoomFactor:{value:t}}=this.viewer.navigationState;this.axesLineHelper.draw((0,Z.ad)(CJ(i,e*t)))}this.viewer.showScaleBar.value&&(a.enable(WebGL2RenderingContext.BLEND),a.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(i,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),a.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(!0),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){let{offscreenFramebuffer:i}=this;i.readPixelFloat32IntoBuffer(1,e-5,t-5,0,11,11)}completePickRequest(e,t,i,r){let{mouseState:n}=this.viewer;n.pickedRenderLayer=null,C5(i,0,4,e,t,r.viewportWidth,r.viewportHeight);let{viewportWidth:s,viewportHeight:a}=r,o=C6.length,{value:l}=this.navigationState.position,d=l.length,u=this.navigationState.pose.displayDimensions.value,{displayRank:c,displayDimensionIndices:h}=u,p=(i,n,o)=>{let d=e+i,u=t+n;xx[0]=2*d/s-1,xx[1]=2*u/a-1,xx[2]=0,Z.R3.transformMat4(xx,xx,r.invTransform),o.set(l);for(let e=0;e<c;++e)o[h[e]]=xx[e]},{unsnappedPosition:g}=n;g.length!==d&&(g=n.unsnappedPosition=new Float32Array(d)),n.coordinateSpace=this.navigationState.coordinateSpace.value,n.displayDimensions=u,p(0,0,g);let f=(e,t,i)=>{let{position:r}=n;r.length!==d&&(r=n.position=new Float32Array(d)),p(e-5,t-5,r),this.pickIDs.setMouseState(n,i),n.setActive(!0)};for(let e=0;e<o;++e){let t=C6[e],r=i[4*e];if(0===r)continue;let n=t%11,s=(t-n)/11;f(n,s,r);return}f(5,5,0)}zoomByMouse(e){let{navigationState:t}=this;if(!t.valid)return;let{sliceView:i}=this,{width:r,height:n,invViewMatrix:s,displayDimensionRenderInfo:{displayDimensionIndices:a,displayRank:o}}=i.projectionParameters.value,{mouseX:l,mouseY:d}=this;l-=r/2,d-=n/2;let u=this.navigationState.position.value;for(let t=0;t<o;++t){let i=a[t],r=s[t]*l+s[4+t]*d;u[i]+=r*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}}i(4226);let xD=["#f00","#0f0","#99f"],xL=se.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}}),xI=[e=>e.name,e=>e.scaleFactor];class xP extends eh.gj{displayDimensionRenderInfo;zoom;depthRange;orientation;panelBoundsUpdated;panelRenderViewport;isSliceView;element;dimensionGridContainer;depthGridContainer;fovGridContainer;defaultCheckbox;fovControls;dimensionElements;zoomDimension(e,t){this.updateScaleFactors();let{displayDimensions:i}=this,{relativeDisplayScales:r}=this,{displayDimensionIndices:n}=i.value,s=n[e];if(-1===s)return;let{factors:a}=r.value,o=new Float64Array(a);o[s]*=2**-t,r.setFactors(o)}updateZoomFromScale(e){let{canonicalVoxelFactors:t,displayDimensionScales:i,displayDimensionUnits:r}=this.displayDimensionRenderInfo.value,n=this.dimensionElements[e],s=n.scaleUnit.textContent?.split("/")[0],a=to(n.scale.value+s);if(!a||a.unit!==r[e]){this.updateView();return}let o=a.scale*t[e]/i[e];this.zoom.value=o}updateZoomFromFOV(e){let t=this.getFOVScales();if(null==t)return;let i=this.fovControls[e],r=to(i.input.value+i.unit.textContent),n=0==e?t.width.scale:t.height.scale,s=0==e?t.width.unit:t.height.unit;if(!r||r.unit!==s){this.updateView();return}let{width:a,height:o}=this.panelRenderViewport,l=r.scale/(0===e?a:o);this.zoom.value=l/n}updateScaleTooltip(e){let{displayDimensionUnits:t}=this.displayDimensionRenderInfo.value,i=t[e],r=`Change display scale in ${i}/${this.displayUnit}`;this.dimensionElements[e].scale.title=r,this.dimensionElements[e].scaleUnit.title=r}updateNameValidity(){let{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,i=e.map(e=>e.name.value),r=t_(i),{names:n}=this.displayDimensions.coordinateSpace.value,s=i.length;for(let a=0;a<s;++a){let s=r[a],o=i[a],l=-1;0===o.length?s=!0:-1===(l=n.indexOf(o))&&(s=!1);let d=e[a];d.name.dataset.isValid=s.toString(),d.container.dataset.isModified=(l!==t[a]).toString()}}scheduleUpdateView;getFOVScales(){if(!this.isSliceView)return null;let{displayDimensionScales:e,canonicalVoxelFactors:t,displayDimensionUnits:i,displayDimensionIndices:r}=this.displayDimensionRenderInfo.value,n=Z.R3.fromValues(-1,-1,-1);for(let i=0;i<r.length&&-1!==r[i];++i){let r=e[i],s=t[i];n[i]=r/s}return(0,Z.gh)(this.orientation.orientation,n,i)}toggleFovInputVisibility(e=!0,t=null){let i=t??this.getFOVScales(),r=null!==i&&-1!==i.width.scale&&-1!==i.height.scale;return r!==("none"!==this.fovGridContainer.style.display)&&(this.fovGridContainer.style.display=r?"":"none",e&&this.scheduleUpdateView()),r}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get displayUnit(){return this.isSliceView?"px":"vh"}constructor(e,t,i,r,n,s,a){super(),this.displayDimensionRenderInfo=e,this.zoom=t,this.depthRange=i,this.orientation=r,this.panelBoundsUpdated=n,this.panelRenderViewport=s,this.isSliceView=a,this.element=document.createElement("div"),this.dimensionGridContainer=document.createElement("div"),this.depthGridContainer=document.createElement("div"),this.fovGridContainer=document.createElement("div"),this.defaultCheckbox=document.createElement("input"),this.fovControls=[],this.dimensionElements=Array.from([,,,],(e,t)=>{let i=document.createElement("div");i.classList.add("neuroglancer-display-dimensions-widget-dimension"),i.style.display="contents",ss(i,"adjust-via-wheel",e=>{let{deltaY:i}=e.detail;0!==i&&this.zoomDimension(t,Math.sign(i))});let r=document.createElement("input");r.classList.add("neuroglancer-display-dimensions-widget-name"),r.classList.add("neuroglancer-display-dimensions-input-base"),r.title="Change display dimensions",r.spellcheck=!1,r.autocomplete="off",r.style.color=xD[t],r.style.gridColumn="1",r.style.gridRow=`${t+1}`,r.addEventListener("focus",()=>{r.select()}),i.appendChild(r);let n=document.createElement("span");n.classList.add("neuroglancer-display-dimensions-widget-scale-factor");let s=document.createElement("input");s.classList.add("neuroglancer-display-dimensions-input-base"),s.title="Change relative scale at which dimension is displayed",s.spellcheck=!1,s.autocomplete="off",n.style.gridColumn="2",n.style.gridRow=`${t+1}`,s.addEventListener("focus",()=>{s.select()}),n.appendChild(s),i.appendChild(n);let a=document.createElement("div");a.classList.add("neuroglancer-display-dimensions-input-wrapper");let o=document.createElement("input");o.classList.add("neuroglancer-display-dimensions-widget-scale"),o.classList.add("neuroglancer-display-dimensions-input-base"),o.spellcheck=!1,o.autocomplete="off",o.style.gridColumn="3",o.style.gridRow=`${t+1}`,a.appendChild(o);let l=document.createElement("span");l.classList.add("neuroglancer-display-dimensions-widget-scale-unit"),l.textContent=`/${this.displayUnit}`,a.appendChild(l),i.appendChild(a),this.dimensionGridContainer.appendChild(i),o.addEventListener("input",()=>{sb(o)}),o.addEventListener("blur",()=>{this.updateView()}),ss(o,"commit",()=>{this.updateZoomFromScale(t)});let d={name:r,container:i,scaleFactor:s,scale:o,scaleUnit:l,scaleFactorModified:!1};for(let e of(r.addEventListener("input",()=>{sb(r),this.updateNameValidity()}),ss(r,"commit",()=>{this.updateNames()}),r.addEventListener("blur",e=>{let{relatedTarget:t}=e;!this.dimensionElements.some(e=>e.name===t)&&(this.updateNames()||this.updateView())}),n.addEventListener("click",e=>{let{target:t}=e;t!==s&&(s.focus(),e.preventDefault())}),s.addEventListener("input",()=>{sb(s),d.scaleFactorModified=!0}),ss(s,"commit",()=>{this.updateScaleFactors()}),s.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()}),xI))ss(e(d),"move-up",()=>{0!==t&&e(this.dimensionElements[t-1]).focus()}),ss(e(d),"move-down",()=>{2!==t&&e(this.dimensionElements[t+1]).focus()});return d}),this.scheduleUpdateView=(0,io.H)(()=>this.updateView());let{element:o,dimensionGridContainer:l,defaultCheckbox:d}=this,u=document.createElement("label"),c=this.registerCancellable((0,ie.Z)(()=>{o.dataset.active="false"},2e3)),h=()=>{o.dataset.active="true",c()};if(this.registerDisposer(t.changed.add(h)),this.registerDisposer(e.relativeDisplayScales.changed.add(h)),this.registerDisposer(i.changed.add(h)),o.classList.add("neuroglancer-display-dimensions-widget"),o.appendChild(l),l.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),o.addEventListener("pointerleave",()=>{let e=document.activeElement;e instanceof HTMLElement&&o.contains(e)&&e.blur()}),d.type="checkbox",u.appendChild(d),u.appendChild(document.createTextNode("Default dims")),u.title="Display first 3 dimensions",u.classList.add("neuroglancer-display-dimensions-widget-default"),d.addEventListener("change",()=>{this.updateDefault()}),l.appendChild(u),this.registerDisposer(e),this.registerDisposer(i),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView)),this.registerDisposer(this.panelBoundsUpdated.add(this.scheduleUpdateView)),this.registerDisposer(this.orientation.changed.add(()=>this.toggleFovInputVisibility())),this.registerDisposer(new aM(o,xL)).allShortcutsAreGlobal=!0,this.registerDisposer(new sa(o,xL)),ss(l,"cancel",()=>{this.updateView();let e=document.activeElement;e instanceof HTMLElement&&o.contains(e)&&e.blur()}),a){let{fovGridContainer:e}=this;e.classList.add("neuroglancer-display-dimensions-widget-fov"),o.appendChild(e);let t=document.createElement("div");t.textContent="Field of view:",e.appendChild(t);let i=document.createElement("div");e.appendChild(i),i.classList.add("neuroglancer-display-dimensions-widget-fov-container");for(let e=0;e<2;++e){let t=document.createElement("div"),r=document.createElement("input");r.classList.add("neuroglancer-display-dimensions-input-base"),r.spellcheck=!1,r.autocomplete="off";let n=0===e?"horizontal":"vertical",s=`Change panel ${n} field of view`;r.title=s,r.classList.add("neuroglancer-display-dimensions-widget-fov-input");let a=document.createElement("span");if(a.classList.add("neuroglancer-display-dimensions-widget-fov-unit"),a.title=s,t.appendChild(r),t.appendChild(a),i.appendChild(t),this.fovControls.push({container:t,input:r,unit:a}),0==e){let e=document.createElement("span");e.textContent="x",i.appendChild(e)}r.addEventListener("input",()=>{sb(r)}),r.addEventListener("blur",()=>{this.updateView()}),ss(r,"commit",()=>{this.updateZoomFromFOV(e)}),ss(r,"move-up",()=>{0!==e&&this.fovControls[e-1].input.focus()}),ss(r,"move-down",()=>{1!==e&&this.fovControls[e+1].input.focus()})}}let{depthGridContainer:p}=this;p.classList.add("neuroglancer-depth-range-widget-grid"),o.appendChild(p);let g=document.createElement("label"),f=document.createElement("input");f.type="checkbox",g.classList.add("neuroglancer-depth-range-relative-checkbox-label"),f.classList.add("neuroglancer-depth-range-relative-checkbox"),g.appendChild(f),g.appendChild(document.createTextNode("Zoom-relative")),f.addEventListener("change",()=>{let e=f.checked,t=this.depthRange.value;e!==t<0&&(t=e?-t/this.zoom.value:-t*this.zoom.value,this.depthRange.value=t)}),g.title="Depth range is multiplied by scale",o.appendChild(g),ss(p,"adjust-via-wheel",e=>{let{deltaY:t}=e.detail;if(0===t)return;let i=this.depthRange.value;this.depthRange.value=i*2**Math.sign(t)}),this.registerDisposer((0,J.Uw)((e,t,{factors:i})=>{sv(p);let r=document.createElement("div");r.textContent="Depth range:",p.appendChild(r);let{displayRank:n,globalDimensionNames:s,displayDimensionIndices:a,displayDimensionUnits:o,displayDimensionScales:l,canonicalVoxelFactors:d}=t,u=[],c=()=>{f.checked=this.depthRange.value<0;let e=this.depthRange.value;for(let t of(e<0&&(e*=-this.zoom.value),u)){let{input:i}=t;i.value=ta(e*t.scale,t.unit,{precision:2,elide1:!1}),sb(i)}},h=e=>{let t=to(e.input.value);if(void 0===t||t.unit!==e.unit)return!1;let i=t.scale/e.scale;return this.depthRange.value<0&&(i=-i/this.zoom.value),this.depthRange.value=i,!0};for(let e=0;e<n;++e){let t=a[e],r=s[t],n=o[e],g=i[t],f=u.find(e=>e.unit===n&&e.factor===g);if(void 0===f){let t=document.createElement("div");t.title="Visible depth range",t.classList.add("neuroglancer-depth-range-container"),p.appendChild(t);let i=document.createElement("span");i.textContent="\xb1",t.appendChild(i);let r=document.createElement("input");r.classList.add("neuroglancer-display-dimensions-input-base"),r.spellcheck=!1,r.autocomplete="off",r.addEventListener("focus",()=>{r.select()}),ss(r,"commit",()=>{h(f)}),r.addEventListener("change",()=>{h(f)||c()}),r.addEventListener("input",()=>{sb(r)}),t.appendChild(r);let s=document.createElement("span");s.classList.add("neuroglancer-depth-range-widget-dimension-names"),t.appendChild(s),f={unit:n,factor:g,dimensionNames:[],input:r,label:s,scale:l[e]/d[e]},u.push(f)}f.dimensionNames.push(r)}for(let e of u)e.dimensionNames.length!==n&&(e.label.textContent=e.dimensionNames.join(" "));e.registerDisposer(ss(p,"cancel",()=>{c();let e=document.activeElement;e instanceof HTMLElement&&p.contains(e)&&e.blur()}));let g=e.registerCancellable((0,io.H)(c));e.registerDisposer(this.depthRange.changed.add(g)),e.registerDisposer(this.zoom.changed.add(g)),c()},e,this.relativeDisplayScales)),this.updateView()}updateNames(){let e=this.dimensionElements.map(e=>e.name.value).filter(e=>e.length>0);if(!tB(e))return!1;let{displayDimensions:t}=this.displayDimensionRenderInfo;if(0===e.length)return t.reset(),!0;let i=new Int32Array(3);i.fill(-1);let{names:r}=t.coordinateSpace.value,n=e.length;for(let t=0;t<n;++t){let n=r.indexOf(e[t]);if(-1===n)return!1;i[t]=n}return!!(0,H.cO)(i,t.value.displayDimensionIndices)||(t.setDimensionIndices(n,i),!0)}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){let{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:i,displayRank:r}=e.value,{factors:n}=t.value,{dimensionElements:s}=this,a=new Float64Array(n);for(let e=0;e<r;++e){let t=s[e];if(!t.scaleFactorModified)continue;let r=Number(t.scaleFactor.value),n=i[e];Number.isFinite(r)&&!(r<=0)&&(a[n]=r)}return(0,H.cO)(a,n)||t.setFactors(a),!0}updateView(){let{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:i,canonicalVoxelFactors:r,displayDimensionUnits:n,displayDimensionScales:s,globalDimensionNames:a}=this.displayDimensionRenderInfo.value,{factors:o}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;let l=this.zoom.value,d=i[0],u=!0;if(-1!==d){let e=n[0],t=o[d];for(let r=1;r<3;++r){let s=i[r];if(-1!==s&&(n[r]!==e||o[s]!==t)){u=!1;break}}}for(let t=0;t<3;++t){let d=i[t],c=e[t];if(c.name.dataset.isValid=void 0,c.container.dataset.isModified=(-1===d).toString(),-1===d)c.name.value="",c.scale.value="",c.scaleFactor.value="";else{c.name.value=a[d];let e=s[t]*l/r[t];if(0!==t&&u)c.scale.value="",c.scale.style.display="none";else{let i=ts(e,n[t],{precision:2,elide1:!1});c.scale.value=`${i.scale}${i.prefix}`,c.scaleUnit.textContent=`${i.unit}/${this.displayUnit}`,c.scale.style.display="",this.updateScaleTooltip(t)}c.scaleFactor.value=function(e){if(e<.01||e>1024){let t=0|Math.log2(e),i=e/2**t;return`${uL(i,1)}p${t}`}return e.toString()}(o[d])}sb(c.name),sb(c.scaleFactor),sb(c.scale)}let c=this.getFOVScales();if(this.toggleFovInputVisibility(!1,c)&&c){let{width:e,height:t}=this.panelRenderViewport;for(let i=0;i<2;i++){let r=0==i?c.width:c.height,n=ts(r.scale*l*(0===i?e:t),r.unit,{precision:2,elide1:!1});this.fovControls[i].input.value=`${n.scale}${n.prefix}`,this.fovControls[i].unit.textContent=n.unit,sb(this.fovControls[i].input)}}}disposed(){sy(this.element),super.disposed()}}let xR=new Map([["xy",void 0],["xz",Z.gf.rotateX(Z.gf.create(),Z.gf.create(),Math.PI/2)],["yz",Z.gf.rotateY(Z.gf.create(),Z.gf.create(),Math.PI/2)]]),xA=new Map([["4panel","◱"],["4panel-alt","◲"],["3d","◻"]]);function xM(e,t){var i;let r;return r=void 0===(i=xR.get(t))?e.navigationState.addRef():new n0(new nq(e.navigationState.pose.position.addRef(),e.navigationState.pose.displayDimensionRenderInfo.addRef(),nO.makeRelative(e.navigationState.pose.orientation,i)),e.navigationState.zoomFactor.addRef(),e.navigationState.depthRange.addRef()),new lw(e.chunkManager,e.layerManager,r,e.wireFrame)}function xN(e){return new Map([["xy",xM(e,"xy")],["xz",xM(e,"xz")],["yz",xM(e,"yz")]])}function xV(e){return{crossSectionBackgroundColor:e.crossSectionBackgroundColor,perspectiveViewBackgroundColor:e.perspectiveViewBackgroundColor,selectionDetailsState:e.selectionDetailsState,mouseState:e.mouseState,layerManager:e.layerManager,showAxisLines:e.showAxisLines,wireFrame:e.wireFrame,enableAdaptiveDownsampling:e.enableAdaptiveDownsampling,visibleLayerRoles:e.visibleLayerRoles,selectedLayer:e.selectedLayer,visibility:e.visibility,scaleBarOptions:e.scaleBarOptions,hideCrossSectionBackground3D:e.hideCrossSectionBackground3D}}function xO(e){let{viewer:t}=e;return{...xV(t),navigationState:t.perspectiveNavigationState,inputEventMap:t.inputEventBindings.perspectiveView,orthographicProjection:e.specification.orthographicProjection,showScaleBar:t.showScaleBar,rpc:t.chunkManager.rpc}}function xF(e){return{...xV(e),navigationState:e.navigationState,inputEventMap:e.inputEventBindings.sliceView}}function xB(e,t){let{navigationState:i}=t;t.element.appendChild(e.registerDisposer(new xP(i.pose.displayDimensionRenderInfo.addRef(),i.zoomFactor,i.depthRange.addRef(),i.pose.orientation.addRef(),t.boundsUpdated,t.renderViewport,t instanceof xk)).element)}function x_(e,t,i){let r=document.createElement("div");r.className="neuroglancer-data-panel-layout-controls",e.registerDisposer(()=>sy(r));for(let r=0;r<2;++r){let n=i[Math.min(i.length-1,r)];e.registerDisposer(ss(t.element,0===r?"toggle-layout":"toggle-layout-alternative",t=>{e.container.name=n,t.stopPropagation()}))}for(let t of i){let i=document.createElement("button"),n=document.createElement("div");i.appendChild(n),n.textContent=xA.get(t),i.title=`Switch to ${t} layout.`,i.addEventListener("click",()=>{e.container.name=t}),r.appendChild(i)}t.element.appendChild(r)}function xU(e,t,i){let r=new Map;(()=>{let n=new Set;for(let s of i.values()){if(n.add(s),r.has(s))continue;let i=function(e,t){let i=new lw(e.chunkManager,e.layerManager,t.navigationState.addRef(),e.wireFrame),r=()=>{let{width:{value:e},height:{value:r}}=t;i.projectionParameters.setViewport({width:e,height:r,logicalWidth:e,logicalHeight:r,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return i.registerDisposer(t.width.changed.add(r)),i.registerDisposer(t.height.changed.add(r)),r(),i}(e,s);t.sliceViews.set(i,!0),r.set(s,i)}for(let[e,i]of r)!n.has(e)&&t.sliceViews.delete(i)})()}class x$ extends eh.gj{container;rootElement;viewer;constructor(e,t,i,r){super(),this.container=e,this.rootElement=t,this.viewer=i;let n=xN(i),{display:s}=i,a={...xO(e),showSliceViews:i.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},o={...xF(i),showScaleBar:i.showScaleBar},l={...xF(i),showScaleBar:new i3(!1,!1)},d=(e,t,i,r)=>{let a=this.registerDisposer(new xk(s,t,n.get(e),i));return r&&xB(this,a),x_(this,a,[e,`${e}-3d`]),a},u=[CW(1,Cq("column",[CW(1,Cq("row",[CW(1,e=>{d("xy",e,o,!0)}),CW(1,e=>{d("xz",e,l,!1)})])),CW(1,Cq("row",[CW(1,e=>{let t=this.registerDisposer(new xS(s,e,a));for(let e of n.values())t.sliceViews.set(e.addRef(),!1);xB(this,t),xU(i,t,r),x_(this,t,["3d","4panel-alt"])}),CW(1,e=>{d("yz",e,l,!1)})]))]))];Cq("row",u)(t)}disposed(){sv(this.rootElement),super.disposed()}}class xz extends eh.gj{container;rootElement;viewer;constructor(e,t,i,r){super(),this.container=e,this.rootElement=t,this.viewer=i;let n=xN(i),{display:s}=i,a={...xO(e),showSliceViews:i.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},o={...xF(i),showScaleBar:i.showScaleBar},l={...xF(i),showScaleBar:new i3(!1,!1)},d=(e,t,i,r)=>{let a=this.registerDisposer(new xk(s,t,n.get(e),i));return r&&xB(this,a),x_(this,a,[e,`${e}-3d`]),a},u=[CW(1,Cq("column",[CW(1,Cq("row",[CW(1,e=>{d("xy",e,o,!0)}),CW(1,e=>{d("yz",e,l,!1)})])),CW(1,Cq("row",[CW(1,e=>{d("xz",e,l,!1)}),CW(1,e=>{let t=this.registerDisposer(new xS(s,e,a));for(let e of n.values())t.sliceViews.set(e.addRef(),!1);xB(this,t),xU(i,t,r),x_(this,t,["3d","4panel"])})]))]))];Cq("row",u)(t)}disposed(){sv(this.rootElement),super.disposed()}}class xG extends eh.gj{container;rootElement;viewer;direction;constructor(e,t,i,r,n,s){super(),this.container=e,this.rootElement=t,this.viewer=i,this.direction=r;let a=xM(i,n),{display:o}=i,l={...xO(e),showSliceViews:i.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},d={...xF(i),showScaleBar:i.showScaleBar};CW(1,Cq(r,[CW(1,e=>{let t=this.registerDisposer(new xk(o,e,a,d));xB(this,t),x_(this,t,[n,"4panel-alt"])}),CW(1,e=>{let t=this.registerDisposer(new xS(o,e,l));t.sliceViews.set(a.addRef(),!1),xU(i,t,s),xB(this,t),x_(this,t,["3d","4panel-alt"])})]))(t)}disposed(){sv(this.rootElement),super.disposed()}}class xj extends eh.gj{container;rootElement;viewer;constructor(e,t,i,r){super(),this.container=e,this.rootElement=t,this.viewer=i;let n=xM(i,r),s={...xF(i),showScaleBar:i.showScaleBar};Cq("row",[CW(1,e=>{let t=this.registerDisposer(new xk(i.display,e,n,s));xB(this,t),x_(this,t,["4panel-alt",`${r}-3d`])})])(t)}disposed(){sv(this.rootElement),super.disposed()}}class xW extends eh.gj{container;rootElement;viewer;constructor(e,t,i,r){super(),this.container=e,this.rootElement=t,this.viewer=i;let n={...xO(e),showSliceViews:new i3(!1,!1)};Cq("row",[CW(1,e=>{let t=this.registerDisposer(new xS(i.display,e,n));xU(i,t,r),xB(this,t),x_(this,t,["4panel-alt"])})])(t)}disposed(){sv(this.rootElement),super.disposed()}}let xq=new Map([["4panel",{factory:(e,t,i,r)=>new x$(e,t,i,r)}],["4panel-alt",{factory:(e,t,i,r)=>new xz(e,t,i,r)}],["3d",{factory:(e,t,i,r)=>new xW(e,t,i,r)}]]);for(let e of xR.keys()){xq.set(e,{factory:(t,i,r)=>new xj(t,i,r,e)});let t=`${e}-3d`;xA.set(e,"◻"),xA.set(t,"◫"),xq.set(t,{factory:(t,i,r,n)=>new xG(t,i,r,"row",e,n)})}function xH(e){let t=xq.get(e);if(void 0===t)throw Error(`Invalid layout name: ${JSON.stringify(e)}.`);return t}function xJ(e){return xH(e),e}class xK extends eh.gj{width=new J.TU(1e3,ef.Sc);height=new J.TU(1e3,ef.Sc);position;orientation;scale;navigationState;changed=new eO.K_;constructor(e){super(),this.position=new nV(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new nF(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new nH(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new n0(new nq(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){(0,ef.PT)(e),nf(e,"width",this.width),nf(e,"height",this.height),nf(e,"position",nJ(this.position)),nf(e,"orientation",this.orientation),nf(e,"scale",this.scale),nf(e,"zoom",nJ(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}}class xZ extends i7{parentNavigationState;constructor(e){super((e,t)=>e.registerDisposer(e.registerDisposer(t).changed.add(this.changed.dispatch))),this.parentNavigationState=e,this.registerDisposer(e)}restoreState(e){for(let t of((0,ef.PT)(e),Object.keys(e))){let i=new xK(this.parentNavigationState);try{this.set(t,i.addRef()),i.restoreState(e[t])}finally{i.dispose()}}}reset(){this.clear()}toJSON(){if(0===this.size)return;let e={};for(let[t,i]of this)e[t]=i.toJSON();return e}}class xY extends eh.gj{changed=new eO.K_;type;crossSections;orthographicProjection=new i3(!1);constructor(e,t){super(),this.type=new J.TU(t,xJ),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new xZ(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),"string"==typeof e?this.type.restoreState(e):((0,ef.PT)(e),(0,ef.uq)(e,"type",e=>this.type.restoreState(e)),(0,ef.uq)(e,"orthographicProjection",e=>this.orthographicProjection.restoreState(e)),(0,ef.uq)(e,"crossSections",e=>void 0!==e&&this.crossSections.restoreState(e)))}toJSON(){let{type:e,crossSections:t,orthographicProjection:i}=this,r=i.toJSON();return 0===t.size&&void 0===r?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:r}}}class xX extends eh.gj{viewer;element;specification;layout;get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}constructor(e,t){super(),this.viewer=e,this.element=document.createElement("div"),this.specification=this.registerDisposer(new xY(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";let i=this.registerCancellable((0,ie.Z)(()=>this.updateLayout(),0));this.specification.type.changed.add(i),ss(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>i.flush())),i()}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let{layout:e}=this;void 0!==e&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=xH(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}}let xQ="undefined"!=typeof STATE_SERVERS&&Object.keys(STATE_SERVERS).length>0;class x0 extends eh.gj{element=document.createElement("div");button=sC({text:"Share",title:"Share State"});selectStateServerElement;constructor(e){if(super(),"undefined"==typeof STATE_SERVERS)throw Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys(STATE_SERVERS).length>1){let t=document.createElement("select");for(let[i,r]of(t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{let i=e.selectedStateServer.value;Object.values(STATE_SERVERS).map(e=>e.url).includes(i)&&(t.value=i)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value}),Object.entries(STATE_SERVERS))){let e=document.createElement("option");e.textContent=i,e.value=r.url,e.selected=!!r.default,t.appendChild(e)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{let t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values(STATE_SERVERS)[0].url,{store:i,path:r}=e.dataSourceProvider.sharedKvStoreContext.kvStoreContext.getKvStore(t);if(!(i instanceof yT.Z))throw Error(`Non-HTTP protocol not supported: ${t}`);s1.forPromise(i.fetchOkImpl((0,l0.Lj)(i.baseUrl,r),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON(),ef.qG)}).then(e=>e.json()).then(e=>{let i=new URL(e).protocol,r=e.substring(i.length),n=new URL(t).protocol,s=`${window.location.origin}/#!${n}${r}`;navigator.clipboard.writeText(s).then(()=>{s1.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{s1.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}}function x1(e){return e.startsWith("key")?e.substring(3):e.startsWith("digit")||e.startsWith("arrow")?e.substring(5):e}i(5941);let x2={...dn,side:"left",row:1};class x3{location=new ds(x2);get changed(){return this.location.changed}toJSON(){return(0,ef.$Z)(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class x4 extends cI{bindings;toolBinder;scroll;constructor(e,t,i,r,n){super(e,t.location),this.bindings=i,this.toolBinder=n,this.scroll=document.createElement("div"),this.addTitleBar({title:"Help"});let s=document.createElement("div");s.classList.add("neuroglancer-help-body");let{scroll:a}=this;a.classList.add("neuroglancer-help-scroll-container"),s.appendChild(a),this.addBody(s);let o=this.registerCancellable((0,io.H)(()=>this.updateView()));this.registerDisposer(n.changed.add(o)),this.registerDisposer(r.layersChanged.add(o)),this.updateView()}updateView(){let{scroll:e,bindings:t,toolBinder:i}=this;if(sv(e),"undefined"!=typeof NEUROGLANCER_BUILD_INFO){let t=document.createElement("h2");t.textContent="Build info";let i=document.createElement("div");i.classList.add("neuroglancer-build-info");let r=document.createElement("a"),{tag:n,url:s,timestamp:a}=NEUROGLANCER_BUILD_INFO;if(r.textContent=n,r.target="_blank",void 0!==s&&(r.href=s),e.appendChild(t),i.appendChild(r),void 0!==a){let e=document.createElement("div");e.classList.add("neuroglancer-build-timestamp");let t=Intl.DateTimeFormat("en",{hour12:!1,dateStyle:"medium",timeStyle:"long"}).format(new Date(a));e.textContent=`Built at ${t}`,i.append(e)}e.appendChild(i)}let r=function(e){let t=new Map;for(let[i,r]of e)!function e(i,r){if(t.has(r))return;let n={label:i,entries:new Map};!function t(i,r){for(let n of i.parents)void 0!==n.label?e(n.label,n):t(n,r);for(let[e,t]of i.bindings.entries())r.set(n7(t.originalEventIdentifier??e),t.action)}(r,n.entries),n.entries=function(e){let t=new Map;function i(e,t){return e.slice(0,-1)+String.fromCharCode(e.charCodeAt(e.length-1)+t)}function r(e,t){let r=e.slice(-1),n=i(r,t-1);return e.slice(0,-1)+"["+r+"-"+n+"]"}for(let[n,s]of e)if(n.endsWith("a")&&s.toLowerCase().endsWith("a")||n.endsWith("1")&&s.endsWith("1"))for(let a=1;;++a){let o=i(n,a),l=i(s,a);if(e.get(o)===l){e.delete(o);continue}1!==a&&t.set(n,[r(n,a),r(s,a)]);break}let n=new Map;for(let[i,r]of e){let e=t.get(i);[i,r]=e??[i,r],n.set(i,r)}return n}(n.entries),t.set(r,n)}(i,r);return t}(t),n=(t,i)=>{let r=document.createElement("h2");for(let[n,s]of(r.textContent=t,e.appendChild(r),i)){let t=document.createElement("div");t.className="dt",t.textContent=n.split("+").map(x1).join("+");let i=document.createElement("div");i.className="dd",i.textContent=s,e.appendChild(t),e.appendChild(i)}},s=new Map;for(let[e,t]of i.bindings)if(t.context instanceof dE){let i=s.get(t.context);void 0===i&&(i=[],s.set(t.context,i)),i.push([`shift+key${e.toLowerCase()}`,t.description])}let a=Array.from(s.entries());for(let[e,t]of(a.length>0&&(a[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),a.sort((e,t)=>e[0].managedLayer.nonArchivedLayerIndex-t[0].managedLayer.nonArchivedLayerIndex)),a))t.sort(),n(`Tool bindings for layer ${e.managedLayer.nonArchivedLayerIndex+1}: ${e.managedLayer.name}`,t);for(let e of r.values())n(e.label,e.entries)}}i(5256),i(6866);class x6 extends eh.gj{element=document.createElement("div");menuDisposer;parentDisposers=new Map;disabledValue=!1;opened=new eO.K_;closed=new eO.K_;get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}constructor(e){super();let{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),void 0!==e&&this.registerParent(e)}get open(){return void 0!==this.menuDisposer}registerParent(e){let{parentDisposers:t}=this;!t.has(e)&&t.set(e,(0,eh.H0)(e,"contextmenu",e=>{this.show(e),e.stopPropagation(),e.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();let{element:t}=this,i=(0,eh.H0)(document,"mousedown",e=>{e.target instanceof Node&&!t.contains(e.target)&&this.hide()},!0),r=(0,eh.H0)(document,"keydown",e=>{"Escape"===e.code&&this.hide()},!0);this.opened.dispatch(),function(e,t){e.style.display="block";let{offsetWidth:i,offsetHeight:r}=e,n=document.documentElement.clientWidth,s=document.documentElement.clientHeight,a=document.documentElement.scrollLeft+Math.min(n-i,t.clientX),o=document.documentElement.scrollTop+Math.min(s-r,t.clientY);e.style.left=a+"px",e.style.top=o+"px"}(t,e),this.menuDisposer=()=>{r(),i(),t.style.display="none"}}unregisterParent(e){let{parentDisposers:t}=this,i=t.get(e);void 0!==i&&(i(),t.delete(e))}disposed(){let{parentDisposers:e}=this;for(let t of e.values())t();e.clear(),sy(this.element)}hide(){void 0!==this.menuDisposer&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}}i(6549);let x5="neuroglancer-layer\0";function x8(e,t){var i,r;let n;e.dataTransfer.setData(x5+(i=JSON.stringify(t.layers.map(e=>({name:e.name,visible:e.visible}))),r=new TextEncoder().encode(i),Array.prototype.map.call(r,Y).join("")),JSON.stringify({layers:t.layers.map(e=>e.toJSON()),layout:t.layoutSpec},ef.qG)),void 0!==g&&g.disposer();let s=()=>{for(let e of(t.manager.unregisterDisposer(s),t.layers))e.dispose();t.manager.dispose(),g===n&&(g=void 0)};g=n={manager:t.manager.addRef(),layers:t.layers.map(e=>e.addRef()),layoutSpec:t.layoutSpec,isLayerListPanel:t.isLayerListPanel??!1,disposer:s}}function x9(e="none"){if(void 0!==g){if("move"===e){let e=new Set(g.layers);g.manager.layerManager.filter(t=>!e.has(t))}g.disposer()}}function x7(e){return function(e,t){for(let i of e){let e=function(e,t){if(e.startsWith(t))try{var i;let r=(i=e.substring(t.length),new TextDecoder().decode(function(e){if(!/^(?:[0-9a-fA-F]{2})*$/.test(e))throw Error("Invalid hex-encoded string");let t=e.length/2,i=new Uint8Array(t);for(let r=0;r<t;++r)i[r]=parseInt(e.substr(2*r,2),16);return i}(i)));return JSON.parse(r)}catch{return}}(i,t);if(void 0!==e)return{parameters:e,dragType:i}}}(e.dataTransfer.types,x5)}function Ee(e){if(void 0!==g&&g.manager.rootLayers===e.rootLayers)return g}class Et{dragType;targetIsLayerListPanel;sourceManager;sourceIsLayerListPanel;moveSupported;forceCopy;manager;layers;numSourceLayers;layoutSpec;initializeExternalLayers(e){let{dragType:t}=this;if(void 0!==t)try{let{layers:i,layout:r}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(i)||this.numSourceLayers!==i.length)throw Error("Invalid layer drop data");for(let[e,t]of(this.layoutSpec=r,this.layers))!function(e,t){try{d$(e,t)}catch(e){new s1().setErrorMessage(e instanceof Error?e.message:""+e)}}(e,i[t])}catch{return!1}return!0}updateArchiveStates(e){let{targetIsLayerListPanel:t}=this,i=e.dataTransfer.dropEffect;for(let e of this.layers.keys()){let r=t;t&&!e.archived&&"copy"!==i&&this.sourceIsLayerListPanel&&(r=!1),(e.archived!==r||r&&e.visible)&&(e.archived=r,r&&(e.visible=!1),e.layerChanged.dispatch())}}get method(){return void 0!==this.sourceManager?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e||(!this.forceCopy||"copy"===e)&&!this.moveSupported&&"move"===e}}function Ei(e,t,i,r){let n;let s=Ee(t),a=!1;return void 0===s?n="copy":r?(s.isLayerListPanel||(a=!0),n="link"):s.manager===t&&s.isLayerListPanel===i?(n="move",a=!0):i?n="none":(s.isLayerListPanel||(a=!0),n="link"),aa(e,n,a)}function Er(e,t,i){let{forceCopy:r,newTarget:n,isLayerListPanel:s=!1}=i,a=Ee(t);if(!r&&void 0!==a){let e=!n&&a.manager===t&&(a.isLayerListPanel===s||a.isLayerListPanel),i=new Et;return i.manager=t,i.numSourceLayers=a.layers.length,i.sourceManager=a.manager,i.targetIsLayerListPanel=s,i.sourceIsLayerListPanel=a.isLayerListPanel,i.moveSupported=e,i.layers=new Map,i.forceCopy=!1,i.layoutSpec=a.layoutSpec,e?a.layers.forEach((e,t)=>{i.layers.set(e,t)}):a.layers.forEach((e,r)=>{(n||!t.layerManager.has(e))&&i.layers.set(e.addRef(),r)}),i}let o=x7(e);if(void 0!==o)try{let e=(0,ef.m7)(o.parameters,(e,i)=>{let r=(0,ef.uq)(e,"name",ef.ZE),n=(0,ef.uq)(e,"visible",ef.JG),a=new dT(r,t);return s&&(n=!1),a.visible=n,a.archived=s,[a,i]}),i=new Et;return i.numSourceLayers=e.length,i.targetIsLayerListPanel=s,i.sourceIsLayerListPanel=!1,i.sourceManager=void 0,i.moveSupported=!1,i.forceCopy=void 0!==a,i.manager=t,i.dragType=o.dragType,i.layers=new Map(e),i}catch{}}function En(e,t){return!e.moveSupported&&(e.manager.layerManager.filter(t=>!e.layers.has(t)),void 0!==t&&e.layers.has(t))}function Es(e,t,i,r=!1){function n(t,n){let s=e.dropLayers,{dropEffect:a,dropEffectMessage:l}=n?Ei(t,e.manager,r,!1):{dropEffect:o,dropEffectMessage:""};if(void 0===a)return;as(t,a);let d=!0;if(!(void 0!==s&&!s.compatibleWithMethod(a)&&(e.dropLayers=void 0,En(s,i)))){if(void 0===s){if(void 0===(s=e.dropLayers=Er(t,e.manager,{forceCopy:"copy"===a,newTarget:!1,isLayerListPanel:r})))return;d="move"===s.method}if(void 0!==i&&s.layers.has(i))return{dropLayers:s,dropEffect:a,dropEffectMessage:l};if(d){let t;let{layerManager:r}=e.manager,n=new Set,a=Number.POSITIVE_INFINITY,o=r.managedLayers=r.managedLayers.filter((e,t)=>!s.layers.has(e)||(a===Number.POSITIVE_INFINITY&&(a=t),n.add(e),!1));for(let e of(void 0!==i?(t=o.indexOf(i),a<=t&&++t):t=o.length,s.layers.keys()))n.has(e)||s.layers.delete(e);o.splice(t,0,...s.layers.keys()),r.layersChanged.dispatch()}else{let t;for(let r of(void 0!==i&&(t=e.manager.layerManager.managedLayers.indexOf(i)),s.layers.keys()))e.manager.add(r,t)}return{dropLayers:s,dropEffect:a,dropEffectMessage:l}}}t.addEventListener("dragenter",t=>{void 0!==n(t,!0)?t.preventDefault():s5(t,e.element,"drop")}),t.addEventListener("drop",t=>{t.preventDefault(),e.dragEnterCount=0,s5(t,e.element,"drop");let i=n(t,!1)?.dropLayers;if(e.dropLayers=void 0,void 0!==i){if(!i.initializeExternalLayers(t)){En(i);return}i.updateArchiveStates(t),x9("move"===i.method?void 0:t.dataTransfer.dropEffect)}}),t.addEventListener("dragover",t=>{let i=n(t,!0);if(void 0===i){s5(t,e.element,"drop");return}let{dropLayers:r,dropEffect:s,dropEffectMessage:a}=i,o=r.layers.size,l="",d=1===r.numSourceLayers?"":"s",u=r.numSourceLayers;if("none"===s)l=`Cannot link dragged layer${d} here`;else{let e=u===o?`${u}`:`${o}/${u}`;l=`Drop to ${s} ${e} layer${d}`}a&&(l+=` (${a})`),s6(t,e.element,"drop",l),t.preventDefault(),t.stopPropagation()})}function Ea(e,t,i,r){t.draggable=!0,t.addEventListener("dragstart",n=>{s6(n,t,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),x8(n,{manager:e.manager,layers:[i],layoutSpec:r.getLayoutSpec(),isLayerListPanel:r.isLayerListPanel}),n.stopPropagation()}),t.addEventListener("dragend",e=>{s5(e,t,"drag"),x9()})}function Eo(e){e.element.addEventListener("dragenter",()=>{++e.dragEnterCount}),e.element.addEventListener("dragleave",t=>{if(0!=--e.dragEnterCount)return;s5(t,e.element,"drop");let{dropLayers:i}=e;void 0!==i&&(En(i),e.manager.layerManager.layersChanged.dispatch(),e.dropLayers=void 0)})}class El extends eh.gj{layer;panel;element;layerNumberElement;labelElement;visibleProgress;prefetchProgress;labelElementText;valueElement;maxLength;prevValueText;constructor(e,t){super(),this.layer=e,this.panel=t,this.element=document.createElement("div"),this.layerNumberElement=document.createElement("div"),this.labelElement=document.createElement("div"),this.visibleProgress=document.createElement("div"),this.prefetchProgress=document.createElement("div"),this.labelElementText=document.createTextNode(""),this.valueElement=document.createElement("div"),this.maxLength=0,this.prevValueText="";let{element:i,labelElement:r,layerNumberElement:n,valueElement:s,visibleProgress:a,prefetchProgress:o,labelElementText:l}=this;i.className="neuroglancer-layer-item neuroglancer-noselect",i.appendChild(a),i.appendChild(o),r.className="neuroglancer-layer-item-label",r.appendChild(l),a.className="neuroglancer-layer-item-visible-progress",o.className="neuroglancer-layer-item-prefetch-progress",n.className="neuroglancer-layer-item-number",s.className="neuroglancer-layer-item-value";let d=document.createElement("div");d.className="neuroglancer-layer-item-value-container";let u=document.createElement("div");u.className="neuroglancer-layer-item-button-container";let c=sY();c.title="Remove layer from this layer group",c.addEventListener("click",e=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),e.stopPropagation()});let h=gs();h.title="Delete this layer",h.addEventListener("click",e=>{dQ(this.layer),e.stopPropagation()}),i.appendChild(n),d.appendChild(s),d.appendChild(u),u.appendChild(c),u.appendChild(h),i.appendChild(r),i.appendChild(d);let p=this.registerDisposer(new aZ(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1,velocity:e.localVelocity,getToolBinder:()=>e.layer?.toolBinder}));i.appendChild(p.element),p.element.addEventListener("click",e=>{e.stopPropagation()}),p.element.addEventListener("dblclick",e=>{e.stopPropagation()}),i.addEventListener("click",i=>{i.ctrlKey?t.selectedLayer.toggle(e):i.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),i.addEventListener("contextmenu",i=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,i.stopPropagation(),i.preventDefault()}),Ea(t,i,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),Es(this.panel,i,this.layer)}update(){let{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let i=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(i+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),i+=", drag to move, shift+drag to copy",t.title=i}disposed(){this.element.remove(),super.disposed()}}class Ed extends eh.gj{layerGroupViewer;getLayoutSpecForDrag;showLayerHoverValues;layerWidgets;element;layerUpdateNeeded;valueUpdateNeeded;dropZone;layerWidgetInsertionPoint;positionWidget;dropLayers;dragEnterCount;get layerManager(){return this.manager.layerManager}get manager(){return this.layerGroupViewer.layerSpecification}get display(){return this.layerGroupViewer.display}get selectedLayer(){return this.layerGroupViewer.selectedLayer}get viewerNavigationState(){return this.layerGroupViewer.viewerNavigationState}constructor(e,t,i){super(),this.layerGroupViewer=e,this.getLayoutSpecForDrag=t,this.showLayerHoverValues=i,this.layerWidgets=new Map,this.element=document.createElement("div"),this.layerUpdateNeeded=!0,this.valueUpdateNeeded=!1,this.layerWidgetInsertionPoint=document.createElement("div"),this.dragEnterCount=0,this.scheduleUpdate=this.registerCancellable((0,io.H)(()=>this.update())),this.positionWidget=this.registerDisposer(new aZ(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner,{velocity:this.viewerNavigationState.velocity.velocity,getToolBinder:()=>this.layerGroupViewer.toolBinder}));let{element:r,manager:n,selectedLayer:s}=this;r.className="neuroglancer-layer-panel",this.registerDisposer(n.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(n.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(s.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(i.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let a=sC({svg:gi,title:"Click to add layer, control+click/right click/⌘+click to add local annotation layer."});a.classList.add("neuroglancer-layer-add-button");let o=this.dropZone=document.createElement("div");o.className="neuroglancer-layer-panel-drop-zone";let l=e=>{if(e.ctrlKey||e.metaKey||"contextmenu"===e.type){let e=dz(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(e),this.selectedLayer.layer=e,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(a,"click",l),this.registerEventListener(a,"contextmenu",l),r.appendChild(a),r.appendChild(o),this.registerDisposer((a.draggable=!0,(0,eh.H0)(a,"dragstart",e=>{e.stopPropagation(),e.preventDefault()}))),r.appendChild(this.positionWidget.element);let d=()=>{let e=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=e===nS.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(d)),d(),this.update(),this.updateChunkStatistics(),Eo(this),Es(this,o,void 0),this.registerDisposer(this.display.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(n.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable((0,io.H)(()=>this.updateChunkStatistics()))))}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,sy(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}scheduleUpdate;update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),!1===this.showLayerHoverValues.value)return;let e=this.manager.layerSelectedValues;for(let[t,i]of this.layerWidgets){let r=t.layer,n="";if(null!==r){let t=e.get(r);if(void 0!==t){let{value:e}=t;void 0!==e&&(n=""+e)}}if(n!==i.prevValueText){if(i.prevValueText=n,n.length>i.maxLength){let e=i.maxLength=n.length;i.valueElement.style.width=`${e}ch`}i.valueElement.textContent=n}}}updateChunkStatistics(){for(let[e,t]of this.layerWidgets){let i=0,r=0,n=0,s=0,a=e.layer;if(null!==a)for(let{layerChunkProgressInfo:e}of a.renderLayers)i+=e.numVisibleChunksNeeded,r+=e.numVisibleChunksAvailable,n+=e.numPrefetchChunksNeeded,s+=e.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${r/Math.max(1,i)*100}%`,t.prefetchProgress.style.width=`${s/Math.max(1,n)*100}%`}}updateLayers(){if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let e=this.element,t=new Set,i=this.layerWidgetInsertionPoint.nextElementSibling;for(let r of(this.manager.rootLayers.updateNonArchivedLayerIndices(),this.manager.layerManager.managedLayers)){if(r.archived&&!this.dropLayers?.layers.has(r))continue;t.add(r);let n=this.layerWidgets.get(r),s=r.nonArchivedLayerIndex;void 0===n&&(n=new El(r,this),this.layerWidgets.set(r,n)),n.layerNumberElement.textContent=""+(1+s),n.update();let{element:a}=n;a!==i&&e.insertBefore(n.element,i),i=a.nextElementSibling}for(let[e,i]of this.layerWidgets)t.has(e)||(this.layerWidgets.delete(e),i.dispose())}addLayerMenu(){d3(this.manager,this.selectedLayer)}}function Eu(e,t){let i=(0,eh.H0)(e,"drop",e=>{if(e.preventDefault(),-1!==e.dataTransfer.types.indexOf(aG)){e.stopPropagation();let i=(0,ef.PT)(JSON.parse(e.dataTransfer.getData(aG))),r=(0,ef.uq)(i,"dimensions",tH),n=(0,ef.uq)(i,"position",e=>(0,ef.m7)(e,ef.jz));if(n.length!==r.length)throw Error("length mismatch between position and dimensions");let s=n.length,{coordinateSpace:{value:{names:a}},value:o}=t;for(let e=0;e<s;++e){let t=a.indexOf(r[e]);-1!==t&&(o[t]=n[e])}t.changed.dispatch()}}),r=e=>{-1!==e.dataTransfer.types.indexOf(aG)&&(e.dataTransfer.dropEffect="link",e.preventDefault(),e.stopPropagation())},n=(0,eh.H0)(e,"dragenter",r),s=(0,eh.H0)(e,"dragover",r);return()=>{n(),s(),i()}}let Ec="neuroglancer-layer-group-viewer";function Eh(e){return -1!==e.dataTransfer.types.indexOf(Ec)}class Ep extends eh.gj{position;velocity;relativeDisplayScales;displayDimensions;displayDimensionRenderInfo;crossSectionOrientation;crossSectionScale;projectionOrientation;projectionScale;crossSectionDepthRange;projectionDepthRange;navigationState;projectionNavigationState;constructor(e){super(),this.relativeDisplayScales=new nU(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new nW(e.navigationState.pose.displayDimensions.addRef()),this.position=new nV(e.navigationState.position.addRef()),this.velocity=this.registerDisposer(new nP(e.velocity,this.position.link)),this.crossSectionOrientation=new nF(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new nG(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new nH(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new nQ(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new nQ(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new n0(new nq(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new nF(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new nH(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new n0(new nq(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(let e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.velocity,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",nJ(this.position)),e.add("velocity",this.velocity),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}}class Eg extends eh.gj{element;viewerState;layerSpecification;viewerNavigationState;get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get enableAdaptiveDownsampling(){return this.viewerState.enableAdaptiveDownsampling}get hideCrossSectionBackground3D(){return this.viewerState.hideCrossSectionBackground3D}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}layerPanel;layout;toolBinder;options;state;get changed(){return this.state.changed}constructor(e,t,i={}){super(),this.element=e,this.viewerState=t,this.state=new nm,this.options={showLayerPanel:new i3(!0),showViewerMenu:!1,showLayerHoverValues:new i3(!0),...i},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.toolBinder=this.registerDisposer(new ab(this,this.layerSpecification.root.toolBinder)),this.viewerNavigationState=this.registerDisposer(new Ep(t)),this.viewerNavigationState.register(this.state),this.registerDisposer((0,J.Uw)((e,t)=>{t===nS.UNLINKED&&e.registerDisposer(new nR(this.layerSpecification.root.display,this.viewerNavigationState.position.value,this.viewerNavigationState.velocity.velocity))},this.viewerNavigationState.position.link)),this.layerSpecification instanceof dW?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(e=>e.name),reset:()=>{throw Error("not implemented")},restoreState:()=>{throw Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new g4(e)),this.layout=this.registerDisposer(new xX(this,"xy")),this.state.add("layout",this.layout),this.state.add("toolBindings",this.toolBinder),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(Eu(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable((0,ie.Z)(()=>this.updateUI(),0)))),this.makeUI()}bindAction(e,t){this.registerDisposer(ss(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),nf(e,"crossSectionZoom",nJ(this.viewerNavigationState.crossSectionScale)),nf(e,"perspectiveZoom",nJ(this.viewerNavigationState.projectionScale)),nf(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){let{options:e}=this,t=e.showLayerPanel.value;if(void 0!==this.layerPanel&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&void 0===this.layerPanel){let t=this.layerPanel=new Ed(this,()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(t.registerDisposer(function(e,t){let i=new x6(e),r=i.element;r.classList.add("neuroglancer-layer-group-viewer-context-menu");let n=document.createElement("button");n.textContent="Remove layer group",r.appendChild(n),i.registerEventListener(n,"click",()=>{t.layerSpecification.layerManager.clear()});let{viewerNavigationState:s}=t;for(let[e,t]of[["Render scale factors",s.relativeDisplayScales.link],["Render dimensions",s.displayDimensions.link],["Position",s.position.link],["Cross-section orientation",s.crossSectionOrientation.link],["Cross-section zoom",s.crossSectionScale.link],["Cross-section depth range",s.crossSectionDepthRange.link],["3-D projection orientation",s.projectionOrientation.link],["3-D projection zoom",s.projectionScale.link],["3-D projection depth range",s.projectionDepthRange.link]]){let n=i.registerDisposer(new a_(t)),s=document.createElement("label");s.style.display="flex",s.style.flexDirection="row",s.style.whiteSpace="nowrap",s.textContent=e,s.appendChild(n.element),r.appendChild(s)}return i}(t.element,this)),t.element.title="Right click for options, drag to move/copy layer group."):t.element.title="Drag to move/copy layer group.","undefined"!=typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS&&!0===NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS){{let e=document.createElement("button");e.textContent="Clear segments",e.title='De-select all objects ("x")',e.addEventListener("click",e=>{st(e,e,{action:"clear-segments"})}),t.element.appendChild(e)}for(let e of["3d","xy","xz","yz"]){let i=document.createElement("button");i.textContent=e,i.title=`Switch to ${e} layout`,i.addEventListener("click",()=>{let t;t=this.layout.name===e?"3d"!==e?`${e}-3d`:"4panel-alt":e,this.layout.name=t}),t.element.appendChild(i)}}t.element.draggable=!0;let i=t.element;i.addEventListener("dragstart",e=>{s6(e,t.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),x8(e,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});let i=()=>{f&&f.viewer===this&&(f=void 0),this.unregisterDisposer(i)};f={viewer:this,disposer:i},this.registerDisposer(i);let r=this.toJSON();r.layers=void 0,e.dataTransfer.setData(Ec,JSON.stringify(r)),t.element.style.backgroundColor="black",setTimeout(()=>{t.element.style.backgroundColor=""},0)}),t.element.addEventListener("dragend",e=>{s5(e,i,"drag"),x9(),void 0!==f&&f.viewer===this&&f.disposer()}),this.element.insertBefore(i,this.element.firstChild)}}disposed(){sv(this.element);let{layerPanel:e}=this;void 0!==e&&(e.dispose(),this.layerPanel=void 0),super.disposed()}}i(4003);let Ef=Symbol("layoutComponentContainer");class Em extends eh.gj{viewer;parent;changed;componentValue;unsetComponent(){let e=this.componentValue;void 0!==e&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}flex;setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof Eg){let{layerManager:t}=e,i=e.registerCancellable((0,ie.Z)(()=>{0===t.managedLayers.length&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{0===t.managedLayers.length&&i()})),i()}else if(e instanceof ES){let t=e.registerCancellable((0,ie.Z)(()=>{let{length:t}=e;if(0===t&&void 0!==this.parent)this.dispose();else if(1===t){let t;let i=e.get(0).component;if(void 0===this.parent&&i instanceof Eg){t=i.layout.specification.toJSON(),i.viewerNavigationState.copyToParent();let e=i.layerManager.managedLayers,r=new Set(e),{layerSpecification:n}=i;n.rootLayers.filter(e=>r.has(e)||e.archived);let s=[],{managedLayers:a}=n.rootLayers;for(let e=0,t=a.length;e<t;++e)r.has(a[e])&&s.push(e);for(let t=0,i=e.length;t<i;++t)a[s[t]]=e[t];n.rootLayers.layersChanged.dispatch()}else t=i.toJSON();this.setSpecification(t)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}element;constructor(e,t,i){super(),this.viewer=e,this.parent=i,this.changed=new eO.K_,this.flex=new J.TU(1,ef.o7),this.element=document.createElement("div");let{element:r}=this;r.style.display="flex",r.style.flex="1",r.style.position="relative",r.style.alignItems="stretch",r[Ef]=this,this.flex.changed.add(()=>{r.style.flexGrow=""+this.flex.value,this.changed.dispatch()}),this.setSpecification(t);let n=[],s=e=>{let t;let i=document.createElement("div");switch(i.className="neuroglancer-layout-split-drop-zone",i.style[e]="0",e){case"left":case"right":t="row",i.style.width="10px",i.style.height="100%";break;case"top":case"bottom":t="column",i.style.height="10px",i.style.width="100%"}i.style.display="none",n.push({element:i,direction:t,orientation:e}),r.appendChild(i),Eb(i,this.viewer.layerSpecification,()=>this.split(e).newContainer.component,"row"===t?"column":"row")};s("left"),s("right"),s("top"),s("bottom");let a=!1;r.addEventListener("dragenter",e=>{if(!a&&void 0!==x7(e))for(let{element:e,direction:t,orientation:r}of(a=!0,n)){if(void 0!==i&&t===i.direction&&(("left"===r||"top"===r)&&i.get(0)!==this||("bottom"===r||"right"===r)&&i.get(i.length-1)!==this))continue;let{component:n}=this;(!(n instanceof ES)||n.direction!==t)&&(e.style.display="block")}},!0),r.addEventListener("drop",e=>{if(a)for(let{element:e}of(a=!1,n))e.style.display="none"},!0),r.addEventListener("dragleave",e=>{let{relatedTarget:t}=e;if(!(!a||t instanceof HTMLElement&&this.element.contains(t)))for(let{element:e}of(a=!1,n))e.style.display="none"},!0)}toJSON(){let e=this.component.toJSON();return this.parent instanceof ES&&(e.flex=this.flex.toJSON()),e}setSpecification(e){this.setComponent(function(e,t){let i=document.createElement("div");if(i.style.flex="1",i.style.width="0px","string"==typeof t){if(void 0!==e.parent)throw Error(`Invalid layout component specification: ${JSON.stringify(t)}`);return new Ey(i,t,e.viewer)}(0,ef.PT)(t);let r=(0,ef.uq)(t,"type",ef.ZE);switch(r){case"row":case"column":return new ES(i,r,(0,ef.uq)(t,"children",t=>{let i=(0,ef.m7)(t,e=>e);if(void 0===e.parent&&0===i.length)throw Error("Stack layout requires at least one child.");return i}),e);case"viewer":{let r=e.viewer,n=new dW(r.layerSpecification.addRef()),s=new Eg(i,{display:r.display,layerSpecification:n,...Ev(r)},{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues});try{s.restoreState(t)}catch(e){throw s.dispose(),e}return s}default:return new Ey(i,t,e.viewer)}}(this,e)),this.flex.value=(0,ef.Kh)(e,"flex",ef.o7,1)}static getFromElement(e){return e[Ef]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){let t,i,r;let n={type:"viewer"},{parent:s}=this;if(void 0!==s){if("left"===e&&"row"===s.direction||"top"===e&&"column"===s.direction)return{newContainer:s.insertChild(n,this),existingContainer:this};if("right"===e&&"row"===s.direction||"bottom"===e&&"column"===s.direction)return{newContainer:s.insertChild(n),existingContainer:this}}let a=this.component;t=a instanceof Ey?a.layerGroupViewer.toJSON():a.toJSON();let o="left"===e||"right"===e?"row":"column";switch(e){case"left":case"top":i={type:o,children:[n,t]},r=0;break;case"right":case"bottom":i={type:o,children:[t,n]},r=1}this.setSpecification(i);let l=this.component;return{newContainer:l.get(r),existingContainer:l.get(1-r)}}}function Ev(e){return{mouseState:e.mouseState,showAxisLines:e.showAxisLines,wireFrame:e.wireFrame,enableAdaptiveDownsampling:e.enableAdaptiveDownsampling,showScaleBar:e.showScaleBar,scaleBarOptions:e.scaleBarOptions,showPerspectiveSliceViews:e.showPerspectiveSliceViews,inputEventBindings:e.inputEventBindings,visibility:e.visibility,selectedLayer:e.selectedLayer,visibleLayerRoles:e.visibleLayerRoles,navigationState:e.navigationState.addRef(),perspectiveNavigationState:e.perspectiveNavigationState.addRef(),velocity:e.velocity.addRef(),crossSectionBackgroundColor:e.crossSectionBackgroundColor,perspectiveViewBackgroundColor:e.perspectiveViewBackgroundColor,hideCrossSectionBackground3D:e.hideCrossSectionBackground3D}}class Ey extends eh.gj{element;layerGroupViewer;constructor(e,t,i){super(),this.element=e,this.layerGroupViewer=this.registerDisposer(new Eg(e,{display:i.display,layerSpecification:i.layerSpecification.addRef(),...Ev(i)},{showLayerPanel:i.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:i.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}}function Eb(e,t,i,r){e.addEventListener("dragenter",t=>{void 0!==x7(t)&&e.classList.add("neuroglancer-drag-over")}),e.addEventListener("dragleave",t=>{s5(t,e,"drop"),e.classList.remove("neuroglancer-drag-over")}),e.addEventListener("dragover",i=>{let n=(t,r)=>{t.dropEffectMessage&&(r+=` (${t.dropEffectMessage})`),s6(i,e,"drop",r),i.stopPropagation(),i.preventDefault()};if(Eh(i)){let e=function(e,t){let i;let r=function(e){if(f&&f.viewer.layerSpecification.rootLayers===e.rootLayers)return f.viewer}(t),n=!1;return void 0===r||r.layerSpecification===r.layerSpecification.root?i="copy":(n=!0,i="move"),aa(e,i,n)}(i,t);as(i,e.dropEffect),n(e,`Drop to ${e.dropEffect} layer group as new ${r}`);return}if(void 0!==x7(i)){let e=function(e,t,i,r){let n=Ei(e,t,i,r);return as(e,n.dropEffect),n}(i,t,!1,!0);n(e,`Drop to ${e.dropEffect} layer as new ${r}`);return}}),e.addEventListener("drop",r=>{let n,s;if(e.classList.remove("neuroglancer-drag-over"),s5(r,e,"drop"),Eh(r)){r.stopPropagation();try{s=JSON.parse(r.dataTransfer.getData(Ec))}catch{return}if(void 0===(n=Er(r,t,{forceCopy:!1,newTarget:!0})))return}else{if(void 0===(n=Er(r,t,{forceCopy:"copy"===o,newTarget:!0})))return;s=n.layoutSpec}if(!n.initializeExternalLayers(r)){if(!n.moveSupported)for(let e of n.layers.keys())e.dispose();return}r.preventDefault(),x9(r.dataTransfer.dropEffect=o);let a=i();for(let e of(n.updateArchiveStates(r),n.layers.keys()))a.layerSpecification.add(e);try{a.restoreState(s)}catch{a.layout.reset()}})}class ES extends eh.gj{element;direction;container;changed;get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){let t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",Eb(t,this.viewer.layerSpecification,()=>{let e;let i=t.nextElementSibling;return null!==i&&(e=Em.getFromElement(i)),this.insertChild({type:"viewer",layers:[]},e).component},"row"===this.direction?"column":"row"),e.registerDisposer(()=>{sy(t)}),t.addEventListener("pointerdown",e=>{if("button"in e&&0!==e.button)return;let i=t.nextElementSibling;if(null===i)return;let r=Em.getFromElement(i),n=t.previousElementSibling;if(null===n)return;let s=Em.getFromElement(n);e.preventDefault();let a=()=>{s6(e,t,"drag",`Drag to resize, current ${cE[this.direction]} ratio is ${s.flex.value} : ${r.flex.value}`)};a(),so(e,e=>{let t=s.element.getBoundingClientRect(),i=r.element.getBoundingClientRect(),n=Math.max(.1,Math.min(.9,"column"===this.direction?(e.clientY-t.top)/(i.bottom-t.top):(e.clientX-t.left)/(i.right-t.left))),o=Number(s.flex.value)+Number(r.flex.value);s.flex.value=Math.round(n*o*100)/100,r.flex.value=Math.round((1-n)*o*100)/100,a()},e=>{s5(e,t,"drag")})}),t}get viewer(){return this.container.viewer}constructor(e,t,i,r){for(let n of(super(),this.element=e,this.direction=t,this.container=r,this.changed=new eO.K_,e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this)),i))this.insertChild(n)}get(e){return Em.getFromElement(this.element.children[2*e+1])}insertChild(e,t){let i=new Em(this.viewer,e,this),r=this.makeDropPlaceholder(i);i.element.classList.add("neuroglancer-stack-layout-child"),i.registerDisposer(i.changed.add(this.changed.dispatch)),i.registerDisposer(()=>{this.element.removeChild(i.element),this.changed.dispatch()});let n=void 0!==t?t.element:null;return this.element.insertBefore(i.element,n),this.element.insertBefore(r,n),this.changed.dispatch(),i}disposed(){this.clear(),super.disposed()}clear(){for(;0!==this.length;)this.get(0).dispose()}*[Symbol.iterator](){let{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}}class Ew extends eh.gj{viewer;defaultSpecification;container;get changed(){return this.container.changed}get element(){return this.container.element}constructor(e,t){super(),this.viewer=e,this.defaultSpecification=t,this.container=this.registerDisposer(new Em(e,t,void 0))}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}}i(3938);let EC={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1};class Ex{get changed(){return this.location.changed}location=new ds(EC);sortBy;restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return(0,ef.$Z)(this.location.toJSON())}}function EE(e){let t=new Map;return!function e(i,r){if(null==i||"object"!=typeof i){t.set(r,""+i);return}for(let t of Object.keys(i))e(i[t],r+"."+t)}(e,""),t}function ET(e){return Object.assign({type:e.RPC_TYPE_ID},e.key||{})}function Ek(e){let t=e.map(EE),i=function(e){let t=new Set;t.add(".type");let i=new Set;for(let r=0,n=e.length;r<n;++r){for(let t of e[r].keys())i.add(t);let n=[];for(let i=0;i<r;++i)!function(i,r){for(let n of t)if(e[i].get(n)!==e[r].get(n))return!0;return!1}(r,i)&&n.push(i);for(;n.length>0;){let s,a=n;for(let o of i){if(t.has(o))continue;let i=[];for(let t of n)e[t].get(o)===e[r].get(o)&&i.push(t);if(i.length<a.length&&(a=i,s=o),0===i.length)break}if(void 0===s)break;n=a,t.add(s)}}return Array.from(t)}(t);return t.map(e=>(function(e,t){let i={};for(let r of t){let t=e.get(r);if(void 0!==t){if(""===r)return t;i[r]=t}}return JSON.stringify(i)})(e,i))}let ED=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:e=>{let t=0;for(let i=0;i<8;++i)t+=e[(3*i+ii.VISIBLE)*3+is.numChunks];return t}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:e=>e[(3*it.DOWNLOADING+ii.VISIBLE)*3+is.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:e=>e[(3*it.SYSTEM_MEMORY+ii.VISIBLE)*3+is.numChunks]+e[(3*it.SYSTEM_MEMORY_WORKER+ii.VISIBLE)*3+is.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:e=>e[(3*it.GPU_MEMORY+ii.VISIBLE)*3+is.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:e=>e[(3*it.FAILED+ii.VISIBLE)*3+is.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:e=>e[(3*it.GPU_MEMORY+ii.VISIBLE)*3+is.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:e=>e[72+ir.totalTime]/e[72+ir.totalChunks]}];class EL extends cI{chunkQueueManager;displayState;data;requestDataTimerId;dataRequested;body;constructor(e,t,i){super(e,i.location),this.chunkQueueManager=t,this.displayState=i,this.data=void 0,this.requestDataTimerId=-1,this.dataRequested=!1,this.body=document.createElement("div"),this.debouncedUpdateView=this.registerCancellable((0,ie.Z)(()=>this.updateView(),0));let{body:r}=this;r.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(r),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;let{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(e=>{this.dataRequested=!1,this.data=e,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},1e3)})}debouncedUpdateView;updateView(){let{data:e}=this;if(void 0===e)return;let t=document.createElement("table"),i=[];for(let[t,r]of e){let e=[t];for(let{getter:t}of ED)e.push(t(r));i.push(e)}let r=Ek(i.map(e=>ET(e[0]))),n=new Map;r.forEach((e,t)=>{n.set(i[t][0],e)});{let e;let i=document.createElement("thead"),r=document.createElement("tr");i.appendChild(r);let n=e=>{let t=document.createElement("td");t.textContent=e,r.appendChild(t)};for(let{label:t}of(n("Name"),ED)){let i=t.indexOf("/"),s=t;if(-1!==i){if((s=t.substring(0,i))===e){++r.lastElementChild.colSpan;continue}e=s}n(s)}r=document.createElement("tr"),i.appendChild(r);{let e=document.createElement("td");r.appendChild(e)}for(let{label:e}of ED){let t=e.indexOf("/"),i="";-1!==t&&(i=e.substring(t+1));let n=document.createElement("td");n.textContent=i,r.appendChild(n)}t.appendChild(i)}let s=document.createElement("tbody");for(let[e,...t]of i){let i=document.createElement("tr"),r=e=>{let t=document.createElement("td");t.textContent=e,i.appendChild(t)};for(let i of(r(n.get(e)),t))r(""+i);s.appendChild(i)}t.appendChild(s),sv(this.body),this.body.appendChild(t)}}function EI(e){let t=e.layerManager.visibleRenderLayers,i=new Map;for(let r of t)if(r.role===iY.DATA){let t,n=!1,s=r.userLayer.managedLayer.name,a="";if(r instanceof f1?(a="ImageRenderLayer",n=r.visibleSourcesList.length>0,t=r.highestResolutionLoadedVoxelSize):r instanceof mn?(a="VolumeRenderingRenderLayer",n=r.visibility.visible,t=r.highestResolutionLoadedVoxelSize):r instanceof pS&&(a="SegmentationRenderLayer",n=r.visibleSourcesList.length>0,t=r.highestResolutionLoadedVoxelSize),!n)continue;i.set({name:s,type:a},function(t,i){if(void 0===t)return[];let r=[],{globalDimensionNames:n,displayDimensionUnits:s,displayDimensionIndices:a}=e.navigationState.displayDimensionRenderInfo.value,o=a[0],l=!0;if(-1!==o){let e=s[0],i=t[0];for(let r=1;r<3;++r)if(-1!==a[r]&&(s[r]!==e||i!==t[r])){l=!1;break}}for(let e=0;e<3;++e){let o=a[e];if(-1!==o){let a=n[o];if(0===e||!l){let n=ta(t[e],s[e],{precision:2,elide1:!1});r.push({panelType:i,resolutionWithUnit:`${n}`,dimensionName:l?"All_":a})}}}return r}(t,a))}return i}function EP(e,t=!0){let i=[];for(let t of e){if(!(t instanceof C8))continue;let{width:e,height:r}=t.renderViewport,n=t.canvasRelativeClippedLeft,s=t.canvasRelativeClippedTop,a=n+e,o=s+r,{panelType:l,panelDimensionUnit:d}=ER(t),u={pixelResolution:{left:n,right:a,top:s,bottom:o,panelType:l},physicalResolution:[]},{physicalResolution:c}=u,{navigationState:h}=t,{displayDimensionIndices:p,canonicalVoxelFactors:g,displayDimensionUnits:f,displayDimensionScales:m,globalDimensionNames:v}=h.displayDimensionRenderInfo.value,{factors:y}=h.relativeDisplayScales.value,b=h.zoomFactor.value,S=p[0],w=!0;if(-1!==S){let e=f[0],t=y[S];for(let i=1;i<3;++i){let r=p[i];if(-1!==r&&(f[i]!==e||y[r]!==t)){w=!1;break}}}for(let e=0;e<3;++e){let t=p[e];if(-1!==t){let i=m[e]*b/g[e],r=v[t];if(0===e||!w){let t=ta(i,f[e],{precision:2,elide1:!1});c.push({panelType:l,resolutionWithUnit:`${t}/${d}`,dimensionName:w?"All_":r})}}}i.push(u)}if(!t)return i;let r=[];for(let e of i){let t=!1;for(let i of r)if(function(e,t){let i=e.physicalResolution,r=t.physicalResolution;if(i.length!==r.length)return!1;for(let e=0;e<i.length;++e){let t=i[e],n=r[e];if(t.resolutionWithUnit!==n.resolutionWithUnit||t.panelType!==n.panelType||t.dimensionName!==n.dimensionName)return!1}let n=e.pixelResolution,s=t.pixelResolution,a=Math.round(n.right-n.left),o=Math.round(s.right-s.left),l=Math.round(n.bottom-n.top),d=Math.round(s.bottom-s.top);return a===o&&l===d}(e,i)){t=!0;break}t||r.push(e)}return r}function ER(e){let t;let i=e instanceof xS&&e.viewer.orthographicProjection.value,r=e instanceof xk||i?"px":"vh";return{panelType:e instanceof xk?"Slice view (2D)":i?"Orthographic projection (3D)":e instanceof xS?"Perspective projection (3D)":"Unknown",panelDimensionUnit:r}}function EA(e){let t={left:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY,top:Number.POSITIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY,panelType:"All"},i=[];for(let r of e){if(!(r instanceof C8))continue;let{width:e,height:n}=r.renderViewport,s=r.canvasRelativeClippedLeft,a=r.canvasRelativeClippedTop,o=s+e,l=a+n;t.left=Math.floor(Math.min(t.left,s)),t.right=Math.ceil(Math.max(t.right,o)),t.top=Math.ceil(Math.min(t.top,a)),t.bottom=Math.floor(Math.max(t.bottom,l)),i.push({left:s,right:o,top:a,bottom:l,panelType:ER(r).panelType})}return{totalRenderPanelViewport:t,individualRenderPanelViewports:i}}function EM(e){if(0===e.length)return null;let t=e[0];if("All_"===t.dimensionName)return{type:t.panelType,resolution:t.resolutionWithUnit};{let i=e.map(e=>`${e.dimensionName} ${e.resolutionWithUnit}`).join(" ");return{type:t.panelType,resolution:i}}}function EN(e){let t=EP(e.display.panels),i=[];for(let e of t){let t=EM(e.physicalResolution);if(null===t)continue;let r=function(e){let t=Math.round(e.right-e.left);return{width:t,height:Math.round(e.bottom-e.top),type:e.panelType}}(e.pixelResolution);i.push({type:t.type,width:r.width,height:r.height,resolution:t.resolution})}let r=EI(e),n=[];for(let[e,t]of r){let{name:i,type:r}=e;if("MultiscaleMeshLayer"===r)continue;let s=EM(t);null!==s&&n.push({name:i,type:r,resolution:s.resolution})}return{panelResolutionData:i,layerResolutionData:n}}class EV extends eh.gj{viewer;sendScreenshotRequested;sendStatisticsRequested;requestState;wasAlreadyVisible;previousRequest;debouncedMaybeSendScreenshot;statisticsRequested;throttledSendStatistics;constructor(e){super(),this.viewer=e,this.sendScreenshotRequested=new eO.MZ,this.sendStatisticsRequested=new eO.MZ,this.requestState=new J.TU(void 0,ef.kt),this.wasAlreadyVisible=!1,this.previousRequest=void 0,this.debouncedMaybeSendScreenshot=this.registerCancellable((0,ie.Z)(()=>this.maybeSendScreenshot(),0)),this.statisticsRequested=!1,this.throttledSendStatistics=this.registerCancellable((0,lX.Z)(async e=>{if(this.requestState.value!==e||this.previousRequest===e||(this.throttledSendStatistics(e),this.statisticsRequested))return;this.statisticsRequested=!0;let t=await this.viewer.chunkQueueManager.getStatistics();if(this.statisticsRequested=!1,this.wasDisposed||this.requestState.value!==e||this.previousRequest===e)return;let i=Ek(Array.from(t,e=>ET(e[0]))),r=0,n=[],s=new Float64Array(74);for(let[e,a]of t){for(let e=0;e<74;++e)s[e]+=a[e];let t={};for(let n of(t.id=ET(e),t.distinctId=i[r],ED))t[n.key]=n.getter(a);++r,n.push(t)}let a={};for(let e of ED)a[e.key]=e.getter(s);let o={viewerState:JSON.parse(JSON.stringify(ny(this.viewer.state).value)),selectedValues:JSON.parse(JSON.stringify(this.viewer.layerSelectedValues,ef.qG)),screenshotStatistics:{id:e,chunkSources:n,total:a}};this.sendStatisticsRequested.dispatch(o)},1e3,{leading:!1,trailing:!0})),this.requestState.changed.add(this.debouncedMaybeSendScreenshot),this.registerDisposer(e.display.updateFinished.add(this.debouncedMaybeSendScreenshot))}async maybeSendScreenshot(){let e,t,i;let r=this.requestState.value,{previousRequest:n}=this,{layerSelectedValues:s}=this.viewer;if(void 0===r||r===n){this.wasAlreadyVisible=!1,this.throttledSendStatistics.cancel();return}let{viewer:a}=this,o=this.viewer.display.screenshotMode.value===ic.u.FORCE;if(!a.isReady()&&!o){this.wasAlreadyVisible=!1,this.throttledSendStatistics(r);return}if(!this.wasAlreadyVisible&&!o){this.throttledSendStatistics(r),this.wasAlreadyVisible=!0,this.debouncedMaybeSendScreenshot();return}this.wasAlreadyVisible=!1,this.previousRequest=r,this.throttledSendStatistics.cancel(),a.display.draw();let l=a.display.canvas.toDataURL(),d=EN(a),{width:u,height:c}=a.display.canvas,h="data:image/png;base64,";if(l.startsWith(h)){if(e="image/png",t=l.substring(h.length),r.endsWith("_includeDepth")){let e=a.display.getDepthArray();!function(e,t,i=eg){t!==i&&function(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,i=t.length;e<i;e+=4){let i=t[e];t[e]=t[e+3],t[e+3]=i,i=t[e+1],t[e+1]=t[e+2],t[e+2]=i}}(e)}(e,ep.LITTLE),i=await new Promise(t=>{let i=new Blob([e],{type:"application/octet-stream"}),r=new FileReader;r.onload=e=>{let i=e.target.result;t(i.substr(i.indexOf(",")+1))},r.readAsDataURL(i)})}}else e="",t="";let p={viewerState:JSON.parse(JSON.stringify(ny(this.viewer.state).value)),selectedValues:JSON.parse(JSON.stringify(s,ef.qG)),screenshot:{id:r,image:t,imageType:e,depthData:i,width:u,height:c,resolutionMetadata:d}};this.sendScreenshotRequested.dispatch(p)}}i(7422);var EO=i(7597);i(8263);var EF=i(2491);let EB=se.fromObject({escape:{action:"cancel"}});class E_ extends eh.gj{layer;element;constructor(e){super(),this.layer=e,this.element=document.createElement("input");let{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off",this.registerDisposer(new aM(t,EB)).allShortcutsAreGlobal=!0,ss(t,"cancel",e=>{this.updateView(),t.blur(),e.stopPropagation(),e.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){dX(this.layer,this.element.value)}}class EU extends eh.gj{layer;element;measureElement;constructor(e){super(),this.layer=e,this.element=document.createElement("select"),this.measureElement=document.createElement("div");let{element:t,measureElement:i}=this;for(let[e,r]of(t.classList.add("neuroglancer-layer-side-panel-type"),i.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(i),dq)){if(r.type!==e)continue;let i=document.createElement("option");i.textContent=r.typeAbbreviation,i.value=e,t.appendChild(i)}t.addEventListener("change",()=>{let e=t.value,i=dq.get(e);dY(this.layer.managedLayer,i)}),this.updateView()}updateView(){let e=this.layer.type,{element:t,measureElement:i}=this;i.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${i.offsetWidth}px`}disposed(){this.measureElement.remove()}}class E$ extends cI{panelState;tabView;layer;constructor(e,t){super(e,t.location),this.panelState=t;let i=this.layer=t.layer,{element:r}=this,{titleBar:n}=this.addTitleBar({});n.classList.add("neuroglancer-layer-side-panel-title"),n.appendChild(this.registerDisposer(new EU(i)).element),n.appendChild(this.registerDisposer(new E_(i.managedLayer)).element),this.registerDisposer((0,J.Jk)(e=>{r.dataset.neuroglancerLayerVisible=e.toString()},{get value(){return i.managedLayer.visible},changed:i.managedLayer.layerChanged}));let s=this.registerDisposer(new aN({get value(){return i.managedLayer.pickEnabled},set value(value){i.managedLayer.pickEnabled=value},changed:i.managedLayer.layerChanged},{svg:EF,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new i6({get value(){return i.managedLayer.supportsPickOption},changed:i.managedLayer.layerChanged},s.element)),n.appendChild(s.element);let a={get value(){return t!==i.panels.panels[0]},set value(value){value?t.pin():t.unpin()},changed:i.manager.root.layerManager.layersChanged};n.appendChild(this.registerDisposer(new aN(a,{text:"\uD83D\uDCCC︎",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer((0,J.Jk)(e=>{r.dataset.neuroglancerLayerPanelPinned=e.toString()},a)),n.appendChild(gs({title:"Delete layer",onClick:()=>{dQ(this.layer.managedLayer)}})),this.tabView=new sL({makeTab:e=>i.tabs.options.get(e).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new J.mJ({get value(){return t.tabs.map(e=>{let{label:t,hidden:r}=i.tabs.options.get(e);return{id:e,label:t,hidden:r?.value||!1}})},changed:t.tabsChanged})),handleTabElement:(e,r)=>{r.draggable=!0,r.addEventListener("dragstart",n=>{let s="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(e=>e!==t&&e.location.visible)&&(s+=`, or move tab to other ${JSON.stringify(i.managedLayer.name)} panel`),s6(n,r,"drag",s),this.sidePanelManager.startDrag({dropAsNewPanel:t=>{this.panelState.splitOffTab(e,{...du,...t})},getNewPanelDropEffect:()=>({description:"tab",dropEffect:"move"}),canDropAsTabs:e=>e instanceof E$&&e.layer===this.layer&&e!==this?1:0,dropAsTab:t=>{this.panelState.moveTabTo(e,t.panelState)}},n)}),r.addEventListener("dragend",e=>{s5(e,r,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{0===t.tabs.length&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof E$&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){let e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{let{dragSource:i}=this.sidePanelManager,r=i?.canDropAsTabs?.(this);r&&(e.classList.add(cb),s6(t,e,"drop",`Move ${r} ${1===r?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",t=>{s5(t,e,"drop"),e.classList.remove(cb)}),e.addEventListener("dragover",e=>{let{dragSource:t}=this.sidePanelManager;t?.canDropAsTabs?.(this)&&e.preventDefault()}),e.addEventListener("drop",t=>{s5(t,e,"drop");let{dragSource:i}=this.sidePanelManager;i?.canDropAsTabs?.(this)&&(e.classList.remove(cb),i.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}}class Ez extends eh.gj{sidePanelManager;selectedLayerState;placeholderSelectedLayerPanel;layerSidePanels;generation;layersNeedUpdate;constructor(e,t){super(),this.sidePanelManager=e,this.selectedLayerState=t,this.layerSidePanels=new Map,this.generation=0,this.layersNeedUpdate=!0;let i=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(i)),this.registerDisposer(t.layerManager.layersChanged.add(i)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){return this.selectedLayerState.layer?.layer??void 0}update(){if(!this.layersNeedUpdate)return;let{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;let{layerSidePanels:i}=this,r=e=>{let r=i.get(e);void 0===r?(r={generation:t,unregister:this.sidePanelManager.registerPanel({location:e.location,makePanel:()=>new E$(this.sidePanelManager,e)})},i.set(e,r)):r.generation=t};{let e=this.getSelectedUserLayer(),{location:t}=this.selectedLayerState;if(void 0!==e&&t.visible){this.placeholderSelectedLayerPanel?.(),this.placeholderSelectedLayerPanel=void 0;let i=e.panels.panels[0];i.location.value=t.value,r(i)}else void 0===this.placeholderSelectedLayerPanel&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:t,makePanel:()=>new cI(this.sidePanelManager,t)}))}for(let t of e.managedLayers){let e=t.layer;if(null===e)continue;let{panels:i}=e.panels;for(let e=1,t=i.length;e<t;++e)r(i[e])}for(let[e,r]of i)r.generation!==t&&(r.unregister(),i.delete(e))}disposed(){for(let{unregister:e}of(this.placeholderSelectedLayerPanel?.(),this.layerSidePanels.values()))e()}}i(1399);class EG extends eh.gj{layer;element;constructor(e){super(),this.layer=e,this.element=document.createElement("div"),this.element.classList.add("neuroglancer-layer-type-indicator"),this.registerDisposer(e.layerChanged.add(()=>this.updateView())),this.updateView()}updateView(){let e=this.layer.layer?.type??"unknown";this.element.textContent=dq.get(e)?.typeAbbreviation??"—",this.element.title=`${e?e[0].toUpperCase()+e.slice(1):""} layer (modifiable in the layer settings)`}}let Ej={...dn,side:"left",row:0};class EW{location=new ds(Ej);get changed(){return this.location.changed}restoreState(e){void 0!==e&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return(0,ef.$Z)(this.location.toJSON())}}class Eq extends eh.gj{layer;element;constructor(e){super(),this.layer=e,this.element=document.createElement("div");let{element:t}=this,i=sC({svg:EO,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),r=sC({svg:cN,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});i.classList.add("neuroglancer-layer-list-panel-eye-icon"),r.classList.add("neuroglancer-layer-list-panel-eye-icon"),t.appendChild(r),t.appendChild(i);let n=()=>{let e=this.layer.visible;i.style.display=e?"":"none",r.style.display=e?"none":""};n(),this.registerDisposer(e.layerChanged.add(n))}}class EH extends eh.gj{panel;layer;element;numberElement;generation;constructor(e,t){super(),this.panel=e,this.layer=t,this.element=document.createElement("div"),this.numberElement=document.createElement("div"),this.generation=-1;let{element:i,numberElement:r}=this;i.classList.add("neuroglancer-layer-list-panel-item"),r.classList.add("neuroglancer-layer-list-panel-item-number");let n=this.registerDisposer(new E_(t));n.element.classList.add("neuroglancer-layer-list-panel-item-name"),i.appendChild(this.registerDisposer(new i4({get value(){return!t.archived},set value(value){t.setArchived(!value)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),i.appendChild(r),i.appendChild(this.registerDisposer(new Eq(t)).element),i.appendChild(new EG(t).element),i.appendChild(n.element),i.appendChild(this.registerDisposer(function(e){let{selectedLayer:t}=e.manager.root,i=new aN({get value(){return t.layer===e&&t.visible},set value(value){value?(t.layer=e,t.visible=!0):t.visible=!1},changed:t.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:CU});return i.element.classList.add("neuroglancer-layer-list-panel-item-controls"),i}(t)).element);let s=gs({title:"Delete layer",onClick:()=>{dQ(this.layer)}});s.classList.add("neuroglancer-layer-list-panel-item-delete"),i.appendChild(s),Ea(e,i,t,{isLayerListPanel:!0,getLayoutSpec:()=>void 0}),Es(e,i,t,!0),i.addEventListener("click",i=>{i.ctrlKey?(e.selectedLayer.toggle(t),i.preventDefault()):i.altKey&&(t.pickEnabled=!t.pickEnabled,i.preventDefault())}),i.addEventListener("contextmenu",i=>{e.selectedLayer.toggle(t),i.stopPropagation(),i.preventDefault()})}}class EJ extends cI{manager;state;items;itemContainer;layerDropZone;titleElement;get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}dropLayers;dragEnterCount;generation;constructor(e,t,i){super(e,i.location),this.manager=t,this.state=i,this.items=new Map,this.itemContainer=document.createElement("div"),this.layerDropZone=document.createElement("div"),this.dragEnterCount=0,this.generation=-1;let{itemContainer:r,layerDropZone:n}=this,{titleElement:s}=this.addTitleBar({title:""});this.titleElement=s,r.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(r),n.style.flex="1";let a=this.registerCancellable((0,io.H)(()=>this.render()));this.visibility.changed.add(a),this.registerDisposer(this.layerManager.layersChanged.add(a)),this.registerDisposer(this.selectedLayer.changed.add(a)),Eo(this),Es(this,n,void 0,!0),this.render()}render(){let e=this,t=this.selectedLayer.layer,i=++this.generation,r=0,n=0,s=0;this.layerManager.updateNonArchivedLayerIndices(),sS(this.itemContainer,function*(){let{items:a}=e,o=0;for(let t of e.layerManager.managedLayers)!t.archived&&++o;let l=`${o.toString().length}ch`;for(let o of e.layerManager.managedLayers){o.visible?++r:o.archived?++s:++n;let d=a.get(o);void 0===d&&(d=e.registerDisposer(new EH(e,o)),a.set(o,d)),d.generation=i;let{nonArchivedLayerIndex:u}=o;d.numberElement.style.width=l,o.archived?d.numberElement.style.visibility="hidden":(d.numberElement.style.visibility="",d.numberElement.textContent=`${u+1}`),d.element.dataset.selected=(o===t).toString(),d.element.dataset.archived=o.archived.toString(),yield d.element}for(let[t,r]of a)i!==r.generation&&(a.delete(t),e.unregisterDisposer(r),r.dispose());yield e.layerDropZone}());let a="Layers";if(r||n||s){a+=" (";let e="";r+n&&(a+=`${r}/${n+r} visible`,e=", "),s&&(a+=`${e}${s} archived`),a+=")"}this.titleElement.textContent=a}}class EK extends eh.gj{layerManager;element;constructor(e){super(),this.layerManager=e,this.element=document.createElement("div");let t=this.registerCancellable((0,io.H)(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0,{managedLayers:t}=this.layerManager;for(let i of t)i.archived&&++e;let{element:i}=this;if(0!==e){let r=t.length;i.textContent=`${r-e}/${r}`}else i.textContent=""}}async function EZ(e,t){var i;let r=t.right-t.left,n=t.bottom-t.top,s=await createImageBitmap(e.display.canvas,t.left,t.top,r,n),a=document.createElement("canvas");a.width=r,a.height=n;let o=a.getContext("2d");if(!o)throw Error("Failed to get canvas context");return o.drawImage(s,0,0),await (i="image/png",new Promise((e,t)=>{a.toBlob(i=>{i?e(i):t(Error("Canvas toBlob failed"))},i)}))}i(8400);class EY extends eh.gj{viewer;screenshotId;screenshotLoadStats;screenshotStartTime;screenshotMode;statisticsUpdated;screenshotFinished;zoomMaybeChanged;_shouldKeepSliceViewFOVFixed;_screenshotScale;filename;lastUpdateTimestamp;gpuMemoryChangeTimestamp;throttledSendStatistics;constructor(e){super(),this.viewer=e,this.screenshotId=-1,this.screenshotLoadStats=null,this.screenshotStartTime=0,this.screenshotMode=ic.u.OFF,this.statisticsUpdated=new eO.MZ,this.screenshotFinished=new eO.K_,this.zoomMaybeChanged=new eO.K_,this._shouldKeepSliceViewFOVFixed=!0,this._screenshotScale=1,this.filename="",this.lastUpdateTimestamp=0,this.gpuMemoryChangeTimestamp=0,this.throttledSendStatistics=this.registerCancellable((0,lX.Z)(async()=>{let e=await this.viewer.chunkQueueManager.getStatistics();if(this.wasDisposed)return;let t=Ek(Array.from(e,e=>ET(e[0]))),i=0,r=[],n=new Float64Array(74);for(let[s,a]of e){for(let e=0;e<74;++e)n[e]+=a[e];let e={};for(let r of(e.id=ET(s),e.distinctId=t[i],ED))e[r.key]=r.getter(a);++i,r.push(e)}let s={};for(let e of ED)s[e.key]=e.getter(n);let a={...s,timestamp:Date.now(),gpuMemoryCapacity:this.viewer.chunkQueueManager.capacities.gpuMemory.sizeLimit.value};this.statisticsUpdated.dispatch(a)},1e3)),this.viewer=e,this.registerDisposer(this.viewer.screenshotHandler.sendScreenshotRequested.add(e=>{this.saveScreenshot(e)})),this.registerDisposer(this.viewer.screenshotHandler.sendStatisticsRequested.add(e=>{let t={...e.screenshotStatistics.total,timestamp:Date.now(),gpuMemoryCapacity:this.viewer.chunkQueueManager.capacities.gpuMemory.sizeLimit.value};this.checkAndHandleStalledScreenshot(e,t),this.screenshotLoadStats=t})),this.registerDisposer(this.viewer.display.updateFinished.add(()=>{this.lastUpdateTimestamp=Date.now(),this.throttledSendStatistics()})),this.registerDisposer(this.viewer.display.screenshotMode.changed.add(()=>{this.handleScreenshotModeChange()}))}get screenshotScale(){return this._screenshotScale}set screenshotScale(e){this._screenshotScale=this.handleScreenshotZoomAndResize(e),this.zoomMaybeChanged.dispatch()}get shouldKeepSliceViewFOVFixed(){return this._shouldKeepSliceViewFOVFixed}set shouldKeepSliceViewFOVFixed(e){let t=this.shouldKeepSliceViewFOVFixed;this._shouldKeepSliceViewFOVFixed=e,!e&&t?(this.handleScreenshotZoomAndResize(this.screenshotScale,!0),this.zoomMaybeChanged.dispatch()):e&&!t&&(this.handleScreenshotZoomAndResize(1/this.screenshotScale,!0),this.zoomMaybeChanged.dispatch())}previewScreenshot(){this.viewer.display.screenshotMode.value=ic.u.PREVIEW}takeScreenshot(e=""){this.filename=e,this.viewer.display.screenshotMode.value=ic.u.ON}forceScreenshot(){this.viewer.display.screenshotMode.value=ic.u.FORCE}cancelScreenshot(e=!1){this.screenshotMode===ic.u.ON&&this.screenshotId--;let t=e?ic.u.PREVIEW:ic.u.OFF;this.viewer.display.screenshotMode.value=t}calculatedClippedViewportSize(){let e=EA(this.viewer.display.panels).totalRenderPanelViewport;return{width:Math.round(e.right-e.left),height:Math.round(e.bottom-e.top)}}handleScreenshotStarted(){this.screenshotStartTime=this.lastUpdateTimestamp=this.gpuMemoryChangeTimestamp=Date.now(),this.screenshotLoadStats=null,this.screenshotId++,this.viewer.screenshotHandler.requestState.value=this.screenshotId.toString()}resizeCanvasIfNeeded(e=this.screenshotScale){let{viewer:t}=this;if(1!==e){let i={width:t.display.canvas.width,height:t.display.canvas.height},r={width:Math.round(i.width*e),height:Math.round(i.height*e)};t.display.canvas.width=r.width,t.display.canvas.height=r.height,t.display.resizeCallback()}}handleScreenshotModeChange(){let{display:e}=this.viewer,t=this.screenshotMode===ic.u.OFF;switch(this.screenshotMode=e.screenshotMode.value,this.screenshotMode){case ic.u.OFF:this.resetCanvasSize(),this.resetStatistics(),this.viewer.screenshotHandler.requestState.value=void 0;break;case ic.u.FORCE:e.scheduleRedraw();break;case ic.u.ON:t&&this.resizeCanvasIfNeeded(),this.handleScreenshotStarted();case ic.u.PREVIEW:}}handleScreenshotZoomAndResize(e,t=!1){let i=this.screenshotScale,r=e;if(!t&&e>1){let e=this.calculatedClippedViewportSize(),t=e.width*e.height/(i*i);t*r*r>2601e4&&(r=Math.sqrt(2601e4/t))}let n=r/i,s=t?e:1/n;if(this.shouldKeepSliceViewFOVFixed||t){let{navigationState:e}=this.viewer;for(let t of this.viewer.display.panels)if(t instanceof xk){let t=e.zoomFactor.value;e.zoomFactor.value=t*s;break}}return this.resizeCanvasIfNeeded(t?1:n),r}checkAndHandleStalledScreenshot(e,t){if(null===this.screenshotLoadStats)return;let i=e.screenshotStatistics.total,r={visibleChunksGpuMemory:i.visibleChunksGpuMemory,timestamp:Date.now(),totalGpuMemory:this.viewer.chunkQueueManager.capacities.gpuMemory.sizeLimit.value,numDownloadingChunks:i.visibleChunksDownloading},n=this.screenshotLoadStats;if(n.visibleChunksGpuMemory===r.visibleChunksGpuMemory&&(n.gpuMemoryCapacity===r.totalGpuMemory||0==r.numDownloadingChunks)){if(r.timestamp-this.gpuMemoryChangeTimestamp>3e3&&Date.now()-this.lastUpdateTimestamp>3e3){this.statisticsUpdated.dispatch(t);let e=`Forcing screenshot: screenshot is likely stuck, no change in GPU chunks after 3000ms. Last visible chunks: ${i.visibleChunksGpuMemory}/${i.visibleChunksTotal}`;console.warn(e),s1.showTemporaryMessage(e,5e3),this.forceScreenshot()}}else this.gpuMemoryChangeTimestamp=r.timestamp}async saveScreenshot(e){let{screenshot:t}=e,{imageType:i}=t;if("image/png"!==i){console.error("Image type is not PNG"),this.viewer.display.screenshotMode.value=ic.u.OFF;return}let r=EA(this.viewer.display.panels).totalRenderPanelViewport;try{let e=await EZ(this.viewer,r);this.generateFilename(r.right-r.left,r.bottom-r.top),function(e,t){let i=document.createElement("a"),r=URL.createObjectURL(e);i.href=r,i.download=t;try{i.click()}finally{URL.revokeObjectURL(r)}}(e,this.filename)}catch(e){console.error("Failed to save screenshot:",e)}finally{this.viewer.display.screenshotMode.value=ic.u.OFF,this.screenshotFinished.dispatch()}}resetCanvasSize(){let{viewer:e}=this;++e.display.resizeGeneration,e.display.resizeCallback()}resetStatistics(){this.screenshotLoadStats=null}generateFilename(e,t){if(!this.filename){let i=new Date().toLocaleString().replace(", ","-");this.filename=`neuroglancer-screenshot-w${e}px-h${t}px-at-${i}`}return this.filename=function(e,t=".png"){return e.endsWith(t)?e:function(e){let i=e.lastIndexOf(".");return -1===i?e+t:`${e.substring(0,i)}${t}`}(e)}(this.filename),this.filename}}let EX={chunkUsageDescription:"Number of loaded chunks",gpuMemoryUsageDescription:"Visible chunk GPU memory usage",downloadSpeedDescription:"Number of downloading chunks"},EQ={ImageRenderLayer:"Image slice (2D)",VolumeRenderingRenderLayer:"Volume rendering (3D)",SegmentationRenderLayer:"Segmentation slice (2D)"};function E0(e,t=60){let i=e.split(" "),r=[],n="";for(let e of i)(n+e).length>t?(r.push(n.trim()),n=e+" "):n+=e+" ";return r.push(n.trim()),r.join("\n")}function E1(e){if(0===e.length)return{type:"Loading...",resolution:"Data not loaded"};let t=e[0],i=t.panelType;return"All_"===t.dimensionName?{type:i,resolution:t.resolutionWithUnit}:{type:i,resolution:e.map(e=>`<span class="neuroglancer-screenshot-dimension">${e.dimensionName}</span> ${e.resolutionWithUnit}`).join(" ")}}function E2(e){let t=e=>{let[t,i=""]=e.split("/");return{formattedScale:t,unit:i}},i=(e,i)=>{let{formattedScale:r,unit:n}=t(i),s=to(r);if(!s)throw Error(`Invalid scale: ${i}`);return{formattedScale:r,dimension:e,scale:s.scale,unit:s.unit,...n&&{panelViewportUnit:n}}};return e.includes(" ")?e.split(" ").reduce((e,t,r,n)=>(r%2==0&&e.push(i(t,n[r+1])),e),[]):[i("Uniform",e)]}class E3 extends g8{screenshotManager;nameInput;takeScreenshotButton;closeMenuButton;cancelScreenshotButton;forceScreenshotButton;statisticsTable;panelResolutionTable;layerResolutionTable;statisticsContainer;filenameInputContainer;screenshotSizeText;warningElement;footerScreenshotActionBtnsContainer;progressText;scaleRadioButtonsContainer;keepSliceFOVFixedCheckbox;helpTooltips;statisticsKeyToCellMap;layerResolutionKeyToCellMap;throttledUpdateTableStatistics;screenshotWidth;screenshotHeight;screenshotPixelSize;constructor(e){super(),this.screenshotManager=e,this.statisticsKeyToCellMap=new Map,this.layerResolutionKeyToCellMap=new Map,this.throttledUpdateTableStatistics=this.registerCancellable((0,lX.Z)(()=>{this.populateLayerResolutionTable(),this.handleScreenshotResize(),this.populatePanelResolutionTable()},500)),this.screenshotWidth=0,this.screenshotHeight=0,this.initializeUI(),this.setupEventListeners(),this.screenshotManager.throttledSendStatistics()}dispose(){super.dispose(),this.screenshotManager.shouldKeepSliceViewFOVFixed=!0,this.screenshotManager.screenshotScale=1,this.screenshotManager.cancelScreenshot()}close(){this.screenshotMode!==ic.u.PREVIEW?s1.showTemporaryMessage("Cannot close screenshot menu while a screenshot is in progress. Hit 'Cancel screenshot' to stop the screenshot, or 'Force screenshot' to screenshot the currently available data.",4e3):super.close()}setupHelpTooltips(){let e=sC({svg:pC,title:E0("In the main viewer, see the settings (cog icon, top right) for options to turn off the axis line indicators, the scale bar, and the default annotation yellow bounding box.")}),t=sC({svg:pC,title:"In the main viewer, press 'o' to toggle between perspective and orthographic views."});t.classList.add("neuroglancer-screenshot-resolution-table-tooltip");let i=sC({svg:pC,title:E0("The highest loaded resolution of 2D image slices, 3D volume renderings, and 2D segmentation slices are shown here. Other layers are not shown.")});i.classList.add("neuroglancer-screenshot-resolution-table-tooltip");let r=sC({svg:pC,title:E0("Adjusting the scale will zoom out 2D cross-section panels by that factor unless the box is ticked to keep the slice FOV fixed with scale changes. 3D panels always have fixed FOV regardless of the scale factor.")}),n=sC({svg:pC,title:E0("Set the display scale or the 2D panel FOV (pixel resolution x physical scale) by hovering over the top left dimension indicator in the main viewer panels.")});return n.classList.add("neuroglancer-screenshot-resolution-table-tooltip"),this.helpTooltips={generalSettingsTooltip:e,orthographicSettingsTooltip:t,layerDataTooltip:i,scaleFactorHelpTooltip:r,panelScaleTooltip:n}}initializeUI(){let e=this.setupHelpTooltips();this.content.classList.add("neuroglancer-screenshot-dialog");let t=this.content.parentElement;t&&t.classList.add("neuroglancer-screenshot-overlay");let i=document.createElement("h2");i.classList.add("neuroglancer-screenshot-title"),i.textContent="Screenshot",this.closeMenuButton=this.createButton(null,()=>this.close(),"neuroglancer-screenshot-close-button",sZ),this.cancelScreenshotButton=this.createButton("Cancel screenshot",()=>this.cancelScreenshot(),"neuroglancer-screenshot-footer-button"),this.takeScreenshotButton=this.createButton("Take screenshot",()=>this.screenshot(),"neuroglancer-screenshot-footer-button"),this.forceScreenshotButton=this.createButton("Force screenshot",()=>this.forceScreenshot(),"neuroglancer-screenshot-footer-button"),this.filenameInputContainer=document.createElement("div"),this.filenameInputContainer.classList.add("neuroglancer-screenshot-filename-container");let r=document.createElement("h3");r.classList.add("neuroglancer-screenshot-title-subheading"),r.classList.add("neuroglancer-screenshot-title"),r.textContent="Settings",r.appendChild(e.generalSettingsTooltip),this.filenameInputContainer.appendChild(r);let n=document.createElement("label");n.textContent="Screenshot name",n.classList.add("neuroglancer-screenshot-label"),n.classList.add("neuroglancer-screenshot-name-label"),this.filenameInputContainer.appendChild(n),this.filenameInputContainer.appendChild(this.createNameInput());let s=document.createElement("div");s.classList.add("neuroglancer-screenshot-close"),s.appendChild(i),s.appendChild(this.closeMenuButton),this.content.appendChild(s);let a=document.createElement("div");a.classList.add("neuroglancer-screenshot-main-body-container"),this.content.appendChild(a),a.appendChild(this.filenameInputContainer),a.appendChild(this.createScaleRadioButtons());let o=document.createElement("div");o.classList.add("neuroglancer-screenshot-resolution-preview-container");let l=document.createElement("div");l.classList.add("neuroglancer-screenshot-resolution-table-container");let d=document.createElement("div");d.classList.add("neuroglancer-screenshot-resolution-preview-top-container"),d.style.display="flex";let u=document.createElement("h2");u.classList.add("neuroglancer-screenshot-title"),u.textContent="Preview",this.screenshotSizeText=document.createElement("div"),this.screenshotSizeText.classList.add("neuroglancer-screenshot-label"),this.screenshotSizeText.classList.add("neuroglancer-screenshot-size-text");let c=document.createElement("h3");c.textContent="Screenshot size",c.classList.add("neuroglancer-screenshot-resolution-size-label"),this.screenshotPixelSize=document.createElement("span"),this.screenshotPixelSize.classList.add("neuroglancer-screenshot-resolution-size-value");let h=aO({title:"Copy table to clipboard",onClick:()=>{let e=aI(this.generateScreenshotMetadataJson());s1.showTemporaryMessage(e?"Resolution metadata JSON copied to clipboard":"Failed to copy resolution JSON to clipboard")}});h.classList.add("neuroglancer-screenshot-copy-icon"),this.screenshotSizeText.appendChild(c),this.screenshotSizeText.appendChild(this.screenshotPixelSize),o.appendChild(d),d.appendChild(u),d.appendChild(h),o.appendChild(this.screenshotSizeText),o.appendChild(l),l.appendChild(this.createPanelResolutionTable()),l.appendChild(this.createLayerResolutionTable()),a.appendChild(o),a.appendChild(this.createStatisticsTable()),this.footerScreenshotActionBtnsContainer=document.createElement("div"),this.footerScreenshotActionBtnsContainer.classList.add("neuroglancer-screenshot-footer-container"),this.progressText=document.createElement("p"),this.progressText.classList.add("neuroglancer-screenshot-progress-text"),this.footerScreenshotActionBtnsContainer.appendChild(this.progressText),this.footerScreenshotActionBtnsContainer.appendChild(this.cancelScreenshotButton),this.footerScreenshotActionBtnsContainer.appendChild(this.takeScreenshotButton),this.footerScreenshotActionBtnsContainer.appendChild(this.forceScreenshotButton),this.content.appendChild(this.footerScreenshotActionBtnsContainer),this.screenshotManager.previewScreenshot(),this.updateUIBasedOnMode(),this.populatePanelResolutionTable(),this.throttledUpdateTableStatistics()}setupEventListeners(){this.registerDisposer(this.screenshotManager.screenshotFinished.add(()=>{this.dispose()})),this.registerDisposer(this.screenshotManager.statisticsUpdated.add(e=>{this.populateStatistics(e)})),this.registerDisposer(this.screenshotManager.viewer.display.updateFinished.add(()=>{this.throttledUpdateTableStatistics()})),this.registerDisposer(this.screenshotManager.zoomMaybeChanged.add(()=>{this.populatePanelResolutionTable()}))}createNameInput(){let e=document.createElement("input");return e.type="text",e.placeholder="Enter optional screenshot name",e.classList.add("neuroglancer-screenshot-name-input"),this.nameInput=e}createButton(e,t,i="",r=null){let n=document.createElement("button");if(r){let e=sC({svg:r});n.appendChild(e)}else e&&(n.textContent=e);return n.classList.add("neuroglancer-screenshot-button"),i&&n.classList.add(i),n.addEventListener("click",t),n}createScaleRadioButtons(){let e=document.createElement("div");e.classList.add("neuroglancer-screenshot-scale-menu");let t=document.createElement("label");t.classList.add("neuroglancer-screenshot-scale-factor-label"),t.classList.add("neuroglancer-screenshot-label"),t.textContent="Screenshot scale factor",t.appendChild(this.helpTooltips.scaleFactorHelpTooltip),e.appendChild(t),this.scaleRadioButtonsContainer=document.createElement("div"),this.scaleRadioButtonsContainer.classList.add("neuroglancer-screenshot-scale-radio-container"),e.appendChild(this.scaleRadioButtonsContainer),this.warningElement=document.createElement("div"),this.warningElement.classList.add("neuroglancer-screenshot-warning"),this.warningElement.textContent="",[1,2,4].forEach(e=>{let t=document.createElement("div"),i=document.createElement("label"),r=document.createElement("input");r.type="radio",r.name="screenshot-scale",r.value=e.toString(),r.checked=e===this.screenshotManager.screenshotScale,r.classList.add("neuroglancer-screenshot-scale-radio-input"),i.appendChild(document.createTextNode(`${e}x`)),i.classList.add("neuroglancer-screenshot-scale-radio-label"),t.classList.add("neuroglancer-screenshot-scale-radio-item"),t.appendChild(r),t.appendChild(i),this.scaleRadioButtonsContainer.appendChild(t),r.addEventListener("change",()=>{this.screenshotManager.screenshotScale=e,this.handleScreenshotResize()})}),e.appendChild(this.warningElement);let i=document.createElement("div");i.classList.add("neuroglancer-screenshot-keep-slice-label"),i.classList.add("neuroglancer-screenshot-label"),i.textContent="Keep slice FOV fixed with scale change";let r=document.createElement("input");return r.classList.add("neuroglancer-screenshot-keep-slice-fov-checkbox"),r.type="checkbox",r.checked=this.screenshotManager.shouldKeepSliceViewFOVFixed,r.addEventListener("change",()=>{this.screenshotManager.shouldKeepSliceViewFOVFixed=r.checked}),this.keepSliceFOVFixedCheckbox=r,i.appendChild(r),e.appendChild(i),this.handleScreenshotResize(),e}createStatisticsTable(){this.statisticsContainer=document.createElement("div"),this.statisticsContainer.classList.add("neuroglancer-screenshot-statistics-title"),this.statisticsContainer.style.padding="1rem",this.statisticsTable=document.createElement("table"),this.statisticsTable.classList.add("neuroglancer-screenshot-statistics-table");let e=this.statisticsTable.createTHead().insertRow(),t=document.createElement("th");t.textContent="Screenshot progress",t.classList.add("neuroglancer-screenshot-title"),e.appendChild(t);let i=document.createElement("th");i.textContent="",e.appendChild(i);let r=this.statisticsTable.createTHead().insertRow(),n=document.createElement("th");n.classList.add("neuroglancer-statistics-table-description-header"),n.colSpan=2,n.textContent="The screenshot will take when all the chunks are loaded. If GPU memory is full, the screenshot will only capture the successfully loaded chunks. A screenshot scale larger than 1 may cause new chunks to be downloaded once the screenshot is in progress.",r.appendChild(n);let s={chunkUsageDescription:"",gpuMemoryUsageDescription:"",downloadSpeedDescription:""};for(let e in s){let t=this.statisticsTable.insertRow(),i=t.insertCell();i.classList.add("neuroglancer-screenshot-statistics-table-data-key");let r=t.insertCell();r.classList.add("neuroglancer-screenshot-statistics-table-data-value"),i.textContent=EX[e],r.textContent=s[e],this.statisticsKeyToCellMap.set(e,r)}return this.populateStatistics(this.screenshotManager.screenshotLoadStats),this.statisticsContainer.appendChild(this.statisticsTable),this.statisticsContainer}createPanelResolutionTable(){let e=this.panelResolutionTable=document.createElement("table");e.classList.add("neuroglancer-screenshot-resolution-table");let t=e.createTHead().insertRow(),i=document.createElement("th");i.textContent="Panel type",i.appendChild(this.helpTooltips.orthographicSettingsTooltip),t.appendChild(i);let r=document.createElement("th");r.textContent="Pixel resolution",t.appendChild(r);let n=document.createElement("th");return n.textContent="Physical scale",n.appendChild(this.helpTooltips.panelScaleTooltip),t.appendChild(n),e}populatePanelResolutionTable(){for(;this.panelResolutionTable.rows.length>1;)this.panelResolutionTable.deleteRow(1);let e=this.panelResolutionTable;for(let t of EP(this.screenshotManager.viewer.display.panels)){let i=E1(t.physicalResolution),r=function(e){let t=Math.round(e.right-e.left);return{width:t,height:Math.round(e.bottom-e.top),type:e.panelType}}(t.pixelResolution),n=e.insertRow(),s=n.insertCell();n.insertCell().textContent=`${r.width} x ${r.height} px`;let a=n.insertCell();s.textContent=i.type,a.innerHTML=i.resolution}return e}createLayerResolutionTable(){let e=this.layerResolutionTable=document.createElement("table");e.classList.add("neuroglancer-screenshot-resolution-table");let t=e.createTHead().insertRow(),i=document.createElement("th");i.textContent="Layer name",i.appendChild(this.helpTooltips.layerDataTooltip),t.appendChild(i);let r=document.createElement("th");r.textContent="Data type",t.appendChild(r);let n=document.createElement("th");return n.textContent="Physical voxel resolution",t.appendChild(n),e}populateLayerResolutionTable(){let e=this.layerResolutionTable;for(let[t,i]of EI(this.screenshotManager.viewer)){let{name:r,type:n}=t;if("MultiscaleMeshLayer"===n)continue;let s=`{${r}--${n}}`,a=this.layerResolutionKeyToCellMap.get(s);if(void 0===a){let t=e.insertRow(),i=t.insertCell(),o=t.insertCell();a=t.insertCell(),i.textContent=r,o.textContent=EQ[n],this.layerResolutionKeyToCellMap.set(s,a)}a.innerHTML=E1(i).resolution}}forceScreenshot(){this.screenshotManager.forceScreenshot()}cancelScreenshot(){this.screenshotManager.cancelScreenshot(!0),this.updateUIBasedOnMode()}screenshot(){let e=this.nameInput.value;this.screenshotManager.takeScreenshot(e),this.updateUIBasedOnMode()}populateStatistics(e){let t=this.parseStatistics(e);if(null!==t)for(let e in t)this.statisticsKeyToCellMap.get(e).textContent=String(t[e])}handleScreenshotResize(){let e=this.screenshotManager.calculatedClippedViewportSize(),t=this.screenshotManager.screenshotScale.toFixed(2),i=Math.round(Math.sqrt(2601e4));(e.width+2)*(e.height+2)>=2601e4?this.warningElement.textContent=`Screenshots can't have more than ${i}x${i} total pixels, the scale factor was reduced to x${t} to fit.`:this.warningElement.textContent="",this.screenshotWidth=e.width,this.screenshotHeight=e.height,this.updateScreenshotSizeDisplay()}updateScreenshotSizeDisplay(){this.screenshotPixelSize&&(this.screenshotPixelSize.textContent=`${this.screenshotWidth} x ${this.screenshotHeight} px`)}parseStatistics(e){if(null===e)return null;let t=0===e.visibleChunksTotal?0:100*e.visibleChunksGpuMemory/e.visibleChunksTotal,i=100*e.visibleGpuMemory/e.gpuMemoryCapacity,r=e.visibleGpuMemory/1e6,n=e.gpuMemoryCapacity/1e6,s=isNaN(e.downloadLatency)?0:e.downloadLatency,a=0==e.visibleChunksDownloading?"0":`${e.visibleChunksDownloading} at ${s.toFixed(0)}ms latency`;return{chunkUsageDescription:`${e.visibleChunksGpuMemory} out of ${e.visibleChunksTotal} (${t.toFixed(2)}%)`,gpuMemoryUsageDescription:`${r.toFixed(0)}MB / ${n.toFixed(0)}MB (${i.toFixed(2)}% of total)`,downloadSpeedDescription:a}}generateScreenshotMetadataJson(){let e={width:this.screenshotWidth,height:this.screenshotHeight},{panelResolutionData:t,layerResolutionData:i}=EN(this.screenshotManager.viewer),r=[];for(let e of t){let t={type:e.type,pixelResolution:{width:e.width,height:e.height},physicalScale:E2(e.resolution)};r.push(t)}let n=[];for(let e of i){let t={name:e.name,type:e.type,voxelResolution:E2(e.resolution)};n.push(t)}return JSON.stringify({date:new Date().toISOString(),name:this.nameInput.value,size:e,panels:r,layers:n},null,2)}updateUIBasedOnMode(){if(this.screenshotMode===ic.u.PREVIEW){for(let e of(this.nameInput.disabled=!1,this.scaleRadioButtonsContainer.children))for(let t of e.children)t instanceof HTMLInputElement&&(t.disabled=!1);this.keepSliceFOVFixedCheckbox.disabled=!1,this.forceScreenshotButton.disabled=!0,this.cancelScreenshotButton.disabled=!0,this.takeScreenshotButton.disabled=!1,this.progressText.textContent="",this.forceScreenshotButton.title=""}else{for(let e of(this.nameInput.disabled=!0,this.scaleRadioButtonsContainer.children))for(let t of e.children)t instanceof HTMLInputElement&&(t.disabled=!0);this.keepSliceFOVFixedCheckbox.disabled=!0,this.forceScreenshotButton.disabled=!1,this.cancelScreenshotButton.disabled=!1,this.takeScreenshotButton.disabled=!0,this.progressText.textContent="Screenshot in progress...",this.forceScreenshotButton.title="Force a screenshot of the current view without waiting for all data to be loaded and rendered"}}get screenshotMode(){return this.screenshotManager.screenshotMode}}i(6876),i(8657),i(3195),i(5688),i(4886),i(7980);class E4 extends g8{viewer;textEditor;applyButton;downloadButton;closeButton;constructor(e){super(),this.viewer=e,this.parsedValue=null,this.debouncedValueUpdater=(0,ie.Z)(()=>{let e=this.textEditor.getValue();try{let t=JSON.parse(e);this.parsedValue=t,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(n){this.parsedValue=null,this.applyButton.disabled=!0;let t=0,i=0,r="Unknown parse error";if(n instanceof Error){let s=n.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(null!==s){r=s[1];let n=parseInt(s[2],10),a=e.substring(0,n).split("\n");t=a.length-1,i=a[a.length-1].length}else r=n.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:r,severity:"error",from:fe().Pos(t,i)}]})}},100),this.content.classList.add("neuroglancer-state-editor");let t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;let i=this.closeButton=document.createElement("button");i.classList.add("close-button"),i.textContent="Close",this.content.appendChild(i),i.addEventListener("click",()=>this.dispose());let r=this.downloadButton=document.createElement("button");r.textContent="Download",r.title="Download state as a JSON file",this.content.appendChild(r),r.addEventListener("click",()=>this.downloadState()),this.textEditor=fe()(e=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){let e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),i=URL.createObjectURL(t);e.href=i,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){null!==this.parsedValue&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}parsedValue;debouncedValueUpdater;getJson(){return JSON.stringify(ny(this.viewer.state).value,null,"  ")}}i(3278);var E6=i(2384),E5=i(9045);let E8={...dn,side:"right",row:0,visible:!0};function E9(e,t){(0,ef.PT)(t);let i=(0,ef.Kh)(t,"layer",ef.ZE);if(void 0===i)return ah(e,t);{let{layer:r,...n}=t,s=e.layerManager.getLayerByName(i);if(void 0===s)return;let a=s.layer;if(null===a)return;return ah(a,n)}}class E7 extends eh.gj{viewer;tools;changed;constructor(e){super(),this.viewer=e,this.tools=[],this.changed=new eO.K_}get value(){return this.tools}reset(){let{tools:e}=this;if(0!==e.length){for(let t of e)t.dispose();e.length=0,this.changed.dispatch()}}makeTool(e){let t=E9(this.viewer,e);if(void 0!==t)return this.initializeTool(t),t}initializeTool(e){e.unbound.add(()=>{this.remove(e)})}restoreState(e){let t=[];this.tools=t,(0,ef.m7)(e,e=>{let i=this.makeTool(e);void 0!==i&&t.push(i)}),this.changed.dispatch()}insert(e,t){let i;let{tools:r}=this;i=void 0===t?r.length:r.indexOf(t);let n=this.makeTool(e);if(void 0!==n)return r.splice(i,0,n),this.changed.dispatch(),n}move(e,t){let i;let{tools:r}=this,n=r.indexOf(e);if(-1===n)return!1;if(void 0===t)i=r.length;else if(-1===(i=r.indexOf(t)))return!1;return i===n||(r.splice(n,1),i>n&&--i,r.splice(i,0,e),this.changed.dispatch(),!0)}remove(e){let{tools:t}=this,i=t.indexOf(e);return -1!==i&&(t.splice(i,1),e.dispose(),this.changed.dispatch(),!0)}toJSON(){let{tools:e}=this;if(0!==e.length)return Array.from(e,e=>e.localBinder.convertLocalJSONToPaletteJSON(e.toJSON()))}addTools(e){for(let t of e)this.initializeTool(t);this.tools.push(...e),this.changed.dispatch()}disposed(){for(let e of(super.disposed(),this.tools))e.dispose()}}class Te extends eh.gj{viewer;location;name;tools;query;parsedQuery;queryDefined;trackable;get changed(){return this.trackable.changed}constructor(e){super(),this.viewer=e,this.location=new ds(E8),this.name=new J.TU("",ef.ZE),this.query=new J.TU("",ef.ZE),this.parsedQuery=this.registerDisposer((0,J.og)(e=>(function(e){let t=at(e);return(t.endOffset!==e.length&&t.errors.push({range:{begin:t.endOffset,end:e.length},message:"Invalid clause/term"}),t.errors.length>0)?{errors:t.errors}:{query:t.query}})(e),this.query)),this.trackable=new nm,this.tools=this.registerDisposer(new E7(e)),this.location.changed.add(this.changed.dispatch),this.name.changed.add(this.changed.dispatch),this.trackable.add("tools",this.tools),this.trackable.add("query",this.query),this.queryDefined=this.registerDisposer((0,J.mo)(e=>0===e.length,[this.tools]))}restoreState(e){this.location.restoreState(e),this.trackable.restoreState(e),""!==this.query.value&&this.tools.reset()}reset(){this.location.reset(),this.trackable.reset()}toJSON(){return{...this.location.toJSON(),...this.trackable.toJSON()}}}class Tt extends eh.gj{layer;element;header;content;firstTool;constructor(e){super(),this.layer=e,this.element=document.createElement("div"),this.header=document.createElement("div"),this.content=document.createElement("div");let{element:t,header:i,content:r}=this;t.classList.add("neuroglancer-tool-palette-layer-group"),t.appendChild(i),t.appendChild(r),i.classList.add("neuroglancer-tool-palette-layer-group-header"),r.classList.add("neuroglancer-tool-palette-layer-group-content"),i.appendChild(this.registerDisposer(new Eq(e.managedLayer)).element),i.appendChild(this.registerDisposer(new E_(e.managedLayer)).element)}}class Ti extends eh.gj{state;changed;results;jsonToTool;constructor(e){super(),this.state=e,this.changed=new eO.K_,this.results=[],this.jsonToTool=new Map,this.debouncedUpdateResults=this.registerCancellable((0,ie.Z)(()=>{this.updateResults()})),this.registerDisposer(e.query.changed.add(this.debouncedUpdateResults)),this.registerDisposer(e.viewer.globalToolBinder.localBindersChanged.add(this.debouncedUpdateResults)),this.updateResults()}disposed(){for(let e of this.jsonToTool.values())e.dispose();super.dispose()}debouncedUpdateResults;getMatches(){let e=!1,t=this.state.parsedQuery.value;if(void 0!==t&&"query"in t)return aL(this.state.viewer.globalToolBinder,t.query,()=>{e||(e=!0,this.debouncedUpdateResults())})}updateResults(){let e=this.getMatches()??new Map,{results:t,jsonToTool:i}=this,r=[];for(let[t,n]of e){let e=i.get(t);if(void 0===e){if(void 0===(e=E9(this.state.viewer,n)))continue;i.set(t,e)}r.push(e)}for(let[t,r]of i)e.has(t)||(r.dispose(),i.delete(t));(0,H.cO)(t,r)||(this.results=r,this.changed.dispatch())}convertToExplicitPalette(){this.debouncedUpdateResults.flush(),this.state.query.value="",this.state.tools.addTools(this.results),this.results.length=0,this.jsonToTool.clear()}get value(){return this.results}}class Tr extends eh.gj{tool;palette;layerGroup;element;context;constructor(e,t){super(),this.tool=e,this.palette=t,this.element=document.createElement("label"),this.context=void 0,this.debouncedUpdateView=this.registerCancellable((0,io.H)(()=>this.updateView())),this.debouncedUpdateTooltip=this.registerCancellable((0,io.H)(()=>this.updateTooltip()));let{element:i}=this;i.classList.add("neuroglancer-tool-palette-tool-container"),i.addEventListener("dblclick",()=>{this.tool.unbind()}),i.append(this.registerDisposer(new aC(e.localBinder,e.toJSON(),i,{tool:e,palette:t})).element),this.updateView(),this.updateTooltip(),this.registerDisposer(e.changed.add(this.debouncedUpdateTooltip)),this.registerDisposer(t.state.queryDefined.changed.add(this.debouncedUpdateTooltip))}debouncedUpdateView;debouncedUpdateTooltip;updateTooltip(){let e=this.tool.toJSON();"string"==typeof e&&(e={type:e});let t=Object.entries(e).map(([e,t])=>`${e}:${t}`).join(" ");this.palette.state.queryDefined.value?t+="\nDrag to copy to another palette":t+="\nDrag to move/copy, dblclick to remove",this.element.title=t}updateView(){let{context:e}=this,{element:t}=this;void 0!==e&&(e.dispose(),t.removeChild(t.lastElementChild)),this.context=e=new eh.gj;let{tool:i}=this,r=this.tool.renderInPalette(e);void 0===r&&((r=document.createElement("div")).textContent="Loading...",i.localBinder instanceof aS&&e.registerDisposer(i.localBinder.context.managedLayer.layerChanged.add(this.debouncedUpdateView))),r.classList.add("neuroglancer-tool-palette-tool-content"),t.appendChild(r)}disposed(){this.context?.dispose(),this.layerGroup?.dispose(),super.disposed()}}class Tn extends cI{manager;state;itemContainer;dropZone;renderedTools;dragState;dragEnterCount;queryResults;clearDragState(){let{dragState:e}=this;void 0!==e&&(this.dragState=void 0,this.state.tools.remove(e.ephemeralTool))}get hasQuery(){return""!==this.state.query.value}registerDropHandlers(e,t){let i=()=>m?.localBinder.globalBinder===this.manager.state.viewer.globalToolBinder,r=(e,r)=>{let n;if(!i())return;if(this.hasQuery){this.clearDragState();let t=m?.paletteState?.palette;return r&&void 0!==t&&t!==this&&s6(e,this.itemContainer,"drop","Tools cannot be dropped into a query-defined palette.  To allow dropping tools into this palette, first click the magnifying glass icon in the panel titlebar to convert it to a manually-defined palette."),aw(m,"none",!1),"none"}this.dragState?.dragSource!==m&&this.clearDragState();let s="";if(r){let t=m.paletteState?.palette.state.queryDefined.value===!1,i=aa(e,t?"move":"copy",t);as(e,n=i.dropEffect),s=`Drop to ${n} the tool`,i.dropEffectMessage&&(s+=` (${i.dropEffectMessage})`)}else n=o;let a=t(),l=m.paletteState?.palette===this;if("copy"!==n&&l)this.clearDragState(),this.state.tools.move(m.paletteState.tool,a);else{let{dragState:e}=this;if(void 0===e){let e=m.localBinder.convertLocalJSONToPaletteJSON(m.toolJson),t=this.state.tools.insert(e,a);if(void 0===t){console.error("Failed to create tool: ",m.toolJson);return}this.dragState={dragSource:m,ephemeralTool:t}}else this.state.tools.move(e.ephemeralTool,a)}if(r){let t=m;s6(e,this.itemContainer,"drop",s,()=>{aw(t)}),aw(t,n,l)}return n},n=e=>{if(void 0===r(e,!0)){s5(e,this.itemContainer,"drop");return}e.preventDefault(),e.stopPropagation()};e.addEventListener("dragover",n),e.addEventListener("dragenter",e=>{++this.dragEnterCount,n(e)}),e.addEventListener("dragleave",e=>{0==--this.dragEnterCount&&(s5(e,this.itemContainer,"drop"),this.clearDragState(),e.stopPropagation())}),e.addEventListener("drop",e=>{e.preventDefault(),this.dragEnterCount=0,s5(e,this.itemContainer,"drop");let t=r(e,!1);if(void 0===t){this.clearDragState();return}if(e.stopPropagation(),this.dragState=void 0,"move"===t){let{paletteState:e}=m;void 0!==e&&e.palette!==this&&e.palette.state.tools.remove(e.tool)}})}constructor(e,t,i){super(t,i.location),this.manager=e,this.state=i,this.itemContainer=document.createElement("div"),this.dropZone=document.createElement("div"),this.renderedTools=new Map,this.dragState=void 0,this.dragEnterCount=0;let{titleBar:r}=this.addTitleBar({});r.appendChild(this.registerDisposer(new Tl(i.name)).element),this.queryResults=this.registerDisposer(new Ti(i));let n=this.registerDisposer((0,J.mo)(e=>""!==e,[i.query])),s=this,a=this.registerDisposer(new aN({changed:n.changed,get value(){return n.value},set value(newValue){!1===newValue&&!1!==n.value&&s.queryResults.convertToExplicitPalette()}},{svg:E6,disableTitle:"Convert query results to an explicit tool palette"}));r.appendChild(a.element),this.registerDisposer(new i6(n,a.element));let o=gs({title:"Delete tool palette"});o.addEventListener("click",()=>{i.dispose()}),r.appendChild(o);let l=document.createElement("div");l.classList.add("neuroglancer-tool-palette-body");let{itemContainer:d}=this;d.classList.add("neuroglancer-tool-palette-items"),l.appendChild(this.registerDisposer(new aB(s.state.queryDefined,(e,t,r)=>{e&&t.appendChild(r.registerDisposer(new Ts(i)).element)})).element),l.appendChild(d),this.addBody(l);let{dropZone:u}=this;u.classList.add("neuroglancer-tool-palette-drop-zone"),this.registerDropHandlers(u,()=>void 0);let c=this.registerCancellable((0,io.H)(()=>this.render()));this.registerDisposer(this.state.tools.changed.add(c)),this.registerDisposer(this.queryResults.changed.add(c)),this.visibility.changed.add(c),this.render()}getRenderedTool(e){let{renderedTools:t}=this,i=t.get(e);return void 0===i&&(i=new Tr(e,this),this.registerDropHandlers(i.element,()=>e),t.set(e,i)),i}getDragDropDescription(){return"tool palette"}canCopy(){return!0}copyToNewLocation(e){let t=this.manager.state.addNew({location:{...this.state.location.value,...e},name:this.state.name.value});t.tools.restoreState(this.state.tools.toJSON()??[]),t.query.value=this.state.query.value}render(){let e=this;sS(this.itemContainer,function*(){let t=e.state.queryDefined.value?e.queryResults.value:e.state.tools.tools,{renderedTools:i}=e,r=new Set(t),n=t.length,s=new Set;for(let i=0;i<n;){let r=t[i],{localBinder:a}=r;if(a instanceof aS){let o=a.context,l=e.getRenderedTool(r),{layerGroup:d}=l;s.has(d)||void 0===d?(d=new Tt(o),e.registerDropHandlers(d.header,()=>d.firstTool),d.firstTool=r):d.addRef(),s.add(d),sS(d.content,function*(){for(;l.layerGroup?.dispose(),l.layerGroup=d.addRef(),yield l.element,++i!==n&&(r=t[i]).localBinder===a;)l=e.getRenderedTool(r)}()),yield d.element,d.dispose()}else{let t=e.getRenderedTool(r);yield t.element,++i}}for(let[e,t]of i)r.has(e)||(t.dispose(),i.delete(e));yield e.dropZone}())}disposed(){}}class Ts extends eh.gj{state;element;errorsElement;constructor(e){super(),this.state=e,this.element=document.createElement("div"),this.errorsElement=document.createElement("ul");let t=this.registerDisposer(new CP({completer:this.completeQuery.bind(this)}));t.placeholder="Enter tool query or drag in tools",t.element.classList.add("neuroglancer-tool-palette-query"),t.value=e.query.value??"",this.registerDisposer(e.parsedQuery.changed.add(this.registerCancellable((0,ie.Z)(()=>this.updateErrors(),200)))),this.updateErrors(),t.onCommit.add(()=>{e.query.value=t.value}),e.query.changed.add(()=>{t.value=e.query.value??""});let{element:i,errorsElement:r}=this;i.appendChild(t.element),i.appendChild(r),r.classList.add("neuroglancer-tool-palette-query-errors")}updateErrors(){let{errorsElement:e}=this;sv(e);let t=this.state.parsedQuery.value;if(void 0!==t&&"errors"in t)for(let i of t.errors){let t=document.createElement("li");t.textContent=i.message,e.appendChild(t)}}async completeQuery({value:e}){let t;let i=at(e),r=function(e){let t,i;let r=function(e){let{clauses:t}=e.query;if(e.endOffset===e.raw.length&&0!==t.length){let{range:i,terms:r}=t[t.length-1];if(i.end===e.endOffset&&0!==r.length){let e=r[r.length-1];return r.length=r.length-1,e.range.begin}}return e.endOffset}(e),n=e.raw.substring(r),s=n.match(ar),a=0==e.query.clauses.length||e.query.clauses[e.query.clauses.length-1].include;null===s?i=r:(i=r+s[1].length+1,t=s[1],n=n.substring(s[1].length+1));let o={clauses:[]},{clauses:l}=e.query,d=[];if(0!==l.length&&d.push(...l[l.length-1].terms),void 0!==t&&d.push({property:t,predicate:{regexp:RegExp("^"+(0,s9.Z)(n))},range:{begin:-1,end:-1}}),a){o.clauses.push({include:!0,terms:d,range:{begin:-1,end:-1}});for(let e=0,t=l.length-1;e<t;++e){let t=l[e];o.clauses.push({include:!t.include,terms:t.terms,range:t.range})}}else for(let e=0,t=l.length-1;e<t;++e){let t=l[e],i=t.terms;t.include&&(i=[...i,...d]),o.clauses.push({include:t.include,terms:i,range:t.range})}return{offset:i,prefix:n,property:t,include:a,completionQuery:o}}(i),n=aL(this.state.viewer.globalToolBinder,r.completionQuery);t=void 0===r.property?function(e,t,i){let r=new Set(Array.from(e.clauses[0].terms,e=>e.property)),n=new Map;for(let e of t.values())for(let t in e){if(!t.startsWith(i)||r.has(t))continue;let e=t+":",s=n.get(e)??0;n.set(e,s+1)}return an(n)}(r.completionQuery,n,r.prefix):function(e,t){let i=new Map;for(let r of e.values()){let e=""+r[t],n=i.get(e)??0;i.set(e,n+1)}return an(i)}(n,r.property);let s=[];for(let[e,n]of(void 0===r.property&&""===r.prefix&&i.query.clauses.length>0&&0!==i.query.clauses[i.query.clauses.length-1].terms.length&&(s.push({value:"+",description:"New inclusion clause"}),s.push({value:"-",description:"New exclusion clause"})),t))s.push({value:e,description:`${n} tool${n>0?"s":""}`});return{offset:r.offset,completions:s,makeElement:CL}}}class Ta{viewer;changed;changedShallow;visibleStateChanged;palettes;constructor(e){this.viewer=e,this.changed=new eO.K_,this.changedShallow=new eO.K_,this.visibleStateChanged=new eO.K_,this.palettes=new Set,this.checkingTitles=!1}add(e){this.palettes.add(e),e.registerDisposer(e.changed.add(this.changed.dispatch)),e.registerDisposer(e.location.watchableVisible.changed.add(this.visibleStateChanged.dispatch)),e.registerDisposer(e.name.changed.add(()=>this.checkTitles(e))),e.registerDisposer(()=>{this.palettes.delete(e),this.changedShallow.dispatch(),this.visibleStateChanged.dispatch(),this.changed.dispatch()}),this.changedShallow.dispatch(),this.changed.dispatch()}toJSON(){let{palettes:e}=this;if(0===e.size)return;let t={};for(let i of e)t[i.name.value]=ny(i).value;return t}reset(){let{palettes:e}=this;if(0!==e.size)for(let t of e)t.dispose()}restoreState(e){if(void 0===e)return;(0,ef.PT)(e);let{viewer:t}=this,i=new Map;for(let e of this.palettes)i.set(e.name.value,e);for(let[r,n]of Object.entries(e)){let e=i.get(r);if(void 0!==e){e.restoreState(n);continue}let s=new Te(t);s.name.value=r,s.restoreState(n),i.set(r,s),this.add(s)}}addNew(e={}){let t=new Te(this.viewer),{location:i,name:r="Palette"}=e;return t.name.value=r,this.checkTitles(t),t.location.value={...E8,...i},t.location.locationChanged.dispatch(),this.add(t),t}checkingTitles;checkTitles(e){if(!this.checkingTitles)try{this.checkingTitles=!0;let t=new Set;for(let i of this.palettes)i!==e&&t.add(i.name.value);let i=e.name.value;if(!t.has(i))return;let r=0;for(;;){let n=i+ ++r;if(!t.has(n)){e.name.value=n;return}}}finally{this.checkingTitles=!1}}}class To extends eh.gj{sidePanelManager;state;panels;constructor(e,t){super(),this.sidePanelManager=e,this.state=t,this.panels=new Map;let i=this.registerCancellable((0,io.H)(()=>this.updatePanels()));this.registerDisposer(this.state.changedShallow.add(i)),this.updatePanels()}updatePanels(){let{panels:e}=this,{palettes:t}=this.state;for(let[i,r]of e)t.has(i)||(this.sidePanelManager.unregisterPanel(r),e.delete(i));for(let i of t)if(!e.has(i)){let t={location:i.location,makePanel:()=>new Tn(this,this.sidePanelManager,i)};e.set(i,t),this.sidePanelManager.registerPanel(t)}}disposed(){for(let e of(super.disposed(),this.panels.values()))this.sidePanelManager.unregisterPanel(e)}}class Tl extends uF{name;constructor(e){super(e),this.name=e;let{element:t}=this;t.classList.add("neuroglancer-tool-palette-name"),t.title="Rename tool palette"}}class Td extends eh.gj{state;element;constructor(e){super(),this.state=e,this.element=document.createElement("li");let{element:t}=this;t.appendChild(this.registerDisposer(new i4(e.location.watchableVisible,{enableTitle:"Show tool palette",disableTitle:"Hide tool palette"})).element),t.appendChild(this.registerDisposer(new Tl(e.name)).element);let i=gs({title:"Delete tool palette"});i.addEventListener("click",()=>{e.dispose()}),t.appendChild(i)}}class Tu{state;palette;element;constructor(e,t){this.state=e,this.palette=t,this.element=document.createElement("li");let{element:i}=this;i.classList.add("neuroglancer-tool-palette-dropdown-canned-item"),i.textContent=t.description??t.name,i.addEventListener("click",()=>{e.addNew({name:t.name}).query.value=t.query})}}let Tc=[{name:"Palette",description:"New empty palette",query:""},{name:"All controls",query:"+"},{name:"Shader controls",query:"type:shaderControl"}];class Th extends eh.gj{state;element;itemContainer;items;cannedItems;cannedItemSeparator;constructor(e){super(),this.state=e,this.element=document.createElement("div"),this.itemContainer=document.createElement("ul"),this.items=new Map,this.cannedItems=new Map,this.cannedItemSeparator=document.createElement("li");let{element:t,itemContainer:i,cannedItemSeparator:r}=this;t.classList.add("neuroglancer-tool-palette-dropdown"),r.classList.add("neuroglancer-tool-palette-dropdown-separator"),t.appendChild(i);let n=this.registerCancellable((0,io.H)(()=>this.updateView()));this.registerDisposer(this.state.changedShallow.add(n)),this.updateView()}updateView(){let e=this;sS(this.itemContainer,function*(){let{palettes:t}=e.state,i=new Set,{items:r}=e;for(let e of t){let t=r.get(e);void 0===t&&(t=new Td(e),r.set(e,t)),i.add(e.query.value),yield t.element}let n=!0,{cannedItems:s}=e;for(let r of Tc){if(""!==r.query&&i.has(r.query))continue;let a=s.get(r);void 0===a&&(a=new Tu(e.state,r),s.set(r,a)),n&&(n=!1,0!==t.size&&(yield e.cannedItemSeparator)),yield a.element}for(let[e,i]of r)t.has(e)||(r.delete(e),i.dispose())}())}disposed(){super.disposed(),sy(this.element)}}class Tp extends eh.gj{state;countElement;dropdownVisible;dropdown;element;constructor(e){super(),this.state=e,this.countElement=document.createElement("div"),this.dropdownVisible=new J.SN(!1),this.element=document.createElement("div");let{element:t,countElement:i}=this,r=this.registerDisposer(new aN(this.dropdownVisible,{svg:E5,enableTitle:"Show tool palette list (control+click to create new)",disableTitle:"Hide tool palette list",backgroundScheme:"dark"})).element;t.appendChild(r),t.classList.add("neuroglancer-tool-palette-button"),t.classList.add("neuroglancer-sticky-focus"),t.tabIndex=-1;let n=this.registerCancellable((0,io.H)(()=>this.updateView()));this.registerDisposer(e.changedShallow.add(n)),this.registerDisposer(e.visibleStateChanged.add(n)),t.addEventListener("focusout",e=>{let{relatedTarget:i}=e;i instanceof Node&&!t.contains(i)&&(this.dropdownVisible.value=!1)}),r.insertAdjacentElement("afterbegin",i),this.dropdownVisible.changed.add(()=>{this.dropdownVisible.value?void 0===this.dropdown&&(this.dropdown=new Th(this.state),this.element.appendChild(this.dropdown.element),function(e,t){let i=t.getBoundingClientRect(),{clientHeight:r,clientWidth:n}=e.ownerDocument.documentElement,s=i.top-6,a=n-i.bottom-6;i.left<r-i.right?(e.style.left="0px",e.style.right=""):(e.style.right="0px",e.style.left=""),e.style.maxWidth=`${i.width}px`,s>3*a?(e.style.top="",e.style.bottom=`${n-i.top}px`,e.style.maxHeight=s+"px"):(e.style.top=`${i.bottom}px`,e.style.bottom="",e.style.maxHeight=a+"px")}(this.dropdown.element,this.element)):(this.dropdown?.dispose(),this.dropdown=void 0)}),this.updateView()}updateView(){let e=this.state.palettes.size,t=0;for(let e of this.state.palettes)e.location.visible&&++t;this.countElement.textContent=t<e?`${t}/${e}`:""}disposed(){this.dropdown?.dispose()}}i(1808);let Tg={...dn,side:"left",row:2};class Tf{location=new ds(Tg);get changed(){return this.location.changed}toJSON(){return(0,ef.$Z)(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class Tm extends cI{constructor(e,t,i){super(e,t.location),this.addTitleBar({title:"Settings"});let r=document.createElement("div");r.classList.add("neuroglancer-settings-body");let n=document.createElement("div");n.classList.add("neuroglancer-settings-scroll-container"),r.appendChild(n),this.addBody(r);{let e=this.registerDisposer(new uF(i.title));e.element.placeholder="Title",e.element.classList.add("neuroglancer-settings-title"),n.appendChild(e.element)}let s=(e,t)=>{let i=this.registerDisposer(new aU(t,{label:e}));i.element.classList.add("neuroglancer-settings-limit-widget"),n.appendChild(i.element)};s("GPU memory limit",i.chunkQueueManager.capacities.gpuMemory.sizeLimit),s("System memory limit",i.chunkQueueManager.capacities.systemMemory.sizeLimit),s("Concurrent chunk requests",i.chunkQueueManager.capacities.download.itemLimit);let a=(e,t)=>{let i=document.createElement("label");i.textContent=e;let r=this.registerDisposer(new i4(t));i.appendChild(r.element),n.appendChild(i)};a("Show axis lines",i.showAxisLines),a("Show scale bar",i.showScaleBar),a("Show cross sections in 3-d",i.showPerspectiveSliceViews),a("Hide sections background 3-d",i.hideCrossSectionBackground3D),a("Show default annotations",i.showDefaultAnnotations),a("Show chunk statistics",i.statisticsDisplayState.location.watchableVisible),a("Wire frame rendering",i.wireFrame),a("Enable prefetching",i.chunkQueueManager.enablePrefetch),a("Enable adaptive downsampling",i.enableAdaptiveDownsampling);let o=(e,t)=>{let i=document.createElement("label");i.textContent=e;let r=this.registerDisposer(new sg(t));i.appendChild(r.element),n.appendChild(i)};o("Cross-section background",i.crossSectionBackgroundColor),o("Projection background",i.perspectiveViewBackgroundColor)}}i(5584);class Tv extends eh.gj{selectedLayer;toolBinder;element;unbindPreviousLayer;get selectedTool(){let e=this.selectedLayer.layer;if(void 0===e)return;let t=e.layer;if(null!==t)return t.tool.value}constructor(e,t){super(),this.selectedLayer=e,this.toolBinder=t,this.element=document.createElement("div"),this.viewContext=void 0,this.updateView=this.registerCancellable((0,io.H)(()=>{let{viewContext:e}=this;void 0!==e&&(this.unregisterDisposer(e),e.dispose()),this.viewContext=e=this.registerDisposer(new eh.gj),sv(this.element);let{selectedTool:t}=this;void 0!==t&&this.element.appendChild(this.makeWidget(e,t));let i=Array.from(this.toolBinder.bindings);for(let[,t]of(i.sort(([e],[t])=>(0,s7.B)(e,t)),i))this.element.appendChild(this.makeWidget(e,t))}));let{element:i}=this;i.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}selectedLayerChanged(){let{unbindPreviousLayer:e}=this;void 0!==e&&e();let t=this.selectedLayer.layer;void 0!==t&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){let{unbindPreviousLayer:e}=this;void 0!==e&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){let i=document.createElement("div");i.title="dblclick → unbind",t instanceof ad&&(i.title+=", click → bind key"),i.className="neuroglancer-annotation-tool-status-widget";let r=document.createElement("div");r.className="neuroglancer-annotation-tool-status-widget-layer-number";let n=document.createElement("div");if(n.className="neuroglancer-annotation-tool-status-widget-description",n.textContent=t.description,i.addEventListener("dblclick",()=>{t instanceof ac?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof ad){let r=document.createElement("div");r.className="neuroglancer-annotation-tool-status-widget-key",r.textContent=t.keyBinding,i.appendChild(r),ax(e,i,e=>t.localBinder.set(e,t.addRef()))}let s=t.context;if(s instanceof dE){let{managedLayer:e}=s;e.manager.rootLayers.updateNonArchivedLayerIndices();let t=e.nonArchivedLayerIndex;r.textContent=(t+1).toString(),i.appendChild(r)}return i.appendChild(n),i}viewContext;updateView}let Ty=["showHelpButton","showSettingsButton","showEditStateButton","showScreenshotButton","showToolPaletteButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus","showImportButton"],Tb=[...Ty,"showLayerPanel","showLayerHoverValues"],TS=[...Tb,"showTopBar","showUIControls","showPanelBorders"],Tw="undefined"!=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0};class TC extends nm{viewer;constructor(e){super(),this.viewer=e,this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("velocity",e.velocity),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("enableAdaptiveDownsampling",e.enableAdaptiveDownsampling),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("hideCrossSectionBackground3D",e.hideCrossSectionBackground3D),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer),this.add("toolBindings",e.toolBinder),this.add("toolPalettes",e.toolPalettes)}restoreState(e){let{viewer:t}=this;super.restoreState(e),(0,ef.Kh)(e,"navigation",e=>{(0,ef.PT)(e),(0,ef.Kh)(e,"pose",e=>{(0,ef.PT)(e),(0,ef.Kh)(e,"position",e=>{(0,ef.PT)(e),nf(e,"voxelCoordinates",t.position),(0,ef.Kh)(e,"voxelSize",e=>{let i=(0,ef.Iw)(new Float64Array(3),e,ef.o7);for(let e=0;e<3;++e)i[e]*=1e-9;t.coordinateSpace.value=tw({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:i})})}),nf(e,"orientation",t.crossSectionOrientation)}),nf(e,"zoomFactor",t.crossSectionScale.legacyJsonView)}),nf(e,"perspectiveOrientation",t.projectionOrientation),nf(e,"perspectiveZoom",t.projectionScale.legacyJsonView),nf(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}}class Tx extends eh.gj{display;title;coordinateSpace;position;velocity;relativeDisplayScales;displayDimensions;displayDimensionRenderInfo;crossSectionOrientation;crossSectionScale;projectionOrientation;crossSectionDepthRange;projectionDepthRange;projectionScale;navigationState;perspectiveNavigationState;mouseState;layerManager;selectedLayer;showAxisLines;wireFrame;enableAdaptiveDownsampling;showScaleBar;showPerspectiveSliceViews;hideCrossSectionBackground3D;visibleLayerRoles;showDefaultAnnotations;crossSectionBackgroundColor;perspectiveViewBackgroundColor;scaleBarOptions;partialViewport;statisticsDisplayState;helpPanelState;settingsPanelState;layerSelectedValues;selectionDetailsState;selectedStateServer;layerListPanelState;resetInitiated;screenshotHandler;screenshotManager;get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}layerSpecification;layout;sidePanelManager;state;dataContext;visibility;inputEventBindings;element;dataSourceProvider;uiConfiguration;makeUiControlVisibilityState(e){let t=this.uiConfiguration.showUIControls,i=this.uiConfiguration.showTopBar,r=this.uiConfiguration[e],n=Ty.includes(e);return this.registerDisposer((0,J.S_)((e,t,i)=>e&&(!n||t)&&i,t,i,r))}uiControlVisibility;showLayerDialog;resetStateWhenEmpty;get inputEventMap(){return this.inputEventBindings.global}visible;constructor(e,t={}){super(),this.display=e,this.title=new J.TU(void 0,ef.ZE),this.coordinateSpace=new tk,this.position=this.registerDisposer(new nT(this.coordinateSpace)),this.velocity=this.registerDisposer(new nI(this.coordinateSpace)),this.relativeDisplayScales=this.registerDisposer(new nB(this.coordinateSpace)),this.displayDimensions=this.registerDisposer(new nj(this.coordinateSpace)),this.displayDimensionRenderInfo=this.registerDisposer(new nG(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef())),this.crossSectionOrientation=this.registerDisposer(new nO),this.crossSectionScale=this.registerDisposer(new nZ(this.displayDimensionRenderInfo.addRef())),this.projectionOrientation=this.registerDisposer(new nO),this.crossSectionDepthRange=this.registerDisposer(new nX(-10,this.displayDimensionRenderInfo)),this.projectionDepthRange=this.registerDisposer(new nX(-50,this.displayDimensionRenderInfo)),this.projectionScale=this.registerDisposer(new nY(this.displayDimensionRenderInfo.addRef())),this.navigationState=this.registerDisposer(new n0(new nq(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef())),this.perspectiveNavigationState=this.registerDisposer(new n0(new nq(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef())),this.mouseState=new dD,this.layerManager=this.registerDisposer(new dk),this.selectedLayer=this.registerDisposer(new dO(this.layerManager.addRef())),this.showAxisLines=new i3(!0,!0),this.wireFrame=new i3(!1,!1),this.enableAdaptiveDownsampling=new i3(!0,!0),this.showScaleBar=new i3(!0,!0),this.showPerspectiveSliceViews=new i3(!0,!0),this.hideCrossSectionBackground3D=new i3(!1,!1),this.visibleLayerRoles=new J.GF([0,1,2]),this.showDefaultAnnotations=new i3(!0,!0),this.crossSectionBackgroundColor=new ea(Z.R3.fromValues(.5,.5,.5)),this.perspectiveViewBackgroundColor=new ea(Z.R3.fromValues(0,0,0)),this.scaleBarOptions=new xn,this.partialViewport=new ib,this.statisticsDisplayState=new Ex,this.helpPanelState=new x3,this.settingsPanelState=new Tf,this.layerSelectedValues=this.registerDisposer(new dL(this.layerManager,this.mouseState)),this.selectionDetailsState=this.registerDisposer(new dR(this.coordinateSpace,this.layerSelectedValues)),this.selectedStateServer=new J.TU("",ef.ZE),this.layerListPanelState=new EW,this.resetInitiated=new eO.K_,this.uiControlVisibility={},this.visible=!0,this.toolInputEventMapBinder=(e,t)=>{t.registerDisposer(this.inputEventBindings.sliceView.addParent(e,Number.POSITIVE_INFINITY)),t.registerDisposer(this.inputEventBindings.perspectiveView.addParent(e,Number.POSITIVE_INFINITY))},this.toolPalettes=new Ta(this),this.globalToolBinder=this.registerDisposer(new ay(this.toolInputEventMapBinder,this.toolPalettes)),this.toolBinder=this.registerDisposer(new ab(this,this.globalToolBinder)),this.screenshotHandler=this.registerDisposer(new EV(this)),this.screenshotManager=this.registerDisposer(new EY(this));let{dataContext:i=new Cj(e.gl,e),visibility:r=new iJ(iJ.VISIBLE),inputEventBindings:n={global:new se,sliceView:new se,perspectiveView:new se},element:s=e.makeCanvasOverlayElement(),uiConfiguration:a=Object.fromEntries(TS.map(e=>[e,new i3(!0)])),dataSourceProvider:o=(()=>{let{credentialsManager:e=function(){let e=new vC;for(let[t,i]of vE)e.register(t,i);return e}()}=t,r=this.registerDisposer(new m4(e,i.rpc)),n=this.registerDisposer(new wC(i.chunkManager,r));return function(e){let t=new l5(e.kvStoreContext);for(let e of(t.register(new lY),vh))t.register(e);for(let e of vp)t.registerKvStoreBasedProvider(e);return e.kvStoreContext.kvStoreContext.autoDetectRegistry.copyTo(t.autoDetectRegistry),vg.copyTo(t.autoDetectRegistry),t}({credentialsManager:r,kvStoreContext:n})})()}=t;this.visibility=r,this.inputEventBindings=n,this.element=s,this.dataSourceProvider=o,this.uiConfiguration=a,this.registerDisposer((0,J.Jk)(e=>{this.display.applyWindowedViewportToElement(s,e)},this.partialViewport)),this.registerDisposer(()=>sy(this.element)),this.dataContext=this.registerDisposer(i),function(e,t){for(let i of TS){let r=t[i];void 0!==r&&(e[i].value=r)}}(a,t);let{resetStateWhenEmpty:l,showLayerDialog:d}={...Tw,...t};for(let e of Tb)this.uiControlVisibility[e]=this.makeUiControlVisibilityState(e);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=d,this.resetStateWhenEmpty=l,this.layerSpecification=new dj(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.globalToolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(iY.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(iY.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));let u=this.registerCancellable((0,ie.Z)(()=>{!this.wasDisposed&&0===this.layerManager.managedLayers.length&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.layout.restoreState("4panel-alt"),this.resetInitiated.dispatch(),!g6&&this.showLayerDialog&&this.visibility.visible&&d3(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(u),u(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(Eu(s,this.navigationState.position)),this.state=new TC(this),this.registerDisposer(new nR(this.display,this.position,this.velocity))}updateShowBorders(){let{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){let e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";let t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";let i=this.registerDisposer(new aZ(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner,{velocity:this.velocity,getToolBinder:()=>this.toolBinder}));this.registerDisposer(new i6(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element);let r=this.registerDisposer(new aY(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(r.element.style.flex="1",r.element.style.alignSelf="center",this.registerDisposer(new i6(this.uiControlVisibility.showLocation,r.element)),t.appendChild(r.element),"undefined"!=typeof NEUROGLANCER_CREDIT_LINK){let e=NEUROGLANCER_CREDIT_LINK;for(let{url:i,text:r}of(Array.isArray(e)||(e=[e]),e)){let e=document.createElement("a");e.style.marginRight="5px",e.href=i,e.textContent=r,e.style.fontFamily="sans-serif",e.style.color="yellow",e.target="_blank",t.appendChild(e)}}let n=this.registerDisposer(new Tv(this.selectedLayer,this.globalToolBinder));if(t.appendChild(n.element),this.registerDisposer(new i6(this.uiControlVisibility.showAnnotationToolStatus,n.element)),xQ){let e=this.registerDisposer(new x0(this));t.appendChild(e.element)}{let e=this.registerDisposer(new Tp(this.toolPalettes)).element;this.registerDisposer(new i6(this.uiControlVisibility.showToolPaletteButton,e)),t.appendChild(e)}{let{layerListPanelState:e}=this,i=this.registerDisposer(new aN(e.location.watchableVisible,{svg:C$,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));i.element.insertAdjacentElement("afterbegin",this.registerDisposer(new EK(this.layerManager)).element),this.registerDisposer(new i6(this.uiControlVisibility.showLayerListPanelButton,i.element)),t.appendChild(i.element)}{let{selectionDetailsState:e}=this,i=this.registerDisposer(new aN(e.location.watchableVisible,{svg:Cz,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new i6(this.uiControlVisibility.showSelectionPanelButton,i.element)),t.appendChild(i.element)}{let{selectedLayer:e}=this,i=this.registerDisposer(new aN({get value(){return e.visible},set value(visible){e.visible=visible},changed:e.location.locationChanged},{svg:CU,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new i6(this.uiControlVisibility.showLayerSidePanelButton,i.element)),t.appendChild(i.element)}{let e=sC({text:"{}",title:"Edit JSON state"});this.registerEventListener(e,"click",()=>{this.editJsonState()}),this.registerDisposer(new i6(this.uiControlVisibility.showEditStateButton,e)),t.appendChild(e)}{let e=sC({svg:C_,title:"Screenshot"});this.registerEventListener(e,"click",()=>{this.showScreenshotDialog()}),this.registerDisposer(new i6(this.uiControlVisibility.showScreenshotButton,e)),t.appendChild(e)}{let{helpPanelState:e}=this,i=this.registerDisposer(new aN(e.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new i6(this.uiControlVisibility.showHelpButton,i.element)),t.appendChild(i.element)}{let{settingsPanelState:e}=this,i=this.registerDisposer(new aN(e.location.watchableVisible,{svg:CG,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new i6(this.uiControlVisibility.showSettingsButton,i.element)),t.appendChild(i.element)}{let e=sC({text:"\uD83D\uDCC1",title:"Import Viewer State"});this.registerEventListener(e,"click",()=>{let e=document.createElement("input");e.type="file",e.accept=".json",e.style.display="none",e.onchange=async e=>{let t=e.target;if(!t.files||0===t.files.length)return;let i=t.files[0],r=new FormData;r.append("file",i);try{let e=await fetch("/import_viewer",{method:"POST",body:r});if(!e.ok)throw Error(`Server error: ${e.statusText}`);let t=await e.json();console.log("Import success:",t),alert(t.message)}catch(e){console.error("Error uploading viewer state:",e),alert(`Error importing viewer state: ${e}`)}},document.body.appendChild(e),e.click(),document.body.removeChild(e)}),t.appendChild(e)}this.registerDisposer(new i6((0,J.S_)((...e)=>e.reduce((e,t)=>e||t,!1),...Ty.map(e=>this.uiControlVisibility[e])),t)),e.appendChild(t),this.layout=this.registerDisposer(new Ew(this,"4panel")),this.sidePanelManager=this.registerDisposer(new cP(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new EJ(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new Ez(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new cM(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new EL(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{let{inputEventBindings:e}=this;return new x4(this.sidePanelManager,this.helpPanelState,[["Global",e.global],["Cross section view",e.sliceView],["3-D projection view",e.perspectiveView]],this.layerManager,this.globalToolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new Tm(this.sidePanelManager,this.settingsPanelState,this)})),this.registerDisposer(new To(this.sidePanelManager,this.toolPalettes));let s=()=>{let t=this.visibility.visible;t!==this.visible&&(e.style.visibility=t?"inherit":"hidden",this.visible=t)};s(),this.registerDisposer(this.visibility.changed.add(s))}registerEventActionBindings(){let{element:e}=this;this.registerDisposer(new aM(e,this.inputEventMap)),this.registerDisposer(new g4(e))}bindAction(e,t){this.registerDisposer(ss(this.element,e,t))}registerActionListeners(){for(let e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e)});for(let e of["select","star"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{let t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){let t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{let e=this.selectedLayer.layer;if(void 0===e){s1.showTemporaryMessage("The annotate command requires a layer to be selected.");return}let t=e.layer;if(null===t||void 0===t.tool.value){s1.showTemporaryMessage(`The selected layer (${JSON.stringify(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}toolInputEventMapBinder;toolPalettes;globalToolBinder;toolBinder;activateTool(e){this.globalToolBinder.activate(e)}deactivateTools(){this.globalToolBinder.deactivate()}editJsonState(){this.deactivateTools(),new E4(this)}showScreenshotDialog(){this.deactivateTools(),new E3(this.screenshotManager)}showStatistics(e){void 0===e&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let{chunkQueueManager:e}=this.dataContext;null===e.chunkUpdateDeadline&&(e.chunkUpdateDeadline=Date.now()+10)}}isReady(){if(this.chunkQueueManager.flushPendingChunkUpdates(),!this.display.isReady())return!1;for(let e of this.layerManager.managedLayers)if(!e.isReady())return!1;return!0}}am(Tx,aX,(e,t)=>a1({position:e.position,velocity:e.velocity,coordinateSpaceCombiner:e.layerSpecification.coordinateSpaceCombiner,toolBinder:e.toolBinder},t),(e,t)=>a2(e.coordinateSpace,t)),am(Eg,aX,(e,t)=>a1({position:e.viewerNavigationState.position.value,velocity:e.viewerNavigationState.velocity.velocity,coordinateSpaceCombiner:e.layerSpecification.root.coordinateSpaceCombiner,toolBinder:e.toolBinder},t)),am(dE,aX,(e,t)=>a1({position:e.localPosition,velocity:e.localVelocity,coordinateSpaceCombiner:e.localCoordinateSpaceCombiner,toolBinder:e.toolBinder},t),(e,t)=>a2(e.localCoordinateSpace,t));class TE extends eh.gj{root;sharedKvStoreContext;prevStateString;prevStateGeneration;parseError;defaultFragment;constructor(e,t,i={}){super(),this.root=e,this.sharedKvStoreContext=t,this.parseError=new J.SN(void 0);let{updateDelayMilliseconds:r=200,defaultFragment:n="{}"}=i;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());let s=(0,ie.Z)(()=>this.setUrlHash(),r,{maxWait:2*r});this.registerDisposer(e.changed.add(s)),this.registerDisposer(()=>s.cancel()),this.defaultFragment=n}setUrlHash(){let e=ny(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let t=encodeURI(JSON.stringify(e.value,ef.qG)).replace(/[!'()*;,]/g,e=>"%"+e.charCodeAt(0).toString(16).toUpperCase());t!==this.prevStateString&&(this.prevStateString=t,"{}"===decodeURIComponent(t)?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+t))}}updateFromUrlHash(){try{let e=location.href.replace(/^[^#]+/,"");if((""===e||"#"===e||"#!"===e)&&(e="#!"+this.defaultFragment),e.match(/^#!([a-z][a-z\d+-.]*):\/\//)){let t=e.substring(2);s1.forPromise(this.sharedKvStoreContext.kvStoreContext.read(t,{throwIfMissing:!0}).then(e=>e.response.json()).then(e=>{(0,ef.PT)(e),this.root.reset(),this.root.restoreState(e)}),{initialMessage:`Loading state from ${t}`,errorPrefix:"Error loading state:"})}else if(e.startsWith("#!+")){e=e.slice(3),e=decodeURIComponent(e);let t=(0,ef.OD)(e);(0,ef.PT)(t),this.root.restoreState(t),this.prevStateString=void 0}else if(e.startsWith("#!")){if(e=e.slice(2),(e=decodeURIComponent(e))===this.prevStateString)return;this.prevStateString=e,this.root.reset();let t=(0,ef.OD)(e);(0,ef.PT)(t),this.root.restoreState(t)}else throw Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}}i(4465),function(){var e,t;let i=window.viewer=(e=void 0,(0,eh.H0)(document,"contextmenu",e=>{e.preventDefault()}),(0,eh.H0)(document,"wheel",e=>{e.ctrlKey&&e.preventDefault()},{passive:!1}),function(e={}){try{let{target:t=document.getElementById("neuroglancer-container")}=e;null===t&&((t=document.createElement("div")).id="neuroglancer-container",document.body.appendChild(t));let i=new iS(t);return new Tx(i,e)}catch(e){throw s1.showMessage(`Error: ${e.message}`),e}}(e));(t=i.inputEventBindings).global.addParent(function(){if(void 0===l){let e=new se;e.set("keyl","recolor"),e.set("keyx","clear-segments"),e.set("keys","toggle-show-slices"),e.set("keyb","toggle-scale-bar"),e.set("keyv","toggle-default-annotations"),e.set("keya","toggle-axis-lines"),e.set("keyo","toggle-orthographic-projection");for(let t=1;t<=9;++t)e.set("digit"+t,"toggle-layer-"+t),e.set("control+digit"+t,"select-layer-"+t),e.set("alt+digit"+t,"toggle-pick-layer-"+t);for(let t=0;t<26;++t){let i=String.fromCharCode(97+t),r=String.fromCharCode(65+t);e.set(`alt?+control?+shift+key${i}`,`tool-${r}`)}e.set("keyn","add-layer"),e.set("keyh","help"),e.set("space","toggle-layout"),e.set("shift+space","toggle-layout-alternative"),e.set("backslash","toggle-show-statistics"),l=e}return l}(),Number.NEGATIVE_INFINITY),t.sliceView.addParent((void 0===p&&(p=se.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[cy(),Number.NEGATIVE_INFINITY]]})),p),Number.NEGATIVE_INFINITY),t.perspectiveView.addParent((void 0===h&&(h=se.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[cy(),Number.NEGATIVE_INFINITY]]})),h),Number.NEGATIVE_INFINITY);let r=i.registerDisposer(new TE(i.state,i.dataSourceProvider.sharedKvStoreContext,{defaultFragment:"undefined"!=typeof NEUROGLANCER_DEFAULT_STATE_FRAGMENT?NEUROGLANCER_DEFAULT_STATE_FRAGMENT:void 0}));i.registerDisposer(r.parseError.changed.add(()=>{let{value:e}=r.parseError;void 0!==e&&(new s1().setErrorMessage(`Error parsing state: ${e.message}`),console.log("Error parsing state",e)),r.parseError})),r.updateFromUrlHash(),i.registerDisposer(function(e){let t=(0,io.H)(()=>{let t=e.value?.trim();t?document.title=`${t} - neuroglancer`:document.title="neuroglancer"}),i=e.changed.add(t);return t(),t.flush(),()=>{i(),t.cancel()}}(i.title)),function(e){e.registerEventListener(document,"copy",t=>{if(sw(t.target))return;let i=document.getSelection();if(null!==i&&"Range"===i.type)return;let r=ny(e.state).value,{clipboardData:n}=t;null!==n&&n.setData("text/plain",JSON.stringify(r,void 0,"  ")),t.preventDefault()})}(i),function(e){e.registerEventListener(document,"paste",t=>{if(sw(t.target))return;let{clipboardData:i}=t;if(null!==i){let t=function(e,t){let i=String.raw`^[\[\]{}()\s,]*`;for(let e=0;e<t;++e)0!==e&&(i+=String.raw`[,\s]+`),i+=String.raw`(\d+(?:\.\d+)?)`;i+=String.raw`[\[\]{}()\s,]*$`;let r=e.match(i);if(null===r)return;let n=new Float32Array(t);for(let e=0;e<t;++e){let t=Number(r[e+1]);if(!Number.isFinite(t))return;n[e]=t}return n}(i.getData("text/plain"),e.coordinateSpace.value.rank);void 0!==t&&(e.navigationState.position.value=t)}t.preventDefault()})}(i)}()}},t={};function i(r){var n=t[r];if(void 0!==n)return n.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,i),s.exports}i.m=e,i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,{a:t}),t},i.d=function(e,t){for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.k=function(e){return""+e+".css"},i.u=function(e){return""+e+".f2e5bd83130a3d69.js"},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e=[];i.O=function(t,r,n,s){if(r){s=s||0;for(var a=e.length;a>0&&e[a-1][2]>s;a--)e[a]=e[a-1];e[a]=[r,n,s];return}for(var o=1/0,a=0;a<e.length;a++){for(var r=e[a][0],n=e[a][1],s=e[a][2],l=!0,d=0;d<r.length;d++)(!1&s||o>=s)&&Object.keys(i.O).every(function(e){return i.O[e](r[d])})?r.splice(d--,1):(l=!1,s<o&&(o=s));if(l){e.splice(a--,1);var u=n();void 0!==u&&(t=u)}}return t}})(),i.rv=function(){return"1.2.2"},(()=>{i.g.importScripts&&(e=i.g.location+"");var e,t=i.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var n=r.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=r[n--].src}if(!e)throw Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=e})(),(()=>{i.b=document.baseURI||self.location.href;var e={909:0};i.O.j=function(t){return 0===e[t]};var t=function(t,r){var n,s,a=r[0],o=r[1],l=r[2],d=0;if(a.some(function(t){return 0!==e[t]})){for(n in o)i.o(o,n)&&(i.m[n]=o[n]);if(l)var u=l(i)}for(t&&t(r);d<a.length;d++)s=a[d],i.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return i.O(u)},r=globalThis.webpackChunkneuroglancer=globalThis.webpackChunkneuroglancer||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})(),i.ruid="bundler=rspack@1.2.2";var r=i.O(void 0,["822","213","205","51"],function(){return i(7663)});r=i.O(r)})();
//# sourceMappingURL=main.b296376c54472182.js.map