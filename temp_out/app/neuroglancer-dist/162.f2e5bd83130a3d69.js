(()=>{"use strict";var e={8522:function(e,t,r){e.exports=r.p+"09f21dcf7b4f13e8.wasm"},4881:function(e,t,r){function n(e){return async t=>{let r=[];for(let n of(await Promise.allSettled(e.map(e=>e.match(t)))))"fulfilled"===n.status&&r.push(...n.value);return r}}r.d(t,{_E:()=>i}),r(6985),r(7734);class i{directorySpecs=[];fileSpecs=[];_directorySpec;_fileSpec;registerDirectoryFormat(e){this.directorySpecs.push(e),this._directorySpec=void 0}registerFileFormat(e){this.fileSpecs.push(e),this._fileSpec=void 0}copyTo(e){e.directorySpecs.push(...this.directorySpecs),e.fileSpecs.push(...this.fileSpecs),e._fileSpec=void 0,e._directorySpec=void 0}get directorySpec(){return this._directorySpec??(this._directorySpec=this.getDirectorySpec())}getDirectorySpec(){return function(e){let t=new Set,r=new Set;for(let n of e){let{fileNames:e,subDirectories:i}=n;if(void 0!==e)for(let r of e)t.add(r);if(void 0!==i)for(let e of i)r.add(e)}return{fileNames:t,subDirectories:r,match:n(e)}}(this.directorySpecs)}get fileSpec(){return this._fileSpec??(this._fileSpec=this.getFileSpec())}getFileSpec(){let{fileSpecs:e}=this;return function(e){let t=0,r=0;for(let n of e)t=Math.max(t,n.prefixLength),r=Math.max(r,n.suffixLength);return{prefixLength:t,suffixLength:r,match:n(e)}}([...e])}}},4758:function(e,t,r){r.d(t,{_J:()=>s,uX:()=>a,z2:()=>i});var n=r(6985);function i(e,t){if(void 0===t)return{outer:e,inner:{offset:0,length:e.length}};if("suffixLength"in t){let r=Math.min(e.length,t.suffixLength);return{outer:{offset:e.offset+(e.length-r),length:r},inner:{offset:e.length-r,length:r}}}if(t.offset+t.length>e.length)throw Error(`Requested byte range ${JSON.stringify(t)} not valid for value of length ${e.length}`);return{outer:{offset:e.offset+t.offset,length:t.length},inner:t}}function s(e,t){let{outer:{offset:r,length:n}}=i({offset:0,length:e.length},t);return{offset:r,length:n,totalSize:e.length,response:new Response(e.subarray(r,r+n))}}class a{base;byteRange;constructor(e,t){this.base=e,this.byteRange=t}async stat(e){return{totalSize:this.byteRange.length}}async read(e){let{byteRange:t}=this,{outer:r,inner:s}=i(t,e.byteRange);return 0===r.length?{response:new Response(new Uint8Array(0)),totalSize:t.length,...s}:{response:(await (0,n.iT)(this.base,{signal:e.signal,byteRange:r,strictByteRange:!0,throwIfMissing:!0})).response,totalSize:t.length,...s}}getUrl(){let{offset:e,length:t}=this.byteRange;return`${this.base.getUrl()}|range:${e}-${e+t}`}}},119:function(e,t,r){r.d(t,{i:()=>h,l:()=>f});var n=r(4758),i=r(6985),s=r(2258);function a(e){if(void 0!==e)return`bytes=${e.offset}-${e.offset+e.length-1}`}let o=-1!==navigator.userAgent.indexOf("Chrome")?"no-store":"default";function l(e,t){return new URL(e).pathname+"/"===new URL(t.url).pathname}function u(e){let t;let r=e.match(/bytes ([0-9]+)-([0-9]+)\/([0-9]+|\*)/);if(null===r)throw Error(`Invalid content-range header: ${JSON.stringify(e)}`);let n=parseInt(r[1],10),i=parseInt(r[2],10);return"*"!==r[3]&&(t=parseInt(r[3],10)),{offset:n,length:i-n+1,totalSize:t}}async function h(e,t,r,i,g=s.ru){let p;try{let s,h,d,y;let{byteRange:m}=i;if(void 0!==m){if("suffixLength"in m){let o=await f(e,t,r,i,g);if(void 0===o)return;let{totalSize:l}=o;if(void 0===l)throw Error(`Failed to determine total size of ${e.getUrl(t)} in order to fetch suffix ${JSON.stringify(m)}`);if(p=(0,n.z2)({offset:0,length:l},m).outer,0===p.length)return{...p,totalSize:l,response:new Response(new Uint8Array(0))};s=a(p)}else p=m,s=0===p.length?a({offset:Math.max(p.offset-1,0),length:1}):a(p)}let v={signal:i.signal,progressListener:i.progressListener};void 0!==s&&(v.headers={range:s},v.cache=o);let b=await g(r,v);if(l(r,b))return;if(206===b.status){let e=b.headers.get("content-range");if(null===e){if(void 0!==p)h=p.offset;else throw Error("Unexpected HTTP 206 response when no byte range specified.")}null!==e&&({offset:h,length:d,totalSize:y}=u(e))}else d=y=c(b.headers);return void 0===h&&(h=0),void 0===d&&(d=c(b.headers)),p?.length===0&&(b=new Response(new Uint8Array(0)),h=p.offset,d=0),{response:b,offset:h,length:d,totalSize:y}}catch(r){if(r instanceof s.oo&&416===r.status&&p?.length===0&&0===p.offset)return{response:new Response(new Uint8Array(0)),offset:0,length:0,totalSize:0};return d(e,t,i,r)}}function c(e){let t=e.get("content-length");if(null===e.get("content-encoding")&&null!==t){let e=Number(t);if(!Number.isFinite(e)||e<0)throw Error("Invalid content-length: {contentLength}");return e}}function d(e,t,r,n){if((0,s.XD)(n)){if(!0===r.throwIfMissing)throw new i.dR(new i.f2(e,t),{cause:n});return}throw n}async function f(e,t,r,n,i=s.ru){try{let e=await i(r,{method:"HEAD",signal:n.signal,progressListener:n.progressListener});if(l(r,e))return;return{totalSize:c(e.headers)}}catch(r){if(!(r instanceof s.oo)||405!==r.status&&501!==r.status)return d(e,t,n,r)}try{let e;let t=await i(r,{signal:n.signal,progressListener:n.progressListener,headers:{range:"bytes=0-0"}});if(l(r,t))return;if(200===t.status)e=c(t.headers);else{let r=t.headers.get("content-range");null!==r&&({totalSize:e}=u(r))}return{totalSize:e}}catch(r){if(r instanceof s.oo&&416===r.status)return{totalSize:0};return d(e,t,n,r)}}},6985:function(e,t,r){r.d(t,{BF:()=>s,Mt:()=>u,RQ:()=>o,dR:()=>i,f2:()=>l,iT:()=>a});var n=r(6235);class i extends Error{constructor(e,t){super(`${e.getUrl()} not found`,t)}}async function s(e,t,r={}){return a(new l(e,t),r)}async function a(e,t={}){let r=await e.read(t);if(t?.throwIfMissing===!0&&void 0===r)throw new i(e);if(t?.strictByteRange===!0&&void 0!==r){let{byteRange:n}=t,{offset:i,length:s}=r;if(void 0!==n&&("suffixLength"in n?s!==n.suffixLength:i!==n.offset||void 0!==s&&s!==n.length))throw Error(`Received truncated response for ${e.getUrl()}, expected ${JSON.stringify(n)} but received offset=${i}, length=${s}`)}return r}async function o(e,t,r={}){if(!e.list)throw Error("Listing not supported");return function(e,t,r,n){switch(n){case"suffix":{let r=t.length;return{directories:e.directories.map(e=>e.substring(r)),entries:e.entries.map(({key:e,...t})=>({...t,key:e.substring(r)}))}}case"url":return{directories:e.directories.map(e=>r.getUrl(e)),entries:e.entries.map(({key:e,...t})=>({...t,key:r.getUrl(e)}))};default:return e}}(await e.list(t,r),t,e,r.responseKeys)}class l{store;key;constructor(e,t){this.store=e,this.key=t}stat(e){return this.store.stat(this.key,e)}read(e){return this.store.read(this.key,e)}getUrl(){return this.store.getUrl(this.key)}}function u(e){return e.entries.sort(({key:e},{key:t})=>(0,n.B)(e,t)),e.directories.sort(n.B),e}},8274:function(e,t,r){function n(e){if(void 0===e)return"HEAD";if("generationNumber"in e)return`v${e.generationNumber}`;let{commitTime:t}=e;return a(t)}function i(e){if(void 0===e)return;let t=e.match(/^(?:v([1-9]\d*)|(?:\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d*)?Z))$/);if(null===t)throw Error(`Invalid OCDBT version specifier: ${JSON.stringify(e)}`);let[,r]=t;if(void 0!==r){let e=BigInt(r);if(e>0xffffffffffffffffn)throw Error(`Invalid generation number: ${e}`);return{generationNumber:e}}return{commitTime:function(e){let t=e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})(?:(\.\d*))?Z$/);if(null===t)throw Error(`Invalid commit timestamp: ${JSON.stringify(e)}`);let[,r,n]=t;return s(Date.parse(r+"Z"),n)}(e)}}function s(e,t){let r=1000000n*BigInt(e);return void 0!==t&&t.length>1&&(r+=BigInt(Math.min(0x3b9ac9ff,Math.round(1e9*Number(t))))),r}function a(e){let t=e%1000000000n,r=e/1000000000n;t<0n&&(t+=1000000000n,r-=1n);let n=new Date(1e3*Number(r)).toISOString();if(24!==n.length)throw Error(`Invalid commit time: ${e} -> ${n}`);return n=n.slice(0,19),0n!==t&&(n+="."+t.toString().padStart(9,"0").replace(/0+$/,"")),n+="Z"}r.d(t,{Qf:()=>u,ZU:()=>a,ko:()=>n,wy:()=>i});let o=RegExp("^(\\d{0,4})(?:(?<=\\d{4})-(\\d{0,2})(?:(?<=\\d{2})-(\\d{0,2})(?:(?<=\\d{2})T(\\d{0,2})(?:(?<=\\d{2}):(\\d{0,2})(?:(?<=\\d{2}):(\\d{0,2})(?:(?<=\\d{2})(\\.\\d*)?(Z)?)?)?)?)?)?)?$");function l(e,t,r,n,i){let s=parseInt((t=t??"").padEnd(r,"0"),10),a=parseInt(t.padEnd(r,"9"),10);if(s>i)throw Error(`Invalid ${e} prefix: ${t}`);return[Math.max(n,s),Math.min(i,a)]}function u(e){let t=e.match(o);if(null===t)throw Error(`Expected prefix of ISO-8601 "YYYY-MM-DDThh:mm:ss.sssssssssZ" format, but received: ${JSON.stringify(e)}`);let r=l("year",t[1],4,0,9999),n=l("month",t[2],2,1,12),i=function(e,t){let r=new Date(0);return r.setUTCFullYear(e),r.setUTCMonth(t),r.setUTCDate(0),r.getUTCDate()}(r[1],n[1]),a=l("day",t[3],2,1,i),u=l("hour",t[4],2,0,23),h=l("minute",t[5],2,0,59),c=l("second",t[6],2,0,59),d=t[7]??".",f=t[8],g=d.padEnd(10,"0"),p=void 0===f?d.padEnd(10,"9"):g,y=[g,p];function m(e){let t=new Date(0);return t.setUTCFullYear(r[e]),t.setUTCMonth(n[e]-1),t.setUTCDate(a[e]),t.setUTCHours(u[e]),t.setUTCMinutes(h[e]),t.setUTCSeconds(c[e]),s(t.getTime(),y[e])}return[m(0),m(1)]}},732:function(e,t,r){r.d(t,{g6:()=>l,ib:()=>s});var n=r(6923);let i=["http://doc.s3.amazonaws.com/2006-03-01/","http://s3.amazonaws.com/doc/2006-03-01/"];async function s(e,t,r,n){try{let s=await r(`${e}?list-type=2&prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent("/")}&encoding-type=url`,{headers:{accept:"application/xml,text/xml"},signal:n.signal,progressListener:n.progressListener}),a=s.headers.get("content-type");if(null===a||null===/\b(application\/xml|text\/xml|text\/html)\b/i.exec(a))throw Error(`Expected XML content-type but received: ${a}`);let o=await s.text(),l=new DOMParser().parseFromString(o,"application/xml"),{documentElement:u}=l;if(!i.includes(u.namespaceURI)||"ListBucketResult"!==u.tagName)throw Error(`Received unexpected XML root element <${u.tagName} xmlns="${u.namespaceURI}">`);let h=u.namespaceURI,c=()=>h,d=l.evaluate("//CommonPrefixes/Prefix",l,c,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),f=[];for(let e=0,t=d.snapshotLength;e<t;++e){let t=d.snapshotItem(e).textContent;null!==t&&(t=decodeURIComponent(t),f.push(t.substring(0,t.length-1)))}let g=[],p=l.evaluate("//Contents/Key",l,c,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let e=0,t=p.snapshotLength;e<t;++e){let t=p.snapshotItem(e).textContent;null!==t&&g.push({key:decodeURIComponent(t)})}return{directories:f,entries:g}}catch(e){throw Error("S3-compatible listing not supported",{cause:e})}}function a(e,t,r){let{baseUrl:i,path:a}=(0,n.f0)(e);return s(i,a,t,r)}async function o(e,t,r){let i=function(e){let t=new URL(e),r=t.pathname.match(/^\/([^/]+)(?:\/(.*))$/);if(null===r)return;let[,n,i]=r;return{bucketUrl:`${t.origin}/${n}/${t.search}`,bucket:decodeURIComponent(n),prefix:decodeURIComponent(i)}}(e);if(void 0===i)throw Error(`Path-style S3 URL ${JSON.stringify(e)} must specify bucket`);let{bucketUrl:a,bucket:o,prefix:l}=i,u=await s(a,l,t,r),h=(0,n.aU)(o)+"/";return{entries:u.entries.map(e=>({key:h+e.key})),directories:u.directories.map(e=>h+e)}}async function l(e,t,r,n,i){let s=r.getUncounted("s3:urlkind",()=>new Map),l=s.get(t);if("virtual"===l)return await a(e,n,i);if("path"===l)return await o(e,n,i);if(null!==l)try{let{result:r,urlKind:l}=await Promise.any([a(e,n,i).then(e=>({result:e,urlKind:"virtual"})),o(e,n,i).then(e=>({result:e,urlKind:"path"}))]);return s.set(t,l),r}catch(e){throw i.signal?.throwIfAborted(),s.set(t,null),Error("Neither virtual hosted nor path-style S3 listing supported",{cause:e})}throw Error("Neither virtual hosted nor path-style S3 listing supported")}},6923:function(e,t,r){function n(e){return e.match(/.*?([^|]*)$/)[1]}r.d(t,{Lj:()=>g,V8:()=>u,Vo:()=>l,Yq:()=>o,aU:()=>f,f0:()=>p,i1:()=>d,kw:()=>n,mq:()=>s,pN:()=>a,uh:()=>h,zY:()=>c});let i=/^(?:([a-zA-Z][a-zA-Z0-9-+.]*):)?(.*)$/;function s(e){let t=e.match(i),r=t[1],n=t[2];return void 0===r?{url:e,scheme:e,suffix:void 0}:{url:e,scheme:r,suffix:n}}function a(e){return e.split("|").map(s)}function o(e,...t){let[,r,n]=e.match(/^(.*?[^|?#]*)([^|]*)$/);for(let e of t)e.startsWith("/")&&(e=e.substring(1)),""!==e&&(r=function(e){let t=e.match(/^((?:.*?\|)?)([a-zA-Z][a-zA-Z0-9-+.]*)(?:(:[^?#|]*)((?:[?#][^|]*)?))?$/);if(null===t)throw Error(`Invalid URL: ${e}`);let[,r,n,i,s]=t;return void 0===i?`${r}${n}:`:":"===i||i.endsWith("/")?e:`${r}${n}${i}/${s??""}`}(r)+f(e));return r+n}function l(e,...t){for(let r of t)r.startsWith("/")&&(r=r.substring(1)),""!==r&&(e=u(e)+r);return e}function u(e){var t;return""===(t=e)||t.endsWith("/")||(e+="/"),e}function h(e){let{suffix:t}=e;if(void 0!==t&&t.match(/[#?]/))throw Error(`Invalid URL ${e.url}: query parameters and/or fragment not supported`)}function c(e){if(e.suffix)throw Error(`Invalid URL syntax ${JSON.stringify(e.url)}, expected "${e.scheme}:"`)}function d(e,t){let r=e;for(let n of(e.endsWith("/")&&(e=e.substring(0,e.length-1)),t.split("/")))if(""!==n&&"."!==n){if(".."===n){let n=e.lastIndexOf("/");if(n<=0)throw Error(`Invalid relative path ${JSON.stringify(t)} from base path ${JSON.stringify(r)}`);e=e.substring(0,n);continue}""!==e&&(e+="/"),e+=n}return t.endsWith("/")&&(e+="/"),e}function f(e){return encodeURI(e).replace(/[?#@]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)}function g(e,t){let{base:r,queryAndFragment:n}=function(e){let[,t,r]=e.match(/^(.*?[^|?#]*)([^|]*)$/);return{base:t,queryAndFragment:r}}(e);return r+f(t)+n}function p(e){let t=new URL(e);if(t.hash)throw Error("fragment not supported");if(t.username||t.password)throw Error("basic auth credentials not supported");return{baseUrl:`${t.origin}/${t.search}`,path:decodeURIComponent(t.pathname.substring(1))}}},4066:function(e,t,r){r.d(t,{BA:()=>i});var n,i=((n={})[n.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",n[n.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",n[n.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",n[n.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED",n)},3719:function(e,t,r){r.d(t,{SN:()=>a,TU:()=>o,Uw:()=>l});var n=r(2902),i=r(106),s=r(566);class a{value_;get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}changed;constructor(e){this.value_=e,this.changed=new s.K_}}class o extends a{validator;defaultValue;constructor(e,t,r=e){super(e),this.validator=t,this.defaultValue=r}toJSON(){let{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(void 0!==e){let{validator:t}=this;try{this.value=t(e);return}catch{}}this.value=this.defaultValue}}function l(e,...t){let r=t.map(e=>e.value),s=t.length,a=new i.gj,o=e(a,...r),u=(0,n.Z)(()=>{let n=!1;for(let e=0;e<s;++e){let i=t[e].value;r[e]!==i&&(r[e]=i,n=!0)}n&&(a.dispose(),o=e(a=new i.gj,...r))},0),h=t.map(e=>e.changed.add(u));return{flush(){u.flush()},dispose(){u.cancel(),(0,i.k1)(h),a.dispose()},get value(){return u.flush(),o}}}i.gj,i.gj,i.gj,i.gj,i.gj,i.gj},2606:function(e,t,r){function n(e,t){if(void 0!==e){if(e.aborted){t(e.reason);return}return e.addEventListener("abort",r,{once:!0}),{[Symbol.dispose](){e.removeEventListener("abort",r)}}}function r(){t(this.reason)}}r.d(t,{L0:()=>s,eg:()=>i,oi:()=>a});class i{consumers=new Map;controller=new AbortController;retainCount=0;get signal(){return this.controller.signal}addConsumer(e){if(!this.controller.signal.aborted){if(void 0!==e){if(e.aborted)return;let t=this;e.addEventListener("abort",function e(){t.consumers.delete(e),0==--t.retainCount&&(t.controller.abort(),t[Symbol.dispose]())},{once:!0})}++this.retainCount}}[Symbol.dispose](){for(let[e,t]of this.consumers)t.removeEventListener("abort",e);this.consumers.clear(),this.retainCount=0}start(){0===this.retainCount&&this.controller.abort()}}function s(e,t){let{promise:r,resolve:i,reject:s}=Promise.withResolvers(),a=n(e,t);return{promise:r,resolve:e=>{a?.[Symbol.dispose](),i(e)},reject:e=>{a?.[Symbol.dispose](),s(e)}}}function a(e,t){return void 0===t?e:t.aborted?Promise.reject(t.reason):new Promise((r,i)=>{let s=n(t,e=>{i(e)});e.then(e=>{s?.[Symbol.dispose](),r(e)},e=>{s?.[Symbol.dispose](),i(e)})})}},686:function(e,t,r){function n(e,t){return e<t?-1:e>t?1:0}function i(){let e=0x100000000*Math.random()>>>0;return BigInt(0x100000000*Math.random()>>>0)|BigInt(e)<<32n}r.d(t,{Nr:()=>s,_f:()=>n,ff:()=>i});let s=0xffffffffffffffffn},106:function(e,t,r){function n(e){for(let r=e.length;r>0;--r){var t;"object"==typeof(t=e[r-1])?t.dispose():t()}}r.d(t,{IF:()=>s,gj:()=>i,k1:()=>n});class i{refCount=1;wasDisposed;disposers;addRef(){return++this.refCount,this}disposedStacks;dispose(){0==--this.refCount&&this.refCountReachedZero()}[Symbol.dispose](){this.dispose()}refCountReachedZero(){this.disposed();let{disposers:e}=this;void 0!==e&&(n(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let{disposers:t}=this;return null==t?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let{disposers:t}=this;if(null!=t){let r=t.indexOf(e);-1!==r&&t.splice(r,1)}return e}registerEventListener(e,t,r,n){this.registerDisposer((e.addEventListener(t,r,n),()=>e.removeEventListener(t,r,n)))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}}class s extends i{value;constructor(e){super(),this.value=e}}},3783:function(e,t,r){r.d(t,{$k:()=>h,Fi:()=>p,R3:()=>i,Rq:()=>v,V2:()=>S,_E:()=>n,_Z:()=>g,b$:()=>l,bZ:()=>y,e6:()=>w,gf:()=>a,iG:()=>b,m0:()=>d,n_:()=>c,rn:()=>u,th:()=>m,vh:()=>s,vx:()=>f,wO:()=>o});var n=r(5975),i=r(7160),s=r(8333),a=r(2945),o=r(5600);n.create(),i.fromValues(1,0,0),i.fromValues(0,1,0),i.fromValues(0,0,1);let l=i.fromValues(0,0,0);s.fromValues(0,0,0,0);let u=i.fromValues(1,1,1),h=i.fromValues(1/0,1/0,1/0);function c(e){return e[0]*e[1]*e[2]}function d(e){return`${e[0]},${e[1]},${e[2]}`}function f(e,t,r){let n=t[0],i=t[1],s=t[2];return e[0]=r[0]*n+r[4]*i+r[8]*s,e[1]=r[1]*n+r[5]*i+r[9]*s,e[2]=r[2]*n+r[6]*i+r[10]*s,e}function g(e,t,r){let n=t[0],i=t[1],s=t[2];return e[0]=r[0]*n+r[1]*i+r[2]*s,e[1]=r[4]*n+r[5]*i+r[6]*s,e[2]=r[8]*n+r[9]*i+r[10]*s,e}function p(e,t,r,i,s){return e[0]=i[0],e[1]=i[1],e[2]=i[2]*s,n.fromRotationTranslationScale(e,r,t,e)}function y(e,t){let r=t[0],n=t[1],i=t[2],s=t[4],a=t[5],o=t[6],l=t[8],u=t[9],h=t[10];return e[0]=r,e[1]=n,e[2]=i,e[3]=s,e[4]=a,e[5]=o,e[6]=l,e[7]=u,e[8]=h,e}function m(e,t){let r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],l=t[6],u=t[7],h=t[8],c=t[9],d=t[10],f=t[11],g=t[12],p=t[13],y=t[14],m=t[15];e[0]=s+r,e[1]=u+a,e[2]=f+h,e[3]=m+g,e[4]=s-r,e[5]=u-a,e[6]=f-h,e[7]=m-g,e[8]=s+n,e[9]=u+o,e[10]=f+c,e[11]=m+p,e[12]=s-n,e[13]=u-o,e[14]=f-c,e[15]=m-p;let v=s+i,b=u+l,w=f+d,S=s-i,E=u-l,k=f-d,I=Math.sqrt(v**2+b**2+w**2);e[16]=v/I,e[17]=b/I,e[18]=w/I,e[19]=(m+y)/I;let M=Math.sqrt(S**2+E**2+k**2);return e[20]=S/M,e[21]=E/M,e[22]=k/M,e[23]=(m-y)/M,e}function v(e,t,r,n,i,s,a){for(let o=0;o<6;++o){let l=a[4*o],u=a[4*o+1],h=a[4*o+2];if(Math.max(l*e,l*n)+Math.max(u*t,u*i)+Math.max(h*r,h*s)+a[4*o+3]<0)return!1}return!0}function b(e,t,r,n,i,s,a){for(let o=0;o<4;++o){let l=a[4*o],u=a[4*o+1],h=a[4*o+2];if(Math.max(l*e,l*n)+Math.max(u*t,u*i)+Math.max(h*r,h*s)+a[4*o+3]<0)return!1}{let o=a[20],l=a[21],u=a[22],h=a[23],c=Math.max(o*e,o*n)+Math.max(l*t,l*i)+Math.max(u*r,u*s),d=1e-6*Math.abs(h);if(Math.min(o*e,o*n)+Math.min(l*t,l*i)+Math.min(u*r,u*s)>-h+d||c<-h-d)return!1}return!0}function w(e){if(1===e[15]){let t=2/Math.abs(e[10]);return 2/Math.abs(e[0])*(2/Math.abs(e[5]))*t}let t=e[10],r=2*e[14]/(2*t-2);return 4/(e[0]*e[5])/3*(Math.abs((t-1)*r/(t+1))**3-Math.abs(r)**3)}function S(e){if(1===e[15])return 2/Math.abs(e[10]);let t=e[10],r=2*e[14]/(2*t-2);return Math.abs((t-1)*r/(t+1)-r)}a.create(),i.create()},2136:function(e,t,r){function n(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);return t.length>=3&&31===t[0]&&139===t[1]&&8===t[2]}async function i(e,t,r){try{let n=s(e instanceof Response?e:new Response(e),t,r);return await new Response(n).arrayBuffer()}catch{throw r?.throwIfAborted(),Error(`Failed to decode ${t}`)}}function s(e,t,r){return e.body.pipeThrough(new DecompressionStream(t),{signal:r})}r.d(t,{Nk:()=>s,fK:()=>n,lL:()=>i})},290:function(e,t,r){r.d(t,{C$:()=>v,CT:()=>I,Iw:()=>y,JG:()=>T,Kh:()=>E,PT:()=>m,Qu:()=>x,ZE:()=>b,_b:()=>l,c6:()=>f,f6:()=>g,hd:()=>function e(t){if("object"==typeof t){if(null===t)return"null";if(Array.isArray(t)){let r="[",n=t.length,i=0;if(0<n)for(r+=e(t[i]);++i<n;)r+=",",r+=e(t[i]);return r+"]"}let r="{",n=Object.keys(t).sort(),i=0,s=n.length;if(i<s){let a=n[i];for(r+=JSON.stringify(a),r+=":",r+=e(t[a]);++i<s;)r+=",",r+=JSON.stringify(a=n[i]),r+=":",r+=e(t[a])}return r+"}"}return"bigint"==typeof t?t.toString():JSON.stringify(t)},j2:()=>k,jz:()=>s,kt:()=>w,lu:()=>a,m7:()=>p,nH:()=>i,o7:()=>o,tw:()=>C,uq:()=>S,zE:()=>M});var n=r(686);function i(e){let t=typeof e;if("number"===t||"string"===t){let t=parseFloat(""+e);if(!Number.isNaN(t))return t}throw Error(`Expected floating-point number, but received: ${JSON.stringify(e)}.`)}function s(e){let t=i(e);if(Number.isFinite(t))return t;throw Error(`Expected finite floating-point number, but received: ${t}.`)}function a(e){let t=i(e);if(Number.isFinite(t)&&t>=0)return t;throw Error(`Expected finite non-negative floating-point number, but received: ${t}.`)}function o(e){let t=s(e);if(t>0)return t;throw Error(`Expected positive finite floating-point number, but received: ${t}.`)}function l(e,t){let r=e.length;if(!Array.isArray(t)||t.length!==r)throw Error("Incompatible sizes");for(let e=0;e<r;++e)if(!Number.isFinite(parseFloat(t[e])))throw Error("Non-finite value.");for(let n=0;n<r;++n)e[n]=parseFloat(t[n]);return e}r(3783);let u=/('(?:[^'\\]|(?:\\.))*')/,h=/("(?:[^"\\]|(?:\\.))*")/,c=RegExp(`${u.source}|${h.source}`);RegExp(`${h.source}|${u.source}`);let d=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/;function f(e){return JSON.parse(function(e){let t="";for(;e.length>0;){let r,n;let i=e.match(c);if(null===i)r=e,e="",n="";else{r=e.substr(0,i.index),e=e.substr(i.index+i[0].length);let t=i[1];n=void 0!==t?function(e,t,r,n){if(e.length>=2&&"'"===e.charAt(0)&&"'"===e.charAt(e.length-1)){let i=e.substr(1,e.length-2),s='"';for(;i.length>0;){let e=i.match(n);if(null===e){s+=i;break}s+=e[1],'"'===e[2]?(s+="\\",s+=r):s+=t,i=i.substr(e.index+e[0].length)}return s+r}return e}(t,"'",'"',d):i[2]}t+=r.replace(/\(/g,"[").replace(/\)/g,"]").replace("True","true").replace("False","false").replace(/,\s*([}\]])/g,"$1"),t+=n}return t}(e))}function g(e,t){if(!Array.isArray(e))throw Error(`Expected array, but received: ${JSON.stringify(e)}.`);if(void 0!==t&&e.length!==t)throw Error(`Expected array of length ${t}, but received: ${JSON.stringify(e)}.`);return e}function p(e,t){if(!Array.isArray(e))throw Error(`Expected array, but received: ${JSON.stringify(e)}.`);return e.map(t)}function y(e,t,r){let n=e.length;if(!Array.isArray(t)||t.length!==n)throw Error(`Expected length ${n} array, but received: ${JSON.stringify(t)}.`);for(let i=0;i<n;++i)e[i]=r(t[i],i);return e}function m(e){if("object"!=typeof e||null==e||Array.isArray(e))throw Error(`Expected JSON object, but received: ${JSON.stringify(e)}.`);return e}function v(e){let t=parseInt(e,10);if(!Number.isInteger(t))throw Error(`Expected integer, but received: ${JSON.stringify(e)}.`);return t}function b(e){if("string"!=typeof e)throw Error(`Expected string, but received: ${JSON.stringify(e)}.`);return e}function w(e){if(void 0!==e)return b(e)}function S(e,t,r){let n=Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0;try{return r(n)}catch(e){throw Error(`Error parsing ${JSON.stringify(t)} property: ${e.message}`)}}function E(e,t,r,n){return S(e,t,e=>void 0===e?n:r(e))}function k(e){if("number"!=typeof e||!Number.isFinite(e)||e<0||e>1)throw Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(e)}.`);return e}function I(e,t,r=/^[a-zA-Z]/){if("string"==typeof e&&null!==e.match(r)){let r=e.toUpperCase();if(Object.prototype.hasOwnProperty.call(t,r))return t[r]}throw Error(`Invalid enum value: ${JSON.stringify(e)}.`)}function M(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)if("string"!=typeof t)throw Error(`Expected string, received: ${JSON.stringify(t)}.`);return e}function x(e){if(!Array.isArray(e))throw Error(`Expected array, received: ${JSON.stringify(e)}.`);for(let t of e)if(!Number.isInteger(t))throw Error(`Expected integer, received: ${JSON.stringify(t)}.`);return e}function T(e){if("boolean"!=typeof e)throw Error(`Expected boolean, received: ${JSON.stringify(e)}`);return e}function C(e){let t;switch(typeof e){case"string":if(null===e.match(/^(?:0|[1-9][0-9]*)$/))throw Error(`Expected base-10 number, but received: ${JSON.stringify(e)}`);t=BigInt(e);break;case"number":t=BigInt(e);break;case"bigint":t=e;break;default:throw Error(`Expected uint64 value, but received: ${JSON.stringify(e)}`)}if(t<0n||t>n.Nr)throw Error(`Expected uint64 value, but received: ${t}`);return t}},3853:function(e,t,r){let n;function i(e,t,r=t){return function(e,t,r){for(let n=0;n<r;++n){let i=t*n;e.fill(0,i,i+r),e[i+n]=1}return e}(new e(t*r),t,Math.min(t,r))}function s(e,t,r,i,s){return!function(e,t,r,n,i,s){for(let a=0;a<s;++a){let s=a*n,o=a*t;for(let t=0;t<i;++t)e[o+t]=r[s+t]}}(e,t,r,i,s,s),function(e,t,r){let i=1;(void 0===n||n.length<r)&&(n=new Uint32Array(r));for(let e=0;e<r;++e)n[e]=e;for(let s=0;s<r;++s){let a=t*s,o=s;{let t=Math.abs(e[a+s]);for(let n=s+1;n<r;++n){let r=Math.abs(e[a+n]);r>t&&(t=r,o=n)}}if(s!==o){i*=-1;for(let n=0;n<r;++n){let r=t*n,i=e[r+s];e[r+s]=e[r+o],e[r+o]=i}{let e=n[s];n[s]=n[o],n[o]=e}}let l=e[a+s],u=1/l;i*=l;for(let n=0;n<r;++n)e[t*n+s]*=u;e[a+s]=u;for(let n=0;n<r;++n){if(n===s)continue;let i=-e[t*s+n];for(let a=0;a<r;++a){let r=t*a;e[r+n]+=i*e[r+s]}e[t*s+n]=i*u}}for(let i=0;i<r;++i){let s=n[i];for(;s!==i;){let a=t*i,o=t*s;for(let t=0;t<r;++t){let r=a+t,n=o+t,i=e[r];e[r]=e[n],e[n]=i}let l=n[i]=n[s];n[s]=s,s=l}}return i}(e,t,s)}r.d(t,{SO:()=>s,XD:()=>i})},7734:function(e,t,r){r.d(t,{Vi:()=>n,Zi:()=>l});class n{listener;id;startTime;message;constructor(e,t){this.listener=e;let{id:r=Math.random(),startTime:n=Date.now(),message:i}=t;this.id=r,this.startTime=n,this.message=i,e.addSpan(this)}[Symbol.dispose](){this.listener.removeSpan(this.id)}}class i{items=new Map;add(e){let{items:t}=this,r=(t.get(e)??0)+1;return t.set(e,r),r}delete(e){let{items:t}=this,r=t.get(e);return r>1?(r-=1,t.set(e,r),r):(t.delete(e),0)}has(e){return this.items.has(e)}keys(){return this.items.keys()}entries(){return this.items.entries()}[Symbol.iterator](){return this.items.keys()}}class s{getKey;items;constructor(e){this.getKey=e,this.items=new Map}add(e){let{items:t}=this,r=this.getKey(e),n=t.get(r);return void 0===n?(t.set(r,{value:e,count:1}),1):n.count+=1}delete(e){return this.deleteKey(this.getKey(e))}deleteKey(e){let{items:t}=this,r=t.get(e);return void 0!==r&&r.count>1?r.count-=1:(t.delete(e),0)}has(e){return this.items.has(this.getKey(e))}*[Symbol.iterator](){for(let e of this.items.values())yield e.value}}function a(e){return e.id}class o extends s{constructor(){super(a)}}class l{spans=new o;listeners=new i;addSpan(e){if(1===this.spans.add(e))for(let t of this.listeners)t.addSpan(e)}removeSpan(e){if(0===this.spans.deleteKey(e))for(let t of this.listeners)t.removeSpan(e)}addListener(e){if(void 0!==e&&1===this.listeners.add(e))for(let t of this.spans)e.addSpan(t)}removeListener(e){if(void 0!==e&&0===this.listeners.delete(e))for(let t of this.spans)e.removeSpan(t.id)}}},6224:function(e,t,r){function n(e=128){let t=Math.ceil(e/32),r=new Uint32Array(t);crypto.getRandomValues(r);let i="";for(let e=0;e<t;++e)i+=("00000000"+r[e].toString(16)).slice(-8);return i}function i(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,r=t.length;e<r;e+=65536)crypto.getRandomValues(t.subarray(e,Math.min(r,e+65536)));return e}r.d(t,{PP:()=>i,c0:()=>n})},566:function(e,t,r){r.d(t,{K_:()=>i,MZ:()=>n});class n{handlers=new Set;count=0;constructor(){let e=this;this.dispatch=function(){++e.count,e.handlers.forEach(e=>{e.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}addOnce(e){let{handlers:t}=this;t.add(function r(...n){t.delete(r),e(...n)})}remove(e){return this.handlers.delete(e)}dispatch;dispose(){this.handlers=void 0}}class i extends n{}},1949:function(e,t,r){let n,i,s;r(2374);var a,o,l,u,h,c,d,f,g,p,y,m,v,b,w,S,E,k=r(3719),I=r(2606),M=r(106),x=r(7734);let T=!("undefined"!=typeof Window&&self instanceof Window),C="rpc.promise.response",N="rpc.promise.cancel",$="rpc.promise.addProgressSpan",R="rpc.promise.removeProgressSpan",P="rpc.ready",U=new Map;function O(e,t){U.set(e,t)}class A{rpc;id;constructor(e,t){this.rpc=e,this.id=t}addSpan(e){this.rpc.invoke($,{id:this.id,span:{id:e.id,message:e.message,startTime:e.startTime}})}removeSpan(e){this.rpc.invoke(R,{id:this.id,spanId:e})}}function _(e,t){O(e,function(e){let r;let n=e.id,i=new AbortController;!0===e.progressListener&&(r=new A(this,n));let s=t.call(this,e,{signal:i.signal,progressListener:r});this.set(n,{promise:s,abortController:i}),s.then(({value:e,transfers:t})=>{this.delete(n),this.invoke(C,{id:n,value:e},t)},e=>{this.delete(n),this.invoke(C,{id:n,error:e})})})}O(N,function(e){let t=e.id,r=this.get(t);if(void 0!==r){let{abortController:e}=r;e.abort()}}),O(C,function(e){let t=e.id,{resolve:r,reject:n}=this.get(t);this.delete(t),Object.prototype.hasOwnProperty.call(e,"value")?r(e.value):n(e.error)}),O($,function(e){let t=e.id,{progressListener:r}=this.get(t);new x.Vi(r,e.span)}),O(R,function(e){let t=e.id,{progressListener:r}=this.get(t);r.removeSpan(e.spanId)}),O(P,function(e){this.onPeerReady()});let L=T?-1:0;class D extends M.gj{rpc=null;rpcId=null;isOwner;unreferencedGeneration;referencedGeneration;initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){!0===this.isOwner?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():!1===this.isOwner?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){let{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,0===this.refCount&&e===this.referencedGeneration&&this.ownerDispose()}}function z(e,t,r={}){null!=t&&e.initializeSharedObject(t,r.id)}class B extends D{constructor(e,t={}){super(),z(this,e,t)}}O("SharedObject.dispose",function(e){let t=this.get(e.id);if(0!==t.refCount)throw Error("Attempted to dispose object with non-zero reference count.");t.disposed(),this.delete(t.rpcId),t.rpcId=null,t.rpc=null}),O("SharedObject.refCountReachedZero",function(e){let t=this.get(e.id),r=e.gen;t.counterpartRefCountReachedZero(r)});let j=new Map;function F(e){return t=>{if(void 0!==e)t.prototype.RPC_TYPE_ID=e;else if(void 0===(e=t.prototype.RPC_TYPE_ID))throw Error("RPC_TYPE_ID should have already been defined");j.set(e,t)}}O("SharedObject.new",function(e){let t=e.type,r=new(j.get(t))(this,e);--r.refCount});let V="SharedWatchableValue.changed";class G extends B{base;updatingValue_=!1;constructor(e,t={}){super(e,t),void 0!==e&&(this.base=new k.SN(t.value),this.setupChangedHandler())}initializeCounterpart(e,t={}){t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{let{rpc:e}=this;null!==e&&e.invoke(V,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(e,t){let r=new G;return r.base=t,r.setupChangedHandler(),r.initializeCounterpart(e),r}static make(e,t){return G.makeFromExisting(e,new k.SN(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}}G=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F("SharedWatchableValue")],G),O(V,function(e){let t=this.get(e.id);t.updatingValue_=!0,t.base.value=e.value,t.updatingValue_=!1});var K=r(8709),Y=((a={})[a.GPU_MEMORY=0]="GPU_MEMORY",a[a.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",a[a.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",a[a.DOWNLOADING=3]="DOWNLOADING",a[a.QUEUED=4]="QUEUED",a[a.NEW=5]="NEW",a[a.FAILED=6]="FAILED",a[a.EXPIRED=7]="EXPIRED",a),q=((o={})[o.FIRST_TIER=0]="FIRST_TIER",o[o.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",o[o.VISIBLE=0]="VISIBLE",o[o.PREFETCH=1]="PREFETCH",o[o.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",o[o.RECENT=2]="RECENT",o[o.LAST_TIER=2]="LAST_TIER",o),J=((l={})[l.totalTime=0]="totalTime",l[l.totalChunks=1]="totalChunks",l),W=((u={})[u.numChunks=0]="numChunks",u[u.systemMemoryBytes=1]="systemMemoryBytes",u[u.gpuMemoryBytes=2]="gpuMemoryBytes",u),Z=r(7902),X=r(4571);function Q(e){let{child:t,next:r,prev:n,compare:i}=e;function s(e){let i=e[t];if(null===i)return null;let s=null;for(;;){let e,t;let n=i[r];if(null===n?(e=null,t=i):(e=n[r],t=a(i,n)),t[r]=s,s=t,null===e)break;i=e}let o=s;for(s=s[r];null!==s;){let e=s[r];o=a(o,s),s=e}return o[n]=null,o[r]=null,o}function a(e,s){if(null===s)return e;if(null===e)return s;if(i(s,e)){let t=e;e=s,s=t}let a=e[t];return s[r]=a,s[n]=e,null!==a&&(a[n]=s),e[t]=s,e}function o(e){let i=s(e);return e[r]=null,e[n]=null,e[t]=null,i}function*l(e){if(null!==e){let n=e[t];for(yield e;null!==n;){let e=n[r];yield*l(n),n=e}}}return{compare:i,meld:a,removeMin:o,remove:function(e,i){if(e===i)return o(e);let l=i[n],u=i[r];l[t]===i?l[t]=u:l[r]=u,null!==u&&(u[n]=l);let h=a(e,s(i));return i[r]=null,i[n]=null,i[t]=null,h},entries:l,removedEntries:function*(e){if(null!==e){let i=e[t];for(e[t]=null,e[r]=null,e[n]=null,yield e;null!==i;){let e=i[r];i[t]=null,i[r]=null,i[n]=null,yield*l(i),i=e}}}}}var H=r(566);function ee(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}let et=0;class er{child0=null;next0=null;prev0=null;child1=null;next1=null;prev1=null;source=null;key=null;state_=Y.NEW;error=null;markGeneration=-1;priority=0;newPriority=0;priorityTier=q.RECENT;newPriorityTier=q.RECENT;systemMemoryBytes_=0;gpuMemoryBytes_=0;downloadSlots_=1;isComputational=!1;requestedState=Y.NEW;newRequestedState=Y.NEW;downloadAbortController=void 0;initialize(e){this.key=e,this.priority=Number.NEGATIVE_INFINITY,this.priorityTier=q.RECENT,this.newPriority=Number.NEGATIVE_INFINITY,this.newPriorityTier=q.RECENT,this.error=null,this.state=Y.NEW,this.requestedState=Y.NEW,this.newRequestedState=Y.NEW}updatePriorityProperties(){this.priorityTier=this.newPriorityTier,this.priority=this.newPriority,this.newPriorityTier=q.RECENT,this.newPriority=Number.NEGATIVE_INFINITY,this.requestedState=this.newRequestedState,this.newRequestedState=Y.NEW}dispose(){this.source=null,this.error=null}get chunkManager(){return this.source.chunkManager}get queueManager(){return this.source.chunkManager.queueManager}downloadFailed(e){this.error=e,this.queueManager.updateChunkState(this,Y.FAILED)}downloadSucceeded(){this.requestedState===Y.SYSTEM_MEMORY?(this.queueManager.moveChunkToFrontend(this),this.queueManager.updateChunkState(this,Y.SYSTEM_MEMORY)):this.queueManager.updateChunkState(this,Y.SYSTEM_MEMORY_WORKER)}freeSystemMemory(){}serialize(e,t){e.id=this.key,e.source=this.source.rpcId,e.new=!0}toString(){return this.key}set state(e){if(e===this.state_)return;let t=this.state_;this.state_=e,this.source.chunkStateChanged(this,t)}get state(){return this.state_}set systemMemoryBytes(e){ei(this,-1),this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!1),this.systemMemoryBytes_=e,this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!0),ei(this,1),this.chunkManager.queueManager.scheduleUpdate()}get systemMemoryBytes(){return this.systemMemoryBytes_}set gpuMemoryBytes(e){ei(this,-1),this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!1),this.gpuMemoryBytes_=e,this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!0),ei(this,1),this.chunkManager.queueManager.scheduleUpdate()}get gpuMemoryBytes(){return this.gpuMemoryBytes_}get downloadSlots(){return this.downloadSlots_}set downloadSlots(e){e!==this.downloadSlots_&&(ei(this,-1),this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!1),this.downloadSlots_=e,this.chunkManager.queueManager.adjustCapacitiesForChunk(this,!0),ei(this,1),this.chunkManager.queueManager.scheduleUpdate())}registerListener(e){return!!this.source&&this.source.registerChunkListener(this.key,e)}unregisterListener(e){return!!this.source&&this.source.unregisterChunkListener(this.key,e)}static priorityLess(e,t){return e.priority<t.priority}static priorityGreater(e,t){return e.priority>t.priority}}class en extends D{chunkManager;listeners_;chunks;freeChunks;statistics;sourceQueueLevel;constructor(e){super(),this.chunkManager=e,this.listeners_=new Map,this.chunks=new Map,this.freeChunks=[],this.statistics=new Float64Array(74),this.sourceQueueLevel=0,e.queueManager.sources.add(this)}disposed(){this.chunkManager.queueManager.sources.delete(this),super.disposed()}getNewChunk_(e){let t=this.freeChunks,r=t.length;if(r>0){let e=t[r-1];return t.length=r-1,e.source=this,e}let n=new e;return n.source=this,n}addChunk(e){let{chunks:t}=this;0===t.size&&this.addRef(),t.set(e.key,e),ei(e,1)}removeChunk(e){let{chunks:t,freeChunks:r}=this;t.delete(e.key),e.dispose(),r[r.length]=e,0===t.size&&this.dispose()}registerChunkListener(e,t){return this.listeners_.has(e)?this.listeners_.get(e).push(t):this.listeners_.set(e,[t]),!0}unregisterChunkListener(e,t){if(!this.listeners_.has(e))return!1;let r=this.listeners_.get(e),n=r.indexOf(t);return!(n<0)&&(r.splice(n,1),0===r.length&&this.listeners_.delete(e),!0)}chunkStateChanged(e,t){let{key:r}=e;if(null===r)return;let n=this.listeners_.get(r);if(void 0!==n)for(let r of n.slice())r(e,t)}}function ei(e,t){let{statistics:r}=e.source,{systemMemoryBytes:n,gpuMemoryBytes:i}=e,s=3*e.state+e.priorityTier;r[3*s+W.numChunks]+=t,r[3*s+W.systemMemoryBytes]+=t*n,r[3*s+W.gpuMemoryBytes]+=t*i}class es extends en{constructor(e,t){super(e.get(t.chunkManager)),z(this,e,t)}}function ea(e){let t=e.downloadAbortController;e.downloadAbortController=void 0,t.abort(new DOMException("chunk download cancelled","AbortError"))}class eo{heapOperations;linkedListOperations;heapRoots;recentHead;constructor(e,t){this.heapOperations=e,this.linkedListOperations=t,this.heapRoots=[null,null],this.recentHead=new er,t.initializeHead(this.recentHead)}add(e){let t=e.priorityTier;if(t===q.RECENT)this.linkedListOperations.insertAfter(this.recentHead,e);else{let{heapRoots:r}=this;r[t]=this.heapOperations.meld(r[t],e)}}*candidates(){if(this.heapOperations.compare===er.priorityLess){let{linkedListOperations:e,recentHead:t}=this;for(;;){let r=e.back(t);if(null==r)break;yield r}let{heapRoots:r}=this;for(let e=q.LAST_ORDERED_TIER;e>=q.FIRST_ORDERED_TIER;--e)for(;;){let t=r[e];if(null==t)break;yield t}}else{let e=this.heapRoots;for(let t=q.FIRST_ORDERED_TIER;t<=q.LAST_ORDERED_TIER;++t)for(;;){let r=e[t];if(null==r)break;yield r}let{linkedListOperations:t,recentHead:r}=this;for(;;){let e=t.front(r);if(null==e)break;yield e}}}delete(e){let t=e.priorityTier;if(t===q.RECENT)this.linkedListOperations.pop(e);else{let r=this.heapRoots;r[t]=this.heapOperations.remove(r[t],e)}}}let el=(0,Z.Z)({next:"next0",prev:"prev0"}),eu=(0,Z.Z)({next:"next1",prev:"prev1"});function eh(e){return new eo(Q({compare:e,child:"child1",next:"next1",prev:"prev1"}),eu)}function ec(e,t,r,n,i,s){for(;t.availableItems<1||t.availableSize<e;){let e=i.next().value;if(void 0===e)return!1;let t=e.priorityTier;if(t<r||t===r&&e.priority>=n)return!1;s(e)}return!0}class ed extends M.gj{itemLimit;sizeLimit;currentSize;currentItems;capacityChanged;constructor(e,t){super(),this.itemLimit=e,this.sizeLimit=t,this.currentSize=0,this.currentItems=0,this.capacityChanged=new H.K_,this.registerDisposer(e.changed.add(this.capacityChanged.dispatch)),this.registerDisposer(t.changed.add(this.capacityChanged.dispatch))}adjust(e,t){this.currentItems-=e,this.currentSize-=t}get availableSize(){return this.sizeLimit.value-this.currentSize}get availableItems(){return this.itemLimit.value-this.currentItems}toString(){return`bytes=${this.currentSize}/${this.sizeLimit.value},items=${this.currentItems}/${this.itemLimit.value}`}}class ef extends B{gpuMemoryCapacity;systemMemoryCapacity;downloadCapacity;computeCapacity;enablePrefetch;sources=new Set;queuedDownloadPromotionQueue=[eh(er.priorityGreater),eh(er.priorityGreater)];queuedComputePromotionQueue=eh(er.priorityGreater);downloadEvictionQueue=[eh(er.priorityLess),eh(er.priorityLess)];computeEvictionQueue=eh(er.priorityLess);systemMemoryEvictionQueue=new eo(Q({compare:er.priorityLess,child:"child0",next:"next0",prev:"prev0"}),el);gpuMemoryPromotionQueue=eh(er.priorityGreater);gpuMemoryEvictionQueue=eh(er.priorityLess);updatePending=null;gpuMemoryChanged=new H.K_;numQueued=0;numFailed=0;gpuMemoryGeneration=0;constructor(e,t){super(e,t);let r=t=>{let r=this.registerDisposer(new ed(e.get(t.itemLimit),e.get(t.sizeLimit)));return r.capacityChanged.add(()=>this.scheduleUpdate()),r};this.gpuMemoryCapacity=r(t.gpuMemoryCapacity),this.systemMemoryCapacity=r(t.systemMemoryCapacity),this.enablePrefetch=e.get(t.enablePrefetch),this.downloadCapacity=[r(t.downloadCapacity),r(t.downloadCapacity)],this.computeCapacity=r(t.computeCapacity)}scheduleUpdate(){null===this.updatePending&&(this.updatePending=setTimeout(this.process.bind(this),0))}*chunkQueuesForChunk(e){switch(e.state){case Y.QUEUED:e.isComputational?yield this.queuedComputePromotionQueue:yield this.queuedDownloadPromotionQueue[e.source.sourceQueueLevel];break;case Y.DOWNLOADING:e.isComputational?yield this.computeEvictionQueue:(yield this.downloadEvictionQueue[e.source.sourceQueueLevel],yield this.systemMemoryEvictionQueue);break;case Y.SYSTEM_MEMORY_WORKER:case Y.SYSTEM_MEMORY:yield this.systemMemoryEvictionQueue,e.requestedState===Y.GPU_MEMORY&&(yield this.gpuMemoryPromotionQueue);break;case Y.GPU_MEMORY:yield this.systemMemoryEvictionQueue,yield this.gpuMemoryEvictionQueue}}adjustCapacitiesForChunk(e,t){let r=t?-1:1;switch(e.state){case Y.FAILED:this.numFailed-=r;break;case Y.QUEUED:this.numQueued-=r;break;case Y.DOWNLOADING:(e.isComputational?this.computeCapacity:this.downloadCapacity[e.source.sourceQueueLevel]).adjust(r*e.downloadSlots,r*e.systemMemoryBytes),this.systemMemoryCapacity.adjust(r,r*e.systemMemoryBytes);break;case Y.SYSTEM_MEMORY:case Y.SYSTEM_MEMORY_WORKER:this.systemMemoryCapacity.adjust(r,r*e.systemMemoryBytes);break;case Y.GPU_MEMORY:this.systemMemoryCapacity.adjust(r,r*e.systemMemoryBytes),this.gpuMemoryCapacity.adjust(r,r*e.gpuMemoryBytes)}}removeChunkFromQueues_(e){for(let t of(ei(e,-1),this.chunkQueuesForChunk(e)))t.delete(e)}addChunkToQueues_(e){if(e.state===Y.QUEUED&&e.priorityTier===q.RECENT){let{source:t}=e;return t.removeChunk(e),this.adjustCapacitiesForChunk(e,!1),!1}for(let t of(ei(e,1),this.chunkQueuesForChunk(e)))t.add(e);return!0}performChunkPriorityUpdate(e){if(e.priorityTier===e.newPriorityTier&&e.priority===e.newPriority){e.newPriorityTier=q.RECENT,e.newPriority=Number.NEGATIVE_INFINITY;return}this.removeChunkFromQueues_(e),e.updatePriorityProperties(),e.state===Y.NEW&&(e.state=Y.QUEUED,this.adjustCapacitiesForChunk(e,!0)),this.addChunkToQueues_(e)}updateChunkState(e,t){t!==e.state&&(this.adjustCapacitiesForChunk(e,!1),this.removeChunkFromQueues_(e),e.state=t,this.adjustCapacitiesForChunk(e,!0),this.addChunkToQueues_(e),this.scheduleUpdate())}markRecentlyUsed(e){this.removeChunkFromQueues_(e),this.addChunkToQueues_(e)}processGPUPromotions_(){let e=this;function t(t){e.freeChunkGPUMemory(t),t.source.chunkManager.queueManager.updateChunkState(t,Y.SYSTEM_MEMORY)}let r=this.gpuMemoryPromotionQueue.candidates(),n=this.gpuMemoryEvictionQueue.candidates(),i=this.gpuMemoryCapacity;for(;;){let e=r.next().value;if(void 0===e)break;let s=e.priorityTier,a=e.priority;if(!ec(e.gpuMemoryBytes,i,s,a,n,t))break;this.copyChunkToGPU(e),this.updateChunkState(e,Y.GPU_MEMORY)}}freeChunkGPUMemory(e){++this.gpuMemoryGeneration,this.rpc.invoke("Chunk.update",{id:e.key,state:Y.SYSTEM_MEMORY,source:e.source.rpcId})}freeChunkSystemMemory(e){e.state===Y.SYSTEM_MEMORY_WORKER?e.freeSystemMemory():this.rpc.invoke("Chunk.update",{id:e.key,state:Y.EXPIRED,source:e.source.rpcId})}retrieveChunkData(e){return this.rpc.promiseInvoke("Chunk.retrieve",{key:e.key,source:e.source.rpcId})}copyChunkToGPU(e){++this.gpuMemoryGeneration;let t=this.rpc;if(e.state===Y.SYSTEM_MEMORY)t.invoke("Chunk.update",{id:e.key,source:e.source.rpcId,state:Y.GPU_MEMORY});else{let r={},n=[];e.serialize(r,n),r.state=Y.GPU_MEMORY,t.invoke("Chunk.update",r,n)}}moveChunkToFrontend(e){let t=this.rpc,r={},n=[];e.serialize(r,n),r.state=Y.SYSTEM_MEMORY,t.invoke("Chunk.update",r,n)}processQueuePromotions_(){let e=e=>{switch(e.state){case Y.DOWNLOADING:ea(e);break;case Y.GPU_MEMORY:this.freeChunkGPUMemory(e);case Y.SYSTEM_MEMORY_WORKER:case Y.SYSTEM_MEMORY:this.freeChunkSystemMemory(e)}this.updateChunkState(e,Y.QUEUED)},t=(t,r,n)=>{let i=this.systemMemoryEvictionQueue.candidates(),s=this.systemMemoryCapacity;for(;;){let a=t.next();if(a.done)return;let o=a.value,l=o.priorityTier,u=o.priority;if(!ec(0,n,l,u,r,e)||!ec(0,s,l,u,i,e))return;this.updateChunkState(o,Y.DOWNLOADING),function(e){let t=e.downloadAbortController=new AbortController,r=Date.now();e.source.download(e,t.signal).then(()=>{if(e.downloadAbortController===t){e.downloadAbortController=void 0;let t=Date.now(),{statistics:n}=e.source;n[72+J.totalTime]+=t-r,++n[72+J.totalChunks],e.downloadSucceeded()}},r=>{e.downloadAbortController===t&&(e.downloadAbortController=void 0,e.downloadFailed(r),console.log(`Error retrieving chunk ${e}: ${r}`))})}(o)}};for(let e=0;e<2;++e)t(this.queuedDownloadPromotionQueue[e].candidates(),this.downloadEvictionQueue[e].candidates(),this.downloadCapacity[e]);t(this.queuedComputePromotionQueue.candidates(),this.computeEvictionQueue.candidates(),this.computeCapacity)}process(){if(!this.updatePending)return;this.updatePending=null;let e=this.gpuMemoryGeneration;this.processGPUPromotions_(),this.processQueuePromotions_(),this.logStatistics(),this.gpuMemoryGeneration!==e&&this.gpuMemoryChanged.dispatch()}logStatistics(){}invalidateSourceCache(e){for(let t of e.chunks.values()){switch(t.state){case Y.DOWNLOADING:ea(t);break;case Y.SYSTEM_MEMORY_WORKER:t.freeSystemMemory()}this.updateChunkState(t,Y.QUEUED)}this.rpc.invoke("Chunk.update",{source:e.rpcId}),this.scheduleUpdate()}}ef=ee([F("ChunkQueueManager")],ef);class eg extends B{chunkManagerGeneration=-1;numVisibleChunksNeeded=0;numVisibleChunksAvailable=0;numPrefetchChunksNeeded=0;numPrefetchChunksAvailable=0}class ep extends B{queueManager;existingTierChunks=[];newTierChunks=[];updatePending=null;recomputeChunkPriorities=new H.K_;recomputeChunkPrioritiesLate=new H.K_;memoize=new X.O1;layers=[];sendLayerChunkStatistics=this.registerCancellable((0,K.Z)(()=>{this.rpc.invoke("ChunkManager.chunkLayerStatistics",{id:this.rpcId,layers:this.layers.map(e=>({id:e.rpcId,numVisibleChunksAvailable:e.numVisibleChunksAvailable,numVisibleChunksNeeded:e.numVisibleChunksNeeded,numPrefetchChunksAvailable:e.numPrefetchChunksAvailable,numPrefetchChunksNeeded:e.numPrefetchChunksNeeded}))})},200));constructor(e,t){super(e,t),this.queueManager=e.get(t.chunkQueueManager).addRef(),this.registerDisposer(this.queueManager.gpuMemoryChanged.add(this.registerCancellable((0,K.Z)(()=>this.scheduleUpdateChunkPriorities(),200,{leading:!1,trailing:!0}))));for(let e=q.FIRST_TIER;e<=q.LAST_TIER;++e)e!==q.RECENT&&(this.existingTierChunks[e]=[])}scheduleUpdateChunkPriorities(){null===this.updatePending&&(this.updatePending=setTimeout(this.recomputeChunkPriorities_.bind(this),0))}registerLayer(e){let t=this.recomputeChunkPriorities.count;e.chunkManagerGeneration!==t&&(e.chunkManagerGeneration=t,this.layers.push(e),e.numVisibleChunksAvailable=0,e.numVisibleChunksNeeded=0,e.numPrefetchChunksAvailable=0,e.numPrefetchChunksNeeded=0)}recomputeChunkPriorities_(){this.updatePending=null,this.layers.length=0,this.recomputeChunkPriorities.dispatch(),this.recomputeChunkPrioritiesLate.dispatch(),this.updateQueueState([q.VISIBLE,q.PREFETCH]),this.sendLayerChunkStatistics()}requestChunk(e,t,r,n=Y.GPU_MEMORY){if(Number.isNaN(r))return;if(t===q.RECENT)throw Error("Not going to request a chunk with the RECENT tier");e.newRequestedState=Math.min(e.newRequestedState,n),e.newPriorityTier===q.RECENT&&this.newTierChunks.push(e);let i=e.newPriorityTier;(t<i||t===i&&r>e.newPriority)&&(e.newPriorityTier=t,e.newPriority=r)}updateQueueState(e){let t=this.existingTierChunks,r=this.queueManager;for(let n of e){let e=t[n];for(let t of e)t.newPriorityTier===q.RECENT&&r.performChunkPriorityUpdate(t);e.length=0}let n=this.newTierChunks;for(let e of n)r.performChunkPriorityUpdate(e),t[e.priorityTier].push(e);n.length=0,this.queueManager.scheduleUpdate()}}function ey(e,t){var r;class n extends e{parameters;constructor(...e){super(...e);let t=e[1];this.parameters=t.parameters}}return ee([(r=t.RPC_ID,e=>{e.prototype.RPC_TYPE_ID=r})],n)}function em(e){return class extends e{chunkManager;constructor(...e){super(...e);let t=e[0],r=e[1];this.chunkManager=t.get(r.chunkManager)}}}ep=ee([F("ChunkManager")],ep),O("ChunkSource.invalidate",function(e){let t=this.get(e.id);t.chunkManager.queueManager.invalidateSourceCache(t)}),_("ChunkQueueManager.requestChunkStatistics",function(e){let t=this.get(e.queue),r=new Map;for(let e of t.sources)r.set(e.rpcId,e.statistics);return Promise.resolve({value:r})});class ev extends M.gj{}function eb(e){let t,r;return async(n,i)=>((void 0===r||void 0!==n&&t?.generation===n.generation)&&(t=void 0,r=(0,X.E7)(async r=>t=await e(n,r))),r(i??{}))}class ew extends M.gj{base;memoize;constructor(e){super(),this.base=e,this.memoize=new X.O1}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}}var eS=r(5898);function eE(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}class ek extends B{get=eb((e,t)=>this.rpc.promiseInvoke(eS.LD,{providerId:this.rpcId,invalidCredentials:e},{signal:t.signal,progressListener:t.progressListener}))}function eI(){return e=>class extends e{credentialsProvider;constructor(...e){super(...e);let t=e[1];this.credentialsProvider=this.rpc.getOptionalRef(t.credentialsProvider)}}}ek=eE([F(eS.yP)],ek);class eM extends ev{rpc;managerId;key;parameters;constructor(e,t,r,n){super(),this.rpc=e,this.managerId=t,this.key=r,this.parameters=n,this.get=eb((e,t)=>this.rpc.promiseInvoke(eS.Wd,{managerId:this.managerId,key:this.key,parameters:this.parameters,invalidCredentials:e},{signal:t.signal,progressListener:t.progressListener}))}get}class ex extends B{impl=new ew(this.makeBaseCredentialsManager());makeBaseCredentialsManager(){return{getCredentialsProvider:(e,t)=>new eM(this.rpc,this.rpcId,e,t)}}getCredentialsProvider(e,t){return this.impl.getCredentialsProvider(e,t)}}ex=eE([F(eS.Yn)],ex);var eT=r(8580),eC=r(9858),eN=r(6249);class e$ extends B{kvStoreContext;chunkManager;credentialsManager;constructor(e,t){super(e,t),this.chunkManager=e.get(t.chunkManager),this.credentialsManager=e.get(t.credentialsManager),this.kvStoreContext=new eT.e,eC.u.applyToContext(this),eR.applyToContext(this)}}e$=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F(eN.F0)],e$);let eR=new eC.X;function eP(e){return class extends e{sharedKvStoreContext;constructor(...e){super(...e);let t=e[1];this.sharedKvStoreContext=this.rpc.get(t.sharedKvStoreContext)}}}var eU=r(1395);class eO extends M.gj{view;state;constructor(e){super(),this.view=e,this.state=void 0}}class eA extends eg{attachments=new Map;attach(e){}}O(eU.ny,function(e){let t=this.get(e.view),r=this.get(e.layer),n=new eO(t);r.attachments.set(t,n),r.attach(n)}),O(eU.ti,function(e){let t=this.get(e.view),r=this.get(e.layer),n=r.attachments.get(t);r.attachments.delete(t),n.dispose()});class e_ extends B{value;oldValue;changed=new H.MZ;constructor(e,t){super(e,t),this.value=t.value,this.oldValue=Object.assign({},this.value)}}function eL(e,t,r,n=0,i=e.length){for(;n<i;){let s=n+i-1>>1,a=r(t,e[s]);if(a>0)n=s+1;else{if(!(a<0))return s;i=s}}return~n}function eD(e,t,r){let n=t-e;for(;n>0;){let t=Math.floor(n/2),i=e+t;r(i)?n=t:(e=i+1,n-=t+1)}return e}function ez(e,t){let r=e.length;if(t.length!==r)return!1;for(let n=0;n<r;++n)if(e[n]!==t[n])return!1;return!0}e_=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F(eU.rC)],e_),O(eU.uH,function(e){let t=this.get(e.id),{value:r,oldValue:n}=t;Object.assign(n,r),Object.assign(r,e.value),t.changed.dispatch(n,r)});var eB=r(3783),ej=r(290);let eF=[{prefix:"Y",exponent:24,longPrefix:"yotta"},{prefix:"Z",exponent:21,longPrefix:"zetta"},{prefix:"E",exponent:18,longPrefix:"exa"},{prefix:"P",exponent:15,longPrefix:"peta"},{prefix:"T",exponent:12,longPrefix:"tera"},{prefix:"G",exponent:9,longPrefix:"giga"},{prefix:"M",exponent:6,longPrefix:"mega"},{prefix:"k",exponent:3,longPrefix:"kilo"},{prefix:"",exponent:0,longPrefix:""},{prefix:"m",exponent:-3,longPrefix:"milli"},{prefix:"\xb5",exponent:-6,longPrefix:"micro"},{prefix:"n",exponent:-9,longPrefix:"nano"},{prefix:"p",exponent:-12,longPrefix:"pico"},{prefix:"f",exponent:-15,longPrefix:"femto"},{prefix:"a",exponent:-18,longPrefix:"atto"},{prefix:"z",exponent:-21,longPrefix:"zepto"},{prefix:"y",exponent:-24,longPrefix:"yocto"},{prefix:"h",exponent:2,longPrefix:"hecto"},{prefix:"da",exponent:1,longPrefix:"deca"},{prefix:"d",exponent:-1,longPrefix:"deci"},{prefix:"c",exponent:-2,longPrefix:"centi"}],eV=[{prefix:"u",exponent:-6},...eF],eG=new Map;eG.set("",{unit:"",exponent:0});let eK=new Map;for(let{prefix:e,exponent:t}of eV)for(let r of(eK.set(t,e),["m","s","Hz","rad/s"]))eG.set(`${e}${r}`,{unit:r,exponent:t});let eY=new Float32Array(0),eq=new Float64Array(0);function eJ(e){let{names:t,units:r,scales:n}=e,{valid:i=!0,rank:s=t.length,timestamps:a=t.map(()=>Number.NEGATIVE_INFINITY),ids:o=t.map((e,t)=>-t),boundingBoxes:l=[]}=e,{coordinateArrays:u=Array(s)}=e,{bounds:h=function(e,t){let r=new Float64Array(t),n=new Float64Array(t);r.fill(Number.NEGATIVE_INFINITY),n.fill(Number.POSITIVE_INFINITY);let i=Array(t);i.fill(0);let s=Array(t);for(let a of(s.fill(0),e))for(let e=0;e<t;++e){let o=function(e,t,r){let{box:{lowerBounds:n,upperBounds:i},transform:s}=e,a=n.length,o=s[r*a+t],l=o,u=o,h=!1;for(let e=0;e<a;++e){let a=s[r*e+t];if(0===a)continue;let o=a*n[e],c=a*i[e];l+=Math.min(o,c),u+=Math.max(o,c),h=!0}if(h)return{lower:l,upper:u}}(a,e,t);if(void 0===o)continue;let{lower:l,upper:u}=o;if(Number.isFinite(l)&&Number.isFinite(u)){let t,r,n,a;.001>Math.abs(l-(t=Math.round(l)))&&.001>Math.abs(u-(r=Math.round(u)))?(++s[e],l=t,u=r):.001>Math.abs(l-(n=Math.floor(l))-.5)&&.001>Math.abs(u-(a=Math.floor(u))-.5)&&(++i[e],l=n+.5,u=a+.5)}r[e]=r[e]===Number.NEGATIVE_INFINITY?l:Math.min(r[e],l),n[e]=n[e]===Number.POSITIVE_INFINITY?u:Math.max(n[e],u)}return{lowerBounds:r,upperBounds:n,voxelCenterAtIntegerCoordinates:s.map((e,t)=>i[t]>0&&0===e)}}(l,s)}=e;return{valid:i,rank:s,names:t,timestamps:a,ids:o,units:r,scales:n,boundingBoxes:l,bounds:h,coordinateArrays:u}}Float64Array.of(1,1,1);let eW=eJ({valid:!1,names:[],units:[],scales:eq,boundingBoxes:[]});eJ({valid:!0,names:[],units:[],scales:eq,boundingBoxes:[]}),k.SN;function eZ(e,t){let r=(e+t)/2;return Number.isFinite(r)||(r=Math.min(Math.max(0,e),t)),r}function eX(e,t=!1){if(t){let t=Number(e);if(Number.isInteger(t)&&t>=0)return!0}return null!==e.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)}new WeakMap;var eQ=r(5580);(h={})[h.LINKED=0]="LINKED",h[h.RELATIVE=1]="RELATIVE",h[h.UNLINKED=2]="UNLINKED",(c={})[c.LINKED=0]="LINKED",c[c.UNLINKED=2]="UNLINKED",eQ.B,eQ.B,eB.R3.create(),eB.gf.create();M.gj;var eH=((d={})[d.STOP=0]="STOP",d[d.LOOP=1]="LOOP",d[d.REVERSE=2]="REVERSE",d);class e0{velocity=10;atBoundary=2;paused=!0}function e1(e){return(0,ej.PT)(e),{velocity:(0,ej.Kh)(e,"velocity",ej.jz,10),atBoundary:(0,ej.Kh)(e,"atBoundary",e=>(0,ej.CT)(e,eH),0),paused:(0,ej.Kh)(e,"paused",ej.JG,!0)}}M.gj,M.gj,M.gj;class e2 extends M.gj{orientation;changed=new H.K_;constructor(e){super(),null==e&&(e=eB.gf.create()),this.orientation=e}toJSON(){let{orientation:e}=this;if(eB.gf.normalize(this.orientation,this.orientation),0!==e[0]||0!==e[1]||0!==e[2]||1!==e[3])return Array.prototype.slice.call(this.orientation)}restoreState(e){try{(0,ej._b)(this.orientation,e),eB.gf.normalize(this.orientation,this.orientation)}catch{eB.gf.identity(this.orientation)}this.changed.dispatch()}reset(){eB.gf.identity(this.orientation),this.changed.dispatch()}snap(){let e=eB.wO.create();eB.wO.fromQuat(e,this.orientation);let t=[!1,!1,!1];for(let r=0;r<3;++r){let n=0,i=0;for(let s=0;s<3;++s){let a=e[3*r+s];e[3*r+s]=0,!t[s]&&Math.abs(a)>Math.abs(n)&&(n=a,i=s)}e[3*r+i]=Math.sign(n),t[i]=!0}eB.gf.fromMat3(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let r=new e2(eB.gf.multiply(eB.gf.create(),e.orientation,t)),n=!1;r.registerDisposer(e.changed.add(()=>{n||(i=!0,eB.gf.multiply(r.orientation,e.orientation,t),r.changed.dispatch(),i=!1)}));let i=!1,s=eB.gf.invert(eB.gf.create(),t);return r.registerDisposer(r.changed.add(()=>{i||(n=!0,eB.gf.multiply(e.orientation,r.orientation,s),e.changed.dispatch(),n=!1)})),r}assign(e){eB.gf.copy(this.orientation,e.orientation),this.changed.dispatch()}}M.gj;function e3(e,t){var r,n;let i=e.displayDimensionRenderInfo;return i===t||(r=i,n=t,!!(ez(r.globalDimensionNames,n.globalDimensionNames)&&ez(r.displayDimensionIndices,n.displayDimensionIndices)&&ez(r.canonicalVoxelFactors,n.canonicalVoxelFactors)&&ez(r.voxelPhysicalScales,n.voxelPhysicalScales)&&r.canonicalVoxelPhysicalSize===n.canonicalVoxelPhysicalSize&&ez(r.displayDimensionUnits,n.displayDimensionUnits)&&ez(r.displayDimensionScales,n.displayDimensionScales))&&(e.displayDimensionRenderInfo=t,!0))}M.gj,M.gj,M.gj,M.gj,M.gj,M.gj;var e6=r(2902);r(5901);var e4=r(4186);r(9652);class e8{width=0;height=0;logicalWidth=0;logicalHeight=0;visibleLeftFraction=0;visibleTopFraction=0;visibleWidthFraction=0;visibleHeightFraction=0}M.gj,k.TU,M.gj,new Uint32Array(0),new Uint32Array(0);var e5=r(9023),e9=((f={})[f.UINT8=0]="UINT8",f[f.INT8=1]="INT8",f[f.UINT16=2]="UINT16",f[f.INT16=3]="INT16",f[f.UINT32=4]="UINT32",f[f.INT32=5]="INT32",f[f.UINT64=6]="UINT64",f[f.FLOAT32=7]="FLOAT32",f);let e7={0:1,1:1,2:2,3:2,4:4,5:4,6:8,7:4},te={0:Uint8Array,1:Int8Array,2:Uint16Array,3:Int16Array,4:Uint32Array,5:Int32Array,6:BigUint64Array,7:Float32Array};function tt(e,t,r=0,n=t.byteLength){let i=e7[e];return new te[e](t,r,n/i)}let tr=eB._E.create();function tn(e,t,r){let{curPositionInChunks:n,fixedPositionWithinChunk:i}=e,{nonDisplayLowerClipBound:s,nonDisplayUpperClipBound:a}=e,{rank:o,chunkDataSize:l,lowerChunkBound:u,upperChunkBound:h}=e.source.spec;if(!function(e,t,r,n,i){let s=t.length,a=r.length,o=e.length,l=!0;for(let u=0;u<n;++u){let h=u,c=0;for(let e=0;e<s;++e)c+=i[h+e*n]*t[e];h+=s*n;for(let e=0;e<a;++e)c+=i[h+e*n]*r[e];c+=i[h+a*n],u<o?e[u]=c:(c<0||c>=1)&&(l=!1)}return l}(n,t,r,e.layerRank,e.fixedLayerToChunkTransform))return!1;for(let e=0;e<o;++e){let t=n[e];if(t<s[e]-.001||t>a[e]+.001)return!1;let r=l[e],o=n[e]=Math.min(h[e]-1,Math.max(u[e],Math.floor(t/r)));i[e]=t-o*r}return!0}let ti=new e5.d(eB.R3.create(),eB._E.create(),0);class ts extends D{projectionParameters;visibleLayers;visibleSourcesStale;constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new Map,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((e,t)=>{(function(e,t){if(e.displayDimensionRenderInfo!==t.displayDimensionRenderInfo||e.pixelSize!==t.pixelSize)return!0;let{viewMatrix:r}=e,{viewMatrix:n}=t;for(let e=0;e<12;++e)if(r[e]!==n[e])return!0;return!1})(e,t)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;let e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(let[r,n]of t){let{allSources:t,visibleSources:i}=n;if(i.length=0,0===t.length||!e3(n,e))continue;let s=function(e,t){let r=t.length,n=0;if(r>1){let i=0;for(let s=0;s<r;++s){let{chunkLayout:r}=t[s],a=function(e,t){let r=0,n=Math.abs(e.detTransform),{transform:i,size:s}=e;for(let e=0;e<3;++e){let a=0;for(let r=0;r<3;++r)a+=t[4*r+2]*i[4*e+r];let o=s[e];r+=Math.abs(a)*o,n*=o}return n/r}(r,e);a>i&&(i=a,n=s)}}return n}(this.projectionParameters.value.viewMatrix,t.map(e=>e[0])),a=t[s];for(let e of r.filterVisibleSources(this,a))i.push(e);i.reverse()}}}let ta=new Float32Array(3),to=new Float32Array(3),tl=eB._E.create(),tu=new Float32Array(24);function th(e,t,r,n){let{lowerChunkDisplayBound:i,upperChunkDisplayBound:s}=t;for(let e=0;e<3;++e)ta[e]=Math.max(ta[e],i[e]),to[e]=Math.min(to[e],s[e]);let{curPositionInChunks:a,chunkDisplayDimensionIndices:o}=t;!function t(){if(!n(ta[0],ta[1],ta[2],to[0],to[1],to[2],e))return;let i=0,s=Math.max(0,to[0]-ta[0]),l=s;for(let e=1;e<3;++e){let t=Math.max(0,to[e]-ta[e]);l*=t,t>s&&(s=t,i=e)}if(0===l)return;if(1===l){a[o[0]]=ta[0],a[o[1]]=ta[1],a[o[2]]=ta[2],r(ta,e);return}let u=ta[i],h=to[i],c=Math.floor(.5*(u+h));to[i]=c,t(),to[i]=h,ta[i]=c,t(),ta[i]=u}()}function tc(e,t,r,n){if(!tn(r,e.globalPosition,t))return;let{size:i}=r.chunkLayout,s=eB._E.multiply(tl,e.viewProjectionMat,r.chunkLayout.transform);for(let e=0;e<3;++e){let t=i[e];for(let r=0;r<4;++r)s[4*e+r]*=t}(0,eB.th)(tu,s),ta.fill(Number.NEGATIVE_INFINITY),to.fill(Number.POSITIVE_INFINITY),th(tu,r,n,eB.Rq)}function td(e,t,r,n,i){if(!tn(r,e.globalPosition,t))return;let{size:s}=n,a=eB._E.multiply(tl,e.viewProjectionMat,n.transform);for(let e=0;e<3;++e){let t=s[e];for(let r=0;r<4;++r)a[4*e+r]*=t}let{upperChunkDisplayBound:o}=r;eB._E.invert(tr,a);for(let e=0;e<3;++e){let t=tr[12+e]+1e-4/s[e],r=Math.abs(tr[e]),n=Math.abs(tr[4+e]),i=o[e],a=t-r-n;a=a>=i&&a<i+.001?i-1:Math.floor(a),ta[e]=a,to[e]=Math.floor(t+r+n+1)}for(let e=0;e<3;++e){let t=a[4*e],r=a[4*e+1],n=a[4*e+2];tu[e]=t,tu[4+e]=-t,tu[8+e]=+r,tu[12+e]=-r,tu[16+e]=+n,tu[20+e]=-n}{let e=a[12],t=a[13],r=a[14];tu[3]=1+e,tu[7]=1-e,tu[11]=1+t,tu[15]=1-t,tu[19]=r,tu[23]=-r}th(tu,r,i,eB.iG)}function tf(e,t){let{finiteRank:r}=t;if(3===r)return t;ti.finiteRank=r,eB.R3.copy(ti.size,t.size);let n=eB._E.copy(ti.transform,t.transform),i=eB._E.copy(ti.invTransform,t.invTransform);ti.detTransform=t.detTransform;let{invViewMatrix:s,width:a,height:o}=e,l=(0,eB.V2)(e.projectionMat);for(let e=r;e<3;++e){let t=s[12+e],r=t,i=t,u=Math.abs(s[e]*a);r-=u,i+=u;let h=Math.abs(s[e+4]*o);r-=h,i+=h;let c=Math.abs(s[e+8]*l);r-=c;let d=Math.max(1,(i+=c)-r);n[12+e]=r,n[5*e]=d}return eB._E.invert(i,n),ti}class tg{velocityHalfLifeMilliseconds;modelHalfLifeMilliseconds;lastTime;rank;numSamples;prevPosition;velocity;mean;variance;constructor(e=50,t=1e3){this.velocityHalfLifeMilliseconds=e,this.modelHalfLifeMilliseconds=t,this.lastTime=Number.NEGATIVE_INFINITY,this.rank=0,this.numSamples=0,this.prevPosition=new Float32Array,this.velocity=new Float32Array,this.mean=new Float32Array,this.variance=new Float32Array}reset(e){this.lastTime=Number.NEGATIVE_INFINITY,this.rank=e,this.numSamples=0,this.velocity=new Float32Array(e),this.prevPosition=new Float32Array(e),this.mean=new Float32Array(e),this.variance=new Float32Array(e)}addSample(e,t=Date.now()){let r=e.length;r!==this.rank&&this.reset(r);let n=this.numSamples;if(++this.numSamples,0===this.numSamples){this.prevPosition.set(e),this.lastTime=t;return}let i=t-this.lastTime;this.lastTime=t;let s=1-2**-(i/this.velocityHalfLifeMilliseconds),a=1-2**-(i/this.modelHalfLifeMilliseconds),{velocity:o,prevPosition:l,mean:u,variance:h}=this;for(let t=0;t<r;++t){let r=(e[t]-l[t])/Math.max(i,1);l[t]=e[t];let c=o[t],d=o[t]=c+s*(r-c);if(1===n)u[t]=d;else{let e=u[t],r=h[t],n=d-e;u[t]=e+a*n,h[t]=(1-a)*(r+a*n*n)}}}}function tp(e){return class extends e{visibility;constructor(...e){super(...e);let t=e[0],r=e[1];this.visibility=t.get(r.visibility),this.registerDisposer(this.visibility.changed.add(()=>this.chunkManager.scheduleUpdateChunkPriorities()))}}}function ty(e){return e===Number.POSITIVE_INFINITY?q.VISIBLE:q.PREFETCH}function tm(e){return e===Number.POSITIVE_INFINITY?0:1e13*e}function tv(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}let tb=eB.R3.create(),tw=eB.R3.create(),tS=eB.R3.create();function tE(e){for(let t of e)for(let e of t)e.source.dispose()}let tk=tp(em(class extends ts{constructor(e,t){super(e.get(t.projectionParameters)),this.initializeSharedObject(e,t.id)}}));class tI extends tk{velocityEstimator=new tg;constructor(e,t){super(e,t),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateVisibleChunks()})),this.registerDisposer(this.projectionParameters.changed.add(()=>{this.velocityEstimator.addSample(this.projectionParameters.value.globalPosition)}))}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.chunkManager.scheduleUpdateChunkPriorities()}handleLayerChanged=()=>{this.chunkManager.scheduleUpdateChunkPriorities()};updateVisibleChunks(){let e=this.projectionParameters.value,t=this.chunkManager,r=this.visibility.value;if(r===Number.NEGATIVE_INFINITY)return;this.updateVisibleSources();let{centerDataPosition:n}=e,i=ty(r),s=tm(r);s+=-1e12;let a=[];for(let[r,o]of(this.velocityEstimator.addSample(this.projectionParameters.value.globalPosition),this.visibleLayers)){t.registerLayer(r);let{visibleSources:l}=o;for(let o=0,u=l.length;o<u;++o){let u=l[o],h=t.queueManager.enablePrefetch.value?function(e,t){let r=[],n=e.rank,{combinedGlobalLocalToChunkTransform:i,layerRank:s}=t,{rank:a,chunkDataSize:o}=t.source.spec,{mean:l,variance:u}=e;for(let e=0;e<a;++e){let a=t.chunkDisplayDimensionIndices.includes(e),h=0,c=0;for(let t=0;t<n;++t){let r=l[t],n=u[t],a=i[t*s+e];h+=a*r,c+=a*a*n}if(h>.1)continue;let d=o[e],f=a?0:t.fixedPositionWithinChunk[e]/d,g=h/d*2e3,p=Math.sqrt(2*c)/d*2e3;if(.001>Math.abs(g)&&p<.001)continue;p=Math.max(1e-6,p);let y=e=>.5*(1+function(e){let t=1/(1+.3275911*Math.abs(e)),r=1-((((1.061405429*t+-1.453152027)*t+1.421413741)*t+-.284496736)*t+.254829592)*t*Math.exp(-e*e);return Math.sign(e)*r}((e-g)/p)),m=t.curPositionInChunks[e],v=Math.floor(t.lowerClipBound[e]/d),b=Math.ceil(t.upperClipBound[e]/d)-1,w=r.length;for(let t=1;t<=32&&(a||!(m+t>b));++t){let n=1-y(t-f);if(n<.05)break;r.push(e,t,v,b,n,0)}let S=r.length;for(let e=w,t=r.length;e<t;e+=tN)r[e+tN-1]=S;w=S;for(let t=1;t<=32&&(a||!(m-t<v));++t){let n=y(-t+1-f);if(n<.05)break;r.push(e,-t,v,b,n,0)}S=r.length;for(let e=w,t=r.length;e<t;e+=tN)r[e+tN-1]=S}return r}(this.velocityEstimator,u):[],{chunkLayout:c}=u;c.globalToLocalSpatial(tw,n);let{size:d,finiteRank:f}=c;eB.R3.copy(tS,d);for(let e=f;e<3;++e)tS[e]=0,tw[e]=0;let g=s+1e9*o;a.length=0;let p=++et;if(td(e,u.renderLayer.localPosition.value,u,tf(e,u.chunkLayout),e=>{eB.R3.multiply(tb,e,tS);let n=-eB.R3.distance(tw,tb),{curPositionInChunks:s}=u,o=u.source.getChunk(s);t.requestChunk(o,i,g+n),++r.numVisibleChunksNeeded,o.state===Y.GPU_MEMORY&&++r.numVisibleChunksAvailable,a.push(o),o.markGeneration=p}),0!==h.length){let{curPositionInChunks:e}=u;for(let n of a){e.set(n.chunkGridPosition);for(let n=0,i=h.length;n<i;){let i=h[n],s=h[n+2],a=h[n+3],o=h[n+4],l=h[n+5],c=e[i],d=c+h[n+1];if(d<s||d>a){n=l;continue}e[i]=d;let f=u.source.getChunk(e);if(e[i]=c,f.markGeneration===p){n=l;continue}t.requestChunk(f,q.PREFETCH,g+o),++r.numPrefetchChunksNeeded,f.state===Y.GPU_MEMORY&&++r.numPrefetchChunksAvailable,n+=tN}}}}}}removeVisibleLayer(e){let{visibleLayers:t}=this,r=t.get(e);t.delete(e),tE(r.allSources),e.renderScaleTarget.changed.remove(this.invalidateVisibleSources),e.localPosition.changed.remove(this.handleLayerChanged),this.invalidateVisibleSources()}addVisibleLayer(e,t,r){let n=this.visibleLayers.get(e);void 0===n?(n={allSources:t,visibleSources:[],displayDimensionRenderInfo:r},this.visibleLayers.set(e,n),e.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()),e.localPosition.changed.add(this.handleLayerChanged)):(tE(n.allSources),n.allSources=t,n.visibleSources.length=0,n.displayDimensionRenderInfo=r),this.invalidateVisibleSources()}disposed(){for(let e of this.visibleLayers.keys())this.removeVisibleLayer(e);super.disposed()}invalidateVisibleSources(){super.invalidateVisibleSources(),this.chunkManager.scheduleUpdateChunkPriorities()}}function tM(e,t,r){return t.map(t=>t.map(t=>{let n=e.getRef(t.source),i=t.chunkLayout,{rank:s}=n.spec;return{renderLayer:r,source:n,chunkLayout:e5.d.fromObject(i),layerRank:t.layerRank,nonDisplayLowerClipBound:t.nonDisplayLowerClipBound,nonDisplayUpperClipBound:t.nonDisplayUpperClipBound,lowerClipBound:t.lowerClipBound,upperClipBound:t.upperClipBound,lowerClipDisplayBound:t.lowerClipDisplayBound,upperClipDisplayBound:t.upperClipDisplayBound,lowerChunkDisplayBound:t.lowerChunkDisplayBound,upperChunkDisplayBound:t.upperChunkDisplayBound,effectiveVoxelSize:t.effectiveVoxelSize,chunkDisplayDimensionIndices:t.chunkDisplayDimensionIndices,fixedLayerToChunkTransform:t.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:t.combinedGlobalLocalToChunkTransform,curPositionInChunks:new Float32Array(s),fixedPositionWithinChunk:new Uint32Array(s)}}))}tI=tv([F("SliceView")],tI),O("SliceView.addVisibleLayer",function(e){let t=this.get(e.id),r=this.get(e.layerId),n=tM(this,e.sources,r);t.addVisibleLayer(r,n,e.displayDimensionRenderInfo)}),O("SliceView.removeVisibleLayer",function(e){let t=this.get(e.id),r=this.get(e.layerId);t.removeVisibleLayer(r)});class tx extends er{chunkGridPosition;source=null;initializeVolumeChunk(e,t){super.initialize(e),this.chunkGridPosition=Float32Array.from(t)}serialize(e,t){super.serialize(e,t),e.chunkGridPosition=this.chunkGridPosition}downloadSucceeded(){super.downloadSucceeded()}freeSystemMemory(){}toString(){return this.source.toString()+":"+(0,eB.m0)(this.chunkGridPosition)}}class tT extends es{spec;constructor(e,t){super(e,t),this.spec=t.spec}getChunk(e){let t=e.join(),r=this.chunks.get(t);return void 0===r&&((r=this.getNewChunk_(this.chunkConstructor)).initializeVolumeChunk(t,e),this.addChunk(r)),r}}class tC extends B{renderScaleTarget;localPosition;numVisibleChunksNeeded;numVisibleChunksAvailable;numPrefetchChunksNeeded;numPrefetchChunksAvailable;chunkManagerGeneration;constructor(e,t){super(e,t),this.renderScaleTarget=e.get(t.renderScaleTarget),this.localPosition=e.get(t.localPosition),this.numVisibleChunksNeeded=0,this.numVisibleChunksAvailable=0,this.numPrefetchChunksAvailable=0,this.numPrefetchChunksNeeded=0,this.chunkManagerGeneration=-1}filterVisibleSources(e,t){return function*(e,t,r){let n;let i=1.1*e.projectionParameters.value.pixelSize,s=r[0].effectiveVoxelSize,a=t.renderScaleTarget.value,o=e=>{let t=i*a;for(let r=0;r<3;++r){let n=e[r];if(n>t&&n>1.01*s[r])return!0}return!1},l=(e,t)=>{let r=i*a;for(let n=0;n<3;++n){let i=e[n],s=t[n];if(Math.abs(r-i)<Math.abs(r-s)&&i<1.01*s)return!0}return!1},u=r.length-1;for(;;){let e=r[u];if(void 0!==n&&!l(e.effectiveVoxelSize,n)||(yield e,0===u||!o(e.effectiveVoxelSize)))break;n=e.effectiveVoxelSize,--u}}(e,this,t)}}tC=tv([F("sliceview/RenderLayer")],tC);let tN=6;_("ChunkManager.requestChunk",async function(e,t){let r;let n=this.get(e.source),{chunkManager:i}=n,s=n.getChunk(e.chunkGridPosition),a=s.key;if(s.state<=Y.SYSTEM_MEMORY)return{value:void 0};if(s.state===Y.FAILED)throw s.error;let o=i.recomputeChunkPriorities.add(()=>{i.requestChunk(s,q.VISIBLE,Number.POSITIVE_INFINITY,Y.SYSTEM_MEMORY)});i.scheduleUpdateChunkPriorities();let l=new Promise((e,t)=>{r=r=>{if(r.state===Y.FAILED){t(r.error);return}r.state<=Y.SYSTEM_MEMORY&&e()}});n.registerChunkListener(a,r);try{return await (0,I.oi)(l,t.signal),{value:void 0}}finally{n.unregisterChunkListener(a,r),o(),i.scheduleUpdateChunkPriorities()}});var t$=r(9443);class tR extends B{visibility;projectionParameters;constructor(...e){super(...e);let t=e[0],r=e[1];this.visibility=t.get(r.visibility),this.projectionParameters=t.get(r.projectionParameters)}}tR=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F(t$.w)],tR);class tP extends eA{}let tU=eB.wO.create(),tO=eB.R3.create(),tA=eB.R3.create(),t_=eB.R3.create(),tL=eB.R3.create();class tD extends em(eA){localPosition;renderScaleTarget;constructor(e,t){super(e,t),this.renderScaleTarget=e.get(t.renderScaleTarget),this.localPosition=e.get(t.localPosition);let r=()=>this.chunkManager.scheduleUpdateChunkPriorities();this.registerDisposer(this.localPosition.changed.add(r)),this.registerDisposer(this.renderScaleTarget.changed.add(r)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>this.recomputeChunkPriorities()))}attach(e){let t=()=>this.chunkManager.scheduleUpdateChunkPriorities(),{view:r}=e;e.registerDisposer(t),e.registerDisposer(r.projectionParameters.changed.add(t)),e.registerDisposer(r.visibility.changed.add(t)),e.state={displayDimensionRenderInfo:r.projectionParameters.value.displayDimensionRenderInfo,transformedSources:[]}}recomputeChunkPriorities(){for(let e of this.attachments.values()){let t;let{view:r}=e,n=r.visibility.value;if(n===Number.NEGATIVE_INFINITY)continue;let i=e.state,{transformedSources:s}=i;if(0===s.length||!e3(i,r.projectionParameters.value.displayDimensionRenderInfo))continue;let a=r.projectionParameters.value,o=ty(n),l=tm(n);l+=-1e12;let{globalPosition:u,displayDimensionRenderInfo:{displayDimensionIndices:h}}=a;for(let e=0;e<3;++e){let t=h[e];tL[e]=-1===t?0:u[t]}let{chunkManager:c}=this;c.registerLayer(this),function(e,t,r,n,i,s){if(0===n.length)return;let{viewMatrix:a,projectionMat:o,displayDimensionRenderInfo:l}=e,{voxelPhysicalScales:u}=l,h=(0,eB.n_)(u),c=(0,eB.V2)(o),d=(c/r)**3,f=eB.wO.determinant((0,eB.bZ)(tU,a)),g={spatialScales:new Map,activeIndex:-1},p=e=>Math.abs(n[e].chunkLayout.detTransform*f),y=n.length-1,m=p(y);for(let e=y;e>=0;--e){let t=p(e),r=Math.cbrt(t*h/f),n=c/Math.cbrt(t);g.spatialScales.set(r,n),t-d>=0&&(m=t,y=e),g.activeIndex=y}let v=Math.cbrt(m*h/f),b=c/Math.cbrt(m),w=!0,S=n[y];tc(e,t,S,(e,t)=>{w&&(i(S,y,v,b,t,g),w=!1),s(S,y,e)})}(a,this.localPosition.value,this.renderScaleTarget.value,s[0],(e,r)=>{let{chunkLayout:n}=e;n.globalToLocalSpatial(tA,tL);let{size:i,finiteRank:a}=n;eB.R3.copy(t_,i);for(let e=a;e<3;++e)t_[e]=0,tA[e]=0;let o=s[0].length-1-r;t=l+1e9*o},(e,r,n)=>{eB.R3.multiply(tO,n,t_);let i=-eB.R3.distance(tA,tO),s=e.source.getChunk(e.curPositionInChunks);++this.numVisibleChunksNeeded,c.requestChunk(s,o,t+i),s.state===Y.GPU_MEMORY&&++this.numVisibleChunksAvailable})}}}tD=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F("volume_rendering/VolumeRenderingRenderLayer")],tD),O("volume_rendering/VolumeRenderingRenderLayer/update",function(e){let t=this.get(e.view),r=this.get(e.layer),n=r.attachments.get(t);n.state.transformedSources=tM(this,e.sources,r),n.state.displayDimensionRenderInfo=e.displayDimensionRenderInfo,r.chunkManager.scheduleUpdateChunkPriorities()});let tz="annotation.commit",tB=eB.wO.create();var tj=r(658);let tF="DisjointUint64Sets.add",tV="DisjointUint64Sets.clear",tG="DisjointUint64Sets.highBitRepresentativeChanged",tK="DisjointUint64Sets.deleteSet";class tY extends B{disjointSets=new tj.D;changed=new H.K_;get value(){return this}static makeWithCounterpart(e,t){let r=new tY;return r.disjointSets.visibleSegmentEquivalencePolicy=t,r.registerDisposer(t.changed.add(()=>{tq(r)})),r.initializeCounterpart(e),t.value&&tq(r),r}link(e,t){if(this.disjointSets.link(e,t)){let{rpc:r}=this;return r&&r.invoke(tF,{id:this.rpcId,a:e,b:t}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,r=e.length;t<r;++t)this.link(e[0],e[t])}has(e){return this.disjointSets.has(e)}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let{rpc:e}=this;e&&e.invoke(tV,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let{rpc:t}=this;t&&t.invoke(tK,{id:this.rpcId,x:e}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){void 0!==e&&(0,ej.m7)(e,e=>{let t;(0,ej.m7)(e,e=>{let r=(0,ej.tw)(e);void 0!==t&&this.link(t,r),t=r})})}assignFrom(e){for(let[t,r]of(this.clear(),e instanceof tY&&(e=e.disjointSets),e))this.link(t,r)}}function tq(e){e.rpc.invoke(tG,{id:e.rpcId,value:e.disjointSets.visibleSegmentEquivalencePolicy.value})}tY=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F("DisjointUint64Sets")],tY),O(tF,function(e){let t=this.get(e.id);t.disjointSets.link(e.a,e.b)&&t.changed.dispatch()}),O(tV,function(e){let t=this.get(e.id);t.disjointSets.clear()&&t.changed.dispatch()}),O(tG,function(e){this.get(e.id).disjointSets.visibleSegmentEquivalencePolicy.value=e.value}),O(tK,function(e){let t=this.get(e.id);t.disjointSets.deleteSet(e.x)&&t.changed.dispatch()});var tJ=r(1425),tW=r(686),tZ=r(6224);let tX=0n,tQ=0n;class tH{hashSeeds;loadFactor;size;table;tableSize;empty;maxRehashAttempts;maxAttempts;capacity;generation;mungedEmptyKey;constructor(e=tH.generateHashSeeds(3)){this.hashSeeds=e,this.loadFactor=.8,this.size=0,this.empty=0xffffffffffffffffn,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=tH.generateHashSeeds(e),this.mungedEmptyKey=void 0}tableWithMungedEmptyKey(e){let t=this.hashSeeds.length,r=Array(t);for(let e=0;e<t;++e)r[e]=this.getHash(e,this.empty);let{mungedEmptyKey:n}=this;if(void 0===n)e:for(;;){n=(0,tW.ff)();for(let e=0;e<t;++e){let i=this.getHash(e,n);for(let e=0;e<t;++e)if(r[e]===i)continue e}this.mungedEmptyKey=n;break}let{table:i,empty:s}=this;for(let e=0;e<t;++e){let t=r[e];i[t]===s&&(i[t]=n)}try{e(i)}finally{for(let e=0;e<t;++e){let t=r[e];i[t]===n&&(i[t]=s)}}}static generateHashSeeds(e=3){return(0,tZ.PP)(new Uint32Array(e))}getHash(e,t){let r=this.hashSeeds[e];return r=(0,tJ.B)(r,Number(4294967295n&t)),r=(0,tJ.B)(r,Number(t>>32n)),this.entryStride*(r&this.tableSize-1)}*keys(){let{empty:e,entryStride:t}=this,{table:r}=this;for(let n=0,i=r.length;n<i;n+=t){let t=r[n];t!==e&&(yield t)}}indexOf(e){let{table:t,empty:r}=this;if(e===r)return -1;for(let r=0,n=this.hashSeeds.length;r<n;++r){let n=this.getHash(r,e);if(t[n]===e)return n}return -1}chooseAnotherEmptyKey(){let e;let{empty:t,table:r,entryStride:n}=this;for(;(e=(0,tW.ff)())===t||this.has(e););this.empty=e;for(let i=0,s=r.length;i<s;i+=n)r[i]===t&&(r[i]=e)}has(e){return -1!==this.indexOf(e)}delete(e){let t=this.indexOf(e);if(-1!==t){let{table:e}=this;return e[t]=this.empty,++this.generation,this.size--,!0}return!1}clearTable(){let{table:e,empty:t}=this;e.fill(t)}clear(){return 0!==this.size&&(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity&&(this.backupPending(),this.grow(e),this.restorePending(),!0)}swapPending(e,t){let r=tX;this.storePending(e,t),e[t]=r}storePending(e,t){tX=e[t]}backupPending(){tQ=tX}restorePending(){tX=tQ}tryToInsert(){let e=0,{empty:t,maxAttempts:r,table:n}=this,i=this.hashSeeds.length,s=Math.floor(Math.random()*i);for(;;){let a=this.getHash(s,tX);if(this.swapPending(n,a),tX===t)return!0;if(++e===r)break;s=(s+Math.floor(Math.random()*(i-1))+1)%i}return!1}allocate(e){this.tableSize=e;let{entryStride:t}=this;this.table=new BigUint64Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=void 0}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let{empty:r,entryStride:n}=this;for(let t=0,i=e.length;t<i;t+=n)if(e[t]!==r&&(this.storePending(e,t),!this.tryToInsert()))return!1;return!0}grow(e){let t=this.table,{tableSize:r}=this;for(;r<e;)r*=2;for(;;){for(let e=0;e<this.maxRehashAttempts;++e)if(this.rehash(t,r))return;r*=2}}insertInternal(){for(++this.generation,tX===this.empty&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(2*this.tableSize),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class t0 extends tH{add(e){return!this.has(e)&&(tX=e,this.insertInternal(),!0)}[Symbol.iterator](){return this.keys()}}t0.prototype.entryStride=1;let t1=0n,t2=0n;class t3 extends tH{set(e,t){return!this.has(e)&&(tX=e,t1=t,this.insertInternal(),!0)}get(e){let t=this.indexOf(e);if(-1!==t)return this.table[t+1]}swapPending(e,t){let r=t1;super.swapPending(e,t),e[t+1]=r}storePending(e,t){super.storePending(e,t),t1=e[t+1]}backupPending(){super.backupPending(),t2=t1}restorePending(){super.restorePending(),t1=t2}[Symbol.iterator](){return this.entries()}*entries(){let{empty:e,entryStride:t}=this,{table:r}=this;for(let n=0,i=r.length;n<i;n+=t){let t=r[n];if(t!==e){let e=r[n+1];yield[t,e]}}}}t3.prototype.entryStride=2;class t6 extends B{hashTable=new t3;changed=new H.MZ;get value(){return this}static makeWithCounterpart(e){let t=new t6;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let{rpc:r}=this;r&&r.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e){return this.hashTable.get(e)}[Symbol.iterator](){return this.hashTable.entries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){for(let[t,r]of(this.clear(),e))this.set(t,r)}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let[t,r]of this.hashTable.entries())e[t.toString()]=r.toString();return e}}t6=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F("Uint64Map")],t6),O("Uint64Map.set",function(e){let t=this.get(e.id);t.set_(e.key,e.value)&&t.changed.dispatch()}),O("Uint64Map.delete",function(e){let t=this.get(e.id);t.delete_(e.key)&&t.changed.dispatch()}),O("Uint64Map.clear",function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()});class t4 extends B{hashTable=new t0;changed=new H.MZ;get value(){return this}static makeWithCounterpart(e){let t=new t4;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}reserve_(e){return this.hashTable.reserve(e)}reserve(e){if(this.reserve_(e)){let{rpc:t}=this;t&&t.invoke("Uint64Set.reserve",{id:this.rpcId,value:e})}}add_(e){let t=!1;for(let r of e)t=this.hashTable.add(r)||t;return t}add(e){let t="bigint"==typeof e?[e]:e;if(this.add_(t)){let{rpc:r}=this;r&&r.invoke("Uint64Set.add",{id:this.rpcId,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[Symbol.iterator](){return this.hashTable.keys()}keys(){return this.hashTable.keys()}delete_(e){let t=!1;for(let r of e)t=this.hashTable.delete(r)||t;return t}delete(e){let t="bigint"==typeof e?[e]:e;if(this.delete_(t)){let{rpc:r}=this;r&&r.invoke("Uint64Set.delete",{id:this.rpcId,value:t}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let{rpc:e}=this;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=[];for(let t of this.keys())e.push(t.toString());return e.sort(),e}assignFrom(e){for(let t of(this.clear(),e.keys()))this.add(t)}}t4=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F("Uint64Set")],t4),O("Uint64Set.reserve",function(e){let t=this.get(e.id);t.reserve_(e.value)&&t.changed.dispatch()}),O("Uint64Set.add",function(e){let t=this.get(e.id);t.add_(e.value)&&t.changed.dispatch()}),O("Uint64Set.delete",function(e){let t=this.get(e.id);t.delete_(e.value)&&t.changed.dispatch()}),O("Uint64Set.clear",function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()});var t8=r(4066);let t5=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function t9(e,t,r){e.registerDisposer(t.visibleSegments.changed.add(r)),e.registerDisposer(t.segmentEquivalences.changed.add(r))}function t7(e,t,r){e.registerDisposer(t.temporaryVisibleSegments.changed.add(r)),e.registerDisposer(t.temporarySegmentEquivalences.changed.add(r)),e.registerDisposer(t.useTemporaryVisibleSegments.changed.add(r)),e.registerDisposer(t.useTemporarySegmentEquivalences.changed.add(r))}function re(e){return e.toString()}function rt(e,t){let r=e.useTemporaryVisibleSegments.value?e.temporaryVisibleSegments:e.visibleSegments,n=e.useTemporarySegmentEquivalences.value?e.temporarySegmentEquivalences:e.segmentEquivalences,i=n.disjointSets.visibleSegmentEquivalencePolicy.value;for(let e of r.keys())if(i&t8.BA.NONREPRESENTATIVE_EXCLUDED){let r=n.get(e);t(e,r)}else{if(!n.disjointSets.isMinElement(e))continue;for(let r of n.setElements(e))(!(i&t8.BA.REPRESENTATIVE_EXCLUDED)||!(i&t8.BA.MAX_REPRESENTATIVE)||(0x8000000000000000n&r)===0n)&&t(r,e)}}function rr(e,t,r={}){for(let n of t5)r[n]=e.get(t[n]);return r}let rn=e=>class extends e{visibleSegments;selectedSegments;segmentEquivalences;temporaryVisibleSegments;temporarySegmentEquivalences;useTemporaryVisibleSegments;useTemporarySegmentEquivalences;transform;renderScaleTarget;constructor(...e){let[t,r]=e;super(t,r),rr(t,r,this),this.transform=t.get(r.transform),this.renderScaleTarget=t.get(r.renderScaleTarget);let n=()=>{this.chunkManager.scheduleUpdateChunkPriorities()};t7(this,this,n),t9(this,this,n),this.registerDisposer(this.transform.changed.add(n)),this.registerDisposer(this.renderScaleTarget.changed.add(n))}};function ri(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}class rs extends er{annotation;freeSystemMemory(){this.annotation=void 0}serialize(e,t){super.serialize(e,t),e.annotation=this.annotation}downloadSucceeded(){this.systemMemoryBytes=this.gpuMemoryBytes=0,super.downloadSucceeded()}}class ra{data;typeToOffset;typeToIds;typeToIdMaps;serialize(e,t){e.data=this.data,e.typeToOffset=this.typeToOffset,e.typeToIds=this.typeToIds,e.typeToIdMaps=this.typeToIdMaps,t.push(this.data.buffer)}get numBytes(){return this.data.byteLength}}function ro(e){return class extends e{data;serialize(e,t){super.serialize(e,t);let{data:r}=this;void 0!==r&&(r.serialize(e,t),this.data=void 0)}downloadSucceeded(){let{data:e}=this;this.systemMemoryBytes=this.gpuMemoryBytes=void 0===e?0:e.numBytes,super.downloadSucceeded()}freeSystemMemory(){this.data=void 0}}}class rl extends ro(tx){}class ru extends ro(er){objectId}class rh extends es{parent=void 0;getChunk(e){let{chunks:t}=this,r=t.get(e);return void 0===r&&((r=this.getNewChunk_(rs)).initialize(e),this.addChunk(r)),r}download(e,t){return this.parent.downloadMetadata(e,t)}}rh=ri([F("annotation.MetadataChunkSource")],rh);class rc extends tT{parent;constructor(e,t){super(e,t),this.parent=e.get(t.parent)}}rc.prototype.chunkConstructor=rl;class rd extends es{parent=void 0;relationshipIndex;getChunk(e){let t=re(e),{chunks:r}=this,n=r.get(t);return void 0===n&&((n=this.getNewChunk_(ru)).initialize(t),n.objectId=e,this.addChunk(n)),n}download(e,t){return this.parent.downloadSegmentFilteredGeometry(e,this.relationshipIndex,t)}}rd=ri([F("annotation.SubsetGeometryChunkSource")],rd);class rf extends B{references=new Set;chunkManager;metadataChunkSource;segmentFilteredSources;constructor(e,t){super(e,t);let r=this.chunkManager=e.get(t.chunkManager),n=this.metadataChunkSource=this.registerDisposer(e.getRef(t.metadataChunkSource));this.segmentFilteredSources=t.segmentFilteredSource.map((t,r)=>{let n=this.registerDisposer(e.getRef(t));return n.parent=this,n.relationshipIndex=r,n}),n.parent=this,this.registerDisposer(r.recomputeChunkPriorities.add(()=>this.recomputeChunkPriorities()))}recomputeChunkPriorities(){let{chunkManager:e,metadataChunkSource:t}=this;for(let r of this.references)e.requestChunk(t.getChunk(r),q.VISIBLE,200)}add(e){throw Error("Not implemented")}delete(e){throw Error("Not implemented")}update(e,t){throw Error("Not implemented")}}O("annotation.reference.add",function(e){let t=this.get(e.id);t.references.add(e.annotation),t.chunkManager.scheduleUpdateChunkPriorities()}),O("annotation.reference.delete",function(e){let t=this.get(e.id);t.references.delete(e.annotation),t.chunkManager.scheduleUpdateChunkPriorities()}),O("annotation.commit",function(e){let t;let r=this.get(e.id),n=e.annotationId,i=e.newAnnotation;(void 0===n?r.add(i).then(e=>({...i,id:e})):null===i?r.delete(n).then(()=>null):r.update(n,i).then(()=>i)).then(e=>{r.wasDisposed||this.invoke(tz,{id:r.rpcId,annotationId:n||i.id,newAnnotation:e})},e=>{r.wasDisposed||this.invoke(tz,{id:r.rpcId,annotationId:n||i?.id,error:e.message})})});class rg extends em(eA){localPosition;renderScaleTarget;constructor(e,t){super(e,t),this.renderScaleTarget=e.get(t.renderScaleTarget),this.localPosition=e.get(t.localPosition);let r=()=>this.chunkManager.scheduleUpdateChunkPriorities();this.registerDisposer(this.localPosition.changed.add(r)),this.registerDisposer(this.renderScaleTarget.changed.add(r)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>this.recomputeChunkPriorities()))}attach(e){let t=()=>this.chunkManager.scheduleUpdateChunkPriorities(),{view:r}=e;e.registerDisposer(t),e.registerDisposer(r.projectionParameters.changed.add(t)),e.registerDisposer(r.visibility.changed.add(t)),e.state={displayDimensionRenderInfo:r.projectionParameters.value.displayDimensionRenderInfo,transformedSources:[]}}recomputeChunkPriorities(){for(let e of(this.chunkManager.registerLayer(this),this.attachments.values())){let{view:t}=e,r=t.visibility.value;if(r===Number.NEGATIVE_INFINITY)continue;let n=e.state,{transformedSources:i}=n;if(0===i.length||!e3(n,t.projectionParameters.value.displayDimensionRenderInfo))continue;let s=ty(r),a=tm(r),o=t.projectionParameters.value,{chunkManager:l}=this;!function(e,t,r,n,i,s){let{displayDimensionRenderInfo:a,viewMatrix:o,projectionMat:l,width:u,height:h}=e,{voxelPhysicalScales:c}=a,d=Math.abs(eB.wO.determinant((0,eB.bZ)(tB,o))),f=(0,eB.n_)(c),g=(0,eB.e6)(l)/d*f;if(0===n.length)return;let p=n[0],y=Math.abs(p.chunkLayout.detTransform)*f,{lowerClipDisplayBound:m,upperClipDisplayBound:v}=p;for(let e=0;e<3;++e)y*=v[e]-m[e];let b=Math.min(y,g),w=u*h,S=w/r**2/b,E=0;for(let r=n.length-1;r>=0&&E<S;--r){let a=n[r],o=a.source.spec,{chunkLayout:l}=a,u=(0,eB.n_)(l.size)*Math.abs(l.detTransform)*f,{limit:h,rank:c}=o,{nonDisplayLowerClipBound:d,nonDisplayUpperClipBound:g}=a,p=1;for(let e=0;e<c;++e){let t=g[e]-d[e];Number.isFinite(t)&&(p/=t)}let y=!0,m=E+h*p/u,v=(1/m)**(1/3),k=Math.sqrt(w/(m*b)),I=Math.min(1,(S-E)*u/p/o.limit);tc(e,t,a,()=>{y&&(i(a,r),y=!1),s(a,r,I,v,k)}),E=m}}(o,this.localPosition.value,this.renderScaleTarget.value,i[0],()=>{},(e,t)=>{let r=e.source.getChunk(e.curPositionInChunks);++this.numVisibleChunksNeeded,r.state===Y.GPU_MEMORY&&++this.numVisibleChunksAvailable,l.requestChunk(r,s,a+0+1e9*t)})}}}rg=ri([F("annotation/SpatiallyIndexedRenderLayer")],rg),O("annotation/PerspectiveRenderLayer:updateSources",function(e){let t=this.get(e.view),r=this.get(e.layer),n=r.attachments.get(t);n.state.transformedSources=tM(this,e.sources,r),n.state.displayDimensionRenderInfo=e.displayDimensionRenderInfo,r.chunkManager.scheduleUpdateChunkPriorities()});class rp extends tp(em(eg)){source;segmentationStates;constructor(e,t){super(e,t),this.source=e.get(t.source),this.segmentationStates=new k.SN(this.getSegmentationState(t.segmentationStates));let r=()=>this.chunkManager.scheduleUpdateChunkPriorities();this.registerDisposer((0,k.Uw)((e,t)=>{if(void 0!==t){for(let n of t)null!=n&&(t9(e,n,r),t7(e,n,r));r()}},this.segmentationStates)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>this.recomputeChunkPriorities()))}recomputeChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;let{segmentationStates:{value:t},source:{segmentFilteredSources:r}}=this;if(void 0===t)return;let{chunkManager:n}=this;n.registerLayer(this);let i=t.length;for(let s=0;s<i;++s){let i=t[s];if(null==i)continue;let a=ty(e),o=tm(e),l=r[s];rt(i,e=>{let t=l.getChunk(e);++this.numVisibleChunksNeeded,t.state===Y.GPU_MEMORY&&++this.numVisibleChunksAvailable,n.requestChunk(t,a,o+60)})}}getSegmentationState(e){if(void 0!==e)return e.map(e=>null==e?e:rr(this.rpc,e))}}rp=ri([F("annotation/RenderLayer")],rp),O("annotation/RenderLayer.updateSegmentation",function(e){let t=this.get(e.id);t.segmentationStates.value=t.getSegmentationState(e.segmentationStates)});var ry=r(4406),rm=r(2258);async function rv(e,t,r){return(0,rm.ru)(t,r).catch(n=>{if(500!==n.status&&401!==n.status&&403!==n.status&&504!==n.status)throw n;return(0,ry.q)(e,t,r,e=>{let t=new Headers(r.headers);return t.set("Authorization",`Bearer ${e}`),{...r,headers:t}},e=>{let{status:t}=e;if(403===t||401===t)return"refresh";throw e})})}var rb=r(5675),rw=r(7688),rS=((g={})[g.LITTLE=0]="LITTLE",g[g.BIG=1]="BIG",g);let rE=17===new Uint8Array(Uint16Array.of(4386).buffer)[0]?1:0;function rk(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,r=t.length;e<r;e+=2){let r=t[e];t[e]=t[e+1],t[e+1]=r}}function rI(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,r=t.length;e<r;e+=4){let r=t[e];t[e]=t[e+3],t[e+3]=r,r=t[e+1],t[e+1]=t[e+2],t[e+2]=r}}function rM(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let e=0,r=t.length;e<r;e+=8){let r=t[e];t[e]=t[e+7],t[e+7]=r,r=t[e+1],t[e+1]=t[e+6],t[e+6]=r,r=t[e+2],t[e+2]=t[e+5],t[e+5]=r,r=t[e+3],t[e+3]=t[e+4],t[e+4]=r}}function rx(e,t,r=rE){t!==r&&rI(e)}function rT(e,t,r,n=rE){if(t!==n&&1!==r)switch(r){case 2:rk(e);break;case 4:rI(e);break;case 8:rM(e)}}function rC(e,t,r,n,i,s){let a=Math.max(e,t,r),o=0,l=0n;function u(e){l|=BigInt(e)<<BigInt(o++)}for(let o=0;o<a;++o)o<e&&u(n>>o&1),o<t&&u(i>>o&1),o<r&&u(s>>o&1);return l}function rN(e,t,r,n,i,s){var a,o,l,u;let h=r,c=s;return(a=h^c)<(o=t^i)&&a<(a^o)&&(h=t,c=i),(l=h^c)<(u=e^n)&&l<(l^u)&&(h=e,c=n),h<c}function r$(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}class rR extends er{objectId=0n;fragmentIds;initializeManifestChunk(e,t){super.initialize(e),this.objectId=t}freeSystemMemory(){this.fragmentIds=null}serialize(e,t){super.serialize(e,t),e.fragmentIds=this.fragmentIds}downloadSucceeded(){this.systemMemoryBytes=100,this.gpuMemoryBytes=0,super.downloadSucceeded(),this.priorityTier<q.RECENT&&this.source.chunkManager.scheduleUpdateChunkPriorities()}toString(){return this.objectId.toString()}}function rP(e,t,r){let{vertexPositions:n,indices:i,vertexNormals:s,strips:a}=e;t.vertexPositions=n,t.indices=i,t.strips=a,t.vertexNormals=s;let o=n.buffer;r.push(o);let l=i.buffer;l!==o&&r.push(l),r.push(s.buffer)}function rU(e){let{vertexPositions:t,indices:r,vertexNormals:n}=e;return t.byteLength+r.byteLength+n.byteLength}class rO extends er{manifestChunk=null;fragmentId=null;meshData=null;initializeFragmentChunk(e,t,r){super.initialize(e),this.manifestChunk=t,this.fragmentId=r}freeSystemMemory(){this.manifestChunk=null,this.meshData=null,this.fragmentId=null}serialize(e,t){super.serialize(e,t),rP(this.meshData,e,t),this.meshData=null}downloadSucceeded(){this.systemMemoryBytes=this.gpuMemoryBytes=rU(this.meshData),super.downloadSucceeded()}}function rA(e,t,r){(0,ej.PT)(t),e.fragmentIds=(0,ej.uq)(t,r,ej.zE)}function r_(e,t){let r=eB.R3.create(),n=eB.R3.create(),i=eB.R3.create(),s=new Float32Array(e.length),a=t.length;for(let o=0;o<a;o+=3){let a=3*t[o],l=3*t[o+1],u=3*t[o+2];for(let t=0;t<3;++t)n[t]=e[l+t]-e[a+t],i[t]=e[u+t]-e[l+t];eB.R3.cross(r,n,i),eB.R3.normalize(r,r);for(let e=0;e<3;++e){let n=3*t[o+e];for(let e=0;e<3;++e)s[n+e]+=r[e]}}let o=s.length;for(let e=0;e<o;e+=3){let t=s.subarray(e,e+3);eB.R3.normalize(t,t)}return s}function rL(e){return Math.min(Math.max(-127,127*e+.5),127)>>>0}function rD(e,t,r,n,i,s,a){let o;let l=new Float32Array(t,n,3*i);rx(l,r),void 0===s&&(s=n+12*i),void 0!==a&&(o=a*e);let u=void 0===o?new Uint32Array(t,s):new Uint32Array(t,s,o);if(u.length%e!=0)throw Error(`Number of indices is not a multiple of ${e}: ${u.length}.`);return rx(u,r),{vertexPositions:l,indices:u}}class rz extends es{fragmentSource;constructor(e,t){super(e,t),(this.fragmentSource=this.registerDisposer(e.getRef(t.fragmentSource))).meshSource=this}getChunk(e){let t=re(e),r=this.chunks.get(t);return void 0===r&&((r=this.getNewChunk_(rR)).initializeManifestChunk(t,e),this.addChunk(r)),r}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}getFragmentChunk(e,t){let r=this.fragmentSource,{key:n,fragmentId:i}=this.getFragmentKey(e.key,t),s=r.chunks.get(n);return void 0===s&&((s=r.getNewChunk_(rO)).initializeFragmentChunk(n,e,i),r.addChunk(s)),s}}class rB extends es{meshSource=null;download(e,t){return this.meshSource.downloadFragment(e,t)}}rB=r$([F(rw.q7)],rB);class rj extends rn(tp(em(tP))){source;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities()}))}attach(e){let t=()=>{this.chunkManager.scheduleUpdateChunkPriorities()},{view:r}=e;e.registerDisposer(r.visibility.changed.add(t)),e.registerDisposer(t),t()}updateChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;this.chunkManager.registerLayer(this);let t=ty(e),r=tm(e),{source:n,chunkManager:i}=this;rt(this,e=>{let s=n.getChunk(e);++this.numVisibleChunksNeeded,i.requestChunk(s,t,r+100);let a=s.state;if(a===Y.SYSTEM_MEMORY_WORKER||a===Y.SYSTEM_MEMORY||a===Y.GPU_MEMORY)for(let e of(++this.numVisibleChunksAvailable,s.fragmentIds)){let a=n.getFragmentChunk(s,e);++this.numVisibleChunksNeeded,i.requestChunk(a,t,r+50),a.state===Y.GPU_MEMORY&&++this.numVisibleChunksAvailable}})}}rj=r$([F(rw.ve)],rj);class rF extends er{objectId=0n;manifest;initializeManifestChunk(e,t){super.initialize(e),this.objectId=t}freeSystemMemory(){this.manifest=void 0}serialize(e,t){super.serialize(e,t),e.manifest=this.manifest}downloadSucceeded(){this.systemMemoryBytes=this.manifest.octree.byteLength,this.gpuMemoryBytes=0,super.downloadSucceeded(),this.priorityTier<q.RECENT&&this.source.chunkManager.scheduleUpdateChunkPriorities()}toString(){return this.objectId.toString()}}class rV extends er{subChunkOffsets=null;meshData=null;lod=0;chunkIndex=0;manifestChunk=null;freeSystemMemory(){this.meshData=this.subChunkOffsets=null}serialize(e,t){super.serialize(e,t),rP(this.meshData,e,t);let{subChunkOffsets:r}=this;e.subChunkOffsets=r,t.push(r.buffer),this.meshData=this.subChunkOffsets=null}downloadSucceeded(){let{subChunkOffsets:e}=this;this.systemMemoryBytes=this.gpuMemoryBytes=rU(this.meshData),this.systemMemoryBytes+=e.byteLength,super.downloadSucceeded()}}class rG extends es{fragmentSource;format;constructor(e,t){super(e,t);let r=this.fragmentSource=this.registerDisposer(e.getRef(t.fragmentSource));this.format=t.format,r.meshSource=this}getChunk(e){let t=re(e),r=this.chunks.get(t);return void 0===r&&((r=this.getNewChunk_(rF)).initializeManifestChunk(t,e),this.addChunk(r)),r}getFragmentChunk(e,t,r){let n=`${e.key}/${t}:${r}`,i=this.fragmentSource,s=i.chunks.get(n);return void 0===s&&((s=i.getNewChunk_(rV)).initialize(n),s.lod=t,s.chunkIndex=r,s.manifestChunk=e,i.addChunk(s)),s}}class rK extends es{meshSource=null;download(e,t){return this.meshSource.downloadFragment(e,t)}}rK=r$([F(rw.Ff)],rK);let rY=eB._E.create();class rq extends rn(tp(em(tP))){source;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities()}))}attach(e){let t=()=>this.chunkManager.scheduleUpdateChunkPriorities(),{view:r}=e;e.registerDisposer(r.projectionParameters.changed.add(t)),e.registerDisposer(r.visibility.changed.add(t)),e.registerDisposer(t),t()}updateChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;let{transform:{value:t}}=this;if(void 0!==t.error)return;let r=[];this.chunkManager.registerLayer(this);{let t=ty(e),n=tm(e),{source:i,chunkManager:s}=this;rt(this,e=>{let a=i.getChunk(e);++this.numVisibleChunksNeeded,s.requestChunk(a,t,n+100);let o=a.state;(o===Y.SYSTEM_MEMORY_WORKER||o===Y.SYSTEM_MEMORY||o===Y.GPU_MEMORY)&&(r.push(a),++this.numVisibleChunksAvailable)})}if(0===r.length)return;let{source:n,chunkManager:i}=this;for(let{view:e}of this.attachments.values()){let s=e.visibility.value;if(s===Number.NEGATIVE_INFINITY)continue;let a=ty(s),o=tm(s),l=e.projectionParameters.value;try{!function(e,t,r){e.fill(0),e[15]=1;let n=!0,{displayDimensionIndices:i}=t,{globalToRenderLayerDimensions:s,modelToRenderLayerTransform:a}=r,o=r.rank;for(let t=0;t<3;++t){let r=i[t];if(-1===r){n=!1;continue}let l=s[r];if(-1===l){n=!1;continue}e[t+12]=a[l+o*(o+1)];for(let r=0;r<3;++r)e[t+4*r]=a[l+(o+1)*r]}if(!n){let{globalDimensionNames:e}=t,n=Array.from(i.filter(e=>-1!==e),t=>e[t]).join(",\xa0");throw Error(`Transform from model dimensions (${r.modelDimensionNames.join(",\xa0")}) to display dimensions (${n}) does not have full rank`)}}(rY,l.displayDimensionRenderInfo,t)}catch{continue}eB._E.multiply(rY,l.viewProjectionMat,rY);let u=(0,eB.th)(new Float32Array(24),rY),h=this.renderScaleTarget.value;for(let e of r){let t=e.manifest.lodScales.length-1;!function(e,t,r,n,i,s,a){let{octree:o,lodScales:l,chunkGridSpatialOrigin:u,chunkShape:h}=e,c=l.length-1,d=t[0],f=t[4],g=t[8],p=t[1],y=t[5],m=t[9],v=t[3],b=t[7],w=t[11],S=t[15],E=v>0?0:1,k=b>0?0:1,I=w>0?0:1,M=r[16],x=r[17],T=r[18],C=r[19],N=-C*M*v+-C*x*b+-C*T*w+S,$=e.clipLowerBound[0],R=e.clipLowerBound[1],P=e.clipLowerBound[2],U=e.clipUpperBound[0],O=e.clipUpperBound[1],A=e.clipUpperBound[2],_=Math.max(Math.sqrt((d*i)**2+(p*s)**2),Math.sqrt((f*i)**2+(y*s)**2),Math.sqrt((g*i)**2+(m*s)**2));!function e(t,i,s){let c=1<<t,d=5*i,f=o[d],g=o[d+1],p=o[d+2],y=o[d+3],m=o[d+4],M=f*c*h[0]+u[0],x=g*c*h[1]+u[1],T=p*c*h[2]+u[2],C=M+c*h[0],L=x+c*h[1],D=T+c*h[2];if(M=Math.max(M,$),x=Math.max(x,R),T=Math.max(T,P),C=Math.min(C,U),L=Math.min(L,O),D=Math.min(D,A),(0,eB.Rq)(M,x,T,C,L,D,r)){var z,B,j;let r=Math.max(N,v*((z=M)+E*(C-z))+b*((B=x)+k*(L-B))+w*((j=T)+I*(D-j))+S)/_;if(0===s||r*n<s){let o=l[t];if(0!==o&&a(t,i,o/r,m>>>31),t>0&&(0===o||r*n<o)){let r=0===o?s:o,n=(0x7fffffff&m)>>>0;for(let i=y;i<n;++i)e(t-1,i,r)}}}}(c,o.length/5-1,0)}(e.manifest,rY,u,h,l.width,l.height,(r,s,l,u)=>{if(u)return;let h=n.getFragmentChunk(e,r,s);++this.numVisibleChunksNeeded,i.requestChunk(h,a,o+50-t+r),h.state===Y.GPU_MEMORY&&++this.numVisibleChunksAvailable})}}}}function rJ(e,t){let r,n;let i=r_(e.vertexPositions,e.indices),s=new Uint8Array(i.length/3*2);if(!function(e,t){let r=t.length,n=0;for(let i=0;i<r;i+=3){let r=t[i],s=t[i+1],a=t[i+2],o=1/(Math.abs(r)+Math.abs(s)+Math.abs(a));a<0?(e[n]=rL((1-Math.abs(s*o))*(r<0?-1:1)),e[n+1]=rL((1-Math.abs(r*o))*(s<0?-1:1))):(e[n]=rL(r*o),e[n+1]=rL(s*o)),n+=2}}(s,i),4===e.indices.BYTES_PER_ELEMENT&&e.vertexPositions.length/3<65535?(r=new Uint16Array(e.indices.length)).set(e.indices):r=e.indices,t===rw.k_.uint10){let t=e.vertexPositions,r=t.length/3;n=new Uint32Array(r);for(let e=0,i=0;i<r;e+=3,++i)n[i]=1023&t[e]|(1023&t[e+1])<<10|(1023&t[e+2])<<20}else if(t===rw.k_.uint16){let t=e.vertexPositions;2===t.BYTES_PER_ELEMENT?n=t:(n=new Uint16Array(t.length)).set(t)}else n=e.vertexPositions;return{vertexPositions:n,vertexNormals:s,indices:r,strips:!1}}function rW(e,t,r=rw.k_.float32){e.meshData=rJ(t,r)}function rZ(e,t,r){e.meshData=rJ(t,r),e.subChunkOffsets=t.subChunkOffsets}function rX(e,t,r){let n=r;for(let r=0;r<3;++r)e[5*n+r]=e[5*t+r]>>>1;e[5*n+3]=t;for(let i=t+1;i<r;++i){let t=e[5*i]>>>1,r=e[5*i+1]>>>1,s=e[5*i+2]>>>1;(t!==e[5*n]||r!==e[5*n+1]||s!==e[5*n+2])&&(e[5*n+4]=i,e[5*++n]=t,e[5*n+1]=r,e[5*n+2]=s,e[5*n+3]=i)}return e[5*n+4]=r,++n}rq=r$([F(rw.nL)],rq);let rQ={id:"encodeCompressedSegmentationUint32"},rH={id:"encodeCompressedSegmentationUint64"},r0=0,r1=[],r2=new Map,r3=new Map,r6=void 0===navigator.hardwareConcurrency?4:Math.min(12,navigator.hardwareConcurrency),r4=0;function r8(e){for(let[t,r]of r2){r2.delete(t),r.cleanup?.(),e.postMessage(r.msg,r.transfer);return}r1.push(e)}function r5(e,t,n,...i){let s=r4++,a={t:e.id,id:s,args:i};t?.throwIfAborted();let o=new Promise((e,t)=>{r3.set(s,{resolve:e,reject:t})});if(0!==r1.length)r1.pop().postMessage(a,n);else{let e;if(void 0!==t){function l(){r2.delete(s);let e=r3.get(s);r3.delete(s),e.reject(t.reason)}t.addEventListener("abort",l,{once:!0}),e=()=>{t.removeEventListener("abort",l)}}r2.set(s,{msg:a,transfer:n,cleanup:e}),r3.size>r0&&r0<r6&&function(){++r0;let e=new Worker(new URL(r.p+r.u("412"),r.b),Object.assign({},{type:"module"},{type:void 0})),t=!1;e.onmessage=r=>{if(!t){t=!0,r8(e);return}let{id:n,value:i,error:s}=r.data;r8(e);let a=r3.get(n);r3.delete(n),void 0!==a&&(void 0!==s?a.reject(s):a.resolve(i))}}()}return o}async function r9(e,t,r){let{spec:n}=e.source;if(void 0!==n.compressedSegmentationBlockSize){let{dataType:i}=n,s=e.chunkDataSize,a=[s[0],s[1],s[2],s[3]||1];switch(i){case e9.UINT32:e.data=await r5(rQ,t,[r.buffer],r,a,n.compressedSegmentationBlockSize);break;case e9.UINT64:e.data=await r5(rH,t,[r.buffer],r,a,n.compressedSegmentationBlockSize);break;default:throw Error(`Unsupported data type for compressed segmentation: ${e9[i]}`)}}else e.data=r}var r7=r(2136);let ne=new Map;for(let[e,t]of(ne.set("|u1",{endianness:rS.LITTLE,dataType:e9.UINT8}),ne.set("|i1",{endianness:rS.LITTLE,dataType:e9.INT8}),[["<",rS.LITTLE],[">",rS.BIG]])){for(let r of["u","i"])ne.set(`${e}${r}8`,{endianness:t,dataType:e9.UINT64});ne.set(`${e}u2`,{endianness:t,dataType:e9.UINT16}),ne.set(`${e}i2`,{endianness:t,dataType:e9.INT16}),ne.set(`${e}u4`,{endianness:t,dataType:e9.UINT32}),ne.set(`${e}i4`,{endianness:t,dataType:e9.INT32}),ne.set(`${e}f4`,{endianness:t,dataType:e9.FLOAT32})}class nt{data;shape;dataType;fortranOrder;constructor(e,t,r,n){this.data=e,this.shape=t,this.dataType=r,this.fortranOrder=n}}async function nr(e,t,r){let n=function(e){let t;if(147!==e[0]||78!==e[1]||85!==e[2]||77!==e[3]||80!==e[4]||89!==e[5])throw Error("Data does not match npy format.");let r=e[6],n=e[7];if(1!==r||0!==n)throw Error(`Unsupported npy version ${r}.${n}`);let i=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(8,!0),s=new TextDecoder("utf-8").decode(e.subarray(10,i+10)),a=i+10;try{t=(0,ej.c6)(s)}catch(e){throw Error(`Failed to parse npy header: ${e}`)}let o=t.descr,l=t.shape,u=1;if(!Array.isArray(l))throw Error("Invalid shape ${JSON.stringify(shape)}");for(let e of l){if("number"!=typeof e)throw Error("Invalid shape ${JSON.stringify(shape)}");u*=e}let{dataType:h,endianness:c}=function(e){let t=ne.get(e);if(void 0===t)throw Error(`Unsupported numpy data type: ${JSON.stringify(e)}`);return t}(o),d=e7[h],f=te[h];if(d*u+a!==e.byteLength)throw Error("Expected length does not match length of data");let g=new f(e.buffer,e.byteOffset+a,u);return rT(g,c,d),new nt(g,l,h,!0===t.fortran_order)}(new Uint8Array(await (0,r7.lL)(r,"deflate"))),i=e.chunkDataSize,s=e.source,{shape:a}=n;if(3!==a.length||a[0]!==i[2]||a[1]!==i[1]||a[2]!==i[0])throw Error(`Shape ${JSON.stringify(a)} does not match chunkDataSize ${(0,eB.m0)(i)}`);let o=n.dataType,{spec:l}=s;if(o!==l.dataType)throw Error(`Data type ${e9[o]} does not match expected data type ${e9[l.dataType]}`);await r9(e,t,n.data)}let nn={id:"decodeJpeg"};async function ni(e,t,r){let n=e.chunkDataSize,{uint8Array:i}=await r5(nn,t,[r],new Uint8Array(r),void 0,void 0,n[0]*n[1]*n[2],n[3]||1,!1);await r9(e,t,i)}function ns(e,t){let{spec:r,tempChunkDataSize:n,tempChunkPosition:i}=e,{upperVoxelBound:s,rank:a,baseVoxelOffset:o}=r,l=r.chunkDataSize,u=function(e,t,r){let n=e.length;for(let i=0;i<n;++i)e[i]=t[i]*r[i];return e}(i,t.chunkGridPosition,l),h=!1;for(let e=0;e<a;++e){let t=Math.min(s[e],u[e]+l[e]);(n[e]=t-u[e])!==l[e]&&(h=!0)}return!function(e,t,r){let n=e.length;for(let i=0;i<n;++i)e[i]=t[i]+r[i]}(u,u,o),h?t.chunkDataSize=Uint32Array.from(n):t.chunkDataSize=l,u}class na extends tT{tempChunkDataSize;tempChunkPosition;constructor(e,t){super(e,t);let r=this.spec.rank;this.tempChunkDataSize=new Uint32Array(r),this.tempChunkPosition=new Float32Array(r)}computeChunkBounds(e){return ns(this,e)}}function no(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}na.prototype.chunkConstructor=class extends tx{source=null;data;chunkDataSize;initializeVolumeChunk(e,t){super.initializeVolumeChunk(e,t),this.chunkDataSize=null,this.data=null}serialize(e,t){super.serialize(e,t);let r=this.chunkDataSize;r!==this.source.spec.chunkDataSize&&(e.chunkDataSize=r);let n=e.data=this.data;null!==n&&t.push(n.buffer),this.data=null}downloadSucceeded(){this.systemMemoryBytes=this.gpuMemoryBytes=this.data?.byteLength??0,super.downloadSucceeded()}freeSystemMemory(){this.data=null}};let nl=new Map;nl.set("npz",nr),nl.set("jpeg",ni);let nu=new Map;function nh(e,t){return ey(eI()(e),t)}nu.set("npz","application/npygz"),nu.set("jpeg","image/jpeg");class nc extends nh(na,rb.Yz){chunkDecoder=nl.get(this.parameters.encoding);async download(e,t){let{parameters:r}=this,n=`${r.baseUrl}/latest/cutout/${r.collection}/${r.experiment}/${r.channel}/${r.resolution}`;{let t=this.computeChunkBounds(e),r=e.chunkDataSize;for(let e=0;e<3;++e)n+=`/${t[e]}:${t[e]+r[e]}`}n+="/",void 0!==r.window&&(n+=`?window=${r.window[0]},${r.window[1]}`);let i=await rv(this.credentialsProvider,n,{signal:t,headers:{Accept:nu.get(r.encoding)}});await this.chunkDecoder(e,t,await i.arrayBuffer())}}nc=no([F()],nc);class nd extends nh(rz,rb.i6){download(e,t){let{parameters:r}=this;return rv(this.credentialsProvider,`${r.baseUrl}${e.objectId}`,{signal:t}).then(e=>e.arrayBuffer()).then(t=>rA(e,t,"fragments"))}downloadFragment(e,t){let{parameters:r}=this;return rv(this.credentialsProvider,`${r.baseUrl}${e.fragmentId}`,{signal:t}).then(e=>e.arrayBuffer()).then(t=>(function(e,t){let r=new DataView(t).getUint32(0,!0);rW(e,rD(3,t,rS.LITTLE,4,r,void 0,void 0))})(e,t))}}nd=no([F()],nd);var nf=r(5931);function ng(e){try{if("string"!=typeof e)throw Error(`Expected string, but received ${JSON.stringify(e)}.`);let t=document.createElement("canvas").getContext("2d");t.fillStyle=e;let r=function(e){{let t=e.match(/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/);if(null!==t)return[parseInt(t[1],10),parseInt(t[2],10),parseInt(t[3],10),parseFloat(t[4])]}{let t=e.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/);if(null!==t)return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),1]}throw Error(`Invalid serialized color: ${JSON.stringify(e)}.`)}(t.fillStyle);return eB.vh.fromValues(r[0]/255,r[1]/255,r[2]/255,r[3])}catch(e){throw Error(`Failed to parse color specification: ${e.message}`)}}function np(e){let t=void 0===e[3]?3:4,r=0;for(let n=0;n<t;n++)r=(r<<8>>>0)+Math.min(255,Math.max(0,Math.round(255*e[t-1-n])));return r}function ny(e){if(void 0===e[3]||1===e[3]){let t="#";for(let r=0;r<3;++r)t+=("0"+Math.min(255,Math.max(0,Math.round(255*e[r]))).toString(16)).slice(-2);return t}let t="rgba(";for(let r=0;r<3;++r)0!==r&&(t+=", "),t+=Math.min(255,Math.max(0,Math.round(255*e[r])));return t+`, ${(0,nf.i)(e[3])})`}k.SN,k.SN,new Uint32Array(new Float64Array(1).buffer),e9.UINT8,e9.INT8,e9.UINT16,e9.INT16,e9.UINT32,e9.INT32,e9.UINT64,e9.FLOAT32,M.gj;var nm=((p={})[p.POINT=0]="POINT",p[p.LINE=1]="LINE",p[p.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",p[p.ELLIPSOID=3]="ELLIPSOID",p);let nv=[0,1,2,3];e9.FLOAT32,e9.UINT32,e9.INT32,e9.UINT16,e9.INT16,e9.UINT8,e9.INT8;let nb={rgb:{serializedBytes:()=>3,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, true);dv.setUint8(${t} + 2, ${e} >>> 16);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, true) | (dv.getUint8(${t} + 2) << 16);`,deserializeJson:e=>np(ng(e).subarray(0,3)),serializeJson:e=>ny(eB.R3.fromValues((e>>>0&255)/255,(e>>>8&255)/255,(e>>>16&255)/255))},rgba:{serializedBytes:()=>4,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, true);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, true);`,deserializeJson:e=>np(ng(e)),serializeJson:e=>ny(eB.vh.fromValues((e>>>0&255)/255,(e>>>8&255)/255,(e>>>16&255)/255,(e>>>24&255)/255))},float32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setFloat32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getFloat32(${t}, isLittleEndian);`,deserializeJson:e=>(0,ej.nH)(e),serializeJson:e=>e},uint32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, isLittleEndian);`,deserializeJson:e=>(0,ej.C$)(e),serializeJson:e=>e},int32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setInt32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt32(${t}, isLittleEndian);`,deserializeJson:e=>(0,ej.C$)(e),serializeJson:e=>e},uint16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, isLittleEndian);`,deserializeJson:e=>(0,ej.C$)(e),serializeJson:e=>e},int16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setInt16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt16(${t}, isLittleEndian);`,deserializeJson:e=>(0,ej.C$)(e),serializeJson:e=>e},uint8:{serializedBytes:()=>1,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getUint8(${t});`,deserializeJson:e=>(0,ej.C$)(e),serializeJson:e=>e},int8:{serializedBytes:()=>2,alignment:()=>1,serializeCode:(e,t)=>`dv.setInt8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getInt8(${t});`,deserializeJson:e=>(0,ej.C$)(e),serializeJson:e=>e}};class nw{rank;firstGroupInitialOffset;propertySpecs;serializedBytes;serialize;deserialize;propertyGroupBytes;constructor(e,t,r){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=r,0===r.length){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}let{serializedBytes:n,offsets:i,propertyGroupBytes:s}=function(e,t,r){let n=0,i=r.length,s=Array(i),a=[];for(let e=0;e<i;++e)s[e]=e;let o=t=>nb[r[t].type].alignment(e);s.sort((e,t)=>o(t)-o(e));let l=0,u=Array(i),h=t,c=()=>{h+=(4-h%4)%4,n+=h,a[l]=h,h=0,++l};for(let t=0;t<i;++t){let n=s[t],i=nb[r[n].type],a=i.serializedBytes(e),o=i.alignment(e),d=(o-h%o)%o,f=h+d+a;f+(4-f%4)%4<=255?h+=d:c(),u[n]={offset:h,group:l},h+=a}return c(),{serializedBytes:n,offsets:u,propertyGroupBytes:a}}(e,t,r);this.propertyGroupBytes=s;let a="let groupOffset0 = offset;";for(let e=1;e<s.length;++e)a+=`let groupOffset${e} = groupOffset${e-1} + ${s[e-1]}*annotationCount;`;for(let e=0;e<s.length;++e)a+=`groupOffset${e} += ${s[e]}*annotationIndex;`;let o=a,l=a,u=r.length;for(let t=0;t<u;++t){let{group:n,offset:s}=i[t],a=nb[r[t].type],u=`properties[${t}]`,h=`groupOffset${n} + ${s}`;o+=a.serializeCode(u,h,e),l+=a.deserializeCode(u,h,e)}this.serializedBytes=n,this.serialize=Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",o),this.deserialize=Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",l)}}function nS(e,t,r,n,i){for(let s=0;s<n;++s)e.setFloat32(t,i[s],r),t+=4;return t}function nE(e,t,r,n,i,s){return t=nS(e,t,r,n,i),t=nS(e,t,r,n,s)}function nk(e,t,r,n,i){for(let s=0;s<n;++s)i[s]=e.getFloat32(t,r),t+=4;return t}function nI(e,t,r,n,i,s){return t=nk(e,t,r,n,i),t=nk(e,t,r,n,s)}let nM={1:{icon:"ꕹ",description:"Line",toJSON:e=>({pointA:Array.from(e.pointA),pointB:Array.from(e.pointB)}),restoreState(e,t,r){e.pointA=(0,ej.uq)(t,"pointA",e=>(0,ej.Iw)(new Float32Array(r),e,ej.jz)),e.pointB=(0,ej.uq)(t,"pointB",e=>(0,ej.Iw)(new Float32Array(r),e,ej.jz))},serializedBytes:e=>8*e,serialize(e,t,r,n,i){nE(e,t,r,n,i.pointA,i.pointB)},deserialize:(e,t,r,n,i)=>{let s=new Float32Array(n),a=new Float32Array(n);return nI(e,t,r,n,s,a),{type:1,pointA:s,pointB:a,id:i,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},0:{icon:"⚬",description:"Point",toJSON:e=>({point:Array.from(e.point)}),restoreState:(e,t,r)=>{e.point=(0,ej.uq)(t,"point",e=>(0,ej.Iw)(new Float32Array(r),e,ej.jz))},serializedBytes:e=>4*e,serialize:(e,t,r,n,i)=>{nS(e,t,r,n,i.point)},deserialize:(e,t,r,n,i)=>{let s=new Float32Array(n);return nk(e,t,r,n,s),{type:0,point:s,id:i,properties:[]}},visitGeometry(e,t){t(e.point,!1)}},2:{icon:"❑",description:"Bounding Box",toJSON:e=>({pointA:Array.from(e.pointA),pointB:Array.from(e.pointB)}),restoreState:(e,t,r)=>{e.pointA=(0,ej.uq)(t,"pointA",e=>(0,ej.Iw)(new Float32Array(r),e,ej.jz)),e.pointB=(0,ej.uq)(t,"pointB",e=>(0,ej.Iw)(new Float32Array(r),e,ej.jz))},serializedBytes:e=>8*e,serialize(e,t,r,n,i){nE(e,t,r,n,i.pointA,i.pointB)},deserialize:(e,t,r,n,i)=>{let s=new Float32Array(n),a=new Float32Array(n);return nI(e,t,r,n,s,a),{type:2,pointA:s,pointB:a,id:i,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},3:{icon:"◎",description:"Ellipsoid",toJSON:e=>({center:Array.from(e.center),radii:Array.from(e.radii)}),restoreState:(e,t,r)=>{e.center=(0,ej.uq)(t,"center",e=>(0,ej.Iw)(new Float32Array(r),e,ej.jz)),e.radii=(0,ej.uq)(t,"radii",e=>(0,ej.Iw)(new Float32Array(r),e,ej.lu))},serializedBytes:e=>8*e,serialize(e,t,r,n,i){nE(e,t,r,n,i.center,i.radii)},deserialize:(e,t,r,n,i)=>{let s=new Float32Array(n),a=new Float32Array(n);return nI(e,t,r,n,s,a),{type:3,center:s,radii:a,id:i,properties:[]}},visitGeometry(e,t){t(e.center,!1),t(e.radii,!0)}}};M.gj;class nx{propertySerializers;annotations;constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return function(e,t){let r=0,n=[];for(let i of nv){let s=t[i].serializedBytes;n[i]=r,r+=s*e[i].length}let i=[],s=[],a=new ArrayBuffer(r),o=new DataView(a),l=rE===rS.LITTLE;for(let r of nv){let a=t[r],{rank:u}=a,h=a.serialize,c=e[r];i[r]=c.map(e=>e.id),s[r]=new Map(c.map((e,t)=>[e.id,t]));let d=nM[r].serialize,f=n[r],g=a.propertyGroupBytes[0];for(let e=0,t=c.length;e<t;++e){let r=c[e];d(o,f+e*g,l,u,r),h(o,f,e,t,l,r.properties)}}return{data:new Uint8Array(a),typeToIds:i,typeToOffset:n,typeToIdMaps:s}}(this.annotations,this.propertySerializers)}}var nT=r(7399);function nC(e,t,r,n={}){return(0,nT.i)(t,`${e.serverUrl}${r}`,n)}var nN=r(3488),n$=r(5105);class nR extends er{objectId=0n;vertexPositions=null;vertexAttributes=null;indices=null;initializeSkeletonChunk(e,t){super.initialize(e),this.objectId=t}freeSystemMemory(){this.vertexPositions=this.indices=null}getVertexAttributeBytes(){let e=this.vertexPositions.byteLength,{vertexAttributes:t}=this;return null!=t&&t.forEach(t=>{e+=t.byteLength}),e}serialize(e,t){super.serialize(e,t);let r=this.vertexPositions,n=this.indices;e.numVertices=r.length/3,e.indices=n,t.push(n.buffer);let{vertexAttributes:i}=this;if(null!=i&&i.length>0){let n=new Uint8Array(this.getVertexAttributeBytes());n.set(new Uint8Array(r.buffer,r.byteOffset,r.byteLength));let s=e.vertexAttributeOffsets=new Uint32Array(i.length+1);s[0]=0;let a=r.byteLength;i.forEach((e,t)=>{s[t+1]=a,n.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a),a+=e.byteLength}),t.push(n.buffer),e.vertexAttributes=n}else e.vertexAttributes=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),e.vertexAttributeOffsets=Uint32Array.of(0),r.buffer!==t[0]&&t.push(r.buffer);this.vertexPositions=this.indices=this.vertexAttributes=null}downloadSucceeded(){this.systemMemoryBytes=this.gpuMemoryBytes=this.indices.byteLength+this.getVertexAttributeBytes(),super.downloadSucceeded()}}class nP extends es{getChunk(e){let t=re(e),r=this.chunks.get(t);return void 0===r&&((r=this.getNewChunk_(nR)).initializeSkeletonChunk(t,e),this.addChunk(r)),r}}class nU extends rn(tp(em(eg))){source;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities()}))}updateChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;this.chunkManager.registerLayer(this);let t=ty(e),r=tm(e),{source:n,chunkManager:i}=this;rt(this,e=>{let s=n.getChunk(e);++this.numVisibleChunksNeeded,s.state===Y.GPU_MEMORY&&++this.numVisibleChunksAvailable,i.requestChunk(s,t,r+60)})}}function nO(e,t,r,n,i,s,a){let o=rD(2,t,r,n,i,s,a);e.vertexPositions=o.vertexPositions,e.indices=o.indices}async function nA(e,t,r){e.data=new Uint32Array(r)}async function n_(e,t,r,n=rE,i=0,s=r.byteLength){let{spec:a}=e.source,{dataType:o}=a,l=function(e){let t=1;for(let r=0,n=e.length;r<n;++r)t*=e[r];return t}(e.chunkDataSize),u=e7[o],h=l*u;if(h!==s)throw Error(`Raw-format chunk is ${s} bytes, but ${l} * ${u} = ${h} bytes are expected.`);let c=tt(o,r,i,s);rT(c,n,u),await r9(e,t,c)}nU=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F(n$.f)],nU);var nL=r(6235);function nD(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}let nz=new Map([[nN.ke.RAW,n_],[nN.ke.JPEG,ni],[nN.ke.COMPRESSED_SEGMENTATION,nA]]);function nB(e,t){e&&(t.change_spec={change_stack_id:e.changeStackId},e.timeStamp&&(t.change_spec.time_stamp=e.timeStamp),e.skipEquivalences&&(t.change_spec.skip_equivalences=e.skipEquivalences))}function nj(e,t){return ey(eI()(e),t)}class nF extends nj(na,nN.LV){chunkDecoder=nz.get(this.parameters.encoding);applyEncodingParams(e){let{encoding:t}=this.parameters;switch(t){case nN.ke.RAW:e.subvolume_format="RAW";break;case nN.ke.JPEG:e.subvolume_format="SINGLE_IMAGE",e.image_format_options={image_format:"JPEG",jpeg_quality:this.parameters.jpegQuality};return;case nN.ke.COMPRESSED_SEGMENTATION:e.subvolume_format="RAW",e.image_format_options={compressed_segmentation_block_size:(0,eB.m0)(this.spec.compressedSegmentationBlockSize)};break;default:throw Error(`Invalid encoding: ${t}`)}}async download(e,t){let{parameters:r}=this,n=this.computeChunkBounds(e),i=e.chunkDataSize,s=`/v1/volumes/${r.volumeId}/subvolume:binary`,a={geometry:{corner:(0,eB.m0)(n),size:(0,eB.m0)(i),scale:r.scaleIndex}};this.applyEncodingParams(a),nB(r.changeSpec,a);let o=await nC(r.instance,this.credentialsProvider,s,{method:"POST",body:JSON.stringify(a),signal:t});await this.chunkDecoder(e,t,await o.arrayBuffer())}}function nV(e,t){let r=e.byteLength,n=0,i=new DataView(e);for(;n<r;){if(n+32>r)throw Error("Invalid batch mesh fragment response.");let s=i.getBigUint64(n,!0).toString()+"\0";n+=8;let a=i.getUint32(n,!0),o=i.getUint32(n+4,!0);if(n+=8,0!==o||n+a+8+8>r)throw Error("Invalid batch mesh fragment response.");let l=s+new TextDecoder().decode(new Uint8Array(e,n,a));n+=a;let u=i.getUint32(n,!0),h=i.getUint32(n+4,!0);n+=8;let c=i.getUint32(n,!0),d=i.getUint32(n+4,!0);if(n+=8,0!==h||0!==d)throw Error("Invalid batch mesh fragment response.");let f=n+12*c+12*u;if(f>r)throw Error("Invalid batch mesh fragment response.");t({fullKey:l,buffer:e,verticesOffset:n,numVertices:u,indicesOffset:n+12*u,numIndices:3*c}),n=f}}function nG(e){let t=0,r=0;for(let n of e)t+=n.numVertices,r+=n.numIndices;let n=new Float32Array(3*t),i=new Uint32Array(r),s=0,a=0;for(let t of e){n.set(new Float32Array(t.buffer,t.verticesOffset,3*t.numVertices),3*s);let{numIndices:e}=t,r=new Uint32Array(t.buffer,t.indicesOffset,e);rx(r,rS.LITTLE);for(let t=0;t<e;++t)i[a++]=r[t]+s;s+=t.numVertices}return rx(n,rS.LITTLE),{vertexPositions:n,indices:i}}async function nK(e,t,r,n){let i;let s=[],a=0,o=new Map;for(let[e,t]of r){o.set(e,t),r.delete(e);let n=e.indexOf("\0"),l=e.substring(0,n),u=e.substring(n+1);if(l!==i&&s.push({object_id:l,fragment_keys:[]}),s[s.length-1].fragment_keys.push(u),255==++a)break}let l={volume_id:t.volumeId,mesh_name:t.meshName,batches:s};try{return await (await nC(t.instance,e,"/v1/objects/meshes:batch",{method:"POST",body:JSON.stringify(l),signal:n})).arrayBuffer()}finally{for(let[e,t]of o)r.set(e,t)}}nF=nD([F()],nF);class nY extends nj(rG,nN.f5){listFragmentsParams=(()=>{let{parameters:e}=this,{changeSpec:t}=e;return void 0!==t?`&header.changeStackId=${t.changeStackId}`:""})();download(e,t){let{parameters:r}=this,n=`/v1/objects/${r.volumeId}/meshes/${r.info.lods[0].info.name}:listfragments?object_id=${e.objectId}&return_supervoxel_ids=true`+this.listFragmentsParams;return nC(r.instance,this.credentialsProvider,n,{signal:t}).then(e=>e.json()).then(t=>(function(e,t){let r,n,i;(0,ej.PT)(t);let s=e.source,a=(0,ej.uq)(t,"fragmentKey",ej.zE),o=(0,ej.uq)(t,"supervoxelId",ej.zE),l=a.length;if(l!==o.length)throw Error("Expected fragmentKey and supervoxelId arrays to have the same length.");let u=new Map;a.forEach((e,t)=>{let r=u.get(e);void 0===r&&(r=[],u.set(e,r)),r.push(o[t])});let{chunkShape:h}=s.parameters.info,c=s.parameters.info.lods[0].gridShape,d=Math.ceil(Math.log2(c[0])),f=Math.ceil(Math.log2(c[1])),g=Math.ceil(Math.log2(c[2])),p=Array.from(u.entries()).map(([e,t])=>({fragmentId:e,corner:function(e,t,r,n){let i=Math.max(t,r,n),s=0,a=0,o=0,l=0;for(let u=0;u<i;++u)u<t&&(a|=Number(e>>BigInt(s++)&BigInt(1))<<u),u<r&&(o|=Number(e>>BigInt(s++)&BigInt(1))<<u),u<n&&(l|=Number(e>>BigInt(s++)&BigInt(1))<<u);return Uint32Array.of(a,o,l)}((0,ej.tw)(BigInt("0x"+e)),d,f,g),supervoxelIds:t}));p.sort((e,t)=>rN(e.corner[0],e.corner[1],e.corner[2],t.corner[0],t.corner[1],t.corner[2])?-1:1);let y=0;if(0===l)r=n=eB.b$,i=Uint32Array.of(0,0,0,0,0x80000000);else{let e=eB.R3.clone(eB.$k),t=eB.R3.clone(eB.b$);for(p.forEach(r=>{let{corner:n}=r;for(let r=0;r<3;++r)e[r]=Math.min(e[r],n[r]),t[r]=Math.max(t[r],n[r])}),y=1;t[0]>>>y-1!=e[0]>>>y-1||t[1]>>>y-1!=e[1]>>>y-1||t[2]>>>y-1!=e[2]>>>y-1;)++y;r=eB.R3.multiply(e,e,h),n=eB.R3.add(t,eB.R3.multiply(t,t,h),h)}let{lods:m}=s.parameters.info,v=new Float32Array(Math.max(m.length,y));for(let e=0;e<m.length;++e)v[e]=m[e].scale;if(0!==l){let e=new Uint32Array(p.length*v.length*5);p.forEach((t,r)=>{e.set(t.corner,5*r),e[5*r]=t.corner[0]});let t=0,r=p.length;for(let n=1;n<v.length;++n){let n=rX(e,t,r);t=r,r=n}i=e.slice(0,5*r)}let b={chunkShape:h,chunkGridSpatialOrigin:eB.b$,clipLowerBound:r,clipUpperBound:n,octree:i,lodScales:v,vertexOffsets:new Float32Array(3*v.length)};e.manifest=b,e.fragmentSupervoxelIds=p})(e,t))}async downloadFragment(e,t){let{parameters:r}=this,n=e.manifestChunk,{fragmentSupervoxelIds:i}=n,s=n.manifest,{lod:a}=e,{octree:o}=s,l=i.length,u=e.chunkIndex,h=u;for(;h>=l;)h=o[5*h+3];let c=u+1;for(;c>l;)c=0x7fffffff&o[5*c-1];let{relativeBlockShape:d,gridShape:f}=r.info.lods[a],g=Math.ceil(Math.log2(f[0])),p=Math.ceil(Math.log2(f[1])),y=Math.ceil(Math.log2(f[2])),m=new Map;for(let e=h;e<c;++e){let t=Math.floor(o[5*e]/d[0]),r=rC(g,p,y,t,Math.floor(o[5*e+1]/d[1]),Math.floor(o[5*e+2]/d[2])).toString(16).padStart(16,"0");for(let t of i[e].supervoxelIds)m.set(t+"\0"+r,e)}let v=Math.max(0,a-1),b=[],w=Array.from(m);w.sort((e,t)=>(0,nL.B)(e[0],t[0])),m=new Map(w);let S=r.info.lods[a].info.name;await new Promise((n,i)=>{let s=0,a=!1,o=()=>{if(!a){for(;0!==m.size;)++s,nK(this.credentialsProvider,{instance:r.instance,volumeId:r.volumeId,meshName:S},m,t).then(e=>{--s,nV(e,e=>{let t=m.get(e.fullKey);if(!m.delete(e.fullKey))throw Error(`Received unexpected fragment key: ${JSON.stringify(e.fullKey)}.`);e.chunkIndex=t,b.push(e)}),o()}).catch(e=>{a=!0,i(e)});if(e.downloadSlots=Math.max(1,s),0===s){n(void 0);return}}};o()}),b.sort((e,t)=>e.chunkIndex-t.chunkIndex);let E=0,k=1<<3*(a-v),I=new Uint32Array(k+1),M=0;for(let e of b){var x;let t=e.chunkIndex,r=(x=o[5*t]>>>v,(1&x|o[5*t+1]>>>v<<1&2|o[5*t+2]>>>v<<2&4)&k-1);I.fill(E,M+1,r+1),M=r,E+=e.numIndices}I.fill(E,M+1,k+1),rZ(e,{...nG(b),subChunkOffsets:I},rw.k_.float32)}}nY=nD([F()],nY);class nq extends nj(rz,nN.i6){listFragmentsParams=(()=>{let{parameters:e}=this,{changeSpec:t}=e;return void 0!==t?`&header.changeStackId=${t.changeStackId}`:""})();download(e,t){let{parameters:r}=this,n=`/v1/objects/${r.volumeId}/meshes/${r.meshName}:listfragments?object_id=${e.objectId}&return_supervoxel_ids=true`+this.listFragmentsParams;return nC(r.instance,this.credentialsProvider,n,{signal:t}).then(e=>e.json()).then(t=>(function(e,t){(0,ej.PT)(t);let r=(0,ej.uq)(t,"fragmentKey",ej.zE),n=(0,ej.uq)(t,"supervoxelId",ej.zE);if(r.length!==n.length)throw Error("Expected fragmentKey and supervoxelId arrays to have the same length.");let i=n.map((e,t)=>e+"\0"+r[t]);e.fragmentIds=function(e){let t=[],r=0,n=e.length;for(;r<n;)t.push(JSON.stringify(e.slice(r,r+255))),r+=255;return t}(i)})(e,t))}async downloadFragment(e,t){let{parameters:r}=this,n=new Map;for(let t of JSON.parse(e.fragmentId))n.set(t,null);let i=[],{credentialsProvider:s}=this;for(;0!==n.size;)nV(await nK(s,r,n,t),e=>{if(!n.delete(e.fullKey))throw Error(`Received unexpected fragment key: ${JSON.stringify(e.fullKey)}.`);i.push(e)});rW(e,nG(i))}}nq=nD([F()],nq);class nJ extends nj(nP,nN.zT){download(e,t){let{parameters:r}=this,n={object_id:`${e.objectId}`},i=`/v1/objects/${r.volumeId}/meshes/${r.meshName}/skeleton:binary`;return nB(r.changeSpec,n),nC(r.instance,this.credentialsProvider,i,{method:"POST",body:JSON.stringify(n),signal:t}).then(e=>e.arrayBuffer()).then(t=>(function(e,t){let r=new DataView(t),n=r.getUint32(0,!0);if(0!==r.getUint32(4,!0))throw Error("The number of vertices should not exceed 2^32-1.");let i=r.getUint32(8,!0);if(0!==r.getUint32(12,!0))throw Error("The number of edges should not exceed 2^32-1.");nO(e,t,rS.LITTLE,16,n,void 0,i)})(e,t))}}nJ=nD([F()],nJ);let nW=["LOCATION","LINE","VOLUME"];function nZ(e){let t=e.match(/(-?[0-9]+),(-?[0-9]+),(-?[0-9]+)/);if(null===t)throw Error(`Error parsing number triplet: ${JSON.stringify(e)}.`);return eB.R3.fromValues(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]))}function nX(e){return e.volumeId+":"+e.changestack+":"}function nQ(e,t){if(!t.startsWith(e))throw Error(`Received annotation id ${JSON.stringify(t)} does not have expected prefix of ${JSON.stringify(e)}.`);return t.substring(e.length)}function nH(e){if(null!=e)return[BigUint64Array.from((0,ej.m7)(e,ej.tw))]}function n0(e,t,r){let n=(0,ej.uq)(e,"corner",e=>nZ((0,ej.ZE)(e))),i=(0,ej.uq)(e,"size",e=>nZ((0,ej.ZE)(e))),s=(0,ej.uq)(e,"payload",ej.kt),a=(0,ej.uq)(e,"type",ej.ZE),o=(0,ej.uq)(e,"id",ej.ZE),l=nQ(t,o),u=(0,ej.uq)(e,"objectLabels",nH);if(void 0!==r&&l!==r)throw Error(`Received annotation has unexpected id ${JSON.stringify(o)}.`);switch(a){case"LOCATION":{if(eB.R3.equals(i,eB.b$))return{type:nm.POINT,id:l,point:n,description:s,relatedSegments:u,properties:[]};let e=eB.R3.scale(eB.R3.create(),i,.5),t=eB.R3.add(eB.R3.create(),n,e);return{type:nm.ELLIPSOID,id:l,center:t,radii:e,description:s,relatedSegments:u,properties:[]}}case"LINE":return{type:nm.LINE,id:l,pointA:n,pointB:eB.R3.add(eB.R3.create(),n,i),description:s,relatedSegments:u,properties:[]};case"VOLUME":return{type:nm.AXIS_ALIGNED_BOUNDING_BOX,id:l,pointA:n,pointB:eB.R3.add(eB.R3.create(),n,i),description:s,relatedSegments:u,properties:[]};default:throw Error(`Unknown spatial annotation type: ${JSON.stringify(a)}.`)}}let n1=function(e,t){let r=[];for(let n of nv){let i=nM[n];r[n]=new nw(3,i.serializedBytes(e),t)}return r}(3,[]);function n2(e,t){let r=new nx(n1),n=nX(e.source.parent.parameters);t.forEach((e,t)=>{try{(0,ej.PT)(e);let t=(0,ej.uq)(e,"annotations",e=>void 0===e?[]:e);if(!Array.isArray(t))throw Error(`Expected array, but received ${JSON.stringify(typeof t)}.`);for(let e of t)try{r.add(n0(e,n))}catch(e){throw Error(`Error parsing annotation: ${e.message}`)}}catch(e){throw Error(`Error parsing ${nW[t]} annotations: ${e.message}`)}}),e.data=Object.assign(new ra,r.serialize())}function n3(e){let t=e.indexOf(".");return e.substring(0,t)}function n6(e){return`${Math.round(e[0])},${Math.round(e[1])},${Math.round(e[2])}`}function n4(e,t){return`${e.volumeId}:${e.changestack}:${t}`}function n8(e){let t=e.description||"",r=void 0===e.relatedSegments?void 0:Array.from(e.relatedSegments[0],e=>e.toString());switch(e.type){case nm.LINE:{let{pointA:n,pointB:i}=e,s=eB.R3.subtract(eB.R3.create(),i,n);return{type:"LINE",corner:n6(n),size:n6(s),object_labels:r,payload:t}}case nm.AXIS_ALIGNED_BOUNDING_BOX:{let{pointA:n,pointB:i}=e,s=function(e,t,r){let n=e.length;for(let i=0;i<n;++i)e[i]=Math.min(t[i],r[i]);return e}(eB.R3.create(),n,i),a=function(e,t,r){let n=e.length;for(let i=0;i<n;++i)e[i]=Math.max(t[i],r[i]);return e}(eB.R3.create(),n,i),o=eB.R3.subtract(a,a,s);return{type:"VOLUME",corner:n6(s),size:n6(o),object_labels:r,payload:t}}case nm.POINT:return{type:"LOCATION",corner:n6(e.point),size:"0,0,0",object_labels:r,payload:t};case nm.ELLIPSOID:{let n=eB.R3.subtract(eB.R3.create(),e.center,e.radii),i=eB.R3.scale(eB.R3.create(),e.radii,2);return{type:"LOCATION",corner:n6(n),size:n6(i),object_labels:r,payload:t}}}}class n5 extends nj(rc,nN.WM){async download(e,t){let{parameters:r}=this;return Promise.all(nW.map(e=>nC(r.instance,this.credentialsProvider,`/v1/changes/${r.volumeId}/${r.changestack}/spatials:get`,{signal:t,method:"POST",body:JSON.stringify({type:e,ignore_payload:!0})}).then(e=>e.json()))).then(t=>{n2(e,t)})}}n5=nD([F()],n5);class n9 extends nj(rf,nN.Jb){downloadSegmentFilteredGeometry(e,t,r){let{parameters:n}=this;return Promise.all(nW.map(t=>nC(n.instance,this.credentialsProvider,`/v1/changes/${n.volumeId}/${n.changestack}/spatials:get`,{signal:r,method:"POST",body:JSON.stringify({type:t,object_labels:[e.objectId.toString()],ignore_payload:!0})}).then(e=>e.json()))).then(t=>{n2(e,t)})}downloadMetadata(e,t){let{parameters:r}=this,n=e.key;return nC(r.instance,this.credentialsProvider,`/v1/changes/${r.volumeId}/${r.changestack}/spatials:get`,{signal:t,method:"POST",body:JSON.stringify({type:n3(n),id:n4(r,n)})}).then(e=>e.json()).then(t=>{var i;e.annotation=(i=nX(r),(0,ej.PT)(t),n0((0,ej.uq)(t,"annotations",e=>(0,ej.Iw)([void 0],e,ej.PT))[0],i,n))},()=>{e.annotation=null})}add(e){let{parameters:t}=this,r=n8(e);return nC(t.instance,this.credentialsProvider,`/v1/changes/${t.volumeId}/${t.changestack}/spatials:push`,{method:"POST",body:JSON.stringify({annotations:[r]})}).then(e=>e.json()).then(e=>{(0,ej.PT)(e);let t=(0,ej.uq)(e,"ids",ej.zE);if(1!==t.length)throw Error(`Expected list of 1 id, but received ${JSON.stringify(t)}.`);return nQ(nX(this.parameters),t[0])})}update(e,t){let{parameters:r}=this,n=n8(t);return n.id=n4(r,e),nC(r.instance,this.credentialsProvider,`/v1/changes/${r.volumeId}/${r.changestack}/spatials:push`,{method:"POST",body:JSON.stringify({annotations:[n]})}).then(e=>e.json())}delete(e){let{parameters:t}=this;return nC(t.instance,this.credentialsProvider,`/v1/changes/${t.volumeId}/${t.changestack}/spatials:delete`,{method:"POST",body:JSON.stringify({type:n3(e),ids:[n4(t,e)]})}).then(e=>e.json())}}n9=nD([F()],n9);let n7={id:"decodePng"};var ie=r(7484);class it extends ey(eP(na),ie.j){tileKvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.url);gridShape=(()=>{let e=new Uint32Array(2),{upperVoxelBound:t,chunkDataSize:r}=this.spec;for(let n=0;n<2;++n)e[n]=Math.ceil(t[n]/r[n]);return e})();async download(e,t){let r;let{parameters:n}=this,{tilesize:i,overlap:s,encoding:a}=n,[o,l]=e.chunkGridPosition,u=0===o?0:s,h=0===l?0:s,c=`${this.tileKvStore.path}/${o}_${l}.${n.format}`,d=await this.tileKvStore.store.read(c,{signal:t});if(void 0===d)return;let f=new Uint8Array(await d.response.arrayBuffer()),g=0,p=0;switch(a){case ie.W.PNG:{let e=await r5(n7,t,[f.buffer],f,void 0,void 0,void 0,3,1,!1);({width:g,height:p}=e),r=function(e,t,r){let n=new e.constructor(e.length);for(let i=0;i<3*t;i+=3)for(let s=0;s<r;s++)n[s*t+i/r]=e[i+s];return n}(e.uint8Array,g*p,3);break}case ie.W.JPG:case ie.W.JPEG:{let e=await r5(nn,t,[f.buffer],f,void 0,void 0,void 0,3,!1);({uint8Array:r,width:g,height:p}=e)}}if(void 0!==r){let t=i*i,n=g*p,s=e.data=new Uint8Array(3*t);for(let e=0;e<3;e++)for(let a=0;a<p;a++)for(let o=0;o<g;o++)s[o+a*i+e*t]=r[o+u+(a+h)*g+e*n]}}}it=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F()],it);class ir{baseUrl;nodeKey;constructor(e,t){this.baseUrl=e,this.nodeKey=t}getNodeApiUrl(e=""){return`${this.baseUrl}/api/node/${this.nodeKey}${e}`}getRepoInfoUrl(){return`${this.baseUrl}/api/repos/info`}getKeyValueUrl(e,t){return`${this.getNodeApiUrl()}/${e}/key/${t}`}getKeyValueRangeUrl(e,t,r){return`${this.getNodeApiUrl()}/${e}/keyrange/${t}/${r}`}getKeyValuesUrl(e){return`${this.getNodeApiUrl()}/${e}/keyvalues?jsontar=false`}}function ii(e,t){return e.includes("?")?e+="&":e+="?",e+="app=Neuroglancer",t&&(e+=`&u=${t}`),e}function is(e,t,r){return(0,ry.q)(e,t,r,(e,t)=>{let r={...t};return e.token&&(r.headers={...r.headers,Authorization:`Bearer ${e}`}),r},e=>{let{status:t}=e;if(403===t||401===t)return"refresh";throw e})}var ia=r(2600);class io{type;x;y;z;radius;parent}function il(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}function iu(e,t){return ey(eI()(e),t)}class ih extends iu(nP,ia.zT){download(e,t){let{parameters:r}=this,n=`${e.objectId}`,i=`${r.baseUrl}/api/node/${r.nodeKey}/${r.dataInstanceKey}/key/`+n+"_swc";return is(this.credentialsProvider,ii(i,r.user),{signal:t}).then(e=>e.arrayBuffer()).then(t=>{!function(e,t){let r=function(e){let t=e.split("\n"),r=[],n="-?\\d*(?:\\.\\d+)?",i=RegExp("^[ \\t]*("+["\\d+","\\d+",n,n,n,n,"-1|\\d+"].join(")[ \\t]+(")+")[ \\t]*$");return t.forEach(e=>{let t=e.match(i);if(t){let e=r[parseInt(t[1],10)]=new io;e.type=parseInt(t[2],10),e.x=parseFloat(t[3]),e.y=parseFloat(t[4]),e.z=parseFloat(t[5]),e.radius=parseFloat(t[6]),e.parent=parseInt(t[7],10)}}),r}(t);if(r.length<1)throw Error("ERROR parsing swc data");let n=new Uint32Array(r.length),i=0,s=0;r.forEach((e,t)=>{e&&(n[t]=i++,e.parent>=0&&++s)});let a=new Float32Array(3*i),o=new Uint32Array(2*s),l=0,u=0;r.forEach(e=>{e&&(a[3*l]=e.x,a[3*l+1]=e.y,a[3*l+2]=e.z,e.parent>=0&&(o[2*u]=l,o[2*u+1]=n[e.parent],++u),++l)}),e.indices=o,e.vertexPositions=a}(e,new TextDecoder("utf-8").decode(t))})}}ih=il([F()],ih);class ic extends iu(rz,ia.i6){download(e){return e.fragmentIds=[`${e.objectId}`],Promise.resolve(void 0)}downloadFragment(e,t){let{parameters:r}=this,n=new ir(r.baseUrl,r.nodeKey).getKeyValueUrl(r.dataInstanceKey,`${e.fragmentId}.ngmesh`);return is(this.credentialsProvider,ii(n,r.user),{signal:t}).then(e=>e.arrayBuffer()).then(t=>(function(e,t){let r=new DataView(t).getUint32(0,!0);rW(e,rD(3,t,rS.LITTLE,4,r,void 0,void 0))})(e,t))}}ic=il([F()],ic);class id extends iu(na,ia.Yz){async download(e,t){let r;let n=this.parameters;{let t=this.computeChunkBounds(e),n=e.chunkDataSize;r=this.getPath(t,n)}let i=this.getDecoder(n),s=await is(this.credentialsProvider,ii(`${n.baseUrl}${r}`,n.user),{signal:t}).then(e=>e.arrayBuffer());await i(e,t,n.encoding===ia.ke.JPEG?s.slice(16):s)}getPath(e,t){let r=this.parameters;return r.encoding===ia.ke.JPEG?`/api/node/${r.nodeKey}/${r.dataInstanceKey}/subvolblocks/${t[0]}_${t[1]}_${t[2]}/${e[0]}_${e[1]}_${e[2]}`:r.encoding===ia.ke.RAW?`/api/node/${r.nodeKey}/${r.dataInstanceKey}/raw/0_1_2/${t[0]}_${t[1]}_${t[2]}/${e[0]}_${e[1]}_${e[2]}/jpeg`:r.encoding===ia.ke.COMPRESSED_SEGMENTATIONARRAY?`/api/node/${r.nodeKey}/${r.dataInstanceKey}/raw/0_1_2/${t[0]}_${t[1]}_${t[2]}/${e[0]}_${e[1]}_${e[2]}?compression=googlegzip&scale=${r.dataScale}`:`/api/node/${r.nodeKey}/${r.dataInstanceKey}/raw/0_1_2/${t[0]}_${t[1]}_${t[2]}/${e[0]}_${e[1]}_${e[2]}?compression=googlegzip`}getDecoder(e){return e.encoding===ia.ke.JPEG||e.encoding===ia.ke.RAW?ni:nA}}id=il([F()],id);var ig=r(3078),ip=r(6923);class iy{url;static RPC_ID="graphene/ChunkedGraphSource"}class im{manifestUrl;fragmentUrl;lod;sharding;nBitsForLayerId;static RPC_ID="graphene/MeshSource"}function iv(e,t){return 1n==e>>BigInt(64-t)}async function ib(e){if(e.response){let t;return"application/json"===e.response.headers.get("content-type")?(await e.response.json()).message:await e.response.text()}}function iw(e,t){let{store:r,path:n}=e.getKvStore(t);if(!(r instanceof ig.Z))throw Error(`Non-HTTP URL ${JSON.stringify(t)} not supported`);let{fetchOkImpl:i,baseUrl:s}=r;if(s.includes("?"))throw Error(`Invalid URL ${s}: query parameters not supported`);return{fetchOkImpl:i,baseUrl:(0,ip.Lj)(s,n)}}var iS=r(602);let iE=Symbol("objectId"),ik=0;class iI extends er{asyncMemoize;initialize(e){super.initialize(e)}freeSystemMemory(){this.asyncMemoize=void 0}}class iM extends en{constructor(e,t){super(e),this.registerDisposer(e),this.downloadFunction=t.get,this.encodeKeyFunction=t.encodeKey??ej.hd}encodeKeyFunction;downloadFunction;get(e,t){let r=this.encodeKeyFunction(e),n=this.chunks.get(r);return void 0===n&&((n=this.getNewChunk_(iI)).initialize(r),this.addChunk(n)),void 0===n.asyncMemoize&&(n.asyncMemoize=(0,X.E7)(async t=>{try{let{data:r,size:i}=await this.downloadFunction(e,t);return n.systemMemoryBytes=i,n.queueManager.updateChunkState(n,Y.SYSTEM_MEMORY_WORKER),r}catch(e){throw n.queueManager.updateChunkState(n,Y.FAILED),e}})),n.state===Y.SYSTEM_MEMORY_WORKER&&n.chunkManager.queueManager.markRecentlyUsed(n),n.asyncMemoize(t)}}function ix(e,t,r,n){return e.chunkManager.memoize.get(`getCachedDecodedUrl:${function(e){if(e instanceof Object){let t=e[iE];return void 0===t&&(t=e[iE]=ik++),`o${t}`}return""+JSON.stringify(e)}(r)}`,()=>{let t=new iM(e.chunkManager.addRef(),{get:async(t,n)=>{let i=await e.kvStoreContext.read(t,{...n,throwIfMissing:!0});try{return r(i,n)}catch(e){throw Error("Error reading ${url}",{cause:e})}}});return t.registerDisposer(e.addRef()),t}).get(t,n)}var iT=r(4758),iC=r(4634),iN=r(6985);function i$(e){return e^=e>>>16,e=Math.imul(e,0x85ebca6b),e^=e>>>13,e=Math.imul(e,0xc2b2ae35),e^=e>>>16}function iR(e,t){return e<<t|e>>>32-t}let iP=new Map([[iS.wC.MURMURHASH3_X86_128,e=>{let t,r,n,i,s,a;return t=0,n=0,i=0,r=0^Math.imul(iR(Math.imul(Number(e>>BigInt(32)),0xab0e9789),16),0x38b34ae5),t^=Math.imul(iR(Math.imul(Number(e&BigInt(0xffffffff)),0x239b961b),15),0xab0e9789),t^=8,r^=8,n^=8,i^=8,t=(t=(t=t+r>>>0)+n>>>0)+i>>>0,r=r+t>>>0,n=n+t>>>0,i=i+t>>>0,t=i$(t),r=i$(r),n=i$(n),i=i$(i),t=(t=(t=t+r>>>0)+n>>>0)+i>>>0,r=r+t>>>0,BigInt(t)|BigInt(r)<<BigInt(32)}],[iS.wC.IDENTITY,e=>e]]);function iU(e,t){return t===iS.qm.GZIP&&(e=new iC.Ll(e,"gzip")),e}class iO extends M.gj{base;sharding;minishardIndexCache;constructor(e,t,r){super(),this.base=t,this.sharding=r,this.minishardIndexCache=this.registerDisposer(new iM(e.addRef(),{encodeKey:e=>e.toString(),get:async(e,n)=>{let i=e&(1n<<BigInt(r.minishardBits))-1n,s=(1n<<BigInt(r.shardBits))-1n&e>>BigInt(r.minishardBits),a=t.path+s.toString(16).padStart(Math.ceil(r.shardBits/4),"0")+".shard",o=new iN.f2(t.store,a),l=BigInt(16)<<BigInt(r.minishardBits),u=await (0,iN.iT)(o,{...n,byteRange:{offset:Number(i<<4n),length:16},strictByteRange:!0});if(void 0===u)return{data:void 0,size:0};let h=new DataView(await u.response.arrayBuffer()),c=h.getBigUint64(0,!0),d=h.getBigUint64(8,!0);if(c===d)return{data:void 0,size:0};c+=l,d+=l;let f=await (await (0,iN.iT)(iU(new iT.uX(o,{offset:Number(c),length:Number(d-c)}),r.minishardIndexEncoding),{...n,strictByteRange:!0,throwIfMissing:!0})).response.arrayBuffer();if(f.byteLength%24!=0)throw Error(`Invalid minishard index length: ${f.byteLength}`);let g=new BigUint64Array(f);!function(e,t,r=rE){t!==r&&rM(e)}(g,rS.LITTLE);let p=g.byteLength/24,y=0n,m=l;for(let e=0;e<p;++e){let t=y+g[e];y=g[e]=t;let r=m+g[p+e];g[p+e]=r;let n=r+g[2*p+e];m=n,g[2*p+e]=n}return{data:{data:g,shardPath:a},size:g.byteLength}}}))}getUrl(e){return`chunk ${e} in ${this.base.store.getUrl(this.base.path)}`}async findKey(e,t){let{sharding:r}=this,n=iP.get(r.hash)(e>>BigInt(r.preshiftBits))&(1n<<BigInt(r.minishardBits+r.shardBits))-1n,i=await this.minishardIndexCache.get(n,t);if(void 0===i)return;let s=function(e,t){let r=e.data,n=r.length/3;for(let e=0;e<n;++e){if(r[e]!==t)continue;let i=r[n+e],s=r[2*n+e];return{offset:Number(i),length:Number(s-i)}}}(i,e);if(void 0!==s)return{minishardEntry:s,shardInfo:{shardPath:i.shardPath,offset:s.offset}}}async readWithShardInfo(e,t){let{sharding:r}=this,n=await this.findKey(e,t);if(void 0===n)return;let{minishardEntry:i,shardInfo:s}=n;return{response:await iU(new iT.uX(new iN.f2(this.base.store,s.shardPath),i),r.dataEncoding).read(t),shardInfo:s}}async stat(e,t){let r=await this.findKey(e,t);if(void 0===r)return;let{sharding:n}=this;return n.dataEncoding!==iS.qm.RAW?{totalSize:void 0}:{totalSize:r.minishardEntry.length}}async read(e,t){let r=await this.readWithShardInfo(e,t);if(void 0!==r)return r.response}get supportsOffsetReads(){return this.sharding.dataEncoding===iS.qm.RAW}get supportsSuffixReads(){return this.sharding.dataEncoding===iS.qm.RAW}}function iA(e,t,r){if(void 0!==r)return e.registerDisposer(new iO(e.chunkManager,t,r))}let i_=0,iL={emscripten_notify_memory_growth:e=>{},neuroglancer_draco_receive_decoded_mesh:(e,t,r,i,a)=>{let o=n.exports.memory,l=new Uint32Array(o.buffer,r,3*e).slice(),u=new Uint32Array(o.buffer,i,3*t).slice();s={indices:l,vertexPositions:u,subChunkOffsets:new Uint32Array(o.buffer,a,i_+1).slice()}},proc_exit:e=>{throw`proc exit: ${e}`}};function iD(){return void 0==i&&(i=(async()=>{let e=n=(await WebAssembly.instantiateStreaming(fetch(new URL(r(8522),r.b)),{env:iL,wasi_snapshot_preview1:iL})).instance;return e.exports._initialize(),e})()),i}async function iz(e,t,r){let n=await iD(),i=n.exports.malloc(e.byteLength);new Uint8Array(n.exports.memory.buffer).set(e,i),i_=r?8:1;let a=n.exports.neuroglancer_draco_decode(i,e.byteLength,r,t,!0);if(0===a){let e=s;if(s=void 0,e instanceof Error)throw e;return e}throw Error(`Failed to decode draco mesh: ${a}`)}async function iB(e){let t=await iD(),r=t.exports.malloc(e.byteLength);new Uint8Array(t.exports.memory.buffer).set(e,r);let n=t.exports.neuroglancer_draco_decode(r,e.byteLength,!1,0,!1);if(0===n){let e=s;if(s=void 0,e instanceof Error)throw e;return e.vertexPositions=new Float32Array(e.vertexPositions.buffer),e}throw Error(`Failed to decode draco mesh: ${n}`)}let ij={id:"decodeCompresso"};async function iF(e,t,r){let n=await r5(ij,t,[r],new Uint8Array(r));await n_(e,t,n.buffer)}let iV={id:"decodeJxl"};async function iG(e,t,r){let n=e.chunkDataSize,{uint8Array:i}=await r5(iV,t,[r],new Uint8Array(r),n[0]*n[1]*n[2],n[3]||1,1);await r9(e,t,i)}async function iK(e,t,r){let n=e.chunkDataSize,i=e.source.spec.dataType,{uint8Array:s}=await r5(n7,t,[r],new Uint8Array(r),void 0,void 0,n[0]*n[1]*n[2],n[3]||1,e7[i],!1);await n_(e,t,s.buffer)}function iY(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}function iq(e){if(void 0===e)throw Error("not found");return e}let iJ=new Map;iJ.set(iS.ke.RAW,n_),iJ.set(iS.ke.JPEG,ni),iJ.set(iS.ke.COMPRESSED_SEGMENTATION,nA),iJ.set(iS.ke.COMPRESSO,iF),iJ.set(iS.ke.PNG,iK),iJ.set(iS.ke.JXL,iG);class iW extends ey(eP(na),iS.Yz){chunkDecoder=iJ.get(this.parameters.encoding);kvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.url);shardedKvStore=iA(this,this.kvStore,this.parameters.sharding);gridShape=(()=>{let e=new Uint32Array(3),{upperVoxelBound:t,chunkDataSize:r}=this.spec;for(let n=0;n<3;++n)e[n]=Math.ceil(t[n]/r[n]);return e})();async download(e,t){let r;let{shardedKvStore:n}=this;if(void 0===n){let n;let{kvStore:i}=this;{let t=this.computeChunkBounds(e),r=e.chunkDataSize;n=`${i.path}${t[0]}-${t[0]+r[0]}_${t[1]}-${t[1]+r[1]}_${t[2]}-${t[2]+r[2]}`}r=await i.store.read(n,{signal:t})}else{this.computeChunkBounds(e);let{gridShape:i}=this,{chunkGridPosition:s}=e,a=Math.ceil(Math.log2(i[0])),o=rC(a,Math.ceil(Math.log2(i[1])),Math.ceil(Math.log2(i[2])),s[0],s[1],s[2]);r=await n.read(o,{signal:t})}void 0!==r&&await this.chunkDecoder(e,t,await r.response.arrayBuffer())}}function iZ(e,t){return rA(e,t,"fragments")}iW=iY([F()],iW);class iX extends ey(eP(rz),iS.i6){kvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.url);async download(e,t){let{parameters:r,kvStore:n}=this,i=await (0,iN.BF)(n.store,`${n.path}${e.objectId}:${r.lod}`,{signal:t,throwIfMissing:!0});iZ(e,await i.response.json())}async downloadFragment(e,t){let{kvStore:r}=this,n=await (0,iN.BF)(r.store,`${r.path}${e.fragmentId}`,{signal:t,throwIfMissing:!0});!function(e,t){let r=new DataView(t).getUint32(0,!0);rW(e,rD(3,t,rS.LITTLE,4,r,void 0,void 0))}(e,await n.response.arrayBuffer())}}async function iQ(e,t){let{lod:r}=e,n=e.manifestChunk.source;rZ(e,await iz(new Uint8Array(t),n.parameters.metadata.vertexQuantizationBits,0!==r),n.format.vertexPositionFormat)}iX=iY([F()],iX);class iH extends ey(eP(rG),iS.f5){kvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.url);shardedKvStore=iA(this,this.kvStore,this.parameters.metadata.sharding);async download(e,t){let r;let{shardedKvStore:n}=this;if(void 0===n){let{kvStore:n}=this;r=await n.store.read(`${n.path}${e.objectId}.index`,{signal:t})}else({response:r,shardInfo:e.shardInfo}=iq(await n.readWithShardInfo(e.objectId,{signal:t})));!function(e,t){let r;if(t.byteLength<28||t.byteLength%4!=0)throw Error(`Invalid index file size: ${t.byteLength}`);let n=new DataView(t),i=0,s=eB.R3.fromValues(n.getFloat32(i,!0),n.getFloat32(i+4,!0),n.getFloat32(i+8,!0));i+=12;let a=eB.R3.fromValues(n.getFloat32(i,!0),n.getFloat32(i+4,!0),n.getFloat32(i+8,!0));i+=12;let o=n.getUint32(i,!0);if(i+=4,t.byteLength<i+20*o)throw Error(`Invalid index file size for ${o} lods: ${t.byteLength}`);let l=new Float32Array(t,i,o);i+=4*o,rx(l,rS.LITTLE);let u=new Float32Array(t,i,3*o);rx(u,rS.LITTLE);let h=new Uint32Array(t,i+=12*o,o);i+=4*o,rx(h,rS.LITTLE);let c=h.reduce((e,t)=>e+t);if(t.byteLength!==i+16*c)throw Error(`Invalid index file size for ${o} lods and ${c} total fragments: ${t.byteLength}`);let d=new Uint32Array(t,i);rx(d,rS.LITTLE);let f=eB.R3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),g=eB.R3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),p=Math.max(1,l.length);{let e=0;for(let t=0;t<o;++t){let r=h[t];for(let n=0;n<3;++n){let i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,a=e+r*n;for(let e=0;e<r;++e){let t=d[a+e];i=Math.max(i,t),s=Math.min(s,t)}if(0!==r){for(;i>>>p-t-1!=s>>>p-t-1;)++p;0===t&&(f[n]=Math.min(f[n],(1<<t)*s),g[n]=Math.max(g[n],(1<<t)*(i+1)))}}e+=4*r}}let y=0;{let e=0,t=0;for(let r=0;r<o;++r){let n=h[r];y+=e*(r-t),t=r,e=n,y+=n}y+=(p-1-t)*e}let m=new Uint32Array(5*y),v=new Float64Array(y+1);{let t=0,n=0,i=0,s=0;for(let e=0;e<o;++e){let r=h[e];for(let e=0;e<r;++e){for(let t=0;t<3;++t)m[5*(n+e)+t]=d[s+e+t*r];let t=d[s+e+3*r];i+=t,v[n+e+1]=i,0===t&&(m[5*(n+e)+4]=0x80000000)}for(s+=4*r,0!==e&&function(e,t,r,n){let i=t;for(let t=r;t<n;++t){let n=e[5*t],s=e[5*t+1],a=e[5*t+2];for(;i<r;){let t=e[5*i]>>>1;if(!rN(t,e[5*i+1]>>>1,e[5*i+2]>>>1,n,s,a))break;++i}for(e[5*t+3]=i;i<r;){let t=e[5*i]>>>1,r=e[5*i+1]>>>1,o=e[5*i+2]>>>1;if(t!==n||r!==s||o!==a)break;++i}e[5*t+4]+=i}}(m,t,n,n+r),t=n,n+=r;e+1<p&&(e+1>=l.length||0===l[e+1]);){let r=rX(m,t,n);v.fill(i,n+1,r+1),t=n,n=r,++e}}r=m.slice(0,5*n),e.offsets=v.slice(0,n+1)}let{lodScaleMultiplier:b}=e.source.parameters.metadata,w=new Float32Array(p);w.set(l,0);for(let e=0;e<l.length;++e)w[e]*=b;e.manifest={chunkShape:s,chunkGridSpatialOrigin:a,clipLowerBound:eB.R3.add(f,a,eB.R3.multiply(f,f,s)),clipUpperBound:eB.R3.add(g,a,eB.R3.multiply(g,g,s)),octree:r,lodScales:w,vertexOffsets:u}}(e,await iq(r).response.arrayBuffer())}async downloadFragment(e,t){let r,n,i;let{kvStore:s}=this,a=e.manifestChunk,o=e.chunkIndex,{shardInfo:l,offsets:u}=a,h=u[o],c=u[o+1];if(void 0!==l){r=l.shardPath;let e=u[u.length-1],t=l.offset-e+h,s=t+c-h;n=t,i=s}else r=`${s.path}${a.objectId}`,n=h,i=c;let d=await (0,iN.BF)(s.store,r,{signal:t,byteRange:{offset:n,length:i-n},throwIfMissing:!0,strictByteRange:!0});await iQ(e,await d.response.arrayBuffer())}}async function i0(e,t,r){let{shardedKvStore:n}=e;if(void 0!==n)return n.read(t,{signal:r});{let{kvStore:n}=e;return n.store.read(`${n.path}${t}`,{signal:r})}}iH=iY([F()],iH);class i1 extends ey(eP(nP),iS.zT){kvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.url);shardedKvStore=iA(this,this.kvStore,this.parameters.metadata.sharding);async download(e,t){let{parameters:r}=this,n=iq(await i0(this,e.objectId,t));!function(e,t,r){let n=new DataView(t),i=n.getUint32(0,!0),s=n.getUint32(4,!0),a=8+12*i;nO(e,t,rS.LITTLE,8,i,a,s),a+=8*s;let o=[];for(let e of r.values()){let r=e7[e.dataType]*e.numComponents,n=r*i,s=new Uint8Array(t,a,n);switch(r){case 2:!function(e,t,r=rE){t!==r&&rk(e)}(s,rS.LITTLE);break;case 4:case 8:rx(s,rS.LITTLE)}o.push(s),a+=n}e.vertexAttributes=o}(e,await n.response.arrayBuffer(),r.metadata.vertexAttributes)}}function i2(e,t,r){let n;let i=new DataView(e);if(e.byteLength<=8)throw Error("Expected at least 8 bytes");let s=i.getUint32(0,!0);if(0!==i.getUint32(4,!0))throw Error("Annotation count too high");let a=r.serializedBytes,o=8+(a+8)*s;if(e.byteLength!==o)throw Error(`Expected ${o} bytes, but received: ${e.byteLength} bytes`);let l=8+a*s,u=Array(s);for(let e=0;e<s;++e)u[e]=i.getBigUint64(l+8*e,!0).toString();let h=new ra,c=new Uint8Array(e,8,a*s),{propertyGroupBytes:d}=r;if(d.length>1){n=new Uint8Array(c.length);let e=0,t=0;for(let r=0;r<d.length;++r){let i=d[r];for(let r=0;r<s;++r){let s=e+r*a,o=t+r*i;for(let e=0;e<i;++e)n[o+e]=c[s+e]}e+=i,t+=i*s}}else n=c;h.data=n;let f=h.typeToOffset=Array(nv.length);f.fill(0),f[t.type]=0;let g=h.typeToIds=Array(nv.length),p=h.typeToIdMaps=Array(nv.length);return g.fill([]),g[t.type]=u,p.fill(new Map),p[t.type]=new Map(u.map((e,t)=>[e,t])),h}i1=iY([F()],i1);class i3 extends ey(eP(rc),iS.WM){kvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.url);shardedKvStore=iA(this,this.kvStore,this.parameters.sharding);async download(e,t){let r;let{shardedKvStore:n}=this,{parent:i}=this,{chunkGridPosition:s}=e;if(void 0===n){let{kvStore:e}=this,n=`${e.path}${s.join("_")}`;r=await e.store.read(n,{signal:t})}else{let{upperChunkBound:i}=this.spec,{chunkGridPosition:s}=e,a=function(e,t){let r=0n,n=0,i=e.length;for(let s=0;s<32;++s)for(let a=0;a<i;++a)if(t[a]-1>>>s)r|=BigInt(1&e[a]>>>s)<<BigInt(n++);return r}(s,i);r=await n.read(a,{signal:t})}void 0!==r&&(e.data=i2(await r.response.arrayBuffer(),i.parameters,i.annotationPropertySerializer))}}i3=iY([F()],i3);class i6 extends ey(eP(rf),iS.Jb){kvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.byId.url);shardedKvStore=iA(this,this.kvStore,this.parameters.byId.sharding);relationshipIndexSource=this.parameters.relationships.map(e=>{let t=this.sharedKvStoreContext.kvStoreContext.getKvStore(e.url),r=iA(this,t,e.sharding);return{kvStore:t,shardedKvStore:r}});annotationPropertySerializer=new nw(this.parameters.rank,nM[this.parameters.type].serializedBytes(this.parameters.rank),this.parameters.properties);async downloadSegmentFilteredGeometry(e,t,r){let n=await i0(this.relationshipIndexSource[t],e.objectId,r);void 0!==n&&(e.data=i2(await n.response.arrayBuffer(),this.parameters,this.annotationPropertySerializer))}async downloadMetadata(e,t){let r=BigInt(e.key),n=await i0(this,r,t);void 0===n?e.annotation=null:e.annotation=function(e,t,r,n){let i=nM[t.type],s=r.serializedBytes,a=t.relationships.length,o=s+4*a;if(e.byteLength<o)throw Error(`Expected at least ${o} bytes, but received: ${e.byteLength}`);let l=new DataView(e),u=i.deserialize(l,0,!0,t.rank,n);r.deserialize(l,0,0,1,!0,u.properties=Array(t.properties.length));let h=s,c=u.relatedSegments=[];c.length=a;for(let t=0;t<a;++t){let r=l.getUint32(h,!0);if(e.byteLength<o+8*r)throw Error(`Expected at least ${o} bytes, but received: ${e.byteLength}`);h+=4;let n=c[t]=new BigUint64Array(r);for(let e=0;e<r;++e)n[e]=l.getBigUint64(h,!0),h+=8}if(h!==e.byteLength)throw Error(`Expected ${h} bytes, but received: ${e.byteLength}`);return u}(await n.response.arrayBuffer(),this.parameters,this.annotationPropertySerializer,e.key)}}function i4(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}async function i8(e,t){rW(e,await iB(t))}i6=iY([F()],i6);class i5 extends ey(eP(rz),im){manifestRequestCount=new Map;newSegments=new t4;manifestHttpSource=iw(this.sharedKvStoreContext.kvStoreContext,this.parameters.manifestUrl);fragmentKvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.fragmentUrl);addNewSegment(e){let{newSegments:t}=this;t.add(e),setTimeout(()=>{t.delete(e)},6e5)}async download(e,t){let{parameters:r,newSegments:n,manifestRequestCount:i}=this;if(iv(e.objectId,r.nBitsForLayerId))return iZ(e,{fragments:[]});let{fetchOkImpl:s,baseUrl:a}=this.manifestHttpSource,o=`/manifest/${e.objectId}:${r.lod}?verify=1&prepend_seg_ids=1`,l=await (await s(a+o,{signal:t})).json();if(n.has(e.objectId)){let t=(i.get(o)??0)+1;i.set(o,t),setTimeout(()=>{this.chunkManager.queueManager.updateChunkState(e,Y.QUEUED)},2**t*1e3)}else i.delete(o);return iZ(e,l)}async downloadFragment(e,t){var r,n;let{response:i}=await (r=this.fragmentKvStore,n=e.fragmentId,this.parameters.sharding?function(e,t,r){if(t&&"~"===t.charAt(0)){let n=t.substring(1).split(":"),i={offset:Number(n[1]),length:Number(n[2])};return(0,iN.BF)(e.store,`${e.path}initial/${n[0]}`,{signal:r,byteRange:i,throwIfMissing:!0})}return(0,iN.BF)(e.store,`${e.path}dynamic/${t}`,{signal:r,throwIfMissing:!0})}(r,n,t):(0,iN.BF)(r.store,`${r.path}/${n}`,{signal:t,throwIfMissing:!0}));await i8(e,new Uint8Array(await i.arrayBuffer()))}getFragmentKey(e,t){return function(e){if("~"===e.charAt(0)){let t=e.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}return{key:e,fragmentId:e}}(t)}}i5=i4([F()],i5);class i9 extends er{chunkGridPosition;source=null;segment;leaves=new BigUint64Array(0);chunkDataSize;initializeVolumeChunk(e,t){super.initialize(e),this.chunkGridPosition=Float32Array.from(t)}initializeChunkedGraphChunk(e,t,r){this.initializeVolumeChunk(e,t),this.chunkDataSize=null,this.systemMemoryBytes=16,this.gpuMemoryBytes=0,this.segment=r}downloadSucceeded(){this.systemMemoryBytes=16,this.systemMemoryBytes+=this.leaves.byteLength,this.queueManager.updateChunkState(this,Y.SYSTEM_MEMORY_WORKER),this.priorityTier<q.RECENT&&this.source.chunkManager.scheduleUpdateChunkPriorities(),super.downloadSucceeded()}freeSystemMemory(){this.leaves=new BigUint64Array(0)}}class i7 extends ey(eP(es),iy){spec;tempChunkDataSize;tempChunkPosition;httpSource=iw(this.sharedKvStoreContext.kvStoreContext,this.parameters.url);constructor(e,t){super(e,t),this.spec=t.spec;let r=this.spec.rank;this.tempChunkDataSize=new Uint32Array(r),this.tempChunkPosition=new Float32Array(r)}async download(e,t){let r=this.computeChunkBounds(e),n=e.chunkDataSize,i=`${r[0]}-${r[0]+n[0]}_${r[1]}-${r[1]+n[1]}_${r[2]}-${r[2]+n[2]}`,{fetchOkImpl:s,baseUrl:a}=this.httpSource,o=s(`${a}/${e.segment}/leaves?int64_as_str=1&bounds=${i}`,{signal:t});await this.withErrorMessage(o,`Fetching leaves of segment ${e.segment} in region ${i}: `).then(e=>e.json()).then(t=>{var r;e.leaves=(r=t.leaf_ids,BigUint64Array.from(r,ej.tw))}).catch(e=>{e instanceof Error&&"AbortError"===e.name||console.error(e)})}getChunk(e,t){let r=`${(0,eB.m0)(e)}-${t}`,n=this.chunks.get(r);return void 0===n&&((n=this.getNewChunk_(i9)).initializeChunkedGraphChunk(r,e,t),this.addChunk(n)),n}computeChunkBounds(e){return ns(this,e)}async withErrorMessage(e,t){return e.catch(async e=>{if(e instanceof rm.oo&&e.response){let r=await ib(e);throw Error(`[${e.response.status}] ${t}${r??""}`)}throw e})}}i7=i4([F()],i7);let se=eB.R3.create(),st=eB.R3.create(),sr=eB.R3.create();class sn extends rn(tp(em(eA))){source;localPosition;leafRequestsActive;nBitsForLayerId;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.localPosition=e.get(t.localPosition),this.leafRequestsActive=e.get(t.leafRequestsActive),this.nBitsForLayerId=e.get(t.nBitsForLayerId),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities(),this.debouncedupdateDisplayState()}))}attach(e){let t=()=>this.chunkManager.scheduleUpdateChunkPriorities(),{view:r}=e;e.registerDisposer(t),e.registerDisposer(r.projectionParameters.changed.add(t)),e.registerDisposer(r.visibility.changed.add(t)),e.state={displayDimensionRenderInfo:r.projectionParameters.value.displayDimensionRenderInfo}}get renderRatioLimit(){return 5}updateChunkPriorities(){let{source:e,chunkManager:t}=this;for(let r of(t.registerLayer(this),this.attachments.values())){let{view:n}=r,i=n.visibility.value;if(i===Number.NEGATIVE_INFINITY)continue;let{transformedSource:s}=r.state,a=n.projectionParameters.value;if(!s)continue;let o=1.1*a.pixelSize,l=s.effectiveVoxelSize;if(this.leafRequestsActive.value=this.renderRatioLimit>=o/Math.min(...l),!this.leafRequestsActive.value)continue;let u=ty(i),h=tm(i),{chunkLayout:c}=s,{size:d,finiteRank:f}=c;eB.R3.copy(sr,d);for(let e=f;e<3;++e)sr[e]=0,st[e]=0;let{centerDataPosition:g}=a;c.globalToLocalSpatial(st,g),td(a,this.localPosition.value,s,tf(a,c),r=>{eB.R3.multiply(se,r,sr);let n=-eB.R3.distance(st,se),{curPositionInChunks:i}=s;rt(this,(r,s)=>{if(iv(r,this.nBitsForLayerId.value))return;let a=e.getChunk(i,r);t.requestChunk(a,u,h+n,Y.SYSTEM_MEMORY_WORKER),++this.numVisibleChunksNeeded,a.state===Y.GPU_MEMORY&&++this.numVisibleChunksAvailable})})}}forEachSelectedRootWithLeaves(e){let{source:t}=this;for(let r of t.chunks.values())r.state===Y.SYSTEM_MEMORY_WORKER&&r.priorityTier<q.RECENT&&this.visibleSegments.has(r.segment)&&r.leaves.length&&e(r.segment,r.leaves)}debouncedupdateDisplayState=(0,e6.Z)(()=>{this.updateDisplayState()},100);updateDisplayState(){let e=new Map,t=new Map;for(let[r,n]of(this.forEachSelectedRootWithLeaves((e,r)=>{t.set(e,(t.get(e)??0)+r.length)}),this.forEachSelectedRootWithLeaves((r,n)=>{e.has(r)||(e.set(r,new t4),e.get(r).reserve(t.get(r)),e.get(r).add(r)),e.get(r).add(n)}),e))for(let e of[...n].filter(e=>!this.segmentEquivalences.has(e)))this.segmentEquivalences.link(r,e)}}sn=i4([F("ChunkedGraphLayer")],sn),O("ChunkedGraphLayer:updateSources",function(e){let t=this.get(e.view),r=this.get(e.layer),n=r.attachments.get(t);n.state.transformedSource=tM(this,e.sources,r)[0][0],n.state.displayDimensionRenderInfo=e.displayDimensionRenderInfo,r.chunkManager.scheduleUpdateChunkPriorities()}),O("GrapheneMeshSource:NewSegment",function(e){this.get(e.rpcId).addNewSegment(e.segment)});let si={id:"decodeBlosc"},ss={id:"decodeZstd"};var sa=r(835);async function so(e,t,r,n){let i=new DataView(r),s=i.getUint16(0,!1);if(0!==s)throw Error(`Unsupported mode: ${s}.`);let a=i.getUint16(2,!1);if(a!==e.source.spec.rank)throw Error("Number of dimensions must be 3.");let o=4,l=new Uint32Array(a);for(let e=0;e<a;++e)l[e]=i.getUint32(o,!1),o+=4;e.chunkDataSize=l;let u=new Uint8Array(r,o);switch(n){case sa.k.ZLIB:u=new Uint8Array(await (0,r7.lL)(u,"deflate"));break;case sa.k.GZIP:u=new Uint8Array(await (0,r7.lL)(u,"gzip"));break;case sa.k.BLOSC:u=await r5(si,t,[u.buffer],u);break;case sa.k.ZSTD:u=await r5(ss,t,[u.buffer],u)}await n_(e,t,u.buffer,rS.BIG,u.byteOffset,u.byteLength)}class sl extends ey(eP(na),sa.Y){chunkKvStore=this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.url);async download(e,t){let{parameters:r,chunkKvStore:n}=this,{chunkGridPosition:i}=e,s=n.path,a=this.spec.rank;for(let e=0;e<a;++e)0!==e&&(s+="/"),s+=`${i[e]}`;let o=await n.store.read(s,{signal:t});void 0!==o&&await so(e,t,await o.response.arrayBuffer(),r.encoding)}}sl=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F()],sl);var su=r(8551),sh=r(2147),sc=r(3853);class sd{uncompressedData;header}async function sf(e,t){let r=await e.response.arrayBuffer();(0,su.isCompressed)(r)&&(r=await (0,r7.lL)(r,"gzip",t.signal));let n=new sd;n.uncompressedData=r;let i=(0,su.readHeader)(r);if(null===i)throw Error("Failed to parse NIFTI header.");return n.header=i,{data:n,size:r.byteLength}}async function sg(e,t,r){return(await ix(e,t,sf,r)).header}var sp=((y=sp||{})[y.NONE=0]="NONE",y[y.BINARY=1]="BINARY",y[y.UINT8=2]="UINT8",y[y.INT16=4]="INT16",y[y.INT32=8]="INT32",y[y.FLOAT32=16]="FLOAT32",y[y.COMPLEX64=32]="COMPLEX64",y[y.FLOAT64=64]="FLOAT64",y[y.RGB24=128]="RGB24",y[y.INT8=256]="INT8",y[y.UINT16=512]="UINT16",y[y.UINT32=768]="UINT32",y[y.INT64=1024]="INT64",y[y.UINT64=1280]="UINT64",y[y.FLOAT128=1536]="FLOAT128",y[y.COMPLEX128=1792]="COMPLEX128",y[y.COMPLEX256=2048]="COMPLEX256",y);let sy=new Map([[256,{dataType:e9.INT8}],[2,{dataType:e9.UINT8}],[4,{dataType:e9.INT16}],[512,{dataType:e9.UINT16}],[8,{dataType:e9.INT32}],[768,{dataType:e9.UINT32}],[1024,{dataType:e9.UINT64}],[1280,{dataType:e9.UINT64}],[16,{dataType:e9.FLOAT32}]]);_(sh._,async function(e,t){var r;let n=this.get(e.sharedKvStoreContext),i=await sg(n,e.url,t),s=sy.get(i.datatypeCode);if(void 0===s)throw Error(`Unsupported data type: ${sp[i.datatypeCode]||i.datatypeCode}.`);let a=1,o="";switch(i.xyzt_units&su.NIFTI1.SPATIAL_UNITS_MASK){case su.NIFTI1.UNITS_METER:a=1,o="m";break;case su.NIFTI1.UNITS_MM:a=1e3,o="m";break;case su.NIFTI1.UNITS_MICRON:a=1e6,o="m"}let l="",u=1;switch(i.xyzt_units&su.NIFTI1.TEMPORAL_UNITS_MASK){case su.NIFTI1.UNITS_SEC:l="s",u=1;break;case su.NIFTI1.UNITS_MSEC:l="s",u=1e3;break;case su.NIFTI1.UNITS_USEC:l="s",u=1e6;break;case su.NIFTI1.UNITS_HZ:l="Hz",u=1;break;case su.NIFTI1.UNITS_RADS:l="rad/s",u=1}let h=[o,o,o,l,"","",""],c=Float64Array.of(i.pixDims[1]/a,i.pixDims[2]/a,i.pixDims[3]/a,i.pixDims[4]/u,i.pixDims[5],i.pixDims[6],i.pixDims[7]),d=Float64Array.of(1/a,1/a,1/a,1/u,1,1,1),f=["i","j","k","m","c^","c1^","c2^"],g=["x","y","z","t","c^","c1^","c2^"],p=i.dims[0];f=f.slice(0,p),g=g.slice(0,p),h=h.slice(0,p),c=c.slice(0,p),d=d.slice(0,p);let{quatern_b:y,quatern_c:m,quatern_d:v}=i,b=Math.sqrt(1-y*y-m*m-v*v),w=-1===i.pixDims[0]?-1:1,S=eB.R3.fromValues(i.qoffset_x,i.qoffset_y,i.qoffset_z);r=i.affine,eB._E.fromValues(r[0][0],r[1][0],r[2][0],r[3][0],r[0][1],r[1][1],r[2][1],r[3][1],r[0][2],r[1][2],r[2][2],r[3][2],r[0][3],r[1][3],r[2][3],r[3][3]);let E=(0,eB.Fi)(eB._E.create(),S,eB.gf.fromValues(y,m,v,b),eB.rn,w),k=sc.XD(Float64Array,p+1),I=Math.min(3,p);for(let e=0;e<I;++e){for(let t=0;t<I;++t)k[t*(p+1)+e]=E[4*t+e];k[p*(p+1)+e]=E[12+e]}return{value:{rank:p,sourceNames:f,viewNames:g,units:h,sourceScales:c,viewScales:d,description:i.description,transform:k,dataType:s.dataType,volumeSize:Uint32Array.from(i.dims.slice(1,1+p))}}});class sm extends ey(eP(na),sh.L){async download(e,t){var r;e.chunkDataSize=this.spec.chunkDataSize;let n=await (r=this.sharedKvStoreContext,ix(r,this.parameters.url,sf,{signal:t})),i=(0,su.readImage)(n.header,n.uncompressedData);await n_(e,t,i,n.header.littleEndian?rS.LITTLE:rS.BIG)}}sm=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F()],sm);let sv={id:"parseOBJFromArrayBuffer"};var sb=r(8956);function sw(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}class sS extends er{data=null;freeSystemMemory(){this.data=null}serialize(e,t){super.serialize(e,t);let{vertexPositions:r,indices:n,vertexNormals:i,vertexAttributes:s}=this.data;e.vertexPositions=r,e.indices=n,e.vertexNormals=i,e.vertexAttributes=s;let a=new Set;for(let e of(a.add(r.buffer),a.add(n.buffer),a.add(i.buffer),s))a.add(e.buffer);t.push(...a),this.data=null}downloadSucceeded(){let{vertexPositions:e,indices:t,vertexNormals:r,vertexAttributes:n}=this.data,i=this.gpuMemoryBytes=e.byteLength+t.byteLength+r.byteLength;for(let e of n)i+=e.byteLength;this.systemMemoryBytes=this.gpuMemoryBytes=i,super.downloadSucceeded()}}let sE=new Map,sk=/^(?:([a-zA-Z-+_]+):\/\/)?(.*)$/;function sI(e,t,r){return function(e,t,r){let[n,i]=function(e,t){let r=t.match(sk);if(null===r||void 0===r[1])throw Error('Data source URL must have the form "<protocol>://<path>".');let n=r[1],i=e.get(n);if(void 0===i)throw Error(`Unsupported data source: ${JSON.stringify(n)}.`);return[i,r[2],n]}(sE,t);return n.getMesh(e,i,r)}(e,t.meshSourceUrl,r)}class sM extends ey(eP(es),sb.J6){getChunk(){let e=sb.Sk,t=this.chunks.get(e);return void 0===t&&((t=this.getNewChunk_(sS)).initialize(e),this.addChunk(t)),t}async download(e,t){let r=await sI(this.sharedKvStoreContext,this.parameters,{signal:t});if((0,ej.hd)(r.info)!==(0,ej.hd)(this.parameters.info))throw Error("Mesh info has changed.");void 0===r.vertexNormals&&(r.vertexNormals=r_(r.vertexPositions,r.indices)),e.data=r}}sM=sw([F()],sM);let sx=tp(em(B));class sT extends sx{source;constructor(e,t){super(e,t),this.source=this.registerDisposer(e.getRef(t.source)),this.registerDisposer(this.chunkManager.recomputeChunkPriorities.add(()=>{this.updateChunkPriorities()}))}updateChunkPriorities(){let e=this.visibility.value;if(e===Number.NEGATIVE_INFINITY)return;let t=ty(e),r=tm(e),{source:n,chunkManager:i}=this,s=n.getChunk();i.requestChunk(s,t,r+50)}}async function sC(e,t){let r=await e.response.arrayBuffer();return r5(sv,t.signal,[r],r)}sT=sw([F(sb.V4)],sT),_(sb.Wl,async function(e,t){let r=this.get(e.sharedKvStoreContext),n=e.parameters;return{value:(await sI(r,n,t)).info}}),m={description:"OBJ",getMesh:(e,t,r)=>ix(e,t,sC,r)},sE.set("obj",m);var sN=r(3074);let s$=new Map;s$.set("jpg",async(e,t,r)=>{let n=e.chunkDataSize,{uint8Array:i}=await r5(nn,t,[r],new Uint8Array(r),void 0,void 0,n[0]*n[1]*n[2],3,!0);await r9(e,t,i)}),s$.set("png",async(e,t,r)=>{let n=e.chunkDataSize,{uint8Array:i}=await r5(n7,t,[r],new Uint8Array(r),n[0],n[1],n[0]*n[1]*n[2],4,1,!1);await r9(e,t,i)}),s$.set("png16",async(e,t,r)=>{let n=e.chunkDataSize,{uint8Array:i}=await r5(n7,t,[r],new Uint8Array(r),n[0],n[1],n[0]*n[1]*n[2],1,2,!1);await r9(e,t,i)}),s$.set("raw16",(e,t,r)=>n_(e,t,r,rS.BIG));class sR extends ey(na,sN.xd){chunkDecoder=s$.get(this.parameters.encoding);queryString=(()=>{let{parameters:e}=this,t=new URLSearchParams;for(let[r,n]of(void 0!==e.channel&&t.append("channel",e.channel),Object.entries(e.renderArgs)))t.append(r,n);return t.toString()})();async download(e,t){let r;let{parameters:n}=this,{chunkGridPosition:i}=e,s=1/2**n.level;e.chunkDataSize=this.spec.chunkDataSize;let a=e.chunkDataSize[0]*2**n.level,o=e.chunkDataSize[1]*2**n.level,l=eB.R3.create();l[0]=i[0]*a,l[1]=i[1]*o,l[2]=i[2],r="raw16"===n.encoding?"raw16-image":"png16"===n.encoding?"png16-image":"png"===n.encoding?"png-image":"jpeg-image";let u=`/render-ws/v1/owner/${n.owner}/project/${n.project}/stack/${n.stack}/z/${l[2]}/box/${l[0]},${l[1]},${a},${o},${s}/${r}`,h=await (0,rm.ru)(`${n.baseUrl}${u}?${this.queryString}`,{signal:t});await this.chunkDecoder(e,t,await h.arrayBuffer())}}sR=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F()],sR);let sP={id:"parseVTKFromArrayBuffer"};async function sU(e,t){let r=await e.response.arrayBuffer();return r5(sP,t.signal,[r],r)}v={description:"VTK",getMesh:async(e,t,r)=>{let n=await ix(e,t,sU,r),i={info:{numTriangles:n.numTriangles,numVertices:n.numVertices,vertexAttributes:[]},indices:n.indices,vertexPositions:n.vertexPositions,vertexAttributes:[]};for(let e of n.vertexAttributes)i.info.vertexAttributes.push({name:e.name,dataType:e9.FLOAT32,numComponents:e.numComponents}),i.vertexAttributes.push(e.data);return i}},sE.set("vtk",v);var sO=r(6363);let sA={[sO.i.arrayToArray]:new Map,[sO.i.arrayToBytes]:new Map,[sO.i.bytesToBytes]:new Map,sharding:new Map};function s_(e){e.kind===sO.i.arrayToBytes&&"getShardedKvStore"in e?sA.sharding.set(e.name,e):sA[e.kind].set(e.name,e)}async function sL(e,t,r){let n;let i=e[sO.i.bytesToBytes];for(let e=i.length;e--;){let n=i[e],s=sA[sO.i.bytesToBytes].get(n.name);if(void 0===s)throw Error(`Unsupported codec: ${JSON.stringify(n.name)}`);t=await s.decode(n.configuration,t,r)}{let i=e[sO.i.arrayToBytes],s=sA[sO.i.arrayToBytes].get(i.name);if(void 0===s)throw Error(`Unsupported codec: ${JSON.stringify(i.name)}`);n=await s.decode(i.configuration,e.arrayInfo[e.arrayInfo.length-1],t,r)}let s=e[sO.i.arrayToArray];for(let t=s.length;t--;){let i=s[t],a=sA[sO.i.arrayToArray].get(i.name);if(void 0===a)throw Error(`Unsupported codec: ${JSON.stringify(i.name)}`);n=await a.decode(i.configuration,e.arrayInfo[t],n,r)}return n}s_({name:"blosc",kind:sO.i.bytesToBytes,decode:(e,t,r)=>r5(si,r,[t.buffer],t)}),s_({name:"zstd",kind:sO.i.bytesToBytes,decode:(e,t,r)=>r5(ss,r,[t.buffer],t)}),s_({name:"bytes",kind:sO.i.arrayToBytes,async decode(e,t,r,n){let{dataType:i,chunkShape:s}=t,a=s.reduce((e,t)=>e*t,1),o=e7[i],l=a*o;if(r.byteLength!==l)throw Error(`Raw-format chunk is ${r.byteLength} bytes, but ${a} * ${o} = ${l} bytes are expected.`);let u=tt(i,r.buffer,r.byteOffset,r.byteLength);return rT(u,e.endian,o),u}}),s_({name:"crc32c",kind:sO.i.bytesToBytes,async decode(e,t,r){if(t.length<4)throw Error(`Expected buffer of size at least 4 bytes but received: ${t.length} bytes`);return t.subarray(0,t.length-4)}});var sD=r(6758);for(let[e,t]of[["gzip","gzip"],["zlib","deflate"]])s_({name:e,kind:sO.i.bytesToBytes,decode:async(e,r,n)=>new Uint8Array(await (0,r7.lL)(r,t,n))});function sz(e){let{name:t,configuration:r}=function(e,t,r){(0,ej.PT)(e);let n=(0,ej.uq)(e,"name",e=>t((0,ej.ZE)(e))),i=(0,ej.uq)(e,"configuration",e=>(void 0===e?e={}:(0,ej.PT)(e),r(e,n)));return{name:n,configuration:i}}(e,e=>{let t=sB.get(e);if(void 0===t)throw Error(`Unknown codec: ${JSON.stringify(e)}`);return t},e=>e);return{resolver:t,configuration:r}}let sB=new Map;function sj(e,t){let r=[],n=[],i=[],s=[];n.push(t);let a=(0,ej.m7)(e,sz),o=a.length,l=0;for(;l<o;++l){let{resolver:e,configuration:i}=a[l];if(e.kind!==sO.i.arrayToArray)break;let{configuration:s,encodedArrayInfo:o}=e.resolve(i,t);n.push(o),t=o,r.push({kind:sO.i.arrayToArray,name:e.name,configuration:s})}if(l===o||a[l].resolver.kind!==sO.i.arrayToBytes)throw Error("Missing array -> bytes codec");let{codecSpec:u,layoutInfo:h,encodedSize:c,shardingInfo:d}=(()=>{let{resolver:e,configuration:r}=a[l],{configuration:n,shardingInfo:i,encodedSize:s}=e.resolve(r,t);if(void 0!==i&&l+1!==o)throw Error("bytes -> bytes codecs not supported following sharding codec");let u=e.getDecodedArrayLayoutInfo(n,t);return{codecSpec:{name:e.name,kind:sO.i.arrayToBytes,configuration:n},layoutInfo:u,encodedSize:s,shardingInfo:i}})();i[l]=h,s.push(c);let f=[];for(++l;l<o;){let{resolver:e,configuration:t}=a[l];if(e.kind!==sO.i.bytesToBytes)throw Error(`Expected bytes -> bytes codec, but received ${JSON.stringify(e.name)} of kind ${sO.i[e.kind]}`);let{configuration:r,encodedSize:n}=e.resolve(t,c);f.push({name:e.name,kind:e.kind,configuration:r}),s.push(n),++l}for(let e=r.length-1;e>=0;--e)i[e]=a[e].resolver.getDecodedArrayLayoutInfo(r[e].configuration,n[e],i[e+1]);return{[sO.i.arrayToArray]:r,[sO.i.arrayToBytes]:u,[sO.i.bytesToBytes]:f,arrayInfo:n,layoutInfo:i,shardingInfo:d,encodedSize:s}}let sF=new Map([["",{unit:"",scale:1}],["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:3600}],["day",{unit:"s",scale:86400}]]);for(let e of["meter","second"])for(let t of eF){let{longPrefix:r,prefix:n}=t;if(void 0===r)continue;let i={unit:e[0],scale:10**t.exponent};sF.set(`${r}${e}`,i),sF.set(`${n}${e[0]}`,i)}var sV=((b={})[b.START=0]="START",b[b.END=1]="END",b);w={name:"sharding_indexed",kind:sO.i.arrayToBytes,resolve(e,t){(0,ej.PT)(e);let r=(0,ej.uq)(e,"chunk_shape",e=>{var r;return r=t.chunkShape.length,(0,ej.Iw)(Array(r),e,e=>{if("number"!=typeof e||!Number.isInteger(e)||e<=0)throw Error(`Expected positive integer, but received: ${JSON.stringify(e)}`);return e})}),n=(0,ej.Kh)(e,"index_location",e=>(0,ej.CT)(e,sV,/^[a-z]+$/),1),i=Array.from(t.chunkShape,(e,n)=>{let i=r[n];if(e%i!=0)throw Error(`sub-chunk shape of ${JSON.stringify(i)} does not evenly divide outer chunk shape of ${JSON.stringify(t.chunkShape)}`);return e/i}),s=Array.from(i);s.push(2);let a=(0,ej.uq)(e,"index_codecs",e=>sj(e,{dataType:e9.UINT64,chunkShape:s}));if(void 0===a.encodedSize[a.encodedSize.length-1])throw Error("index_codecs must specify fixed-size encoding");let o=(0,ej.uq)(e,"codecs",e=>sj(e,{dataType:t.dataType,chunkShape:r}));return{configuration:{indexCodecs:a,subChunkCodecs:o,subChunkShape:r,subChunkGridShape:i,indexLocation:n},shardingInfo:{subChunkShape:r,subChunkGridShape:i,subChunkCodecs:o}}},getDecodedArrayLayoutInfo:(e,t)=>e.subChunkCodecs.layoutInfo[0]},sB.set(w.name,w);let sG=BigInt("18446744073709551615");class sK extends M.gj{configuration;base;indexCache;indexStrides;constructor(e,t,r){super(),this.configuration=e,this.base=r,this.indexCache=this.registerDisposer(new iM(t.addRef(),{get:async(t,n)=>{let i;let{indexCodecs:s}=e,a=s.encodedSize[s.encodedSize.length-1];switch(e.indexLocation){case sV.START:i={offset:0,length:a};break;case sV.END:i={suffixLength:a}}let o=await r.read(t,{...n,byteRange:i});if(void 0===o)return{size:0,data:void 0};let l=await sL(e.indexCodecs,new Uint8Array(await o.response.arrayBuffer()),n.signal);return{size:l.byteLength,data:new BigUint64Array(l.buffer,l.byteOffset,l.byteLength/8)}}}));let{subChunkGridShape:n}=this.configuration,i=n.length,s=this.configuration.indexCodecs.layoutInfo[0].physicalToLogicalDimension,a=this.indexStrides=Array(i+1),o=1;for(let e=i;e>=0;--e){let t=s[e];a[t]=o,o*=t===i?2:n[t]}}async findKey(e,t){let r=await this.indexCache.get(e.base,t);if(void 0===r)return;let n=this.configuration.subChunkShape.length,{subChunk:i}=e,{indexStrides:s}=this,a=0;for(let e=0;e<n;++e)a+=i[e]*s[e];let o=r[a],l=r[a+s[n]];if(o!==sG||l!==sG)return{offset:Number(o),length:Number(l)}}async stat(e,t){let r=await this.findKey(e,t);if(void 0!==r)return{totalSize:r.length}}async read(e,t){let r=await this.findKey(e,t);if(void 0!==r)return new iT.uX(new iN.f2(this.base,e.base),r).read(t)}getUrl(e){return`subchunk ${JSON.stringify(e.subChunk)} within shard ${this.base.getUrl(e.base)}`}get supportsOffsetReads(){return!0}get supportsSuffixReads(){return!0}}s_({name:"sharding_indexed",kind:sO.i.arrayToBytes,getShardedKvStore:(e,t,r)=>new sK(e,t,r)}),s_({name:"transpose",kind:sO.i.arrayToArray,decode:async(e,t,r,n)=>r});var sY=r(6252);class sq extends ey(eP(na),sD.Y){chunkKvStore=(function(e,t,r){let n=r.store,i=t;for(;;){let{shardingInfo:t}=i;if(void 0===t)break;let r=i[sO.i.arrayToBytes],s=sA.sharding.get(r.name);if(void 0===s)throw Error(`Unsupported codec: ${JSON.stringify(r.name)}`);n=s.getShardedKvStore(r.configuration,e,n),i=t.subChunkCodecs}let s=i,a=r.path;return{kvStore:n,getChunkKey:function(e,r){let n=a+r,i=e.length,s=t;for(;void 0!==s.shardingInfo;){let{physicalToLogicalDimension:r,readChunkShape:a}=t.layoutInfo[t.layoutInfo.length-1],{subChunkShape:o,subChunkGridShape:l,subChunkCodecs:u}=s.shardingInfo,h=Array(i);for(let t=0;t<i;++t){let n=r[i-1-t];h[n]=Math.floor(e[t]*a[n]/o[n])%l[n]}n={base:n,subChunk:h},s=u}return n},decodeCodecs:s}})(this.chunkManager,this.parameters.metadata.codecs,this.sharedKvStoreContext.kvStoreContext.getKvStore(this.parameters.url));async download(e,t){let r;e.chunkDataSize=this.spec.chunkDataSize;let{parameters:n}=this,{chunkGridPosition:i}=e,{metadata:s}=n,a="",o=this.spec.rank,{physicalToLogicalDimension:l}=s.codecs.layoutInfo[0];s.chunkKeyEncoding===sY.$.DEFAULT?(a+="c",r=s.dimensionSeparator):(r="",0===o&&(a+="0"));let u=Array(o),{readChunkShape:h}=s.codecs.layoutInfo[0],{chunkShape:c}=s;for(let e=0;e<o;++e){let t=l[o-1-e];u[t]=Math.floor(i[e]*h[t]/c[t])}for(let e=0;e<o;++e)a+=`${r}${u[e]}`,r=s.dimensionSeparator;let{chunkKvStore:d}=this,f=await d.kvStore.read(d.getChunkKey(i,a),{signal:t});if(void 0!==f){let r=await sL(d.decodeCodecs,new Uint8Array(await f.response.arrayBuffer()),t);await r9(e,t,r)}}}function sJ(e,t,r){return e.rpc.promiseInvoke(eN.Bg,{sharedKvStoreContext:e.rpcId,url:t},{signal:r.signal,progressListener:r.progressListener})}sq=function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}([F()],sq),r(7439),r(2298),r(8679),_(eN.md,async function(e,t){let r=this.get(e.sharedKvStoreContext);return{value:await r.kvStoreContext.stat(e.url,t)}}),_(eN.cn,async function(e,t){let r=this.get(e.sharedKvStoreContext),n=await r.kvStoreContext.read(e.url,{...t,byteRange:e.byteRange,throwIfMissing:e.throwIfMissing});if(void 0===n)return{value:void 0};let i=await n.response.arrayBuffer();return{value:{data:i,offset:n.offset,totalSize:n.totalSize},transfers:[i]}}),_(eN.Bg,async function(e,t){let{store:r,path:n}=this.get(e.sharedKvStoreContext).kvStoreContext.getKvStore(e.url);return{value:await r.list(n,t)}}),_(eN.aJ,async function(e,t){let r;let{kvStoreContext:n}=this.get(e.sharedKvStoreContext),{url:i}=e,s=(0,ip.kw)(i);if(s===i){let e=(0,ip.mq)(s),i=n.getBaseKvStoreProvider(e);void 0!==i.completeUrl&&(r=await i.completeUrl({url:e,...t}))}else{let e=(0,ip.mq)(s),a=n.getKvStoreAdapterProvider(e),o=i.slice(0,i.length-s.length-1),l=n.getKvStore(o);void 0!==a.completeUrl&&(r=await a.completeUrl({url:e,base:l,...t}))}return{value:r}});class sW extends ig.Z{list(e,t){return sJ(this.sharedKvStoreContext,this.getUrl(e),t)}}(0,ig.X)(eR,sW);var sZ=r(8779),sX=r(9749);let sQ="0123456789ABCDEFGHJKMNPQRSTVWXYZ";function sH(e){let t=e.length,r=0,n="",i=0;for(let s=0;s<t;++s)for(r=r<<8|e[s],i+=8;i>=5;i-=5)n+=sQ[r>>>i-5&31];return i>0&&(n+=sQ[r<<5-i&31]),n}let s0=Uint8Array.of(73,67,69,240,159,167,138,67,72,85,78,75),s1=s0.length+24+1+1+1;async function s2(e,t,r,n){if(e.byteLength<s1)throw Error(`Expected icechunk header of ${s1} bytes, but received: ${e.byteLength} bytes`);let i=new DataView(e),s=0;for(let t=0,r=s0.length;t<r;++t)if(i.getUint8(t)!==s0[t])throw Error(`Expected magic bytes of ${s0.join()} but received: ${new Uint8Array(e,0,r).join()}`);s+=s0.length,s+=24;let a=i.getUint8(s++);if(a>t)throw Error(`Expected version <= ${t} but received: ${a}`);let o=i.getUint8(s++);if(o!==r)throw Error(`Expected file type of ${r}, but received: ${o}`);let l=i.getUint8(s++),u=new Uint8Array(e,s);switch(l){case 0:break;case 1:u=new Uint8Array((u=await r5(ss,n,[e],u)).buffer,u.byteOffset,u.byteLength);break;default:throw Error(`Unknown compression method: ${l}`)}return{content:u,specVersion:a}}async function s3(e,t,r,n){let{content:i,specVersion:s}=await s2(e,t,r,n);return{content:new sX.SY({mapsAsObjects:!1,int64AsType:"bigint"}).unpack(i),specVersion:s,estimatedSize:3*e.byteLength}}let s6=sZ.zGw(sZ.bcc([sZ.eE4(Uint8Array)]),sZ.vs(e=>e[0])),s4=sZ.zGw(s6,sZ.kE(12),sZ.vs(sH)),s8=sZ.zGw(s6,sZ.kE(8),sZ.vs(sH)),s5=BigInt(Number.MIN_SAFE_INTEGER),s9=BigInt(Number.MAX_SAFE_INTEGER),s7=sZ.zGw(sZ.Kvp(),sZ.BF5(e=>e>=s5&&e<=s9,`Number outside supported range: [${Number.MIN_SAFE_INTEGER}, ${Number.MAX_SAFE_INTEGER}]`),sZ.vs(Number)),ae=sZ.G0j([s7,sZ.zGw(sZ.Rxh(),sZ._LP())]);function at(e){let t=Object.keys(e);return sZ.zGw(sZ.IXX(sZ.YjB()),sZ.kE(t.length),sZ.vs(e=>Object.fromEntries(t.map((t,r)=>[t,e[r]]))),sZ.cfj(e))}function ar(e,t,r){try{return{...sZ.Qc3(e,r.content),estimatedSize:r.estimatedSize}}catch(e){if(sZ.yhs(e))throw Error(`Error parsing icechunk ${t}: ${JSON.stringify(sZ.xHg(e.issues))}`);throw e}}let an=sZ.cfj({Inline:sZ.eE4(Uint8Array)}),ai=sZ.YjB(),as=at({location:sZ.Z_8(),offset:ae,length:ae,chunksum:ai}),aa=sZ.cfj({Virtual:as}),ao=at({id:s4,offset:ae,length:ae}),al=sZ.cfj({Ref:ao}),au=sZ.zGw(sZ.UID(sZ.Z_8(),sZ.YjB()),sZ.vs(Object.fromEntries),sZ.G0j([an,aa,al])),ah=at({id:s4,chunks:sZ.UID(s8,sZ.UID(sZ.zGw(sZ.IXX(ae),sZ.vs(e=>e.join())),au))});async function ac(e,t){return ar(ah,"chunk manifest",await s3(e,1,2,t))}function ad(e){return null!==e.match(/^[0-9ABCDEFGHJKMNPQRSTVWXYZ]{20}$/)}let af=at({id:s4,sizeBytes:ae,numRows:ae}),ag=at({id:s4}),ap=sZ.zGw(sZ.UID(sZ.Z_8(),sZ.YjB()),sZ.vs(Object.fromEntries),sZ.G0j([sZ.cfj({Inline:sZ.YjB()})])),ay=sZ.$R3(["Slash","Dot"]),am=sZ.UID(sZ.Z_8(),sZ.YjB()),av=at({name:sZ.Z_8(),configuration:am}),ab=sZ.zGw(sZ.UID(sZ.Z_8(),sZ.YjB()),sZ.vs(e=>{let t=Array.from(e.values());if(1!==t.length)throw Error(`Expected a single key, but received: ${JSON.stringify(Array.from(e.keys()))}`);return t[0]})),aw=at({name:sZ.Z_8(),configuration:am}),aS=sZ.IXX(sZ.AG3(sZ.Z_8())),aE=at({shape:sZ.IXX(ae),dataType:sZ.Z_8(),chunkShape:sZ.IXX(ae),chunkKeyEncoding:ay,fillValue:ab,codecs:sZ.IXX(av),storageTransformers:sZ.IXX(aw),dimensionNames:sZ.AG3(aS)}),ak=sZ.IXX(ae),aI=at({objectId:s4,extents:sZ.qXN([ak,ak])}),aM=sZ.$R3(["Group"]),ax=sZ.cfj({Array:at({metadata:aE,manifests:sZ.IXX(aI)})}),aT=sZ.G0j([aM,sZ.zGw(sZ.UID(sZ.Z_8(),sZ.YjB()),sZ.vs(Object.fromEntries),ax)]),aC=at({id:s8,path:sZ.zGw(sZ.Z_8(),sZ.vs(e=>"/"===e?"":e.slice(1)+"/")),userAttributes:ap,nodeData:aT}),aN=sZ.zGw(sZ.UID(sZ.Z_8(),aC),sZ.vs(e=>Array.from(e.values()).sort((e,t)=>(0,nL.B)(e.path,t.path)))),a$=at({id:s4,parentId:sZ.AG3(s4),flushedAt:sZ.Z_8(),message:sZ.Z_8(),metadata:sZ.IMB(sZ.Z_8(),sZ.YjB()),manifestFiles:sZ.zGw(sZ.IXX(af),sZ.vs(e=>{let t=new Map;for(let r of e)t.set(r.id,r);return t})),attributeFiles:sZ.IXX(ag),nodes:aN});async function aR(e,t){return ar(a$,"snapshot",await s3(e,1,1,t))}function aP(e,t,r){if(null!=t){var n,i;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(r){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");n=t[Symbol.asyncDispose]}if(void 0===n){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");n=t[Symbol.dispose],r&&(i=n)}if("function"!=typeof n)throw TypeError("Object not disposable.");i&&(n=function(){try{i.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:n,async:r})}else r&&e.stack.push({async:!0});return t}function aU(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,r){var n=Error(r);return n.name="SuppressedError",n.error=e,n.suppressed=t,n};return(aU=function(e){function r(r){e.error=e.hasError?new t(r,e.error,"An error was suppressed during disposal."):r,e.hasError=!0}var n,i=0;return function t(){for(;n=e.stack.pop();)try{if(!n.async&&1===i)return i=0,e.stack.push(n),Promise.resolve().then(t);if(n.dispose){var s=n.dispose.call(n.value);if(n.async)return i|=2,Promise.resolve(s).then(t,function(e){return r(e),t()})}else i|=1}catch(e){r(e)}if(1===i)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}function aO(e,t,r){let n=new iM(e.chunkManager.addRef(),{get:async(n,i)=>{let s=await e.kvStoreContext.read(n,{...i,throwIfMissing:!0});try{return await r(s.response,i.signal)}catch(e){throw Error(`Error reading icechunk ${t} from ${n}`,{cause:e})}}});return n.registerDisposer(e.addRef()),n}function aA(e,t,r){return e.chunkManager.memoize.get("icechunk:ref",()=>aO(e,"ref",async e=>({data:function(e){if((0,ej.PT)(e),1!==Object.keys(e).length)throw Error(`Expected object with only a "snapshot" property, but received: ${JSON.stringify(e)}`);let t=(0,ej.uq)(e,"snapshot",ej.ZE);if(!ad(t))throw Error(`Expected icechunk snapshot id but received: ${JSON.stringify(t)}`);return t}(await e.json()),size:0}))).get(t,r)}function a_(e,t){let r,n;let i=t.match(/(?:^|\/)(zarr\.json)$/);if(null!==i)r=t.slice(0,-i[1].length);else{let e=t.match(/c(?:[./][0-9]+)*$/);if(null===e)return;r=t.slice(0,-e[0].length);let i=e[0].split(/[./]/),s=i.length-1;n=Array(s);for(let e=0;e<s;++e)n[e]=Number(i[e+1])}let s=function(e,t){let{nodes:r}=e,n=eL(r,t,(e,t)=>(0,nL.B)(e,t.path));if(n<0)throw Error(`Node not found: ${JSON.stringify(t)}`);return r[n]}(e,r);if(void 0===n)return{node:s};if("Group"===s.nodeData)return;let{shape:a,chunkShape:o}=s.nodeData.Array.metadata,l=a.length;if(l===n.length){for(let e=0;e<l;++e)if(n[e]*o[e]>=a[e])return;return{node:s,chunk:n}}}async function aL(e,t,r,n,i){let{manifests:s}=r.nodeData.Array,a=n.join(),o=r.id;for(let r of s){if(!function([e,t],r){for(let n=0,i=r.length;n<i;++n){let i=r[n];if(i<e[n]||i>=t[n])return!1}return!0}(r.extents,n))continue;let s=(await function(e,t,r,n){return e.chunkManager.memoize.get("icechunk:manifest",()=>aO(e,"manifest",async(e,t)=>{let r=await ac(await e.arrayBuffer(),t);return{data:r,size:r.estimatedSize}})).get((0,ip.Yq)(t,`manifests/${r}`),n)}(e,t,r.objectId,i)).chunks.get(o);if(void 0===s)continue;let l=s.get(a);if(void 0!==l)return l}}async function aD(e,t,r,n,i){let s;let a=a_(r,n);if(void 0===a)return;let{node:o,chunk:l}=a;if(void 0===l)return{totalSize:void 0};let u=await aL(e,t,o,l,i);if(void 0!==u)return{totalSize:"Inline"in u?u.Inline.length:"Virtual"in u?u.Virtual.length:u.Ref.length}}async function az(e,t,r,n){let i,s,a;if("Inline"in r)return(0,iT._J)(r.Inline,n.byteRange);if("Virtual"in r)({location:a,offset:i,length:s}=r.Virtual);else{var o,l;let{Ref:e}=r;({offset:i,length:s}=e),o=t,l=e.id,a=(0,ip.Yq)(o,`chunks/${l}`)}return new iT.uX(e.kvStoreContext.getFileHandle(a),{offset:i,length:s}).read(n)}async function aB(e,t,r,n,i){let s=a_(r,n);if(void 0===s)return;let{node:a,chunk:o}=s;if(void 0===o){let e=function(e){let t;let{userAttributes:r,nodeData:n}=e;return t=null===r?new Map:r.Inline,JSON.stringify("Group"!==n?function(e,t){let{shape:r,chunkShape:n,chunkKeyEncoding:i,dataType:s,fillValue:a,codecs:o,storageTransformers:l,dimensionNames:u}=e;return{zarr_format:3,node_type:"array",shape:r,data_type:s,chunk_grid:{name:"regular",configuration:{chunk_shape:n}},chunk_key_encoding:{name:"default",configuration:{separator:"Dot"===i?".":"/"}},fill_value:a,codecs:o,storage_transformers:l,dimension_names:u??void 0,attributes:t}}(n.Array.metadata,t):{zarr_format:3,node_type:"group",attributes:t},(e,t)=>t instanceof Map?Object.fromEntries(t):t)}(a),t=new TextEncoder().encode(e);return(0,iT._J)(t,i.byteRange)}let l=await aL(e,t,a,o,i);if(void 0!==l)return az(e,t,l,i)}let aj="branch.",aF="tag.";function aV(e){return e.length>0&&!e.includes("/")}function aG(e){if(void 0!==e){if(e.startsWith(aj)){let t=e.substring(aj.length);if(!aV(t))throw Error(`Invalid branch name: ${JSON.stringify(t)}`);return{branch:decodeURIComponent(t)}}if(e.startsWith(aF)){let t=e.substring(aF.length);if(!aV(t))throw Error(`Invalid tag name: ${JSON.stringify(t)}`);return{tag:decodeURIComponent(t)}}if(ad(e))return{snapshot:e};throw Error(`Invalid ref spec: ${JSON.stringify(e)}`)}}class aK{sharedKvStoreContext;baseUrl;refSpec;constructor(e,t,r){this.sharedKvStoreContext=e,this.baseUrl=t,this.refSpec=r}snapshot;async getSnapshot(e){let{snapshot:t}=this;if(void 0===t){var r,n;let i=await function(e,t,r,n){var i,s;return"snapshot"in r?Promise.resolve(r.snapshot):"branch"in r?(i=(0,ip.Yq)(t,`refs/branch.${r.branch}/`),e.chunkManager.memoize.get("icechunk:branch",()=>{let t=new iM(e.chunkManager.addRef(),{get:async(t,r)=>{let n={stack:[],error:void 0,hasError:!1};try{aP(n,new x.Vi(r.progressListener,{message:`Resolving icechunk branch at ${t}`}),!1);try{let n=(await e.kvStoreContext.list(t,{...r,responseKeys:"suffix"})).entries.find(e=>{var t;return t=e.key,null!==t.match(/^[0-9ABCDEFGHJKMNPQRSTVWXYZ]{8}\.json$/)});if(void 0===n)throw Error("Failed to find any refs");return{data:await aA(e,(0,ip.Yq)(t,n.key),r),size:0}}catch(e){throw Error(`Error resolving icechunk branch at ${t}`,{cause:e})}}catch(e){n.error=e,n.hasError=!0}finally{aU(n)}}});return t.registerDisposer(e.addRef()),t}).get(i,n)):(s=(0,ip.Yq)(t,`refs/tag.${r.tag}/`),e.chunkManager.memoize.get("icechunk:tag",()=>{let t=new iM(e.chunkManager.addRef(),{get:async(t,r)=>{let n={stack:[],error:void 0,hasError:!1};try{aP(n,new x.Vi(r.progressListener,{message:`Resolving icechunk tag at ${t}`}),!1);try{let[n,i]=await Promise.all([aA(e,(0,ip.Yq)(t,"ref.json"),r),e.kvStoreContext.stat((0,ip.Yq)(t,"ref.json.deleted"),r)]);if(void 0!==i)throw Error("Tag is marked as deleted");return{data:n,size:0}}catch(e){throw Error(`Error resolving icechunk tag at ${t}`,{cause:e})}}catch(e){n.error=e,n.hasError=!0}finally{aU(n)}}});return t.registerDisposer(e.addRef()),t}).get(s,n))}(this.sharedKvStoreContext,this.baseUrl,this.refSpec??{branch:"main"},e);t=this.snapshot=await (r=this.sharedKvStoreContext,n=this.baseUrl,r.chunkManager.memoize.get("icechunk:snapshot",()=>aO(r,"snapshot",async(e,t)=>{let r=await aR(await e.arrayBuffer(),t);return{data:r,size:r.estimatedSize}})).get((0,ip.Yq)(n,`snapshots/${i}`),e))}return t}getUrl(e){return function(e,t){var r;let{baseUrl:n,refSpec:i}=e,s=void 0===i?"":`@${"branch"in(r=i)?aj+(0,ip.aU)(r.branch):"tag"in r?aF+(0,ip.aU)(r.tag):r.snapshot}/`;return n+`|icechunk:${s}${(0,ip.aU)(t)}`}(this,e)}async stat(e,t){let r=await this.getSnapshot(t);return aD(this.sharedKvStoreContext,this.baseUrl,r,e,t)}async read(e,t){let r=await this.getSnapshot(t);return aB(this.sharedKvStoreContext,this.baseUrl,r,e,t)}async list(e,t){return function(e,t){let{nodes:r}=e,n=eD(0,r.length,e=>r[e].path>=t),i=eD(Math.min(r.length,n+1),r.length,e=>!r[e].path.startsWith(t)),s={entries:[],directories:[]};for(let e=n;e<i;){let{path:n}=r[e],a=n.indexOf("/",t.length);if(-1===a)++e;else{a+1===n.length&&s.directories.push(n.slice(0,a));let t=n.substring(0,a+1);e=eD(e+1,i,e=>!r[e].path.startsWith(t))}}let a=t.lastIndexOf("/");if("zarr.json".startsWith(t.slice(a+1))){let e=t.substring(0,a+1);if(eL(r,e,(e,t)=>(0,nL.B)(e,t.path))>=0)s.entries.push({key:e+"zarr.json"});else throw Error(`Parent node ${JSON.stringify(e)} not found`)}return(0,iN.Mt)(s)}(await this.getSnapshot(t),e)}get supportsOffsetReads(){return!0}get supportsSuffixReads(){return!0}}async function aY(e,t){let r,n;let{url:i}=t,s=i.suffix??"";if(""===s)return{offset:0,completions:[{value:"@",description:"Ref specifier"}]};let a=s.match(/^@([^/]*)((?:\/|$).*)/);if(null===a)return;let[,o,l]=a;if(""!==l){aG(o);return}if(o.match(/^(?:(?:(?:t|$)(?:a|$)(?:g|$)(?:\.|$))|(?:(?:b|$)(?:r|$)(?:a|$)(?:n|$)(?:c|$)(?:h|$)(?:\.|$)))/)){let e=(0,ip.Vo)(t.base.path,"refs/");r=(0,iN.RQ)(t.base.store,e+decodeURIComponent(o),{signal:t.signal,progressListener:t.progressListener}).then(({directories:t})=>t.map(t=>{let r=t.slice(e.length);return{value:(0,ip.aU)(r)+"/",description:r.startsWith("tag.")?"Tag":"Branch"}}))}if(o.match(/^[0-9ABCDEFGHJKMNPQRSTVWXYZ]{0,20}$/)){let e=(0,ip.Vo)(t.base.path,"snapshots/");n=(0,iN.RQ)(t.base.store,e+o,{signal:t.signal,progressListener:t.progressListener}).then(({entries:t})=>{let r=[];for(let{key:n}of t){let t=n.slice(e.length);ad(t)&&r.push({value:t+"/",description:"Snapshot"})}return r})}return{offset:1,completions:[...await r??[],...await n??[]]}}eR.registerKvStoreAdapterProvider(function(e){return{scheme:"icechunk",description:"Icechunk repository",getKvStore(t,r){let{baseUrl:n,version:i,path:s}=function(e,t){(0,ip.uh)(e);try{let[,r,n]=(e.suffix??"").match(/^(?:@([^/]*)(?:\/|$))?(.*)$/);return{baseUrl:t.store.getUrl((0,ip.V8)(t.path)),version:aG(r),path:decodeURIComponent(n)}}catch(t){throw Error(`Invalid URL: ${e.url}`,{cause:t})}}(t,r);return{store:new aK(e,n,i),path:s}},completeUrl:t=>aY(e,t)}}),(0,r(5139).X)(eR,sW),r(8366);var aq=r(4163),aJ=((S={})[S.UNCOMPRESSED=0]="UNCOMPRESSED",S[S.ZSTD=1]="ZSTD",S);async function aW(e,t,r,n){if(e.byteLength<18)throw Error("Unexpected EOF");let i=new DataView(e),s=i.getUint32(0,!1);if(s!==t)throw Error(`Expected magic value 0x${t.toString(16)} but received 0x${s.toString(16)}`);let a=i.getBigUint64(4,!0);if(a!=BigInt(e.byteLength))throw Error(`Expected length ${e.byteLength} but received: ${a}`);let o=i.getUint32(e.byteLength-4,!0),l=(0,aq.buf)(new Uint8Array(e,0,e.byteLength-4))>>>0;if(o!=l)throw Error(`Expected CRC32c checksum of ${o}, but received ${l}`);let u=i.getUint8(12);if(u>r)throw Error(`Expected version to be <= ${r}, but received: ${u}`);let h=i.getUint8(13),c=new Uint8Array(e,14,e.byteLength-14-4);switch(h){case 0:break;case 1:c=await r5(ss,n,[e],c);break;default:throw Error(`Unknown compression format ${h}`)}return{reader:{offset:0,data:new DataView(c.buffer,c.byteOffset,c.byteLength)},version:u}}function aZ(e,t){let{offset:r,data:n}=e;if(r+t>n.byteLength)throw Error("Unexpected EOF");return e.offset+=t,new Uint8Array(n.buffer,n.byteOffset+r,t)}function aX(e){let{value:t,offset:r}=function(e,t){let r=0,n=0;for(let i=t,s=e.byteLength;i<s;++i){let t=e.getUint8(i);if(r+=(127&t)<<n,(128&t)==0){if(r>Number.MAX_SAFE_INTEGER)throw Error(`Value exceeded ${Number.MAX_SAFE_INTEGER}`);return{offset:i+1,value:r}}n+=7}throw Error("Unexpected EOF")}(e.data,e.offset);return e.offset=r,t}function aQ(e){let{value:t,offset:r}=function(e,t){let r=0n,n=0n;for(let i=t,s=e.byteLength;i<s;++i){let t=e.getUint8(i);if(r|=BigInt(127&t)<<BigInt(n),(128&t)==0)return{offset:i+1,value:r};n+=7n}throw Error("Unexpected EOF")}(e.data,e.offset);return e.offset=r,t}function aH(e,t){let r=aX(e);if(r>t)throw Error(`Expected value <= ${t}, but received: ${r}`);return r}function a0(e){let{offset:t,data:r}=e;if(t+1>r.byteLength)throw Error("Unexpected EOF");return e.offset+=1,r.getUint8(t)}function a1(e){let{offset:t,data:r}=e;if(t+8>r.byteLength)throw Error("Unexpected EOF");return e.offset+=8,r.getBigUint64(t,!0)}function a2(e){return(t,r,n)=>{let i=[];for(let s=0;s<r;++s)i[s]=e(t,n);return i}}function a3(e,t){let r=Object.keys(t),n=[];for(let i=0;i<e;++i){let e=Object.fromEntries(r.map(e=>[e,t[e][i]]));n[i]=e}return n}function a6(e,t){return(r,n,i)=>{let s=Object.fromEntries(Object.entries(e).map(([e,t])=>[e,t(r,n,i)])),a=a3(n,s);if(void 0!==t)for(let e=0;e<n;++e)t?.(a[e],i);return a}}let a4=new Uint8Array(0);function a8(e,t){let r=Math.min(e.length,t.length);for(let n=0;n<r;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}function a5(e,t){let r=Math.min(e.length,t.length);for(let n=0;n<r;++n){let r=e[n]-t[n];if(0!==r)return{offset:n,difference:r}}return{offset:r,difference:e.length-t.length}}function a9(...e){let t=0;for(let r of e)t+=r.length;let r=new Uint8Array(t),n=0;for(let t of e)r.set(t,n),n+=t.length;return r}function a7(e,t){return e.length>=t.length&&a5(e,t).offset===t.length}function oe(e,t){let{dataFileTable:r}=t,n=aX(e);if(n>=r.length)throw Error(`Invalid data file index ${n}, expected value <= ${r.length}`);return r[n]}Uint8Array.of(0);let ot=a6({dataFile:a2(oe),offset:a2(aQ),length:a2(aQ)},(e,t)=>{if(or(e)){if(!0!==t.allowMissing)throw Error("Reference to missing value not allowed")}else if(e.offset+e.length>BigInt(Number.MAX_SAFE_INTEGER))throw Error(`Offset=${e.offset} + length=${e.length} exceeds maximum of ${Number.MAX_SAFE_INTEGER}`)});function or(e){return 0xffffffffffffffffn===e.offset&&0xffffffffffffffffn===e.length}function on(e,t){let r=aX(e),n=new Uint16Array(3*r);for(let t=1,i=3*r;t<i;++t)n[t]=aH(e,65535);let i=[],s=a4,a=a4,o=new TextDecoder("utf-8",{fatal:!0});for(let l=0;l<r;++l){let u,h,c=n[l],d=n[l+r],f=n[l+2*r],g=c+d;if(g>65535)throw Error(`path_length[${l} = prefix_length(${c}) + suffix_length(${d}) = ${g} > 65535`);if(f>g)throw Error(`base_path_length[${l}] = ${f} > path_length(${g}) = prefix_length(${c}) + suffix_length(${d})`);if(c>Math.min(s.length,f)&&f!==s.length)throw Error(`path_prefix_length[${l-1}] = ${c} > min(base_path_length[${l-1}] = ${s.length}, base_path_length[${l}] = ${f}) is not valid if base_path_length[${l-1}] != base_path_length[${l}]`);let p=c+d-f;if(0===f)u=t,s=a4;else if(c>=f)u=i[l-1].baseUrl;else{let r=new Uint8Array(f),n=0,i=Math.max(f-c,0);if(c>0){let e=Math.min(c,f);r.set(s.subarray(0,e)),n=e,c-=e}0!==i&&(r.set(aZ(e,i),n),d-=i),u=(0,ip.Yq)(t,o.decode(r)),s=r}if(0===p)h="",a=a4;else if(0===d&&p===a.length)h=i[l-1].relativePath;else{let t=new Uint8Array(p),r=0;0!==c&&(t.set(a.subarray(0,c),0),r+=c),d>0&&t.set(aZ(e,d),r),h=o.decode(t),a=t}i[l]={baseUrl:u,relativePath:h}}return i}async function oi(e,t,r){try{let{reader:n}=await aW(e,0xcdb20de,0,r),i=a0(n),s=on(n,t),a=aX(n);if(0===a)throw Error("Empty b+tree node");if(a>1048576)throw Error(`B+tree node has arity ${a}, which exceeds limit of 1048576`);return{height:i,...0===i?function(e,t,r){let{keys:n,commonPrefix:i}=os(e,r,!1),s=function(e,t,r){let n=a2(aQ)(e,r,{}),i=aZ(e,r);for(let e=0;e<r;++e){let t=i[e];if(t>1)throw Error(`value_kind[${e}]=${t} is outside valid range [0, 1]`);if(0===t){let t=n[e];if(t>BigInt(1048576))throw Error(`value_length[${e}]=${t} exceeds maximum of 1048576 for an inline value`)}}let s=Array(r);for(let a=0;a<r;++a){if(1!==i[a])continue;let r=oe(e,{dataFileTable:t});s[a]={dataFile:r,offset:0n,length:n[a]}}for(let t=0;t<r;++t){if(1!==i[t])continue;let r=aQ(e);s[t].offset=r}for(let t=0;t<r;++t)0===i[t]&&(s[t]=aZ(e,Number(n[t])));return s}(e,t,r);return{keyPrefix:i,entries:a3(r,{key:n,value:s})}}(n,s,a):function(e,t,r){let{keys:n,commonPrefix:i,subtreeCommonPrefixLengths:s}=os(e,r,!0),a=oo(e,r,{dataFileTable:t});return{keyPrefix:i,entries:a3(r,{key:n,subtreeCommonPrefixLength:s,node:a})}}(n,s,a),estimatedSize:3*n.data.byteLength}}catch(e){throw Error("Error decoding OCDBT b+tree node",{cause:e})}}function os(e,t,r){let n,i;let s=new Uint16Array(2*t);for(let t=1,r=s.length;t<r;++t)s[t]=aH(e,65535);let a=s[t];for(let e=1;e<t;++e)a=Math.min(a,s[e]);if(r){n=new Uint16Array(t);for(let r=0;r<t;++r)a=Math.min(a,n[r]=aH(e,65535))}a=Math.min(s[t],a);for(let e=0,i=0;e<t;++e){let o=s[e];if(o>i)throw Error(`Child ${e}: Prefix length of ${o} exceeds previous key length ${i}`);let l=o+s[e+t];if(l>65535)throw Error(`Child ${e}: Key length ${l} exceeds limit of 65535`);if(r){let t=n[e];if(t>l)throw Error(`Child ${e}: subtree common prefix length of ${t} exceeds key length of ${l}`);n[e]-=a}i=l}let o=Array(t);{let r=aZ(e,s[t]);i=r.slice(0,a),o[0]=r.slice(a)}for(let r=1;r<t;++r){let n=s[r]-a,i=s[r+t],l=aZ(e,i),u=o[r-1];if(a8(u.subarray(n),l)>=0)throw Error("Invalid key order");let h=new Uint8Array(n+i);h.set(u.subarray(0,n)),h.set(l,n),o[r]=h}return{keys:o,subtreeCommonPrefixLengths:n,commonPrefix:i}}let oa=a6({numKeys:a2(aQ),numTreeBytes:a2(aQ),numIndirectValueBytes:a2(aQ)}),oo=a6({location:ot,statistics:oa});function ol(e,t,r){if(e.height!==t)throw Error(`Expected height of ${t} but received ${e.height}`);let{keyPrefix:n}=e;if(r.length<n.length){if(a8(n,r)>=0)return}else if(a8(n,r.subarray(0,n.length))>=0&&a8(e.entries[0].key,r.subarray(n.length))>=0)return;throw Error(`First key [${n}]+[${e.entries[0].key}] < inclusive_min [${r}] specified by parent node`)}function ou(e,t,r,n){return t===r||0===n.length?r:eD(t,r,t=>{let{offset:r,difference:i}=a5(n,e[t].key);return i<0&&r<n.length})}function oh(e,t,r){let n=aH(e,2**t),i=om(e,n,{allowMissing:!0,dataFileTable:r});return function(e,t){let r=2**t;if(0===e.length||e.length>r)throw Error(`num_children=${e.length} outside valid range [1, ${r}]`);for(let[t,r]of e.entries()){if(or(r.root.location)){if(0!==r.rootHeight)throw Error(`non-zero root_height=${r.rootHeight} for empty generation ${r.generationNumber}`);let{statistics:e}=r.root;if(0n!==e.numKeys||0n!==e.numTreeBytes||0n!==e.numIndirectValueBytes)throw Error(`non-zero statistics for empty generation_number[${t}]=${r.generationNumber}`)}if(0n===r.generationNumber)throw Error(`generation_number[${t}] must be non-zero`);if(0!==t&&r.generationNumber<=e[t-1].generationNumber)throw Error(`generation_number[${t}]=${r.generationNumber} <= generation_number[${t-1}]=${e[t-1].generationNumber}`)}let n=e.at(-1).generationNumber,i=e[0].generationNumber,s=oc(t,0,n);if(i<s)throw Error(`Generation range [${i}, ${n}] exceeds maximum of [${s}, ${n}]`)}(i,t),i}function oc(e,t,r){return r-(r-1n)%(1n<<BigInt(e*(t+1)))}function od(e){let t=a0(e);if(0===t||t>16)throw Error(`Expected version_tree_arity_log2 in range [1, 16] but received: ${t}`);return t}async function of(e,t,r){try{let{reader:n}=await aW(e,0xcdb1234,0,r),i=od(n),s=a0(n),a=on(n,t);return{versionTreeArityLog2:i,height:s,entries:0===s?oh(n,i,a):function(e,t,r,n){let i=oy(t);if(n>i)throw Error(`height=${n} exceeds maximum of ${i} for version_tree_arity_log2=${t}`);let s=op(e,r,2**t,n-1);return function(e,t,r){let n=2**t;if(0===e.length||e.length>n)throw Error(`num_children=${e.length} outside valid range [1, ${n}]`);let i=1n<<BigInt(t*r);for(let[t,r]of e.entries()){if(0n===r.generationNumber)throw Error(`generation_number[${t}] must be non-zero`);if(0!==t){let n=e[t-1];if(r.generationNumber<=n.generationNumber)throw Error(`generation_number[${t}]=${r.generationNumber} >= generation_number[${t-1}]=${n.generationNumber}`);if((r.generationNumber-1n)/i==(n.generationNumber-1n)/i)throw Error(`generation_number[${t}]=${r.generationNumber} should be in the same child node as generation_number[${t-1}]=${n.generationNumber}`)}if(r.generationNumber%i!==0n)throw Error(`generation_number[${t}]=${r.generationNumber} is not a multiple of ${i}`);if(r.numGenerations>i)throw Error(`num_generations[${t}]=${r.numGenerations} for generation_number=${r.generationNumber} is greater than ${i}`)}let s=1n<<BigInt(t),a=e.at(-1);if((a.generationNumber-1n)/i/s!=(e[0].generationNumber-1n)/i/s)throw Error(`generation_number[0]=${e[0].generationNumber} cannot be in the same node as generation_number[${e.length-1}]=${a.generationNumber}`)}(s,t,n),s}(n,i,a,s),estimatedSize:3*n.data.byteLength}}catch(e){throw Error("Error decoding OCDBT version tree node",{cause:e})}}let og=a6({generationNumber:a2(aQ),location:ot,numGenerations:a2(aQ),commitTime:a2(a1),height:a2((e,{height:t})=>void 0===t?a0(e):t),cumulativeNumGenerations:a2(()=>0n)});function op(e,t,r,n){let i=aH(e,r),s=og(e,i,{dataFileTable:t,height:n});return!function(e){let t=0n;for(let r of e)t+=r.numGenerations,r.cumulativeNumGenerations=t}(s),s}function oy(e){return Math.floor(63/e)-1}let om=a6({generationNumber:a2(aQ),rootHeight:a2(a0),root:oo,commitTime:a2(a1)});function ov(e,t){return"generationNumber"in e?(0,tW._f)(e.generationNumber,t.generationNumber):(0,tW._f)(e.commitTime,t.commitTime)}function ob(e,t,r){if("generationIndex"in r){let n=r.generationIndex-e;return n<0n?0:n>BigInt(t.length)?t.length:Number(n)}return eD(0,t.length,e=>0>=ov(r,t[e]))}function ow(e,t){return eD(0,e.length,r=>e[r].cumulativeNumGenerations>t)}function oS(e,t,r,n){var i,s,a;return"generationIndex"in n?ow(r,n.generationIndex-t):"generationNumber"in n?(i=e,s=r,a=n.generationNumber,eD(0,s.length,e=>{let t=s[e];return oc(i,t.height,t.generationNumber)>=a})):oE(r,n.commitTime)}function oE(e,t){return Math.max(0,eD(0,e.length,r=>e[r].commitTime>t)-1)}function ok(e,t,r){var n,i,s,a;return"generationIndex"in r?(n=t,i=r.generationIndex-e,eD(0,n.length,e=>{let t=n[e];return t.cumulativeNumGenerations-t.numGenerations>=i})):"generationNumber"in r?(s=t,a=r.generationNumber,eD(0,s.length,e=>s[e].generationNumber>=a)):oE(t,r.commitTime)}function oI(e,t,r,n,i){if(e.height!==n)throw Error(`Expected height of ${n} but received: ${e.height}`);if(e.versionTreeArityLog2!==t.versionTreeArityLog2)throw Error(`Expected version_tree_arity_log2=${t.versionTreeArityLog2} but received: ${e.versionTreeArityLog2}`);let{generationNumber:s}=e.entries.at(-1);if(s!==r)throw Error(`Expected generation number ${r} but received: ${s}`);let a=0===e.height?BigInt(e.entries.length):e.entries.at(-1).cumulativeNumGenerations;if(a!==i)throw Error(`Expected ${i}, but received: ${a}`)}async function oM(e,t,r){try{let{reader:n}=await aW(e,0xcdb3a2a,0,r),i=function(e){let t;let r=aZ(e,16).slice(),n=aX(e);if(n>1)throw Error(`Unknown manifest kind: ${n}`);let i=aX(e),s=aX(e),a=od(e),o=aX(e);switch(o){case aJ.UNCOMPRESSED:break;case aJ.ZSTD:t=function(e){let{offset:t,data:r}=e;if(t+4>r.byteLength)throw Error("Unexpected EOF");return e.offset+=4,r.getInt32(t,!0)}(e);break;default:throw Error(`Invalid compression method: ${o}`)}return{uuid:r,manifestKind:n,maxInlineValueBytes:i,maxDecodedNodeBytes:s,versionTreeArityLog2:a,compressionMethod:o,zstdLevel:t}}(n),s=0===i.manifestKind?function(e,t,r){let n=on(e,r),i=oh(e,t.versionTreeArityLog2,n),s=function(e,t,r,n){let i=op(e,r,oy(t),void 0);return function(e,t,r){let n=oy(e);for(let[e,t]of r.entries()){if(0===t.height||t.height>n)throw Error(`entry_height[${e}]=${t.height} outside valid range [1, ${n}]`);if(0n===t.generationNumber)throw Error(`generation_number[${e}] must be non-zero`);if(e>0){let n=r[e-1];if(t.generationNumber<=n.generationNumber)throw Error(`generation_number[${e}]=${t.generationNumber} <= generation_number[${e-1}]=${n.generationNumber}`);if(t.height>=n.height)throw Error(`entry_height[${e}]=${t.height} >= entry_height[${e-1}]=${n.height}`)}}let i=r.length;for(let{minGenerationNumber:n,maxGenerationNumber:s,height:a}of function(e,t){e=e-1n>>BigInt(t)<<BigInt(t);let r=1,n=[];for(;0n!==e;){let i=BigInt((r+1)*t),s=e-1n>>i<<i,a=s+1n;n.push({minGenerationNumber:a,maxGenerationNumber:e,height:r}),++r,e=s}return n}(t,e)){if(0===i)break;let e=r[i-1];if(e.height!==a)continue;--i;let{generationNumber:t}=e;if(t<n||t>s)throw Error(`generation_number[${i}]=${t} is outside expected range [${n}, ${s}] for height ${a}`)}if(0!==i)throw Error(`Unexpected child with generation_number[${i-1}]=${r[i-1].generationNumber} and entry_height=${r[i-1].height} given last generation_number=${t}`)}(t,n,i),i}(e,t.versionTreeArityLog2,n,i.at(-1).generationNumber);return{inlineVersions:i,versionTreeNodes:s,numGenerations:BigInt(i.length)+(s.at(-1)?.cumulativeNumGenerations??0n)}}(n,i,t):void 0;return!function(e){if(e.offset!==e.data.byteLength)throw Error(`Expected EOF at byte ${e.offset}`)}(n),{config:i,versionTree:s,estimatedSize:3*n.data.byteLength}}catch(e){throw Error("Error decoding OCDBT manifest",{cause:e})}}function ox(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,r){var n=Error(r);return n.name="SuppressedError",n.error=e,n.suppressed=t,n};return(ox=function(e){function r(r){e.error=e.hasError?new t(r,e.error,"An error was suppressed during disposal."):r,e.hasError=!0}var n,i=0;return function t(){for(;n=e.stack.pop();)try{if(!n.async&&1===i)return i=0,e.stack.push(n),Promise.resolve().then(t);if(n.dispose){var s=n.dispose.call(n.value);if(n.async)return i|=2,Promise.resolve(s).then(t,function(e){return r(e),t()})}else i|=1}catch(e){r(e)}if(1===i)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}async function oT(e,t,r){var n;let i=await (n={baseUrl:t,relativePath:"manifest.ocdbt"},e.chunkManager.memoize.get("ocdbt:manifest",()=>{let t=new iM(e.chunkManager.addRef(),{get:async(t,r)=>{let n={stack:[],error:void 0,hasError:!1};try{let i=(0,ip.Yq)(t.baseUrl,t.relativePath);!function(e,t,r){if(null!=t){var n,i;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(r){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");n=t[Symbol.asyncDispose]}if(void 0===n){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");n=t[Symbol.dispose],r&&(i=n)}if("function"!=typeof n)throw TypeError("Object not disposable.");i&&(n=function(){try{i.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:n,async:r})}else r&&e.stack.push({async:!0})}(n,new x.Vi(r.progressListener,{message:`Reading OCDBT manifest from ${i}`}),!1);let s=await e.kvStoreContext.read(i,{...r,throwIfMissing:!0});try{let e=await oM(await s.response.arrayBuffer(),t.baseUrl,r.signal);return{data:e,size:e.estimatedSize}}catch(e){throw Error(`Error reading OCDBT manifest from ${i}`,{cause:e})}}catch(e){n.error=e,n.hasError=!0}finally{ox(n)}}});return t.registerDisposer(e.addRef()),t}).get(n,r));if(void 0===i.versionTree)throw Error("only manifest_kind=single is supported");return i}function oC(e,t,r){let n=new iM(e.chunkManager.addRef(),{get:async(n,i)=>{let{dataFile:s}=n,a=(0,ip.Yq)(s.baseUrl,s.relativePath),o=await e.kvStoreContext.read(a,{...i,throwIfMissing:!0,byteRange:{offset:Number(n.offset),length:Number(n.length)}});try{let e=await r(await o.response.arrayBuffer(),s.baseUrl,i.signal);return{data:e,size:e.estimatedSize}}catch(e){throw Error(`Error reading OCDBT ${t} from ${a}`,{cause:e})}},encodeKey:({dataFile:e,offset:t,length:r})=>JSON.stringify([e,`${t}/${r}`])});return n.registerDisposer(e.addRef()),n}function oN(e,t,r){return e.chunkManager.memoize.get("ocdbt:btree",()=>oC(e,"b+tree node",oi)).get(t,r)}function o$(e,t,r){return e.chunkManager.memoize.get("ocdbt:versionnode",()=>oC(e,"version tree node",of)).get(t,r)}async function oR(e,t,r,n){let i=[],s=new Set;return or(t.root.location)||await oP(t.root,t.rootHeight,a4,0,{sharedKvStoreContext:e,prefix:r,entries:i,directories:s,signal:n.signal,progressListener:n.progressListener}),(0,iN.Mt)({entries:i,directories:Array.from(s)})}async function oP(e,t,r,n,i){i.signal?.throwIfAborted();let s=await oN(i.sharedKvStoreContext,e.location,i);ol(s,t,r.subarray(n));let a=a9(r.subarray(0,n),s.keyPrefix),o=e=>{try{i.directories.add(new TextDecoder("utf-8",{fatal:!0}).decode(e))}catch{}},{prefix:l}=i;{let{offset:e,difference:t}=a5(l,a);if(0!==t&&e<Math.min(l.length,a.length))return}if(l.length<a.length){let e=a.indexOf(47,l.length);if(-1!==e){o(a.subarray(0,e));return}}let u=l.subarray(a.length);if(s.height>0){let e=s.entries,[r,n]=function(e,t){let r=Math.max(0,eD(0,e.length,r=>a8(e[r].key,t)>0)-1),n=ou(e,r,e.length,t);return[r,n]}(e,u),l=[];for(let s=r;s<n;){let r=e[s];++s;let{key:h}=r,{subtreeCommonPrefixLength:c}=r;if(c>u.length){let t=h.indexOf(47,u.length);if(-1!==t){let r=h.subarray(0,t);o(a9(a,r)),s=ou(e,s,n,r);continue}}l.push(oP(r.node,t-1,a9(a,r.key),a.length+r.subtreeCommonPrefixLength,i))}await Promise.all(l)}else{let e=s.entries,[t,r]=function(e,t){let r=eD(0,e.length,r=>a8(e[r].key,t)>=0),n=ou(e,r,e.length,t);return[r,n]}(e,u);for(let n=t;n<r;){let t=e[n];++n;let{key:s}=t,l=s.indexOf(47,u.length);if(-1!==l){o(a9(a,s.subarray(0,l))),n=ou(e,n,r,s.subarray(0,l+1));continue}try{i.entries.push({key:new TextDecoder("utf-8",{fatal:!0}).decode(a9(a,s))})}catch{}}}}async function oU(e,t,r,n){if(!or(t.root.location))return await oO(e,t.root,t.rootHeight,a4,r,n)}async function oO(e,t,r,n,i,s){for(;;){let a=await oN(e,t.location,s);if(ol(a,r,n),!a7(i,a.keyPrefix))return;if(0===a.height)return function(e,t){let r=eL(e,t,(e,t)=>a8(e,t.key));if(!(r<0))return e[r]}(a.entries,i);let o=function(e,t){let r=eD(0,e.length,r=>a8(e[r].key,t)>0);if(0===r)return;let n=e[r-1],{subtreeCommonPrefixLength:i}=n;if(0===i||a7(t,n.key.subarray(0,i)))return n}(a.entries,i);if(void 0===o)return;let{subtreeCommonPrefixLength:l}=o;i=i.subarray(l),t=o.node,n=o.key.subarray(l),--r}}async function oA(e,t,r){let{value:n}=t;if(n instanceof Uint8Array)return(0,iT._J)(n,r.byteRange);let{offset:i,length:s,dataFile:{baseUrl:a,relativePath:o}}=n,{store:l,path:u}=e.kvStoreContext.getKvStore(a);return await new iT.uX(new iN.f2(l,u+o),{offset:Number(i),length:Number(s)}).read(r)}var o_=r(8274);async function oL(e,t,r,n){return e.chunkManager.memoize.get("ocdbt:version",()=>{let t=new iM(e.chunkManager.addRef(),{get:async({url:t,version:r},i)=>{let s=await oT(e,t,i),a=await oD(e,s,r,n);if(void 0===a)throw Error(`Version ${(0,o_.ko)(r)} not found`);return{data:a.ref,size:0}},encodeKey:({url:e,version:t})=>{let r;return void 0!==t&&(r=(0,o_.ko)(t)),JSON.stringify([e,r])}});return t.registerDisposer(e.addRef()),t}).get({url:t,version:r},n)}async function oD(e,t,r,n){let{versionTree:i}=t;if(void 0===r){let{versionTreeNodes:e,inlineVersions:t}=i,r=t.length-1;return{ref:t[r],generationIndex:(e.at(-1)?.cumulativeNumGenerations??0n)+BigInt(r)}}let{ref:s,generationIndex:a}=await oV(e,t,r,n);if(void 0!==s)return{ref:s,generationIndex:a}}async function oz(e,t,r,n){let{generationIndex:i}=await oG(e,t,r,n);return i}async function oB(e,t,r,n){let{generationIndex:i}=await oK(e,t,r,n);return i}function oj(e){let{isInline:t,findInLeaf:r,findInInterior:n}=e;async function i(e,t,i,s,a,o){for(;;){let l=await o$(e,s.location,o);if(oI(l,t,s.generationNumber,s.height,s.numGenerations),0===l.height){let e=l.entries,n=r(t,i,e,a);return{ref:e[n],generationIndex:i+BigInt(n)}}let u=n(t,i,l.entries,a);if(void 0===u)return{ref:void 0,generationIndex:i};i+=(s=u).cumulativeNumGenerations-s.numGenerations}}return async function(e,s,a,o){let{config:l,versionTree:u}=s,h=u.versionTreeNodes.at(-1)?.cumulativeNumGenerations??0n,{inlineVersions:c}=u;if(t(l,h,c,a)){let e=r(l,h,c,a);return{ref:c[e],generationIndex:h+BigInt(e)}}let{versionTreeNodes:d}=u;if(0===d.length)return{ref:void 0,generationIndex:0n};let f=n(l,0n,d,a);return void 0===f?{ref:void 0,generationIndex:0n}:await i(e,s.config,0n+f.cumulativeNumGenerations-f.numGenerations,f,a,o)}}function oF(e,t,r){return"generationIndex"in r?r.generationIndex>=e:ov(r,t[0])>=0}let oV=oj({isInline:(e,t,r,n)=>oF(t,r,n),findInLeaf:(e,t,r,n)=>(function(e,t,r){if("generationNumber"in r)return function(e,t){let r=eL(e,t,(e,t)=>(0,tW._f)(e,t.generationNumber));return r<0?e.length:r}(t,r.generationNumber);if(!("generationIndex"in r))return function(e,t){let r=eD(0,e.length,r=>e[r].commitTime>t);return 0===r?e.length:r-1}(t,r.commitTime);{let{generationIndex:n}=r;return(n-=e)<0n?-1:n>=BigInt(t.length)?t.length:Number(n)}})(t,r,n),findInInterior:(e,t,r,n)=>{var i;return i=e.versionTreeArityLog2,"generationIndex"in n?r[ow(r,n.generationIndex-t)]:"generationNumber"in n?function(e,t,r){let n=eD(0,t.length,e=>t[e].generationNumber>=r);if(n===t.length)return;let i=t[n];if(!(oc(e,i.height,i.generationNumber)>r))return i}(i,r,n.generationNumber):function(e,t){let r=eD(0,e.length,r=>e[r].commitTime>t);if(0!==r)return e[r-1]}(r,n.commitTime)}}),oG=oj({isInline:(e,t,r,n)=>oF(t,r,n),findInLeaf:(e,t,r,n)=>ob(t,r,n),findInInterior(e,t,r,n){let i=oS(e.versionTreeArityLog2,t,r,n);return r[i]}}),oK=oj({isInline:(e,t,r,n)=>oF(t,r,n),findInLeaf:(e,t,r,n)=>ob(t,r,n),findInInterior(e,t,r,n){let i=ok(t,r,n);return r[i]}});var oY=r(9922);class oq{sharedKvStoreContext;baseUrl;version;constructor(e,t,r){this.sharedKvStoreContext=e,this.baseUrl=t,this.version=r}root;async getRoot(e){let{root:t}=this;return void 0===t&&(t=this.root=await oL(this.sharedKvStoreContext,this.baseUrl,this.version,e)),t}getUrl(e){return(0,oY.k)(this,e)}async stat(e,t){let r=await this.getRoot(t),n=new TextEncoder().encode(e),i=await oU(this.sharedKvStoreContext,r,n,t);if(void 0===i)return;let{value:s}=i;return{totalSize:Number(s.length)}}async read(e,t){let r=await this.getRoot(t),n=new TextEncoder().encode(e),i=await oU(this.sharedKvStoreContext,r,n,t);if(void 0!==i)return await oA(this.sharedKvStoreContext,i,t)}async list(e,t){let r=await this.getRoot(t),n=new TextEncoder().encode(e);return await oR(this.sharedKvStoreContext,r,n,t)}get supportsOffsetReads(){return!0}get supportsSuffixReads(){return!0}}async function oJ(e,t,r){let n;let{inclusiveMin:i,exclusiveMax:s}=r,a=void 0===i?{generationIndex:0n}:i,o=void 0===s?{generationIndex:t.versionTree.numGenerations}:s,{config:l,versionTree:u}=t,{versionTreeArityLog2:h}=l,c=[];function d(e,t){let r=ob(e,t,a),i=ob(e,t,o),s=e+BigInt(r);(void 0===n||s<n)&&(n=s);for(let e=r;e<i;++e)c.push(t[e])}async function f(e,t){r.signal?.throwIfAborted();let n=oS(h,e,t,a),i=ok(e,t,o),s=[];for(let r=n;r<i;++r){let n=t[r];s.push(g(e+n.cumulativeNumGenerations-n.numGenerations,n))}await Promise.all(s)}async function g(t,n){let i=await o$(e,n.location,r);oI(i,l,n.generationNumber,n.height,n.numGenerations),0===i.height?d(t,i.entries):await f(t,i.entries)}return d(u.versionTreeNodes.at(-1)?.cumulativeNumGenerations??0n,u.inlineVersions),await f(0n,u.versionTreeNodes),c.sort((e,t)=>(0,tW._f)(e.generationNumber,t.generationNumber)),{generationIndex:n??0n,versions:c}}async function oW(e,t,r,n,i,s){if(n<=r+i){let{versions:i}=await oJ(e,t,{inclusiveMin:{generationIndex:r},exclusiveMax:{generationIndex:n},...s});return i}let[{versions:a},{versions:o}]=await Promise.all([r,n-i/2n].map(r=>oJ(e,t,{inclusiveMin:{generationIndex:r},exclusiveMax:{generationIndex:r+i/2n},...s})));return[...a,...o]}async function oZ(e,t){let{url:r}=t,n=r.suffix??"";if(""===n)return{offset:0,completions:[{value:"@",description:"Version specifier"}]};let i=n.match(/^@([^/]*)((?:\/|$).*)/);if(null===i)return;let[,s,a]=i;if(""!==a){(0,o_.wy)(s);return}let{base:o}=t,l=o.store.getUrl((0,ip.V8)(o.path));if(!s.startsWith("v")){let[r,n]=(0,o_.Qf)(s),i={signal:t.signal,progressListener:t.progressListener},a=await oT(e,l,i),[o,u]=await Promise.all([oz(e,a,{commitTime:r},i),oB(e,a,{commitTime:n+1n},i)]),h=(await oW(e,a,o,u,100n,{signal:t.signal,progressListener:t.progressListener})).map(e=>({value:`${(0,o_.ZU)(e.commitTime)}/`,description:`v${e.generationNumber}`}));return h.reverse(),{offset:1,completions:h}}if("v"===s){let{base:r}=t,n=(await oT(e,r.store.getUrl(r.path),t)).versionTree.inlineVersions.map(e=>({value:`v${e.generationNumber}/`,description:(0,o_.ZU)(e.commitTime)}));return n.reverse(),{offset:1,completions:n}}return{offset:1,completions:[{value:`${s}/`}]}}eR.registerKvStoreAdapterProvider(function(e){return{scheme:"ocdbt",description:"OCDBT database",getKvStore(t,r){let{baseUrl:n,version:i,path:s}=(0,oY.r)(t,r);return{store:new oq(e,n,i),path:s}},completeUrl:t=>oZ(e,t)}});var oX=r(3126);class oQ extends oX.S{list(e,t){return sJ(this.sharedKvStoreContext,this.getUrl(e),t)}}(0,oX.X)(eR,oQ);var oH=r(4606);async function o0(e,t,r){let n=Math.min(65557,t),i=await e(t-n,n,r),s=function(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=e.length;for(let e=r-22;e>=0;--e){if(0x6054b50!==t.getUint32(e,!0)||t.getUint16(e+20,!0)!==r-e-22)continue;let n=t.getUint16(e+4,!0),i=t.getUint16(e+10,!0),s=t.getUint32(e+12,!0),a=t.getUint32(e+16,!0);return{eocdrOffset:e,diskNumber:n,entryCount:i,centralDirectorySize:s,centralDirectoryOffset:a}}}(i);if(void 0===s)throw Error("End of central directory record signature not found; either not a zip file or file is truncated.");let{eocdrOffset:a,diskNumber:o,entryCount:l,centralDirectorySize:u,centralDirectoryOffset:h}=s;if(0!==o)throw Error(`Multi-volume zip files are not supported. This is volume: ${o}`);let c=i.slice(a+22,i.length);return 65535===l||0xffffffff===h?await o1(e,a,c,r):await o2(e,h,u,l,c,r)}async function o1(e,t,r,n){let i=await e(t-20,20,n),s=new DataView(i.buffer,i.byteOffset,i.byteLength);if(0x7064b50!==s.getUint32(0,!0))throw Error("invalid zip64 end of central directory locator signature");let a=s.getBigUint64(8,!0),o=await e(Number(a),56,n),l=new DataView(o.buffer,o.byteOffset,o.byteLength);if(0x6064b50!==l.getUint32(0,!0))throw Error("invalid zip64 end of central directory record signature");let u=l.getBigUint64(32,!0),h=l.getBigUint64(40,!0);return o2(e,Number(l.getBigUint64(48,!0)),Number(h),Number(u),r,n)}async function o2(e,t,r,n,i,s){let a=0,o=await e(t,r,s),l=[],u=new DataView(o.buffer,o.byteOffset,o.byteLength),h=new TextDecoder;for(let e=0;e<n;++e){let e=u.getUint32(a+0,!0);if(0x2014b50!==e)throw Error(`invalid central directory file header signature: 0x${e.toString(16)}`);let t=u.getUint16(a+4,!0),r=u.getUint16(a+6,!0),n=u.getUint16(a+8,!0),i=u.getUint16(a+10,!0),s=u.getUint16(a+12,!0),c=u.getUint16(a+14,!0),d=u.getUint32(a+16,!0),f=u.getUint32(a+20,!0),g=u.getUint32(a+24,!0),p=u.getUint16(a+28,!0),y=u.getUint16(a+30,!0),m=u.getUint16(a+32,!0),v=u.getUint16(a+36,!0),b=u.getUint32(a+38,!0),w=u.getUint32(a+42,!0);if(64&n)throw Error("strong encryption is not supported");a+=46;let S=o.subarray(a,a+=p),E=[];for(let e=0;e<y-3;){let t=u.getUint16(a+e+0,!0),r=u.getUint16(a+e+2,!0),n=e+4,i=n+r;if(i>y)throw Error("extra field length exceeds extra field buffer size");E.push({id:t,offset:a+n,length:r}),e=i}a+=y;let k=o.slice(a,a+=m);if(0xffffffff===g||0xffffffff===f||0xffffffff===w){let e=E.find(e=>1===e.id);if(void 0===e)throw Error("expected zip64 extended information extra field");let{offset:t,length:r}=e,n=0;if(0xffffffff===g){if(n+8>r)throw Error("zip64 extended information extra field does not include uncompressed size");g=Number(u.getBigUint64(t+n,!0)),n+=8}if(0xffffffff===f){if(n+8>r)throw Error("zip64 extended information extra field does not include compressed size");f=Number(u.getBigUint64(t+n,!0)),n+=8}if(0xffffffff===w){if(n+8>r)throw Error("zip64 extended information extra field does not include relative header offset");w=Number(u.getBigUint64(t+n,!0)),n+=8}}let I=E.find(e=>28789===e.id&&e.length>=6&&1===o[e.offset]&&u.getInt32(e.offset+1,!0)===(0,oH.buf)(S));if(I&&(S=o.slice(I.offset+5,I.offset+I.length)),0===i){let e=g;if((1&n)!=0&&(e+=12),f!==e)throw Error(`compressed/uncompressed size mismatch for stored file: ${f} != ${e}`)}let M=h.decode(S);M=M.replaceAll("\\","/");let x={versionMadeBy:t,versionNeededToExtract:r,generalPurposeBitFlag:n,compressionMethod:i,lastModFileTime:s,lastModFileDate:c,crc32:d,compressedSize:f,uncompressedSize:g,nameBytes:S,commentBytes:k,internalFileAttributes:v,externalFileAttributes:b,relativeOffsetOfLocalHeader:w,fileName:M};l.push(x)}return{commentBytes:i,entries:l,sizeEstimate:i.length+2*o.length}}async function o3(e,t,r){if(1&t.generalPurposeBitFlag)throw Error("encrypted entries not supported");let n=await e(t.relativeOffsetOfLocalHeader,30,r),i=new DataView(n.buffer,n.byteOffset,n.byteLength),s=i.getUint32(0,!0);if(0x4034b50!==s)throw Error(`invalid local file header signature: 0x${s.toString(16)}`);let a=i.getUint16(26,!0),o=i.getUint16(28,!0);return t.relativeOffsetOfLocalHeader+n.length+a+o}async function o6(e,t,r){let n,i;return await o0((i=0,async function(t,r,s){if(void 0!==n&&t>i&&t+r<=i+n.length)return n.subarray(t-i,t+r-i);let a=await e(t,r,s);return i=t,n=a,a}),t,r)}var o4=((E={})[E.STORE=0]="STORE",E[E.DEFLATE=8]="DEFLATE",E);function o8(e){var t="function"==typeof SuppressedError?SuppressedError:function(e,t,r){var n=Error(r);return n.name="SuppressedError",n.error=e,n.suppressed=t,n};return(o8=function(e){function r(r){e.error=e.hasError?new t(r,e.error,"An error was suppressed during disposal."):r,e.hasError=!0}var n,i=0;return function t(){for(;n=e.stack.pop();)try{if(!n.async&&1===i)return i=0,e.stack.push(n),Promise.resolve().then(t);if(n.dispose){var s=n.dispose.call(n.value);if(n.async)return i|=2,Promise.resolve(s).then(t,function(e){return r(e),t()})}else i|=1}catch(e){r(e)}if(1===i)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()})(e)}function o5(e){return async(t,r,n)=>{let i=await (0,iN.iT)(e,{throwIfMissing:!0,byteRange:{offset:t,length:r},strictByteRange:!0,signal:n.signal,progressListener:n.progressListener});return new Uint8Array(await i.response.arrayBuffer())}}async function o9(e,t,r){let n=function(e,t){var r,n;let i=t.getUrl();return r=`zipMetadata:${i}`,n={get:async(e,r)=>{let n={stack:[],error:void 0,hasError:!1};try{!function(e,t,r){if(null!=t){var n,i;if("object"!=typeof t&&"function"!=typeof t)throw TypeError("Object expected.");if(r){if(!Symbol.asyncDispose)throw TypeError("Symbol.asyncDispose is not defined.");n=t[Symbol.asyncDispose]}if(void 0===n){if(!Symbol.dispose)throw TypeError("Symbol.dispose is not defined.");n=t[Symbol.dispose],r&&(i=n)}if("function"!=typeof n)throw TypeError("Object not disposable.");i&&(n=function(){try{i.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:n,async:r})}else r&&e.stack.push({async:!0})}(n,new x.Vi(r.progressListener,{message:`Reading ZIP central directory from ${i}`}),!1);let e=await t.stat(r);if(e?.totalSize===void 0)throw Error(`Failed to determine ZIP file size: ${i}`);let s=await o6(o5(t),e.totalSize,r);return function(e,t){let r=e.length,n=0;for(let i=0;i<r;++i)t(e[i],i,e)&&(e[n]=e[i],++n);e.length=n}(s.entries,e=>!e.fileName.endsWith("/")),s.entries.sort((e,t)=>(0,nL.B)(e.fileName,t.fileName)),{data:s,size:s.sizeEstimate}}catch(e){n.error=e,n.hasError=!0}finally{o8(n)}}},e.memoize.get(`simpleAsyncCache:${r}`,()=>new iM(e.addRef(),n))}(e,t);try{return await n.get(void 0,r)}finally{n.dispose()}}function o7(e,t){let{entries:r}=e,n=eL(r,t,(e,t)=>(0,nL.B)(e,t.fileName));if(!(n<0))return r[n]}class le{chunkManager;base;constructor(e,t){this.chunkManager=e,this.base=t}metadata;async getMetadata(e){let{metadata:t}=this;return void 0===t&&(t=this.metadata=await o9(this.chunkManager,this.base,e)),t}getUrl(e){return this.base.getUrl()+`|zip:${(0,ip.aU)(e)}`}async stat(e,t){let r=o7(await this.getMetadata(t),e);if(void 0!==r)return{totalSize:r.uncompressedSize}}async read(e,t){let r=o7(await this.getMetadata(t),e);if(void 0===r)return;let{fileDataStart:n}=r;void 0===n&&(n=r.fileDataStart=await o3(o5(this.base),r,t));let i=new iT.uX(this.base,{offset:n,length:r.compressedSize});switch(r.compressionMethod){case o4.STORE:break;case o4.DEFLATE:i=new iC.Ll(i,"deflate-raw");break;default:throw Error(`Unsupported compression method: ${r.compressionMethod}`)}return i.read(t)}async list(e,t){return function(e,t){let{entries:r}=e,n=eD(0,r.length,e=>r[e].fileName>=t),i=eD(Math.min(r.length,n+1),r.length,e=>!r[e].fileName.startsWith(t)),s=[],a=[];for(let e=n;e<i;){let n=r[e],o=n.fileName.indexOf("/",t.length);if(-1===o)s.push({key:n.fileName}),++e;else{a.push(n.fileName.substring(0,o));let t=n.fileName.substring(0,o+1);e=eD(e+1,i,e=>!r[e].fileName.startsWith(t))}}return{entries:s,directories:a}}(await this.getMetadata(t),e)}get supportsOffsetReads(){return!0}get supportsSuffixReads(){return!0}}eR.registerKvStoreAdapterProvider(function(e){return{scheme:"zip",description:"ZIP archive",getKvStore:(t,r)=>((0,ip.uh)(t),{store:new le(e.chunkManager,new iN.f2(r.store,r.path)),path:decodeURIComponent(t.suffix??"")})}});let lt=new class{target;objects;nextId;queue;constructor(e,t){this.target=e,this.objects=new Map,this.nextId=L,t&&(this.queue=[]),e.onmessage=e=>{let t=e.data;if(void 0===U.get(t.functionName))throw Error(`Missing RPC function: ${t.functionName}`);U.get(t.functionName).call(this,t)}}sendReady(){this.invoke(P,{})}onPeerReady(){let{queue:e}=this;if(void 0!==e)for(let{data:t,transfers:r}of(this.queue=void 0,e))this.target.postMessage(t,r)}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}getOptionalRef(e){if(void 0===e)return;let t=e.id,r=this.get(t);return r.referencedGeneration=e.gen,r.addRef(),r}invoke(e,t,r){t.functionName=e;let{queue:n}=this;if(void 0!==n){n.push({data:t,transfers:r});return}this.target.postMessage(t,r)}promiseInvoke(e,t,r){let n,i,s;if(void 0!==r&&({signal:n,progressListener:i,transfers:s}=r),n?.aborted)return Promise.reject(n.reason);void 0!==i&&(t.progressListener=!0);let a=t.id=this.newId();this.invoke(e,t,s);let{promise:o,resolve:l,reject:u}=void 0===n?Promise.withResolvers():(0,I.L0)(n,()=>{this.invoke(N,{id:a})});return this.set(a,{resolve:l,reject:u,progressListener:i}),o}newId(){return T?this.nextId--:this.nextId++}}(self,!1);lt.sendReady(),globalThis.rpc=lt}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,r),s.exports}r.m=e,r.x=()=>{var e=r.O(void 0,["822","213","451","51"],function(){return r(1949)});return r.O(e)},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,{a:t}),t},r.d=function(e,t){for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=function(e){return Promise.all(Object.keys(r.f).reduce(function(t,n){return r.f[n](e,t),t},[]))},r.u=function(e){return"451"===e?"451.f4a0ec14850e18f3.js":"412"===e?"412.d86e2b5b8b184d10.js":""+e+"."+({213:"c62ddd4a2eb4c3a9",51:"95147b00883ea97e",822:"c9ad3a05b434474b"})[e]+".js"},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e=[];r.O=function(t,n,i,s){if(n){s=s||0;for(var a=e.length;a>0&&e[a-1][2]>s;a--)e[a]=e[a-1];e[a]=[n,i,s];return}for(var o=1/0,a=0;a<e.length;a++){for(var n=e[a][0],i=e[a][1],s=e[a][2],l=!0,u=0;u<n.length;u++)(!1&s||o>=s)&&Object.keys(r.O).every(function(e){return r.O[e](n[u])})?n.splice(u--,1):(l=!1,s<o&&(o=s));if(l){e.splice(a--,1);var h=i();void 0!==h&&(t=h)}}return t}})(),r.rv=function(){return"1.2.2"},(()=>{var e=r.x;r.x=function(){return Promise.all(["822","213","451","51"].map(r.e,r)).then(e)}})(),(()=>{r.g.importScripts&&(e=r.g.location+"");var e,t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var i=n.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=n[i--].src}if(!e)throw Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{r.b=self.location+"";var e={162:1};r.f.i=function(t,n){e[t]||importScripts(r.p+r.u(t))};var t=globalThis.webpackChunkneuroglancer=globalThis.webpackChunkneuroglancer||[],n=t.push.bind(t);t.push=function(t){var i=t[0],s=t[1],a=t[2];for(var o in s)r.o(s,o)&&(r.m[o]=s[o]);for(a&&a(r);i.length;)e[i.pop()]=1;n(t)}})(),r.ruid="bundler=rspack@1.2.2",r.x()})();
//# sourceMappingURL=162.f2e5bd83130a3d69.js.map